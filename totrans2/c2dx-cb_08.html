<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Working with Hardware</h1></div></div></div><p>The following topics will be covered in this chapter:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using native code</li><li class="listitem" style="list-style-type: disc">Change the processing using the platform</li><li class="listitem" style="list-style-type: disc">Using the acceleration sensor</li><li class="listitem" style="list-style-type: disc">Keeping the screen on</li><li class="listitem" style="list-style-type: disc">Getting dpi</li><li class="listitem" style="list-style-type: disc">Getting the maximum texture size</li></ul></div><div><div><div><div><h1 class="title"><a id="ch08lvl1sec66"/>Introduction</h1></div></div></div><p>Cocos2d-x has a lot of APIs. However, there are no APIs that we need, for example, In-App purchase, push notification, and so on. In this case, we have to create original APIs and need to write Objective-C code for iOS or Java code for Android. In addition, we want to get the device information that it is running on. When we want to adjust for each device, we have to get the device information such as the running application version, device name, dpi on device, and so on. However, doing so is very difficult and confusing. In this chapter, you can write the native code for iOS or Android and get the device information.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec67"/>Using native code</h1></div></div></div><p>In Cocos2d-x, you can<a id="id313" class="indexterm"/> write one source for the cross platform. However, you have to write an Objective-C function or a Java function for the dependency process such as a purchase or push notification. If you want to call Java for Android from C++, you have to use <a id="id314" class="indexterm"/>
<strong>JNI</strong> (<strong>Java Native Interface</strong>). In particular, JNI is very confusing. To call Java from C++, you have to use JNI. In this recipe, we will explain how to call an Objective-C function or a Java function from C++.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec185"/>Getting ready</h2></div></div></div><p>In this case, we will <a id="id315" class="indexterm"/>make a new class called <code class="literal">Platform</code>. You can get the application version by using this class. Before writing code, you will make three files called <strong>Platform.h</strong>, <strong>Platform.mm</strong>, and <strong>Platform.cpp</strong> in your project.</p><div><img src="img/B0561_08_01.jpg" alt="Getting ready"/></div><p>It is important that you don't add <code class="literal">Platform.cpp</code> to <strong>Compile Sources</strong> in Xcode. That's why <code class="literal">Platform.cpp</code> is for an Android target and doesn't need to be built for iOS. If you added it to <strong>Compile Sources</strong>, you have to remove it from there.</p><div><img src="img/B0561_08_02.jpg" alt="Getting ready"/></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec186"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Firstly, you<a id="id316" class="indexterm"/> have to make a header file called <code class="literal">Platform.h</code> by using the following code:<div><pre class="programlisting">class Platform
{
public:
    static const char* getAppVersion();
};</pre></div></li><li class="listitem">You have to make an execution file called <code class="literal">Platform.mm</code> for iOS. This code is in Objective-C.<div><pre class="programlisting">#include "Platform.h"

const char* Platform::getAppVersion()
{
    NSDictionary* info = [[NSBundle mainBundle] 
    infoDictionary]; 
    NSString* version = [info 
    objectForKey:(NSString*)kCFBundleVersionKey]; 
    if (version) { 
        return [version UTF8String]; 
    }
    return nullptr;
}</pre></div></li><li class="listitem">You have to make an execution file called <code class="literal">Platform.cpp</code> for Android. The following code is in C++ and uses Java through JNI:<div><pre class="programlisting">#include "Platform.h"
#include "platform/android/jni/JniHelper.h"
#define CLASS_NAME "org/cocos2dx/cpp/AppActivity"

USING_NS_CC;

const char* Platform::getAppVersion()
{
    JniMethodInfo t;
    const char* ret = NULL;
    if (JniHelper::getStaticMethodInfo(t, CLASS_NAME, 
    "getAppVersionInJava", "()Ljava/lang/String;")) {
        jstring jstr = (jstring)t.env- 
&gt;CallStaticObjectMethod(t.classID,t.methodID); 
        std::string sstr = JniHelper::jstring2string(jstr); 
        t.env-&gt;DeleteLocalRef(t.classID); 
        t.env-&gt;DeleteLocalRef(jstr); 
        ret = sstr.c_str(); 
    }
    return ret;
}</pre></div></li><li class="listitem">You have to edit <code class="literal">proj.android/jni/Android.mk</code> to build for Android when you added a new class file in your project.<div><pre class="programlisting">LOCAL_SRC_FILES := hellocpp/main.cpp \ 
                   ../../Classes/AppDelegate.cpp \ 
                   ../../Classes/HelloWorldScene.cpp \
                   ../../Classes/Platform.cpp</pre></div></li><li class="listitem">Next, you<a id="id317" class="indexterm"/> have to write Java code in <code class="literal">AppActivity.java</code>. This file is named <code class="literal">pro.android/src/org/cocos2dx/cpp/AppActivity.java</code>.<div><pre class="programlisting">public class AppActivity extends Cocos2dxActivity { 
    public static String appVersion = "";

    @Override 
    protected void onCreate(Bundle savedInstanceState) { 
        super.onCreate(savedInstanceState); 

        try { 
            PackageInfo packageInfo = 
getPackageManager().getPackageInfo(getPackageName(), 
PackageManager.GET_META_DATA); 
            appVersion = packageInfo.versionName; 
        } catch (NameNotFoundException e) { 
        }
    }

    public static String getAppVersionInJava() { return appVersion; 
    }
}</pre></div></li><li class="listitem">Finally, you can get a version of your game by using the following code:<div><pre class="programlisting">#include "Platform.h" 

const char* version = Platform::getAppVersion(); 
CCLOG("application version = %s", version);</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec187"/>How it works...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Firstly, we will look at it for iOS. You will be able to get a version of your game by using Objective-C in <code class="literal">Platform.mm</code>. You can write C++ and Objective-C in the <code class="literal">.mm</code> files.</li><li class="listitem">Next, we will look for Android. When you call <code class="literal">Platform::getAppversion</code> on Android devices, the method in <code class="literal">Platform.cpp</code> is executed. In this method, you can call the <code class="literal">getAppVersionInJava</code> method in <code class="literal">AppActivity.java</code>. by using JNI. C++ can connect Java via JNI. That's why you can only get the application version by using Java.</li><li class="listitem">In Java, you can get the version of your application by using the <code class="literal">onCreate</code> method. You<a id="id318" class="indexterm"/> can set it to a static variable and then, get it from the <code class="literal">getAppVersionInJava</code> method in Java.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec188"/>There's more…</h2></div></div></div><p>You can use JNI easily by using the <code class="literal">JniHelper</code> class in Cocos2d-x. How this class manages typos from C++ and creates a bridge between C++ and Java has already been explained. You can use the <code class="literal">JniHelper</code> class by using the following code:</p><div><pre class="programlisting">JniMethodInfo t; 
JniHelper::getStaticMethodInfo(t, CLASS_NAME, 
"getAppVersionInJava", 
"()Ljava/lang/String;")</pre></div><p>You can get the information about the Java method by using <code class="literal">JniHelper::getStaticMethodInfo</code>. The first argument is a variable of <code class="literal">JniMethodInfo</code>. The second argument is the name of the class that has the method you want to call. The third argument is the method name. The last argument is the parameter of this method. This parameter is decided by the return value and the arguments. The characters in the bracket are the parameters for the Java method. In this case, this method has no parameters. The characters after the bracket are the return value. <code class="literal">Ljava/lang/String</code> means that the return value is a string. If you get this parameter easily, you should use the command called <code class="literal">javap</code>. As the following result will be generated by using this command.</p><div><pre class="programlisting">$ cd /path/to/project/pro.android/bin/classes 
$ javap -s org.cocos2dx.cpp.AppActivity 
Compiled from "AppActivity.java" 
public class org.cocos2dx.cpp.AppActivity extends 
org.cocos2dx.lib.Cocos2dxActivity { 
  public static java.lang.String appVersion; 
    descriptor: Ljava/lang/String; 
  public org.cocos2dx.cpp.AppActivity(); 
    descriptor: ()V 

  protected void onCreate(android.os.Bundle); 
    descriptor: (Landroid/os/Bundle;)V 

  public static java.lang.String getAppVersionInJava(); 
    descriptor: ()Ljava/lang/String; 

  static {}; 
    descriptor: ()V 
}</pre></div><p>From the above result, you can see that the parameter for the <code class="literal">getAppVersionInJava</code> method is <code class="literal">()Ljava/lang/String</code>;</p><p>As mentioned earlier, you can get the information of the Java method as a <code class="literal">t</code> variable. So, you can call the Java method by using this variable and the following code:</p><div><pre class="programlisting">jstring jstr = (jstring)t.env- &gt;CallStaticObjectMethod(t.classID,t.methodID);</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec68"/>Changing the processing using the platform</h1></div></div></div><p>You can make the <a id="id319" class="indexterm"/>program run on specific parts of the source <a id="id320" class="indexterm"/>code for each OS. For example, you will change the file name, the file path, or the image scale by the platform. In this recipe, we will introduce the branching code based on the platform of choice in the case of a complication.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec189"/>How to do it...</h2></div></div></div><p>You can change the processing by using the preprocessor as follows:</p><div><pre class="programlisting">#if (CC_TARGET_PLATFORM == CC_PLATFORM_ANDROID) 
    CCLOG("this platform is Android"); 
#elif (CC_TARGET_PLATFORM == CC_PLATFORM_IOS) 
    CCLOG("this platform is iOS"); 
#else 
    CCLOG("this platfomr is others");
#endif</pre></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec190"/>How it works...</h2></div></div></div><p>Cocos2d-x defined the <code class="literal">CC_TARGET_PLATFORM</code> value in <code class="literal">CCPlatformConfig.h</code>. If your game is compiled for Android devices, <code class="literal">CC_TARGET_PLATFORM</code> is equal to <code class="literal">CC_PLATFORM_ANDROID</code>. If it is compiled for iOS devices, <code class="literal">CC_TARGET_PLATFORM</code> is equal to <code class="literal">CC_PLATFORM_IOS</code>. Needless to say, there are other values besides Android and iOS. Please check <code class="literal">CCPlatformConfig.h</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec191"/>There's more…</h2></div></div></div><p>The code that was used in the preprocessor is difficult to read on an editor. Further, you cannot notice the error before compiling your code. You should define a constant value that can be changed by the preprocessor, but you should change the processing by using code as much as possible. You can check the platform by using the <code class="literal">Application</code> class in Cocos2d-x as<a id="id321" class="indexterm"/> follows:</p><div><pre class="programlisting">switch (Application::getInstance()-&gt;getTargetPlatform()) { 
        case Application::Platform::OS_ANDROID: 
            CCLOG("this device is Android"); 
            break;
        case Application::Platform::OS_IPHONE: 
            CCLOG("this device is iPhone"); 
            break;
        case Application::Platform::OS_IPAD: 
            CCLOG("this device is iPad"); 
            break;
        default: 
            break;
}</pre></div><p>You can get the<a id="id322" class="indexterm"/> value of the platform by using the <code class="literal">Application::getTargetPlatform</code> method. You will be able to check, not just for iPhone or iPad, but also IOS by using this method.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec69"/>Using the acceleration sensor</h1></div></div></div><p>By using an acceleration<a id="id323" class="indexterm"/> sensor on the device, we can make the game more engrossing, by using operations such as shaking and tilting the device. For example, move the ball by tilting the screen, the maze game that aims at the goal, and the skinny panda trying to go on a diet, wherein the players shake the device to play the game. You can get the tilt value and the moving speed of the device by using the accelerometer. If you can use it, your game becomes more unique. In this recipe, we learn how to use the acceleration sensor.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec192"/>How to do it...</h2></div></div></div><p>You can get the x, y, and z axis values from the acceleration sensor by using the following code:</p><div><pre class="programlisting">Device::setAccelerometerEnabled(true);
auto listener = EventListenerAcceleration::create([](Acceleration* 
acc, Event* event){ 
    CCLOG("x=%f, y=%f, z=%f", acc-&gt;x, acc-&gt;y, acc-&gt;z); 
}); 
this-&gt;getEventDispatcher()- 
&gt;addEventListenerWithSceneGraphPriority(listener, this);</pre></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec193"/>How it works...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Firstly, you<a id="id324" class="indexterm"/> enable the acceleration sensor by using the <code class="literal">Device::setAccelerometerEnable</code> method. The methods in the <code class="literal">Device</code> class are static methods. So, you can directly call a method without an instance like this:<div><pre class="programlisting">Device::setAccelerometerEnable(true);</pre></div></li><li class="listitem">You set the event listener for getting the value from the acceleration sensor. In this case, you can get these values by using the lambda function.</li><li class="listitem">Finally, you set the event listener in the event dispatcher.</li><li class="listitem">You can get the value of the x, y, and z axes from the acceleration sensor, if you run this code on the real device. The x axis is the left and the right of the slope. The y axis is before and after of the slope. The z axis is the vertical motion.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec194"/>There's more…</h2></div></div></div><p>The acceleration sensor uses more battery power. When you use it, you set an appropriate interval for when the event occurred. The following code sets the interval as one second.</p><div><pre class="programlisting">Device::setAccelerometerInterval(1.0f);</pre></div><div><div><h3 class="title"><a id="tip16"/>Tip</h3><p>If the interval is higher, we might miss some tilt inputs. However, if we use a low interval, we will drain a lot of battery.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec70"/>Keeping the screen on</h1></div></div></div><p>You have to keep the <a id="id325" class="indexterm"/>device from entering into the sleep mode while playing your game. For example, in your game, the player can control the game and keep the game going by using the accelerometer. The problem is that if the player does not touch the screen while playing with the accelerometer, the device goes to sleep and enters background mode. In this recipe, you can keep the screen on easily.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec195"/>How to do it...</h2></div></div></div><p>You can keep the screen on if you set it to <code class="literal">true</code> by using the <code class="literal">Device::setKeepScreenOn</code> method as follows:</p><div><pre class="programlisting">Device::setKeepScreenOn(true);</pre></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec196"/>How it works...</h2></div></div></div><p>There is a different way for<a id="id326" class="indexterm"/> each platform to prevent a device from entering the sleep mode. However, Cocos2d-x can do it for every platform. You can use this method without executing a platform. In the iOS platform, the <code class="literal">setKeepScreenOn</code> method is as follows:</p><div><pre class="programlisting">void Device::setKeepScreenOn(bool value) 
{
    [[UIApplication sharedApplication] 
setIdleTimerDisabled:(BOOL)value]; 
}</pre></div><p>In the Android platform, the method is as follows:</p><div><pre class="programlisting">public void setKeepScreenOn(boolean value) { 
    final boolean newValue = value; 
    runOnUiThread(new Runnable() { 
        @Override
        public void run() { 
            mGLSurfaceView.setKeepScreenOn(newValue); 
        }
    });
}</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec71"/>Getting dpi</h1></div></div></div><p>There are a lot of <a id="id327" class="indexterm"/>
<strong>dpi</strong> (<strong>dots per inch</strong>) variations for each device. You can prepare several kinds of images by resolution. You might want to change an image by the dpi running on the device. In this recipe, if you would like to get the dpi that your game is running on, you need to use the Cocos2d-x function.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec197"/>How to do it...</h2></div></div></div><p>You can get dpi<a id="id328" class="indexterm"/> of the device game is executing on, by using the <code class="literal">Device::getDPI</code> method as follows:</p><div><pre class="programlisting">int dpi = Device::getDPI(); 
CCLOG("dpi = %d", dpi);</pre></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec198"/>How it works...</h2></div></div></div><p>In fact, we checked the dpi of some devices. To use the dpi information, you can further adjust the multiscreen resolution.</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Device</p>
</th><th style="text-align: left" valign="bottom">
<p>Dpi</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>iPhone 6 Plus</p>
</td><td style="text-align: left" valign="top">
<p>489</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>iPhone 6</p>
</td><td style="text-align: left" valign="top">
<p>326</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>iPhone 5s</p>
</td><td style="text-align: left" valign="top">
<p>326</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>iPhone 4s</p>
</td><td style="text-align: left" valign="top">
<p>326</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>iPad Air</p>
</td><td style="text-align: left" valign="top">
<p>264</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>iPad 2</p>
</td><td style="text-align: left" valign="top">
<p>132</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Nexus 5</p>
</td><td style="text-align: left" valign="top">
<p>480</p>
</td></tr></tbody></table></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec72"/>Getting the maximum texture size</h1></div></div></div><p>The<a id="id329" class="indexterm"/> maximum texture size that can be used is different for each device. In particular, when you use the texture atlas, you should be careful. That's why a texture atlas that has a lot of images is too large in size. You can't use a texture that is over the maximum size. If you use it, your game will crash. In this recipe, you can get the maximum texture size.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec199"/>How to do it...</h2></div></div></div><p>You can get the max texture size easily by using the following code:</p><div><pre class="programlisting">auto config = Configuration::getInstance();
int texutureSize = config-&gt;getMaxTextureSize();
CCLOG("max texture size = %d", texutureSize);</pre></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec200"/>How it works...</h2></div></div></div><p>The Configuration class is a singleton class. This class has some OpenGL variables. OpenGL is a multiplatform API for rendering 2D and 3D vector graphics. It is pretty difficult to use. Cocos2d-x wraps it and makes it easy to use. OpenGL has a lot of information for graphics. The max texture size is one of the variables providing this information. You can get the max texture size of the device that your application is running on.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec201"/>There's more…</h2></div></div></div><p>You can get other OpenGL variables. If you want to check the variables that <code class="literal">Configuration</code> has, you will use the <code class="literal">Configuration::getInfo</code> method.</p><div><pre class="programlisting">auto config = Configuration::getInstance(); 
std::string info = config-&gt;getInfo(); 
CCLOG("%s", info.c_str());</pre></div><p>The result <a id="id330" class="indexterm"/>of the log on iPhone 6 Plus:</p><div><pre class="programlisting">{
  gl.supports_vertex_array_object: true  cocos2d.x.version: 
  cocos2d-x 3.5 
  gl.vendor: Apple Inc. 
  gl.supports_PVRTC: true 
  gl.renderer: Apple A8 GPU 
  cocos2d.x.compiled_with_profiler: false 
  gl.max_texture_size: 4096 
  gl.supports_ETC1: false 
  gl.supports_BGRA8888: false 
  cocos2d.x.build_type: RELEASE 
  gl.supports_discard_framebuffer: true 
  gl.supports_NPOT: true 
  gl.supports_ATITC: false 
  gl.max_samples_allowed: 4 
  gl.max_texture_units: 8 
  cocos2d.x.compiled_with_gl_state_cache: true 
  gl.supports_S3TC: false 
  gl.version: OpenGL ES 2.0 Apple A8 GPU - 53.13 
}</pre></div><p>If you get each variable, and you check the source code of the <code class="literal">Configuration</code> class, you can understand them easily.</p></div></div></body></html>