<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Building Scenes and Layers"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Building Scenes and Layers</h1></div></div></div><p>The following topics will be covered in this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating scenes</li><li class="listitem" style="list-style-type: disc">Transitioning between scenes</li><li class="listitem" style="list-style-type: disc">Transitioning scenes with effects</li><li class="listitem" style="list-style-type: disc">Making original transitions for replacing scenes</li><li class="listitem" style="list-style-type: disc">Making original transitions for popping scenes</li><li class="listitem" style="list-style-type: disc">Creating layers</li><li class="listitem" style="list-style-type: disc">Creating modal layers</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec35"/>Introduction</h1></div></div></div><p>One screen has one scene. A<a id="id178" class="indexterm"/> scene is a container that holds Sprite, Labels, and other objects. For example, a scene can be a title scene, a game scene, or an option menu scene. Each scene has multiple layers. A layer is a transparent sheet similar to Photoshop's layer. Objects that added to layers are displayed on the screen. In this chapter, we will explain how to use the <code class="literal">Scene</code> class and the <code class="literal">Layer</code> class and how to transition between scenes. Finally, by the end of this chapter, you will be able to create original scenes and layers.</p></div></div>
<div class="section" title="Creating scenes"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec36"/>Creating scenes</h1></div></div></div><p>In Cocos2d-x, your<a id="id179" class="indexterm"/> games should have one or more scenes. A scene is basically a node. In this recipe, we will explain how to create and use a <code class="literal">Scene</code> class.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec94"/>How to do it...</h2></div></div></div><p>In this recipe, we will use the project that was created in <a class="link" href="ch01.html" title="Chapter 1. Getting Started with Cocos2d-x">Chapter 1</a>, <span class="emphasis"><em>Getting Started with Cocos2d-x</em></span>.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Firstly, duplicate <a id="id180" class="indexterm"/>the <code class="literal">HelloWorldScene.cpp</code> and <code class="literal">HelloWorldScene.h</code> files at <code class="literal">Finder</code> and rename them as <code class="literal">TitleScene.cpp</code> and <code class="literal">TitleScene.h</code>. Secondly, add them to the Xcode project. The result is shown in the following image:<div class="mediaobject"><img src="graphics/B0561_04_01.jpg" alt="How to do it..."/></div></li><li class="listitem">Next, we have to change <code class="literal">HelloWorldScene</code> to <code class="literal">TitleScene</code> and place the search and replace method in the tips section.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip11"/>Tip</h3><p>
<span class="strong"><strong>How to search for and replace a class name?</strong></span>
</p><p>In this case, select <code class="literal">TitleScene.h</code> and then the <span class="strong"><strong>Find</strong></span> | <span class="strong"><strong>Find and Replace …</strong></span> menu in Xcode. Then, enter <code class="literal">HelloWorld</code> in the <span class="strong"><strong>String Matching</strong></span> area and <code class="literal">TitleScene</code> in the <span class="strong"><strong>Replacement String</strong></span> area. Execute all replacements. Follow the same process for <code class="literal">TitleScene.cpp</code>. The result is the following code for <code class="literal">TitleScene.h</code>:</p></div></div><p>The result obtained for <code class="literal">TitleScene.h</code> is as follows:</p><div class="informalexample"><pre class="programlisting">#ifndef __TitleScene_SCENE_H__
#define __TitleScene_SCENE_H__

#include "cocos2d.h"
class TitleScene : public cocos2d::Layer
{
public:
    static cocos2d::Scene* createScene();
    virtual bool init();
    CREATE_FUNC(TitleScene);
};

#endif // __TitleScene_SCENE_H__</pre></div><p>Next, the result for <code class="literal">TitleScene.cpp</code> is as follows:</p><div class="informalexample"><pre class="programlisting">#include "TitleScene.h"

USING_NS_CC;

Scene* TitleScene::createScene()
{
    auto scene = Scene::create();
    auto layer = TitleScene::create();
    scene-&gt;addChild(layer);
    return scene;
}

// on "init" you need to initialize your instance
bool TitleScene::init()
{
    if ( !Layer::init() )
    {
        return false;
    }

    return true;
}</pre></div></li><li class="listitem">Next, add a label<a id="id181" class="indexterm"/> to the difference between <code class="literal">TitleScene</code> and <code class="literal">HelloWorldScene</code>. Add it before the return line in the <code class="literal">TitleScene::init</code> method as follows:<div class="informalexample"><pre class="programlisting">bool TitleScene::init()
{
    if ( !Layer::init() )
    {
        return false;
    }

    auto size = Director::getInstance()-&gt;getWinSize();
    auto label =
    Label::createWithSystemFont("TitleScene", "Arial",
    40);
    label-&gt;setPosition(size/2);
    this-&gt;addChild(label);

    return true;
}</pre></div></li><li class="listitem">Similarly, add the label in the <code class="literal">HelloWorld::init</code> method.<div class="informalexample"><pre class="programlisting">bool HelloWorld::init()
{
    if ( !Layer::init() )
    {
        return false;
    }

    auto size = Director::getInstance()-&gt;getWinSize();
    auto label = Label::createWithSystemFont("HelloWorld",
    "Arial", 40);
    label-&gt;setPosition(size/2);
    this-&gt;addChild(label);

    return true;
}</pre></div></li><li class="listitem">Next, to display<a id="id182" class="indexterm"/> the <code class="literal">TitleScene</code> class, change <code class="literal">AppDelegate.cpp</code> as follows:<div class="informalexample"><pre class="programlisting">#include "TitleScene.h"

bool AppDelegate::applicationDidFinishLaunching() {
    // initialize director
    auto director = Director::getInstance();
    auto glview = director-&gt;getOpenGLView();
    if(!glview) {
        glview = GLViewImpl::create("My Game");
        director-&gt;setOpenGLView(glview);
    }

    // turn on display FPS
    director-&gt;setDisplayStats(true);

    // set FPS. the default value is 1.0/60 if you don't
    call this director-&gt;setAnimationInterval(1.0 / 60);
    glview-&gt;setDesignResolutionSize(640, 960,
    ResolutionPolicy::NO_BORDER); 
    // create a scene. it's an autorelease object
    auto scene = TitleScene::createScene();

    // run
    director-&gt;runWithScene(scene);

    return true;
}</pre></div></li></ol></div><p>The result is shown <a id="id183" class="indexterm"/>in the following image:</p><div class="mediaobject"><img src="graphics/B0561_04_02.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec95"/>How it works...</h2></div></div></div><p>First, you need to create <code class="literal">TitleScene</code> by duplicating the <code class="literal">HelloWorldScene</code> class files. It is pretty difficult to create an original <code class="literal">Scene</code> class from a blank file. However, a basic class of <code class="literal">Scene</code> is patterned. So, you can create it easily by duplicating and modifying the <code class="literal">HelloWorldScene</code> class files. While you are developing your game, you need to execute this step when you need a new scene.</p><p>Finally, we change the <code class="literal">AppDelegate.cpp</code> file. The <code class="literal">AppDelegate</code> class is the first class to be executed in Cocos2d-x. The <code class="literal">AppDelegate:: applicationDidFinishLaunching</code> method is executed when the application is ready to run. This method will prepare the execution of Cocos2d-x. Then, it will create the first scene and run it.</p><div class="informalexample"><pre class="programlisting">auto scene = TitleScene::createScene();
// run
director-&gt;runWithScene(scene);</pre></div><p>The <code class="literal">TitleScene::createScene</code> method is used to create a title scene, and the <code class="literal">runWithScene</code> <a id="id184" class="indexterm"/>method is used to run it.</p></div></div>
<div class="section" title="Transitioning between scenes"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec37"/>Transitioning between scenes</h1></div></div></div><p>Your games have to <a id="id185" class="indexterm"/>transition between scenes. For example, after launching your games, the title scene is displayed. Then, it is transitioned into the level selection scene, game scene, and so on. In this recipe, we will explain how to facilitate transition between scenes, which would improve the gameplay and the flow of the game.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec96"/>How to do it...</h2></div></div></div><p>A game has a lot of scenes. So, you might need to move between scenes in your game. Perhaps, when a game is started, a title scene will be displayed. Then, a game scene will appear in the next title scene. There are two ways to transition to a scene.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">One is to use the <code class="literal">Director::replaceScene</code> method. This method replaces a scene outright.<div class="informalexample"><pre class="programlisting">auto scene = HelloWorld::createScene();
Director::getInstance()-&gt;replaceScene(scene);</pre></div></li><li class="listitem">The other is to use the <code class="literal">Director::pushScene</code> method. This method suspends the execution of the running scene and pushes a new scene on the stack of the suspended scene.<div class="informalexample"><pre class="programlisting">auto scene = HelloWorld::createScene();
Director::getInstance()-&gt;pushScene(scene);</pre></div></li></ol></div><p>In this case, the old scene is suspended. You can get back to the old scene to pop up a new scene.</p><div class="informalexample"><pre class="programlisting">auto Director::getInstance()-&gt;popScene();</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec97"/>How it works...</h2></div></div></div><p>Layer, Sprite, and other nodes can be displayed by using the <code class="literal">addChild</code> method. However, Scene cannot be displayed by using the <code class="literal">addChild</code> method; it can be displayed by using the <code class="literal">Director::replaceScene</code> or <code class="literal">Director::pushScene</code> methods. That's why <code class="literal">Scene</code> is visible only on one screen at the same time. <code class="literal">Scene</code> and <code class="literal">Layer</code> are similar, but there is a significant difference.</p><p>Usually, you will use the <code class="literal">replaceScene</code> method when you change the scene from the title scene to the game scene. Further, you can use the <code class="literal">pushScene</code> method to display a modal scene, as in the case of pausing a scene during a game. In this case, an easy way to suspend a game scene is<a id="id186" class="indexterm"/> to pause the game.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip12"/>Tip</h3><p>When scenes are replaced in a game, the applications will release the memory used by the old scenes. However, if games push scenes, they will not release the memory used by the old scenes because it will suspend it. Further, games are resumed when new scenes are popped. If you added a lot of scenes by using the <code class="literal">pushScene</code> method, the device memory will no longer be enough.</p></div></div></div></div>
<div class="section" title="Transitioning scenes with effects"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec38"/>Transitioning scenes with effects</h1></div></div></div><p>Popular games display <a id="id187" class="indexterm"/>some effects when transitioning scenes. These<a id="id188" class="indexterm"/> effects can be natural, dramatic, and so on. Cocos2d-x has a lot of transitioning effects. In this recipe, we will explain how to use a transitioning effect and the effect produced.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec98"/>How to do it...</h2></div></div></div><p>You can add visual effects to a scene transition by using the <code class="literal">Transition</code> class. Cocos2d-x has many kinds of <code class="literal">Transition</code> classes. However, there is only one pattern for how to use them.</p><div class="informalexample"><pre class="programlisting">auto nextScene = HelloWorld::createScene();
auto transition = TransitionFade::create(1.0f, nextScene);
Director::getInstance()-&gt;replaceScene(transition);</pre></div><p>It can be used when a scene was pushed.</p><div class="informalexample"><pre class="programlisting">auto nextScene = HelloWorld::createScene();
auto transition = TransitionFade::create(1.0f, nextScene);
Director::getInstance()-&gt;pushScene(transition);</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec99"/>How it works...</h2></div></div></div><p>Firstly, you need to create the <code class="literal">nextscene</code> object. Then, you need to create a <code class="literal">transition</code> object with a <a id="id189" class="indexterm"/>set duration and an incoming scene object. Lastly, you<a id="id190" class="indexterm"/> need to run <code class="literal">Director::pushScene</code> with the <code class="literal">transition</code> object. This recipe sets the duration for the transition scene and the fade action as one second. The following table lists some of the major <code class="literal">Transition</code> classes:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Transition Class</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">TransitionRotoZoom</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Rotates and<a id="id191" class="indexterm"/> zooms out of the outgoing scene, and then, rotates and zooms into the incoming scene.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">TransitionJumpZoom</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Zooms<a id="id192" class="indexterm"/> out and jumps the outgoing scene, and then jumps and zooms into the incoming scene.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">TransitionMoveInL</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Moves scene in<a id="id193" class="indexterm"/> from right to the left.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">TransitionSlideInL</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Slides <a id="id194" class="indexterm"/>in the incoming scene from the left border.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">TransitionShrinkGrow</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Shrinks<a id="id195" class="indexterm"/> the outgoing scene while enlarging the incoming scene.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">TransitionFlipX</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Flips the<a id="id196" class="indexterm"/> screen horizontally.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">TransitionZoomFlipX</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Flips the<a id="id197" class="indexterm"/> screen horizontally by doing a zoom out/in. The front face shows the outgoing scene, and the back face shows the incoming scene.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">TransitionFlipAngular</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Flips the<a id="id198" class="indexterm"/> screen half horizontally and half vertically.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">TransitionZoomFlipAngular</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Flips the<a id="id199" class="indexterm"/> screen half horizontally and half vertically by zooming out/in a little.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">TransitionFade</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Fades <a id="id200" class="indexterm"/>out of the outgoing scene, and then, fades into the incoming scene.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">TransitionCrossFade</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Cross-fades <a id="id201" class="indexterm"/>two scenes by using the <code class="literal">RenderTexture</code> object.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">TransitionTurnOffTiles</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Turns off <a id="id202" class="indexterm"/>the tiles of the outgoing scene in an random order.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">TransitionSplitCols</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id203" class="indexterm"/>odd columns go <a id="id204" class="indexterm"/>upwards, while the even columns go downwards.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">TransitionSplitRows</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The odd <a id="id205" class="indexterm"/>rows go to the left, while the even rows go to the right.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">TransitionFadeTR</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Fades the <a id="id206" class="indexterm"/>tiles of the <a id="id207" class="indexterm"/>outgoing scene from the left-bottom corner to the top-right corner.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">TransitionFadeUp</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Fades the tiles <a id="id208" class="indexterm"/>of the outgoing scene from the bottom to the top.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">TransitionPageTurn</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Peels <a id="id209" class="indexterm"/>back the bottom right-hand corner of a scene to transition to the scene beneath it, thereby simulating a page turn.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">TransitionProgressRadialCW</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Counterclockwise<a id="id210" class="indexterm"/> radial transition to the next scene.</p>
</td></tr></tbody></table></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec100"/>There's more...</h2></div></div></div><p>You can also learn the beginning and the end of the transition scene by using the <code class="literal">onEnterTransitionDidFinish</code> method and the <code class="literal">onExitTransitionDidStart</code> method. When your game shows the new scene completely, the <code class="literal">onEnterTransitionDidFinish</code> method is called. When the old scene starts disappearing, the <code class="literal">onExitTransitionDidStart</code> method is called. If you'd like to do something during the time that the scenes appear or disappear, you will need to use these methods.</p><p>Let's now look at an example of using the <code class="literal">onEnterTransitionDidFinish</code> and <code class="literal">onExitTransitionDidStart</code> <a id="id211" class="indexterm"/>methods. <code class="literal">HelloWorldScene.h</code> has the <a id="id212" class="indexterm"/>following code:</p><div class="informalexample"><pre class="programlisting">class HelloWorld : public cocos2d::Layer
{
public:
  static cocos2d::Scene* createScene();
  virtual bool init();
  CREATE_FUNC(HelloWorld);

  virtual void onEnterTransitionDidFinish();
  virtual void onExitTransitionDidStart();
};

HelloWorldScene.cpp has the following code:
void HelloWorld::onEnterTransitionDidFinish()
{
  CCLOG("finished enter transition");
}

void HelloWorld::onExitTransitionDidStart()
{
  CCLOG("started exit transition");
}</pre></div></div></div>
<div class="section" title="Making original transitions for replacing scenes"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec39"/>Making original transitions for replacing scenes</h1></div></div></div><p>You know that <a id="id213" class="indexterm"/>Cocos2d-x has a lot of transitioning effects. However, if it does not have an effect that you need, it is difficult to create an original transitioning effect. However, you can create it if you have the basic knowledge of transitioning effects. In this recipe, we will show you how to create original transitions.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec101"/>How to do it...</h2></div></div></div><p>Even though Cocos2d-x has a lot of different types of <code class="literal">Transition</code> classes, you may not find a transition effect that you need. In this recipe, you can create an original transition effect such as opening a door. When the replacement of a scene begins, the previous scene is divided into two and open to the left or right.</p><p>You have to create new files named "<code class="literal">TransactionDoor.h</code>" and "<code class="literal">TransactionDoor.cpp</code>," and add them to your project.</p><p>
<code class="literal">TransactionDoor.h</code> has the following code:</p><div class="informalexample"><pre class="programlisting">#ifndef __TRANSITIONDOOR_H__
#define __TRANSITIONDOOR_H__

#include "cocos2d.h"

NS_CC_BEGIN

class CC_DLL TransitionDoor : public TransitionScene , public TransitionEaseScene
{
public:
  static TransitionDoor* create(float t, Scene* scene);

  virtual ActionInterval* action();
  virtual void onEnter() override;
  virtual ActionInterval * easeActionWithAction(ActionInterval * action) override;
  virtual void onExit() override;
  virtual void draw(Renderer *renderer, const Mat4 &amp;transform,
  uint32_t flags) override;
  CC_CONSTRUCTOR_ACCESS:
  TransitionDoor();
  virtual ~TransitionDoor();

protected:
  NodeGrid* _gridProxy;
  private:
  CC_DISALLOW_COPY_AND_ASSIGN(TransitionDoor);
};

class CC_DLL SplitDoor : public TiledGrid3DAction
{
public:
  /**
   * creates the action with the number of columns to split and
   the duration
   * @param duration in seconds
   */
  static SplitDoor* create(float duration, unsigned int cols);

  // Overrides
  virtual SplitDoor* clone() const override;
  /**
   * @param time in seconds
   */ 
  virtual void update(float time) override;
  virtual void startWithTarget(Node *target) override;

CC_CONSTRUCTOR_ACCESS:
  SplitDoor() {}
  virtual ~SplitDoor() {}

  /** initializes the action with the number of columns to split
and the duration */
  bool initWithDuration(float duration, unsigned int cols);

protected:
  unsigned int _cols;
  Size _winSize;

private:
  CC_DISALLOW_COPY_AND_ASSIGN(SplitDoor);
};

NS_CC_END

#endif /* defined(__TRANSITIONDOOR_H__) */</pre></div><p>Use the <a id="id214" class="indexterm"/>following code for <code class="literal">TransactionDoor.cpp</code>:</p><div class="informalexample"><pre class="programlisting">#include "TransitionDoor.h"

NS_CC_BEGIN

TransitionDoor::TransitionDoor()
{
  _gridProxy = NodeGrid::create();
  _gridProxy-&gt;retain();
}
TransitionDoor::~TransitionDoor()
{
  CC_SAFE_RELEASE(_gridProxy);
}

TransitionDoor* TransitionDoor::create(float t, Scene* scene)
{
  TransitionDoor* newScene = new (std::nothrow) TransitionDoor();
  if(newScene &amp;&amp; newScene-&gt;initWithDuration(t, scene))
  {
    newScene-&gt;autorelease();
    return newScene;
  }
  CC_SAFE_DELETE(newScene); 
  return nullptr;
}

void TransitionDoor::onEnter()
{
  TransitionScene::onEnter();

  _inScene-&gt;setVisible(true);

  _gridProxy-&gt;setTarget(_outScene);
  _gridProxy-&gt;onEnter();

  ActionInterval* split = action();
  ActionInterval* seq = (ActionInterval*)Sequence::create
  (
   split,
   CallFunc::create(CC_CALLBACK_0(TransitionScene::finish,this)),
   StopGrid::create(),
   nullptr
   );

  _gridProxy-&gt;runAction(seq);
}

void TransitionDoor::draw(Renderer *renderer, const Mat4
&amp;transform, uint32_t flags)
{
  Scene::draw(renderer, transform, flags);
  _inScene-&gt;visit();
  _gridProxy-&gt;visit(renderer, transform, flags);
}

void TransitionDoor::onExit()
{
  _gridProxy-&gt;setTarget(nullptr);
  _gridProxy-&gt;onExit();
  TransitionScene::onExit();
}

ActionInterval* TransitionDoor:: action()
{
  return SplitDoor::create(_duration, 3);
}

ActionInterval*
TransitionDoor::easeActionWithAction(ActionInterval * action)
{
  return EaseInOut::create(action, 3.0f);
}

SplitDoor* SplitDoor::create(float duration, unsigned int cols)
{
  SplitDoor *action = new (std::nothrow) SplitDoor();

  if (action)
  {
    if (action-&gt;initWithDuration(duration, cols))
    {
      action-&gt;autorelease();
    }
    else
    {
      CC_SAFE_RELEASE_NULL(action);
    }
  }

  return action;
}

bool SplitDoor::initWithDuration(float duration, unsigned int cols)
{
  _cols = cols;
  return TiledGrid3DAction::initWithDuration(duration, Size(cols,
1));
}

SplitDoor* SplitDoor::clone() const 
{
  // no copy constructor
  auto a = new (std::nothrow) SplitDoor();
  a-&gt;initWithDuration(_duration, _cols);
  a-&gt;autorelease();
  return a;
}

void SplitDoor::startWithTarget(Node *target)
{
  TiledGrid3DAction::startWithTarget(target);
  _winSize = Director::getInstance()-&gt;getWinSizeInPixels();
}

void SplitDoor::update(float time)
{
  for (unsigned int i = 0; i &lt; _gridSize.width; ++i) 
  {
    Quad3 coords = getOriginalTile(Vec2(i, 0));
    float  direction = 1;

    if ( (i % 2 ) == 0 )
    {
      direction = -1;
    }

    coords.bl.x += direction * _winSize.width/2 * time;
    coords.br.x += direction * _winSize.width/2 * time;
    coords.tl.x += direction * _winSize.width/2 * time;
    coords.tr.x += direction * _winSize.width/2 * time;|

    setTile(Vec2(i, 0), coords);
  }
}
NS_CC_END</pre></div><p>The following code will allow us to use the <code class="literal">TransitionDoor</code> effect:</p><div class="informalexample"><pre class="programlisting">auto trans = TransitionDoor::create(1.0f,
HelloWorld::createScene());
Director::getInstance()-&gt;replaceScene(trans);</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec102"/>How it works...</h2></div></div></div><p>All types of transitions have <code class="literal">TransitionScene</code> as <code class="literal">SuperClass</code>. <code class="literal">TransitionScene</code> is a basic class and has a basic transition process. If you would like to create the original transition effect in an easier way, you would look for a similar transition effect in Cocos2d-x. You can <a id="id215" class="indexterm"/>then create your class from a similar class. The <code class="literal">TransitionDoor</code> class is created from the <code class="literal">TransitionSplitCol</code> class. Then, add and modify them where necessary. However, it is necessary to have basic knowledge about them in order to fix them.</p><p>The following are some of the important <a id="id216" class="indexterm"/>properties of the <code class="literal">Transition</code> class:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Properties</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">_inScene</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Pointer of the next scene.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">_outScene</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Pointer of the out scene.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">_duration</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Duration of the transition, a float value specified by the create method.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">_isInSceneOnTop</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Boolean value; if it is true, the next scene is the top of the scene graph.</p>
</td></tr></tbody></table></div><p>Some of the important properties of<a id="id217" class="indexterm"/> the <code class="literal">transition</code> class are as follows:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Properties</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">onEnter</code>
</p>
</td><td style="text-align: left" valign="top">
<p>To start the transition effect.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Action</code>
</p>
</td><td style="text-align: left" valign="top">
<p>To create an effect action.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">onExit</code>
</p>
</td><td style="text-align: left" valign="top">
<p>To finish the transition effect and clean up.</p>
</td></tr></tbody></table></div><p>In the case of the <code class="literal">TransitionDoor</code> class, the next scene is set to be visible and the previous scene in split into two grids in the <code class="literal">onEnter</code> method. Then, an effect such as opening a door is started. In the action method, an instance of the <code class="literal">Action</code> class is created by using the <code class="literal">SplitDoor</code> class. The <code class="literal">SplitDoor</code> class is based on the <code class="literal">SplitCol</code> class in Cocos2d-x. The <code class="literal">SplitDoor</code> class moves two grids of the previous scene to the left or the right.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec103"/>There's more...</h2></div></div></div><p>There are some <a id="id218" class="indexterm"/>necessary methods in addition to those described above. These methods are defined in the <code class="literal">Node</code> class.</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Properties</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">onEnter</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Node<a id="id219" class="indexterm"/> starts appearing on the screen</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">onExit</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Node disappears from the screen</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">onEnterTransitionDidFinish</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Node finishes the transition effect after appearing on the screen</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">onExitTransitionDidStart</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Node starts the transition effect before disappearing from the screen</p>
</td></tr></tbody></table></div><p>If you want to play background music when the scene appears on the screen, you can play it by using the <code class="literal">onEnter</code> method. If you want to play it before finishing the transition effect, use the <code class="literal">onEnterTransitionDidFinish</code> method. Other than these, the initial process in the <code class="literal">onEnter</code> method starts the animation in the <code class="literal">onEnterTransitionDidFinish</code> method, cleans up the process in the <code class="literal">onExit</code> method, and so on.</p></div></div>
<div class="section" title="Making original transitions for popping scenes"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec40"/>Making original transitions for popping scenes</h1></div></div></div><p>Cocos2d-x has<a id="id220" class="indexterm"/> transition effects for pushing a scene. For some reason, it does not have transition effects for popping scenes. We'd like to transition with an effect for popping scenes after pushing scenes with effects. In this recipe, we will explain how to create an original transition for popping scenes.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec104"/>Getting ready</h2></div></div></div><p>In this recipe, you will understand how to pop a transition scene with effects. You will need a new class, so you have to make new class files called <code class="literal">DirectorEx.h</code> and <code class="literal">DirectorEx.cpp</code> and add them to your project.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec105"/>How to do it...</h2></div></div></div><p>Cocos2d-x has a<a id="id221" class="indexterm"/> transition scene with effects for pushing scenes. However, it does not have transition effects for popping scenes. Therefore, we create an original class called <code class="literal">DirectorEx</code> to create a transition effect for popping scenes. The code snippet is given next.</p><p>
<code class="literal">DirectorEx.h</code> has the following code:</p><div class="informalexample"><pre class="programlisting">class DirectorEx : public Director
{
public:
  Scene* previousScene(void);
  void popScene(Scene* trans);
};</pre></div><p>
<code class="literal">DirectorEx.cpp</code> has the following code:</p><div class="informalexample"><pre class="programlisting">#include "DirectorEx.h"

Scene* DirectorEx::previousScene()
{
  ssize_t sceneCount = _scenesStack.size();
  if (sceneCount &lt;= 1) {
    return nullptr;
  }
  return _scenesStack.at(sceneCount-2);
}

void DirectorEx::popScene(Scene* trans)
{
  _scenesStack.popBack();
  ssize_t sceneCount = _scenesStack.size();
  if (sceneCount==0) {
    end();
  } else {
    _sendCleanupToScene = true;
    _nextScene = trans;
  }
}</pre></div><p>This class can be used as follows:</p><div class="informalexample"><pre class="programlisting">DirectorEx* directorEx = static_cast&lt;DirectorEx*&gt;(Director::getInstance());
Scene* prevScene = directorEx-&gt;previousScene();
Scene* pScene = TransitionFlipX::create(duration, prevScene);
directorEx-&gt;popScene(pScene);</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec106"/>How it works...</h2></div></div></div><p>If we customized the <code class="literal">Director</code> class in Cocos2d-x, it can transition with the effect for popping a scene. However, this is not a good idea. Therefore, we create a sub-class of the <code class="literal">Director</code> class <a id="id222" class="indexterm"/>called the <code class="literal">DirectorEx</code> class and use this class as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Firstly, you can get an instance of the <code class="literal">DirectorEx</code> class to cast an instance of the <code class="literal">Director</code> class.<div class="informalexample"><pre class="programlisting">DirectorEx* directorEx = static_cast&lt;DirectorEx*&gt;(Director::getInstance());</pre></div></li><li class="listitem">Further, you have to get an instance of the previous scene.<div class="informalexample"><pre class="programlisting">Scene* prevScene = directorEx-&gt;previousScene();</pre></div></li><li class="listitem">Next, you have to create a transition effect.<div class="informalexample"><pre class="programlisting">Scene* pScene = TransitionFlipX::create(duration, prevScene);</pre></div></li><li class="listitem">Finally, you can pop a scene with this effect by using the <code class="literal">DirectorEx::popScene</code> method.<div class="informalexample"><pre class="programlisting">directorEx-&gt;popScene(pScene);</pre></div></li></ol></div></div></div>
<div class="section" title="Creating layers"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec41"/>Creating layers</h1></div></div></div><p>A layer is an object that can be used<a id="id223" class="indexterm"/> on <code class="literal">Scene</code>. It is a transparent sheet similar to Photoshop's layer. All the objects are added to <code class="literal">Layer</code> in order to be displayed on the screen. Further, a scene can have multiple layers. Layers are also responsible for accepting inputs, drawing, and touching. For example, in the game, a scene has a background layer, hud layer, and a player's layer. In this recipe, we will explain how to use <code class="literal">Layer</code>.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec107"/>How to do it...</h2></div></div></div><p>The following code shows how to create a layer and add it to a scene:</p><div class="informalexample"><pre class="programlisting">auto layer = Layer::create();
this-&gt;addChild(layer);</pre></div><p>That's easy. If you have a color layer, you can do it.</p><div class="informalexample"><pre class="programlisting">auto layer = LayerColor::create(Color4B::WHITE);
this-&gt;addChild(layer);</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec108"/>How it works...</h2></div></div></div><p>The Scene class is the one displayed on the screen, but the <code class="literal">Layer</code> class can be stacked in many layers. Scene has one or more layers, and Sprite has to be on a layer. The <code class="literal">Layer</code> class is a transparent sheet. In <a id="id224" class="indexterm"/>addition, a transparent node needs more CPU power. So, you need to be careful not to stack too many layers.</p></div></div>
<div class="section" title="Creating modal layers"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec42"/>Creating modal layers</h1></div></div></div><p>In user interface design, a modal<a id="id225" class="indexterm"/> layer is an important layer. A modal layer is like a child window. When a modal layer is showing, players cannot touch any other button outside the modal layer. They can only touch the button on the modal layer. We will need modal layers when we confirm something with the players. In this recipe, we will explain how to create modal layers.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec109"/>How to do it...</h2></div></div></div><p>Firstly, you have to two new files named <code class="literal">ModalLayer.h</code> and <code class="literal">ModalLayer.cpp</code>. They should contain the following code:</p><p>
<code class="literal">ModalLayer.h</code> should have the following code:</p><div class="informalexample"><pre class="programlisting">#include "cocos2d.h"

USING_NS_CC;

class ModalLayer : public Layer
{
public:
  ModalLayer();
  ~ModalLayer();
  bool init();
  CREATE_FUNC(ModalLayer);
  void close(Ref* sender=nullptr);
};

ModalLayer.cpp should have the following code:
#include "ModalLayer.h"
USING_NS_CC;

ModalLayer::ModalLayer()
{
}

ModalLayer::~ModalLayer()
{
}

bool ModalLayer::init()
{
  if (!Layer::init())
  {
    return false;
  }

  auto listener = EventListenerTouchOneByOne::create();
  listener-&gt;setSwallowTouches(true);
  listener-&gt;onTouchBegan = [](Touch *touch,Event*event)-&gt;bool{
  return true; };
  this-&gt;getEventDispatcher()-&gt;addEventListenerWithSceneGraphPriority(listener, this);

  return true;
}

void ModalLayer::close(Ref* sender)
{
  this-&gt;removeFromParentAndCleanup(true);
}</pre></div><p>You should create a <a id="id226" class="indexterm"/>sub-class from the <code class="literal">ModalLayer</code> class and add a menu button or some design that you need. You then have to create an instance of it and add it to the running scene. Then, it should enable the buttons on the modal layer but disable the buttons at the bottom of the modal layer.</p><div class="informalexample"><pre class="programlisting">// add modal layer
auto modal = ModalLayer::create();
this-&gt;addChild(modal);

// close modal layer
modal-&gt;close();</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec110"/>How it works...</h2></div></div></div><p>It is easy to create a modal layer in Cocos2d-x version 3. In version 3, a touch event occurs from the top of the layer. So, if the modal layer picks up all the touch events, the nodes under the modal layer are notified of these. The modal layer is picking up all of the events. Refer to the following code:</p><div class="informalexample"><pre class="programlisting">listener-&gt;onTouchBegan = [](Touch *touch,Event*event)-&gt;bool{ return true; };</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip13"/>Tip</h3><p>This <a id="id227" class="indexterm"/>modal layer can pick up all touching events. However, Android has key events like the back key. When a player touches the back key when the modal layer is displayed, you have to decide to do it. In one of the cases, the modal is closed, and in another, the back key is ignored.</p></div></div></div></div></body></html>