<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Gold, Items, and a Shop"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Gold, Items, and a Shop</h1></div></div></div><p>Now that you have created an NPC that talks to the player, it is time to allow the NPC to help the player. In this chapter, we will use the NPC as a shop owner, displaying items for the user to buy. Before we do this, the user is going to need some sort of currency to buy the items. We will cover the following topics in this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Setting and getting gold instances</li><li class="listitem" style="list-style-type: disc">Item data</li><li class="listitem" style="list-style-type: disc">The shop screen framework</li><li class="listitem" style="list-style-type: disc">The item button framework</li><li class="listitem" style="list-style-type: disc">Linking the item data</li></ul></div><div class="section" title="Setting and getting gold instances"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec47"/>Setting and getting gold instances</h1></div></div></div><p>While we move <a id="id425" class="indexterm"/>on to making a shopping interface, via the <span class="strong"><strong>Shop</strong></span> button, we must first be able to pull the currency in order to pay for items in the shop. In a previous chapter, we discussed and made placeholders for gold, but we did not actually create gold <a id="id426" class="indexterm"/>values. In this game, we would like gold to be dropped by enemies at the end of battle. In this case, enemies will need some sort of gold data that we can add to the player's gold data (eventually, items will need this gold data that is tied to them as well). In <a class="link" href="ch04.html" title="Chapter 4. Pause Menu Framework">Chapter 4</a>, <span class="emphasis"><em>Pause Menu Framework</em></span>, we created a pause menu that has a gold placeholder, and we will now add gold to this pause menu.</p><p>First, let's add a <code class="literal">Gold</code> property to <code class="literal">FEnemyInfo.h</code>. Navigate to <span class="strong"><strong>Source</strong></span> | <span class="strong"><strong>RPG</strong></span> | <span class="strong"><strong>Data</strong></span>, open <code class="literal">FEnemyInfo.h</code>, and add a <code class="literal">Gold</code> property of an integer data type to your <code class="literal">EnemyInfo</code> table, as follows:</p><div class="informalexample"><pre class="programlisting">UPROPERTY( BlueprintReadOnly, EditAnywhere, Category = "EnemyInfo" )
  int32 Gold;</pre></div><p>We now need to tie the <code class="literal">Gold</code> property with our standard <code class="literal">GameCharacter</code> properties so that we can update any instance of an enemy with the proper gold value. Next, you will open <code class="literal">GameCharacter.h</code>, which is located in <span class="strong"><strong>RPG </strong></span>under <span class="strong"><strong>Source</strong></span>, and add a public <code class="literal">UProperty</code> to the <code class="literal">UCharacter</code> class for gold similar to that in <code class="literal">FEnemyInfo.h</code>:</p><div class="informalexample"><pre class="programlisting">UPROPERTY(BlueprintReadWrite,EditAnywhere, Category = CharacterInfo)
  int32 Gold;</pre></div><p>Then, head <a id="id427" class="indexterm"/>into <code class="literal">GameCharacter.cpp</code> to set the return value of the gold <a id="id428" class="indexterm"/>that is equal to the value set in <code class="literal">EnemyInfo</code>, so that each instance of this particular enemy will return the amount of gold set in the enemy's data table:</p><div class="informalexample"><pre class="programlisting">character-&gt;Gold = enemyInfo-&gt;Gold;</pre></div><p>When you are finished, the enemy's character information in <code class="literal">GameCharacter.cpp</code> will look like this:</p><div class="informalexample"><pre class="programlisting">UGameCharacter* UGameCharacter::CreateGameCharacter(FEnemyInfo* enemyInfo, UObject* outer)
{
 UGameCharacter* character = NewObject&lt;UGameCharacter&gt;(outer);

 character-&gt;CharacterName = enemyInfo-&gt;EnemyName;
 character-&gt;ClassInfo = nullptr;

 character-&gt;MHP = enemyInfo-&gt;MHP;
 character-&gt;MMP = 0;
 character-&gt;HP = enemyInfo-&gt;MHP;
 character-&gt;MP = 0;

 character-&gt;ATK = enemyInfo-&gt;ATK;
 character-&gt;DEF = enemyInfo-&gt;DEF;
 character-&gt;LUCK = enemyInfo-&gt;Luck;
 character-&gt;Gold = enemyInfo-&gt;Gold;

 character-&gt;decisionMaker = new TestDecisionMaker();
 character-&gt;isPlayer = false;
 return character;
}</pre></div><p>We now need to choose when to accumulate the gold, and in this case, we will accumulate the gold from combat. So, navigate to <span class="strong"><strong>Source</strong></span> | <span class="strong"><strong>RPG</strong></span> | <span class="strong"><strong>Combat</strong></span>, open <code class="literal">CombatEngine.h</code>, and create a public gold variable that we will use to store all the gold won in the battle:</p><div class="informalexample"><pre class="programlisting">int32 GoldTotal;</pre></div><p>When you have<a id="id429" class="indexterm"/> finished declaring the <code class="literal">GoldTotal</code> variable, the <code class="literal">CombatEngine.h</code> file will <a id="id430" class="indexterm"/>look like this:</p><div class="informalexample"><pre class="programlisting">#pragma once
#include "RPG.h"
#include "GameCharacter.h"


/**
 * 
 */
enum class CombatPhase : uint8
{
 CPHASE_Decision,
 CPHASE_Action,
 CPHASE_Victory,
 CPHASE_GameOver,
};

class RPG_API CombatEngine
{
public:
 TArray&lt;UGameCharacter*&gt; combatantOrder;

 TArray&lt;UGameCharacter*&gt; playerParty;
 TArray&lt;UGameCharacter*&gt; enemyParty;

 CombatPhase phase;
 int32 GoldTotal;

protected:
 UGameCharacter* currentTickTarget;
 int tickTargetIndex;
 bool waitingForCharacter;

public:
 CombatEngine(TArray&lt;UGameCharacter*&gt; playerParty,
  TArray&lt;UGameCharacter*&gt; enemyParty);
 ~CombatEngine();

 bool Tick(float DeltaSeconds);

protected:
 void SetPhase(CombatPhase phase);
 void SelectNextCharacter();
};</pre></div><p>The next step that we need to perform is telling the engine when to give the gold to the player. As mentioned <a id="id431" class="indexterm"/>earlier, we want players to win gold from enemies that can easily be integrated into our combat engine. Navigate to <span class="strong"><strong>Source</strong></span> | <span class="strong"><strong>RPG</strong></span> | <span class="strong"><strong>Combat</strong></span>, and open <code class="literal">CombatEngine.cpp</code>. Let's <a id="id432" class="indexterm"/>first scroll down to the <code class="literal">for</code> loop that we created in <a class="link" href="ch03.html" title="Chapter 3. Exploration and Combat">Chapter 3</a>, <span class="emphasis"><em>Exploration and Combat</em></span>, to check for a victory. Just above this <code class="literal">for</code> loop, declare a new <code class="literal">Gold</code> integer, and set it to <code class="literal">0</code>:</p><div class="informalexample"><pre class="programlisting">int32 Gold = 0;</pre></div><p>This will assure that, if we don't have a victory and need to cycle through the <code class="literal">for</code> loop again, the gold gained in battle will reset to 0. Next, we need to accumulate the gold from every enemy killed; thus, within the <code class="literal">for</code> loop, we have <code class="literal">Gold</code> increment by each enemy's gold:</p><div class="informalexample"><pre class="programlisting">Gold += this-&gt;enemyParty[i]-&gt;Gold;</pre></div><p>Your <code class="literal">for</code> loop will now look like this:</p><div class="informalexample"><pre class="programlisting">for( int i = 0; i &lt; this-&gt;enemyParty.Num(); i++ )
{
  if( this-&gt;enemyParty[i]-&gt;HP &lt;= 0 ) deadCount++;
  Gold += this-&gt;enemyParty[i]-&gt;Gold;
}</pre></div><p>After the <code class="literal">for</code> loop, you will still have an <code class="literal">if</code> condition that checks whether the enemy party is dead; if the enemy party is dead, the combat phase will change to the victory phase. If the condition is <code class="literal">true</code>, it means that we won the battle; therefore, we should be rewarded with the gold from the <code class="literal">for</code> loop. Since the <code class="literal">Gold</code> variable that we want to add is in the <code class="literal">GoldTotal</code> variable, we simply set the local <code class="literal">Gold</code> variable to the new value of <code class="literal">GoldTotal</code>:</p><div class="informalexample"><pre class="programlisting">GoldTotal = Gold;</pre></div><p>When you are finished, your <code class="literal">if</code> condition will now look like this:</p><div class="informalexample"><pre class="programlisting">if (deadCount == this-&gt;enemyParty.Num())
 {
  this-&gt;SetPhase(CombatPhase::CPHASE_Victory);
  GoldTotal = Gold;
  return false;
 }</pre></div><p>Now that we have set enemies to drop gold after the player is victorious in battle, the next thing that we need to do is add gold to our game data; more specifically, it would be best to add it in <code class="literal">RPGGameInstance.h</code>, since an instance of the game will always be active. It would be unwise to add the gold data to a party member unless there is a specific party member who will always be in the game. So, let's open <code class="literal">RPGGameInstance.h</code> located in <span class="strong"><strong>RPG</strong></span> under <span class="strong"><strong>Source</strong></span>.</p><p>As a public property, add another integer to <code class="literal">Game Data</code> that we will call <code class="literal">GameGold</code>. Also, ensure that <code class="literal">GameGold</code> is read- and write-enabled because we want to be able to add and subtract gold; therefore editing of <code class="literal">GameGold</code> must be enabled:</p><div class="informalexample"><pre class="programlisting">UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Game Data")
    int32 GameGold;</pre></div><p>Now that we <a id="id433" class="indexterm"/>can <a id="id434" class="indexterm"/>create instances of <code class="literal">GameGold</code>, go to your <code class="literal">RPGGameMode.cpp</code> file where you originally set up the logic for the game over and victory conditions; in the victory condition, create a pointer to <code class="literal">URPGGameInstance</code> that we will call <code class="literal">gameInstance</code>, and set it equal to a cast to <code class="literal">GetGameInstance</code>:</p><div class="informalexample"><pre class="programlisting">URPGGameInstance* gameInstance = Cast&lt;URPGGameInstance&gt;(GetGameInstance());</pre></div><p>We can now use <code class="literal">gameInstance</code> to add the total gold that we got from the battle to <code class="literal">GameGold</code>:</p><div class="informalexample"><pre class="programlisting">gameInstance-&gt;GameGold += this-&gt;currentCombatInstance-&gt;GoldTotal;</pre></div><p>At this point, the value of <code class="literal">GameGold</code> that we are using as the player's gold will now be incremented by the gold won in the battle. The <code class="literal">tick</code> function in <code class="literal">RPGGameMode.cpp</code> will now look like this:</p><div class="informalexample"><pre class="programlisting">void ARPGGameMode::Tick( float DeltaTime )
{
  if( this-&gt;currentCombatInstance != nullptr )
  {
    bool combatOver = this-&gt;currentCombatInstance-&gt;Tick( DeltaTime );
    if( combatOver )
    {
      if( this-&gt;currentCombatInstance-&gt;phase == CombatPhase::CPHASE_GameOver )
      {
        UE_LOG( LogTemp, Log, TEXT( "Player loses combat, game over" ) );

        Cast&lt;URPGGameInstance&gt;( GetGameInstance() )-&gt;PrepareReset();

        UUserWidget* GameOverUIInstance = CreateWidget&lt;UUserWidget&gt;( GetGameInstance(), this-&gt;GameOverUIClass );
        GameOverUIInstance-&gt;AddToViewport();
      }
      else if( this-&gt;currentCombatInstance-&gt;phase == CombatPhase::CPHASE_Victory )
      {
        UE_LOG( LogTemp, Log, TEXT( "Player wins combat" ) );
        //add gold to total gold
        URPGGameInstance* gameInstance = Cast&lt;URPGGameInstance&gt;(GetGameInstance());
        gameInstance-&gt;GameGold += this-&gt;currentCombatInstance-&gt;GoldTotal;

        // enable player actor
        UGameplayStatics::GetPlayerController( GetWorld(), 0 )-&gt;SetActorTickEnabled( true );
      }

      for( int i = 0; i &lt; this-&gt;currentCombatInstance-&gt;playerParty.Num(); i++ )
      {
        this-&gt;currentCombatInstance-&gt;playerParty[i]-&gt;decisionMaker = nullptr;
      }

      this-&gt;CombatUIInstance-&gt;RemoveFromViewport();
      this-&gt;CombatUIInstance = nullptr;

      delete( this-&gt;currentCombatInstance );
      this-&gt;currentCombatInstance = nullptr;
      this-&gt;enemyParty.Empty();
    }
  }
}</pre></div><p>Now, you <a id="id435" class="indexterm"/>need to <a id="id436" class="indexterm"/>make sure that all your changes are saved and recompile your entire project (you may need to restart UE4).</p><p>We can now adjust the gold value of each enemy character that we have from the enemy's Data Table. In <span class="strong"><strong>Content Browser</strong></span>, navigate to the <span class="strong"><strong>Enemies</strong></span> Data Table located at <span class="strong"><strong>Data </strong></span>under <span class="strong"><strong>Content</strong></span>. In the Data Table, you will now see a <span class="strong"><strong>Gold</strong></span> row. Add any value that you want to the <span class="strong"><strong>Gold</strong></span> row, and save the Data Table:</p><div class="mediaobject"><img src="graphics/B04548_07_01.jpg" alt="Setting and getting gold instances"/></div><p>Now that an enemy <a id="id437" class="indexterm"/>has a gold value, there is a real value that is bound to the <code class="literal">Gold</code> variable in <code class="literal">EnemyInfo</code> that gets added to <code class="literal">GameGold</code> if the player is victorious in battle. However, we need to display that gold; luckily, we still have a placeholder for the gold in <a id="id438" class="indexterm"/>our pause menu. Open the <span class="strong"><strong>Pause_Main</strong></span> Widget Blueprint, and click on the <span class="strong"><strong>Editable_Gold</strong></span> Text Block that we created in <a class="link" href="ch04.html" title="Chapter 4. Pause Menu Framework">Chapter 4</a>, <span class="emphasis"><em>Pause Menu Framework</em></span>. In the <span class="strong"><strong>Details</strong></span> panel, go to <span class="strong"><strong>Content</strong></span> and create a binding for the Text Block, which will open the graph for <span class="strong"><strong>Get Editable Gold Text</strong></span>:</p><div class="mediaobject"><img src="graphics/B04548_07_02.jpg" alt="Setting and getting gold instances"/></div><p>The first thing that we need to do is get the game instance of <span class="strong"><strong>RPGGameInstance</strong></span> by creating a <span class="strong"><strong>Get Game Instance</strong></span> function located under <span class="strong"><strong>Game</strong></span> and setting it as an object of <span class="strong"><strong>Cast To RPGGameInstance</strong></span>:</p><div class="mediaobject"><img src="graphics/B04548_07_03.jpg" alt="Setting and getting gold instances"/></div><p>We can then get <a id="id439" class="indexterm"/>the <code class="literal">GameGold</code> variable from <span class="strong"><strong>RPGGameInstance</strong></span>, which<a id="id440" class="indexterm"/> is the variable that stores the current gold total for the game. It is located in <span class="strong"><strong>Game Data </strong></span>under <span class="strong"><strong>Variables</strong></span>. Link it to the <span class="strong"><strong>As RPGGameInstance</strong></span> pin in <span class="strong"><strong>Cast To RPGGameInstance</strong></span>:</p><div class="mediaobject"><img src="graphics/B04548_07_04.jpg" alt="Setting and getting gold instances"/></div><p>Lastly, link <span class="strong"><strong>Game Gold</strong></span> to <span class="strong"><strong>Return Value</strong></span> in <span class="strong"><strong>ReturnNode</strong></span> and allow <span class="strong"><strong>Get Editable Gold Text</strong></span> to trigger <span class="strong"><strong>Cast To RPGGameInstance</strong></span>, which will<a id="id441" class="indexterm"/> trigger <span class="strong"><strong>ReturnNode</strong></span>. Your <span class="strong"><strong>Get Editable Gold Text</strong></span> binding <a id="id442" class="indexterm"/>will now look like this:</p><div class="mediaobject"><img src="graphics/B04548_07_05.jpg" alt="Setting and getting gold instances"/></div><p>If you test this now, you will be able to get into battle, win gold from your enemies on victory, and now you will be able to see your gold accumulate in your pause menu. We can use these same variables to add to any menu system, including a shop.</p></div></div>
<div class="section" title="Item data"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec48"/>Item data</h1></div></div></div><p>Now that we are<a id="id443" class="indexterm"/> finished with the gold creation, we need to create one more thing before we make a shop, that is, items. There are many ways to make items, but it is best to keep an inventory and stats of items through the use of Data Tables. So, let's first create a new C++ <code class="literal">FTableRowBase</code> struct similar to the <code class="literal">CharacterInfo</code> structs that you previously created. Our files will be called <code class="literal">ItemsData.h</code> and <code class="literal">ItemsData.cpp</code>, and we will put these files where our other data is; that is, by navigating to <span class="strong"><strong>Source</strong></span> | <span class="strong"><strong>RPG</strong></span> | <span class="strong"><strong>Data</strong></span>. The <code class="literal">ItemsData.cpp</code> source file will include the following two header files:</p><div class="informalexample"><pre class="programlisting">#include "RPG.h"
#include "ItemsData.h"</pre></div><p>The <code class="literal">ItemsData.h</code> header file will contain definitions of all the item data that we will need. In this case, the item data will be stats that the player has, since items will most likely affect stats. The stats only need to be of the integer type and read-enabled since we won't be changing the value of any of the items directly. Your <code class="literal">ItemsData.h</code> file will look something like this:</p><div class="informalexample"><pre class="programlisting">#pragma once

#include "GameFramework/Actor.h"
#include "ItemsData.generated.h"

/**
 *
 */

USTRUCT( BlueprintType )
struct FItemsData : public FTableRowBase
{
  GENERATED_USTRUCT_BODY()

  UPROPERTY( BlueprintReadOnly, EditAnywhere, Category = "ItemData" )
    int32 HP;

  UPROPERTY( BlueprintReadOnly, EditAnywhere, Category = "ItemData" )
    int32 MP;

  UPROPERTY( BlueprintReadOnly, EditAnywhere, Category = "ItemData" )
    int32 ATK;

  UPROPERTY( BlueprintReadOnly, EditAnywhere, Category = "ItemData" )
    int32 DEF;

  UPROPERTY( BlueprintReadOnly, EditAnywhere, Category = "ItemData" )
    int32 Luck;

  UPROPERTY( BlueprintReadOnly, EditAnywhere, Category = "ItemData" )
    int32 Gold;
};</pre></div><p>At this point, you can<a id="id444" class="indexterm"/> recompile, and you are now ready to create your own Data Table. Since we are creating a shop, let's create a Data Table for the shop in <span class="strong"><strong>Content Browser</strong></span> and in the <code class="literal">Data</code> folder by navigating to <span class="strong"><strong>Miscellaneous</strong></span> | <span class="strong"><strong>Data Table</strong></span>, and then using <span class="strong"><strong>Items Data</strong></span> as the structure.</p><div class="mediaobject"><img src="graphics/B04548_07_06.jpg" alt="Item data"/></div><p>Name your new <a id="id445" class="indexterm"/>Data Table <span class="strong"><strong>Items_Shop</strong></span>, and then open the Data Table. Here, you can add as many items as you want with whatever kinds of stat you would like using the <span class="strong"><strong>Row Editor</strong></span> tab. To make an item, first click on the <span class="strong"><strong>Add</strong></span> button in <span class="strong"><strong>Row Editor</strong></span> to add a new row. Then, click on the textbox next to <span class="strong"><strong>Rename</strong></span> and type in <span class="strong"><strong>Potion</strong></span>. You will see that you have a potion item with all the other stats zeroed out:</p><div class="mediaobject"><img src="graphics/B04548_07_07.jpg" alt="Item data"/></div><p>Next, give it some <a id="id446" class="indexterm"/>values. I will make this a healing potion; therefore, I will give it an <span class="strong"><strong>HP</strong></span> value of <span class="strong"><strong>50</strong></span> and a <span class="strong"><strong>Gold</strong></span> value of <span class="strong"><strong>10</strong></span>.</p><div class="mediaobject"><img src="graphics/B04548_07_08.jpg" alt="Item data"/></div><p>The purpose of this Data Table is also to store every item that our shop owner will carry. So, feel free to add more items to this Data Table:</p><div class="mediaobject"><img src="graphics/B04548_07_09.jpg" alt="Item data"/></div></div>
<div class="section" title="The shop screen framework"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec49"/>The shop screen framework</h1></div></div></div><p>Now <a id="id447" class="indexterm"/>that we are done with creating items, we can move on to creating the shop. In the previous chapter, we created dialog boxes for our shop owner, and in one of the dialog boxes, we created a <span class="strong"><strong>Shop</strong></span> button that, when clicked, will open up a shop menu. Let's create this shop menu by first creating a new Widget Blueprint by navigating to <span class="strong"><strong>Content</strong></span> | <span class="strong"><strong>Blueprints</strong></span> | <span class="strong"><strong>UI</strong></span> | <span class="strong"><strong>NPC</strong></span>. We will call this Widget Blueprint <span class="strong"><strong>Shop</strong></span> and open it:</p><div class="mediaobject"><img src="graphics/B04548_07_10.jpg" alt="The shop screen framework"/></div><p>We will make the <a id="id448" class="indexterm"/>shop in a similar format to that of our pause menu, but we will keep it simple because all we need for now is a Scroll Box that will hold the shop's items, as well as an area for gold, and an <span class="strong"><strong>Exit</strong></span> button.</p><p>To expedite this process, you can simply copy and paste the elements from your existing menu systems that you wish to reuse into the <span class="strong"><strong>Shop</strong></span> Widget Blueprint. We can do this by navigating to <span class="strong"><strong>Content</strong></span> | <span class="strong"><strong>Blueprints</strong></span> | <span class="strong"><strong>UI</strong></span> and opening the <span class="strong"><strong>Pause_Main</strong></span> and <span class="strong"><strong>Pause_Inventory</strong></span> Widget Blueprints, which we created in the previous chapters. From <span class="strong"><strong>Pause_Main</strong></span>, we can copy the <span class="strong"><strong>Menu_Gold</strong></span>, <span class="strong"><strong>Editable_Gold</strong></span>, <span class="strong"><strong>Button_Exit</strong></span>, <span class="strong"><strong>Menu_Exit</strong></span>, and <span class="strong"><strong>BG_Color</strong></span>, and paste them into the <span class="strong"><strong>Shop</strong></span> Widget Blueprint.</p><p>We can also copy the <span class="strong"><strong>ScrollBox_Inventory</strong></span> and <span class="strong"><strong>Title_Inventory</strong></span> from the <span class="strong"><strong>Pause_Inventory</strong></span> Widget Blueprint and paste them into the <span class="strong"><strong>Shop</strong></span> Widget Blueprint. When you are done, your <span class="strong"><strong>Shop</strong></span> Widget Blueprint will look like this:</p><div class="mediaobject"><img src="graphics/B04548_07_11.jpg" alt="The shop screen framework"/></div><p>Here, edit the <span class="strong"><strong>Shop</strong></span> Widget <a id="id449" class="indexterm"/>Blueprint so that the title reads as <span class="strong"><strong>Shop</strong></span> instead of <span class="strong"><strong>Inventory</strong></span>:</p><div class="mediaobject"><img src="graphics/B04548_07_12.jpg" alt="The shop screen framework"/></div><p>You will now need<a id="id450" class="indexterm"/> to link the <span class="strong"><strong>Shop</strong></span> Widget Blueprint to the Shop button in the <span class="strong"><strong>Shop_Welcome</strong></span> Widget Blueprint. To do this, open the <span class="strong"><strong>Shop_Welcome</strong></span> Widget Blueprint by navigating to <span class="strong"><strong>Content</strong></span> | <span class="strong"><strong>Blueprints</strong></span> | <span class="strong"><strong>UI</strong></span> | <span class="strong"><strong>NPC</strong></span>, select <span class="strong"><strong>Button_Shop</strong></span>, and then click on the <span class="strong"><strong>+</strong></span> button to the right of the <span class="strong"><strong>OnClicked</strong></span> event by navigating to <span class="strong"><strong>Details</strong></span> | <span class="strong"><strong>Events</strong></span>:</p><div class="mediaobject"><img src="graphics/B04548_07_13.jpg" alt="The shop screen framework"/></div><p>This will <a id="id451" class="indexterm"/>automatically open the graph with a newly created <span class="strong"><strong>OnClicked</strong></span> event for <span class="strong"><strong>Button_Shop</strong></span>:</p><div class="mediaobject"><img src="graphics/B04548_07_14.jpg" alt="The shop screen framework"/></div><p>Here, you can simply mimic the same actions you used to open the dialog boxes when the player clicks on the <span class="strong"><strong>Talk</strong></span> button. The only difference is that, instead of creating a new <span class="strong"><strong>Shop_Talk</strong></span> widget, the <span class="strong"><strong>Shop</strong></span> widget will create the <span class="strong"><strong>Create Shop Widget</strong></span> for you. The graph for <span class="strong"><strong>Button_Shop</strong></span> will look like the following screenshot:</p><div class="mediaobject"><img src="graphics/B04548_07_15.jpg" alt="The shop screen framework"/></div><p>You will now <a id="id452" class="indexterm"/>be able to test the shop by talking to the NPC and clicking on the <span class="strong"><strong>Shop</strong></span> button, which will now open the shop:</p><div class="mediaobject"><img src="graphics/B04548_07_16.jpg" alt="The shop screen framework"/></div><p>You will <a id="id453" class="indexterm"/>notice that nothing is yet visible in the shop, not even the gold. To display the gold on the screen, you need to repeat the steps you performed earlier in this chapter when you displayed the gold in the <span class="strong"><strong>Pause_Main</strong></span> Widget Blueprint. But this time, open the graph in the <span class="strong"><strong>Shop</strong></span> Widget Blueprint, and then create a binding for the <span class="strong"><strong>Editable_Gold</strong></span> Text Block by navigating to <span class="strong"><strong>Details</strong></span> | <span class="strong"><strong>Context</strong></span>:</p><div class="mediaobject"><img src="graphics/B04548_07_17.jpg" alt="The shop screen framework"/></div><p>Your graph will <a id="id454" class="indexterm"/>automatically open, and you will notice a <span class="strong"><strong>Get Editable Gold Text</strong></span> function with a <span class="strong"><strong>ReturnNode</strong></span>. Since you will be getting the gold from the same game instance that you did when getting the gold from the <span class="strong"><strong>Pause_Main</strong></span> Widget Blueprint, you can simply copy and paste all the nodes from the <span class="strong"><strong>Get Editable Gold Text</strong></span> function into <span class="strong"><strong>Pause_Main</strong></span>, and link them to the <span class="strong"><strong>Get Editable Text</strong></span> function in the <span class="strong"><strong>Shop</strong></span> Widget Blueprint. When you are done, the <span class="strong"><strong>Get Editable Gold Text</strong></span> function in the <span class="strong"><strong>Shop</strong></span> Widget Blueprint will look like this:</p><div class="mediaobject"><img src="graphics/B04548_07_18.jpg" alt="The shop screen framework"/></div><p>Next, we will create<a id="id455" class="indexterm"/> the <span class="strong"><strong>Button_Exit</strong></span> functionality in the <span class="strong"><strong>Shop</strong></span> Widget Blueprint by creating an <span class="strong"><strong>OnClicked</strong></span> event (by navigating to <span class="strong"><strong>Details</strong></span> | <span class="strong"><strong>Events</strong></span>) for <span class="strong"><strong>Button_Exit</strong></span>:</p><div class="mediaobject"><img src="graphics/B04548_07_19.jpg" alt="The shop screen framework"/></div><p>When the graph opens, link the <span class="strong"><strong>OnClicked</strong></span> event to the <span class="strong"><strong>Remove from Parent</strong></span> function:</p><div class="mediaobject"><img src="graphics/B04548_07_20.jpg" alt="The shop screen framework"/></div><p>At this point, when <a id="id456" class="indexterm"/>you test the shop, you will see the gold and be able to exit the shop screen.</p></div>
<div class="section" title="The item button framework"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec50"/>The item button framework</h1></div></div></div><p>Before we <a id="id457" class="indexterm"/>link our items to the shop, we will first need to create a framework in which the items are placed in the shop. What we would like to do is create a button for each item that the shop owner sells but, in order to make the interface scalable in such a way that NPCs can hold different selectable items, it would be wise to create a Scroll Box framework that holds a single button with a default value for the item's text/description. We can then dynamically draw the button for as many items as the shop owner carries, as well as dynamically draw the text on each button.</p><p>To do this, we must first create a Widget Blueprint by navigating to <span class="strong"><strong>Content</strong></span> | <span class="strong"><strong>Blueprints</strong></span> | <span class="strong"><strong>UI</strong></span> and call it <span class="strong"><strong>Item</strong></span>:</p><div class="mediaobject"><img src="graphics/B04548_07_21.jpg" alt="The item button framework"/></div><p>Open <span class="strong"><strong>Item</strong></span>. Since we<a id="id458" class="indexterm"/> are going to make the items clickable, we will program a button. To make the button, all that we will need is the button itself and text for the button; we will not need a Canvas Panel because we will eventually be adding this button to the Scroll Box of our shop. So, from the <span class="strong"><strong>Hierarchy</strong></span> tab, delete the Canvas Panel, and drag a button from <span class="strong"><strong>Palette</strong></span>. We will name this button, <span class="strong"><strong>Button_Item</strong></span>:</p><div class="mediaobject"><img src="graphics/B04548_07_24.jpg" alt="The item button framework"/></div><p>Finally, we will place a Text Block in the button that we just created and name it <span class="strong"><strong>TextBlock_Item</strong></span>:</p><div class="mediaobject"><img src="graphics/B04548_07_25.jpg" alt="The item button framework"/></div><p>Once done, navigate<a id="id459" class="indexterm"/> to <span class="strong"><strong>Details</strong></span> | <span class="strong"><strong>Content</strong></span>, and create a binding for the text in the Text Block. This will automatically open the graph with a <span class="strong"><strong>Get Text</strong></span> function:</p><div class="mediaobject"><img src="graphics/B04548_07_26.jpg" alt="The item button framework"/></div><p>Create a <a id="id460" class="indexterm"/>new <span class="strong"><strong>Item</strong></span> variable of the <span class="strong"><strong>Text</strong></span> type:</p><div class="mediaobject"><img src="graphics/B04548_07_27.jpg" alt="The item button framework"/></div><p>Drag the <span class="strong"><strong>Item</strong></span> variable into<a id="id461" class="indexterm"/> the graph, select <span class="strong"><strong>Get</strong></span> to drop in a getter for the <span class="strong"><strong>Item</strong></span> variable, and then link it to the <span class="strong"><strong>Return Value</strong></span> pin of <span class="strong"><strong>ReturnNode</strong></span>:</p><div class="mediaobject"><img src="graphics/B04548_07_28.jpg" alt="The item button framework"/></div></div>
<div class="section" title="Linking the item data"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec51"/>Linking the item data</h1></div></div></div><p>It is now time to<a id="id462" class="indexterm"/> link the item data that we created at the beginning of this chapter to the shop using the <span class="strong"><strong>Item</strong></span> button framework we just created. To do this, we will add a functionality to display every item in our <span class="strong"><strong>Items_Shop</strong></span> Data Table using the <span class="strong"><strong>Item</strong></span> button framework that we created in the previous section. First, open <span class="strong"><strong>Event Graph</strong></span> in the <span class="strong"><strong>Shop</strong></span> Widget Blueprint. Link the <span class="strong"><strong>Get Data Table Row Names</strong></span> function located in Data Tables to <span class="strong"><strong>Event Construct</strong></span>:</p><div class="mediaobject"><img src="graphics/B04548_07_29.jpg" alt="Linking the item data"/></div><p>Then, from the <span class="strong"><strong>Select Asset</strong></span> drop-down menu, select <span class="strong"><strong>Items_Shop</strong></span>:</p><div class="mediaobject"><img src="graphics/B04548_07_30.jpg" alt="Linking the item data"/></div><p>This will get the names <a id="id463" class="indexterm"/>of every item in the <span class="strong"><strong>Items_Shop</strong></span> Data table that we created earlier in this chapter. Here, we need to create an instance of the <span class="strong"><strong>Item</strong></span> Widget Blueprint for every item row. This will create a button for every item with the correct corresponding item name. To do this, create a <span class="strong"><strong>ForEachLoop</strong></span> located at <span class="strong"><strong>Array</strong></span> under <span class="strong"><strong>Utilities</strong></span> and allow the <span class="strong"><strong>Get Data Table Row Names</strong></span> function to execute it. Link the <span class="strong"><strong>Out Row Names</strong></span> pin to the <span class="strong"><strong>Array</strong></span> pin of the <span class="strong"><strong>ForEachLoop</strong></span> so that every row in the Data Table becomes an element of the array in the <span class="strong"><strong>ForEachLoop</strong></span>:</p><div class="mediaobject"><img src="graphics/B04548_07_31.jpg" alt="Linking the item data"/></div><p>Next, we need to<a id="id464" class="indexterm"/> loop through each element of the array of row names and, for each row, we need to create a new instance of the <span class="strong"><strong>Item</strong></span> Widget Blueprint. To do this, link the <span class="strong"><strong>Create Item Widget</strong></span> action located under <span class="strong"><strong>User Interface</strong></span> to the <span class="strong"><strong>Loop Body</strong></span> pin in the <span class="strong"><strong>ForEachLoop</strong></span>. Let the class instance be <span class="strong"><strong>Item</strong></span> that can be selected from the <span class="strong"><strong>Class</strong></span> drop-down menu in the <span class="strong"><strong>Create Item Widget</strong></span> action:</p><div class="mediaobject"><img src="graphics/B04548_07_41.jpg" alt="Linking the item data"/></div><p>Then, for every item created, set the <span class="strong"><strong>Item</strong></span> variable that is created for every <span class="strong"><strong>Item</strong></span> widget instance to the value of each element in the array. You can create the <span class="strong"><strong>Set Item</strong></span> action, by right-clicking anywhere in <span class="strong"><strong>Event Graph</strong></span>, unchecking <span class="strong"><strong>Context Sensitive</strong></span>, and locating <span class="strong"><strong>Set Item</strong></span> by navigating to <span class="strong"><strong>Class</strong></span> | <span class="strong"><strong>Item</strong></span>:</p><div class="mediaobject"><img src="graphics/B04548_07_33.jpg" alt="Linking the item data"/></div><p>
<span class="strong"><strong>Create Item Widget</strong></span> can <a id="id465" class="indexterm"/>now launch <span class="strong"><strong>Set Item</strong></span>, and set the <span class="strong"><strong>Return Value</strong></span> pin value of <span class="strong"><strong>Create Item Widget</strong></span> to the <span class="strong"><strong>Target</strong></span> pin value of <span class="strong"><strong>Item</strong></span>:</p><div class="mediaobject"><img src="graphics/B04548_07_32.jpg" alt="Linking the item data"/></div><p>At this point, we have not yet set the element of the array to the item that we set in the <span class="strong"><strong>Item</strong></span> widget; so, to do this, we can simply link the <span class="strong"><strong>Array Element</strong></span> pin from the <span class="strong"><strong>ForEachLoop</strong></span> to the <span class="strong"><strong>Item</strong></span> pin in the <span class="strong"><strong>Set Item</strong></span> action:</p><div class="mediaobject"><img src="graphics/B04548_07_36.jpg" alt="Linking the item data"/></div><p>Lastly, we are <a id="id466" class="indexterm"/>going to have our Scroll Box that we created in the <span class="strong"><strong>Shop</strong></span> Widget Blueprint hold all of our item instances. To do this, after we set each item to the correct name, we will add the item instance as a child to the <span class="strong"><strong>ScrollBox_Inventory</strong></span> Scroll Box that we created earlier in this chapter. This is done by simply calling the <span class="strong"><strong>Add Child</strong></span> function located in <span class="strong"><strong>Panel</strong></span> under <span class="strong"><strong>Widget</strong></span> after we set the item:</p><div class="mediaobject"><img src="graphics/B04548_07_37.jpg" alt="Linking the item data"/></div><p>Then, we set the <span class="strong"><strong>Content</strong></span> value of the child to the <span class="strong"><strong>Return Value</strong></span> pin of the item:</p><div class="mediaobject"><img src="graphics/B04548_07_38.jpg" alt="Linking the item data"/></div><p>Lastly, the <span class="strong"><strong>Target</strong></span> pin <a id="id467" class="indexterm"/>of the child needs to be linked to <span class="strong"><strong>ScrollBox_Inventory</strong></span>, which can be dragged into your <span class="strong"><strong>Event Graph</strong></span> from <span class="strong"><strong>Variables</strong></span>. If you do not see the <span class="strong"><strong>ScrollBox_Inventory</strong></span> variable in your variables, go back to the <span class="strong"><strong>Designer View</strong></span>, select the <span class="strong"><strong>ScrollBox_Inventory</strong></span>, and make sure <span class="strong"><strong>is variable</strong></span> is checked:</p><div class="mediaobject"><img src="graphics/B04548_07_39.jpg" alt="Linking the item data"/></div><p>At this point, if you test your shop, you will see the shop populated with every item listed in your Data Table:</p><div class="mediaobject"><img src="graphics/B04548_07_40.jpg" alt="Linking the item data"/></div><p>You will be able to <a id="id468" class="indexterm"/>add even more items to your Data Table and these items will automatically appear in your shop.</p></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec52"/>Summary</h1></div></div></div><p>In this chapter, we created a currency system for our game along with the ability for our enemies to drop gold. We also created a new set of data that contains items and their stats, and we have now populated the shop owner's store to display the items currently for sale in the shop.</p><p>In the next chapter, we will add the buying functionality to the shop along with the usage of an item and consumption.</p></div></body></html>