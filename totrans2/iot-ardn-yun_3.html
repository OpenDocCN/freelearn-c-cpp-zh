<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Making Your Own Cloud-connected Camera</h1></div></div></div><p>In this project, we are going to build a security camera that automatically uploads pictures to the Web. We will connect a<a id="id80" class="indexterm"/> camera to the Arduino Yún board, and use its powerful features to control this camera easily and upload pictures to the Web. What we are going to build is a system that can detect motion, and if some motion is detected, can automatically take a picture and save it both on the local SD card attached to the Yún board and to a cloud storage; in our case, Dropbox. We are also going to make the camera stream a video live on a private YouTube feed.</p><div><div><div><div><h1 class="title"><a id="ch03lvl1sec19"/>Getting started</h1></div></div></div><p>Let's see what we are going to do in this project in more detail:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">First, we are going to build the hardware part of the project with a typical USB camera, a PIR motion sensor, and one SD card.</li><li class="listitem" style="list-style-type: disc">Then, we will write some code to test all the hardware connections of the project. We'll check whether the motion sensor is working correctly and try to take a picture with the camera while it is connected to the Arduino Yún board.</li><li class="listitem" style="list-style-type: disc">After testing the hardware, we are going to build the first application, which captures pictures whenever some motion is detected and automatically stores these pictures on the SD card.</li><li class="listitem" style="list-style-type: disc">Right after building this simple local application, we are going to connect the project to the cloud. The project will do the same as in the earlier case, take pictures when some motion is detected, but this time the pictures will also be uploaded to your Dropbox folder. This way, the pictures can be seen in real time from anywhere, as you can log in to Dropbox from any web browser.</li><li class="listitem" style="list-style-type: disc">Finally, we are going to stream a video to the Web, so you can always check what's going on in your home from a mobile phone or tablet, wherever you are in the world. For this application, we are going to install a streaming library on the Yún board and make it continuously stream a video over Wi-Fi. This stream will be acquired by your computer and sent to YouTube via a dedicated software. On YouTube, we will then be able to access this live stream just as you would watch a typical YouTube video.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec20"/>The required hardware and software components</h1></div></div></div><p>First, let's see which<a id="id81" class="indexterm"/> components we need for the project. Apart from the Yún board, you will need three components: a USB camera, a PIR motion sensor, and an SD card. We will only make direct connections to Yún in this part, so you won't need a breadboard to make electrical connections.</p><p>The most important <a id="id82" class="indexterm"/>component of this project is the USB camera. We are using a standard USB webcam from Logitech, the C700 model, which can record pictures up to the HD resolution. Of course, you can use other cameras if you already have one on your desk. Make sure that the camera is compatible with<a id="id83" class="indexterm"/> <strong>USB Video Class</strong> (<strong>UVC</strong>). Most of the recent webcams are compatible with this protocol. It might work with a camera that is not officially compatible with UVC, but there is no guarantee. You can find a list of all UVC compatible cameras at <a class="ulink" href="http://en.wikipedia.org/wiki/List_of_USB_video_class_devices">http://en.wikipedia.org/wiki/List_of_USB_video_class_devices</a>.</p><p>Also, try to choose a camera with at least HD resolution, so you can get nice and clear pictures. It's not so important for the streaming part, but can be great if you want to use this project for other applications than security, for example, to create time-lapse videos. The following is an image of the USB camera we are using, the C700 USB webcam from Logitech:</p><div><img src="img/8007OS_03_01.jpg" alt="The required hardware and software components"/></div><p>Then, there is the PIR motion sensor<a id="id84" class="indexterm"/>. This sensor is a really inexpensive sensor that uses infrared pictures to detect motion in a room from anything that emits heat, such as humans. We could have used the camera directly to detect motion, but that would have not been so efficient. The camera uses quite a lot of power when it is on, whereas a PIR motion sensor uses nearly no power. It would also have been more difficult to write the software required to detect motion efficiently from the camera recording. We used a PIR motion sensor from Parallax, which you can see in the following image:</p><div><img src="img/8007OS_03_02.jpg" alt="The required hardware and software components"/></div><p>Again, you can use other brands of PIR sensors. The main thing to consider is that it should work with 5V voltage levels because that is the voltage level used by the Yún. Most sensors work with both 3.3V and 5V voltage levels, so you shouldn't have many problems with this characteristic. When motion is detected, it should simply put a logical high level on its signal pin.</p><p>For the SD card, we used a standard micro SD card. Usually, you will have one already in your digital camera or smartphone. You will need to format it correctly so that the Yún can use it. We recommend that you use the official SD card formatter from the SD card association, see <a class="ulink" href="https://www.sdcard.org/downloads/formatter_4/">https://www.sdcard.org/downloads/formatter_4/</a>.</p><p>Now, on the software side, you will need a bit more than just the Arduino IDE. We are going to install the required software for the camera directly on the Yún board when we connect to it via SSH, but you will need the Temboo Python SDK to upload pictures on to Dropbox. You can find the SDK at <a class="ulink" href="https://www.temboo.com/download">https://www.temboo.com/download</a>.</p><p>Then, you also need to have a Dropbox account, so you can upload pictures on to it. You can simply create an account by going to <a class="ulink" href="https://www.dropbox.com/home">https://www.dropbox.com/home</a>.</p><p>Once your account is created, you need to create an app that will be used by your project. This basically means that you have to authorize the project you are going to build in this chapter to automatically send pictures to your Dropbox account without having to enter your login and password every time. You will also be given all the required information (such as an API key) that we will enter later in the Python script on Yún.</p><p>Perform the following<a id="id85" class="indexterm"/> steps to create an app:</p><div><ol class="orderedlist arabic"><li class="listitem">To create an app, first go to <a class="ulink" href="https://www.dropbox.com/developers/apps">https://www.dropbox.com/developers/apps</a>.</li><li class="listitem">Then, click on <strong>Create app</strong> in the top-right corner of the window. You can now choose the type of app you want to create. In our case, we want to use the <strong>Dropbox API</strong> directly, as shown in the following screenshot:<div><img src="img/8007OS_03_03.jpg" alt="The required hardware and software components"/></div></li><li class="listitem">You will then be prompted to choose the kind of data your app needs to store. We want to upload pictures, so choose <strong>Files and datastores</strong>, as shown in the following screenshot:<div><img src="img/8007OS_03_04.jpg" alt="The required hardware and software components"/></div></li><li class="listitem">You can then finish the process of creating your Dropbox app.</li><li class="listitem">On the confirmation page that describes the app, you will need to write down the <strong>App key</strong> and <strong>App secret</strong>, which we will need for the rest of the project.</li><li class="listitem">Also, make sure that the <strong>Permission type</strong> field is set to <strong>App folder</strong>. This will ensure that the pictures are uploaded to the folder dedicated to the app and that the Yún won't have access to the rest of your Dropbox folder.</li><li class="listitem">What you need to get now is the Token key and Token secret relative to your Dropbox app, so you can enter them later in the software of our project.<p>To get them, the first step is to go to the InitialiseOAuth Choreo on the Temboo website at <a class="ulink" href="https://temboo.com/library/Library/Dropbox/OAuth/InitializeOAuth/">https://temboo.com/library/Library/Dropbox/OAuth/InitializeOAuth/</a>. Here, you will need to enter the App key and App secret. This will generate some additional information such as a callback ID and a temporary token secret. You'll also be asked to visit a link to Dropbox to confirm the authentication.</p></li><li class="listitem">Finally, go to the FinalizeOAuth page to finish the process. You'll be asked to enter your App key, App secret, callback ID, and temporary token secret at <a class="ulink" href="https://temboo.com/library/Library/Dropbox/OAuth/FinalizeOAuth/">https://temboo.com/library/Library/Dropbox/OAuth/FinalizeOAuth/</a>.<p>After this step, you'll be given your final Token key and Token secret. Write them down as you'll need them later.</p></li></ol></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec21"/>Making hardware connections</h1></div></div></div><p>It's now time<a id="id86" class="indexterm"/> to assemble our project. As <a id="id87" class="indexterm"/>we are going to use most of the Yún's connectivity, such as the USB port, it will be quite easy and quick to assemble the project. First, simply put the formatted micro SD card into the SD card reader of the Yún, which is located below the Yún board, as shown in the following image:</p><div><img src="img/8007OS_03_05.jpg" alt="Making hardware connections"/></div><p>Then, plug the<a id="id88" class="indexterm"/> USB camera into the Yún USB port, as shown:</p><div><img src="img/8007OS_03_06.jpg" alt="Making hardware connections"/></div><p>Finally, you need to<a id="id89" class="indexterm"/> connect the PIR motion sensor to the Yún board. It basically has three pins: VCC, GND, and SIG (signal pin). Connect VCC to the Yún's 5V pin, GND to the Yún ground, <a id="id90" class="indexterm"/>and SIG to pin number 8 of the Yún. You should end up with a setup similar to the following image:</p><div><img src="img/8007OS_03_07.jpg" alt="Making hardware connections"/></div><p>Finally, you<a id="id91" class="indexterm"/> can connect the Yún to your computer via a micro USB cable or power it with a USB adapter<a id="id92" class="indexterm"/> if you want to use the project remotely and upload the Arduino sketches via Wi-Fi.</p></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec22"/>Testing your hardware connections</h1></div></div></div><p>Now that all the<a id="id93" class="indexterm"/> connections are made, <a id="id94" class="indexterm"/>we can test the project. To get started, we will take care of the motion sensor. For this, we will write a very simple sketch that will only make use of the embedded Atmel microcontroller on the Yún board. We first need to declare the pin that the sensor is connected to, as follows:</p><div><pre class="programlisting">const int sensor_pin = 8;</pre></div><p>Then, in the <code class="literal">setup()</code> function, we will start the Serial connection, as follows:</p><div><pre class="programlisting">Serial.begin(9600);
delay(1000);</pre></div><p>We can also set some delay before data is read from the sensor, as it needs some time to initialize and work correctly. In the <code class="literal">loop()</code> function, we continuously read the value from pin number 8. Remember that the sensor will simply return a logical high state if some motion is detected and a low state otherwise. This means that we can store the sensor's reading into a Boolean variable, as shown in the following line of code:</p><div><pre class="programlisting">boolean sensor_value = digitalRead(sensor_pin);</pre></div><p>Every second,<a id="id95" class="indexterm"/> this value is then printed on the <a id="id96" class="indexterm"/>Serial monitor using the following lines of code:</p><div><pre class="programlisting">Serial.println(sensor_value);
delay(100);</pre></div><p>The complete code for this part can be found at <a class="ulink" href="https://github.com/openhomeautomation/geeky-projects-yun/tree/master/chapter3/pir_test">https://github.com/openhomeautomation/geeky-projects-yun/tree/master/chapter3/pir_test</a>.</p><p>You can now upload the preceding code on to your Yún board. Open the Serial monitor and try to pass your hand in front of the sensor; you should see the value change instantly on the Serial monitor, as shown in the following screenshot:</p><div><img src="img/8007OS_03_08.jpg" alt="Testing your hardware connections"/></div><p>If you can see the values change instantly as you pass your hand in front of the sensor, this means that the Yún is wired correctly. You will also notice that the sensor turns red when it detects motion.</p><p>Now we are going to test the USB camera. We can actually test the camera without writing any Arduino sketch. What we are going to do instead is connect directly to the Yún board via SSH. Indeed, the camera is interfaced directly to the Linux machine of the Yún via the USB port, so the Arduino sketch will later have to use the <code class="literal">Bridge</code> library in order to access the camera.</p><p>For now, just go to a terminal window (the typical terminal that comes installed with OS X or Linux, or install one such as HyperTerminal if you are under Windows), and type the following command:</p><div><pre class="programlisting">
<strong>ssh root@yourYunName.local</strong>
</pre></div><p>Of course, you will have to put the name you gave to your own Yún in place of <code class="literal">yourYunName</code>. For example, the name of my Yún is <code class="literal">myarduinoyun</code>; therefore, I need to type <code class="literal">myarduinoyun.local</code>. This will establish a direct connection with the Linux machine of the Yún.</p><p>You will<a id="id97" class="indexterm"/> then be <a id="id98" class="indexterm"/>prompted to enter the password that you chose for your Yún. If it works, you should see the following screenshot being displayed on your terminal, which indicates that you are now working directly on the Yún:</p><div><img src="img/8007OS_03_09.jpg" alt="Testing your hardware connections"/></div><p>You can access all the functions from your Yún Linux machine. We are now going to install the required software for the camera. This requires the Arduino Yún to be connected to the Internet so that it can get the required packages, as described in the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">The process starts by updating the package manager, <code class="literal">opkg</code>, as follows:<div><pre class="programlisting">
<strong>opkg update</strong>
</pre></div></li><li class="listitem">Install the UVC drivers, as follows:<div><pre class="programlisting">
<strong>opkg install kmod-video-uvc</strong>
</pre></div></li><li class="listitem">Install the <code class="literal">python-openssl</code> package that we will use later in the project, as shown in the following command:<div><pre class="programlisting">
<strong>opkg install python-openssl</strong>
</pre></div></li><li class="listitem">Finally, you can install the <code class="literal">fswebcam</code> software that we will use to take pictures, as shown in the following command:<div><pre class="programlisting">
<strong>opkg install fswebcam</strong>
</pre></div></li><li class="listitem">Once this part is done and the software is installed on the Yún, we can test the camera and take a picture. To also test whether the SD card is working at the same time, go over to the SD card folder, which is usually called <code class="literal">sda1</code>, using the following command:<div><pre class="programlisting">
<strong>cd /mnt/sda1</strong>
</pre></div></li><li class="listitem">You can now take a picture by typing the following command:<div><pre class="programlisting">
<strong>fswebcam test.png</strong>
</pre></div></li><li class="listitem">You should see some message being printed that starts with the following:<div><pre class="programlisting">
<strong>--- Opening /dev/video0...</strong>
<strong>Trying source module v4l2...</strong>
<strong>/dev/video0 opened. </strong>
</pre></div></li></ol></div><p>Some errors <a id="id99" class="indexterm"/>might be printed as well, but this doesn't matter for the process of taking a picture.</p><p>To check <a id="id100" class="indexterm"/>whether this works correctly, you can first check whether there is a file named <code class="literal">test.png</code> located on the SD card. To do this, you can simply type the following command:</p><div><pre class="programlisting">
<strong>ls</strong>
</pre></div><p>The preceding command will print the list of all the files in the current folder; in the present case, the SD card. You should see at least a file named <code class="literal">test.png</code>.</p><p>Now, to check that the picture is fine and not corrupted, you can, for example, remove the SD card from the Yún (by unmounting it first using the <code class="literal">unmount/dev/sda1</code> command), and plug it directly to your computer using a micro SD card to normal SD card adapter. You should see the following screenshot in your browser (we already added the files that are required for the next sections of the project at this point, which explains the other files located on the SD card):</p><div><img src="img/8007OS_03_10.jpg" alt="Testing your hardware connections"/></div><p>If you see a picture on your SD card at this point, open it to check that it was correctly taken. If that's the case, congratulations! Everything is now set up for you to write exciting applications with this project. If you can't see a picture at this point, the first step is to repeat the whole process again. Be careful to actually unmount the SD card after the picture is taken. You can also plug the camera directly to your computer to check whether the problem comes from the camera itself.</p></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec23"/>Recording pictures when motion is detected</h1></div></div></div><p>The first application <a id="id101" class="indexterm"/>we are going to build with the hardware that we just step up will be only local, so nothing will be sent to the Web yet. In this section, we just want to build a camera that will be triggered by the motion sensor.</p><p>With this, you can, for example, check whether somebody entered your home while you were not there because the PIR motion sensor would instantly notice it. This section is really the foundation of the whole project. We are going to reuse the code developed in this section later when we write the piece of code to upload pictures to Dropbox.</p><p>For this part of the project, we don't want to use the SSH access to take pictures anymore; we need to trigger the camera right from the Arduino sketch. For this, we are going to use the <code class="literal">Bridge</code> library and the <code class="literal">Process</code> library to call a command on the Linux machine, just as if you were typing it on a terminal window.</p><p>The sketch starts by declaring the libraries that we need to use:</p><div><pre class="programlisting">#include &lt;Bridge.h&gt;
#include &lt;Process.h&gt;</pre></div><p>To call some commands on the Yún's Linux machine, we will need to declare a process, which is an object that we will call to emulate some terminal entries:</p><div><pre class="programlisting">Process picture;</pre></div><p>We'll also build a filename for each picture that will be taken, as shown in the following line of code. Indeed, we named the file <code class="literal">test.png</code> earlier, but in this application, we want every picture taken by the project to have a different name:</p><div><pre class="programlisting">String filename;</pre></div><p>Declare the pin on which the motion sensor is connected, as follows:</p><div><pre class="programlisting">int pir_pin = 8;</pre></div><p>We also need to define where the pictures will be stored. Remember, we want to store them all on the SD card, as follows:</p><div><pre class="programlisting">String path = "/mnt/sda1/";</pre></div><p>You can also store pictures locally on the Yún, but it would quickly saturate the memory of the Arduino Yún.</p><p>Then, in the <code class="literal">setup()</code> function, we start the bridge between the Atmel microcontroller and the Linux machine of the Yún, as follows:</p><div><pre class="programlisting">Bridge.begin();</pre></div><p>Also, we set the pin of the PIR motion sensor as an input, as follows:</p><div><pre class="programlisting">pinMode(pir_pin,INPUT);</pre></div><p>In the <code class="literal">loop()</code> function, what we want to do is to continuously read data from the motion sensor and trigger the camera if any motion is detected.</p><p>This is done by a simple <code class="literal">if</code> statement that checks the sensor's value, as follows:</p><div><pre class="programlisting">if (digitalRead(pir_pin) == true)</pre></div><p>Then, if some <a id="id102" class="indexterm"/>motion is detected, we need to prepare everything to take the picture. The first step is to build a filename that will contain the date on which the picture was taken. To do so, we are using the Linux date command that outputs the current date and time. This is important because we want to know what time the picture was taken at and give a unique filename to every picture. At the end, we also want to specify that this picture will be taken in a <code class="literal">PNG</code> format. The filename formatting part is done by the following code:</p><div><pre class="programlisting">filename = "";
picture.runShellCommand("date +%s");
while(picture.running());

while (picture.available()&gt;0) {
  char c = picture.read();
  filename += c;
  } 
filename.trim();
filename += ".png";</pre></div><p>Finally, we can take the picture. What we are going to do here is to call the <code class="literal">fswebcam</code> command again using the <code class="literal">runShellCommand</code> function of our picture process that will emulate a terminal entry.</p><p>We also want to use the maximum resolution available on the camera. In the case of the camera we chose, it was 1280 x 720 (standard HD resolution). We have quite a lot of space available on the SD card (4 GB with the one I used), so you can use the maximum resolution without running into problems. We recommend that you use a dedicated SD card for this project so that you don't run into problems with other files that could be stored on the card. For the sake of simplicity, we won't add an automated check to see whether the card is full, but this is something you should consider if you want to let the project run continuously over time. You can specify the resolution using the <code class="literal">–o</code> command at the end of the call. Finally, we can build the complete code to take a picture:</p><div><pre class="programlisting">picture.runShellCommand("fswebcam " + path + filename + " -r 1280x720");
while(picture.running());</pre></div><p>Note that we are also using a <code class="literal">while()</code> statement here to make sure that the <code class="literal">fswebcam</code> utility has enough time to take the picture. The complete code can be found at <a class="ulink" href="https://github.com/openhomeautomation/geeky-projects-yun/tree/master/chapter3/triggered_camera">https://github.com/openhomeautomation/geeky-projects-yun/tree/master/chapter3/triggered_camera</a>.</p><p>You can now upload the code to the Yún board and test the project. Once it's uploaded, try moving your hand in front of the sensor. The Arduino Yún should trigger the camera to take a picture <a id="id103" class="indexterm"/>and save it to the SD card. To make sure that a picture was taken at this point, you can simply check on the camera itself. For example, the Logitech webcam that I used has a small LED that turns green whenever it is active.</p><p>After a while, remove the SD card from the Arduino Yún (as earlier, unmount the SD card from the Yún first), and put it in your computer with the adapter we used earlier. You should see all the pictures that were taken at the root of the SD card, as shown in the following screenshot:</p><div><img src="img/8007OS_03_11.jpg" alt="Recording pictures when motion is detected"/></div><p>Again, check these pictures to make sure that they are not corrupted and that everything worked as planned.</p></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec24"/>Sending pictures to Dropbox at regular intervals</h1></div></div></div><p>We are now going<a id="id104" class="indexterm"/> to extend the code we built in the previous section and write some new code that automatically uploads the pictures that were taken by the camera to Dropbox. For this, we will need to build a slightly more complex software than in the previous part.</p><p>For now, we only used the Choreos (Temboo libraries) for the Arduino Yún. However, there are actually many other Choreos available for other languages, such as for Python. This is great news because the Linux machine of the Yún is capable of running Python code out of the box.</p><p>It's actually much easier to access the Dropbox API from Python, so that's what we are going to use in this part. We will build a Python script that uploads the pictures we took to Dropbox, and call this script from the Arduino sketch using the <code class="literal">Bridge</code> library and our picture processes.</p><p>I will now explain the content of the Python script. Later, we will save all these lines of code in a separate file, and put it on the SD card along with the Temboo Python SDK.</p><p>The Python script starts with the following lines of code:</p><div><pre class="programlisting">from temboo.core.session import TembooSession
from temboo.Library.Dropbox.FilesAndMetadata import UploadFile</pre></div><p>The Python script will also take an argument: the name of the file to be uploaded. This way, we can <a id="id105" class="indexterm"/>directly pass the name of file (built by the Arduino code with a timestamp) to the Python script. The following lines of code do exactly this:</p><div><pre class="programlisting">with open(str(sys.argv[1]), "rb") as image_file:
  encoded_string = base64.b64encode(image_file.read())</pre></div><p>Inside the script, you need to define your Temboo credentials, as follows:</p><div><pre class="programlisting">session = TembooSession('yourTembooName', 'yourTembooApp', 'yourTembooKey')</pre></div><p>These are exactly the same credentials we used for Temboo earlier. We then need to declare the upload file Choreo for Python that will be used to automatically upload pictures to Dropbox, as follows:</p><div><pre class="programlisting">uploadFileChoreo = UploadFile(session)
uploadFileInputs = uploadFileChoreo.new_input_set()</pre></div><p>The next step is to set the different inputs, which you had done when you created your Dropbox app, as follows:</p><div><pre class="programlisting">uploadFileInputs.set_AppSecret("appSecret")
uploadFileInputs.set_AccessToken("accessToken")
uploadFileInputs.set_FileName(str(sys.argv[1]))
uploadFileInputs.set_AccessTokenSecret("accessTokenSecret")
uploadFileInputs.set_AppKey("appKey")
uploadFileInputs.set_FileContents(encoded_string)
uploadFileInputs.set_Root("sandbox")</pre></div><p>Finally, we can order <code class="literal">uploadFileChoreo</code> to upload the file to your Dropbox folder in the corresponding folder of your app, as follows:</p><div><pre class="programlisting">uploadFileResults = uploadFileChoreo.execute_with_results(uploadFileInputs)</pre></div><p>You can now save this code in a file named <code class="literal">upload_picture.py</code> and put it at the root of the SD card. Remember the Temboo Python library we downloaded earlier? It's time to unpack it and place it at the root of the SD card as well. Just make sure that it appears with the name <code class="literal">temboo</code> in the root of the SD card, so the Python file we just created can access it correctly. If no pictures have been recorded yet, the following screenshot shows what your SD card folder should look like:</p><div><img src="img/8007OS_03_12.jpg" alt="Sending pictures to Dropbox at regular intervals"/></div><p>We also need to slightly modify the Arduino sketch to upload pictures on Dropbox. We used exactly the same code base as in the previous section, so we will only detail the new code that was added.</p><p>In the part that is<a id="id106" class="indexterm"/> executed when motion is detected, right at the end of the loop, you need to use the picture process again to execute the Python script, as shown in the following code:</p><div><pre class="programlisting">picture.runShellCommand("python " + path + "upload_picture.py " + path + filename);
while(picture.running());</pre></div><p>Note that we are passing along the same filename and path as the pictures that are recorded on the SD card, so the exact same picture name is recorded locally and sent to Dropbox.</p><p>The complete code for this part can be found at <a class="ulink" href="https://github.com/openhomeautomation/geeky-projects-yun/tree/master/chapter3/dropbox_log">https://github.com/openhomeautomation/geeky-projects-yun/tree/master/chapter3/dropbox_log</a>.</p><p>You can now put the SD card back into the Arduino Yún, upload the updated Arduino sketch, and head to your Dropbox folder. At this point, you should note that a new folder was created in your <code class="literal">Apps</code> folder with the name of your Dropbox app that you set on the Dropbox website, as shown in the following screenshot:</p><div><img src="img/8007OS_03_13.jpg" alt="Sending pictures to Dropbox at regular intervals"/></div><p>Now, if motion is detected, the sketch should not only log the pictures on the SD card, but also on your Dropbox folder. If everything is working correctly, you can see that pictures arrive in real time inside your Dropbox folder as the Yún takes the pictures using the USB camera.</p><p>The cool aspect about these applications of our project is that this can be done from anywhere in the world. You can do this from your computer, of course, but also from a web browser. Many mobile devices can also run the mobile version of Dropbox, so you can see if somebody has entered your home right from your mobile device. On my computer, for example, Dropbox also sends me a notification that a new file was uploaded, so I can instantly see whether something is happening in my house and can act accordingly.</p></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec25"/>Live video streaming via Wi-Fi</h1></div></div></div><p>To finish this<a id="id107" class="indexterm"/> chapter, we are going to see another cool application that we can make with the Arduino Yún and our USB camera. <a id="id108" class="indexterm"/>Remember that the camera is actually a standard webcam, and that it is also made to capture videos. Wouldn't it be cool to automatically stream video on a private video channel on the Web, so you can watch over your home in real time from anywhere just by going into a web browser? That's exactly what we are going to do in this section.</p><p>Many commercial IP cameras are actually doing this with proprietary solutions, but I wanted to use commonly available tools; this is why we chose the YouTube live event service to stream the video that can then be accessed from any device.</p><p>To make the application work, we first need to install some additional software packages on the Yún, as shown in the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Connect to the Yún again using SSH with your Arduino Yún name and password, and type the following command to get the correct package for live streaming:<div><pre class="programlisting">
<strong>wget http://www.custommobileapps.com.au/downloads/mjpg-streamer.ipk</strong>
</pre></div></li><li class="listitem">Note that if the link is not valid anymore and you can't find the files, this package is also available inside the code of this chapter. You can now install it with the following command:<div><pre class="programlisting">
<strong>opkg install mjpg-streamer.ipk</strong>
</pre></div></li><li class="listitem">You can now start the live streaming software on your Arduino Yún using the following command:<div><pre class="programlisting">
<strong>mjpg_streamer -i "input_uvc.so -d /dev/video0 -r 640x480 -f 25" -o "output_http.so -p 8080 -w /www/webcam" &amp;</strong>
</pre></div><p>Here, the parameter after <code class="literal">–h</code> is the resolution and the one after <code class="literal">–i</code> is the port on which the stream will be available. We also specified the number of frames per second using the <code class="literal">–I</code> command. The other options are less important and you do not have to worry about them.</p></li></ol></div><p>Note that we didn't stream at HD resolution; it was apparently too much for the Arduino Yún, and the video stream suffered significant lag and also had corrupted images, which is not what we want at all. You can then access your stream by going to your Arduino Yún's address in your web browser followed by <code class="literal">8080</code> to specify the correct port. For example, in my case, it was <code class="literal">http://myarduinoyun.local:8080/stream.html</code>.</p><p>This actually gives you direct access to the live stream. You should then see the stream interface with the live stream in the middle of the page, as shown in the following screenshot:</p><div><img src="img/8007OS_03_14.jpg" alt="Live video streaming via Wi-Fi"/></div><p>You can also use the different elements of the menu on the left to explore other possibilities of this <a id="id109" class="indexterm"/>streaming software. For example, you can get a link for <strong>VideoLAN</strong>, so you can access your stream right from the VLC player.</p><p>Now, this is<a id="id110" class="indexterm"/> already great and you could stop here to access your video stream from your local Wi-Fi network. But it would be even better if the stream was available online, so you could access it from anywhere in the world even without being connected to your local Wi-Fi network.</p><p>The first step is to go to your YouTube account in <strong>VIDEO MANAGER</strong> and to the <strong>Live Events</strong> menu on the left, as shown in the following screenshot:</p><div><img src="img/8007OS_03_15.jpg" alt="Live video streaming via Wi-Fi"/></div><p>From this menu, you can create your stream just like you would create a new YouTube video. Make sure that you put the video as unlisted unless you want other people on YouTube to be able to<a id="id111" class="indexterm"/> see what's going on in your home. Compared to a private video, you will still be able to share the video with the people you know just by giving them the URL of the stream. Then, on the next page, YouTube will ask you to choose which encoder you want to use.</p><p>I chose <strong>Wirecast</strong> <a id="id112" class="indexterm"/>from the list and downloaded it from their website. In the Wirecast interface, you need to set the correct video source (by default, it will stream from your computer's webcam). In the menu where you can select the video source, select <strong>Web Stream Source</strong> and configure it, as shown in the following screenshot:</p><div><img src="img/8007OS_03_16.jpg" alt="Live video streaming via Wi-Fi"/></div><p>Basically, you need to choose HTTP as the protocol, use <strong>Motion JPEG</strong> as the format, and put the URL from the VideoLAN tab of the streaming interface. For example, for my project, it was <code class="literal">myarduinoyun.local:8080/?action=stream</code>.</p><p>After a moment, if everything is working fine, you should see the live stream from your USB camera appear directly in the main window of Wirecast. Don't worry if there is some lag at this point; it is only a delay usually; in my case, I had about 1-2 seconds of delay in the Wirecast software. The following is the image I got in the main Wirecast interface after adding the right video stream:</p><div><img src="img/8007OS_03_17.jpg" alt="Live video streaming via Wi-Fi"/></div><p>Also, make sure that this stream is the only one that will be sent to YouTube. For this purpose, delete all the other streams from the Wirecast interface. Indeed, by default, Wirecast puts the stream that comes from your webcam on the interface.</p><div><div><h3 class="title"><a id="note03"/>Note</h3><p>Also note that using an HTTP stream is a feature from the paid version of Wirecast; it works perfectly in the free version, but you will get a watermark displayed on the video from time to time. Don't worry; it's actually not a problem to monitor what is going on in your house.</p></div></div><p>The<a id="id113" class="indexterm"/> next step<a id="id114" class="indexterm"/> is to actually stream data to YouTube. Click on the <strong>Stream</strong> button at the top of the interface, which should turn red, after which you will be prompted to enter your YouTube credentials. It should then automatically detect your live event video that you just created on YouTube.</p><p>Accept the settings, make sure it is streaming from Wirecast, and go back to the YouTube interface. You can now go to the video manager, and go to the <strong>Live Control Room</strong> tab. This is where you should see that YouTube is actually receiving some data from your Arduino Yún via Wirecast running on your computer. It should indicate that the <strong>Stream Status</strong> is <strong>GOOD</strong>, as shown in the following screenshot:</p><div><img src="img/8007OS_03_18.jpg" alt="Live video streaming via Wi-Fi"/></div><p>If this is not the case, please go back to the Wirecast application to check that the streaming process is <a id="id115" class="indexterm"/>working<a id="id116" class="indexterm"/> correctly. At this moment, don't worry; your stream is not working just yet. You should see that the <strong>Preview</strong> button, as shown in the following screenshot, is now available and can be clicked. Just click on it.</p><div><img src="img/8007OS_03_19.jpg" alt="Live video streaming via Wi-Fi"/></div><p>YouTube will then prepare your stream, as shown in the following screenshot, and you will have to wait for a moment (around 30 seconds when I tried it):</p><div><img src="img/8007OS_03_20.jpg" alt="Live video streaming via Wi-Fi"/></div><p>After a while, the page will be updated automatically so that you can move to the next step and actually start the streaming, as shown in the following screenshot:</p><div><img src="img/8007OS_03_21.jpg" alt="Live video streaming via Wi-Fi"/></div><p>Note that before making the stream live, you can preview it using the options on the preceding page. If what you see is satisfactory, you can now click on <strong>Start Streaming</strong> to finally finish the process. <a id="id117" class="indexterm"/>You will then have access to the stream on this page or directly on the dedicated page of the stream. The following screenshot is the final result on the YouTube interface:</p><div><img src="img/8007OS_03_22.jpg" alt="Live video streaming via Wi-Fi"/></div><p>You can see from the red dot below the video that the video is streaming live. Because the video is marked as <strong>Unlisted</strong>, only people with the URL can access it. You can, for example, mark the <a id="id118" class="indexterm"/>video as a favorite in your YouTube account and then access it from anywhere. You can also share it with your family and friends, so they can also watch the stream from their browsers.</p><p>Note that because we <a id="id119" class="indexterm"/>are using the Wirecast software on our computer to encode the stream for YouTube, we need to have our computer on for this to work. At the time this book was written, no software was available to directly stream the video to YouTube without the help of a computer, but this might change in the future, removing the need for a computer to stream the video.</p></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec26"/>Summary</h1></div></div></div><p>Let's now summarize what we learned in this project. What we've built in this project is a security camera that can automatically log pictures locally and to Dropbox whenever motion is detected. We also learned how to stream the video that comes from this camera live on YouTube via Wi-Fi.</p><p>The following were the major takeaways from this project:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In the first part of the project, we connected the USB camera to the Arduino Yún as well as the PIR motion sensor. We also plugged a micro SD card to the Yún so we can also record pictures locally, even if the Internet connection is not available. We also installed the required software packages for the project, such as the driver, to access the USB camera from a terminal command.</li><li class="listitem" style="list-style-type: disc">Then, we tested our hardware by checking whether the motion sensor was working properly and by making sure that we can actually take pictures using the USB camera.</li><li class="listitem" style="list-style-type: disc">Then, we built a simple application using our hardware to automatically take a picture when motion is detected and store it on the micro SD card. We tested this software on the Yún, and when we checked later, we found that some pictures were indeed stored on the SD card.</li><li class="listitem" style="list-style-type: disc">After this simple application, we built on the sketch to automatically upload the pictures on our Dropbox folder as well. For this, we wrote a Python script that can automatically upload files to Dropbox. This script was then called from the Arduino sketch to upload pictures over to Dropbox whenever motion is detected.</li><li class="listitem" style="list-style-type: disc">Finally, in the last part of the sketch, we used the video capabilities of the camera to stream video live on YouTube. This way, we can monitor what's going on in your home from wherever you are in the world; we just need an Internet connection and a device that can access YouTube, such as a smartphone.</li></ul></div><p>Of course, there are many ways you can improve and extend this project based on what we learned in this chapter. You can, of course, have many of these modules with a camera and a motion sensor within your home. This way, you can have a complete security system that monitors your home remotely.</p><p>One way to improve the project is to integrate more Choreos into the project. For example, you can inject the Gmail Choreo we used in the first chapter to automatically send an e-mail alert as well whenever some motion is detected. This will create another layer of security in your home. In a similar way, you can also use the Twilio Choreo that will send you an SMS when motion is detected in your home.</p><p>You can also use the project for completely different purposes. While testing the project, we, for example, created a time-lapse device that takes pictures at regular time intervals (for example, every minute) and uploads these pictures on Dropbox.</p><p>In the next chapter, we are going to use the Arduino Yún's Wi-Fi capabilities for a completely different application: to control a mobile robot. We are going to use the power of the Arduino Yún to remotely control this robot and read out data that comes from the robot, all within a simple web application running on your computer.</p></div></body></html>