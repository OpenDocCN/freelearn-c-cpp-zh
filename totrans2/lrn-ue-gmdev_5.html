<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Animation and AI"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Animation and AI</h1></div></div></div><p>This chapter is about animation and <a id="id389" class="indexterm"/>
<span class="strong"><strong>artificial intelligence</strong></span> (<span class="strong"><strong>AI</strong></span>).</p><p>Animation is what we need in order to see things move in a game. AI is what is required for characters (other than the player) to know how to behave and react while you are in the game.</p><p>We will cover the following topics in this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Definition of animation</li><li class="listitem" style="list-style-type: disc">3D animation</li><li class="listitem" style="list-style-type: disc">Tools required for animation in Unreal Engine 4</li><li class="listitem" style="list-style-type: disc">Learning to add animation to your game</li><li class="listitem" style="list-style-type: disc">Using an Animation Blueprint</li><li class="listitem" style="list-style-type: disc">Learning about Blend Animation</li><li class="listitem" style="list-style-type: disc">AI in games</li><li class="listitem" style="list-style-type: disc">Designing a<a id="id390" class="indexterm"/> <span class="strong"><strong>Behavior Tree</strong></span> (<span class="strong"><strong>BT</strong></span>)</li><li class="listitem" style="list-style-type: disc">Using a Blueprint to implement AI in your game</li></ul></div><div class="section" title="What is animation?"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec58"/>What is animation?</h1></div></div></div><p>Animation<a id="id391" class="indexterm"/> is the simulation of movement through a series of images or frames.</p><p>Before computers came into the picture, animation was created using traditional techniques such as hand-drawn animation and stop-motion animation (or model animation). Hand-drawn animation, as the name suggests, involves hand-drawn scenes on paper. Each scene is repeated on the next sheet of paper with a slight change in the scene. All the papers are put together in sequence and the pages are turned very quickly, like a flipbook. The slight changes on the sheets of paper create 2D animation, and this can be filmed into a motion film. This technique is used very often in Disney cartoons and movies. As you can imagine, this is a very time-consuming way to produce animation, as you would need thousands of drawings to create seconds of the film.</p><p>Stop-motion animation<a id="id392" class="indexterm"/> involves creating models, moving them a little in each<a id="id393" class="indexterm"/> frame to mimic movement, and filming this sequence to construct an entire scene. The tedious process of capturing countless snippets has limited the use of this method in favor of more mainstream animation techniques today.</p><p>Computer animation<a id="id394" class="indexterm"/> is quite similar to stop-motion animation <a id="id395" class="indexterm"/>as computer graphics is moved a little in each frame; these frames are then rendered on screen. For computer games, we use computer animation by creating 3D models using tools, such as Maya and 3ds Max. Then, we animate these models to simulate life-like behavior and actions for the game. Animation is needed for all things in order to make them move. Characters need to be animated so that they can look real—they can be in an idle position, walk, run, or execute any other action that needs to be performed in the course of the game.</p><p>Motion capture<a id="id396" class="indexterm"/> is also another very popular way to animate characters these days. This technology basically uses recorded human actions to create the computer graphic character's behavior. If you have watched the movie <span class="emphasis"><em>Avatar</em></span>, the blue avatar characters were, in fact, played by human actors and then enhanced to look the way they did using computer graphics. For the filming of the movie, they advanced the motion capture technology into what is now called<a id="id397" class="indexterm"/> <span class="strong"><strong>performance capture</strong></span>. This advancement in technology has empowered film and game makers to capture the details in animation in such a way that can make a CG character stand out.</p></div></div>
<div class="section" title="Understanding how to animate a 3D model"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec59"/>Understanding how to animate a 3D model</h1></div></div></div><p>Although the<a id="id398" class="indexterm"/> objective of this book is not to teach you how to animate a model, it is important to understand how animation is done so that you can understand better how to get game characters in a game to move and behave according to design.</p><p>As mentioned earlier, we can animate 3D models using tools, such as Maya or 3ds Max. We can then record their changes and then render these animations on screen when needed.</p><div class="section" title="Preparing before animation"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec69"/>Preparing before animation</h2></div></div></div><p>In game <a id="id399" class="indexterm"/>development, the creation of animation<a id="id400" class="indexterm"/> falls under the responsibility of an animator. Before an animation can be first created, we need to first have a 3D model that's been created by a 3D modeler. The 3D modeler is responsible for giving the object its shape and texturing it. Depending on the type of object we're dealing with, the exact process to get an object properly rigged can be slightly different. Rigging needs to be done before handing over the object to the animator to create specific animations. Sometimes, animators also need to fine-tune the rigs for better control of the animation.</p><p>Rigging<a id="id401" class="indexterm"/> is a process where a skeleton is placed in the mesh and joints that are created for the skeleton. The collection of bones/joints is known as the <a id="id402" class="indexterm"/>
<span class="strong"><strong>rig</strong></span>. The rig provides control points, which the animator can use to move the object in order to create the desired animation. I will use a human character model in my explanation here so that you can understand this concept easily.</p><p>The 3D or character modeler first shows how the face and body of a model are shaped. It then determines how tall the model is, creates all the required features by adding primitives to the model, and then textures it to give color to its eyes, hair, and so on. The model is now ready but still jelly on the inside because we have not given it any internal structure. Rigging is the process where we add bones to the body to hold it up. The arm can be rotated because we have given it a shoulder bone (scapula), arm bone (humerus), and a joint that can mimic the ball and socket joint. The joint we have in place for rigging is made up of a group of constraints that limit movement in various planes and angles. Hierarchies are also applied to the bone structure to help the bones link each other. The fingers are linked to the hand, which is linked to the arm. Such a relationship can be put in place so that movement looks real when one of parts moves and the rest of the parts naturally move together as well.</p><p>Tools, such as Maya and 3ds Max, provide some simplification to the rigging process, as you can use standard rigs as the base, and tweak this base according to the needs of the model. Some models are taller and require longer bones. A 3D model must have a simple skeletal structure that adheres closely to the shape and size of a 3D model. Similar sized 3D models<a id="id403" class="indexterm"/> can share the same skeletal structure.</p><p>To better <a id="id404" class="indexterm"/>understand how we can add animation to our game levels, let's learn how computer animation is created and how we can make these models move.</p></div><div class="section" title="How is animation created?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec70"/>How is animation created?</h2></div></div></div><p>Animation <a id="id405" class="indexterm"/>basically mimics how life moves in the real world. Many companies go to great lengths to make computer animation as accurate as possible through the use of motion capture. They film actual movements in real life and then recreate these movements using computer 3D models.</p><p>When creating animations, the animator makes use of the bones and joints created during the rigging process and adjusts them in place using as much detail as possible to mimic their natural movement. The joints and bones work together to affect the body posture. These movements are then recorded as short animation clips known as an animation sequence. Animation sequences form the most basic blocks of animation, and they can be played once or repeatedly to create an action. For example, a walking animation is only 1.8 seconds long but can be replayed over and over to simulate walking. When this sequence is repeated again, it is commonly known as an animation loop.</p><p>Animation sequences can also be linked to form a chain of actions. While transitioning from one sequence to another, some blending might be needed in order for the movement to look natural.</p></div></div>
<div class="section" title="What Unreal Engine 4 offers for animation in games"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec60"/>What Unreal Engine 4 offers for animation in games</h1></div></div></div><p>Animation in Unreal Engine 4 <a id="id406" class="indexterm"/>is mostly done in the Persona editor. This editor offers four different modes: <span class="strong"><strong>Skeleton</strong></span>, <span class="strong"><strong>Mesh</strong></span>, <span class="strong"><strong>Animation</strong></span>, and <span class="strong"><strong>Graph</strong></span>. These modes mainly exist so that you can jump straight into one of them to edit/create the animations more effectively. So, they are simply a loose group of functions that can be used to control the different aspects of animation. We will learn how to make use of the functions in Persona to add animation to our level.</p><p>To help improve team collaboration, Unreal Engine 4 also released a previously in-house-only toolset, which is a plugin for Maya (compatible for Maya 2013 and higher versions), known as <a id="id407" class="indexterm"/>
<span class="strong"><strong>Animation and Rigging Toolset</strong></span> (<span class="strong"><strong>ART</strong></span>). This toolset provides a user interface to allow the creation of a skeleton, placement of the skeleton, and rig creation within Maya itself. We will not go into the details of this toolset, but you can find more information on this in Unreal's online documentation at <a class="ulink" href="https://docs.unrealengine.com/latest/INT/Engine/Content/Tools/MayaRiggingTool/index.html">https://docs.unrealengine.com/latest/INT/Engine/Content/Tools/MayaRiggingTool/index.html</a>.</p><div class="section" title="Importing animation from Maya/3ds Max"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec71"/>Importing animation from Maya/3ds Max</h2></div></div></div><p>As many artists use<a id="id408" class="indexterm"/> Maya and 3ds Max to create 3D models and <a id="id409" class="indexterm"/>animation, Unreal Engine 4 has a great FBX <a id="id410" class="indexterm"/>Import pipeline that allows you to successfully<a id="id411" class="indexterm"/> import skeletal models, animation sequences, and morph targets. This makes it easy to transfer assets to the Unreal Editor and put them into the game. Unreal also tries to stabilize the import of art assets from other software, such as Blender and MODO.</p><div class="section" title="Tutorial – importing the animation pack from Marketplace"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec36"/>Tutorial – importing the animation pack from Marketplace</h3></div></div></div><p>Since 3D models and <a id="id412" class="indexterm"/>animation are first created outside <a id="id413" class="indexterm"/>Unreal Engine, for the purpose of learning about how animation works, we will import an animation pack that contains a 3D model with a number of animation sequences first, and we'll then learn how to make use of the different tools in the Unreal Editor for animation.</p><p>Unreal Engine offers a number of downloadable packs in Marketplace. Marketplace is in the start menu screen, which is under the <span class="strong"><strong>Launch</strong></span> button. The following screenshot shows the startup screen that has the <span class="strong"><strong>Marketplace</strong></span> tab selected for the downloadable packs. Search for <span class="strong"><strong>Animation Starter Pack</strong></span> in Marketplace under <span class="strong"><strong>Characters and Animations</strong></span>. This particular pack is free to download. Click on <span class="strong"><strong>Animation Started Pack</strong></span> to download it.</p><div class="mediaobject"><img src="graphics/B03679_05_01.jpg" alt="Tutorial – importing the animation pack from Marketplace"/></div><p>After the pack is <a id="id414" class="indexterm"/>downloaded, you will find the pack<a id="id415" class="indexterm"/> added to the <span class="strong"><strong>Library</strong></span>. The following screenshot shows where <span class="strong"><strong>Animator Starter Pack</strong></span> is found in <span class="strong"><strong>Library</strong></span> under <span class="strong"><strong>Vault</strong></span>:</p><div class="mediaobject"><img src="graphics/B03679_05_02.jpg" alt="Tutorial – importing the animation pack from Marketplace"/></div><p>Now that we have the<a id="id416" class="indexterm"/> <span class="strong"><strong>Animation Starter Pack</strong></span> in our <a id="id417" class="indexterm"/>
<span class="strong"><strong>Library</strong></span>, we can add it to our current project and start playing with the animations.</p><p>Click on <span class="strong"><strong>Add To Project</strong></span> and a pop-up screen with all the current projects that are present in Unreal Engine will appear. Select the name of the project that you have been creating for all the various levels and all the tutorial examples. If you have followed the same project and level naming convention as me, it will be <code class="literal">MyProject</code>. I have also opened <code class="literal">Chapter4Level</code> from the previous chapter and renamed it <code class="literal">Chapter5Level</code>. The following screenshot shows <code class="literal">AnimStarterPack</code> loaded in the project:</p><div class="mediaobject"><img src="graphics/B03679_05_03.jpg" alt="Tutorial – importing the animation pack from Marketplace"/></div></div></div><div class="section" title="What can you do with Persona?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec72"/>What can you do with Persona?</h2></div></div></div><p>Persona gives game<a id="id418" class="indexterm"/> developers the ability to playback and preview animation sequences, combine animation sequences into a single animation by blending, creating montages, editing skeletons/sockets, and controlling animation with Blueprints. I hope you still remember what you have learned about Blueprints in <a class="link" href="ch03.html" title="Chapter 3. Game Objects – More and Move">Chapter 3</a>, <span class="emphasis"><em>Game Object – More and Move</em></span>.</p><div class="section" title="Tutorial – assigning existing animation to a Pawn"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec37"/>Tutorial – assigning existing animation to a Pawn</h3></div></div></div><p>After adding the <a id="id419" class="indexterm"/>free animation pack into your project in<a id="id420" class="indexterm"/> the previous exercise, it is time to add some animation to the level. First of all, open <code class="literal">Chapter4Level</code>, rename it <code class="literal">Chapter5Level</code>, and then navigate to the <code class="literal">AnimStarterPack</code> folder using <span class="strong"><strong>Content Browser</strong></span>. Go to the <code class="literal">Character</code> subfolder and click and drag <span class="strong"><strong>HeroTPP</strong></span> into the level.</p><p>This screenshot shows how <span class="strong"><strong>HeroTPP</strong></span> is added to the level:</p><div class="mediaobject"><img src="graphics/B03679_05_04.jpg" alt="Tutorial – assigning existing animation to a Pawn"/></div><p>The <span class="strong"><strong>HeroTPP</strong></span> looks<a id="id421" class="indexterm"/> fake and frozen, right? Now, let's give<a id="id422" class="indexterm"/> him a better pose. Click on <span class="strong"><strong>HeroTPP</strong></span> to display the details. Go to the <span class="strong"><strong>Animation</strong></span> tab under <span class="strong"><strong>Details</strong></span> and input the <span class="strong"><strong>Animation Mode</strong></span> settings. Use <span class="strong"><strong>Animation Asset</strong></span>, navigate and click on <span class="strong"><strong>Jog_Fwd_Rifle</strong></span> in <code class="literal">AnimStarterPack</code> (in <span class="strong"><strong>Content Browser</strong></span>), and then click on the arrow next to <span class="strong"><strong>Anim to Play</strong></span>.</p><div class="mediaobject"><img src="graphics/B03679_05_05.jpg" alt="Tutorial – assigning existing animation to a Pawn"/></div><p>Here is a zoomed-in <a id="id423" class="indexterm"/>view<a id="id424" class="indexterm"/> of the <span class="strong"><strong>Animation</strong></span> settings:</p><div class="mediaobject"><img src="graphics/B03679_05_06.jpg" alt="Tutorial – assigning existing animation to a Pawn"/></div><p>Now, build and play the level. You will see the character that you have just added to the level, is jogging.</p><p>This is the straightforward way to animate a character. However, the character continues to loop through this animation no matter what is happening around. We probably want the character to be able to react to the environment and conditions of the game. So, how can we do this?</p></div></div><div class="section" title="Why do we need to blend animations?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec73"/>Why do we need to blend animations?</h2></div></div></div><p>In the previous exercise, we <a id="id425" class="indexterm"/>learned how to make a skeletal mesh take on a single animation. But can we make the skeletal mesh start running in a straight line? The next few sections of animation exercises will explain how we can do this and, subsequently, add more to this basic animation.</p><p>First of all, you need to remember that animation sequences/poses are played when you tell them to. While animating character, you need to look into the details so that the character looks normal.</p><p>Now, let's quickly recap what we did in the previous exercise: the skeletal mesh character was a zombie with no animation attached. When we linked the run animation and set it to play, the character immediately seemed like it was running. So, if we want the character to stop running, we can remove the run animation. The character goes back to looking like a zombie that hasn't been animated. If we did this in a game, you would probably think that there is something very wrong with the animation. Zombie-&gt;Running-&gt;Zombie. Nothing realistic about it.</p><p>How can we improve this? We start with an idle pose for the character; an idle pose is one where the character stands at a fixed spot and breathes. Breathing is part of animation too. It makes the character look like it's alive. Next, we set it to play the run animation. To stop this animation, we allow the character to take the idle position again. Not a bad attempt for this iteration. The character doesn't look like a zombie now, but it looks and feels real.</p><p>What else can we do to make this even better? Let's use an analogy of someone driving a car normally (not a race car driver). When moving from the start position, you accelerate from a speed of 0 up to a comfortable cruising speed. When you want to stop, you reduce the cruising speed by stepping on the brakes and then gradually go back to 0 (to avoid a stopping suddenly and giving your passengers the unpleasant experience of being thrown forward). Similarly, we can use this to help us design our character's transition from a stationary position. We will use a tool called<a id="id426" class="indexterm"/> <span class="strong"><strong>Blend Animation</strong></span> to create this transition so that we can make the movement of the character a little more realistic.</p><p>Blend Animation, as the name suggests, blends various types of animation using variables. It can be a simple one-dimensional relationship where we use speed as an axis to blend the animations or a two-dimensional relationship where we use both speed and direction to blend animations. Unreal Engine's Blend Animation tool is capable of setting up the blending of animations in different ways.</p><div class="section" title="Tutorial – creating a Blend Animation"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec38"/>Tutorial – creating a Blend Animation</h3></div></div></div><p>In this example, we will use <a id="id427" class="indexterm"/>speed as the parameter to blend the animation. Let's quickly cover the thought process here first before listing the steps to follow in the Unreal Editor to achieve this. This would help in your understanding of how this process works instead of simply following the process to make something happen.</p><p>At speed = 0, we assign the idle pose. As the speed increases, we should switch the animation from an idle to a walking animation. As the speed increases even more, the animation switches from walking to jogging, and then running. Here's an illustration of how the blend would look:</p><div class="mediaobject"><img src="graphics/B03679_05_07.jpg" alt="Tutorial – creating a Blend Animation"/></div><p>Next, let's identify which animation sequences we have in the animation pack and would be suitable for each of the stages:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Idle_Rifle_Hip</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Walk_Fwd_Rifle_Ironsights</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Jog_Fwd_Rifle</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Sprint_Fwd_Rifle</strong></span></li></ul></div><p>To create a simple <a id="id428" class="indexterm"/>1D Blend Space, we can right-click on the <code class="literal">Character</code> folder, and go to <span class="strong"><strong>Create Asset</strong></span> | <span class="strong"><strong>Animation</strong></span> | <span class="strong"><strong>Blend Space 1D</strong></span>. Alternatively, you can select the <code class="literal">Character</code> folder in <span class="strong"><strong>Content Browser</strong></span>, click on the <span class="strong"><strong>Create</strong></span> button at the top, go to <span class="strong"><strong>Animation</strong></span>, and then <span class="strong"><strong>Blend Space 1D</strong></span>.</p><div class="mediaobject"><img src="graphics/B03679_05_08.jpg" alt="Tutorial – creating a Blend Animation"/></div><p>Select <span class="strong"><strong>HeroTPP_Skeleton</strong></span>; clicking <a id="id429" class="indexterm"/>on this creates a new Blend Space 1D. Rename <span class="strong"><strong>newblendspace1d</strong></span> to <code class="literal">WalkJogRun</code>. Double-click on the newly created <span class="strong"><strong>WalkJogRun</strong></span> to open the editor. This will propel you straight to the <span class="strong"><strong>Animation</strong></span> tab of the editor. Notice that this part is highlighted in the following screenshot. In the <span class="strong"><strong>SkeletonMesh</strong></span> field, we have <span class="strong"><strong>HeroTPP_Skeleton</strong></span>, which was what we selected when creating the blend space earlier.</p><div class="mediaobject"><img src="graphics/B03679_05_09.jpg" alt="Tutorial – creating a Blend Animation"/></div><p>In the <span class="strong"><strong>Animation</strong></span> editor, you <a id="id430" class="indexterm"/>have access to <span class="strong"><strong>Asset Browser</strong></span> (which is, by default, in the bottom right-hand side of the screen). Clicking on the animation assets will allow you to preview how the animation looks.</p><p>Let's first set the <span class="strong"><strong>X Axis Label</strong></span> to <code class="literal">Speed</code>. <span class="strong"><strong>X Axis Range</strong></span> is from <code class="literal">0</code> to <code class="literal">375</code>. Leave <span class="strong"><strong>X Axis Divisions</strong></span> as <span class="strong"><strong>4</strong></span>.</p><p>The number of divisions creates segments in the speed graph that we have. Based on what we selected earlier for the Idle, Walk, Jog, and Run states, find the animation using <span class="strong"><strong>Asset Browser</strong></span>, click and drop the animation into the <span class="strong"><strong>WalkJogRun</strong></span> tab into the appropriate sections, as shown in the following screenshot:</p><p>
<span class="strong"><strong>Idle_Rifle_Hip</strong></span> is at speed = 0. Set <span class="strong"><strong>Walk_Fwd_Rifle_Ironsights</strong></span> in the first division line. When you drag an animation into the graph, it creates a node and snaps at one of the division lines. Set <span class="strong"><strong>Jog_Fwd_Rifle</strong></span> in the second division line and set <span class="strong"><strong>Sprint_Fwd_Rifle</strong></span> at speed = 375. To preview how the animation blends, move the mouse over the graph along the vertical axis.</p><div class="mediaobject"><img src="graphics/B03679_05_10.jpg" alt="Tutorial – creating a Blend Animation"/></div></div><div class="section" title="Tutorial – setting up the Animation Blueprint to use a Blend Animation"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec39"/>Tutorial – setting up the Animation Blueprint to use a Blend Animation</h3></div></div></div><p>Now we have created a<a id="id431" class="indexterm"/> Blend Animation <a id="id432" class="indexterm"/>that uses speed as a parameter. How do we make an NPC change speed and then link this animation to it so that as the speed changes and the animation that is played also changes?</p><p>For a simple implementation of getting the speed and animation to change, we will set up the Animation Blueprint. Go to <span class="strong"><strong>Content Browser</strong></span>. Navigate to <span class="strong"><strong>Animation</strong></span> | <span class="strong"><strong>Character</strong></span>; then, navigate and click on <span class="strong"><strong>Create Asset</strong></span> | <span class="strong"><strong>Animation</strong></span> | <span class="strong"><strong>Animation Blueprint</strong></span>:</p><div class="mediaobject"><img src="graphics/B03679_05_11.jpg" alt="Tutorial – setting up the Animation Blueprint to use a Blend Animation"/></div><p>Upon selecting <a id="id433" class="indexterm"/>
<span class="strong"><strong>Animation Blueprint</strong></span>, the <a id="id434" class="indexterm"/>editor will prompt you about the base class that you want the Animation Blueprint to be created in. This screenshot shows the options that are available for selection:</p><div class="mediaobject"><img src="graphics/B03679_05_12.jpg" alt="Tutorial – setting up the Animation Blueprint to use a Blend Animation"/></div><p>In this example, <a id="id435" class="indexterm"/>we will pick the most <a id="id436" class="indexterm"/>basic generic class, <code class="literal">AnimInstance</code>, to build our Animation Blueprint in. Select <span class="strong"><strong>HeroTPP_Skeleton</strong></span> as the target skeletal mesh for this blueprint. Name this Animation Blueprint <code class="literal">MyNPC_Blueprint</code>.</p><p>To check whether you have selected the correct target skeletal mesh, look in the <span class="strong"><strong>Skeleton</strong></span> tab in the <span class="strong"><strong>Blueprint</strong></span> window, as shown in the following screenshot. You should see <span class="strong"><strong>HeroTPP_Skeleton</strong></span> in the box. The screenshot also shows the <span class="strong"><strong>Graph</strong></span> tab that's been selected with the empty default AnimGraph showing. We will proceed through this exercise with the <span class="strong"><strong>Graph</strong></span> tab selected, unless specified otherwise.</p><div class="section" title="AnimGraph"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl4sec10"/>AnimGraph</h4></div></div></div><p>This screenshot shows the default blank <a id="id437" class="indexterm"/>AnimGraph. <span class="strong"><strong>Final Animation Pose</strong></span> will receive the output of the skeletal mesh that's been specified:</p><div class="mediaobject"><img src="graphics/B03679_05_13.jpg" alt="AnimGraph"/></div><p>First, we want to add a state machine by right-clicking within the AnimGraph and navigating to <span class="strong"><strong>State Machines</strong></span> | <span class="strong"><strong>Add New State Machine…</strong></span>, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/B03679_05_14.jpg" alt="AnimGraph"/></div><p>Rename the newly created state<a id="id438" class="indexterm"/> machine <span class="strong"><strong>Movement</strong></span>:</p><div class="mediaobject"><img src="graphics/B03679_05_15.jpg" alt="AnimGraph"/></div><p>Double-click on <span class="strong"><strong>Movement</strong></span>. Create a new state named <span class="strong"><strong>WalkJogRun</strong></span>:</p><div class="mediaobject"><img src="graphics/B03679_05_16.jpg" alt="AnimGraph"/></div><p>Double-click on the newly created <span class="strong"><strong>WalkJogRun</strong></span> state to modify the state in a new tab. Go to the <span class="strong"><strong>Asset Browser</strong></span> tab, look<a id="id439" class="indexterm"/> for <span class="strong"><strong>WalkJogRun</strong></span> blendspace, which we created in the previous exercise, and click and drag it into the editor. Link <span class="strong"><strong>WalkJogRun</strong></span> blendspace to the final animation, as shown in the following screenshot. Notice that speed = 0.00 is specified in the blendspace node; this was the variable that we defined to control the change of the animation when we created blendspace in the earlier exercise.</p><p>Next, we need to create a variable so that we can pass in a value to the <span class="strong"><strong>WalkJogRun</strong></span> blendspace speed variable. To do so, we need to click and drag the green dot next to the <span class="strong"><strong>Speed</strong></span> on the blendspace node to open up a contextual menu, look for <span class="strong"><strong>Promote to Variable</strong></span>, and then click on it. This promotes speed in the blendspace node to a float variable, which we would set to control the speed and type of animation that will be played. Rename this new variable <span class="strong"><strong>Speed</strong></span>. The following screenshot shows how we have created and connected a <span class="strong"><strong>Speed</strong></span> variable to <span class="strong"><strong>WalkJogRun</strong></span> blendspace, which is linked to <span class="strong"><strong>Final Animation Pose</strong></span>:</p><div class="mediaobject"><img src="graphics/B03679_05_17.jpg" alt="AnimGraph"/></div><p>Now, go back to link <a id="id440" class="indexterm"/>
<span class="strong"><strong>Movement</strong></span> to <span class="strong"><strong>Final Animation Pose</strong></span>:</p><div class="mediaobject"><img src="graphics/B03679_05_18.jpg" alt="AnimGraph"/></div><p>Now, the entire AnimGraph is linked up. Click on <span class="strong"><strong>Compile</strong></span>, and you would see the preview of the character model updated, as shown in the following screenshot. The white moving dots show how data flows through the system. The speed is 0 here.</p><div class="mediaobject"><img src="graphics/B03679_05_19.jpg" alt="AnimGraph"/></div><p>We can also use this tab to<a id="id441" class="indexterm"/> see live preview as we change the value to <span class="strong"><strong>Speed</strong></span>. The following screenshot shows you when speed is 50. The character model assumes a walking pose.</p><div class="mediaobject"><img src="graphics/B03679_05_20.jpg" alt="AnimGraph"/></div><p>Through AnimGraph, we were able to set up <span class="strong"><strong>Speed</strong></span> as a variable and link this variable to <span class="strong"><strong>WalkJogRun</strong></span> blendspace, which, in turn, controls what animation to play at which speed. We need to now think about how to provide some logic to determine how the speed of the NPC changes.</p></div><div class="section" title="EventGraph"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl4sec11"/>EventGraph</h4></div></div></div><p>EventGraph<a id="id442" class="indexterm"/> is used to program logic into the Blueprint.</p><p>In this example, we will use EventGraph to create logic to change the speed values that will, in turn, affect the NPC's animation control.</p><p>To create a more complex intelligent decision-making process, which is termed as AI, we will need to use a set of AI-related nodes in EventGraph. We will learn more about creating AI in the next section.</p><p>The following screenshot shows the default new <span class="strong"><strong>EventGraph</strong></span> tab in the Animation Blueprint.</p><p>The <span class="strong"><strong>Event Blueprint Update Animation</strong></span> node can be thought of as the source that sends a pulse through the EventGraph network. As this pulse travels through the network, it goes through a series of questions that you design to determine which animation is played.</p><div class="mediaobject"><img src="graphics/B03679_05_21.jpg" alt="EventGraph"/></div><p>
<span class="strong"><strong>Try Get Pawn Owner</strong></span> is to get the owner that Animation Blueprint is assigned to. This is simply used in combination with another node, <span class="strong"><strong>IsValid</strong></span>, to ensure that we have a valid owner before setting values to change the animation.</p><p>To make <span class="strong"><strong>MyNPC_Blueprint</strong></span> work for the <span class="strong"><strong>Hero_TPP</strong></span> mesh that we have in the level, we will need to first delete the <span class="strong"><strong>Try Get Pawn Owner</strong></span> node and replace it with <span class="strong"><strong>Get Owning Component</strong></span>. Right-click on the EventGraph and type <code class="literal">Get</code>. In the contextual menu that is opened, scroll down to find <span class="strong"><strong>Get Owning Component</strong></span>. This screenshot shows where the <span class="strong"><strong>Get Owning Component</strong></span> node is:</p><div class="mediaobject"><img src="graphics/B03679_05_22.jpg" alt="EventGraph"/></div><p>In the same way, right-click in the editor<a id="id443" class="indexterm"/> and type <code class="literal">IsValid</code> to look for the node. This screenshot shows where to get the <span class="strong"><strong>IsValid</strong></span> node:</p><div class="mediaobject"><img src="graphics/B03679_05_23.jpg" alt="EventGraph"/></div><p>Now, link the triangular output from <span class="strong"><strong>Event Blueprint Update Animation</strong></span> to the <span class="strong"><strong>Exec</strong></span> input of the <span class="strong"><strong>IsValid</strong></span> node (which is also a triangular input). Link <span class="strong"><strong>Return Value</strong></span> (this has a blue circle next to it) output from <span class="strong"><strong>Get Owning Component</strong></span> to <span class="strong"><strong>Input Object</strong></span> (this has a blue circle next to it) of the <span class="strong"><strong>IsValid</strong></span> node. The following screenshot shows the linkage of the three nodes.</p><p>The explanation for this is that at every tick, we need to check whether the target skeleton mesh is valid.</p><p>For now, let's simply set the speed of the NPC to 100 if the target skeleton mesh is valid. So, right-click on the EventGraph area, and type <code class="literal">SetSpeed</code> to filter the options. Click and select <span class="strong"><strong>Set Speed</strong></span>, as shown in this screenshot:</p><div class="mediaobject"><img src="graphics/B03679_05_24.jpg" alt="EventGraph"/></div><p>Link the <span class="strong"><strong>Is Valid</strong></span> output<a id="id444" class="indexterm"/> of the <span class="strong"><strong>IsValid</strong></span> node to the input (this has a triangular symbol) of the <span class="strong"><strong>SET Speed</strong></span> node. Then, click on the box next to <span class="strong"><strong>Speed</strong></span> and type <code class="literal">100</code> to set the speed:</p><div class="mediaobject"><img src="graphics/B03679_05_25.jpg" alt="EventGraph"/></div><p>Save and recompile now to see how the preview model changes. The following screenshot shows the model playing the walk animation when speed is set to 100:</p><div class="mediaobject"><img src="graphics/B03679_05_26.jpg" alt="EventGraph"/></div><p>Now, Animation Blueprint<a id="id445" class="indexterm"/> is ready for use in the game level. We need to assign this Animation Blueprint to a character in the game. Save and close the Animation Blueprint editor to go back to the main editor.</p><p>To assign the Blueprint to the skeleton mesh, we will click on the existing <span class="strong"><strong>HeroTPP</strong></span> to display the details panel. Focus on the animation part of the panel; the following screenshot shows the original setting that I have when there is no animation sequence linked to the skeleton mesh and it does not use an Animation Blueprint. Set <span class="strong"><strong>Animation Mode</strong></span> to <span class="strong"><strong>Use Animation Asset</strong></span> and <span class="strong"><strong>Anim to Play</strong></span> to <span class="strong"><strong>None</strong></span>:</p><div class="mediaobject"><img src="graphics/B03679_05_27.jpg" alt="EventGraph"/></div><p>To use <span class="strong"><strong>MyNPC_Blueprint</strong></span> for this <a id="id446" class="indexterm"/>skeleton mesh, set <span class="strong"><strong>Animation Mode</strong></span> to <span class="strong"><strong>Use Animation Blueprint</strong></span>. Select <span class="strong"><strong>MyNPC_Blueprint</strong></span> for <span class="strong"><strong>Anim Blueprint Generated Class</strong></span>:</p><div class="mediaobject"><img src="graphics/B03679_05_28.jpg" alt="EventGraph"/></div><p>Now, compile and run the game; you would see the NPC walking on the same spot with the speed set as 100.</p></div></div></div></div>
<div class="section" title="Artificial intelligence"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec61"/>Artificial intelligence</h1></div></div></div><p>AI is a <a id="id447" class="indexterm"/>decision-making process that adds NPCs in a game. AI is a programmable decision-making process for NPCs to govern their responses and behaviors in a game. A game character that is not controlled by a human player has no form of intelligence, and when these characters need to have a higher form of decision-making process, we apply AI to them.</p><p>AI in games has progressed tremendously over the years and NPCs can be programmed to behave in a certain way, sometimes, with some form of randomness, making it almost unpredictable so that players do not have a simple, straightforward strategy to win the level.</p><p>The decision-making process, which is also the logic of the NPCs, is stored in a data structure known as a Behavior Tree. We will first learn how to design a simple Behavior Tree then learn how to implement this in Unreal Engine 4.</p><div class="section" title="Understanding a Behavior Tree"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec74"/>Understanding a Behavior Tree</h2></div></div></div><p>Learning how to design a <a id="id448" class="indexterm"/>good decision-making tree is very important. This is the foundation on which programmers or scripters rely to create the behavior of a character in a game. The Behavior Tree is the equivalent of a construction blueprint for architects who design your house.</p><p>A Behavior Tree has roots that branch out into layers of child nodes, which are ordered from left to right (this means that you always start from the left-most node when traversing the child nodes) that describe the decision-making process. The nodes that make up the Behavior Tree mainly fall into three categories: Composite, Decorator, or Leaf. Once you are familiar with a couple of the common types of nodes in each of the three categories, you would be ready to create your own complex behaviors:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom"> </th><th style="text-align: left" valign="bottom">
<p>Composite</p>
</th><th style="text-align: left" valign="bottom">
<p>Decorator</p>
</th><th style="text-align: left" valign="bottom">
<p>Leaf</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Children nodes</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Having one or more children are possible.</p>
</td><td style="text-align: left" valign="top">
<p>This can only have a single child node.</p>
</td><td style="text-align: left" valign="top">
<p>This cannot have any children at all.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Function</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Children nodes are processed, depending on the particular type of composite node.</p>
</td><td style="text-align: left" valign="top">
<p>This either transforms results from a child node's status, terminates the child, or repeats the processing of the child, depending on the particular type of Decorator.</p>
</td><td style="text-align: left" valign="top">
<p>This executes specific game actions/tasks or tests.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Node examples</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>The <span class="strong"><strong>Sequence</strong></span> node processes the children nodes from the left-most child in sequence, collects results from each child, and passes the overall success or failure result over to the parent (note that even when only one child fails and the rest succeed, the overall result is failure). This can be thought of as an <span class="strong"><strong>AND</strong></span> node.</p>
</td><td style="text-align: left" valign="top">
<p>The <span class="strong"><strong>Inverter</strong></span> node converts a success to a failure and pass this inverted result back to the parent. It works vice versa as well.</p>
</td><td style="text-align: left" valign="top">
<p>The <span class="strong"><strong>Shoot Once leaf</strong></span> node shows that the NPC would shoot once and return a success or failure, depending on the result.</p>
</td></tr></tbody></table></div></div><div class="section" title="Exercise – designing the logic of a Behavior Tree"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec75"/>Exercise – designing the logic of a Behavior Tree</h2></div></div></div><p>This is a simple walkthrough of <a id="id449" class="indexterm"/>how a Behavior Tree can be <a id="id450" class="indexterm"/>constructed. The following legend will help you identify the different components of a Behavior Tree:</p><div class="mediaobject"><img src="graphics/B03679_05_29.jpg" alt="Exercise – designing the logic of a Behavior Tree"/></div></div><div class="section" title="Example – creating a simple Behavior Tree"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec76"/>Example – creating a simple Behavior Tree</h2></div></div></div><p>The following figure<a id="id451" class="indexterm"/> shows a simple response for an enemy NPC. The enemy will only start attacking when the war starts.</p><div class="mediaobject"><img src="graphics/B03679_05_30.jpg" alt="Example – creating a simple Behavior Tree"/></div><p>The following figure has been expanded on the earlier Behavior Tree. It gives a more detailed description of how the enemy NPC should approach the target. The NPC will run towards the target (the player character in this case), and if it is close enough, it starts shooting the player.</p><div class="mediaobject"><img src="graphics/B03679_05_31.jpg" alt="Example – creating a simple Behavior Tree"/></div><p>Next, we set more<a id="id452" class="indexterm"/> behaviors that show how the NPC will shoot the player. We give the enemy NPC a little intelligence: hide if someone is shooting at it and start shooting if no one is shooting at it; if the player starts moving in toward it, the NPC starts moving backward to a better spot or goes for a death match (it shoots the player at close range).</p><div class="mediaobject"><img src="graphics/B03679_05_32.jpg" alt="Example – creating a simple Behavior Tree"/></div></div><div class="section" title="How to implement a Behavior Tree in Unreal Engine 4"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec77"/>How to implement a Behavior Tree in Unreal Engine 4</h2></div></div></div><p>The Unreal Editor <a id="id453" class="indexterm"/>allows complex Behavior <a id="id454" class="indexterm"/>Trees to be designed using the visual scripting Blueprints together with several AI components.</p><p>There is also an option in Unreal Engine 4 where very complex AI behaviors can be programmed in the conventional way or in combination with Blueprint visual scripting.</p><p>The nodes for BT in UE4 are broadly divided into five categories. Just to recap, we have already learned a little about the first four in the previous section; <span class="strong"><strong>Service</strong></span> is the only new category here:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Root</strong></span>: The starting node for a Behavior Tree and every Behavior Tree has only one root.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Composite</strong></span>: These are the nodes that define the root of a branch and the base rules for how this branch is executed.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Decorator</strong></span>: This is also known as a <a id="id455" class="indexterm"/><span class="strong"><strong>conditional</strong></span>. These attach themselves to another node and make decisions on whether or not a branch in the tree, or even a single node, can be executed.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Task</strong></span>: This is also known as a Leaf in a typical BT. These are the leaves of the tree, that is, the nodes that "do" things.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Service</strong></span>: These are attachments to composite nodes. They are executed at a defined frequency, as long as their branch is being executed. These are often used to make checks and update the <a id="id456" class="indexterm"/><span class="strong"><strong>Blackboard</strong></span>. These take the place of traditional parallel nodes in other Behavior Tree systems.</li></ul></div></div><div class="section" title="Navigation Mesh"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec78"/>Navigation Mesh</h2></div></div></div><p>For AI characters to move around in the game level, we need to specifically tell the AI character which areas in the map are accessible.</p><p>Unreal Engine has implemented a mesh-like component known as <a id="id457" class="indexterm"/>
<span class="strong"><strong>Navigation Mesh</strong></span>. The Navigation Mesh is pretty much like a block volume; you could scale the size of the mesh to cover a specific area in the game level that an AI character can move around in. This limits the area in which an AI can go and makes the movement of the character more predictable.</p><div class="section" title="Tutorial – creating a Navigation Mesh"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec40"/>Tutorial – creating a Navigation Mesh</h3></div></div></div><p>Go to <span class="strong"><strong>Modes</strong></span> | <span class="strong"><strong>Volumes</strong></span>. Click and <a id="id458" class="indexterm"/>drop <span class="strong"><strong>Nav Mesh Bounds Volume</strong></span> into your game level. The following screenshot shows where you can find <span class="strong"><strong>Nav Mesh Bounds Volume</strong></span> in the editor:</p><div class="mediaobject"><img src="graphics/B03679_05_33.jpg" alt="Tutorial – creating a Navigation Mesh"/></div><p>If you are unable to see <span class="strong"><strong>Nav Mesh Bounds Volume</strong></span> in your map, go to the <span class="strong"><strong>Show</strong></span> settings within the editor, as shown in the following screenshot. Make sure the checkbox next to <span class="strong"><strong>Navigation</strong></span> is checked:</p><div class="mediaobject"><img src="graphics/B03679_05_34.jpg" alt="Tutorial – creating a Navigation Mesh"/></div><p>Scale and move the<a id="id459" class="indexterm"/> Navigation Mesh to cover the area of the floor you want the AI character to be able to access. What I have done in the following screenshot is to scale the mesh to fit the floor area which I want my AI character to walk in. Translate the mesh upward and downward to allow it to be slightly above the actual ground mesh. The Navigation Mesh should sort of enclose the ground mesh. This screenshot shows how the mesh looks when it is visible:</p><div class="mediaobject"><img src="graphics/B03679_05_35.jpg" alt="Tutorial – creating a Navigation Mesh"/></div></div></div><div class="section" title="Tutorial – setting up AI logic"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec79"/>Tutorial – setting up AI logic</h2></div></div></div><p>Here's an overview of the <a id="id460" class="indexterm"/>components that we will create for this tutorial:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Blueprint AIController (<span class="strong"><strong>MyNPC_AIController</strong></span>)</li><li class="listitem" style="list-style-type: disc">Blueprint Character (<span class="strong"><strong>MyNPC_Character</strong></span>)</li><li class="listitem" style="list-style-type: disc">BlackBoard (<span class="strong"><strong>MyNPC_Brain</strong></span>)</li><li class="listitem" style="list-style-type: disc">Behavior Tree (<span class="strong"><strong>MyNPC_BT</strong></span>)</li><li class="listitem" style="list-style-type: disc">Blueprint Behavior Tree Task (<span class="strong"><strong>Task_PickTargetLocation</strong></span>)</li></ul></div><p>The important takeaway from this tutorial is to learn how the components are linked up to work together to create logic; we make use of this logic to control the behavior of the NPC.</p><p>In terms of file structure in <span class="strong"><strong>Content Browser</strong></span> for these different file types, you can group the different components into different folders. For this example, since we are only creating one NPC character with logic, I will put all these components into a single folder for simplicity. I created <code class="literal">MyFolder</code> under the main directory for this purpose.</p><p>We start creating the AI logic of our NPC starting with AIController and Character. The Character Blueprint is the object that contains the link to the mesh, and we will drag and drop this Character Blueprint into the level map after we make some initial configurations. The AIController is the component that gives the NPC character its logic.</p><p>We will discuss the <a id="id461" class="indexterm"/>rest of the other three components as we go along.</p><div class="section" title="Creating the Blueprint AIController"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec41"/>Creating the Blueprint AIController</h3></div></div></div><p>Go to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Blueprint</strong></span>. Type<a id="id462" class="indexterm"/> in <code class="literal">AIController</code> into the textbox to filter by class, as shown in the following screenshot. Select <span class="strong"><strong>AIController</strong></span> as the parent class.</p><p>Rename this AIController Blueprint as <code class="literal">MyNPC_AIController</code>:</p><div class="mediaobject"><img src="graphics/B03679_05_36.jpg" alt="Creating the Blueprint AIController"/></div><p>We will come back to configure this later.</p></div><div class="section" title="Creating the Blueprint character"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec42"/>Creating the Blueprint character</h3></div></div></div><p>Go to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Blueprint</strong></span>, and type<a id="id463" class="indexterm"/> in <code class="literal">Character</code> in the textbox to filter by class. Select <span class="strong"><strong>Character</strong></span> as the parent class for the Blueprint, as shown in the following screenshot. Rename this Blueprint as <code class="literal">MyNPC_Character</code>.</p><div class="mediaobject"><img src="graphics/B03679_05_37.jpg" alt="Creating the Blueprint character"/></div></div><div class="section" title="Adding and configuring Mesh to a Character Blueprint"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec43"/>Adding and configuring Mesh to a Character Blueprint</h3></div></div></div><p>Double-click <a id="id464" class="indexterm"/>on <a id="id465" class="indexterm"/>
<span class="strong"><strong>MyNPC_Character</strong></span> in <span class="strong"><strong>Content Browser</strong></span> to open the Character Blueprint<a id="id466" class="indexterm"/> editor. Go to the <span class="strong"><strong>Components</strong></span> tab.</p><p>In the <span class="strong"><strong>Perspective</strong></span> space <a id="id467" class="indexterm"/>view, you will see an empty wireframe-capsule-shaped object, as shown in the following screenshot. In the <span class="strong"><strong>Details</strong></span> panel in the Blueprint editor, scroll to the <span class="strong"><strong>Mesh</strong></span> section, and we will add a mesh to this Blueprint by selecting an existing mesh we have. You can go to <span class="strong"><strong>Content Browser</strong></span>, select <span class="strong"><strong>HeroTPP</strong></span>, and click on the arrow next to it. Alternatively, you can click on the search button next to the box and find <span class="strong"><strong>HeroTPP</strong></span>:</p><div class="mediaobject"><img src="graphics/B03679_05_38.jpg" alt="Adding and configuring Mesh to a Character Blueprint"/></div><p>After selecting <a id="id468" class="indexterm"/>
<span class="strong"><strong>HeroTPP</strong></span> as the skeletal mesh, you will see<a id="id469" class="indexterm"/> the mesh appearing in the wireframe capsule. Notice<a id="id470" class="indexterm"/> that the <span class="strong"><strong>HeroTPP</strong></span> skeletal mesh is <a id="id471" class="indexterm"/>much larger than the capsule wireframe, as shown in the following screenshot. We want to be able to adjust the size of the wireframe to surround the height and width of the skeletal mesh as closely as possible. This will define the collision volume of the character.</p><div class="mediaobject"><img src="graphics/B03679_05_39.jpg" alt="Adding and configuring Mesh to a Character Blueprint"/></div><p>This figure shows <a id="id472" class="indexterm"/>when the wireframe for the skeletal mesh <a id="id473" class="indexterm"/>is the <a id="id474" class="indexterm"/>correct <a id="id475" class="indexterm"/>height:</p><div class="mediaobject"><img src="graphics/B03679_05_40.jpg" alt="Adding and configuring Mesh to a Character Blueprint"/></div></div><div class="section" title="Linking AIController to the Character Blueprint"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec44"/>Linking AIController to the Character Blueprint</h3></div></div></div><p>Go to the <span class="strong"><strong>Default</strong></span> <a id="id476" class="indexterm"/>tab of <span class="strong"><strong>MyNPC_Character</strong></span>, scroll<a id="id477" class="indexterm"/> to the AI section, and click on the scroll box to display the options available for AIControllers. Select <span class="strong"><strong>MyNPC_AIController</strong></span> to assign the character to use this AIController, as shown in this screenshot. Compile, save, and close <span class="strong"><strong>MyNPC_Character</strong></span> for now.</p><div class="mediaobject"><img src="graphics/B03679_05_41.jpg" alt="Linking AIController to the Character Blueprint"/></div><p>Go to <span class="strong"><strong>Content Browser</strong></span>, and click and drop <span class="strong"><strong>MyNPC_Character</strong></span> into the level map. Compile and play the level. You will see that the character appears in the level but it is static.</p></div><div class="section" title="Adding basic animation"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec45"/>Adding basic animation</h3></div></div></div><p>Similar to the early <a id="id478" class="indexterm"/>implementation of assigning an animation to the mesh, we will add animation to <span class="strong"><strong>MyNPC_Character</strong></span>. Double-click on <span class="strong"><strong>MyNPC_Character</strong></span> to open the editor. Go the <span class="strong"><strong>Default</strong></span> tab, scroll to the <span class="strong"><strong>Animation</strong></span> section, and assign the Animation Blueprint (<span class="strong"><strong>MyNPC_Blueprint</strong></span>), which we created earlier for this Character Blueprint. The following screenshot shows how we can assign animation to the character. Compile and save <span class="strong"><strong>MyNPC_Character</strong></span>:</p><div class="mediaobject"><img src="graphics/B03679_05_42.jpg" alt="Adding basic animation"/></div><p>Now, play the level <a id="id479" class="indexterm"/>again, and you will see that the character is now walking on the spot (as we have set the speed to 100 in the Animation Blueprint, <span class="strong"><strong>MyNPC_Blueprint</strong></span>).</p></div><div class="section" title="Configuring AIController"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec46"/>Configuring AIController</h3></div></div></div><p>Go to <span class="strong"><strong>Content Browser</strong></span>. Then, go to <span class="strong"><strong>MyFolder</strong></span> and double-click on <span class="strong"><strong>MyNPC_AIController</strong></span> to open<a id="id480" class="indexterm"/> the editor. We will now add nodes in EventGraph to design the logic.</p><p>Our first mission is to get the character to move forward (instead of just walking on the same spot).</p><div class="section" title="Nodes to add in EventGraph"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl4sec12"/>Nodes to add in EventGraph</h4></div></div></div><p>The following are the<a id="id481" class="indexterm"/> nodes to be added in EventGraph:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Event Tick</strong></span>: This<a id="id482" class="indexterm"/> is used to trigger the loop to run at every tick</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Get Controlled Pawn</strong></span>: This returns the pawn of AIController (which will be the pawn of <span class="strong"><strong>HeroTPP</strong></span>)</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Get Actor Forward Vector</strong></span>: This gets the forward vector</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Add Movement Input</strong></span>: This links the target to <span class="strong"><strong>Get Controlled Pawn</strong></span> and <span class="strong"><strong>Link World Direction</strong></span> to the output of <span class="strong"><strong>Get Actor Forward Vector</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>IsValid</strong></span>: This is to ensure that the pawn exists first before actually changing the pawn values</li></ul></div><p>The following screenshot shows the final EventGraph that we want to create:</p><div class="mediaobject"><img src="graphics/B03679_05_43.jpg" alt="Nodes to add in EventGraph"/></div><p>Now, play the level again, and <a id="id483" class="indexterm"/>you will see that the character is now walking forward. But <a id="id484" class="indexterm"/>it's doing this a little too quickly. We want to adjust the maximum speed at which the character moves.</p></div></div><div class="section" title="Adjusting movement speed"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec47"/>Adjusting movement speed</h3></div></div></div><p>Double-click on<a id="id485" class="indexterm"/> <span class="strong"><strong>MyNPC_Character</strong></span> to open the editor. Go to the <span class="strong"><strong>Default</strong></span> tab, scroll to the <span class="strong"><strong>Character Movement</strong></span> section, and set <span class="strong"><strong>Max Walk Speed</strong></span> to <span class="strong"><strong>100</strong></span>, as shown in this screenshot:</p><div class="mediaobject"><img src="graphics/B03679_05_44.jpg" alt="Adjusting movement speed"/></div></div><div class="section" title="Creating the BlackBoardData"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec48"/>Creating the BlackBoardData</h3></div></div></div><p>BlackBoardData functions <a id="id486" class="indexterm"/>as the memory unit of the brain of the NPC. This is where you store and retrieve data that would be used to control the behavior of the NPC. Go to <span class="strong"><strong>Content Browser</strong></span>, and navigate to <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Miscellaneous</strong></span> | <span class="strong"><strong>Blackboard</strong></span>. Rename it <code class="literal">MyNPC_Brain</code>.</p><div class="mediaobject"><img src="graphics/B03679_05_45.jpg" alt="Creating the BlackBoardData"/></div><div class="section" title="Adding a variable into BlackBoardData"><div class="titlepage"><div><div><h4 class="title"><a id="ch05lvl4sec13"/>Adding a variable into BlackBoardData</h4></div></div></div><p>Double-click on <a id="id487" class="indexterm"/>
<span class="strong"><strong>MyNPC_Brain</strong></span> to open the BlackBoardData editor. Click on <a id="id488" class="indexterm"/>
<span class="strong"><strong>New Key</strong></span>, select <span class="strong"><strong>Key Type</strong></span> as <span class="strong"><strong>Vector</strong></span>, and name it <code class="literal">TargetLocation</code>. This screenshot shows that <span class="strong"><strong>TargetLocation</strong></span> is created correctly. Save and close the editor.</p><div class="mediaobject"><img src="graphics/B03679_05_46.jpg" alt="Adding a variable into BlackBoardData"/></div></div></div><div class="section" title="Creating a Behavior Tree"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec49"/>Creating a Behavior Tree</h3></div></div></div><p>Behavior Tree is the<a id="id489" class="indexterm"/> logic path that NPC goes through to determine what course of action to take.</p><p>To create a Behavior Tree in Unreal Engine, go to <span class="strong"><strong>Content Browser</strong></span> | <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Miscellaneous</strong></span>, and then click on <span class="strong"><strong>Behavior Tree</strong></span>. Rename it <code class="literal">MyNPC_BT</code>.</p><div class="mediaobject"><img src="graphics/B03679_05_47.jpg" alt="Creating a Behavior Tree"/></div><p>Double-click on <span class="strong"><strong>MyNPC_BT</strong></span> to open the Behavior Tree editor. The following screenshot shows the setting that we want for <span class="strong"><strong>MyNPC_BT</strong></span>. It should have <span class="strong"><strong>MyNPC_Brain</strong></span> set as the BlackBoard asset. If it doesn't, search for <span class="strong"><strong>MyNPC_Brain</strong></span> and assign it as the BlackBoard asset.</p><p>If you have already gone <a id="id490" class="indexterm"/>through the earlier exercise and are familiar with a Behavior Tree, you will notice that in this editor that there is a <span class="strong"><strong>Root</strong></span> node, which you could use to start building out your NPC's behavior.</p><div class="mediaobject"><img src="graphics/B03679_05_48.jpg" alt="Creating a Behavior Tree"/></div></div><div class="section" title="Creating a simple BT using a Wait task"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec50"/>Creating a simple BT using a Wait task</h3></div></div></div><p>The next step here <a id="id491" class="indexterm"/>is to add on a composite<a id="id492" class="indexterm"/> node (either <span class="strong"><strong>Sequence</strong></span>, <span class="strong"><strong>Selector</strong></span>, or <span class="strong"><strong>Simple Parallel</strong></span>). In this example, we will select and use a <span class="strong"><strong>Sequence</strong></span> node to extend our Behavior Tree here. You can click and drag from the <span class="strong"><strong>Root</strong></span> node to open up the contextual menu, as shown in the following screenshot. Alternatively, just right-click to open up the menu and select the node that you want to create.</p><div class="mediaobject"><img src="graphics/B03679_05_49.jpg" alt="Creating a simple BT using a Wait task"/></div><p>We will add a <span class="strong"><strong>Wait</strong></span> <a id="id493" class="indexterm"/>task from the <span class="strong"><strong>Sequence</strong></span> node. Click <a id="id494" class="indexterm"/>and drag to create a new connection from the <span class="strong"><strong>Sequence</strong></span> node. From the contextual menu, select <span class="strong"><strong>Wait</strong></span>. Set <span class="strong"><strong>Wait</strong></span> to be <span class="strong"><strong>15.0s</strong></span>, as shown in this screenshot. Save and compile <span class="strong"><strong>MyNPC_BT</strong></span>.</p><div class="mediaobject"><img src="graphics/B03679_05_50.jpg" alt="Creating a simple BT using a Wait task"/></div><p>After compiling, click on <span class="strong"><strong>Play</strong></span> in the Behavior Tree editor. You would see the light moving through the <a id="id495" class="indexterm"/>links and especially from the <a id="id496" class="indexterm"/>
<span class="strong"><strong>Sequence</strong></span> node to the <span class="strong"><strong>Wait</strong></span> task for 15s.</p></div><div class="section" title="Using the Behavior Tree"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec51"/>Using the Behavior Tree</h3></div></div></div><p>Now that we <a id="id497" class="indexterm"/>have a simple implementation of the Behavior Tree, we want our NPC character to start using it. How do we do this? Go to <span class="strong"><strong>Content Browser</strong></span> | <span class="strong"><strong>MyFolder</strong></span>, and double-click on <span class="strong"><strong>MyNPC_AIController</strong></span> to open up the editor. Go to the <span class="strong"><strong>EventGraph</strong></span> tab where we initially created a simple move forward implementation. Break the initial links between the <span class="strong"><strong>IsValid</strong></span> node and <span class="strong"><strong>Add Movement Input</strong></span>. Rewire them based on the following screenshot by linking the <span class="strong"><strong>IsValid</strong></span> node to a new <span class="strong"><strong>Run</strong></span> Behavior Tree node. In the <span class="strong"><strong>Run</strong></span> Behavior Tree node, assign <span class="strong"><strong>BTAsset</strong></span> to <span class="strong"><strong>MyNPC_BT</strong></span>. Next, replace <span class="strong"><strong>Event Tick</strong></span> with <span class="strong"><strong>Event Begin Play</strong></span> (since the BT will now replace the thinking function here). Save and compile.</p><div class="mediaobject"><img src="graphics/B03679_05_51.jpg" alt="Using the Behavior Tree"/></div></div><div class="section" title="Creating a custom task for the Behavior Tree"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec52"/>Creating a custom task for the Behavior Tree</h3></div></div></div><p>We want to now<a id="id498" class="indexterm"/> make the NPC select a location on the map <a id="id499" class="indexterm"/>and walk toward it.</p><p>This requires the creation of a custom task where the NPC has to select a target location. We have already created an entry in the BlackBoardData to store a vector value. However, we have not made a way to assign values to the data yet. This would be done by creating a custom Behavior Tree task.</p><p>Go to <span class="strong"><strong>Content Browser</strong></span> | <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Blueprint</strong></span>. For the parent class, search for <span class="strong"><strong>BTNode</strong></span> and select <span class="strong"><strong>BTTask_BlueprintBase</strong></span>, as shown<a id="id500" class="indexterm"/> in the following screenshot. Rename this task as <code class="literal">Task_PickTargetLocation</code>.</p><div class="mediaobject"><img src="graphics/B03679_05_52.jpg" alt="Creating a custom task for the Behavior Tree"/></div><p>Double-click on the <a id="id501" class="indexterm"/>newly created <span class="strong"><strong>Task_PickTargetLocation</strong></span>. Go to <span class="strong"><strong>EventGraph</strong></span>, create the following nodes, and link these nodes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Event Receive Execute</strong></span>: Link <span class="strong"><strong>Owner Actor</strong></span> to the target of <span class="strong"><strong>Get Actor Location</strong></span>. When <span class="strong"><strong>PickTargetLocation</strong></span> is executed, <span class="strong"><strong>Event Receive Execute</strong></span> starts.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Get Actor Location</strong></span>: Link <span class="strong"><strong>Return Value</strong></span> to <span class="strong"><strong>Origin of Get Random Point</strong></span> in the <span class="strong"><strong>Radius</strong></span> node.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Set Blackboard Value as Vector</strong></span>: Link <span class="strong"><strong>Event Receive Execute</strong></span> to the execution arrow of <span class="strong"><strong>Set Blackboard Value as Vector</strong></span>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Get Random Point in Radius</strong></span>: Link <span class="strong"><strong>Return Value</strong></span> to the <span class="strong"><strong>Value</strong></span> input for <span class="strong"><strong>Set Blackboard Value as Vector</strong></span>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Finish Execute</strong></span>: Link <span class="strong"><strong>Set Blackboard Value as Vector</strong></span> to the input execution of <span class="strong"><strong>Finish Execute</strong></span>.<div class="mediaobject"><img src="graphics/B03679_05_53.jpg" alt="Creating a custom task for the Behavior Tree"/></div></li></ul></div><p>Notice that there is a <a id="id502" class="indexterm"/>
<span class="strong"><strong>New Target Loc</strong></span> variable linked to <span class="strong"><strong>Key</strong></span> of<a id="id503" class="indexterm"/> <span class="strong"><strong>Set Blackboard Value as Vector</strong></span>. We need to create a new variable for this. Click on <span class="strong"><strong>+Variable</strong></span>, as shown in the following screenshot, to create a new variable. Name the new variable <code class="literal">New Target Loc</code>.</p><div class="mediaobject"><img src="graphics/B03679_05_54.jpg" alt="Creating a custom task for the Behavior Tree"/></div><p>Click on the newly created <span class="strong"><strong>New Target Loc</strong></span> to display the details of the variable. Select <span class="strong"><strong>BlackBoardKeySelector</strong></span> as the variable type, as shown in this screenshot:</p><div class="mediaobject"><img src="graphics/B03679_05_55.jpg" alt="Creating a custom task for the Behavior Tree"/></div><p>Save and <a id="id504" class="indexterm"/>compile the<a id="id505" class="indexterm"/> custom task.</p></div><div class="section" title="Using the PickTargetLocation custom task in BT"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec53"/>Using the PickTargetLocation custom task in BT</h3></div></div></div><p>Add a new <a id="id506" class="indexterm"/>link<a id="id507" class="indexterm"/> from the current <span class="strong"><strong>Sequence</strong></span> composite node. Place the <span class="strong"><strong>Task_PickTargetLocation</strong></span> node to the left of the <span class="strong"><strong>Sequence</strong></span> node so that it would be executed first, as shown in the following screenshot. Make sure that <span class="strong"><strong>New Target Loc</strong></span> is set as <span class="strong"><strong>TargetLocation</strong></span>:</p><div class="mediaobject"><img src="graphics/B03679_05_56.jpg" alt="Using the PickTargetLocation custom task in BT"/></div></div><div class="section" title="Replacing the Wait task with Move To"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec54"/>Replacing the Wait task with Move To</h3></div></div></div><p>Delete the <span class="strong"><strong>Wait</strong></span> node, and add<a id="id508" class="indexterm"/> the <span class="strong"><strong>Move To</strong></span> node in its place. Make<a id="id509" class="indexterm"/> sure that <span class="strong"><strong>Blackboard Key</strong></span> for <span class="strong"><strong>Move To</strong></span> is set as <span class="strong"><strong>TargetLocation</strong></span>, as show in this screenshot:</p><div class="mediaobject"><img src="graphics/B03679_05_57.jpg" alt="Replacing the Wait task with Move To"/></div><p>After compiling, click on <span class="strong"><strong>Play</strong></span> to run the game. Double-click on <span class="strong"><strong>MyNPC_BT</strong></span> to open the Behavior Tree editor. You would see the light moving through the links and the <span class="strong"><strong>TargetLocation</strong></span> value changing in the Blackboard, as shown in this screenshot:</p><div class="mediaobject"><img src="graphics/B03679_05_58.jpg" alt="Replacing the Wait task with Move To"/></div><p>Remember to go back to <a id="id510" class="indexterm"/>the map level and see how the NPC is behaving<a id="id511" class="indexterm"/> now. The NPC now selects a target location and then move to the target location. Then, it selects a new target location and moves to another spot.</p><p>With this example, you have gained a detailed understanding of how to set up AI behavior and getting AI to work in your level. Challenge yourself to create more complex behaviors using the knowledge gained in this section.</p></div></div><div class="section" title="Implementing AI in games"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec80"/>Implementing AI in games</h2></div></div></div><p>I am sure you have noticed <a id="id512" class="indexterm"/>that we definitely need to create more complex behaviors<a id="id513" class="indexterm"/> to make a game interesting. In terms of implementation, it is often easier to implement more complex AI through a combination of programming and use the editor functions to take this a step further. So, it is important to know how AI can be triggered via the editor and how you can customize AI for your game.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec62"/>Summary</h1></div></div></div><p>This chapter covers both animation and artificial intelligence. These are huge topics in game development and there is definitely more to learn about them. I hope that through this chapter, you now have a strong understanding of these two topics and will use your skills to further explore more functions in the Unreal Editor to create cooler stuff.</p><p>We learned a little about the history of animation, how animation is created today in 3D computer games through various 3D modeling software, and finally, how to import this animation into Unreal Engine to be used in games. An animation sequence is the format in which animation is stored/played in Unreal, and you've learned about a simple blend technique to combine different animation sequences.</p><p>Personally, I love how AI contributes to a game. In this chapter, you learned about the different components that make up AI logic. The main AI logic is executed through the Behavior Tree, and we learned how to construct a Behavior Tree in terms of logic as well as how to replicate this into the Unreal Editor itself through the use of BlackBoardData, Task, Composite, and other nodes.</p><p>Ending this chapter, we have covered a huge portion of what we need to create a game. In the next chapter, you will learn how to add sounds and particle effects into a game.</p></div></body></html>