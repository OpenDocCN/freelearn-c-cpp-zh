<html><head></head><body><div id="sbo-rt-content" class="calibre1"><div class="calibre2" title="Chapter 8. Enabling Your Qt Application to Support Other Languages"><div class="titlepage"><div class="calibre2"><div class="calibre2"><h1 class="title"><a id="ch08" class="calibre7 pcalibre pcalibre3 pcalibre2 pcalibre1"/>Chapter 8. Enabling Your Qt Application to Support Other Languages</h1></div></div></div><p class="calibre9">In this era of globalization, the internationalization and localization of applications is almost inevitable. Fortunately, Qt provides relevant classes, along with some handy tools such as <span class="strong"><strong class="calibre10">Qt Linguist</strong></span> to ease the burden of developers and translators. In this chapter, we will use two example applications to demonstrate the following topics:</p><div class="calibre2"><ul class="itemizedlist"><li class="listitem">Internationalization of Qt applications</li><li class="listitem">Translating Qt Widgets applications</li><li class="listitem">Disambiguating identical texts</li><li class="listitem">Changing languages dynamically</li><li class="listitem">Translating Qt Quick applications</li></ul></div><div class="calibre2" title="Internationalization of Qt applications"><div class="titlepage"><div class="calibre2"><div class="calibre2"><h1 class="title2"><a id="ch08lvl1sec54" class="calibre7 pcalibre pcalibre3 pcalibre2 pcalibre1"/>Internationalization of Qt applications</h1></div></div></div><p class="calibre9">Internationalization and localization are the processes of adapting the application to other locales, which<a id="id376" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> might include different languages and regional differences. In software development, internationalization refers to designing an application in such a way that it can be adapted to various languages and regions without code changes. On the other hand, localization means adapting internationalized software for a specific language or region. This usually involves locale-specific components and translating text.</p><p class="calibre9">Qt has done a lot to free developers from different writing systems. We don't need to worry about how different languages display and input, as long as we use Qt's input and display controls or their subclasses.</p><p class="calibre9">In most cases, what we need to do is to produce translations and enable them in the application. Qt offers the <code class="literal">QTranslator</code> class, which loads the translation file and displays the corresponding language on the screen. The procedure is concluded in the following diagram:</p><div class="mediaobject"><img src="Images/4615OS_08_01.jpg" alt="Internationalization of Qt applications" class="calibre73"/></div><p class="calibre9">First of all, Qt won't just make all the strings translatable, because that would obviously be a disaster. Instead, you <a id="id377" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/>need to explicitly set whether the string is translatable in code or in the <span class="strong"><strong class="calibre10">Design</strong></span> mode. In the Qt/C++ code, use the <a id="id378" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/><code class="literal">tr()</code> function to enclose all the strings that can be translated. We use the<a id="id379" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> <code class="literal">qsTr()</code> function to do this job in the Qt Quick/QML code. Let me show you an example. Here is a demonstration of the normal usage of a string:</p><div class="calibre2"><pre class="programlisting">qDebug() &lt;&lt; "Hello World";</pre></div><p class="calibre9">This will output <code class="literal">Hello World</code> to the standard output stream, which is your command prompt or shell in general cases. If we want to make <code class="literal">Hello World</code> translatable, we need to use a <code class="literal">tr()</code> function to enclose the string, as follows:</p><div class="calibre2"><pre class="programlisting">qDebug() &lt;&lt; tr("Hello World");</pre></div><p class="calibre9">Since <code class="literal">tr()</code> is a static public member function of the <code class="literal">QObject</code> class, you can still use it even for a non <code class="literal">QObject</code> class.</p><div class="calibre2"><pre class="programlisting">qDebug() &lt;&lt; QObject::tr("Hello World");</pre></div><p class="calibre9">Then, we need to use the <code class="literal">lupdate</code> command, which is located in <span class="strong"><strong class="calibre10">Tools</strong></span> | <span class="strong"><strong class="calibre10">External</strong></span> | <span class="strong"><strong class="calibre10">Linguist</strong></span> | <span class="strong"><strong class="calibre10">Update Translations (lupdate)</strong></span> in Qt Creator. This will update, or create if the <span class="strong"><strong class="calibre10">translation source</strong></span> (<span class="strong"><strong class="calibre10">TS</strong></span>) file<a id="id380" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> doesn't exist. You can then use Qt Linguist to translate the strings. Before you release<a id="id381" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> your application, run the <code class="literal">lrelease</code> command, which is located in <span class="strong"><strong class="calibre10">Tools</strong></span> | <span class="strong"><strong class="calibre10">External</strong></span> | <span class="strong"><strong class="calibre10">Linguist</strong></span> | <span class="strong"><strong class="calibre10">Release Translations (lrelease)</strong></span>, to generate the <span class="strong"><strong class="calibre10">Qt message</strong></span> (<span class="strong"><strong class="calibre10">QM</strong></span>) files<a id="id382" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> that can be loaded by an application dynamically. Don't worry if it confuses you; we'll use two examples to walk you through these procedures.</p></div></div></div>



  
<div id="sbo-rt-content" class="calibre1"><div class="calibre2" title="Translating Qt Widgets applications"><div class="titlepage"><div class="calibre2"><div class="calibre2"><h1 class="title2"><a id="ch08lvl1sec55" class="calibre7 pcalibre pcalibre3 pcalibre2 pcalibre1"/>Translating Qt Widgets applications</h1></div></div></div><p class="calibre9">First, let's create<a id="id383" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> a new Qt Widget project, whose name is <code class="literal">Internationalization</code>. Then, edit <code class="literal">mainwindow.ui</code> in the <span class="strong"><strong class="calibre10">Design</strong></span> mode.</p><div class="calibre2"><ol class="orderedlist"><li class="listitem1">As usual, remove the status bar, menu bar, and tool bar.</li><li class="listitem1">Add <span class="strong"><strong class="calibre10">Label</strong></span> into <code class="literal">centralWidget</code> and change its object name to <code class="literal">nonTransLabel</code>. Then, change its text to <code class="literal">This is a non-translatable label</code> and uncheck <code class="literal">translatable</code> under <code class="literal">text</code> in <span class="strong"><strong class="calibre10">Property Editor</strong></span>.</li><li class="listitem1">Drag a <span class="strong"><strong class="calibre10">Push Button</strong></span> just beneath <code class="literal">nonTransLabel</code> with <code class="literal">transButton</code> as its object name. Change its text to <code class="literal">This is a translatable button</code>.</li><li class="listitem1">Change <span class="strong"><strong class="calibre10">Lay out</strong></span> to <span class="strong"><strong class="calibre10">Lay Out Vertically</strong></span> in <span class="strong"><strong class="calibre10">MainWindow</strong></span>.</li><li class="listitem1">Resize the frame to a comfortable size.</li></ol></div><p class="calibre9">Go back to editing the <code class="literal">Internationalization.pro</code> project file in the <span class="strong"><strong class="calibre10">Edit</strong></span> mode. Add a line indicating the translation source file, which is shown as follows:</p><div class="calibre2"><pre class="programlisting">TRANSLATIONS = Internationalization_de.ts</pre></div><p class="calibre9">The <code class="literal">_de</code> suffix is a locale code, indicating that this is a German translation source file. The locale codes are defined by<a id="id384" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> <span class="strong"><strong class="calibre10">Internet Engineering Task Force</strong></span> in the <span class="strong"><strong class="calibre10">BCP 47</strong></span> document series. Historically, Qt follows the POSIX definition, which is slightly different from BCP 47. In this, it uses underscores (<code class="literal">_</code>) instead of hyphens (<code class="literal">-</code>) to separate subtags. In other words, Brazilian Portuguese is expressed as <code class="literal">pt_BR</code> instead of <code class="literal">pt-BR</code>. Meanwhile, Qt has provided some APIs to conform the locale name to a BCP 47 definition since the Qt 4.8 version.</p><p class="calibre9">To ensure this change is valid, save the project file and right-click on the project and select <span class="strong"><strong class="calibre10">Run qmake</strong></span>. After this, we can generate the translation source file, which is exactly <code class="literal">Internationalization_de.ts</code>, by executing the <code class="literal">lupdate</code> command. The results will be printed in the <span class="strong"><strong class="calibre10">General Messages</strong></span> panel, which contains the strings added to the TS file, as shown here:</p><div class="calibre2"><pre class="programlisting">Updating 'Internationalization_de.ts'...
Found 3 source text(s) (3 new and 0 already existing)</pre></div><p class="calibre9">Now, open the <code class="literal">Internationalization_de.ts</code> file in Qt Linguist. The overview UI of Qt Linguist is<a id="id385" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> displayed in the following screenshot:</p><div class="mediaobject"><img src="Images/4615OS_08_02.jpg" alt="Translating Qt Widgets applications" class="calibre74"/></div><p class="calibre9">
<span class="strong"><strong class="calibre10">Context</strong></span> lists the source text context, which is the class name in most cases, while <span class="strong"><strong class="calibre10">Strings</strong></span> contains all the translatable strings. <span class="strong"><strong class="calibre10">Sources and Forms</strong></span> displays the corresponding location of the string, either as a piece of code or a UI form. Beneath them is the translation area, which lets you input the translation and comments, if there are any.</p><p class="calibre9">In addition to the overview, the icon in front of each entry is noteworthy. A yellow question mark (<span class="strong"><strong class="calibre10">?</strong></span>) simply means there is no translation currently, while a green checkmark means accepted/correct, and a yellow checkmark stands for accepted/warnings. You may also encounter a red exclamation mark (<span class="strong"><strong class="calibre10">!</strong></span>), which indicates warnings. The sharp symbol (<span class="strong"><strong class="calibre10">#</strong></span>) in front of a button's text in the <span class="strong"><strong class="calibre10">Sources and Forms</strong></span> pane indicates untranslated, and possibly translatable, strings. Qt Linguist checks string translations automatically according to its own algorithm, which means that it may give a false warning. In this case, simply ignore the warning and accept the translation.</p><p class="calibre9">You'll find that the label text isn't among <span class="strong"><strong class="calibre10">Source text</strong></span>. This is because we unchecked the <code class="literal">translatable</code> property. Now, input German translations in the translation area and click on the <span class="strong"><strong class="calibre10">Done and Next</strong></span> button in the tool bar, then navigate to <span class="strong"><strong class="calibre10">Translation</strong></span> | <span class="strong"><strong class="calibre10">Done and Next</strong></span>. Or, even quicker, press <span class="strong"><em class="calibre14">Ctrl</em></span> + <span class="strong"><em class="calibre14">Enter</em></span> to accept the translation. When you've finished, click on the <span class="strong"><strong class="calibre10">Save</strong></span> button, and then exit Qt Linguist.</p><p class="calibre9">Although it's recommended to use Qt Linguist for translation tasks, it's viable to use a normal text editor to <a id="id386" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/>edit the TS file directly. The TS file is XML-formatted and should be supported well by other editors.</p><p class="calibre9">After translating, return to Qt Creator and run the <code class="literal">lrelease</code> command to generate the <code class="literal">Internationalization_de.qm</code> file. At the current stage, your project folder should contain both the TS and QM files, as shown in the following screenshot:</p><div class="mediaobject"><img src="Images/4615OS_08_03.jpg" alt="Translating Qt Widgets applications" class="calibre75"/></div><div class="sidebar" title="Note"><div class="inner"><h3 class="title4"><a id="note27" class="calibre7 pcalibre pcalibre3 pcalibre2 pcalibre1"/>Note</h3><p class="calibre15">Note that file icons may differ slightly on your computers because of different operating system and (or) software installations.</p></div></div><p class="calibre9">We already produced the QM file; it's now time to modify the <code class="literal">main.cpp</code> file in order to load the translation into this application.</p><div class="calibre2"><pre class="programlisting">#include "mainwindow.h"
#include &lt;QApplication&gt;
<span class="strong"><strong class="calibre10">#include &lt;QTranslator&gt;</strong></span>

int main(int argc, char *argv[])
{
  QApplication a(argc, argv);

<span class="strong"><strong class="calibre10">  QTranslator translator;</strong></span>
<span class="strong"><strong class="calibre10">  translator.load(QLocale::German, "Internationalization", "_");</strong></span>
<span class="strong"><strong class="calibre10">  a.installTranslator(&amp;translator);</strong></span>

  MainWindow w;
  w.show();

  return a.exec();
}</pre></div><p class="calibre9">Here, <code class="literal">QTranslator</code> is used to load the German translation. Before we install translator into <code class="literal">QApplication</code>, we have to load a QM file by calling the <code class="literal">load</code> function. This will load the translation<a id="id387" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> file whose filename consists of <code class="literal">Internationalization</code> followed by <code class="literal">_</code> and the UI language name (which is <code class="literal">de</code> in this case) and <code class="literal">.qm</code> (the default value). There is a simplified overloaded <code class="literal">load</code> function. Our equivalent is as follows:</p><div class="calibre2"><pre class="programlisting">translator.load("Internationalization_de");</pre></div><p class="calibre9">Usually, it would be better to call the previous <code class="literal">load</code> function because it uses <code class="literal">QLocale::uiLanguages()</code>, and it will also format dates and numbers if they're necessary for the new locale. Whichever you choose, always remember that if you load the translation after the <code class="literal">MainWindow w;</code> line, <code class="literal">MainWindow</code> won't be able to use the translation at all.</p><p class="calibre9">If you run the application now, the application won't display German yet. Why? This is simply because <code class="literal">QTranslator</code> can't find the <code class="literal">Internationalization_de.qm</code> file. There are lots of ways to solve this problem. The neatest way is to change the working directory, while running the application in Qt Creator.</p><div class="calibre2"><ol class="orderedlist"><li class="listitem1">Switch to the <span class="strong"><strong class="calibre10">Projects</strong></span> mode.</li><li class="listitem1">Switch to <span class="strong"><strong class="calibre10">Run Settings</strong></span>.</li><li class="listitem1">Change <span class="strong"><strong class="calibre10">Working directory</strong></span> to your project source directory where you put the <code class="literal">Internationalization_de.qm</code> file.</li></ol></div><p class="calibre9">Now, run it again; you'll see German text on the screen, as follows:</p><div class="mediaobject"><img src="Images/4615OS_08_04.jpg" alt="Translating Qt Widgets applications" class="calibre76"/></div><p class="calibre9">The label is displayed in English as we expected, whereas the window title and button text are displayed in German.</p><p class="calibre9">You may think this<a id="id388" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> solution pointless, since the German translation is loaded despite the system locale setting. Well, the application can load the translation according to the system locale with only one modification; that is, changing the translator load line to the one shown here:</p><div class="calibre2"><pre class="programlisting">translator.load(QLocale::system().language(), "Internationalization", "_");</pre></div><p class="calibre9">Here, <code class="literal">system()</code> is a static member function of the <code class="literal">QLocale</code> class, which returns a <code class="literal">QLocale</code> object that initialized with the system locale. We then call the <code class="literal">language()</code> function to get the language of the current locale.</p></div></div>



  
<div id="sbo-rt-content" class="calibre1"><div class="calibre2" title="Disambiguating identical texts"><div class="titlepage"><div class="calibre2"><div class="calibre2"><h1 class="title2"><a id="ch08lvl1sec56" class="calibre7 pcalibre pcalibre3 pcalibre2 pcalibre1"/>Disambiguating identical texts</h1></div></div></div><p class="calibre9">If there are identical texts, the default behavior is to treat them as the texts with the same meaning. This<a id="id389" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> could effectively save translators from translating the same texts. Meanwhile, this doesn't hold true all the time. For instance, the word <code class="literal">open</code> can be used as a noun or an adjective, which may be different words in other languages. Thankfully, it's possible and easy to disambiguate identical texts in Qt.</p><p class="calibre9">Now, let's add a <code class="literal">PushButton</code> and <code class="literal">openButton</code> between <code class="literal">transButton</code> and <code class="literal">nonTransLabel</code>. Use <code class="literal">Open</code> as its text, and then edit <code class="literal">mainwindow.h</code>. Add a new private slot named <code class="literal">onOpenButtonClicked()</code>, which is used to handle the event when <code class="literal">openButton</code> gets clicked. The relevant source file, <code class="literal">mainwindow.cpp</code>, is pasted as follows:</p><div class="calibre2"><pre class="programlisting">
<span class="strong"><strong class="calibre10">#include &lt;QMessageBox&gt;</strong></span>
#include "mainwindow.h"
#include "ui_mainwindow.h"

MainWindow::MainWindow(QWidget *parent) :
  QMainWindow(parent),
  ui(new Ui::MainWindow)
{
  ui-&gt;setupUi(this);

<span class="strong"><strong class="calibre10">  connect(ui-&gt;openButton, &amp;QPushButton::clicked, this, &amp;MainWindow::onOpenButtonClicked);</strong></span>
}

MainWindow::~MainWindow()
{
  delete ui;
}

<span class="strong"><strong class="calibre10">void MainWindow::onOpenButtonClicked()</strong></span>
<span class="strong"><strong class="calibre10">{</strong></span>
<span class="strong"><strong class="calibre10">  QMessageBox::information(this, tr("Dialog"), tr("Open"));</strong></span>
<span class="strong"><strong class="calibre10">}</strong></span>
</pre></div><p class="calibre9">First, we connect the clicked signal of <code class="literal">openButton</code> to the <code class="literal">onOpenButtonClicked</code> slot of <code class="literal">MainWindow</code> in the constructor of <code class="literal">MainWindow</code>. Then, we simply use the static member function, <code class="literal">information</code>, of <code class="literal">QMessageBox</code> to pop-up an information dialog, using <code class="literal">Dialog</code> as<a id="id390" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> the title and <code class="literal">Open</code> as its context. Don't forget to use the <code class="literal">tr()</code> function to make these strings translatable.</p><p class="calibre9">Now, run <code class="literal">lupdate</code> and open the TS file in Qt Linguist. There is only one <span class="strong"><strong class="calibre10">Open</strong></span> string in the <span class="strong"><strong class="calibre10">Strings</strong></span> panel, as shown here:</p><div class="mediaobject"><img src="Images/4615OS_08_05.jpg" alt="Disambiguating identical texts" class="calibre77"/></div><p class="calibre9">However, <span class="strong"><strong class="calibre10">Open</strong></span> in the information dialog is supposed to have an adjective, which shouldn't be mixed<a id="id391" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> up with the text in <code class="literal">openButton</code>. It's a comment that we need to separate this <span class="strong"><strong class="calibre10">Open</strong></span> from the other <code class="literal">Open</code>. Modify the <code class="literal">onOpenButtonClicked</code> function in <code class="literal">mainwindow.cpp</code>:</p><div class="calibre2"><pre class="programlisting">void MainWindow::onOpenButtonClicked()
{
  QMessageBox::information(this, tr("Dialog"), tr("Open", <span class="strong"><strong class="calibre10">"adj.</strong></span>"));
}</pre></div><p class="calibre9">Here, the second argument of the <code class="literal">tr()</code> function is the comment. Different comments stand for different texts. In this way, <code class="literal">lupdate</code> will treat them as nonidentical texts. Rerun <code class="literal">lupdate</code>, and you're able to translate two <code class="literal">Open</code> strings in Qt Linguist. The <span class="strong"><strong class="calibre10">Developer comments</strong></span> column in the translation area is shown here. Qt Linguist will also show two translatable <code class="literal">Open</code> strings.</p><div class="mediaobject"><img src="Images/4615OS_08_06.jpg" alt="Disambiguating identical texts" class="calibre78"/></div><p class="calibre9">The equivalent property in the <span class="strong"><strong class="calibre10">Design</strong></span> mode for <code class="literal">openButton</code> is disambiguation under the <code class="literal">text</code> property. After<a id="id392" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> translation, execute <code class="literal">lrelease</code>, and then rerun the application and the two <code class="literal">Open</code> strings should have two different translations, which is demonstrated here:</p><div class="mediaobject"><img src="Images/4615OS_08_07.jpg" alt="Disambiguating identical texts" class="calibre79"/></div></div></div>



  
<div id="sbo-rt-content" class="calibre1"><div class="calibre2" title="Changing languages dynamically"><div class="titlepage"><div class="calibre2"><div class="calibre2"><h1 class="title2"><a id="ch08lvl1sec57" class="calibre7 pcalibre pcalibre3 pcalibre2 pcalibre1"/>Changing languages dynamically</h1></div></div></div><p class="calibre9">Sometimes, people <a id="id393" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/>want to use languages other than the one specified by the system locale. This is a matter of application of the customized settings. This usually means restarting the application in order to load the corresponding translation file. This is partly because changing the language dynamically requires additional work. However, it's feasible and can be done with some lines. What's more important is that it delivers a better user experience!</p><p class="calibre9">Let's add a new <code class="literal">push</code> button to <code class="literal">MainWindow</code>. Name it <code class="literal">loadButton</code> and change its text to <code class="literal">Load/Unload Translation</code>. Then, edit the <code class="literal">main.cpp</code> file in the <span class="strong"><strong class="calibre10">Edit</strong></span> mode. Remove all <code class="literal">QTranslator</code> related lines, as we'll be implementing this dynamic language switch in the <code class="literal">MainWindow</code> class. The <code class="literal">main.cpp</code> file should look like the originally generated one as follows:</p><div class="calibre2"><pre class="programlisting">#include "mainwindow.h"
#include &lt;QApplication&gt;

int main(int argc, char *argv[])
{
  QApplication a(argc, argv);
  MainWindow w;
  w.show();

  return a.exec();
}</pre></div><p class="calibre9">Now, edit <code class="literal">mainwindow.h</code>, as we need to<a id="id394" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> declare some members here:</p><div class="calibre2"><pre class="programlisting">#ifndef MAINWINDOW_H
#define MAINWINDOW_H

#include &lt;QMainWindow&gt;
<span class="strong"><strong class="calibre10">#include &lt;QTranslator&gt;</strong></span>

namespace Ui {
class MainWindow;
}

class MainWindow : public QMainWindow
{
  Q_OBJECT

public:
  explicit MainWindow(QWidget *parent = 0);
  ~MainWindow();

private:
  Ui::MainWindow *ui;
<span class="strong"><strong class="calibre10">  QTranslator *deTranslator;</strong></span>
<span class="strong"><strong class="calibre10">  bool deLoaded;</strong></span>

private slots:
  void onOpenButtonClicked();
<span class="strong"><strong class="calibre10">  void onLoadButtonClicked();</strong></span>

<span class="strong"><strong class="calibre10">protected:</strong></span>
<span class="strong"><strong class="calibre10">  void changeEvent(QEvent *);</strong></span>
};

#endif // MAINWINDOW_H</pre></div><p class="calibre9">As you can tell, we moved <code class="literal">QTranslator</code> here, named it <code class="literal">deTranslator</code>, and used it as a pointer with the <code class="literal">deLoaded</code> variable to suggest whether or not we've already loaded the German translation. The following <code class="literal">onLoadButtonClicked</code> is a <code class="literal">private</code> slot function, which will be connected to the<a id="id395" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> clicked signal of <code class="literal">loadButton</code>. Last but not least, we reimplement <code class="literal">changeEvent</code>, so that we can translate the entire user interface on the fly. It'll be clear in the <code class="literal">mainwindow.cpp</code> source file, where it is pasted as follows:</p><div class="calibre2"><pre class="programlisting">#include &lt;QMessageBox&gt;
#include "mainwindow.h"
#include "ui_mainwindow.h"

MainWindow::MainWindow(QWidget *parent) :
  QMainWindow(parent),
  ui(new Ui::MainWindow)
{
  ui-&gt;setupUi(this);

  deTranslator = new QTranslator(this);
  deTranslator-&gt;load(QLocale::German, "Internationalization", "_");
  deLoaded = false;

  connect(ui-&gt;openButton, &amp;QPushButton::clicked, this, &amp;MainWindow::onOpenButtonClicked);
  connect(ui-&gt;loadButton, &amp;QPushButton::clicked, this, &amp;MainWindow::onLoadButtonClicked);
}

MainWindow::~MainWindow()
{
  delete ui;
}

void MainWindow::onOpenButtonClicked()
{
  QMessageBox::information(this, tr("Dialog"), tr("Open", "adj."));
}

<span class="strong"><strong class="calibre10">void MainWindow::onLoadButtonClicked()</strong></span>
<span class="strong"><strong class="calibre10">{</strong></span>
<span class="strong"><strong class="calibre10">  if (deLoaded) {</strong></span>
<span class="strong"><strong class="calibre10">    deLoaded = false;</strong></span>
<span class="strong"><strong class="calibre10">    qApp-&gt;removeTranslator(deTranslator);</strong></span>
<span class="strong"><strong class="calibre10">  }</strong></span>
<span class="strong"><strong class="calibre10">  else {</strong></span>
<span class="strong"><strong class="calibre10">    deLoaded = true;</strong></span>
<span class="strong"><strong class="calibre10">    qApp-&gt;installTranslator(deTranslator);</strong></span>
<span class="strong"><strong class="calibre10">  }</strong></span>
<span class="strong"><strong class="calibre10">}</strong></span>

<span class="strong"><strong class="calibre10">void MainWindow::changeEvent(QEvent *e)</strong></span>
<span class="strong"><strong class="calibre10">{</strong></span>
<span class="strong"><strong class="calibre10">  if (e-&gt;type() == QEvent::LanguageChange) {</strong></span>
<span class="strong"><strong class="calibre10">    ui-&gt;retranslateUi(this);</strong></span>
<span class="strong"><strong class="calibre10">  }</strong></span>
<span class="strong"><strong class="calibre10">  else {</strong></span>
<span class="strong"><strong class="calibre10">    QMainWindow::changeEvent(e);</strong></span>
<span class="strong"><strong class="calibre10">  }</strong></span>
<span class="strong"><strong class="calibre10">}</strong></span>
</pre></div><p class="calibre9">In the constructor, we initialize <code class="literal">deTranslator</code> and load the German translation, which is almost identical to what we did in <code class="literal">main.cpp</code> before. Then, we set <code class="literal">deLoaded</code> to <code class="literal">false</code>, indicating that the<a id="id396" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> German translation is not installed yet. Next, this is followed by a <code class="literal">connect</code> statement.</p><p class="calibre9">Now, let's look into the <code class="literal">onLoadButtonClicked</code> function to see what will happen if the <code class="literal">loadButton</code> gets clicked. We set <code class="literal">deLoaded</code> to <code class="literal">false</code> and remove <code class="literal">deTranslator</code> if it's already loaded. Otherwise, we install <code class="literal">deTranslator</code> and set <code class="literal">deLoaded</code> to <code class="literal">true</code>. Remember that <code class="literal">qApp</code> is a predefined macro that simply refers to the current instance of <code class="literal">QCoreApplication</code>. Both <code class="literal">installTranslator</code> and <code class="literal">removeTranslator</code> will propagate the event to all the top-level windows, that is to say, <code class="literal">changeEvent</code> of <code class="literal">MainWindow</code> will be triggered in this case.</p><p class="calibre9">In order to update all the text according to the translator, we have to <code class="literal">reimplement</code> <code class="literal">changeEvent</code>. In this<a id="id397" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> <code class="literal">reimplemented</code> function, we call the <code class="literal">retranslateUi</code> function to retranslate <code class="literal">MainWindow</code> if the event is <code class="literal">languageChange</code>. Otherwise, we simply call the inherited and default <code class="literal">QMainWindow::changeEvent</code> function.</p><p class="calibre9">When you firstly start the application, it'll display English text.</p><div class="mediaobject"><img src="Images/4615OS_08_08.jpg" alt="Changing languages dynamically" class="calibre80"/></div><p class="calibre9">Once you<a id="id398" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> click on the <span class="strong"><strong class="calibre10">Load/Unload Translation</strong></span> button, all translatable and translated text will show in German.</p><div class="mediaobject"><img src="Images/4615OS_08_09.jpg" alt="Changing languages dynamically" class="calibre80"/></div><p class="calibre9">It'll display in English if you click the button again. In addition to a nontranslatable label, <code class="literal">loadButton</code> will not be not translated either. This is because we didn't translate the button at all. However, as you can see, the lack of some translations won't prevent the application from loading other translated texts.</p></div></div>



  
<div id="sbo-rt-content" class="calibre1"><div class="calibre2" title="Translating Qt Quick applications"><div class="titlepage"><div class="calibre2"><div class="calibre2"><h1 class="title2"><a id="ch08lvl1sec58" class="calibre7 pcalibre pcalibre3 pcalibre2 pcalibre1"/>Translating Qt Quick applications</h1></div></div></div><p class="calibre9">The procedure <a id="id399" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/>of translating a Qt Quick application is similar to a Qt Widgets application. We'll walk through the process with another example application.</p><p class="calibre9">Create a new Qt Quick application project and name it <code class="literal">Internationalization_QML</code>. The generated <code class="literal">main.qml</code> file has already added a<a id="id400" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> <code class="literal">qsTr()</code> function for us. The contents may differ slightly in a later version of Qt Creator and (or) Qt Library. However, it should look similar to this one:</p><div class="calibre2"><pre class="programlisting">import QtQuick 2.3
import QtQuick.Controls 1.2

ApplicationWindow {
  visible: true
  width: 640
  height: 480
  title: qsTr("Hello World")

  menuBar: MenuBar {
    Menu {
      title: qsTr("File")
      MenuItem {
        text: qsTr("&amp;Open")
        onTriggered: console.log("Open action triggered");
      }
      MenuItem {
        text: qsTr("Exit")
        onTriggered: Qt.quit();
      }
    }
  }

  Text {
    text: qsTr("Hello World")
    anchors.centerIn: parent
  }
}</pre></div><p class="calibre9">Now, let's edit<a id="id401" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> the <code class="literal">Internationalization_QML.pro</code> project file, whose modified version is pasted as follows:</p><div class="calibre2"><pre class="programlisting">TEMPLATE = app

QT += qml quick widgets

SOURCES += main.cpp

RESOURCES += qml.qrc

<span class="strong"><strong class="calibre10">lupdate_only {</strong></span>
<span class="strong"><strong class="calibre10">  SOURCES += main.qml</strong></span>
<span class="strong"><strong class="calibre10">}</strong></span>

<span class="strong"><strong class="calibre10">TRANSLATIONS = Internationalization_QML_de.ts</strong></span>

# Additional import path used to resolve QML modules in Qt 
# Creator's code model
QML_IMPORT_PATH =

# Default rules for deployment.
include(deployment.pri)</pre></div><p class="calibre9">In addition to the <code class="literal">TRANSLATIONS</code> line, we also add a <code class="literal">lupdate_only</code> block. It is crucial in this case.</p><div class="sidebar" title="Note"><div class="inner"><h3 class="title4"><a id="note28" class="calibre7 pcalibre pcalibre3 pcalibre2 pcalibre1"/>Note</h3><p class="calibre15">We probably don't need this block in the Qt/C++ projects because the <code class="literal">lupdate</code> tool extracts the translatable strings from <code class="literal">SOURCES</code>, <code class="literal">HEADERS</code>, and <code class="literal">FORMS</code>.</p></div></div><p class="calibre9">However, this<a id="id402" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> means that all the strings located elsewhere won't be found, not even saying translating. On the other hand, the <code class="literal">qml</code> files are not the C++ source files that are going to be compiled by the C++ compiler. In this case, we use <code class="literal">lupdate_only</code> to restrict those <code class="literal">SOURCES</code>, which are only available for <code class="literal">lupdate</code>.</p><p class="calibre9">Now, executing <code class="literal">lupdate</code> can generate the translation source file for us. Similarly, we use Qt Linguist to translate the <code class="literal">Internationalization_QML_de.ts</code> file. Then, execute <code class="literal">lrelease</code> to generate the QM file.</p><p class="calibre9">To load the translation, we need to modify <code class="literal">main.cpp</code> into the one shown here:</p><div class="calibre2"><pre class="programlisting">#include &lt;QApplication&gt;
#include &lt;QQmlApplicationEngine&gt;
<span class="strong"><strong class="calibre10">#include &lt;QTranslator&gt;</strong></span>

int main(int argc, char *argv[])
{
  QApplication app(argc, argv);

<span class="strong"><strong class="calibre10">  QTranslator translator;</strong></span>
<span class="strong"><strong class="calibre10">  translator.load(QLocale::German, "Internationalization_QML", "_");</strong></span>
<span class="strong"><strong class="calibre10">  app.installTranslator(&amp;translator);</strong></span>

  QQmlApplicationEngine engine;
  engine.load(QUrl(QStringLiteral("qrc:/main.qml")));

  return app.exec();
}</pre></div><p class="calibre9">Also, we need to change <span class="strong"><strong class="calibre10">Working directory</strong></span> to this project's directory in <span class="strong"><strong class="calibre10">Run Settings</strong></span> in the <span class="strong"><strong class="calibre10">Projects</strong></span> mode. Now, run the application again; we should be able to see German text on the <a id="id403" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/>screen, as we can in the following screenshot:</p><div class="mediaobject"><img src="Images/4615OS_08_10.jpg" alt="Translating Qt Quick applications" class="calibre21"/></div><p class="calibre9">There is an alternative way to load the translations file, which doesn't need to change <span class="strong"><strong class="calibre10">Working directory</strong></span>. Firstly, change the <code class="literal">translator.load</code> line in <code class="literal">main.cpp</code> to the following one:</p><div class="calibre2"><pre class="programlisting">translator.load(QLocale::German, "Internationalization_QML", "_<span class="strong"><strong class="calibre10">", ":/</strong></span>");</pre></div><p class="calibre9">We specify the directory that the translator should search. In this case, it's <code class="literal">":/"</code>, which is the top directory inside <span class="strong"><strong class="calibre10">Resources</strong></span>. Please don't prepend <code class="literal">qrc</code> to the directory string; this will cause <code class="literal">translator</code> to be unable to find the QM file. A colon (<code class="literal">:</code>) is sufficient here to indicate that there is a <code class="literal">qrc</code> path inside <span class="strong"><strong class="calibre10">Resources</strong></span>.</p><p class="calibre9">You can either create a new <code class="literal">qrc</code> file, or similar to what we do, add <code class="literal">Internationalization_QML_de.qm</code> to the current <code class="literal">qml.qrc</code> file.</p><div class="calibre2"><ol class="orderedlist"><li class="listitem1">Right-click on the <code class="literal">qml.qrc</code> file under <span class="strong"><strong class="calibre10">Resources</strong></span> in <span class="strong"><strong class="calibre10">Projects Editor</strong></span>.</li><li class="listitem1">Select <span class="strong"><strong class="calibre10">Open</strong></span> in <span class="strong"><strong class="calibre10">Editor</strong></span>.</li><li class="listitem1">Navigate to <span class="strong"><strong class="calibre10">Add</strong></span> | <span class="strong"><strong class="calibre10">Add Files</strong></span> on the lower-right panel.</li><li class="listitem1">Select the <code class="literal">Internationalization_QML_de.qm</code> file and click on <span class="strong"><strong class="calibre10">Open</strong></span>.</li></ol></div><p class="calibre9">Now, the <code class="literal">Internationalization_QML_de.qm</code> file should display on both <span class="strong"><strong class="calibre10">Editor</strong></span> and the <span class="strong"><strong class="calibre10">Projects</strong></span> tree<a id="id404" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> like the following screenshot:</p><div class="mediaobject"><img src="Images/4615OS_08_11.jpg" alt="Translating Qt Quick applications" class="calibre81"/></div><p class="calibre9">Go to the <span class="strong"><strong class="calibre10">Projects</strong></span> mode and reset <span class="strong"><strong class="calibre10">Working directory</strong></span> in <span class="strong"><strong class="calibre10">Run Settings</strong></span>. Then, run the application again; the German translation should still load successfully.</p><p class="calibre9">So far, there is no huge difference between Qt and Qt Quick. However, it's tedious to achieve dynamic translation installation and removal in Qt Quick. You have to write a C++ class that installs and remove the translator, which then emits a signal indicating that there is a change to<a id="id405" class="calibre4 pcalibre3 pcalibre pcalibre1 pcalibre2"/> the text. Therefore, the best practice for the Qt Quick application is to make language a setting. The user can then load different translations. It needs a restart of the application, though.</p></div></div>



  
<div id="sbo-rt-content" class="calibre1"><div class="calibre2" title="Summary"><div class="titlepage"><div class="calibre2"><div class="calibre2"><h1 class="title2"><a id="ch08lvl1sec59" class="calibre7 pcalibre pcalibre3 pcalibre2 pcalibre1"/>Summary</h1></div></div></div><p class="calibre9">You're now able to make your application more competitive by adding support for other languages now. Besides, the super easy to use Qt Linguist, which is also a cross-platform tool provided by Qt, is also covered in this chapter. In addition to the skills you learnt, you can also tell that Qt/C++ still holds a great advantage over Qt Quick/QML in terms of APIs and features.</p><p class="calibre9">In the next chapter, we're going to make our Qt applications redistributable and deploy them on other devices.</p></div></div>



  </body></html>