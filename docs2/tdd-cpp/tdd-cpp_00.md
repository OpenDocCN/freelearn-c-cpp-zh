# 前言

多年前，当我想要学习一种新技术或开发一项新技能时，我开始避免使用食谱风格的书籍。一本书应该引导我们理解基本概念，以便我们能够调整学习以适应我们的需求。我们不应该因为一个食谱与我们的目标不完全匹配而迷失方向。

我也倾向于避免那些充满理论的书籍。你可能知道我的意思。这些书籍不是解释如何使用一种技术，而是提到了一些想法，但没有探讨将这些想法付诸实践的方法。专注于这两方面的任何一个都可能使学习体验不完整。

这本书与众不同。它不会像食谱一样给你几个简单的例子，也不会一味地讲述规则和定义，而是会向你展示如何使用测试来编写执行以下任务的软件：

+   用户期望的，并且轻松实现

+   让你能够添加新功能而不会破坏你已完成的工作

+   清晰地传达代码的功能

我们将从零开始构建多个项目。你将通过构建一个简单且自然的 C++测试编写方式来学习测试是什么以及它如何帮助。这被称为**测试驱动开发（TDD**），你将使用 TDD 来开发项目所需的各种工具。

为了从测试驱动开发（TDD）中获得最大益处，你需要一种编写和运行测试的方法。一些编程语言已经支持 TDD，而 C++则需要额外的工具和库来支持测试。我本可以简单地解释如何使用现有的各种 TDD 工具。那将是一种食谱式的方法，因为每个现有解决方案都有细微的差别。从零开始构建你需要的东西，你将学习 TDD，同时你也会了解所有其他解决方案是如何工作的。概念是相同的。

例如，大多数学习开车的人都能驾驶皮卡或面包车。一些细微的差异是可以预料的，但概念是相同的。骑摩托车可能更具挑战性，但许多相同的概念仍然有效。驾驶公交车可能需要一些额外的培训，但也是相似的。

如果你决定使用其他工具或甚至其他语言，通过遵循本书中的步骤，你将深入了解那些其他工具是如何工作的。其他工具就像驾驶皮卡一样。

本书分为三部分。在第一部分，你将构建一个测试库，这将让你能够编写和运行测试。你将学习如何一步一步地进行，让测试引导你。

第二部分将使用测试库开始一个新的项目，帮助你记录软件运行时的消息。这是一个日志库，这个项目将向你展示如何构建满足目标客户需求的软件。你将向日志库添加许多功能，你将学习如何在开发更多功能的同时保持一切正常运行。

日志库的目标客户是 C++微服务开发者，这种客户焦点延伸到第三部分，在那里你将扩展测试库并构建一个简单的服务。该服务将用于解释软件开发中最困难的一个方面：如何测试多线程。

三部分将结合起来向你展示如何使用 TDD 有效地设计和编写满足客户需求的软件，让你有信心进行更改，并让其他团队成员理解设计。

# 这本书面向的对象

这本书是为那些已经熟悉并使用 C++进行日常任务的 C++开发者所写。你不需要是专家，但你应该已经了解一些现代 C++以及如何使用模板来充分利用这本书。

如果你曾经努力向大型项目添加新功能，而没有在其他地方破坏软件，那么这本书可以帮助你。你将成为一名更好的软件开发者，避免修复错误或进行设计更改的压力和担忧。TDD 是一种指导你创建直观设计的过程，用户将理解并享受这些设计。

如果你曾经犹豫过是否进行改进，并决定保留过时且令人困惑的设计，因为担心它可能会出错，那么这本书可以帮助你。也许你有一个好主意，但你知道你的经理永远不会同意，因为风险太高。如果你的项目遵循这本书解释的 TDD 实践，那么你可以更有信心地进行改进。你可以让测试证明你的想法是可靠的。

你是否有新团队成员需要快速了解你的软件是如何工作的？这本书探讨的过程将帮助你编写 TDD 测试，以记录软件设计和需求。你甚至可能会发现，测试有助于你自己的理解，尤其是在返回长时间未参与的项目时。

C++是一种功能强大且需要考虑很多细节的语言。这本书通过 TDD 帮助简化软件开发过程。即使你已经知道如何使用一个或多个 TDD 工具，这本书也会提高你的技能，并让你有信心在更高级或更大的项目中应用 TDD。

# 这本书涵盖的内容

*第一章*，*期望的测试声明*，从空项目开始使用 C++编写你的第一个测试。

*第二章*，*测试结果*，报告并使用测试结果，以便你可以快速了解项目的哪些部分正在工作，哪些部分正在失败。

*第三章*，*TDD 过程*，通过识别你已经一直在做的步骤，有目的地使用 TDD。

*第四章*，*向项目中添加测试*，通过判断你的期望是否得到满足来增强测试的通过或失败。

*第五章*，*添加更多确认类型*，通过赋予你检查任何值类型是否满足预期的能力，使测试更加高效。

*第六章*，*早期探索改进*，寻找其他改进，并展示你如何退后一步探索你可能之前没有考虑过的想法。

*第七章*，*测试设置和清理*，准备测试运行并在之后进行清理，这样你可以将注意力集中在测试需要做什么上，这有助于使测试更容易理解。

*第八章*，*什么是一个好的测试？*，提供了来自其他章节的建议和学习，以巩固你所学的内容，并鼓励你通过后续章节中主题的暗示继续学习。

*第九章*，*使用测试*，构建了一个日志库，将你迄今为止所学的一切应用到实际中。

*第十章*，*深入理解 TDD 过程*，通过使用 TDD 向增长的项目添加功能，包括如何处理设计变更进行实践。

*第十一章*，*管理依赖项*，添加了可交换的功能，展示了如何测试不可靠的软件组件，以及在没有所有必需组件的情况下如何取得进展。

*第十二章*，*创建更好的测试确认*，使用 Hamcrest 匹配器通过让你更自然地验证预期来改进测试。

*第十三章*，*如何测试浮点数和自定义值*，展示了如何可靠地使用浮点数，以及如何扩展 Hamcrest 匹配器以满足自定义需求。

*第十四章*，*如何测试服务*，涵盖了服务如何不同以及如何测试服务。

*第十五章*，*如何使用多线程进行测试*，简化并协调多线程测试，以便你在测试每个可能的线程交互时能够可靠且可预测地避免竞态条件。

# 要充分利用这本书

你需要一个能够构建 C++20 或更高版本代码的现代 C++编译器。本书中的所有内容都使用标准 C++，并且可以在任何计算机上运行。所有输出都是文本。

这本书允许你使用你最舒适的构建系统来构建代码。项目文件数量很少，文件夹结构简单。你可以在代码编辑器中轻松创建项目并跟随。

这本书不描述完成的项目。每个项目都是一段旅程。第一章从空项目开始，后续的每一章都会在前一章的基础上添加代码。鼓励你跟随这个过程。

记住要学习这个过程。这比每一章解释的实际代码更重要。本书多次提到了 TDD（测试驱动开发）的过程。前几章向您介绍了 TDD，直到测试库中有足够的功能，以便可以使用测试库构建另一个项目。第二个日志库项目更深入和详细地探讨了 TDD 的过程。一旦日志库可用，就可以使用测试和日志库来构建一个简单的服务项目。TDD 的过程中有一个重复的模式。通过每个项目学习 TDD 过程将给您带来最大的收益。

因为项目是逐步构建的，您也可以从沿途解释的错误中受益。有时，设计会发生变化，您也可以从变化的原因中受益，以及学习如何管理变化。

当我说您需要一个 C++20 编译器时，这是一个简化。编译器供应商在其编译器的不同版本中支持 C++ 的许多不同功能。一个很好的规则是确保您的编译器支持 C++20 的 *概念*。我们在本书的最后几章使用了概念，如果您的编译器支持概念，那么您应该拥有您所需的一切。一个很好的阅读链接是：

[`en.cppreference.com/w/cpp/compiler_support`](https://en.cppreference.com/w/cpp/compiler_support)

当您访问链接时，滚动到 C++20 部分，寻找标识概念功能的行。在撰写本文时，以下编译器应该可以工作：

+   GCC 版本 10

+   Clang 版本 10

+   MSVC 版本 19.30

+   Apple Clang 版本 12（然而，这个编译器只有部分实现）

您可能会使用与您的编译器一起提供的任何版本的 C++ 标准库。然而，另一个应该适用的好规则是确保您的标准库也支持概念。在撰写本文时，以下标准库应该可以工作：

+   GCClibstdc++ 版本 10

+   Clang libc++ 版本 13

+   MSVC STL 版本 19.23

+   Apple Clang 版本 13.1.6

**如果您使用的是本书的数字版，我们建议您亲自输入代码或从本书的 GitHub 仓库（下一节中提供链接）获取代码。这样做将帮助您避免与代码复制粘贴相关的任何潜在错误。**

# 下载示例代码文件

您可以从 GitHub（[`github.com/PacktPublishing/Test-Driven-Development-with-CPP`](https://github.com/PacktPublishing/Test-Driven-Development-with-CPP)）下载本书的示例代码文件。如果代码有更新，它将在 GitHub 仓库中更新。

我们还有其他来自我们丰富图书和视频目录的代码包，可在 [`github.com/PacktPublishing/`](https://github.com/PacktPublishing/) 获取。查看它们吧！

# 使用的约定

本书使用了多种文本约定。

`文本中的代码`：表示文本中的代码单词、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟 URL、用户输入和 Twitter 昵称。以下是一个示例：“这就是为什么我们现在的确认宏被称为`CONFIRM_TRUE`和`CONFIRM_FALSE`。”

代码块应如下设置：

```cpp
TEST("Test bool confirms")
{
    bool result = isNegative(0);
    CONFIRM_FALSE(result);
    result = isNegative(-1);
    CONFIRM_TRUE(result);
}
```

任何命令行输入或输出都应如下所示：

```cpp
Running 3 tests
---------------
Test can be created
Passed
---------------
Test with throw can be created
Passed
---------------
Test that never throws can be created
Failed
Expected exception type int was not thrown.
---------------
Tests passed: 2
Tests failed: 1
Program ended with exit code: 1
```

**粗体**：表示新术语、重要单词或你在屏幕上看到的单词。例如，菜单或对话框中的单词以**粗体**显示。以下是一个示例：“我们将只将状态从**失败**更改为**预期失败**。”

提示或重要注意事项

它看起来像这样。

# 联系我们

我们始终欢迎读者的反馈。

**一般反馈**：如果你对本书的任何方面有疑问，请通过电子邮件发送至 customercare@packtpub.com，并在邮件主题中提及书名。

**勘误表**：尽管我们已经尽一切努力确保内容的准确性，但错误仍然可能发生。如果你在这本书中发现了错误，我们非常感谢你向我们报告。请访问 [www.packtpub.com/support/errata](http://www.packtpub.com/support/errata) 并填写表格。

**盗版**：如果你在互联网上遇到我们作品的任何形式的非法副本，我们非常感谢你提供位置地址或网站名称。请通过电子邮件发送至 copyright@packt.com 并附上材料的链接。

**如果你有兴趣成为作者**：如果你在某个领域有专业知识，并且你感兴趣的是撰写或为书籍做出贡献，请访问 [authors.packtpub.com](http://authors.packtpub.com)。

# 分享你的想法

一旦你阅读了《使用 C++进行测试驱动开发》，我们很乐意听听你的想法！请[点击此处直接进入此书的亚马逊评论页面](https://packt.link/r/1803242000)并分享你的反馈。

你的评论对我们和科技社区都很重要，并将帮助我们确保我们提供高质量的内容。

# 下载此书的免费 PDF 副本

感谢您购买此书！

你喜欢在旅途中阅读，但无法随身携带你的印刷书籍吗？你的电子书购买是否与你的选择设备不兼容？

不要担心，现在，每当你购买 Packt 书籍时，你都可以免费获得该书的 DRM 免费 PDF 版本。

在任何地方、任何设备上阅读。直接从你最喜欢的技术书籍中搜索、复制和粘贴代码到你的应用程序中。

优惠不会就此结束，你还可以获得独家折扣、时事通讯和每日免费内容的每日电子邮件。

按照以下简单步骤获取这些好处：

1.  扫描二维码或访问下面的链接

![](https://packt.link/free-ebook/9781803242002)

[`packt.link/free-ebook/9781803242002`](https://packt.link/free-ebook/9781803242002)

1.  提交您的购买证明

1.  就这些！我们将直接将您的免费 PDF 和其他福利发送到您的电子邮件

# 第一部分：测试最小可行产品

本书分为三个部分。在这个第一部分，您将了解测试驱动开发的重要性以及如何使用它来帮助您设计和编写软件。我们将从一个空项目开始，并使用测试驱动开发实践来设计和构建单元测试库。通过跟随我们的探索和逐步构建一个可工作的项目，您将学习到您需要了解的一切。

以下章节将在本部分介绍：

+   *第一章*, *期望的测试声明*

+   *第二章*, *测试结果*

+   *第三章*, *TDD 过程*

+   *第四章*, *将测试添加到项目中*

+   *第五章*, *添加更多确认类型*

+   *第六章*, *早期探索改进*

+   *第七章*, *测试设置和拆卸*

+   *第八章*, *什么是一个好的测试？*
