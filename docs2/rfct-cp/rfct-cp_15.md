

# 第十五章：代码审查

在本书的前几章中，我们已经系统地探索了一系列旨在提高我们 C++代码质量的自动化解决方案。这包括采用清晰的命名约定、利用现代 C++特性、严格实施单元和端到端测试、维护干净的提交和消息，以及有效使用调试技术，如 git bisect 等。这些实践中的每一项都是我们编写稳健、可维护软件工具箱中的关键组成部分。

然而，尽管这些自动化工具和方法提供了实质性的好处，但它们并非完美无缺。它们依赖于正确和一致的实施，并且如果没有勤勉的监督，标准很容易下滑，错误就会悄悄地进入我们的代码库。这就是代码审查的关键作用所在。一个能够理解上下文和细微差别的人类视角对于确保所有这些自动化实践被正确和有效地应用是必不可少的。

在本章中，我们将深入探讨代码审查的实践，这是开发过程中不可或缺的一部分，有助于防止任何机器都无法完全检测到的疏忽。我们将讨论代码审查如何不仅预防潜在的 bug 和提升代码质量，而且培养开发人员之间的学习与合作文化。通过全面探索有效的策略和实际指南，我们旨在为您提供实施稳健代码审查的知识，这对您 C++项目的成功和可靠性有重大贡献。

# 什么是代码审查以及为什么需要它？

我们今天所理解的代码审查实践起源于 Michael Fagan，他在 20 世纪 70 年代中期开发了软件检查的正式流程。当时，软件工程通常是一种独立的活动，个人开发者作为孤独的牛仔，负责编写、测试和审查自己的代码。这种方法导致了项目之间标准的不一致，以及被忽视的错误发生率更高，因为个人的偏见和盲点没有得到检查。

认识到这种独立方法的局限性，Fagan 引入了一种结构化的方法来系统地检查软件。他的流程不仅旨在发现错误，还旨在检查软件的整体设计和实现。这种转变标志着软件开发的一个重大进步，强调了协作、细致的审查和共同的责任。通过涉及多个审查者，Fagan 的方法为评估过程带来了不同的视角，增强了审查的细致程度和软件的整体质量。

# 代码审查的好处

代码审查通过确保软件的设计与项目的架构标准和 C++的最佳实践保持一致，显著提高了代码的整体质量。这些审查对于强制执行编码标准和惯例至关重要，从而培养出一个对新老团队成员来说都更加统一且易于理解的代码库。此外，它们通过促进对代码复杂部分的讨论和阐明特定方法背后的理由，有助于保持代码的高可理解性。例如，考虑一个开发者使用了虽然功能正常但难以理解和维护的非传统循环结构的情况。在代码审查过程中，这些问题可以被揭露，并可能提出使用标准 STL 算法重构代码的建议。这不仅简化了代码，还确保了与现代 C++实践的兼容性，提高了可读性和可维护性。

同行评审是在错误进入生产之前捕捉错误的最有效方法之一。总是有另一双眼睛检查代码以寻找错误更好，无论是逻辑错误还是语言使用不当。审阅者可以识别逻辑错误、边界错误、内存泄漏和其他可能对原始作者不是立即明显的常见 C++陷阱。此外，在代码审查过程中对单元测试中的测试用例进行彻底审查同样至关重要。这种做法确保测试覆盖了足够的场景，并在早期阶段捕捉到潜在的错误，从而提高了软件的可靠性和健壮性。例如，开发者可能忘记释放函数中分配的内存，这可能导致内存泄漏。审阅此代码的同行可能会注意到这一疏忽，并建议使用智能指针自动管理内存生命周期，从而在软件进一步开发周期之前有效预防此类问题。

代码审查作为一项教育工具，对作者和审查者都有益，因为它在团队中传播领域知识，并增强对代码库的熟悉度。这一知识转移方面对于确保所有团队成员保持一致并能够有效贡献至关重要。例如，一个初级开发者最初可能会使用原始指针来管理资源，这是一种常见的做法，但容易出错，如内存泄漏和指针相关错误。在代码审查过程中，经验更丰富的开发者可以通过介绍智能指针来指导初级开发者。通过解释智能指针的优势，如自动内存管理和改进的安全性，资深开发者不仅帮助纠正了即时问题，还帮助初级开发者成长，并加深了对现代 C++实践的理解。此外，代码审查为审查者提供了一个独特的机会，以深化对项目特定功能的理解。当他们评估同行的作品时，审查者可以深入了解新的功能和应用复杂区域。这种增强的理解使他们具备了解决未来错误或在这些特定区域实施改进所需的知识。本质上，通过审查他人的代码，审查者不仅为项目的即时改进做出了贡献，还为自己在将来维护和扩展项目功能做好了准备。

互负责任是团队内定期进行代码审查的关键好处。随着团队成员持续审查彼此的工作，他们培养了一种强烈的共同责任感和责任感。这种集体监督鼓励每个成员在编码工作中保持高标准和彻底性。例如，意识到他们的同行将审查他们的代码，会激励开发者最初编写更干净、更高效的代码。这种对编码质量的主动方法减少了未来大规模重写的可能性，简化了开发过程，并提高了整体生产力。

代码审查经常催化出比最初实现更高效、更优雅或更简单的解决方案的讨论。代码审查的这一方面尤其有价值，因为它利用了团队的集体专业知识和经验，从而提升了整体软件设计。例如，考虑一个开发者以低效的方式实现了一个排序向量的函数。在代码审查过程中，另一位团队成员可能会注意到这种低效，并提出一个更有效的排序算法，或者建议利用标准库中的现有工具。这样的建议不仅提高了性能，还简化了代码，减少了复杂性和潜在的错误，从而使软件更加健壮和易于维护。

# 准备代码审查

在深入到代码审查的协作过程之前，团队必须充分准备，以确保这些审查尽可能有效和高效。这种准备不仅为更顺畅的审查过程奠定了基础，而且最大限度地减少了在可避免问题上的时间消耗，使团队能够专注于更实质性和有影响力的讨论。

## 清晰的指南

有效的代码审查过程的基础是建立和记录针对 C++ 的明确、具体的编码指南。这些指南应涵盖编码的各个方面，包括风格、实践和语言特定功能的用法。通过设定这些标准，团队创建了一种共同语言，减少了歧义并确保了代码库的一致性。

将尽可能多的自动化融入这些指南可以显著简化审查过程。例如，格式化工具确保一致的编码风格，而静态分析工具可以在人类审查员查看代码之前自动检测潜在的错误或代码异味。此外，确保所有代码提交都附有通过单元测试，以及适用时端到端测试，可以防止许多常见的软件缺陷进入审查阶段。这种自动化水平不仅为审查员节省了时间，还减少了在编码风格或微小疏忽方面的主观偏好争议的可能性。

## 自我审查

准备代码审查的另一个关键方面是进行自我审查。在提交代码供同行审查之前，开发者应彻底检查自己的工作。这就是工具如 linters 和静态分析发挥作用的地方，帮助捕捉容易被忽视的常见问题。

自我审查鼓励开发者对其代码的初始质量负责，减轻了同行审查者的负担，并培养了一种责任感文化。它还允许开发者反思自己的工作，在涉及他人之前考虑潜在的改进，这可能导致提交更高质量的代码和更高效的审查会议。在提交代码供同行审查之前，开发者应通过以下问题系统地评估自己的工作。这种反思实践有助于完善代码，使其更接近项目目标，并为代码审查过程中的任何后续讨论做好准备：

1.  **我需要写代码吗？（我的改动合理吗？）** 在添加新代码之前，考虑一下这个改动是否必要。评估功能是否关键，并证明添加的合理性，同时考虑到代码库中可能增加的复杂性。

1.  **我怎样才能避免编写代码？（是否有我可以利用的第三方库或工具？）** 总是寻找利用现有解决方案的机会。使用经过良好测试的第三方库或工具通常可以实现所需的功能，而无需添加新代码，从而减少潜在的 bug 和维护开销。

1.  **我的代码可读吗？** 评估你代码的清晰度。好的代码应该对可能不熟悉它的其他工程师来说是自我解释的。使用有意义的变量名，保持整洁的结构，并在必要时包含注释来解释复杂的逻辑。

1.  **其他工程师需要理解我的代码逻辑吗？** 考虑你的代码是否可以被其他开发者独立理解。其他人能够在不需要广泛解释的情况下理解逻辑至关重要，这有助于简化维护和集成。

1.  **我的代码看起来是否与其他代码库相似？** 确保你的代码遵循项目中建立的编码风格和模式。代码库的一致性有助于保持统一性，使软件更容易阅读，并在集成过程中减少错误。

1.  **我的代码效率如何？** 评估你代码的效率。考虑资源使用，如 CPU 时间和内存，特别是在性能关键的应用程序中非常重要。审查你的算法和数据结构，以确保它们对任务来说是最佳的。

1.  **我的测试是否覆盖了边缘情况？** 确认你的测试是全面的，特别是检查它们是否覆盖了边缘情况。健壮的测试对于确保代码在异常或意外条件下的弹性和可靠性至关重要。

通过在自我审查过程中回答这些问题，开发者不仅提高了他们所编写代码的质量，还简化了同行评审过程。这种深思熟虑的方法最小化了在同行评审期间进行重大修订的可能性，并提高了代码审查周期的整体有效性。这种准备可以在代码审查期间导致更明智和建设性的讨论，因为开发者已经意识到并解决了许多潜在的问题。

# 在编写代码之前与审阅者和代码所有者讨论大功能

成功地导航代码审查过程对于维护软件质量以及培养积极和富有成效的团队环境至关重要。在这里，我们概述了旨在确保他们的代码顺利有效地通过审查的开发者所必需的基本策略。

## 在编写代码之前与审阅者和代码所有者讨论大功能

在着手开发重大功能之前，建议与代码评审者和所有者进行咨询。这次初步讨论应集中在拟议的设计、实施方法和该功能如何融入现有的代码库。尽早参与这种对话有助于统一预期，减少后期重大修订的可能性，并确保该功能能够与其他项目部分无缝集成。

## 在发布代码之前仔细检查

在提交代码供同行评审之前，请彻底审查自己的代码。这种自我评估应涵盖逻辑、风格以及对项目编码标准的遵守情况。寻找任何可以改进或简化的区域。确保你的提交尽可能完善，这不仅有助于使评审过程更加顺畅，而且也展示了你的勤奋和对评审者时间的尊重。

## 确保代码符合代码约定

遵守既定的代码约定至关重要。这些约定涵盖了从命名方案到布局和程序实践的各个方面，确保代码库的一致性。一致性使得代码更容易阅读、理解和维护。在提交评审之前，请确保你的代码严格遵循这些指南，以避免在评审过程中出现不必要的来回沟通。

## 代码评审是一种对话，而非命令

代码评审应被视为一种对话而非指令。评审者通常提供旨在引发讨论而非单方面命令的评论和建议。特别是对于初级开发者来说，理解你被鼓励参与这些讨论非常重要。如果建议或更正不明确，请寻求澄清，而不是默默地进行更改。这种互动不仅有助于你的职业发展，而且增强了评审过程的协作精神。

## 记住——你的代码不是你本人

我从前老板 Vladi Lyga 那里学到的宝贵教训是“*你的代码不是你本人*。”开发者往往在他们的代码上投入了大量的努力和自豪感，接受批评可能具有挑战性。然而，记住，对你代码的反馈并不是对你作为开发者或个人的个人批评。目标是改进项目并确保最高质量的结果，有时这需要建设性的批评。将个人身份与其工作分离，使开发者能够更客观地对待反馈，并将其作为成长的机会。

通过充分准备、参与开放对话并接受建设性的反馈视角，开发者可以有效地应对代码评审过程。这些做法不仅提高了代码质量，而且有助于营造一个更加支持和协作的团队环境。

# 如何在代码评审中高效地提出异议

争议是代码审查过程中的自然部分。不同的观点可能导致在方法、实现或最佳实践的解释上产生冲突。有效地处理这些争议对于保持高效的审查过程和健康的团队环境至关重要。以下是一些在代码审查期间有效管理争议的关键策略。

## 变更的明确理由

审阅者不仅需要指出需要改进的领域，而且还需要清楚地解释为什么需要变更。在建议修改时，审阅者应提供基于最佳实践、性能考虑或与项目相关的原则的合理依据。包括对编码标准、文章、文档或其他权威资源的链接可以大大增强论点的清晰度和说服力。这种方法有助于被审阅者理解反馈背后的推理，使他们更有可能看到建议变更的价值。

## 被审阅者的相互解释

同样，如果被审阅者不同意某个评论或建议，他们也应该清楚地阐述自己的理由。这种解释应详细说明为什么选择了他们的方法或解决方案，并辅以相关的技术依据、文档或项目内的先例。通过提供合理的论点，被审阅者可以促进更明智的讨论，这可能导致更好的理解或改进的解决方案。

## 直接沟通

当争议涉及多轮来回评论时，建议将对话从书面评论转移到直接对话。这可以通过视频通话、电话或面对面会议来实现，具体取决于可行性。直接沟通可以防止在基于文本的讨论中常见的误解和升级，这些讨论可能会迅速变得无效率和有争议，就像在 Reddit 等平台上看到的漫长线程一样。

## 引入额外的观点

如果审阅者和被审阅者之间无法达成协议，引入额外的观点可能有益。引入第三位工程师、产品经理、质量保证专家或甚至架构师可以提供新的见解并帮助调解分歧。这些方可能提供替代方案、妥协方法或基于更广泛的项目优先级和影响的决策。他们的意见在打破僵局和确保决策全面并与整体项目目标一致方面可能至关重要。

在代码审查期间进行有效的争议解决对于保持审查过程的建设性和专注于提高代码库的质量至关重要。通过解释反馈背后的理由，鼓励直接沟通，并在必要时涉及额外的观点，团队可以有效地解决分歧，并保持积极、协作的环境。这种方法不仅解决了冲突，还增强了团队共同应对未来挑战的能力。

# 如何成为一名优秀的审稿人

在代码审查过程中，审稿人的角色至关重要，这不仅是为了确保代码的技术质量，也是为了维护一个建设性、尊重性和教育性的环境。以下是一些定义优秀审稿人的关键实践。

## 开始对话

通过与被审稿人进行友好的对话开始审查过程。这可以是一条简短的消息，承认他们为**拉取请求**（**PR**）所付出的努力，并为即将到来的审查设定积极的基调。友好的开始有助于与被审稿人建立联系，使随后的交流更加开放和协作。

## 保持礼貌和尊重

在你的评论中始终保持礼貌和尊重。记住，被审稿人已经投入了大量努力到他们的代码中。批评应该是建设性的，专注于代码及其改进，而不是个人。以问题或建议的形式表达反馈，而不是指令，也有助于保持积极的语气和鼓励的基调。

## 审查可管理的部分

如果可能，一次审查的代码量限制在大约 400 行。审查大量代码可能导致疲劳，从而增加遗漏次要和关键问题的可能性。将审查分解为可管理的部分不仅提高了审查过程的有效性，还有助于保持对细节的高度关注。

## 避免个人偏见

在审查过程中，区分必须因客观原因更改的代码——例如语法错误、逻辑错误或偏离项目标准——以及反映个人编码偏好的更改非常重要。例如，让我们考虑以下代码片段：

```cpp
std::string toString(bool done) {
  if (done) {
    return "done";
  } else {
    return "not done";
  }
}
```

一些工程师可能更喜欢以下方式重写这个函数：

```cpp
std::string toString(bool done) {
  if (done) {
    return "done";
  }
  return "not done";
}
```

虽然第二个版本更加简洁，但第一个版本同样有效，并且符合项目的编码标准。如果你对可能增强代码的个人偏好有强烈的看法，请明确将其标记为个人偏好。指出这是一个基于个人偏好的建议，而不是强制性的更改。这种清晰度有助于被审稿人理解哪些更改对于符合项目标准是必要的，哪些是可选的改进。

## 专注于可理解性

作为审稿人，你最需要问自己的关键问题是代码是否足够易懂，以至于你或团队中的其他人可以在半夜修复它。这个问题直击代码可维护性的核心。如果答案是肯定的，那么讨论提高代码清晰度和简洁性的方法就很重要了。易于理解的代码更容易维护和调试，这对于长期项目健康至关重要。

成为一名优秀的审稿人远不止于仅仅识别代码中的缺陷。它需要发起并维持支持性的对话，尊重并认可同事的努力，有效地管理审稿工作量，并提供清晰、有帮助的反馈，将项目标准置于个人偏好之上。通过营造积极和富有成效的审稿环境，你不仅有助于提高代码质量，还有助于团队的发展和凝聚力。

# 摘要

本章深入探讨了进行有效代码审查的基本实践和原则，这是 C++软件开发过程中的一个关键组成部分。通过一系列结构化的子章节，我们探讨了代码审查过程的各个方面，共同确保高质量、可维护的代码，同时营造积极的团队环境。

我们首先讨论了*代码审查的起源*，这是由迈克尔·法根在 20 世纪 70 年代引入的，强调了它将软件开发从孤立的任务转变为增强代码质量和减少错误协作努力的变革性作用。

在*准备代码审查*部分，我们强调了明确指南和自我审查的重要性。我们鼓励开发者使用诸如代码检查器和静态分析工具等工具来在同行审查之前完善他们的代码，确保遵守编码标准并减少代码修订的迭代周期。

在*如何通过代码审查*部分，我们概述了开发者确保他们的代码在审查中受到良好接受的战略。这包括在编码前讨论重大变更，将代码审查视为建设性对话，并记住在审查反馈时将个人身份与代码分离，以客观地看待反馈。

在*如何高效地在代码审查中提出异议*部分，我们讨论了如何有效地处理分歧。我们强调了明确变更理由的重要性，使用直接沟通以避免误解，并在必要时涉及额外观点以解决冲突并达成共识。

最后，在*如何成为一名优秀的审稿人*部分，我们提供了关于如何以积极互动开始审稿、分块审阅代码、避免个人偏好的影响，以及在关键时刻评估代码的清晰度和易于理解性的指导。

在本章的整个内容中，其核心主题一直是代码审查并不仅仅是关于批评代码，而是关于建立一个支持性的开发者社区，这个社区共享知识、持续改进，并致力于在编码实践中追求卓越。目标是提升软件的技术质量以及参与团队成员的专业发展。通过遵循这些最佳实践，团队可以创造出更加健壮、高效且无错误的代码，这对他们 C++项目的成功贡献显著。
