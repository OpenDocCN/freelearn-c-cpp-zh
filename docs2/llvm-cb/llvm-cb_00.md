# 前言

程序员可能在编程过程中某个时刻遇到过编译器。简单来说，编译器将人类可读的高级语言转换为机器可执行代码。但你是否曾想过编译器内部发生了什么？编译器在生成优化后的机器代码之前会进行大量的处理。编写一个好的编译器涉及到许多复杂的算法。

本书贯穿编译的所有阶段：前端处理、代码优化、代码生成等。为了使这次旅程变得简单，LLVM 是研究最简单的编译器基础设施。它是一个模块化、分层编译器基础设施，其中每个阶段都作为一个单独的配方提供。用面向对象的 C++ 编写的 LLVM 为程序员提供了一个简单的接口和大量的 API，以便他们编写自己的编译器。

作为作者，我们坚持认为，简单的解决方案通常比复杂的解决方案更有效；在这本书中，我们将探讨各种配方，这些配方将帮助您提高技能，让您考虑所有编译选项，并理解编译代码不仅仅是表面上的那么简单。

我们也相信，那些没有参与编译器开发的程序员也能从这本书中受益，因为了解编译器实现的知识将帮助他们下次编写代码时进行优化。

我们希望您会发现这本书中的配方美味可口，在尝试了所有配方之后，您将能够准备出自己的编译器大餐。饿了吗？让我们开始配方吧！

# 本书涵盖内容

第一章，*LLVM 设计和使用*，介绍了 LLVM 基础设施的模块化世界，您将学习如何下载和安装 LLVM 和 Clang。在本章中，我们将通过一些示例来熟悉 LLVM 的工作原理。我们还将看到各种前端的一些示例。

第二章，*编写前端步骤*，解释了编写一种语言前端所需的步骤。我们将为一种基本玩具语言编写一个裸机玩具编译器前端。我们还将看到如何将前端语言转换为 LLVM 中间表示（IR）。

第三章，*扩展前端和添加 JIT 支持*，探讨了玩具语言的更高级特性和向前端添加 JIT 支持的情况。我们实现了大多数现代编程语言中找到的一些语言强大功能。

第四章，*准备优化*，探讨了 LLVM IR 的传递基础设施。我们探索了各种优化级别，以及每个级别的优化技术。我们还看到了编写我们自己的 LLVM 传递的逐步方法。

第五章，*实现优化*，展示了我们如何在 LLVM IR 上实现各种常见的优化传递。我们还探索了一些在 LLVM 开源代码中尚未出现的向量化技术。

第六章，*目标无关代码生成器*，带我们穿越目标无关代码生成器的抽象基础设施。我们探索了 LLVM IR 如何转换为选择 DAGs，这些 DAGs 进一步处理以生成目标机器代码。

第七章，*优化机器代码*，探讨了如何优化选择 DAGs 以及如何将目标寄存器分配给变量。本章还描述了在 Selection DAGs 上的各种优化技术以及各种寄存器分配技术。

第八章，*编写 LLVM 后端*，带我们踏上描述目标架构的旅程。本章涵盖了如何描述寄存器、指令集、调用约定、编码、子目标特性等内容。

第九章，*使用 LLVM 进行各种有用的项目*，探讨了 LLVM IR 基础设施可以用于的各种其他项目。记住，LLVM 不仅仅是一个编译器；它是一个编译器基础设施。本章探讨了可以将各种项目应用于代码片段以从中获取有用信息的各种项目。

# 你需要这本书的内容

为了完成这本书中涵盖的大多数示例，你只需要一台 Linux 机器，最好是 Ubuntu。你还需要一个简单的文本或代码编辑器、互联网接入和浏览器。我们建议安装 meld 工具以比较两个文件；它在 Linux 平台上运行良好。

# 这本书面向的对象

这本书是为熟悉编译器概念的编译器程序员而写的，他们希望在他们的工作中以有意义的方式深入了解、探索和使用 LLVM 基础设施。

这本书也适合那些虽然没有直接参与编译器项目，但经常参与编写数千行代码的开发阶段的程序员。通过了解编译器的工作原理，他们将以最优的方式编码，并通过干净的代码提高性能。

# 部分

在这本书中，你会发现一些频繁出现的标题（准备、如何做、如何工作、更多内容、相关内容）。

为了清楚地说明如何完成食谱，我们使用这些部分。

## 准备工作

本节将告诉你在食谱中可以期待什么，并描述如何设置任何软件或任何为食谱所需的初步设置。

## 如何做…

本节包含遵循食谱所需的步骤。

## 如何工作…

这一部分通常包含对上一节发生情况的详细解释。

## 更多内容...

这一部分包含有关食谱的附加信息，以便你更了解食谱。

## 相关内容

这一部分提供了对其他有用信息的链接。

# 惯例

在这本书中，你会发现许多文本样式，用于区分不同类型的信息。以下是一些这些样式的示例及其含义的解释。

文本中的代码单词、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟 URL、用户输入和 Twitter 账号如下所示：“我们可以通过使用 `include` 指令包含其他上下文。”

代码块设置如下：

```cpp
primary := identifier_expr
:=numeric_expr
:=paran_expr
```

当我们希望将你的注意力引到代码块的一个特定部分时，相关的行或项目将以粗体显示：

```cpp
primary := identifier_expr
:=numeric_expr
:=paran_expr
```

任何命令行输入或输出都如下所示：

```cpp
$ cat testfile.ll

```

**新术语**和**重要词汇**以粗体显示。你会在屏幕上看到的单词，例如在菜单或对话框中，在文本中如下所示：“点击**下一步**按钮将你带到下一屏幕。”

### 注意

警告或重要提示以如下方框形式出现。

### 小贴士

小技巧和技巧如下所示。

# 读者反馈

我们读者的反馈总是受欢迎的。告诉我们你对这本书的看法——你喜欢或不喜欢什么。读者反馈对我们很重要，因为它帮助我们开发出你真正能从中获得最大收益的标题。

如要向我们发送一般反馈，请简单地发送电子邮件至 `<feedback@packtpub.com>`，并在邮件主题中提及书籍标题。

如果你在一个主题上有专业知识，并且你对撰写或为书籍做出贡献感兴趣，请参阅我们的作者指南，网址为 [www.packtpub.com/authors](http://www.packtpub.com/authors)。

# 客户支持

现在你已经是 Packt 书籍的骄傲拥有者，我们有一些事情可以帮助你从购买中获得最大收益。

## 下载示例代码

你可以从你购买的所有 Packt 出版物的账户中下载示例代码文件，网址为 [`www.packtpub.com`](http://www.packtpub.com)。如果你在其他地方购买了这本书，你可以访问 [`www.packtpub.com/support`](http://www.packtpub.com/support) 并注册，以便将文件直接通过电子邮件发送给你。

## 下载本书的彩色图像

我们还为你提供了一份包含本书中使用的截图/图表彩色图像的 PDF 文件。彩色图像将帮助你更好地理解输出的变化。你可以从以下链接下载此文件：[`www.packtpub.com/sites/default/files/downloads/5981OS_ColorImages.pdf`](https://www.packtpub.com/sites/default/files/downloads/5981OS_ColorImages.pdf)。

## 错误清单

尽管我们已经尽最大努力确保内容的准确性，错误仍然可能发生。如果您在我们的某本书中发现错误——可能是文本或代码中的错误——如果您能向我们报告这一点，我们将不胜感激。通过这样做，您可以避免其他读者感到沮丧，并帮助我们改进本书的后续版本。如果您发现任何勘误，请通过访问[`www.packtpub.com/submit-errata`](http://www.packtpub.com/submit-errata)，选择您的书籍，点击**勘误提交表单**链接，并输入您的勘误详情来报告它们。一旦您的勘误得到验证，您的提交将被接受，勘误将被上传到我们的网站或添加到该标题的勘误部分下的现有勘误列表中。

要查看之前提交的勘误，请访问[`www.packtpub.com/books/content/support`](https://www.packtpub.com/books/content/support)，并在搜索字段中输入书籍名称。所需信息将出现在**勘误**部分下。

## 盗版

互联网上对版权材料的盗版是一个跨所有媒体的持续问题。在 Packt，我们非常重视我们版权和许可证的保护。如果您在互联网上发现任何形式的我们作品的非法副本，请立即向我们提供位置地址或网站名称，以便我们可以寻求补救措施。

请通过`<copyright@packtpub.com>`与我们联系，并提供疑似盗版材料的链接。

我们感谢您在保护我们的作者和我们为您提供有价值内容的能力方面的帮助。

## 问题

如果您对本书的任何方面有问题，您可以通过`<questions@packtpub.com>`联系我们，我们将尽力解决问题。
