# 前言

我们非常高兴你决定选择*Minimal CMake*，无论是为了首次了解 CMake，还是为了扩展你今天对 CMake 的理解。如果你有兴趣了解 CMake 如何帮助你创建库和应用程序、与世界级开源软件集成，或者它如何帮助你与他人共享你的创作，那么你来对地方了。

本书的标题有些俏皮，但其核心思想是尽可能快地深入了解 CMake 的精髓，跳过一些部分，完全避免其他部分。CMake 最擅长的就是做你需要它做的事，然后给你留出空间。你不需要成为 CMake 专家就能高效使用它，无论你是 CMake 新手，还是离开一段时间后回来看它有什么变化，本书都将为你提供有价值的内容。

本书的一个重要特点是它专注于实际的示例。它将一步一步地引导你从一个简单的控制台应用程序开始，一直到一个完整的窗口化应用程序，这个应用程序可以在 macOS、Windows 和 Linux 上运行。每一章都建立在上一章的基础上，并且每一章都伴随有源代码，源代码被拆分成多个部分，每一部分都在前面的基础上逐步展开。你将亲眼目睹整个过程是如何展开的，以及每个变化背后的推理和取舍。

在*第一部分*中，我们将确保每个人都具备设置 CMake 所需的工具。然后我们将通过一些简单的 CMake 脚本，帮助大家熟悉最基本的 CMake 命令。接着，我们将重点介绍 CMake 中一项相对较新且功能强大的补充，它使得集成外部库变得非常简单。除了展示如何集成外部代码外，我们还将展示如何通过创建可重用的库使自己的代码能够共享。

*第二部分*建立在*第一部分*的基础上。我们将首先介绍近年来 CMake 增加的一些极其有用的生活质量改进。这些改进消除了许多繁琐的命令，同时保持了 CMake 脚本的简洁与清晰。我们还将开始介绍更大的依赖项，并理解如何处理它们的策略，以及如何创建它们。最后，我们将展示如何创建一个统一的构建系统，使用一个命令即可配置并构建我们的应用程序、库和依赖项。

在*第三部分*中，我们将介绍一些 CMake 能帮助我们构建和共享更好软件的其他重要领域。我们将看到如何为我们的库和应用程序添加多种类型的测试，以及如何借助配套工具 CTest 将它们结合起来。我们还将深入了解 CMake 如何帮助我们打包应用程序，使其不仅能在我们的机器上运行，还能在任何地方运行。最后，我们将回顾一下其他一些可以简化 CMake 使用的优秀工具，并了解接下来在哪里可以继续扩展你的 CMake 知识。

# 为什么选择 CMake？

CMake 是那种不幸地（虽然不一定是不值得的）有些不太好的声誉的工具。许多开发者曾经被 CMake 烧过。他们可能在一个遗留代码库中被迫与它打交道，不得不处理复杂性、大量的 CMake 脚本和可疑的做法。或者，他们可能尝试将其用于新项目，但最终因为难以让事情正常工作而感到困惑和沮丧。由于 CMake 存在已久，许多过时的示例和资源引用了旧版本的 CMake，缺少所有最新功能（以及对什么有效、什么不能做的经验教训）。就像任何成功的框架或语言一样，CMake 也带有一定的包袱，这是不可避免的。

话虽如此，好消息是，在过去的几年里，CMake 经历了一次复兴，从 3.0 版本开始（对于死忠用户来说，技术上是 2.8 版本），通过从目标生成复杂项目的新功能，带来了巨大的变化，自那时以来，它的受欢迎程度逐渐上升。

CMake 日益流行的原因之一是一个至关重要的细节，这一点再强调也不为过。如果你使用 CMake 描述你的构建，默认情况下，你将拥有一个可以在 Windows、Linux 和 macOS 上构建的项目。如果你在 Windows 上使用 Visual Studio、在 macOS 上使用 Xcode 或在 Linux 上使用 Make 文件启动项目，迁移到其他平台会更难，且不同平台上的其他人也更难参与进来。将构建设置和选项存储在版本化的、易于阅读的脚本中是非常有用的（再也不需要在 IDE 中翻找嵌套的选项卡和窗口来找到要更改的值）。

另一个有趣的发展是，随着 CMake 的普及，它现在已经成为 C 和 C++ 构建系统的**通用语言**。如果一个 C 或 C++ 项目托管在 GitHub 上， chances are 它正在使用 CMake，即使不是，通过极少的努力，也可以编写一个简单的集成或包装器，使得该库能被 CMake 使用。这解锁了巨大的潜力，因为为项目添加依赖关系以提供改进，突然间变成了几行代码，而不是一个痛苦、繁重且耗时的过程，通常需要将其他库的代码嵌入到你的项目中，或者下载并编写代码来构建那些库。

使用 CMake 构建你的项目并且掌握足够的 CMake 知识以应付日常需求（你完全不需要成为专家）将使你编写应用程序的速度更快、更加易于维护，并且更具协作性。这也会让使用 C 或 C++ 更加有趣（我们保证），不仅仅是 C 和 C++，在本文发布时，CMake 还支持 C#、Fortran、CUDA、Objective-C 和 Swift。

CMake 绝非完美，但今天，它在 C 和 C++ 领域无处不在，并且由于 Kitware 开发者和许多具有影响力的开源贡献者的出色工作，它不断发展和改进。我们确信，无论你是拥有多年经验的专业 C++ 开发者，还是刚刚入门、正在学习或重新熟悉 CMake 的学生或爱好者，掌握 CMake 都会让你成为一个更快乐、更高效的开发者。你在依赖管理和项目结构等方面获得的经验，未来也会为你带来好处。

现在让我们将注意力转向你认为最适合的群体，以帮助你从这本书中获得最大收益。

# 这本书适合谁

我们理解，可能有广泛的读者群体对阅读本书感兴趣，因此我们希望为每种类型的读者提供一些具体细节，以帮助你更好地准备好学习本书的内容。

## 学生

如果你是计算机科学或软件工程专业的学生，那么这本书可能会对你有帮助，不仅能帮助你入门 CMake，还能让你了解跨平台开发、静态库与共享库、代码结构和测试等内容。书中的信息将为你开发自己的桌面应用程序提供坚实的基础，无论是游戏、工具还是模拟。某些主题可能对你来说不太熟悉，但通过研究代码并跟随推荐的链接，你很快就能掌握内容。

## 经验丰富的 C/C++ 开发者

如果你带着丰富的构建 C/C++ 库和/或应用程序的经验来阅读本书，那么很多基础内容可能会很熟悉，但你如何使用 CMake 来高效地配置和设置将会引起你的兴趣（例如，涉及动态库加载和 RPATH 处理等主题）。示例项目还使用了一些有趣的库（特别是图形库 `bgfx` 和用户界面库 Dear ImGui），这些也可能会引起你的兴趣，同时它们在 CMake 中的处理方法也是如此。CMake 如何处理安装和打包也可能与你相关（特别是如何使用 CMake 正确配置安装程序/磁盘镜像）。

## 有经验的开发者（其他语言）

如果你是一个熟悉其他编程语言的有经验的开发者（例如 JavaScript/TypeScript、Java、C#、Python、Rust），那么你一定能够轻松跟上本书的内容。希望 CMake 与你所使用的现有语言/框架中的构建系统之间的相似之处，能使你更容易理解这些概念（尤其是在依赖管理方面）。如果你是 C/C++ 新手（或久未接触），那么这些示例也可以作为 C/C++ 的复习材料。

## 爱好者

如果你是一个业余开发者，想要构建你的第一个游戏或工具，与朋友、家人或同事分享，那么本书应该能为你提供所需的一切，帮助你入门。如果你想构建一个窗口化的应用程序或坚持运行终端中的应用，我们也为你提供了相关内容。本书中介绍如何集成第三方库的信息，尤其有助于帮助你在短时间内提高生产力。

# 本书内容概览

*第一章*，*入门*，涵盖了无论你是使用 Windows、macOS 还是 Linux，都能启动和运行 CMake 所需的一切。

*第二章*，*你好，CMake!*，带你快速浏览 CMake，介绍了一些最基本的概念以及我们将在本书中构建的应用程序的核心。

*第三章*，*使用 FetchContent 与外部依赖*，展示了如何引入我们的第一个外部依赖，以最小的努力增强应用程序。

*第四章*，*为 FetchContent 创建库*，换个角度，展示了如何创建一个库，之后可以被`FetchContent`使用。

*第五章*，*简化 CMake 配置*，转向关注如何设置 CMake，以尽可能高效地工作，并消除冗长的命令。

*第六章*，*安装依赖与 ExternalProject_Add*，在*第五章*的基础上，向你展示了如何最好地处理项目中的更大依赖。

*第七章*，*为你的库添加安装支持*，详细讲解了如何使你的库可安装，以便像我们在*第六章*中探讨的依赖一样使用。

*第八章*，*使用超级构建简化入门*，回到简化项目的主题，演示了如何通过一个命令构建你的项目和多个外部依赖。

*第九章*，*为项目编写测试*，探讨了测试的重要性，并概述了 CTest 如何帮助巩固各种类型的测试。

*第十章*，*为共享打包项目*，讲解了在将你的项目准备好与他人共享时，解决最后一个难题。

*第十一章*，*支持工具与下一步*，探讨了更广泛的 CMake 生态系统，并介绍了一系列能够与 CMake 本身互补的工具，还分享了一些关于未来学习 CMake 的主题和资源。

# 充分利用本书

如果你在以下内容中有一些经验，跟随学习会更加容易：

+   基本的 C/C++ 知识（或类似的过程式语言，如 Java 或 C#）

+   熟悉终端/命令行

+   使用代码编辑器的经验（例如 Visual Studio Code）

+   基本的图形编程概念的意识（加分项；这有助于理解后面的某些示例，但并非必需）

我们希望这本书能帮助你理解和欣赏 CMake 在简化应用构建方面的作用。它将为你提供一个坚实的基础，帮助你构建和组织新项目，让使用他人的代码以及分享自己的代码变得更加简单。

| **书中涵盖的** **软件/硬件** | **操作系统** **要求** |
| --- | --- |
| C, C++, CMake, CTest, CPack, Visual Studio Code | Windows, macOS, Linux |

我们建议你克隆本书附带的仓库，浏览代码并运行示例，以更深入地了解事物的运作方式。我们还建议使用文本比较工具（diff 工具）来比较章节内容，随着时间的推移，库和应用程序会发生变化。

# 下载示例代码文件

你可以从 [`github.com/PacktPublishing/Minimal-CMake`](https://github.com/PacktPublishing/Minimal-CMake) 下载本书的示例代码文件。如果代码有更新，它会在 GitHub 仓库中进行更新。

我们还提供了其他来自我们丰富书籍和视频目录的代码包，详情请访问 [`github.com/PacktPublishing/`](https://github.com/PacktPublishing/)。快来看看吧！

# 使用的约定

本书中使用了若干文本约定。

`文本中的代码`：表示文本中的代码词汇、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟 URL、用户输入和 Twitter 用户名。以下是一个示例：“我们将介绍我们需要在 `CMakeLists.txt` 文件中进行的更改，以及创建软件包所需的命令。”

一段代码的设置如下：

```cpp
cmake_minimum_required(VERSION 3.28)
project(mc-array LANGUAGES C)
```

任何命令行输入或输出如下所示：

```cpp
Shaders not found. Have you built them using compile-shader-<platform>.sh/bat script?
```

**粗体**：表示新术语、重要词汇或屏幕上显示的词语。例如，菜单或对话框中的文字会以粗体显示。以下是一个示例：“完成后，关闭并重新打开终端，返回到 **VS 2022 的开发者命令提示符**。”

提示或重要说明

如下所示：

# 联系我们

我们始终欢迎读者的反馈。

一般反馈：如果你对本书的任何部分有疑问，请通过电子邮件联系 `customercare@packtpub.com`，并在邮件主题中提到书名。

**勘误表**：尽管我们已尽最大努力确保内容的准确性，错误还是有可能发生。如果你发现书中有错误，我们非常感激你能将其报告给我们。请访问 [www.packtpub.com/support/errata](http://www.packtpub.com/support/errata) 并填写表格。

**盗版**：如果你在互联网上发现任何我们作品的非法副本，无论形式如何，我们将非常感激你提供相关位置或网站名称。请通过版权@packtpub.com 与我们联系，并附上相关材料的链接。

如果你有兴趣成为作者：如果你在某个主题上有专业知识，并且有意编写或贡献书籍，请访问[authors.packtpub.com](http://authors.packtpub.com)。

# 分享你的想法

阅读完*Minimal Cmake*后，我们很希望听到你的想法！请[点击这里直接进入本书的亚马逊评论页面](https://packt.link/r/1835087310)，分享你的反馈。

你的评论对我们和技术社区至关重要，将帮助我们确保提供优质内容。

# 下载本书的免费 PDF 副本

感谢你购买本书！

你喜欢在移动中阅读，但又无法随身携带纸质书籍吗？

你的电子书购买与所选设备不兼容吗？

别担心，现在每本 Packt 书籍都附赠免费的 DRM 免保护 PDF 版本。

在任何地方、任何设备上阅读。直接从你最喜欢的技术书籍中搜索、复制和粘贴代码到你的应用中。

优惠不仅仅于此，你还可以独享折扣、新闻通讯以及每日送到你邮箱的优质免费内容。

按照这些简单步骤获取优惠：

1.  扫描二维码或访问以下链接

![](img/B21152_QR_Free_PDF.jpg)

[`packt.link/free-ebook/9781835087312`](https://packt.link/free-ebook/9781835087312)

1.  提交你的购买凭证

1.  就这些！我们将直接通过电子邮件发送你的免费 PDF 及其他优惠。
