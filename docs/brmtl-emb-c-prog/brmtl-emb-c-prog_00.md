# 前言

在一个技术驱动的世界中，嵌入式系统几乎为每个现代设备和创新提供动力，能够开发高效可靠的固件是一项宝贵的技能。从编写基本代码到掌握低级固件开发的过程可能会令人望而却步，但回报是巨大的。无论是家用电器、工业控制系统还是复杂的物联网设备，嵌入式系统都是现代技术背后默默无闻、勤奋工作的引擎。

这本书，《裸机嵌入式 C 编程》，源于一个愿望，即帮助你不仅能够编写功能性的固件，而且能够深入理解控制微控制器核心运作的底层机制。我的目标是带你进行一次深入的技术之旅，深入 ARM 架构微控制器固件开发的内心，特别关注 STM32 系列。这不是一本适合胆小的人的书，也不是一本适合寻找快速捷径的人的书。相反，它是为那些准备好离开预构建库和工具的舒适区，发展编写高效裸机代码所需技能的个人设计的。

那么，究竟什么是*裸机*编程？简单来说，它是一种编写直接与硬件交互的固件的艺术——没有第三方库提供的抽象层。这种方法需要精确性、对微控制器架构的深入理解，以及读取和操作寄存器的能力，以实现从你的硬件中获得你想要的精确行为。

*我为什么写这本书*

作为一名在嵌入式系统开发领域拥有多年经验的人，我经常注意到在固件开发教学方式中存在一个差距。许多文本和课程专注于高级开发，推广使用预构建库来抽象化硬件交互的复杂性。虽然这种方法无疑在很多情况下既方便又实用，但它为那些真正希望了解事物在最低级别是如何工作的留下了空白。我相信，理解嵌入式系统开发的“裸机”方面对于成为一名真正的熟练固件工程师是至关重要的。

这本书是我填补这一空白的一次努力。通过逐步指导，我将向你展示如何构建自己的驱动程序，操作寄存器，并编写能够完全控制微控制器的代码。这不仅仅是学习一项新技能——这是关于达到精通。

# 这本书面向的对象

如果你是一名渴望深入微控制器固件开发世界的开发者、工程师或学生，这本书适合你。如果你是那种更喜欢理解底层发生的事情，而不是依赖在线论坛的复制粘贴解决方案的人，你会发现它特别有价值。无论你是从其他平台过渡，还是寻求在裸机开发中建立坚实的基础，这本书都会给你提供所需的实践经验。

# 本书涵盖内容

*第一章*, *设置开发工具*

本章介绍了你开发所需的基本工具。从浏览数据手册到设置你的集成开发环境（IDE），本章为后续内容奠定了基础。

*第二章*, *从内存地址构建外设寄存器*

在本章中，我们将深入裸机编程的核心。你将学习如何直接从内存地址定义和访问外设寄存器，使用官方微控制器文档作为你的指南。

*第三章*, *理解构建过程和探索 GNU 工具链*

在本章中，我们将更深入地探讨嵌入式 C 构建过程。你将探索如何使用 GNU 工具链手动编译和链接代码，从而完全控制固件创建的方式。

*第四章*, *开发链接脚本和启动文件*

在本章中，你将学习如何编写自定义链接脚本，以定义固件在微控制器内存中的放置方式，包括分配代码、数据和堆栈等部分。此外，你还将开发一个启动文件，配置微控制器的初始状态，设置堆栈，初始化内存，并跳转到你的主代码。

*第五章*, *“Make”构建系统*

自动化构建过程是嵌入式开发的关键部分。本章教你如何使用 Make 构建系统通过创建自定义 Makefile 来简化工作流程，自动化重复性任务。

*第六章*, *通用微控制器软件接口标准（CMSIS）*

CMSIS 简化了 ARM Cortex 微控制器的开发。在本章中，你将学习如何利用 CMSIS 编写高效的代码，利用微控制器的特性同时保持代码的简洁性。

*第七章*, *通用输入/输出（GPIO）外设*

GPIO 允许你的微控制器与外部设备交互。本章将指导你开发 GPIO 的输入和输出驱动程序，这是嵌入式系统中使用最频繁的外设之一。

*第八章*, *系统滴答定时器（SysTick）*

在嵌入式系统中，时间同步至关重要，SysTick 定时器提供了一种简单的方法来生成精确的时间延迟和系统滴答。本章将指导您开发用于嵌入式应用的 SysTick 驱动程序。

*第九章*, *通用* *定时器 (TIM)*

本章向您介绍了 STM32 微控制器中的通用定时器（TIM），并教授您如何开发定时器驱动程序以执行需要精确时间同步的任务。

*第十章*, *通用* *异步* *接收/发送协议*

通信是嵌入式系统的一个关键方面。本章专注于最广泛使用的通信协议之一——UART 协议。您将学习如何开发 UART 驱动程序，使您的微控制器能够从外部设备发送和接收数据。

*第十一章*, *模数* *转换器 (ADC)*

许多嵌入式应用需要将模拟信号转换为微控制器可以处理的数字数据。本章介绍了如何配置 ADC 外设，使您能够读取并将模拟输入转换为有意义的数字值。

*第十二章*, *串行* *外围* *接口 (SPI)*

SPI 是一种在嵌入式系统中常用的高速通信协议。本章将指导您开发 SPI 驱动程序，使您的微控制器能够与其他外围设备（如传感器或存储设备）进行高效通信。

*第十三章*, *集成电路间* *通信 (I2C)*

I2C 是另一种流行的设备连接通信协议，常用于嵌入式系统中的短距离通信。本章介绍了 I2C 驱动程序的开发，使您的微控制器能够通过共享总线与多个设备进行通信。

*第十四章*, *外部中断和* *事件 (EXTI)*

在嵌入式系统中，响应性至关重要，外部中断允许系统对其环境中的变化做出反应。本章介绍了如何配置和管理外部中断和事件（EXTI），以便及时有效地对外部刺激做出响应。

*第十五章*, *实时* *时钟 (RTC)*

对于需要精确时间记录的系统，RTC 外设是必不可少的。在本章中，您将学习如何设置和使用 RTC 在低功耗系统中跟踪时间，即使在微控制器处于睡眠模式时也是如此。

*第十六章*, *独立* *看门狗 (IWDG)*

稳定性对于嵌入式系统至关重要，独立看门狗定时器（IWDG）确保系统可以从意外故障中恢复。本章教授您如何配置 IWDG，以便在微控制器停止响应时自动重置，确保可靠运行。

*第十七章*，*直接内存访问（DMA）*

直接内存访问（DMA）允许数据传输独立于 CPU 进行，显著提高系统效率。本章将介绍如何配置和使用 DMA 进行内存到内存的传输，以及用于 ADC 和 UART 等外围设备的 DMA，从而减轻 CPU 的工作负担。

*第十八章*，*嵌入式系统中的电源管理和能源效率*

电源管理对于节能系统至关重要，尤其是在电池供电的设备中。在本章的最后，你将学习降低功耗的技术，包括如何使用睡眠模式、唤醒源以及优化固件以在性能和能源效率之间取得最佳平衡。

# 为了最大限度地利用这本书

为了充分利用这本书，对 C 编程语言有一个基本的了解是很重要的。虽然我们将详细讲解嵌入式系统编程的细节，但了解代码是如何运行的将使材料更容易理解。熟悉微控制器当然有帮助，但不是严格的要求。随着我们的进展，所有你需要的东西都会被介绍。无论你是初学者还是有经验的开发者，这本书都会一步一步地引导你进入裸机嵌入式编程的迷人世界。

| **本书涵盖的软件/硬件** | **操作系统要求** |
| --- | --- |
| STM32CubeIDE | Windows |
| GNU Arm 嵌入式工具链 |  |
| NUCLEO-411 开发板 |  |
| 10k 电位器 |  |
| OpenOCD |  |
| Notepad++ |  |
| RealTerm |  |

**如果你使用的是这本书的数字版，我们建议你亲自输入代码或从书的 GitHub 仓库（下一节中有一个链接）获取代码。这样做将帮助你避免与代码的复制和粘贴相关的任何潜在错误。**

# 下载示例代码文件

你可以从 GitHub（[`github.com/PacktPublishing/Bare-Metal-Embedded-C-Programming`](https://github.com/PacktPublishing/Bare-Metal-Embedded-C-Programming)）下载本书的示例代码文件。如果代码有更新，它将在 GitHub 仓库中更新。

我们还有其他来自我们丰富的书籍和视频目录的代码包，可在[`github.com/PacktPublishing/`](https://github.com/PacktPublishing/)找到。查看它们吧！

# 使用的约定

本书使用了多种文本约定。

`文本中的代码`：表示文本中的代码单词、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟 URL、用户输入和 Twitter 昵称。以下是一个示例：“复制到`openocd` `bin`文件夹的路径。”

代码块是这样设置的：

```cpp
// 22: Set PA5(LED_PIN) high 
GPIOA_OD_R |= LED_PIN; 
```

当我们希望引起你对代码块中特定部分的注意时，相关的行或项目将以粗体显示：

```cpp
//  1: Define base address for peripherals
#define PERIPH_BASE        (0x40000000UL)
//  2: Offset for AHB1 peripheral bus
```

任何命令行输入或输出都按照以下方式编写：

```cpp
monitor flash write_image erase 4_makefile_project.elf
```

**粗体**：表示新术语、重要单词或您在屏幕上看到的单词。例如，菜单或对话框中的单词以粗体显示。以下是一个示例：“右键单击**此电脑**，然后选择**属性**。”

小贴士或重要笔记

看起来像这样。

# 联系我们

我们始终欢迎读者的反馈。

**一般反馈**：如果您对本书的任何方面有疑问，请通过电子邮件联系我们 customercare@packtpub.com，并在邮件主题中提及书名。

**勘误表**：尽管我们已经尽一切努力确保内容的准确性，但错误仍然可能发生。如果您在这本书中发现了错误，我们将不胜感激，如果您能向我们报告，我们将不胜感激。请访问 [www.packtpub.com/support/errata](http://www.packtpub.com/support/errata) 并填写表格。

**盗版**：如果您在互联网上以任何形式发现我们作品的非法副本，我们将不胜感激，如果您能提供位置地址或网站名称，我们将不胜感激。请通过电子邮件联系我们 copyright@packt.com 并附上材料的链接。

**如果您有兴趣成为作者**：如果您在某个领域有专业知识，并且您有兴趣撰写或为书籍做出贡献，请访问[authors.packtpub.com](http://authors.packtpub.com)。

# 分享您的想法

一旦您阅读了《裸机嵌入式 C 编程》，我们非常乐意听到您的想法！请[点击此处直接进入该书的亚马逊评论页面](https://packt.link/r/183546081X)并分享您的反馈。

您的评论对我们和科技社区都至关重要，并将帮助我们确保我们提供高质量的内容。

# 下载这本书的免费 PDF 副本

感谢您购买这本书！

您喜欢在路上阅读，但无法随身携带您的印刷书籍吗？

您的电子书购买是否与您选择的设备不兼容？

别担心，现在每购买一本 Packt 书籍，您都可以免费获得该书的 DRM 免费 PDF 版本。

在任何地方、任何设备上阅读。直接从您喜欢的技术书籍中搜索、复制和粘贴代码到您的应用程序中。

优惠不会就此结束，您还可以获得独家折扣、时事通讯和每日免费内容的每日访问权限。

按照以下简单步骤获取福利：

1.  扫描二维码或访问以下链接

![二维码](img/B21914_QR_Free_PDF.jpg)

[`packt.link/free-ebook/9781835460818`](https://packt.link/free-ebook/9781835460818)

1.  提交您的购买证明

1.  就这样！我们将直接将您的免费 PDF 和其他福利发送到您的邮箱
