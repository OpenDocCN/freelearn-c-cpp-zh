<html><head></head><body>
        

                            
                    <h1 class="header-title">Environment Sensors</h1>
                
            
            
                
<p>In this chapter, we will look at building a really simple weather station using the DHT11 temperature/humidity sensor and a raindrop sensor. While the previous chapter used the basic digital input, the DHT11 temperature sensor will give us the opportunity to use a third-party library, and the raindrop sensor will use an analog pin. We will also introduce a couple of handy functions that we can use.</p>
<p>In this chapter, you will learn:</p>
<ul>
<li>How to add third-party libraries to a sketch</li>
<li>How to use the <kbd>isnan()</kbd> function</li>
<li>How to use the <kbd>map()</kbd> function</li>
<li>How to use the DHT11 temperature and humidity sensor</li>
<li>How to use a rain sensor</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Introduction</h1>
                
            
            
                
<p>The DHT11 is a low-cost temperature and humidity sensor. This sensor uses a thermistor to measure the temperature. The word <strong>thermistor</strong> is a combination of thermal (temperature) and resistor because it is a type of resistor where the resistance is highly sensitive to temperature even more so than a normal resistor. The current temperature can be determined based on the output voltage of the thermistor.</p>
<p>When working with a thermistor, the first thing we need to do is to determine how to calculate the temperature based on the output voltage. With the TMP36 temperature sensor that we used with the prototype that was created in <a href="f0039485-e47c-40c8-9130-fba1e1afd421.xhtml" target="_blank">Chapter 4</a>, <em>Basic Prototyping</em>, we could easily calculate the temperature based on the output voltage of the sensor with a basic formula of (<em>voltage</em> - <em>0.5</em>) * <em>100.0</em> because it uses a solid-state technique to determine the temperature. This is not the case with a thermistor. While a linear approximation, similar to how we calculated the temperature with the TMP36 sensor, may work for a small temperature range, to get an accurate temperature measurement from a thermistor we need to determine a resistance/temperature curve for the device.</p>
<p>Luckily there are several libraries for the Arduino that are written to help us get an accurate temperature from the DHT11 temperature and humidity sensor. In this chapter, we will be using the <strong>Adafruit</strong> library. The DHT11 sensor will look similar to the following photograph:</p>
<p class="CDPAlignCenter CDPAlign"><img src="img/2f6aec1c-7375-4e1c-9d8d-3c98358db89a.png" style="width:15.75em;height:26.67em;"/></p>
<p>With most DHT11 sensors, the pins are clearly marked as shown in the preceding photograph. The <strong>VCC</strong> pin will connect to the power rail on the breadboard, which should be connected to the 5V out pin on the Arduino. The <strong>GND</strong> pin will connect to the ground rail on the breadboard, which should be connected to the ground out pin on the Arduino. The <strong>DATA</strong> pin will connect to one of the digital pins on the Arduino.</p>
<p>Some DHT temperature sensors come with a pull-up resistor built in, while others require an external one. Please look at the documentation for your sensor to verify if you need to add an external pull-up resistor or not. In the project for this chapter, we will show the external pull up resistor.</p>
<p>For the project in this chapter, we will also be using a generic raindrop sensor. This sensor has two parts. The first part is the rain sensor board, which detects the rain when the water completes the circuits on the board's printed leads. This sensor board acts as a variable resistor where the amount of current increases as the board gets wetter. The second part of the raindrop sensor is the electronic printed circuit board that will determine the amount water based on the current from the sensor board.</p>
<p>The following photograph shows what the raindrop sensor looks like:</p>
<p class="CDPAlignCenter CDPAlign"><img src="img/4f39d6d2-01dd-46d1-a38b-83edb1ac4579.png" style="width:29.83em;height:26.33em;"/></p>
<p>The +/- pins on the printed circuit board connect to the pins on the rain sensor board. On the opposite side of the printed circuit board are four pins. The VCC and GND pins will connect to the power and ground rails of the breadboard respectively. For the project in this chapter, we will use the <strong>A0</strong> analog output pin as the output for the sensor. The A0 pin will connect directly to one of the analog in pins on the Arduino.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Components needed</h1>
                
            
            
                
<p>We will need the following components for this chapter's project:</p>
<ul>
<li>One Arduino Uno or compatible board</li>
<li>One DHT11 temperature/humidity sensor</li>
<li>One MH-RD raindrop sensor</li>
<li>One 4.7K resistor</li>
<li>Jumper wires</li>
<li>One breadboard</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Circuit diagrams</h1>
                
            
            
                
<p>The following diagram shows the Fritzing diagram for this project:</p>
<p class="CDPAlignCenter CDPAlign"><img src="img/e11121f7-5345-4251-a6f2-39070b5f6843.png" style="width:26.25em;height:32.00em;"/></p>
<p>In this diagram, we can see that the VCC and ground pins on both sensors are connected to the power and ground rails on the breadboard. The power and ground rails on the breadboard are connected to the 5V out and the ground pins on the Arduino.</p>
<p>The image of the DHT11 sensor that we showed earlier in this chapter shows a DHT11 sensor with three pins; however, the sensor in the Fritzing library has four pins. It is safe to ignore the extra pin on the Fritzing diagram.</p>
<p>This diagram shows that the data pin on the DHT11 sensor is connected to the digital 3 pin on the Arduino and it also has a 4.7K pull-up resistor. If the DHT11 sensor that you are using does not have a built-in pull-up resistor, you will need to add this external one that is shown in this diagram. The analog out on the rain sensor is connected to the analog 2 input pin on the Arduino.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Code</h1>
                
            
            
                
<p>Before we can start writing code, we will need to load in the DHT11 Adafruit library that we will be using to read the temperature and humidity readings. You can find the source code for this library on Adafruit's GitHub page here: <a href="https://github.com/adafruit/DHT-sensor-library">https://github.com/adafruit/DHT-sensor-library</a>.</p>
<div><strong>Note:</strong> You will need to refer to this code for the challenge section of this chapter.</div>
<p>To install the library, if you are using the Arduino IDE, select the Sketch option in the menu bar and select Include Library and then Manage Libraries as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="img/a17d8cb4-8cbb-4b1e-bda0-92f49dfe34d5.png" style="width:33.42em;height:28.50em;"/></p>
<p>In the window that opens up, type <kbd>dht11</kbd> in the search bar and you should see a couple different DHT11 sensor libraries. In this chapter, we will be using the one from Adafruit (In the following list, the first result). Click on this library, and you will see a button all the way to the right to install it as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="img/586f38fe-03ac-42df-b738-bbe8810b0925.png" style="width:72.25em;height:35.00em;"/></p>
<p>For the Arduino Web Editor, click on the Libraries option and then type <kbd>dht11</kbd> in the search bar as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="img/65656753-9908-4b2c-a3ae-bff5a8ccbe2c.png" style="width:27.75em;height:25.67em;"/></p>
<p>This probably will not return any results; therefore, we will need to click on the LIBRARY MANAGER link, which will bring up the library manager with results of the DHT11 search as shown in the following image:</p>
<p class="CDPAlignCenter CDPAlign"><img src="img/a43509cd-cc26-49d2-8cd3-bd790d88aaef.png" style="width:65.42em;height:39.75em;"/></p>
<p>As the instructions at the top of this window tell us, we need to click on the star of the library we wish to include and then click on the DONE button. Unfortunately, the library manager in the Web Editor does not tell us who created the library; however, if you notice, the names from the three libraries match the library names we saw from the Arduino IDE. Therefore, we are able to tell which library is the Adafruit library by the title.</p>
<p>Now that we have the library installed it is time to start writing the code. The first thing we will need to do is to include the header file for the DHT sensor library. We can do this by adding the following <kbd>include</kbd> statement at the top of the sketch:</p>
<pre>#include "DHT.h"</pre>
<p>Next, we need to define some macros. We will start off by defining the Arduino pins that the DHT11 and the raindrop sensor are connected to:</p>
<pre>#define DHT_PIN 3
#define RAIN_PIN A2</pre>
<p class="mce-root"/>
<p>This code tells us that the DHT11 sensor is connected to the digital 3 pin and the rain sensor is connected to the analog 2 pin. The Adafruit DHT sensor library can read both the DHT11 and DHT22 sensors. Therefore, we will need to tell the library which sensor type we are using, and we should create a macro that contains this type. The following code defines the DHT sensor type:</p>
<pre>#define DHT_TYPE DHT11</pre>
<p>Finally, we will need to create four macros that will help us understand the readings from the rain sensor. If you recall, the Analog input pins will map the input voltage into integer values ranging from 0 to 1023. When we read the input from the rain sensor, a value of 1023 means that there is no rain while a value of 0 means a flood. This makes sense from a purely electronic point of view; however, it seems backwards from a logical point of view where a rain sensor should report a higher value when there is more rain.</p>
<p>We will use the Arduino <kbd>map()</kbd> function to change this for us. Therefore, we will need to define the min/max values for the analog readings and the min/max values for what we want to convert the analog values to. We will explain this some more when we look at the code for the <kbd>map()</kbd> function; for now here are the macros:</p>
<pre>#define RAIN_SENSOR_MAX 1023
#define RAIN_SENSOR_MIN 0
#define RAIN_OUT_MAX 20
#define RAIN_OUT_MIN 0</pre>
<p>Now we will want to create an instance of the <kbd>DHT</kbd> class using the <kbd>DHT_PIN</kbd> and <kbd>DHT_TYPE</kbd> macros we just defined. The following code will create an instance of the <kbd>DHT</kbd> class:</p>
<pre>DHT dht(DHT_PIN, DHT_TYPE);</pre>
<p>Now that we have defined the macros needed and created a global instance of the <kbd>DHT</kbd> class, we need to create the <kbd>setup()</kbd> function. In the <kbd>setup()</kbd> function we will need to initialize the serial monitor and the <kbd>DHT</kbd> class. The <kbd>begin()</kbd> method of the <kbd>DHT</kbd> class is used to initialize the instance of the class. The following code shows the <kbd>setup()</kbd> function:</p>
<pre>void setup() {
  Serial.begin(9600);
 dht.begin();
}</pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p>Now that we have the <kbd>setup()</kbd> function let's look at how to read the DHT and rain sensors. The remainder of the code in this chapter will go into the <kbd>loop()</kbd> function of our sketch. The following code will read the humidity and temperature from the DHT sensor using the Adafruit library:</p>
<pre>float humidity = dht.readHumidity();
float celsius = dht.readTemperature();
float fahrenheit = dht.readTemperature(true);

if (isnan(humidity) || isnan(celsius) || isnan(fahreheit)) {
  Serial.println("Read Failed");
  return;
}

Serial.print("Humidity: ");
Serial.println(humidity);
Serial.print("Temperature: ");
Serial.print(celsius);
Serial.println(" *C ");
Serial.print(fahreheit);
Serial.println(" *F");

delay(3000);</pre>
<p>This code starts off by calling the <kbd>readHumidity()</kbd> method of the <kbd>DHT</kbd> class to read the humidity from the DHT sensor. The <kbd>readTemperature()</kbd> method is then called twice, once to read the temperature in Celsius and once to read the temperature in Fahrenheit. Notice that when the <kbd>readTemperature()</kbd> method is called without a parameter, we receive the temperature in Celsius and when we pass a Boolean parameter of <kbd>true</kbd> we receive the temperature in Fahrenheit. We could also pass a Boolean parameter of <kbd>false</kbd> to receive the temperature in Celsius.</p>
<p>After the temperature and humidity are read from the sensor, it is good practice to verify that the read was successful. To do this, we are using the <kbd>isnan()</kbd> function. The <kbd>isnan()</kbd> function will return <kbd>true</kbd> if the value passed in is not a number, therefore, the line <kbd>if (isnan(humidity) || isnan(celsius) || isnan(Fahrenheit))</kbd> reads "if humidity is not a number or Celsius is not a number or Fahrenheit is not a number then execute the code block". This code block will print an error message to the console and then execute a <kbd>return</kbd> statement to exit this loop.</p>
<p>If all of the variables are numbers, we print the humidity and temperatures to the serial console and then wait 3 seconds before exiting this loop and starting the loop function again.</p>
<p>Now let's look at how we would read the rain sensor. Put the following code between the final <kbd>Serial.println()</kbd> statement and the <kbd>delay()</kbd> function call of the DHT sensor code:</p>
<pre>int rain = analogRead(RAIN_PIN);
if (isnan(rain)) {
  Serial.println("Read Failed");
  return;
}
int range = map(rain, RAIN_SENSOR_MIN, RAIN_SENSOR_MAX, RAIN_OUT_MAX, RAIN_OUT_MIN);

Serial.print("Rain: ");
Serial.println(range);
Serial.println("-------------------------");</pre>
<p>In this code, we call the <kbd>analogRead()</kbd> function to read the analog pin that the rain sensor's connected to and use the <kbd>isnan()</kbd> function to verify that the read was successful. After we verify that the <kbd>analogRead()</kbd> function was performed successfully, we call the <kbd>map()</kbd> function. The <kbd>map()</kbd> function will re-map a value from one range of numbers to a new range of numbers.</p>
<p>This function has five parameters, which are:</p>
<ul>
<li><kbd>value</kbd>: The value to map</li>
<li><kbd>fromLow</kbd>: The lower limit of the value's current range</li>
<li><kbd>fromHigh</kbd>: The upper limit of the value's current range</li>
<li><kbd>toLow</kbd>: The lower limit of the value's new range</li>
<li><kbd>toHigh</kbd>: The upper limit of the value's new range</li>
</ul>
<p>If we take the <kbd>map()</kbd> function call in the previous code and replace the macros with the actual values, the <kbd>map()</kbd> function would look like this:</p>
<pre>int range = map(rain, 0, 1023, 20, 0);</pre>
<p>The value for the rain variable comes from the <kbd>analogRead()</kbd> function, which we know will have a value ranging from <kbd>0</kbd> to <kbd>1023</kbd>. Therefore, we set the current range to have a lower limit of <kbd>0</kbd> and an upper limit of <kbd>1023</kbd>. If you recall from earlier in this chapter, a value of 1023 means there is no rain while a value of 0 means there is a flood. We will want to reverse this with the new range where the higher value will mean more rain and the lower value will mean less rain. Therefore, we set the lower limit of the new range to <kbd>20</kbd> and the upper limit to <kbd>0</kbd>. This will map a value of 1023 from the old range to a value of 0 in the new range and a value of 0 in the old range to a value of <kbd>20</kbd> in the new range.</p>
<p>With this new range, a high value of <kbd>20</kbd> means that we have a flood and a low value of zero means there is no rain. A middle value from the old range (511 or 512) would map to the middle value in the new range (10). The <kbd>map()</kbd> function is very useful when we want to change a scale and/or reverse the order as we see in this example.</p>
<p>After the <kbd>map()</kbd> function is called we print the results to the serial console. Now let's see what happens when we run this project.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Running the project</h1>
                
            
            
                
<p>When we run this project, we should see a result similar to the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="img/ef74651f-83df-4e2f-87cd-923108d8daef.png" style="width:59.83em;height:35.92em;"/></p>
<p>Now try sprinkling the rain sensor board (the part of the raindrop sensor that senses the rain) with water and see how it changes the rain output.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<div><strong>NOTE</strong>: Always use caution when using water around electronic projects. If you get your Arduino or other electronic component wet you will damage them. When working with AC power with relays, you also run the risk of electrocution.</div>
<p>Now let's look at the challenge.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Challenge</h1>
                
            
            
                
<p>For this challenge, use the <kbd>DHT</kbd> library to compute the heat index. The heat index is the discomfort felt as the result of the temperature and humidity combined. There are methods within the <kbd>DHT</kbd> class that will do this for you.</p>
<p>At the beginning of this chapter, we gave a link to the GitHub repository that contained the code for the DHT sensor library. Look at the <kbd>DHT.h</kbd> file to see what methods are in the DHT class.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Summary</h1>
                
            
            
                
<p>In this chapter, we used a third-party library for the first time. This was the Adafruit DHT sensor library. We also saw two new functions that we have not used before. These functions were the <kbd>isnan()</kbd> and <kbd>map()</kbd> functions.</p>
<p>In the next chapter, we will look at range and collision detection sensors.</p>


            

            
        
    </body></html>