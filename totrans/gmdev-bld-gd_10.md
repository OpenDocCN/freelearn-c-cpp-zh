# 10

# 使用光线和阴影使事物看起来更好

我们有一个简单且看起来干净的水平设计，但它需要一次好的改造。例如，墙上的壁灯和地板上的蜡烛只是静静地放在那里，并没有为场景增添太多兴趣。此外，这个关卡作为一个地下环境确实存在一些问题，因为这是一个洞穴。我们必须找到一种方法来模拟外部光线，因为克拉拉划船进来了。总的来说，我们将让关卡的光线足够亮，以便玩家能够感知到事物。

在本章中，我们将向我们的工作流程中引入光线和阴影，以便我们的场景看起来更具视觉吸引力。我们之前在*第四章*中介绍了光线，*调整相机和光线*，但那时是在 Blender 的上下文中进行的。虽然通用概念仍然适用，但这次我们将有机会从游戏开发的角度来做事情，而不是在 Blender 中制作艺术渲染。

在 Godot 中，阴影不是自动可用的。因此，我们将向您展示如何打开阴影并发现一些平衡质量和性能的阴影设置。除了放置光源、启用阴影以及调整它们的品质外，我们还将介绍一个更高级的概念，创建一个**WorldEnvironment**。这也被称为后期处理，并且是改善你的场景外观和感觉的强大工具。

尽管我们将通过添加我们列出的主题来逐步改进关卡，但为了将这些内容串联起来，我们还将处理一个相对高级的主题，**全局照明**，这将给场景增添真实感。

在我们创建一个看起来漂亮的关卡之前，还有很多步骤要走。在本章中，我们将涵盖以下主题：

+   添加不同类型的光线

+   启用和调整阴影

+   创建后期处理效果

+   使用全局照明

尽管本章的目的是理解照明系统的工作原理，但我们在旅途中也会介绍一些互补的 Godot 主题。

到本章结束时，你将能够利用光线并启用阴影，以及利用全局照明和后期处理效果来进一步增强关卡的氛围。

# 技术要求

我们将从我们上次停止的地方继续添加和更改内容。此时你有两个选择——你可以继续使用上一章中的副本工作，或者使用*第九章*中提到的`Finish`文件夹，*设计关卡*，该文件夹可在本书的 GitHub 仓库中找到：[`github.com/PacktPublishing/Game-Development-with-Blender-and-Godot`](https://github.com/PacktPublishing/Game-Development-with-Blender-and-Godot)。

# 添加不同类型的光线

在 *第四章* *调整相机和灯光* 中，我们讨论了不同类型的灯光如何工作——更重要的是，它们对场景带来的效果。在本章中，我们将重新探讨这个主题，但将在 Godot 的背景下进行。

Blender 使用四种灯光类型：**Sun**、**Point**、**Spot** 和 **Area**。然而，Godot 只有三种灯光，如下所示：

+   **DirectionalLight**：这是 Blender 中 **Sun** 灯光的等效物。我们在 **Sun** 灯光的描述中提到了方向性。这种灯光类型的角度是最重要的，因为它是一个无限远的灯光源，所以所有光线都被认为是相互平行的。因此，在 Godot 中，这个概念是节点名称的一部分，这使得它更容易记住。

我们不会在我们的场景中使用这种类型的灯光，因为这是一个室内环境。尽管如此，仍然可能有人想利用它来提供一个整体的光效果，但这个光源会淹没整个场景。我们需要其他可以调整的东西。因此，我们将专注于其他两种灯光类型。

+   **OmniLight**：这是 Blender 中的 **Point** 灯光。灯泡，是的，墙上的壁灯，是这种灯光类型适用的正确对象。提醒一下，omni 意味着在所有方向上。

+   **SpotLight**：这个很容易理解——它是 Blender 中的 **Spot** 灯光。它适用于模拟汽车灯光、手电筒和其他具有束状特性的光源。我们将使用这种灯光来模拟从洞穴外渗透进来的外部光线。

那么，Godot 中的 **Area** 灯光在哪里？它根本不存在。Godot 中有不同机制可以用来模拟 Blender 中 **Area** 灯光的效果。通常，这种灯光是用来模拟从窗户透进来的光线，可以用发射材料来模拟。

谈到使用不同类型的灯光，让我们先点亮那些蜡烛。

## 点蜡烛

对于这类练习，**OmniLight** 类型是正确的选择，但我们应该有多少个呢？如果你仔细观察蜡烛模型，你会发现这个模型由多个蜡烛组成；有的短，有的高。在每个烛芯上方放置一个 **OmniLight** 是否合理？这是完全可能的，但也是一个艺术上的决定，我们留给您来决定。

在我们的案例中，我们假设从该物体发出的整体光线可以简化为蜡烛烛芯上的一个点。因此，为整个模型放置一个 **OmniLight** 是完全可行的。现在是时候展示如何做到这一点了：

1.  双击 `Candles_1.glb` 文件，它在 `Candles_1.tscn` 文件中，位于其原始文件夹 (`Models/Candles/`) 中。

1.  将一个 **OmniLight** 添加到 **场景** 树中。

1.  调整它的 `0.8`，例如，使其略微高于烛芯。

这将在你的蜡烛场景中放置一个点光源。目前，使用默认设置，很难看到其影响。如果你靠近灯光对象并调整你的摄像机角度，以便你不再看到地平线和天空，你可以获得更好的视角。也许你可以通过在**场景**树中打开和关闭**OmniLight**的可见性来看到灯光的贡献。

我们将保留`d6d58e`中的大部分设置。这可以在**检查器**面板的**灯光**部分找到。结果如下：

![图 10.1 – 一个黄色光束直接照在蜡烛上的 OmniLight](img/Figure_10.1_B17473.jpg)

图 10.1 – 一个黄色光束直接照在蜡烛上的 OmniLight

让我们花点时间讨论一下，为什么我们给一个由模型构建的场景添加了灯光，而不是直接将其添加到关卡场景中。毕竟，我们已经有几个**空间**节点来持有类似的项目，比如墙壁、柱子等等。我们可以创建一个名为**灯光**的**空间**节点，并将一串**OmniLight**节点放在那里。

通过将灯光节点引入模型场景而不是主关卡，你可以在其他场景中利用这个蜡烛场景。因此，你不必创建更多的灯光对象并将它们放置在关卡中的所有蜡烛上。当你装饰关卡时，需要蜡烛时，它们将作为一个全服务套餐出现。

克服锯齿边缘

在向场景添加灯光后，你可能注意到一些物体在边缘看起来是锯齿状的，因为细节更加突出。为了消除这一点，你可以打开抗锯齿设置。硬边缘将被平滑，物体将更加无缝地融合，一切看起来都会更加顺眼。要启用它，将**Msaa**值设置为**2x**。此设置可以在**项目设置**的**渲染**部分的**质量**子部分下找到。

到目前为止，一切顺利，但灯光会一直亮着吗？目前看来是这样的。让我们看看我们如何通过引入一个可以关闭灯光的机制来完成蜡烛的全服务功能。为此，我们需要添加一个简短的脚本：

1.  右键单击根节点（**Candle_1**）并选择**附加脚本**。

1.  在即将出现的弹出窗口中保持一切不变，但更改路径，使其显示为`/Models/Candles/Candles.gd`。

1.  你的脚本文件应包含以下代码行：

    ```cpp
    extends Spatial
    export(bool) var is_lit = false setget switch
    func switch(condition):
        is_lit = condition
    func _process(_delta: float) -> void:
        $OmniLight.visible = is_lit
    ```

这将为`is_lit`创建一个切换状态，使灯光再次可见。

要在不运行游戏的情况下测试这一点，你可以在脚本开头添加`tool`关键字，并在你仍在制作关卡时实时查看你的更改。观察在**检查器**面板中`is_lit`中光线的可见性如何变化。

我们还有一个可以从中受益的蜡烛模型，`Candles_2.glb`。而不是从头开始，我们建议你这样做：

1.  在**Candles_1**场景中，右键单击**场景**树中的**OmniLight**节点，并选择**复制**。

1.  将`Candles_2.glb`创建为一个场景，并将其保存在原始文件夹中。

1.  右键单击此新场景的根节点，并选择**粘贴**。

1.  选择根节点，并在**检查器**面板中将`Candles.gd`附加到**脚本**属性。

这将最小化你需要执行的步骤数量来添加一个**OmniLight**，定位它，然后编写几乎相同的脚本来控制它。在这里，我们使用相同的脚本为两个场景，因为场景中的节点引用是相同的。在我们最近的更改之后，Godot 编辑器将如下所示：

![图 10.2 – 使用相同脚本实现开关功能的新的蜡烛场景](img/Figure_10.2_B17473.jpg)

图 10.2 – 使用相同脚本实现开关功能的新的蜡烛场景

尽管我们一直在研究一种通过将灯光对象附加到蜡烛模型来添加灯光的智能方法，但我们并没有对关卡本身进行任何更改。我们将在下一节讨论这个问题，并分享一些关于你可以在未来的项目中进行的流程改进。

## 将蜡烛引入关卡

在*第九章*，“设计关卡”，我们指导您直接将 glTF 文件实例化到关卡中，这样保持了文件系统的整洁，没有创建冗余的`.tscn`文件。否则，你将有一个与模型无关的每个模型一个场景文件。仅添加模型到场景的简单工作流程通常就足够了，尤其是在你不知道项目将走向何方的情况下。

另一方面，在某些情况下，例如你有蜡烛和烛台时，你很可能在**MeshInstance**节点旁边有一个灯光节点，以及一个脚本来控制灯光的行为。在这种情况下，将模型转换为场景并从那里构建是值得的。

关卡的**场景**树仍然包含原始的蜡烛模型。在*第九章*，“设计关卡”，我们使用了两种类型的蜡烛，但总共三个模型来装饰关卡。从关卡中移除这些模型以便实例化新的蜡烛场景是完全可行的。不过，你将不得不重新定位这些新项目。因此，我们将遵循不同的路径以保持位置信息：

1.  在**场景**树中选择**Candles_1**。

1.  实例化`Candles_1.tscn`，这将产生一个嵌套节点。

1.  将嵌套节点从其父节点中拖出，并使其成为其父节点的同级节点。

通过将蜡烛场景嵌套在旧模型实例中，我们正在占用位置。如果你直接将蜡烛场景添加到**道具**节点中，你将不得不找到模型实例的位置并将其应用到新项目上。

你可以为其他两支蜡烛重复此过程，这将最终使这一层可见蜡烛的数量翻倍。也就是说，我们最初的三个蜡烛模型实例不再必要，因此你可以删除它们。同时，注意当你将蜡烛场景与仅保留模型本身相比时，脚本图标会出现在**场景**树中。以下截图显示了结果：

![图 10.3 – 场景树中的新蜡烛有脚本图标](img/Figure_10.3_B17473.jpg)

图 10.3 – 场景树中的新蜡烛有脚本图标

上一张截图不仅展示了添加到这一层的更先进的蜡烛，还展示了你可以通过**检查器**面板中的**Is Lit**属性来打开和关闭这些蜡烛。类似于你对蜡烛所做的那样，你可以通过创建一个由壁灯模型组成的场景来继续练习点光源。在这种情况下，光对象在场景中的位置可能更高，因为模型更高，但概念是相同的。你甚至可以将相同的脚本绑定到这个壁灯场景的根节点。

这确实造成了一些困境。到目前为止，我们一直将所有与蜡烛相关的文件保存在自己的文件夹中，包括脚本。然而，灯光开关脚本非常通用，可以用于任何具有类似结构的场景。尽管也可以将`Candles.gd`脚本附加到`Candles`文件夹中的不同文件夹中的场景，但如果你想通用化，可以将脚本文件移动到项目根目录下的单独`Scripts`文件夹。

这是你将面临众多项目管理难题中的一个，因此如何处理取决于你自己的选择。我们决定尽可能保持内容的通用性。因此，本章的`Finish`文件夹将让蜡烛和壁灯共享来自`Scripts`文件夹的光照脚本。

在将壁灯模型与壁灯场景交换后，这一层将更具特色，如下所示：

![图 10.4 – 三支蜡烛和四盏壁灯照亮了这一层](img/Figure_10.4_B17473.jpg)

图 10.4 – 三支蜡烛和四盏壁灯照亮了这一层

我们已经覆盖了基本灯光，但仍然没有那种你可能在内陆洞穴中看到的灯光效果。想法是克拉拉通过一个开口进入这个结构，因此让一些阳光进入这个区域是有意义的。我们将通过使用**聚光灯**节点来实现这一点。

## 模仿阳光

在我们的游戏中，故事情节是克拉拉系船的码头区域离入口不远。因此，从外部获取一些阳光是有意义的。实现这种效果的一种简单方法是使用**聚光灯**节点。让我们也讨论一个替代方案。

使用**DirectionalLight**节点一开始看起来很有吸引力，但那样会照亮整个场景。我们也希望这个洞穴看起来尽可能黑暗，并且只使用蜡烛和壁灯等人工光源进行照明。为了实现这两个目标，您需要在水平面上放置平面，假装它们是洞穴的天花板，以阻挡大部分光线。因此，由于这种努力感觉是适得其反的，我们将尝试照亮我们需要的，而不是阻挡光线。

因此，使用**SpotLight**节点似乎是我们目前最好的选择。我们将描述我们用来在水平面上放置灯光的过程，以便突出显示船和码头的一部分。下面是：

1.  选择水平面的根节点（**Level-01**）。

1.  添加一个**SpotLight**节点，并将其在**Y**方向上定位在船上方大约七个单位的位置。

1.  在**X**和**Y**方向上将其旋转**-70**度（提示：在**检查器**面板下的**变换**中使用**旋转度数**）。

1.  将其颜色更改为`d6d58e`。

1.  展开`20`。

1.  设置`55`。

我们将在解释光线放置意图后立即为您提供截图，并对截图本身进行免责声明。由于您 Godot 项目中的默认环境设置会导致场景过于明亮，以至于您无法看到您所做事情的影响，我们临时调整了一些设置，以便更好地突出您正在使用的灯光的贡献。

我们将在探索完灯光和阴影之后，在*创建后处理效果*部分研究环境效果。目前，我们仍需要向您解释**SpotLight**节点的设置。即使您遵循了类似的布局，您为地板瓷砖选择的坐标可能差异如此之大，以至于没有简单的方法要求您将灯光放置在特定位置。因此，我们为您提供了一般和精确方向的混合。这是我们到目前为止所得到的：

![图 10.5 – 模拟洞穴中太阳的 SpotLight 节点](img/Figure_10.5_B17473.jpg)

图 10.5 – 模拟洞穴中太阳的 SpotLight 节点

前面的截图显示了**SpotLight**节点正好位于船的后面。我们选择了从上到下的视角，以便您可以看到光线从这个物体发出的距离。您在**检查器**面板中设置的**范围**和**角度**属性将配置这个光源，使其足够远和足够宽，以部分照亮入口。因此，如果您的布局需要不同的值，以便您有一个仅足够照亮的区域，如参考图片所示，您可能需要更改旋转和位置值。

如果您喜欢，您可以创建另一个**SpotLight**节点，并更改其值，就像岩石结构中有一个次要开口，让更多的光线透过来一样。一旦您弄清楚技术部分，剩下的就是您根据个人喜好来推动艺术效果，以达到您满意的结果。

到目前为止，我们一直在分析不同类型的光及其对我们关卡的影响。通常，我们期望有阴影。这些默认情况下是未启用的，所以我们将发现如何启用它们，以及如何在项目上下文中调整一些设置。

# 启用和调整阴影

在某些情况下，例如在舞台艺术中，工程师们会努力通过从多个角度投射光线来照亮舞台的某些部分，以消除阴影。这是一个极端的例子。通常，阴影是当存在附近光源时自然发生的事情。

尽管这是一种自然现象，但在计算机模拟中，仅仅因为存在光源，模拟阴影并不会自动发生。GPU 需要知道光源来自何方以及其强度如何。因此，它可以从光源照射到的物体底部开始创建一个区域，并通过将其与物体所在的表面混合，逐渐将这个区域向光源相反的方向拉伸。这就是计算机计算和模拟阴影的大致方法。

在 Godot 引擎中，光源负责其自身的阴影。这意味着阴影设置是光对象的一部分，但由于这种努力资源密集，Godot 默认将其关闭。让我们来看一个例子，看看我们如何启用它：

1.  双击 **FileSystem** 中的 `Candles_1.tscn` 项以打开它。

1.  在 **Inspector** 面板中，选择 **OmniLight** 节点并展开其 **Shadow** 部分。

1.  打开 **Enabled** 属性。

在这一点上，阴影的颜色无关紧要，但它可能是你可以在项目中调整以获得所需戏剧效果的东西。在此阶段，我们建议你打开 **Candles_2** 和 **Sconce** 场景，为它们拥有的 **OmniLight** 节点启用阴影。当你保存这三个文件并返回到 **Level-01** 场景时，你应该看到以下类似的内容：

![图 10.6 – 有阴影，就有阴影](img/Figure_10.6_B17473.jpg)

图 10.6 – 有阴影，就有阴影

注意启用阴影如何全面提升体验。柱子、板条箱和其他物体开始栩栩如生。然而，这幅画中还有一个大问题：我们还没有启用用于模拟太阳效果的 **OmniLight** 节点的阴影。继续将其阴影打开；你将看到码头如这里所示般突出：

![图 10.7 – 由于阳光的阴影效果，码头和船只看起来更加逼真](img/Figure_10.7_B17473.jpg)

图 10.7 – 由于阳光的阴影效果，码头和船只看起来更加逼真

我们正在逐渐提高关卡的画面质量。我们上次的努力引入了阴影。它们很棒，但有时它们也会产生一些缺陷。现在，让我们谈谈你可以在**检查器**面板中灯光节点的**阴影**部分找到的一些设置：

+   **偏差**：你在游戏开发中遇到的一些名字听起来很技术性，并不总是能迅速让你了解它们控制的是什么。这个确实听起来像是那种。简单来说，这个属性控制阴影相对于物体体积的起始位置。一图胜千言，所以请参考以下图表，看看不同的**偏差**值会导致什么效果：

![图 10.8 – 不同的偏差值及其效果](img/Figure_10.8_B17473.jpg)

图 10.8 – 不同的偏差值及其效果

+   **联系**：当你有一个高的**偏差**值时，它会在阴影和物体之间（如图所示）产生一个间隙，这个属性将尝试填补这个间隙。

因此，如果你因为启用阴影而出现视觉故障，这可能导致阴影不总是与物体相遇或产生自阴影问题，如图所示，我们建议你探索使用**偏差**和**联系**属性组合来调整你的灯光。

这个关卡开始看起来更有生机，多亏了灯光和阴影。然而，一切看起来还是有点太亮。如果我们能降低整体亮度就好了……我们当然可以，这就是我们接下来要探讨的。

# 创建后期处理效果

由于我们假设克拉拉正在参观一个过去有人类活动、建造了码头并在墙上挂上了壁灯的山洞，因此预期其中一些区域非常黑暗是很正常的。我们一直在放置灯光并打开阴影来提高场景的视觉保真度，但我们正在与环境作斗争；它太亮了。

在本节中，我们将研究一个有趣的 Godot 节点，它将控制环境或世界设置，以便你更好地掌握你的世界看起来如何。这种过程也被称为后期处理，因为它的效果是在直接放置的元素（如灯光、阴影、反射等）处理之后应用的。它附带了很多设置，希望我们在探索之后会变得更清晰。

一切皆节点

如果您来自 Unity，那么 Godot 使用的节点系统可能会让您感到困惑。在 Unity 中，您将脚本附加到游戏对象上以添加或控制系统的行为。节点在 Unity 中类似于脚本，但节点更加实用，因为您还可以将脚本附加到 Godot 节点上。这很方便，因为您可以将节点嵌套并组成更大的节点结构。在 Godot 中，您很可能会找到一个将执行关键任务的节点。我们本章讨论的节点就是这样一种节点。您还可以在[`docs.godotengine.org/en/3.4/getting_started/introduction/`](https://docs.godotengine.org/en/3.4/getting_started/introduction/)的*Godot 的设计哲学*部分找到更多关于使用节点的过程。

Godot 有一个巧妙的节点，**WorldEnvironment**，它负责您场景中的整体氛围。尽管节点的名称很奇特，但将其引入关卡与添加其他节点并无不同：

1.  打开`Level-01.tscn`场景。

1.  从**FileSystem**添加一个`default_env.tres`。

1.  双击**FileSystem**中的`default_env.tres`，以将它的属性填充到**Inspector**面板中。

很可能没有任何变化，但我们已经有效地创建了一个**WorldEnvironment**节点，并将其与一个环境资源关联起来。当您创建一个新的 Godot 项目时，它附带了一个默认的环境资源。我们不是创建一个新的资源，而是在整个项目文件夹中重新利用了默认环境资源。

这为您打开了不同的可能性。您的游戏可能包含不同的关卡，您希望视觉线索支持特定关卡的特性。在这种情况下，您的项目文件夹可以存储多个环境资源，并在**WorldEnvironment**节点中相应地使用它们。

虽然根据其名称，**WorldEnvironment**节点的用途可能听起来不言而喻，但要充分利用它，最好是练习使用其属性。您可以通过查看它所使用的资源属性来完成此操作。属性有很多，我们将发现与我们目标相关的那些。

## 背景

环境设置的这个部分负责模拟背景。目前，模式设置为**Sky**，因此背景被描绘成似乎有一个足够远的暗色地面部分延伸到天空。在这种模式下，您可以进一步自定义您想要描绘的天空属性。我们不会涉及这一点，因为我们正在处理一个室内场景。

因此，首先将模式更改为**Custom Color**。这将默认选择黑色，因此您场景的整个背景将变成漆黑一片。这无疑会突出蜡烛和壁灯。

如果你希望使用 Godot 引擎来捕捉模型的游戏渲染效果，那么你可以将背景设置为**清除颜色**，这将创建一个透明颜色。在我们的案例中我们没有使用它，因为一个完全黑暗的背景更适合我们的艺术需求，而且水体下面有透明度看起来有点不自然。我们可能需要在其下方再放置一个同样大小的暗色平面来隐藏透明度的影响。

因此，我们将坚持使用自定义背景颜色。这将导致以下输出：

![图 10.9 – 洞穴开始看起来更加阴森](img/Figure_10.9_B17473.jpg)

图 10.9 – 洞穴开始看起来更加阴森

在我们继续讨论**色调映射**之前，先简单讨论一下**环境光**部分。拱门似乎现在被隐藏了，因为场景中光线不足。因此，为了解决这个问题，你可以选择一个更亮的背景色。然而，这会使整个场景再次变亮，并且一些暗区会变得更亮。有一种更明智的方法可以保持暗区仍然暗，同时让光源的效果更广泛地扩散。我们将在*使用全局照明*部分稍后探讨如何实现这种两全其美的效果。

## 色调映射

这是一种你可以用来快速将光线融合到暗区中的解决方案，这将使一切看起来更加均匀。它自带一些属性：

+   **模式**：默认模式是**线性**，这就是你一直以来的体验。我们把它留给你自己决定，但我们建议你将其更改为**电影**或**ACES Fitted**。它将整个场景的色调重新映射，以至于事物开始看起来更加逼真。

+   **曝光**：与**线性**模式相比，其他模式可能会使你的场景看起来非常暗。调整**曝光**将使场景变亮，同时仍然应用色调映射。

+   **白色**：数码相机有一个与此类似的设置。你指定一个色调为白色，这样其他颜色就可以根据这个新的基线来计算。较小的值会导致整个场景过曝，因为它会开始考虑更多的颜色作为白色。自然地，较高的值会排除更多的颜色，使场景变暗。

在我们的练习中，我们不会调整**曝光**和**白色**值，但这是我们在选择**色调映射**的**ACES Fitted**后得到的结果：

![图 10.10 – 由于色调映射，一切看起来更加突出](img/Figure_10.10_B17473.jpg)

图 10.10 – 由于色调映射，一切看起来更加突出

由于我们已经提到了曝光的概念，简单地说一下启用**自动曝光**。我们不会在我们的工作中使用它，但它是一个有助于减轻你在相机在室内和室外区域之间切换时可能遇到的一些问题的有用选项。

## 屏幕空间反射（SSR）

当一些物体由于材质设置而具有反射特性时，例如**金属**、**镜面反射**和**粗糙度**，开启这个环境设置将创建更真实的效果。

要欣赏**SSR**的影响，关卡必须有更多的光源，所以当你开启它时，可能看起来变化不大。雕像的主体有一个反射材质。因此，如果你放大那个区域，你应该能够看到一些反射，在鹿的脚与底座接触的地方。

当附近有更多光源时，反射将会更加明显。当我们处理*第十二章*，*通过摄像机和角色控制器与世界交互*，以及 Clara 手持火炬走过雕像时，你可能会注意到这个效果甚至更好。在此之前，我们只需简单地启用这个功能即可。

## 环境遮挡（SSAO）

这并不是我们第一次遇到这个术语。我们第一次了解到它是在*第四章*，*调整摄像机和灯光*，当我们想要强调物体连接处的边缘时。同样，我们也会在 Godot 中开启这个设置，但我们需要调整一些属性：

+   `1.0`。

在我们当前的情况下，这似乎就像是一个开/关的开关。然而，由于它的值可以在 `0.0` 和 `1.0` 之间任意取值，你可以通过脚本控制这个值，从而将其作为一个有用的刻度。这在你不希望完全关闭遮挡，而是逐渐减少遮挡的情况下是有效的。

+   我们将值设为 `0.4`，但你可以根据你的喜好设置任何值。

此外，**强度**属性可以与**半径**一起使用，以创建更精确的遮挡。此外，借助一组额外的半径和强度，你可以叠加更多细节。

就像游戏开发中的大多数事情一样，调整正确数量的环境遮挡通常是一项艺术性的工作。使用建议的值，结果将如下：

![图 10.11 – 环境遮挡开启后的关卡](img/Figure_10.11_B17473.jpg)

图 10.11 – 环境遮挡开启后的关卡

前面的截图可能并没有充分展示我们所达到的效果。然而，如果你比较前两个截图，你可以看到砖块之间的遮挡，以及板条箱与地面接触的地方。

## 发光

这个特性在其他应用中通常被称为光晕效果。它用于夸大颜色和光源的效果。虽然它有许多属性，但我们只关注其中几个：

+   `0.2` 的值足以突出壁炉和蜡烛的效果。本质上，虽然暗区将保持相对较暗，但发光区域将会发光。

+   **混合模式**：为了进一步增强影响，我们建议您将其设置为**叠加**。由于光源是开放的火焰，这将给场景中的灯光带来非常舒适的温馨效果。

我们不会触及其余的设置。以下截图显示了级别的最终状态：

![图 10.12 – 我们的灯光在黑暗中发光](img/Figure_10.12_B17473.jpg)

图 10.12 – 我们的灯光在黑暗中发光

在**发光**设置中，有一个名为**级别**的特定部分。你可以展开该区域，并决定光晕和模糊效果会向外扩散多远。当你想要调整包围物体的光晕细节时，这很有用。

## 调整

在应用不同的环境效果时，一些特性可能会相互竞争。尽管我们为灯光增加了更多的力量，并为模型提供了更清晰的轮廓和阴影，但过了一段时间后，你可能会得到一个看起来有点褪色的场景。你将使用**调整**功能中的两个属性，这将给你的场景增添不错的触感：

+   `1.1`或`1.2`可能就足够了。

+   `1.1`将与更高的亮度一起使事物看起来更好。

我们可以永远改变这些设置中的许多设置。根据你的品味，你可能更喜欢不同的效果。然而，我们对目前所拥有的效果感到满意。

## 总结

自从我们开始铺设地板和墙面部件以来，我们级别的外观发生了巨大变化。看起来普通的砖面现在有了特色，由于灯光、阴影，最终是环境设置，场景看起来更加阴森。这在此处可以看到：

![图 10.13 – 后处理效果都已就位并协同工作](img/Figure_10.13_B17473.jpg)

图 10.13 – 后处理效果都已就位并协同工作

根据你为游戏想要营造的氛围，你可以想出不同的后处理效果组合。此外，你可以在游戏会话期间编程调整它们的值，以进一步吸引玩家。

当一个太多时

后处理效果很棒。你可能会觉得自己像在糖果店里的孩子。然而，请记住，一些效果会相互增强，而另一些则会相互超越。最终，你可能会发现太多的效果在运行，这会给你的电脑带来负担。当你的 GPU 激烈地试图冷却时，你就能听到它的代价。

尽管我们努力改善我们级别的外观，但仍有改进的空间。虽然我们明显增强了暗部和亮部区域，但场景仍然缺少行业常说的另一个现实生活质量，即全局照明。

# 使用全局照明

如果你曾经使用过数码相机，你可能已经熟悉我们将在本节中介绍的概念。通过期望和对类似环境的熟悉，我们的大脑会将光线与较暗的区域混合，并填补缺失的部分。另一方面，相机没有关于地方应该如何看起来事先的知识，并且它无法像我们的大脑那样很好地处理暗区。换句话说，人脑近似缺失的部分，并绘制出一个更完整的画面。

到目前为止，渲染引擎的工作方式就像一个相机。如果你现在查看级别，你会看到拱门处于黑暗中。如果我们将光源的强度增加，它将把光线投射得更远。然而，我们仍然会有一些区域比其他区域暗。我们需要某种东西，它能够扩展现有光源的效果，类似于我们的大脑处理光线的方式。

为了达到这个目的，我们将引入全局照明以实现更逼真的外观。通过这种方法，拱门附近的区域将看起来从附近的蜡烛和壁灯那里获得更多的光线。如果你还没有猜到，这里有一个节点来完成这项工作。让我们将其添加到我们的场景中：

1.  选择该级别的根节点。

1.  添加一个**GIProbe**节点。

1.  调整`12`、`5`和`15`。

1.  打开它的**内部**设置。

1.  将这个探测器放置在你的级别中，使其像一个信封一样包围一切。

**GIProbe**最初将类似于一个绿色的线框立方体。在你将其放置以使其围绕级别包裹后，Godot 界面将如下所示：

![图 10.14 – GIProbe 已经放置，但尚未启用](img/Figure_10.14_B17473.jpg)

图 10.14 – GIProbe 已经放置，但尚未启用

这个节点将探测其体积内的光源。然后，它将把这个信息插值到较暗的区域，以便光线可以更均匀地分布，正如我们的眼睛所期望的那样。尽管探测器已经准备好了，但在我们触发计算之前，我们需要注意两个重要的事情。

## 开启光照烘焙

我们已经看到了一些与 3D 模型相关的导入设置。例如，我们看到了材质是自动导入的，因为这是**导入**面板中的默认设置。此外，通过该面板中的**动画**部分，我们能够从模型中提取动作到文件系统。所有这些都在*第七章*，*将 Blender 资产导入 Godot*中有所涉及。

我们这次将重新访问**导入**面板以进行不同的需求。我们希望某些模型能够接收到更多的光线。因此，通过开启**光照烘焙**，一些模型将接收到由**GIProbe**发送的额外光照信息。正如其名所示，这项技术将一次将场景中的一些光线烘焙到模型的材质中。然后，当光线条件发生变化时，它将根据需要更新。

因此，我们将选择一些看起来可能从光照烘焙中受益的模型列表，因为它们具有大而连续的表面：

+   **墙面**（**墙面孔**）

+   **曲线**

+   **地板标准**（**地板标准弯曲 1**和**地板标准弯曲 4**）

+   **圆柱形**

较小的物体，如道具，通常不适合进行光照烘焙，但从技术上讲，你可以为导入的任何模型开启此设置。目前，我们将选择墙面模型并为其启用光照烘焙：

1.  在**文件系统**中选择`Wall.glb`。

1.  打开**导入**面板并向下滚动以找到**光照烘焙**选项（提示：这是**网格**部分的最后一个选项）。

1.  在**光**部分将其值改为**启用**。

1.  点击**重新导入**按钮。

1.  对其他上述模型重复此过程。

一般而言，我们正在为场景中的建筑模型启用光照烘焙。这是方程的一部分。现在我们已经配置了模型以接受光照烘焙，我们必须告诉渲染器这些模型应该烘焙多少光线到材质中。我们将通过调整我们迄今为止使用的光源的能量级别来完成这项工作。

## 调整间接能量

在拥有适当全局照明的第二大重要事情是调整光源的能量级别。尽管本节的标题表明我们将调整间接能量级别，但讨论直接能量的含义也会很有用。

在 Blender 中，你通过调整光的**功率**属性来改变光的直接能量级别，这些属性以瓦特为单位测量。这意味着你可以输入现实生活中的灯泡值以获得准确的结果。Godot 中光的能量值不遵循单位系统。因此，这更多的是一个可以根据你的场景和喜好进行调整的艺术值。

当前的**能量**属性，也称为直接能量，定义了光线的强度，而其**间接能量**值则用于计算我们在“使用全局照明”部分的起始行中描述的自然效果，其中我们对比了人眼和相机。

当环境足够黑暗时，有一种简单的方法可以在家中观察这种效果。你可以点燃一支蜡烛并观察其附近将会有一个足够照亮的区域。然后，光线将逐渐减弱至远处，但你仍然能够注意到一些远处的物体。它们的细节可能不会非常清晰，但它们最显著的外形将一目了然。使用**GIProbe**可以模拟这种类型的间接能量效果。

对于这项工作，我们必须调整我们迄今为止使用的某些**全向光**节点：

1.  打开`Sconce.tscn`并选择其**全向光**节点。

1.  在**光**部分将其值改为`2.5`。

1.  在**全向**部分将其值改为`8`。

这将增加壁灯发出的光照范围，使其能够照射得更远。**1.0**的能量级别已经被使用，因此我们只调整间接能量，因为我们希望它对全局照明做出贡献。

让我们为蜡烛使用不同的值重复这一努力：

1.  打开`Candles_1.tscn`和`Candles_2.tscn`文件，并选择它们的**OmniLight**节点。

1.  将`1.5`和`3`进行更改。

与壁灯相比，蜡烛不应该发出那么多的光。因此，设置较低的值是有意义的。然而，由于不是单独的一支蜡烛，而是一组蜡烛，所以这些值并没有相差太远。这也是你在工作中可能需要平衡的事情：艺术关注与现实主义的平衡。

我们已经为**GIProbe**执行其任务而设置了各项配置。看起来我们增加了场景的整体光照。我们需要这样做，因为其中一些额外的光照将用于计算更好的光照分布。剩下要做的就是触发**GIProbe**：

1.  在**场景**树中选择**GIProbe**。

1.  点击 3D 视图上方标题栏中的**烘焙 GI 探测**按钮。

Godot 引擎将计算你为启用了光照烘焙的模型计算的光线如何从表面反弹。根据光线的强度、范围和间接能量，较暗的区域将接收到更多的光照。这将导致更均匀的分布，并给出符合我们期望的更逼真的外观。*图 10.15*显示了全局照明对拱门附近区域的影响前后对比：

![图 10.15 – 由于光照分布更加均匀，门变得更加显眼](img/Figure_10.15_B17473.jpg)

图 10.15 – 由于光照分布更加均匀，门变得更加显眼

根据你关卡的大小和布局，你可能需要放置多个**GIProbe**节点。例如，如果你正在设计一个有许多房间和走廊的地牢，将每个房间和走廊视为一个独特的**GIProbe**节点可能是个更好的主意，因为这样可以达到更准确的光照分布。

此外，当你有一个户外环境与室内环境相连的场景时，为每个区域创建一个**GIProbe**并相应调整**Interior**设置是个好主意。使用一个涵盖整个关卡的主要节点会对任何环境都不公平，因此引入尽可能少，有时甚至需要尽可能多的节点。

这样一来，我们提升了我们的关卡外观。让我们总结一下我们为了达到这个效果所采取的步骤。

# 概述

我们从上一章继承的这个关卡看起来很完整，但缺乏趣味。为了给它增添更多活力，我们在本章引入了一些乐器。

首先，我们介绍了两种灯光节点类型，**OmniLight**和**SpotLight**，以模拟蜡烛、壁灯和洞穴中太阳的效果。在完成这项任务的同时，你也看到了为什么为模型创建场景可能比直接在级别中实例化模型更有用，也是必要的。随后，我们添加了一个小脚本，可以帮助你在需要时切换灯光。我们将在本书的后续部分利用这一功能。

虽然灯光是改善视觉效果的一个明显工具，但我们还研究了阴影。它们资源密集，因此你可能只想为那些将对你的场景产生重要影响的灯光打开它们。

为了真正欣赏灯光和阴影的效果，我们应用了一系列环境设置。尽管这极大地帮助了视觉效果，但要将现实感提升到下一个层次，你已经接触到了全局照明。通过仔细选择哪些模型应该接收更多间接光，并调整场景中灯光的设置，你使某些区域更加明亮，从而实现了更精确的表示。

在下一章中，我们将处理不同类型的视觉系统。这是一个玩家可以与之交互的有用机制：用户界面。

# 进一步阅读

在本章所讨论的所有主题中，全局照明是最技术性的一个。模拟现实生活中的光是一个具有挑战性的任务，而且专业人士仍在积极努力实现这一目标。如果你想尝尝味道，以下是一些应该能给你一个更好了解它所涉及内容的链接：

+   [`ohiostate.pressbooks.pub/graphicshistory/chapter/19-5-global-illumination/`](https://ohiostate.pressbooks.pub/graphicshistory/chapter/19-5-global-illumination/)

+   [`www.scratchapixel.com/lessons/3d-basic-rendering/global-illumination-path-tracing`](https://www.scratchapixel.com/lessons/3d-basic-rendering/global-illumination-path-tracing)

+   [`developer.nvidia.com/gpugems/gpugems2/part-v-image-oriented-computing/chapter-38-high-quality-global-illumination`](https://developer.nvidia.com/gpugems/gpugems2/part-v-image-oriented-computing/chapter-38-high-quality-global-illumination%20)

在更实际一点的情况下，如果你希望了解更多关于本章所涵盖的内容，官方的 Godot 文档可能很有用：

+   [`docs.godotengine.org/en/3.4/tutorials/3d/lights_and_shadows.xhtml`](https://docs.godotengine.org/en/3.4/tutorials/3d/lights_and_shadows.xhtml)

+   [`docs.godotengine.org/en/3.4/tutorials/3d/environment_and_post_processing.xhtml`](https://docs.godotengine.org/en/3.4/tutorials/3d/environment_and_post_processing.xhtml)

+   [`docs.godotengine.org/en/3.4/tutorials/3d/gi_probes.xhtml`](https://docs.godotengine.org/en/3.4/tutorials/3d/gi_probes.xhtml)
