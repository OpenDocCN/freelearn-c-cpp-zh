# 前言

**低级虚拟机**（**LLVM**）是一组模块化和可重用的编译器和工具链技术，用于开发编译器和编译工具，如代码检查器和重构工具。LLVM 用 C++ 编写，可以被认为是使用有趣技术使其可重用和高效的优秀项目示例。该项目也可以被认为是编译器架构的优秀示例；深入了解它将让你了解编译器是如何组织和工作的。这应该有助于理解使用模式并相应地应用它们。

LLVM 的一个关键组件是名为 Clang 的 C/C++ 编译器。这个编译器在各种公司中被广泛使用，并被指定为某些开发环境的默认编译器，特别是在 macOS 开发中。Clang 将是我们这本书的主要研究对象，特别关注其前端——即最接近 C/C++ 编程语言的部分。具体来说，本书将包括一些示例，展示 C++ 标准如何在编译器中实现。

LLVM 设计的一个关键方面是其模块化，这有助于创建利用编译器全面功能的自定义工具。本书中涵盖的一个显著例子是 Clang-Tidy 代码检查框架，旨在识别不希望的代码模式并推荐修正。尽管它包括数百个检查，但你可能找不到一个专门针对你项目需求的检查。然而，本书将为你提供从零开始开发此类检查所需的基础。

LLVM 是一个每年有两个主要版本发布的活跃项目。在本书编写时，最新的稳定版本是 17 版。同时，18 版本的候选发布版在 2024 年 1 月推出，预计其正式发布将与本书的出版同步。本书的内容已与最新的编译器版本 18 进行了验证，确保它基于最先进的编译器实现提供见解。

### 本书面向的对象

本书是为那些没有编译器知识但希望获得这种知识并将其应用于日常活动的 C++ 工程师编写的。它提供了 Clang 编译器前端概述，这是 LLVM 的一个基本但常被低估的部分。这个编译器部分，连同一系列强大的工具，使程序员能够提高代码质量和整体开发过程。例如，Clang-Tidy 提供了超过 500 种不同的 lint 检查，用于检测代码中的反模式（如移动后的使用）并帮助维护代码风格和标准。另一个值得注意的工具是 Clang-Format，它允许指定适合您项目的各种格式化规则。这些工具也可以被认为是开发过程的一个组成部分。例如，语言服务器（Clangd）是一个关键服务，为您的 IDE 提供导航和重构支持。

理解编译器内部结构可能对任何想要创建和使用此类工具的人来说至关重要。本书提供了开始这段旅程所需的必要基础，涵盖了基本的 LLVM 架构，并详细描述了 Clang 的内部结构。它包括来自 LLVM 源代码和扩展编译器基本功能的自定义工具的示例。此外，本书还讨论了编译数据库和可以增强项目构建速度的各种性能优化。这些知识应有助于 C++ 开发者正确地将编译器应用于他们的工作活动中。

### 本书涵盖的内容

*第一章**，环境设置*，描述了为未来使用 Clang 进行实验所需的基本步骤，适用于基于 Unix 的系统，如 Linux 和 Darwin（macOS）。此外，读者还将学习如何下载、配置和构建 LLVM 源代码。我们还将创建一个简单的 Clang 工具来验证提供的源代码的语法。

*第二章**，Clang 架构*，探讨了 Clang 编译器的内部架构。从编译器的基本概念开始，我们将探讨它在 Clang 中的实现方式。我们将查看编译器的各个部分，包括驱动程序、预处理器（词法分析器）和解析器。我们还将检查示例，展示 C++ 标准如何在 Clang 中实现。

*第三章**，Clang 抽象语法树*，讨论了 **Clang 抽象语法树 (AST)**，这是解析器产生的基

*第四章**，基本库和工具*，探讨了基本 LLVM 库和工具，包括跨所有 LLVM 代码使用的 LLVM **抽象数据类型 (ADT**) 库。我们将研究 TableGen，这是一种用于在 LLVM 的各个部分生成 C++ 代码的 **领域特定语言 (DSL**)。此外，我们还将探索 **LLVM 集成测试器 (LIT**) 工具，它用于创建强大的端到端测试。利用所获得的知识，我们将创建一个简单的 Clang 插件来估计源代码的复杂性。

*第五章**，Clang-Tidy 检查框架*，涵盖了基于 Clang AST 的 Clang-Tidy 检查框架，并创建了一个简单的 Clang-Tidy 检查。我们还将讨论编译错误如何影响 AST 以及不同 Clang 工具（如 Clang-Tidy）提供的结果。

*第六章**，高级代码分析*，进一步考虑了另一种用于代码分析的高级数据结构：**控制流图 (CFG**)。我们将研究其应用的典型情况，并创建一个简单的 Clang-Tidy 检查，利用这种数据结构。

*第七章**，重构工具*，Clang 提供了用于代码修改和重构的高级工具。我们将探索创建自定义重构工具的不同方法，包括基于 Clang-Tidy 检查框架的一个。我们还将探索 Clang-Format，这是一个用于自动代码格式化的极快实用工具。

*第八章**，IDE 支持 和 Clangd*，介绍了 Clangd——一种在诸如 **Visual Studio Code (VS Code**) 等各种 IDE 中使用的语言服务器，用于提供智能支持，包括导航和代码修改。Clangd 展示了 LLVM 强大的模块化架构的实用性。它利用了各种 Clang 工具，如 Clang-Tidy 和 Clang-Format，以增强 VS Code 中的开发体验。编译器性能对于这个工具至关重要，我们将探讨 Clangd 使用的几种提高其性能的技术，从而为开发者提供最佳体验。

*附录 1：编译数据库*，描述了编译数据库——一种向不同的 Clang 工具提供复杂编译命令的方法。这种功能对于将 Clang 工具（如 Clangd 和 Clang-Tidy）集成到实际的 C/C++ 项目中至关重要。

*附录 2：构建速度优化*，涵盖了几个编译器性能优化，这些优化可以用来提高编译器的性能。我们将介绍 Clang 预编译头和 Clang 模块，它们代表了一种序列化的抽象语法树（AST），可以比从头开始构建快得多。

### 为了充分利用这本书

您需要了解 C++，特别是 C++17，这是用于 LLVM 以及本书中的示例的。提供的示例假定在类 Unix 操作系统上运行，Linux 和 Darwin（Mac OS）被视为本书的操作系要求。我们将使用 Git 来克隆 LLVM 源代码树并开始工作。还需要安装一些工具，例如 CMake 和 Ninja，这些工具将用于构建示例和 LLVM 源代码。

**如果您正在使用本书的数字版，我们建议您** **亲自输入代码或从本书的 GitHub** **仓库（下一节中有一个链接）访问代码。这样做将** **帮助您避免与代码的复制和粘贴相关的任何潜在错误。**

### 下载示例代码文件

书籍的代码包也托管在 GitHub 上，地址为 [`github.com/PacktPublishing/Clang-Compiler-Frontend-Packt`](https://github.com/PacktPublishing/Clang-Compiler-Frontend-Packt)。如果代码有更新，它将在现有的 GitHub 仓库中更新。

我们还有其他来自我们丰富的图书和视频目录的代码包可供使用，请访问[`github.com/PacktPublishing/`](https://github.com/PacktPublishing/)。查看它们！

### 使用的约定

本书使用了多种文本约定。

`CodeInText`：表示文本中的代码单词、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟 URL 和用户输入。以下是一个示例：“前两个参数指定声明（`clang::Decl`）和声明语句（`clang::Stmt`）。”

代码块设置如下：

```cpp
1 int main() { 
2   return 0; 
3 }
```

任何命令行输入或输出都应如下编写：

```cpp
$ ninja clang
```

我们使用 `<...>` 作为克隆 LLVM 源代码的文件夹占位符。

一些代码示例将表示 shell 的输入。您可以通过特定的提示字符来识别它们：

+   `(``lldb``)` 用于交互式 LLDB shell

+   `$` 用于 Bash shell（macOS 和 Linux）

+   `>` 用于由不同的 Clang 工具提供的交互式 shell，例如 Clang-Query

重要提示

警告或重要提示如下所示。

小贴士

技巧和窍门如下所示。

### 联系我们

我们欢迎读者的反馈。

**一般反馈**：如果您对本书的任何方面有疑问，请在邮件主题中提及书名，并给我们发送电子邮件至 customercare@packtpub.com。

**勘误表**：尽管我们已经尽最大努力确保内容的准确性，但错误仍然可能发生。如果您在这本书中发现了错误，如果您能向我们报告，我们将不胜感激。请访问[`www.packtpub.com/support/errata`](https://www.packtpub.com/support/errata)，选择您的书籍，点击勘误提交表单链接，并输入详细信息。

**盗版**: 如果你在网上以任何形式遇到我们作品的非法副本，我们将非常感激如果你能提供位置地址或网站名称。请通过版权@packt.com 与我们联系，并提供材料的链接。

**如果你有兴趣成为作者**: 如果你有一个你擅长的主题，并且你感兴趣的是撰写或为书籍做出贡献，请访问[`partnerships.packt.com/contributors/`](https://partnerships.packt.com/contributors/)。

### 分享你的想法

一旦你阅读了*Clang 编译器前端*，我们很乐意听到你的想法！请[点击此处直接跳转到这本书的亚马逊评论页面](https://packt.link/r/1837630984)并分享你的反馈。

你的评论对我们和科技社区都很重要，并将帮助我们确保我们提供高质量的内容。

### 下载这本书的免费 PDF 副本

感谢购买这本书！

你喜欢在旅途中阅读，但无法携带你的印刷书籍到处走吗？你的电子书购买是否与你的选择设备不兼容？

别担心，现在每购买一本 Packt 书籍，你都可以免费获得该书的 DRM 免费 PDF 版本。

在任何地方、任何时间、任何设备上阅读。直接从你最喜欢的技术书籍中搜索、复制和粘贴代码到你的应用程序中。

优惠并未停止，你还可以获得独家折扣、时事通讯和丰富的免费内容，每天直接发送到你的邮箱。

按照以下简单步骤获取福利：

1.  扫描下面的二维码或访问以下链接：

    ![PIC](img/free_ebook_qr.png)

    [`download.packt.com/free-ebook/9781837630981`](https://download.packt.com/free-ebook/9781837630981)

1.  提交你的购买证明。

1.  就这样！我们将直接将你的免费 PDF 和其他福利发送到你的邮箱。
