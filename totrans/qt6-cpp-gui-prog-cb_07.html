<html><head></head><body>
<div id="_idContainer120">
<h1 class="chapter-number" id="_idParaDest-158"><a id="_idTextAnchor158"/><span class="koboSpan" id="kobo.1.1">7</span></h1>
<h1 id="_idParaDest-159"><a id="_idTextAnchor159"/><span class="koboSpan" id="kobo.2.1">Using Network and Managing Large Documents</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In this chapter, we will learn how to create a networking server program and a client program using Qt 6’s networking module. </span><span class="koboSpan" id="kobo.3.2">We will also learn how to create a program that uses </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">File Transfer Protocol</span></strong><span class="koboSpan" id="kobo.5.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.6.1">FTP</span></strong><span class="koboSpan" id="kobo.7.1">) to upload and download files from the server. </span><span class="koboSpan" id="kobo.7.2">Lastly, we will learn how to send HTTP requests to a specific web service using Qt 6 and </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">C++ language.</span></span></p>
<p><span class="koboSpan" id="kobo.9.1">In this chapter, we’re going to cover the following </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">main topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.11.1">Creating a </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">TCP server</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">Creating a </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">TCP client</span></span></li>
<li><span class="koboSpan" id="kobo.15.1">Uploading and downloading files </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">using FTP</span></span></li>
</ul>
<h1 id="_idParaDest-160"><a id="_idTextAnchor160"/><span class="koboSpan" id="kobo.17.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.18.1">The technical requirements for this chapter are Qt 6.6.1, Qt Creator 12.0.2, and FileZilla. </span><span class="koboSpan" id="kobo.18.2">All the code used in this chapter can be downloaded from the following GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">repository: </span></span><a href="https://github.com/PacktPublishing/QT6-C-GUI-Programming-Cookbook---Third-Edition-/tree/main/Chapter07"><span class="No-Break"><span class="koboSpan" id="kobo.20.1">https://github.com/PacktPublishing/QT6-C-GUI-Programming-Cookbook---Third-Edition-/tree/main/Chapter07</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.21.1">.</span></span></p>
<h1 id="_idParaDest-161"><a id="_idTextAnchor161"/><span class="koboSpan" id="kobo.22.1">Creating a TCP server</span></h1>
<p><span class="koboSpan" id="kobo.23.1">In this recipe, we</span><a id="_idIndexMarker462"/><span class="koboSpan" id="kobo.24.1"> will learn how to create a </span><strong class="bold"><span class="koboSpan" id="kobo.25.1">Transmission Control Protocol</span></strong><span class="koboSpan" id="kobo.26.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.27.1">TCP</span></strong><span class="koboSpan" id="kobo.28.1">) server in Qt 6. </span><span class="koboSpan" id="kobo.28.2">Before we’re able to </span><a id="_idIndexMarker463"/><span class="koboSpan" id="kobo.29.1">create a server that lets us upload and download files, let’s scale it down a bit and learn how to create a networking server that receives and </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">delivers texts.</span></span></p>
<h2 id="_idParaDest-162"><a id="_idTextAnchor162"/><span class="koboSpan" id="kobo.31.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.32.1">Follow these steps to create a </span><span class="No-Break"><span class="koboSpan" id="kobo.33.1">TCP server:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.34.1">First, let’s create a </span><strong class="bold"><span class="koboSpan" id="kobo.35.1">Qt Console Application</span></strong><span class="koboSpan" id="kobo.36.1"> project from </span><strong class="bold"><span class="koboSpan" id="kobo.37.1">File</span></strong><span class="koboSpan" id="kobo.38.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.39.1">New File or Project</span></strong><span class="koboSpan" id="kobo.40.1">, as shown in the</span><a id="_idIndexMarker464"/> <span class="No-Break"><span class="koboSpan" id="kobo.41.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer104">
<span class="koboSpan" id="kobo.42.1"><img alt="Figure 7.1 – Creating a new Qt Console Application project" src="image/B20976_07_001.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.43.1">Figure 7.1 – Creating a new Qt Console Application project</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.44.1">After that, go to </span><strong class="bold"><span class="koboSpan" id="kobo.45.1">File</span></strong><span class="koboSpan" id="kobo.46.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.47.1">New File or Project</span></strong><span class="koboSpan" id="kobo.48.1"> again but this time, select </span><strong class="bold"><span class="koboSpan" id="kobo.49.1">C++ Class</span></strong><span class="koboSpan" id="kobo.50.1"> under the </span><strong class="bold"><span class="koboSpan" id="kobo.51.1">C/C++</span></strong><span class="koboSpan" id="kobo.52.1"> category, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.53.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer105">
<span class="koboSpan" id="kobo.54.1"><img alt="Figure 7.2 – Creating a new C++ class" src="image/B20976_07_002.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.55.1">Figure 7.2 – Creating a new C++ class</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.56.1">Then, name your class </span><strong class="source-inline"><span class="koboSpan" id="kobo.57.1">server</span></strong><span class="koboSpan" id="kobo.58.1">. </span><span class="koboSpan" id="kobo.58.2">Set its base class to </span><strong class="bold"><span class="koboSpan" id="kobo.59.1">QObject</span></strong><span class="koboSpan" id="kobo.60.1"> and make sure the </span><strong class="bold"><span class="koboSpan" id="kobo.61.1">Include QObject</span></strong><span class="koboSpan" id="kobo.62.1"> option is </span><a id="_idIndexMarker465"/><span class="koboSpan" id="kobo.63.1">checked before clicking the </span><strong class="bold"><span class="koboSpan" id="kobo.64.1">Next</span></strong><span class="koboSpan" id="kobo.65.1"> button. </span><span class="koboSpan" id="kobo.65.2">Once the class has been created, two files will be created for you—</span><strong class="source-inline"><span class="koboSpan" id="kobo.66.1">server.h</span></strong><span class="koboSpan" id="kobo.67.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.68.1">server.cpp</span></strong><span class="koboSpan" id="kobo.69.1">, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.70.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer106">
<span class="koboSpan" id="kobo.71.1"><img alt="Figure 7.3 – Defining the server class" src="image/B20976_07_003.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.72.1">Figure 7.3 – Defining the server class</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.73.1">After that, open up your project file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.74.1">.pro</span></strong><span class="koboSpan" id="kobo.75.1">) and add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.76.1">network</span></strong><span class="koboSpan" id="kobo.77.1"> module, as shown in the</span><a id="_idIndexMarker466"/><span class="koboSpan" id="kobo.78.1"> following code. </span><span class="koboSpan" id="kobo.78.2">Then, run </span><strong class="source-inline"><span class="koboSpan" id="kobo.79.1">qmake</span></strong><span class="koboSpan" id="kobo.80.1"> again to reload </span><span class="No-Break"><span class="koboSpan" id="kobo.81.1">the modules:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.82.1">
QT += core </span><strong class="bold"><span class="koboSpan" id="kobo.83.1">network</span></strong></pre></li> <li><span class="koboSpan" id="kobo.84.1">Once you’re done, open up </span><strong class="source-inline"><span class="koboSpan" id="kobo.85.1">server.h</span></strong><span class="koboSpan" id="kobo.86.1"> and add the following headers </span><span class="No-Break"><span class="koboSpan" id="kobo.87.1">to it:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.88.1">
#include &lt;QTcpServer&gt;
#include &lt;QTcpSocket&gt;
#include &lt;QVector&gt;
#include &lt;QDebug&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.89.1">Right after that, declare the </span><strong class="source-inline"><span class="koboSpan" id="kobo.90.1">startServer()</span></strong><span class="koboSpan" id="kobo.91.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.92.1">sendMessageToClients()</span></strong><span class="koboSpan" id="kobo.93.1"> functions, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.94.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.95.1">
public:
      server(QObject *parent = nullptr);
      </span><strong class="bold"><span class="koboSpan" id="kobo.96.1">void startServer();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.97.1">      void sendMessageToClients(QString message);</span></strong></pre></li> <li><span class="koboSpan" id="kobo.98.1">Then, declare the</span><a id="_idIndexMarker467"/><span class="koboSpan" id="kobo.99.1"> following slot functions for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.100.1">server</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.101.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.102.1">
public slots:
     void newClientConnection();
     void socketDisconnected();
     void socketReadReady();
     void socketStateChanged(QAbstractSocket::SocketState state);</span></pre></li> <li><span class="koboSpan" id="kobo.103.1">Finally, declare two private variables, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.104.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.105.1">
private:
     QTcpServer* chatServer;
     QVector&lt;QTcpSocket*&gt;* allClients;</span></pre></li> <li><span class="koboSpan" id="kobo.106.1">Once you’re done with the preceding step, open up </span><strong class="source-inline"><span class="koboSpan" id="kobo.107.1">server.cpp</span></strong><span class="koboSpan" id="kobo.108.1"> and define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.109.1">startServer()</span></strong><span class="koboSpan" id="kobo.110.1"> function. </span><span class="koboSpan" id="kobo.110.2">Here, we create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.111.1">QVector</span></strong><span class="koboSpan" id="kobo.112.1"> container to store all the clients that are connected to the server and use it to send out messages in later steps. </span><span class="koboSpan" id="kobo.112.2">This is shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.113.1">following example:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.114.1">
void server::startServer() {
     allClients = new QVector&lt;QTcpSocket*&gt;;
     chatServer = new QTcpServer();
     chatServer-&gt;setMaxPendingConnections(10);
     connect(chatServer, &amp;QTcpServer::newConnection,      this, &amp;server::newClientConnection);
if (chatServer-&gt;listen(QHostAddress::Any, 8001))
     qDebug() &lt;&lt; "Server has started. </span><span class="koboSpan" id="kobo.114.2">Listening to port     8001.";
else
     qDebug() &lt;&lt; "Server failed to start. </span><span class="koboSpan" id="kobo.114.3">Error: " +   chatServer-&gt;errorString();
}</span></pre></li> <li><span class="koboSpan" id="kobo.115.1">Next, we implement</span><a id="_idIndexMarker468"/><span class="koboSpan" id="kobo.116.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.117.1">sendMessageToClients()</span></strong><span class="koboSpan" id="kobo.118.1"> function, where we iterate through the </span><strong class="source-inline"><span class="koboSpan" id="kobo.119.1">allClients</span></strong><span class="koboSpan" id="kobo.120.1"> container we just created in the previous step, and send the message to each client, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.121.1">following example:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.122.1">
void server::sendMessageToClients(QString message) {
if (allClients-&gt;size() &gt; 0) {
     for (int i = 0; i &lt; allClients-&gt;size(); i++) {
     if (allClients-&gt;at(i)-&gt;isOpen() &amp;&amp; allClients-   &gt;at(i)-&gt;isWritable()) {
     allClients-&gt;at(i)-&gt;write(message.toUtf8());
}
}}}</span></pre></li> <li><span class="koboSpan" id="kobo.123.1">After that, we will start implementing the slot functions. </span><span class="koboSpan" id="kobo.123.2">Let’s start with the </span><span class="No-Break"><span class="koboSpan" id="kobo.124.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.125.1">
void server::newClientConnection() {
     QTcpSocket* client = chatServer-&gt;nextPendingConnection();
     QString ipAddress = client-&gt;peerAddress().toString();
     int port = client-&gt;peerPort();
     connect(client, &amp;QTcpSocket::disconnected, this, &amp;server::socketDisconnected);
     connect(client, &amp;QTcpSocket::readyRead,this, &amp;server::socketReadReady);
     connect(client, &amp;QTcpSocket::stateChanged, this, &amp;server::socketStateChanged);
     allClients-&gt;push_back(client);
     qDebug() &lt;&lt; "Socket connected from " + ipAddress + ":" + QString::number(port);
}</span></pre></li> <li><span class="koboSpan" id="kobo.126.1">Then, we’ll </span><a id="_idIndexMarker469"/><span class="koboSpan" id="kobo.127.1">proceed with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.128.1">socketDisconnected()</span></strong><span class="koboSpan" id="kobo.129.1"> function. </span><span class="koboSpan" id="kobo.129.2">This slot function will be called when a client has been disconnected from the server, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.130.1">following example:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.131.1">
void server::socketDisconnected() {
     QTcpSocket* client = qobject_cast&lt;QTcpSocket*&gt;(QObject::sender());
     QString socketIpAddress = client-&gt;peerAddress().toString();
     int port = client-&gt;peerPort();
     qDebug() &lt;&lt; "Socket disconnected from " + socketIpAddress + ":" + QString::number(port);
}</span></pre></li> <li><span class="koboSpan" id="kobo.132.1">Next, we’ll define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.133.1">socketReadReady()</span></strong><span class="koboSpan" id="kobo.134.1"> function, which will be triggered when a client sends a text message to the server, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.135.1">following example:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.136.1">
void server::socketReadReady() {
     QTcpSocket* client = qobject_cast&lt;QTcpSocket*&gt;(QObject::sender());
     QString socketIpAddress = client-&gt;peerAddress().toString();
     int port = client-&gt;peerPort();
     QString data = QString(client-&gt;readAll());
     qDebug() &lt;&lt; "Message: " + data + " (" + socketIpAddress + ":" + QString::number(port) + ")";
     sendMessageToClients(data);
}</span></pre></li> <li><span class="koboSpan" id="kobo.137.1">After that, let’s</span><a id="_idIndexMarker470"/><span class="koboSpan" id="kobo.138.1"> implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.139.1">socketStateChanged()</span></strong><span class="koboSpan" id="kobo.140.1"> function, which will be called when the networking state of a client has changed, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.141.1">following example:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.142.1">
void server::socketStateChanged(QAbstractSocket::SocketState state) {
     QTcpSocket* client = qobject_cast&lt;QTcpSocket*&gt;(QObject::sender());
     QString socketIpAddress = client-&gt;peerAddress().toString();
     int port = client-&gt;peerPort();
     qDebug() &lt;&lt; "Socket state changed (" + socketIpAddress + ":" + QString::number(port) + "): " + desc;
}</span></pre></li> <li><span class="koboSpan" id="kobo.143.1">We also need to add the following code into </span><strong class="source-inline"><span class="koboSpan" id="kobo.144.1">socketStateChanged()</span></strong><span class="koboSpan" id="kobo.145.1"> to print out the status of </span><span class="No-Break"><span class="koboSpan" id="kobo.146.1">the client:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.147.1">
     QString desc;
     if (state == QAbstractSocket::UnconnectedState)
           desc = "The socket is not connected.";
     else if (state == QAbstractSocket::HostLookupState)
           desc = "The socket is performing a host name lookup.";
     else if (state == QAbstractSocket::ConnectingState)
           desc = "The socket has started establishing a connection.";
     else if (state == QAbstractSocket::ConnectedState)
           desc = "A connection is established.";
     else if (state == QAbstractSocket::BoundState)
           desc = "The socket is bound to an address and port.";
     else if (state == QAbstractSocket::ClosingState)
           desc = "The socket is about to close (data may still be waiting to be written).";
     else if (state == QAbstractSocket::ListeningState)
           desc = "For internal use only.";</span></pre></li> <li><span class="koboSpan" id="kobo.148.1">Lastly, let’s open up </span><strong class="source-inline"><span class="koboSpan" id="kobo.149.1">main.cpp</span></strong><span class="koboSpan" id="kobo.150.1"> and add the highlighted code in the following example in order to </span><a id="_idIndexMarker471"/><span class="koboSpan" id="kobo.151.1">initiate </span><span class="No-Break"><span class="koboSpan" id="kobo.152.1">the server:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.153.1">
#include &lt;QCoreApplication&gt;
#include "server.h"
     int main(int argc, char *argv[]) {
     QCoreApplication a(argc, argv);
     </span><strong class="bold"><span class="koboSpan" id="kobo.154.1">server* myServer = new server();</span></strong><span class="koboSpan" id="kobo.155.1">
     </span><strong class="bold"><span class="koboSpan" id="kobo.156.1">myServer-&gt;startServer();</span></strong><span class="koboSpan" id="kobo.157.1">
     return a.exec();
}</span></pre></li> <li><span class="koboSpan" id="kobo.158.1">You can try and run the server program now but you won’t be able to test it as we have not created the client program yet, as the following </span><span class="No-Break"><span class="koboSpan" id="kobo.159.1">screenshot shows:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer107">
<span class="koboSpan" id="kobo.160.1"><img alt="Figure 7.4 – Server is now listening to port 8001" src="image/B20976_07_004.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.161.1">Figure 7.4 – Server is now listening to port 8001</span></p>
<ol>
<li value="18"><span class="koboSpan" id="kobo.162.1">Let’s proceed to the next example project and learn how to create the client program. </span><span class="koboSpan" id="kobo.162.2">We will </span><a id="_idIndexMarker472"/><span class="koboSpan" id="kobo.163.1">come back to test this program again </span><span class="No-Break"><span class="koboSpan" id="kobo.164.1">later on.</span></span></li>
</ol>
<h2 id="_idParaDest-163"><a id="_idTextAnchor163"/><span class="koboSpan" id="kobo.165.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.166.1">There are mainly two types of network connections—the TCP connection and the </span><strong class="bold"><span class="koboSpan" id="kobo.167.1">User Datagram Protocol</span></strong><span class="koboSpan" id="kobo.168.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.169.1">UDP</span></strong><span class="koboSpan" id="kobo.170.1">) connection. </span><span class="koboSpan" id="kobo.170.2">TCP is </span><a id="_idIndexMarker473"/><span class="koboSpan" id="kobo.171.1">a reliable networking connection, while UDP </span><span class="No-Break"><span class="koboSpan" id="kobo.172.1">is unreliable.</span></span></p>
<p><span class="koboSpan" id="kobo.173.1">These two connections are designed for very </span><span class="No-Break"><span class="koboSpan" id="kobo.174.1">different purposes:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.175.1">TCP networking is usually for programs that require every single piece of data to be sent and received in order. </span><span class="koboSpan" id="kobo.175.2">It also makes sure that the client receives the data and that the server gets notified of that. </span><span class="koboSpan" id="kobo.175.3">Programs such as messaging software, web servers, and databases use </span><span class="No-Break"><span class="koboSpan" id="kobo.176.1">TCP networking.</span></span></li>
<li><span class="koboSpan" id="kobo.177.1">UDP networking, on the other hand, does not require constant handholding between the server and client. </span><span class="koboSpan" id="kobo.177.2">Since the connection is unreliable, there is also no feedback on whether the data has been successfully received. </span><span class="koboSpan" id="kobo.177.3">The dropping of packets is tolerated, and data may not even come in the same order as it was sent. </span><span class="koboSpan" id="kobo.177.4">UDP connections are usually used by applications that stream huge amounts of data to their clients without strict requirements on its packet delivery, such as video games, video conferencing software, and domain </span><span class="No-Break"><span class="koboSpan" id="kobo.178.1">name systems.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.179.1">Creating networking software using Qt 6 is a lot easier through its signals and slots mechanism. </span><span class="koboSpan" id="kobo.179.2">All we need to do is connect the signals emitted by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.180.1">QTcpServer</span></strong><span class="koboSpan" id="kobo.181.1"> class and </span><strong class="source-inline"><span class="koboSpan" id="kobo.182.1">QTcpSocket</span></strong><span class="koboSpan" id="kobo.183.1"> class to our slot functions. </span><span class="koboSpan" id="kobo.183.2">We will then implement these slot functions and define what to do within </span><span class="No-Break"><span class="koboSpan" id="kobo.184.1">those functions.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.185.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.186.1">We used a </span><strong class="source-inline"><span class="koboSpan" id="kobo.187.1">QVector</span></strong><span class="koboSpan" id="kobo.188.1"> container to store the pointers to all the clients that have connected to the server so that we can use it to deliver the messages </span><span class="No-Break"><span class="koboSpan" id="kobo.189.1">later on.</span></span></p>
<p><span class="koboSpan" id="kobo.190.1">To keep this example</span><a id="_idIndexMarker474"/><span class="koboSpan" id="kobo.191.1"> project simple, we simply send text messages to all the clients, sort of like a group chat. </span><span class="koboSpan" id="kobo.191.2">You are free to explore other possibilities and make your own changes to improve </span><span class="No-Break"><span class="koboSpan" id="kobo.192.1">the program.</span></span></p>
<h1 id="_idParaDest-164"><a id="_idTextAnchor164"/><span class="koboSpan" id="kobo.193.1">Creating a TCP client</span></h1>
<p><span class="koboSpan" id="kobo.194.1">Since we created a TCP server in the previous recipe, we now need a client program to complete the project. </span><span class="koboSpan" id="kobo.194.2">Therefore, in this </span><a id="_idIndexMarker475"/><span class="koboSpan" id="kobo.195.1">recipe, we will learn how to create a TCP client program using Qt 6 and its </span><span class="No-Break"><span class="koboSpan" id="kobo.196.1">network module.</span></span></p>
<h2 id="_idParaDest-165"><a id="_idTextAnchor165"/><span class="koboSpan" id="kobo.197.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.198.1">To create a TCP client in Qt 6, let’s do </span><span class="No-Break"><span class="koboSpan" id="kobo.199.1">the following:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.200.1">First off, let’s create a new </span><strong class="bold"><span class="koboSpan" id="kobo.201.1">Qt Widgets Application</span></strong><span class="koboSpan" id="kobo.202.1"> project from </span><strong class="bold"><span class="koboSpan" id="kobo.203.1">Files</span></strong><span class="koboSpan" id="kobo.204.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.205.1">New File </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.206.1">or Project</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.207.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.208.1">Once the project has been created, let’s open up </span><strong class="source-inline"><span class="koboSpan" id="kobo.209.1">mainwindow.ui</span></strong><span class="koboSpan" id="kobo.210.1"> and set up the GUI as shown in the following diagram. </span><span class="koboSpan" id="kobo.210.2">Please note that the layout direction of the central widget has to </span><span class="No-Break"><span class="koboSpan" id="kobo.211.1">be vertical:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer108">
<span class="koboSpan" id="kobo.212.1"><img alt="Figure 7.5 – The layout of our client program" src="image/B20976_07_005.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.213.1">Figure 7.5 – The layout of our client program</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.214.1">Then, right-click on the push button that says </span><strong class="bold"><span class="koboSpan" id="kobo.215.1">Connect</span></strong><span class="koboSpan" id="kobo.216.1"> and create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.217.1">clicked()</span></strong><span class="koboSpan" id="kobo.218.1"> slot function </span><a id="_idIndexMarker476"/><span class="koboSpan" id="kobo.219.1">from the menu. </span><span class="koboSpan" id="kobo.219.2">Then, repeat the same step on the </span><strong class="bold"><span class="koboSpan" id="kobo.220.1">Send</span></strong><span class="koboSpan" id="kobo.221.1"> button as well. </span><span class="koboSpan" id="kobo.221.2">As a result, two slot functions will be created for you in the source code, which may or may not look like what we see in the following code, depending on your </span><span class="No-Break"><span class="koboSpan" id="kobo.222.1">widget’s name:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.223.1">
void on_connectButton_clicked();
void on_sendButton_clicked();</span></pre></li> <li><span class="koboSpan" id="kobo.224.1">Next, open up </span><strong class="source-inline"><span class="koboSpan" id="kobo.225.1">mainwindow.h</span></strong><span class="koboSpan" id="kobo.226.1"> and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.227.1">following headers:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.228.1">
#include &lt;QDebug&gt;
#include &lt;QTcpSocket&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.229.1">Then, declare the </span><strong class="source-inline"><span class="koboSpan" id="kobo.230.1">printMessage()</span></strong><span class="koboSpan" id="kobo.231.1"> function and three slot functions: </span><strong class="source-inline"><span class="koboSpan" id="kobo.232.1">socketConnected()</span></strong><span class="koboSpan" id="kobo.233.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.234.1">socketDisconnected()</span></strong><span class="koboSpan" id="kobo.235.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.236.1">socketReadyRead()</span></strong><span class="koboSpan" id="kobo.237.1">, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.238.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.239.1">
public:
     explicit MainWindow(QWidget *parent = 0);
     ~MainWindow();
     </span><strong class="bold"><span class="koboSpan" id="kobo.240.1">void printMessage(QString message);</span></strong><span class="koboSpan" id="kobo.241.1">
private slots:
     void on_connectButton_clicked();
     void on_sendButton_clicked();
     </span><strong class="bold"><span class="koboSpan" id="kobo.242.1">void socketConnected();</span></strong><span class="koboSpan" id="kobo.243.1">
     </span><strong class="bold"><span class="koboSpan" id="kobo.244.1">void socketDisconnected();</span></strong><span class="koboSpan" id="kobo.245.1">
     </span><strong class="bold"><span class="koboSpan" id="kobo.246.1">void socketReadyRead();</span></strong></pre></li> <li><span class="koboSpan" id="kobo.247.1">After that, declare the following</span><a id="_idIndexMarker477"/><span class="koboSpan" id="kobo.248.1"> variables </span><span class="No-Break"><span class="koboSpan" id="kobo.249.1">as well:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.250.1">
private:
     Ui::MainWindow *ui;
     </span><strong class="bold"><span class="koboSpan" id="kobo.251.1">bool connectedToHost;</span></strong><span class="koboSpan" id="kobo.252.1">
     </span><strong class="bold"><span class="koboSpan" id="kobo.253.1">QTcpSocket* socket;</span></strong></pre></li> <li><span class="koboSpan" id="kobo.254.1">Once you’re done with that, you can proceed to </span><strong class="source-inline"><span class="koboSpan" id="kobo.255.1">mainwindow.cpp</span></strong><span class="koboSpan" id="kobo.256.1"> and define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.257.1">printMessage()</span></strong><span class="koboSpan" id="kobo.258.1"> function, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.259.1">following example:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.260.1">
void MainWindow::printMessage(QString message) {
     ui-&gt;chatDisplay-&gt;append(message);
}</span></pre></li> <li><span class="koboSpan" id="kobo.261.1">Then, we’ll implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.262.1">on_connectButton_clicked()</span></strong><span class="koboSpan" id="kobo.263.1"> function, which will be triggered when the </span><strong class="bold"><span class="koboSpan" id="kobo.264.1">Connect</span></strong><span class="koboSpan" id="kobo.265.1"> button is clicked, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.266.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.267.1">
void MainWindow::on_connectButton_clicked() {
     if (!connectedToHost) {
           socket = new QTcpSocket();
           connect(socket, &amp;QTcpSocket::connected, this, &amp;MainWindow::socketConnected);
           connect(socket, &amp;QTcpSocket::disconnected, this, &amp;MainWindow::socketDisconnected);
           connect(socket, &amp;QTcpSocket::readyRead, this, &amp;MainWindow::socketReadyRead);
           socket-&gt;connectToHost("127.0.0.1", 8001);
     }
     else {
           QString name = ui-&gt;nameInput-&gt;text();
           socket-&gt;write("&lt;font color=\"Orange\"&gt;" + name.toUtf8() + " has left the chat room.&lt;/font&gt;");
           socket-&gt;disconnectFromHost();
     }
}</span></pre></li> <li><span class="koboSpan" id="kobo.268.1">We also define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.269.1">on_sendButton_clicked()</span></strong><span class="koboSpan" id="kobo.270.1"> function, which will be called when the </span><strong class="bold"><span class="koboSpan" id="kobo.271.1">Send</span></strong><span class="koboSpan" id="kobo.272.1"> button is </span><a id="_idIndexMarker478"/><span class="koboSpan" id="kobo.273.1">clicked, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.274.1">following example:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.275.1">
void MainWindow::on_sendButton_clicked() {
     QString name = ui-&gt;nameInput-&gt;text();
     QString message = ui-&gt;messageInput-&gt;text();
     socket-&gt;write("&lt;font color=\"Blue\"&gt;" + name.toUtf8() + "&lt;/font&gt;: " + message.toUtf8());
     ui-&gt;messageInput-&gt;clear();
}</span></pre></li> <li><span class="koboSpan" id="kobo.276.1">Right after that, we implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">socketConnected()</span></strong><span class="koboSpan" id="kobo.278.1"> function, which will be called when the client program has been successfully connected to the server, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.279.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.280.1">
void MainWindow::socketConnected() {
     qDebug() &lt;&lt; "Connected to server.";
     printMessage("&lt;font color=\"Green\"&gt;Connected to server.&lt;/font&gt;");
     QString name = ui-&gt;nameInput-&gt;text();
     socket-&gt;write("&lt;font color=\"Purple\"&gt;" + name.toUtf8() + " has joined the chat room.&lt;/font&gt;");
     ui-&gt;connectButton-&gt;setText("Disconnect");
     connectedToHost = true;
}</span></pre></li> <li><span class="koboSpan" id="kobo.281.1">We are not yet done at this point. </span><span class="koboSpan" id="kobo.281.2">We also need to implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.282.1">socketDisconnected()</span></strong><span class="koboSpan" id="kobo.283.1"> function, which will be triggered whenever the client has been disconnected from</span><a id="_idIndexMarker479"/><span class="koboSpan" id="kobo.284.1"> the server, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.285.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.286.1">
void MainWindow::socketDisconnected() {
     qDebug() &lt;&lt; "Disconnected from server.";
     printMessage("&lt;font color=\"Red\"&gt;Disconnected from server.&lt;/font&gt;");
     ui-&gt;connectButton-&gt;setText("Connect");
     connectedToHost = false;
}</span></pre></li> <li><span class="koboSpan" id="kobo.287.1">Lastly, we also need to define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.288.1">socketReadyRead()</span></strong><span class="koboSpan" id="kobo.289.1"> function, which prints out the message sent from the server, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.290.1">following example:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.291.1">
void MainWindow::socketReadyRead() {
     printMessage(socket-&gt;readAll());
}</span></pre></li> <li><span class="koboSpan" id="kobo.292.1">Before we run the client program, we must first turn on the server program that we created in the previous recipe. </span><span class="koboSpan" id="kobo.292.2">Then, build and run the client program. </span><span class="koboSpan" id="kobo.292.3">Once the program has been opened, go and click the </span><strong class="bold"><span class="koboSpan" id="kobo.293.1">Connect</span></strong><span class="koboSpan" id="kobo.294.1"> button. </span><span class="koboSpan" id="kobo.294.2">After you have successfully connected to the server, type something in the line edit widget located at the bottom and press the </span><strong class="bold"><span class="koboSpan" id="kobo.295.1">Send</span></strong><span class="koboSpan" id="kobo.296.1"> button. </span><span class="koboSpan" id="kobo.296.2">You should see something similar to the </span><a id="_idIndexMarker480"/><span class="No-Break"><span class="koboSpan" id="kobo.297.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer109">
<span class="koboSpan" id="kobo.298.1"><img alt="Figure 7.6 – Our chat program is now working" src="image/B20976_07_006.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.299.1">Figure 7.6 – Our chat program is now working</span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.300.1">Let’s go to the server program, shown in the following screenshot, and see whether there is anything printed on the </span><span class="No-Break"><span class="koboSpan" id="kobo.301.1">terminal window:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer110">
<span class="koboSpan" id="kobo.302.1"><img alt="Figure 7.7 – Client activities are also shown on the server output" src="image/B20976_07_007.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.303.1">Figure 7.7 – Client activities are also shown on the server output</span></p>
<ol>
<li value="15"><span class="koboSpan" id="kobo.304.1">Congratulations, you have successfully</span><a id="_idIndexMarker481"/><span class="koboSpan" id="kobo.305.1"> created a program that looks a bit</span><a id="_idIndexMarker482"/><span class="koboSpan" id="kobo.306.1"> like an </span><strong class="bold"><span class="koboSpan" id="kobo.307.1">Internet Relay Chat</span></strong><span class="koboSpan" id="kobo.308.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.309.1">IRC</span></strong><span class="koboSpan" id="kobo.310.1">) </span><span class="No-Break"><span class="koboSpan" id="kobo.311.1">chat room!</span></span></li>
</ol>
<h2 id="_idParaDest-166"><a id="_idTextAnchor166"/><span class="koboSpan" id="kobo.312.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.313.1">In order for this to work, we need two programs: a server program that connects all the clients and delivers their messages, and a client program used by the users to send and receive messages from </span><span class="No-Break"><span class="koboSpan" id="kobo.314.1">other users.</span></span></p>
<p><span class="koboSpan" id="kobo.315.1">Since the server program just sits behind the scenes and works out everything in silence, it doesn’t need any user interface, and thus we only need it as a Qt </span><span class="No-Break"><span class="koboSpan" id="kobo.316.1">Console application.</span></span></p>
<p><span class="koboSpan" id="kobo.317.1">The client program, however, requires a visually pleasant yet easy-to-use GUI for the users to read and write their messages. </span><span class="koboSpan" id="kobo.317.2">Therefore, we created the client program as a Qt Widgets </span><span class="No-Break"><span class="koboSpan" id="kobo.318.1">application instead.</span></span></p>
<p><span class="koboSpan" id="kobo.319.1">The client program is relatively simple when compared to the server program. </span><span class="koboSpan" id="kobo.319.2">All it does is connect to the server, send out the message input by the user, and print out everything the server sends </span><span class="No-Break"><span class="koboSpan" id="kobo.320.1">to it.</span></span></p>
<h1 id="_idParaDest-167"><a id="_idTextAnchor167"/><span class="koboSpan" id="kobo.321.1">Uploading and downloading files using FTP</span></h1>
<p><span class="koboSpan" id="kobo.322.1">We have learned how to create simple</span><a id="_idIndexMarker483"/><span class="koboSpan" id="kobo.323.1"> chat software </span><a id="_idIndexMarker484"/><span class="koboSpan" id="kobo.324.1">that distributes text messages among the users. </span><span class="koboSpan" id="kobo.324.2">Next, we will learn how to create a program that uploads and downloads files </span><span class="No-Break"><span class="koboSpan" id="kobo.325.1">using FTP.</span></span></p>
<h2 id="_idParaDest-168"><a id="_idTextAnchor168"/><span class="koboSpan" id="kobo.326.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.327.1">Let’s get started by observing the </span><span class="No-Break"><span class="koboSpan" id="kobo.328.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.329.1">For this project, we need to</span><a id="_idIndexMarker485"/><span class="koboSpan" id="kobo.330.1"> install software called </span><strong class="bold"><span class="koboSpan" id="kobo.331.1">FileZilla Server</span></strong><span class="koboSpan" id="kobo.332.1">, which we will use as the FTP server. </span><span class="koboSpan" id="kobo.332.2">FileZilla Server</span><a id="_idIndexMarker486"/><span class="koboSpan" id="kobo.333.1"> can be downloaded from </span><a href="https://filezilla-project.org"><span class="koboSpan" id="kobo.334.1">https://filezilla-project.org</span></a><span class="koboSpan" id="kobo.335.1"> by clicking on the </span><strong class="bold"><span class="koboSpan" id="kobo.336.1">Download FileZilla Server</span></strong><span class="koboSpan" id="kobo.337.1"> button, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.338.1">following</span></span><span class="No-Break"><a id="_idIndexMarker487"/></span><span class="No-Break"><span class="koboSpan" id="kobo.339.1"> screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer111">
<span class="koboSpan" id="kobo.340.1"><img alt="Figure 7.8 – Downloading FileZilla Server from the official website" src="image/B20976_07_008.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.341.1">Figure 7.8 – Downloading FileZilla Server from the official website</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.342.1">Once you have downloaded the installer, run it and install </span><strong class="bold"><span class="koboSpan" id="kobo.343.1">FileZilla Server</span></strong><span class="koboSpan" id="kobo.344.1"> by agreeing to all the default options, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.345.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer112">
<span class="koboSpan" id="kobo.346.1"><img alt="Figure 7.9 – Default installation options will do" src="image/B20976_07_009.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.347.1">Figure 7.9 – Default installation options will do</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.348.1">When it has</span><a id="_idIndexMarker488"/><span class="koboSpan" id="kobo.349.1"> completed, open </span><a id="_idIndexMarker489"/><span class="koboSpan" id="kobo.350.1">up </span><strong class="bold"><span class="koboSpan" id="kobo.351.1">FileZilla Server</span></strong><span class="koboSpan" id="kobo.352.1"> and press the </span><strong class="bold"><span class="koboSpan" id="kobo.353.1">Connect to Server…</span></strong><span class="koboSpan" id="kobo.354.1"> button, and the </span><strong class="bold"><span class="koboSpan" id="kobo.355.1">Connection</span></strong><span class="koboSpan" id="kobo.356.1"> window will pop up, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.357.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer113">
<span class="koboSpan" id="kobo.358.1"><img alt="Figure 7.10 – Setting the host, port, and password in the Connection window" src="image/B20976_07_010.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.359.1">Figure 7.10 – Setting the host, port, and password in the Connection window</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.360.1">After the server has been </span><a id="_idIndexMarker490"/><span class="koboSpan" id="kobo.361.1">started, go to </span><strong class="bold"><span class="koboSpan" id="kobo.362.1">Server</span></strong><span class="koboSpan" id="kobo.363.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.364.1">Configure…</span></strong><span class="koboSpan" id="kobo.365.1"> from the top menu, as highlighted </span><a id="_idIndexMarker491"/><span class="koboSpan" id="kobo.366.1">in the </span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer114">
<span class="koboSpan" id="kobo.368.1"><img alt="Figure 7.11 – Opening up the Settings window from the top menu" src="image/B20976_07_011.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.369.1">Figure 7.11 – Opening up the Settings window from the top menu</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.370.1">Once the </span><strong class="bold"><span class="koboSpan" id="kobo.371.1">Settings</span></strong><span class="koboSpan" id="kobo.372.1"> window has been opened, click on the </span><strong class="bold"><span class="koboSpan" id="kobo.373.1">Add</span></strong><span class="koboSpan" id="kobo.374.1"> button located under the </span><strong class="bold"><span class="koboSpan" id="kobo.375.1">Available users</span></strong><span class="koboSpan" id="kobo.376.1"> list to add a new user. </span><span class="koboSpan" id="kobo.376.2">Then, add a shared folder under the </span><strong class="bold"><span class="koboSpan" id="kobo.377.1">Shared</span></strong><span class="koboSpan" id="kobo.378.1"> folders list, where your </span><a id="_idIndexMarker492"/><span class="koboSpan" id="kobo.379.1">users will be uploading and downloading files to and from, as </span><a id="_idIndexMarker493"/><span class="koboSpan" id="kobo.380.1">shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.381.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer115">
<span class="koboSpan" id="kobo.382.1"><img alt="Figure 7.12 – Clicking the Add button to add a new user" src="image/B20976_07_012.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.383.1">Figure 7.12 – Clicking the Add button to add a new user</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.384.1">We have now finished setting up FileZilla Server. </span><span class="koboSpan" id="kobo.384.2">Let’s move on to Qt Creator and create a new </span><strong class="bold"><span class="koboSpan" id="kobo.385.1">Qt Widgets Application</span></strong><span class="koboSpan" id="kobo.386.1"> project. </span><span class="koboSpan" id="kobo.386.2">Then, open up </span><strong class="source-inline"><span class="koboSpan" id="kobo.387.1">mainwindow.ui</span></strong><span class="koboSpan" id="kobo.388.1"> and set up the GUI, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.389.1">following diagram:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer116">
<span class="koboSpan" id="kobo.390.1"><img alt="Figure 7.13 – Layout of our FPT program" src="image/B20976_07_013.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.391.1">Figure 7.13 – Layout of our FPT program</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.392.1">Next, right-click on</span><a id="_idIndexMarker494"/><span class="koboSpan" id="kobo.393.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.394.1">Open</span></strong><span class="koboSpan" id="kobo.395.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.396.1">Upload</span></strong><span class="koboSpan" id="kobo.397.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.398.1">Set Folder</span></strong><span class="koboSpan" id="kobo.399.1"> buttons and create their respective </span><strong class="source-inline"><span class="koboSpan" id="kobo.400.1">clicked()</span></strong><span class="koboSpan" id="kobo.401.1"> slot functions, as </span><a id="_idIndexMarker495"/><span class="koboSpan" id="kobo.402.1">shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.403.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.404.1">
private slots:
     </span><strong class="bold"><span class="koboSpan" id="kobo.405.1">void on_openButton_clicked();</span></strong><span class="koboSpan" id="kobo.406.1">
     </span><strong class="bold"><span class="koboSpan" id="kobo.407.1">void on_uploadButton_clicked();</span></strong><span class="koboSpan" id="kobo.408.1">
     </span><strong class="bold"><span class="koboSpan" id="kobo.409.1">void on_setFolderButton_clicked();</span></strong></pre></li> <li><span class="koboSpan" id="kobo.410.1">After that, double-click on the list widget and select </span><strong class="bold"><span class="koboSpan" id="kobo.411.1">Go to slot...</span></strong><span class="koboSpan" id="kobo.412.1">. </span><span class="koboSpan" id="kobo.412.2">Then, select the </span><strong class="source-inline"><span class="koboSpan" id="kobo.413.1">itemDoubleClicked(QListWidgetItem*)</span></strong><span class="koboSpan" id="kobo.414.1"> option and click </span><strong class="bold"><span class="koboSpan" id="kobo.415.1">OK</span></strong><span class="koboSpan" id="kobo.416.1">, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.417.1">following </span></span><span class="No-Break"><a id="_idIndexMarker496"/></span><span class="No-Break"><span class="koboSpan" id="kobo.418.1">screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer117">
<span class="koboSpan" id="kobo.419.1"><img alt="Figure 7.14 – Selecting the itemDoubleClicked option" src="image/B20976_07_014.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.420.1">Figure 7.14 – Selecting the itemDoubleClicked option</span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.421.1">Then, declare additional slot</span><a id="_idIndexMarker497"/><span class="koboSpan" id="kobo.422.1"> functions such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.423.1">serverConnected()</span></strong><span class="koboSpan" id="kobo.424.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.425.1">serverReply()</span></strong><span class="koboSpan" id="kobo.426.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.427.1">dataReceived()</span></strong><span class="koboSpan" id="kobo.428.1">, which we will implement later in </span><span class="No-Break"><span class="koboSpan" id="kobo.429.1">this chapter:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.430.1">
private slots:
     void on_openButton_clicked();
     void on_uploadButton_clicked();
     void on_setFolderButton_clicked();
     void on_fileList_itemDoubleClicked(QListWidgetItem *item);
     </span><strong class="bold"><span class="koboSpan" id="kobo.431.1">void serverConnected(const QHostAddress &amp;address, int port);</span></strong><span class="koboSpan" id="kobo.432.1">
     </span><strong class="bold"><span class="koboSpan" id="kobo.433.1">void serverReply(int code, const QString &amp;parameters);</span></strong><span class="koboSpan" id="kobo.434.1">
     </span><strong class="bold"><span class="koboSpan" id="kobo.435.1">void dataReceived(const QByteArray &amp;data);</span></strong></pre></li> <li><span class="koboSpan" id="kobo.436.1">Once you have created the</span><a id="_idIndexMarker498"/><span class="koboSpan" id="kobo.437.1"> slot functions, go to </span><strong class="bold"><span class="koboSpan" id="kobo.438.1">File</span></strong><span class="koboSpan" id="kobo.439.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.440.1">New File…</span></strong><span class="koboSpan" id="kobo.441.1"> and create a new C++ class</span><a id="_idIndexMarker499"/> <span class="No-Break"><span class="koboSpan" id="kobo.442.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.443.1">FtpDataChannel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.444.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.445.1">Then, open up </span><strong class="source-inline"><span class="koboSpan" id="kobo.446.1">ftpdatachannel.h</span></strong><span class="koboSpan" id="kobo.447.1"> and add the following code </span><span class="No-Break"><span class="koboSpan" id="kobo.448.1">to it:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.449.1">
#ifndef FTPDATACHANNEL_H
#define FTPDATACHANNEL_H
#include &lt;QtCore/qobject.h&gt;
#include &lt;QtNetwork/qtcpserver.h&gt;
#include &lt;QtNetwork/qtcpsocket.h&gt;
#include &lt;memory&gt;
class FtpDataChannel : public QObject{
    Q_OBJECT
public:
    explicit FtpDataChannel(QObject *parent = nullptr);
    void listen(const QHostAddress &amp;address = QHostAddress::Any);
    void sendData(const QByteArray &amp;data);
    void close();
    QString portspec() const;
    QTcpServer m_server;
    std::unique_ptr&lt;QTcpSocket&gt; m_socket;
signals:
    void dataReceived(const QByteArray &amp;data);
};
#endif</span></pre></li> <li><span class="koboSpan" id="kobo.450.1">Right after that, open</span><a id="_idIndexMarker500"/><span class="koboSpan" id="kobo.451.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.452.1">ftpdatachannel.cpp</span></strong><span class="koboSpan" id="kobo.453.1"> source file</span><a id="_idIndexMarker501"/><span class="koboSpan" id="kobo.454.1"> and write the </span><span class="No-Break"><span class="koboSpan" id="kobo.455.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.456.1">
#include "ftpdatachannel.h"
FtpDataChannel::FtpDataChannel(QObject *parent) : QObject(parent){
    connect(&amp;m_server, &amp;QTcpServer::newConnection, this, [this](){
        m_socket.reset(m_server.nextPendingConnection());
        connect(m_socket.get(), &amp;QTcpSocket::readyRead, this, [this](){
            emit dataReceived(m_socket-&gt;readAll());
        });
        connect(m_socket.get(), &amp;QTcpSocket::bytesWritten, this, [this](qint64 bytes){
            qDebug() &lt;&lt; bytes;
            close();
        });
    });
}</span></pre></li> <li><span class="koboSpan" id="kobo.457.1">Then, we continue to</span><a id="_idIndexMarker502"/><span class="koboSpan" id="kobo.458.1"> implement functions for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.459.1">FtpDataChannel</span></strong><span class="koboSpan" id="kobo.460.1"> class, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.461.1">listen()</span></strong><span class="koboSpan" id="kobo.462.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.463.1">sendData()</span></strong><span class="koboSpan" id="kobo.464.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.465.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.466.1">close()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.467.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.468.1">
void FtpDataChannel::listen(const QHostAddress &amp;address){
    m_server.listen(address);
}
void FtpDataChannel::sendData(const QByteArray &amp;data){
    if (m_socket)
        m_socket-&gt;write(QByteArray(data).replace("\n", "\r\n"));
}
void FtpDataChannel::close(){
    if (m_socket)
        m_socket-&gt;disconnectFromHost();
}</span></pre></li> <li><span class="koboSpan" id="kobo.469.1">Lastly, we implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.470.1">postspec()</span></strong><span class="koboSpan" id="kobo.471.1"> function, which composes the FTP server’s information</span><a id="_idIndexMarker503"/><span class="koboSpan" id="kobo.472.1"> in a special format that can be sent back to the FTP server for </span><span class="No-Break"><span class="koboSpan" id="kobo.473.1">verification purposes:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.474.1">
QString FtpDataChannel::portspec() const{
    QString portSpec;
    quint32 ipv4 = m_server.serverAddress().toIPv4Address();
    quint16 port = m_server.serverPort();
    portSpec += QString::number((ipv4 &amp; 0xff000000) &gt;&gt; 24);
    portSpec += ',' + QString::number((ipv4 &amp; 0x00ff0000) &gt;&gt; 16);
    portSpec += ',' + QString::number((ipv4 &amp; 0x0000ff00) &gt;&gt; 8);
    portSpec += ',' + QString::number(ipv4 &amp; 0x000000ff);
    portSpec += ',' + QString::number((port &amp; 0xff00) &gt;&gt; 8);
    portSpec += ',' + QString::number(port &amp;0x00ff);
    return portSpec;
}</span></pre></li> <li><span class="koboSpan" id="kobo.475.1">Once we’re done with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.476.1">FtpDataChannel</span></strong><span class="koboSpan" id="kobo.477.1"> class, go to </span><strong class="bold"><span class="koboSpan" id="kobo.478.1">File</span></strong><span class="koboSpan" id="kobo.479.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.480.1">New File…</span></strong><span class="koboSpan" id="kobo.481.1"> again and create another </span><a id="_idIndexMarker504"/><span class="koboSpan" id="kobo.482.1">new C++ class </span><span class="No-Break"><span class="koboSpan" id="kobo.483.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.484.1">FtpControlChannel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.485.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.486.1">Open up the newly </span><a id="_idIndexMarker505"/><span class="koboSpan" id="kobo.487.1">created </span><strong class="source-inline"><span class="koboSpan" id="kobo.488.1">ftpcontrolchannel.h</span></strong><span class="koboSpan" id="kobo.489.1"> and add the following code to the </span><span class="No-Break"><span class="koboSpan" id="kobo.490.1">header file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.491.1">
#ifndef FTPCONTROLCHANNEL_H
#define FTPCONTROLCHANNEL_H
#include &lt;QtNetwork/qhostaddress.h&gt;
#include &lt;QtNetwork/qtcpsocket.h&gt;
#include &lt;QtCore/qobject.h&gt;
class FtpControlChannel : public QObject{
    Q_OBJECT
public:
    explicit FtpControlChannel(QObject *parent = nullptr);
    void connectToServer(const QString &amp;server);
    void command(const QByteArray &amp;command, const QByteArray &amp;params);
public slots:
    void error(QAbstractSocket::SocketError);
signals:
    void opened(const QHostAddress &amp;localAddress, int localPort);
    void closed();
    void info(const QByteArray &amp;info);
    void reply(int code, const QByteArray &amp;parameters);
    void invalidReply(const QByteArray &amp;reply);
private:
    void onReadyRead();
    QTcpSocket m_socket;
    QByteArray m_buffer;
};
#endif // FTPCONTROLCHANNEL_H</span></pre></li> <li><span class="koboSpan" id="kobo.492.1">Then, let’s </span><a id="_idIndexMarker506"/><span class="koboSpan" id="kobo.493.1">open up </span><strong class="source-inline"><span class="koboSpan" id="kobo.494.1">ftpcontrolchannel.cpp</span></strong><span class="koboSpan" id="kobo.495.1"> and write the </span><span class="No-Break"><span class="koboSpan" id="kobo.496.1">following </span></span><span class="No-Break"><a id="_idIndexMarker507"/></span><span class="No-Break"><span class="koboSpan" id="kobo.497.1">code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.498.1">
#include "ftpcontrolchannel.h"
#include &lt;QtCore/qcoreapplication.h&gt;
FtpControlChannel::FtpControlChannel(QObject *parent) : QObject(parent){
    connect(&amp;m_socket, &amp;QIODevice::readyRead,
            this, &amp;FtpControlChannel::onReadyRead);
    connect(&amp;m_socket, &amp;QAbstractSocket::disconnected,
            this, &amp;FtpControlChannel::closed);
    connect(&amp;m_socket, &amp;QAbstractSocket::connected, this, [this]() {
        emit opened(m_socket.localAddress(), m_socket.localPort());
    });
    connect(&amp;m_socket, &amp;QAbstractSocket::errorOccurred,
            this, &amp;FtpControlChannel::error);
}</span></pre></li> <li><span class="koboSpan" id="kobo.499.1">Then, we continue to</span><a id="_idIndexMarker508"/><span class="koboSpan" id="kobo.500.1"> implement other</span><a id="_idIndexMarker509"/><span class="koboSpan" id="kobo.501.1"> functions of the class, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.502.1">connectToServer()</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.503.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.504.1">command()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.505.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.506.1">
void FtpControlChannel::connectToServer(const QString &amp;server){
    m_socket.connectToHost(server, 21);
}
void FtpControlChannel::command(const QByteArray &amp;command, const QByteArray &amp;params){
    QByteArray sendData = command;
    if (!params.isEmpty())
        sendData += " " + params;
    m_socket.write(sendData + "\r\n");
}</span></pre></li> <li><span class="koboSpan" id="kobo.507.1">Right after that, we continue</span><a id="_idIndexMarker510"/><span class="koboSpan" id="kobo.508.1"> to write the code for</span><a id="_idIndexMarker511"/><span class="koboSpan" id="kobo.509.1"> its slot functions—namely, </span><strong class="source-inline"><span class="koboSpan" id="kobo.510.1">onReadyRead()</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.511.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.512.1">error()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.513.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.514.1">
void FtpControlChannel::onReadyRead(){
    m_buffer.append(m_socket.readAll());
    int rn = -1;
    while ((rn = m_buffer.indexOf("\r\n")) != -1) {
        QByteArray received = m_buffer.mid(0, rn);
        m_buffer = m_buffer.mid(rn + 2);
        int space = received.indexOf(' ');
        if (space != -1) {
            int code = received.mid(0, space).toInt();
            if (code == 0) {
                qDebug() &lt;&lt; "Info received: " &lt;&lt; received.mid(space + 1);
                emit info(received.mid(space + 1));
            } else {
                qDebug() &lt;&lt; "Reply received: " &lt;&lt; received.mid(space + 1);
                emit reply(code, received.mid(space + 1));
            }
        } else {
            emit invalidReply(received);
        }
    }
}
void FtpControlChannel::error(QAbstractSocket::SocketError error){
    qWarning() &lt;&lt; "Socket error:" &lt;&lt; error;
    QCoreApplication::exit();
}</span></pre></li> <li><span class="koboSpan" id="kobo.515.1">After that, open</span><a id="_idIndexMarker512"/><span class="koboSpan" id="kobo.516.1"> up </span><strong class="source-inline"><span class="koboSpan" id="kobo.517.1">mainwindow.h</span></strong><span class="koboSpan" id="kobo.518.1"> and add the</span><a id="_idIndexMarker513"/> <span class="No-Break"><span class="koboSpan" id="kobo.519.1">following headers:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.520.1">
#include &lt;QDebug&gt;
#include &lt;QNetworkAccessManager&gt;
#include &lt;QNetworkRequest&gt;
#include &lt;QNetworkReply&gt;
#include &lt;QFile&gt;
#include &lt;QFileInfo&gt;
#include &lt;QFileDialog&gt;
#include &lt;QListWidgetItem&gt;
#include &lt;QMessageBox&gt;
#include &lt;QThread&gt;
#include "ftpcontrolchannel.h"
#include "ftpdatachannel.h"</span></pre></li> <li><span class="koboSpan" id="kobo.521.1">Then, declare the </span><strong class="source-inline"><span class="koboSpan" id="kobo.522.1">getFileList()</span></strong><span class="koboSpan" id="kobo.523.1"> function, </span><span class="No-Break"><span class="koboSpan" id="kobo.524.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.525.1">
public:
     explicit MainWindow(QWidget *parent = 0);
     ~MainWindow();
     void getFileList();</span></pre></li> <li><span class="koboSpan" id="kobo.526.1">Right after that, declare the</span><a id="_idIndexMarker514"/> <span class="No-Break"><span class="koboSpan" id="kobo.527.1">following variables:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.528.1">
private:
     Ui::MainWindow *ui;
     FtpDataChannel* dataChannel;
     FtpControlChannel* controlChannel;
     QString ftpAddress;
     QString username;
     QString password;
     QStringList fileList;
     QString uploadFileName;
     QString downloadFileName;</span></pre></li> <li><span class="koboSpan" id="kobo.529.1">Then, open up </span><strong class="source-inline"><span class="koboSpan" id="kobo.530.1">mainwindow.cpp</span></strong><span class="koboSpan" id="kobo.531.1"> and add </span><a id="_idIndexMarker515"/><span class="koboSpan" id="kobo.532.1">the following code to the </span><span class="No-Break"><span class="koboSpan" id="kobo.533.1">class constructor:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.534.1">
MainWindow::MainWindow(QWidget *parent) : QMainWindow(parent), ui(new Ui::MainWindow) {
     ui-&gt;setupUi(this);
     dataChannel = new FtpDataChannel(this);
     connect(dataChannel, &amp;FtpDataChannel::dataReceived, this, &amp;MainWindow::dataReceived);
     connect(controlChannel, &amp;FtpControlChannel::reply, this, &amp;MainWindow::serverReply);
     connect(controlChannel, &amp;FtpControlChannel::opened, this, &amp;MainWindow::serverConnected);
     controlChannel = new FtpControlChannel(this);
     ftpAddress = "127.0.0.1/";
     username = "myuser";
     password = "123456";
     controlChannel-&gt;connectToServer(ftpAddress);
}</span></pre></li> <li><span class="koboSpan" id="kobo.535.1">After that, implement </span><a id="_idIndexMarker516"/><span class="koboSpan" id="kobo.536.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.537.1">getFileList()</span></strong><span class="koboSpan" id="kobo.538.1"> function, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.539.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.540.1">
void MainWindow::getFileList() {
controlChannel-&gt;command("PORT", dataChannel-&gt;portspec().toUtf8());
    controlChannel-&gt;command("MLSD", "");}</span></pre></li> <li><span class="koboSpan" id="kobo.541.1">Then, define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.542.1">on_openButton_clicked()</span></strong><span class="koboSpan" id="kobo.543.1"> slot function, which gets triggered when the </span><strong class="bold"><span class="koboSpan" id="kobo.544.1">Open</span></strong><span class="koboSpan" id="kobo.545.1"> button is</span><a id="_idIndexMarker517"/><span class="koboSpan" id="kobo.546.1"> clicked, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.547.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.548.1">
void MainWindow::on_openButton_clicked() {
     QString fileName = QFileDialog::getOpenFileName(this, "Select File", qApp-&gt;applicationDirPath());
     ui-&gt;uploadFileInput-&gt;setText(fileName);
}</span></pre></li> <li><span class="koboSpan" id="kobo.549.1">Once you’re done with that, implement the slot function that gets called when the </span><strong class="bold"><span class="koboSpan" id="kobo.550.1">Upload</span></strong><span class="koboSpan" id="kobo.551.1"> button is clicked, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.552.1">following example:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.553.1">
void MainWindow::on_uploadButton_clicked() {
     QFile* file = new QFile(ui-&gt;uploadFileInput-&gt;text());
     QFileInfo fileInfo(*file);
     uploadFileName = fileInfo.fileName();
     controlChannel-&gt;command("PORT", dataChannel-&gt;portspec().toUtf8());
     controlChannel-&gt;command("STOR", uploadFileName.toUtf8());
}</span></pre></li> <li><span class="koboSpan" id="kobo.554.1">The following code shows </span><a id="_idIndexMarker518"/><span class="koboSpan" id="kobo.555.1">what the </span><strong class="source-inline"><span class="koboSpan" id="kobo.556.1">on_setFolderButton_clicked()</span></strong><span class="koboSpan" id="kobo.557.1"> slot function </span><span class="No-Break"><span class="koboSpan" id="kobo.558.1">looks like:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.559.1">
void MainWindow::on_setFolderButton_clicked() {
     QString folder = QFileDialog::getExistingDirectory(this, tr("Open Directory"), qApp-&gt;applicationDirPath(), QFileDialog::ShowDirsOnly);
     ui-&gt;downloadPath-&gt;setText(folder);
}</span></pre></li> <li><span class="koboSpan" id="kobo.560.1">Next, define the slot function that </span><a id="_idIndexMarker519"/><span class="koboSpan" id="kobo.561.1">will be triggered when one of the list widget’s items gets double-clicked, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.562.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.563.1">
void MainWindow::on_fileList_itemDoubleClicked(QListWidgetItem *item) {
     downloadFileName = item-&gt;text();
     QString folder = ui-&gt;downloadPath-&gt;text();
     if (folder != "" &amp;&amp; QDir(folder).exists()) {
           controlChannel-&gt;command("PORT", dataChannel-&gt;portspec().toUtf8());
                       controlChannel-&gt;command("RETR", downloadFileName.toUtf8());
     }
     else {
           QMessageBox::warning(this, "Invalid Path", "Please set the download path before download.");
}}</span></pre></li> <li><span class="koboSpan" id="kobo.564.1">We’re not quite done yet. </span><span class="koboSpan" id="kobo.564.2">Next, we will implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.565.1">serverConnected()</span></strong><span class="koboSpan" id="kobo.566.1"> function, which will be called automatically </span><a id="_idIndexMarker520"/><span class="koboSpan" id="kobo.567.1">when the program has successfully connected to the FTP server, as shown</span><a id="_idIndexMarker521"/><span class="koboSpan" id="kobo.568.1"> in the </span><span class="No-Break"><span class="koboSpan" id="kobo.569.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.570.1">
void MainWindow::serverConnected(const QHostAddress &amp;address, int port){
    qDebug() &lt;&lt; "Listening to:" &lt;&lt; address &lt;&lt; port;
    dataChannel-&gt;listen(address);
    controlChannel-&gt;command("USER", username.toUtf8());
    controlChannel-&gt;command("PASS", password.toUtf8());
    getFileList();
}</span></pre></li> <li><span class="koboSpan" id="kobo.571.1">We also need to implement the function that will be called when the FTP server replies to our request, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.572.1">following example:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.573.1">
void MainWindow::serverReply(int code, const QString &amp;parameters){
    if (code == 150 &amp;&amp; uploadFileName != ""){
        QFile* file = new QFile(ui-&gt;uploadFileInput-&gt;text());
        QFileInfo fileInfo(*file);
        uploadFileName = fileInfo.fileName();
        if (file-&gt;open(QIODevice::ReadOnly)){
            QThread::msleep(1000);
            QByteArray data = file-&gt;readAll();
            dataChannel-&gt;sendData(data + "\n\r");
            qDebug() &lt;&lt; data;
        } else {
            QMessageBox::warning(this, "Invalid File", "Failed to open file for upload.");
        }
    }
    if (code == 226 &amp;&amp; uploadFileName != ""){
        uploadFileName = "";
        QMessageBox::warning(this, "Upload Success", "File successfully uploaded.");
    }
}</span></pre></li> <li><span class="koboSpan" id="kobo.574.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.575.1">dataReceived()</span></strong><span class="koboSpan" id="kobo.576.1"> function is</span><a id="_idIndexMarker522"/><span class="koboSpan" id="kobo.577.1"> used to obtain </span><a id="_idIndexMarker523"/><span class="koboSpan" id="kobo.578.1">the data received from the FTP server, and it looks something like the </span><span class="No-Break"><span class="koboSpan" id="kobo.579.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.580.1">
void MainWindow::dataReceived(const QByteArray &amp;data){
    if (data.startsWith("type=file")){
        ui-&gt;fileList-&gt;clear();
        QStringList fileList = QString(data).split("\r\n");
        if (fileList.length() &gt; 0){
            for (int i = 0; i &lt; fileList.length(); ++i){
                if (fileList.at(i) != ""){
                    QStringList fileInfo = fileList.at(i).split(";");
                    QString fileName = fileInfo.at(4).simplified();
                    ui-&gt;fileList-&gt;addItem(fileName);
                }
             }
        }
    } else {
        QString folder = ui-&gt;downloadPath-&gt;text();
        QFile file(folder + "/" + downloadFileName);
        file.open(QIODevice::WriteOnly);
        file.write((data));
        file.close();
        QMessageBox::information(this, "Success", "File successfully downloaded.");
    }
}</span></pre></li> <li><span class="koboSpan" id="kobo.581.1">Lastly, build and run</span><a id="_idIndexMarker524"/><span class="koboSpan" id="kobo.582.1"> the program. </span><span class="koboSpan" id="kobo.582.2">Try and upload some files to the FTP server. </span><span class="koboSpan" id="kobo.582.3">If it works, the file list should be updated</span><a id="_idIndexMarker525"/><span class="koboSpan" id="kobo.583.1"> and displayed on the </span><strong class="bold"><span class="koboSpan" id="kobo.584.1">List</span></strong><span class="koboSpan" id="kobo.585.1"> widget. </span><span class="koboSpan" id="kobo.585.2">Then, try and double-click on the filename on the list widget and download the file to your computer, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.586.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer118">
<span class="koboSpan" id="kobo.587.1"><img alt="Figure 7.15 – Downloading a file from the FTP server by double-clicking on it" src="image/B20976_07_015.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.588.1">Figure 7.15 – Downloading a file from the FTP server by double-clicking on it</span></p>
<ol>
<li value="33"><span class="koboSpan" id="kobo.589.1">You can also try to upload </span><a id="_idIndexMarker526"/><span class="koboSpan" id="kobo.590.1">a file by clicking on the </span><strong class="bold"><span class="koboSpan" id="kobo.591.1">Open</span></strong><span class="koboSpan" id="kobo.592.1"> button, selecting the</span><a id="_idIndexMarker527"/><span class="koboSpan" id="kobo.593.1"> desired file, and pressing the </span><strong class="bold"><span class="koboSpan" id="kobo.594.1">Upload</span></strong><span class="koboSpan" id="kobo.595.1"> button, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.596.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer119">
<span class="koboSpan" id="kobo.597.1"><img alt="Figure 7.16 – Uploading a file to the FTP server" src="image/B20976_07_016.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.598.1">Figure 7.16 – Uploading a file to the FTP server</span></p>
<ol>
<li value="34"><span class="koboSpan" id="kobo.599.1">Congratulations, you have </span><a id="_idIndexMarker528"/><span class="koboSpan" id="kobo.600.1">now successfully created a </span><a id="_idIndexMarker529"/><span class="koboSpan" id="kobo.601.1">working </span><span class="No-Break"><span class="koboSpan" id="kobo.602.1">FTP program!</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.603.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.604.1">Do note that this example program is only meant to show you the most basic implementation of an FTP program and is not a fully featured program. </span><span class="koboSpan" id="kobo.604.2">It’s not guaranteed to work if you try to upload/download files that are not in text format. </span><span class="koboSpan" id="kobo.604.3">It may also not upload correctly if a file already exists on the FTP server. </span><span class="koboSpan" id="kobo.604.4">You must implement these features by yourself if you wish to expand on top of </span><span class="No-Break"><span class="koboSpan" id="kobo.605.1">this project.</span></span></p>
<h2 id="_idParaDest-169"><a id="_idTextAnchor169"/><span class="koboSpan" id="kobo.606.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.607.1">Although this project is much larger and with longer code, it is actually pretty similar to the TCP networking projects we have</span><a id="_idIndexMarker530"/><span class="koboSpan" id="kobo.608.1"> done in previous recipes. </span><span class="koboSpan" id="kobo.608.2">We have also made use of the signals and slots</span><a id="_idIndexMarker531"/><span class="koboSpan" id="kobo.609.1"> mechanism provided by Qt 6 to make our </span><span class="No-Break"><span class="koboSpan" id="kobo.610.1">lives easier.</span></span></p>
<p><span class="koboSpan" id="kobo.611.1">In the past, Qt used to support FTP in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.612.1">QNetworkAccessManager</span></strong><span class="koboSpan" id="kobo.613.1"> class. </span><span class="koboSpan" id="kobo.613.2">However, FTP has since been deprecated in Qt 6 so we have to implement it on </span><span class="No-Break"><span class="koboSpan" id="kobo.614.1">our own.</span></span></p>
<p><span class="koboSpan" id="kobo.615.1">We must understand some of the most common FTP commands and utilize them in our program. </span><span class="koboSpan" id="kobo.615.2">For more information, check </span><span class="No-Break"><span class="koboSpan" id="kobo.616.1">out </span></span><a href="https://www.serv-u.com/resources/tutorial/appe-stor-stou-retr-list-mlsd-mlst-ftp-command"><span class="No-Break"><span class="koboSpan" id="kobo.617.1">https://www.serv-u.com/resources/tutorial/appe-stor-stou-retr-list-mlsd-mlst-ftp-command</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.618.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.619.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.620.1">FtpControlChannel</span></strong><span class="koboSpan" id="kobo.621.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.622.1">FtpDataChannel</span></strong><span class="koboSpan" id="kobo.623.1"> classes were taken from Qt’s official Git repository with some tiny </span><span class="No-Break"><span class="koboSpan" id="kobo.624.1">modifications: </span></span><a href="https://code.qt.io/cgit/qt/qtscxml.git/tree/examples/scxml/ftpclient"><span class="No-Break"><span class="koboSpan" id="kobo.625.1">https://code.qt.io/cgit/qt/qtscxml.git/tree/examples/scxml/ftpclient</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.626.1">.</span></span></p>
</div>
</body></html>