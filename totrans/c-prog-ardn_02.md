# 第二章。与C的第一次接触

在我的程序员生涯中，我遇到了很多基于编译器和脚本语言的情况。其中最低的共同点一直是C语言。

在我们的情况下，这是 **嵌入式系统编程**，这是 **硬件编程** 的另一个名称；这个说法也是正确的。

让我们来看看C编程究竟是什么，让我们进入一个新的世界，那就是Arduino编程的领域。我们还将使用一个非常必要的功能，称为 **串行监控**。这将在我们的C学习中帮我们很多，你也会理解这个功能在现实生活中的项目中也被使用。

# 编程简介

第一个问题，**什么是程序**？

**程序** 是你使用编程语言编写的文本，其中包含你需要处理器获取的行为。它基本上创建了一种处理输入和根据这些行为产生输出的方式。

根据维基百科 ([http://en.wikipedia.org/wiki/Computer_programming](http://en.wikipedia.org/wiki/Computer_programming))：

> 编程是设计、编写、测试、调试和维护计算机程序源代码的过程。

当然，这个定义非常简单，它也适用于微控制器，因为我们已经知道后者基本上是一种计算机。

*设计一个程序* 是你在开始编码之前必须首先思考的事实。这通常涉及到编写、绘制以及制作你希望处理器为你执行的所有动作的示意图。有时，这也意味着编写我们所说的 **伪代码**。我希望你能记住，这是我们上章在想要精确定义我们期望的LED行为的所有步骤时创建的内容。

我不同意很多人称它为 *伪代码*，因为它实际上更像是 *真实代码*。

我们所说的 *伪代码* 是非常有帮助的东西，因为它易于阅读，由清晰的句子组成，并且用于更好地思考和说明我们的目的，这是成功的关键。

我固件 *伪代码* 的定义示例可能如下：

1.  测量热敏传感器的当前值。

1.  检查温度是否大于30°C，如果是，则发出声音。

1.  如果不是，点亮蓝色LED。

1.  并且将这些之前的步骤永久地放在一个循环中。

*编写一个程序* 通常是将伪代码转换为真实且格式良好的代码的过程。这涉及到对编程语言的了解，因为这是你真正编写程序的时候。这就是我们接下来要学习的。

*测试* 是在你对代码进行了一些修改后运行程序时的明显步骤。当你也是程序员时，这是一个既令人兴奋又有点害怕的时刻，因为你害怕虫子，那些让你的程序运行结果与最初预期完全不同的事情。

*调试* 是当你试图找出为什么程序没有按预期工作得很好时的一个非常重要的步骤。你正在追踪打字错误、逻辑差异和全局程序架构问题。你需要监控事物，并且经常需要稍微修改你的程序，以便精确地追踪它是如何工作的。

*维护源代码* 是程序生命周期中帮助避免过时的部分。

程序正在运行，并且你逐步改进它；你根据硬件的进化更新它，有时，你需要调试它，因为用户仍然发现了这个未知的错误。这一步骤增加了你程序的使用寿命。

## 不同的编程范式

**范式**是描述某物的方式。它可以是某物的表示或理论模型。

将编程应用于，编程范式是*计算机编程的基本风格*。

以下是有四种主要的编程范式：

+   面向对象

+   命令式

+   函数式

+   逻辑编程

一些语言遵循的不是一种而是多种范式。

这本书的目的不是围绕这些进行辩论，但我可以增加一个，它可以是这些的组合，同时也描述了一个特定的概念：**可视化编程**。我们将在[第6章](ch06.html "第6章. 感知世界 – 使用模拟输入感受")中了解到最强大的框架之一，即*感知世界 – 使用模拟输入感受*，也就是**Max 6**框架（之前称为**Max/MSP**）。

## 编程风格

没有科学或普遍的方法来定义什么是绝对最佳的编程风格。然而，我可以引用六个项目，这些项目可以帮助我们理解在这本书中我们将尝试一起做什么，以编写出优秀的程序。我们的目标是以下内容：

+   **可靠性**：这使代码能够在运行时处理其生成的错误

+   **稳定性**：这提供了一个框架来预测用户端的问题（错误的输入）

+   **人体工程学**：这有助于直观地轻松使用它

+   **可移植性**：这是为广泛的平台设计程序

+   **可维护性**：这是即使你没有亲自编写代码也能轻松修改它的程度

+   **效率**：这表明程序运行得非常顺畅，而不消耗大量资源

当然，我们将在本书的例子中回到它们，我相信你将逐步改进你的风格。

# C和C++？

**丹尼斯·里奇** [http://en.wikipedia.org/wiki/Dennis_Ritchie](http://en.wikipedia.org/wiki/Dennis_Ritchie)) 在贝尔实验室从1969年到1973年开发了C编程语言。它通常被定义为一门通用编程语言，并且确实是所有时代中最常用的语言之一。它最初被用来设计具有众多要求的Unix操作系统([http://en.wikipedia.org/wiki/Unix](http://en.wikipedia.org/wiki/Unix))，特别是高性能。

它影响了很多非常知名且广泛使用的语言，如C++、Objective-C、Java、JavaScript、Perl、PHP等。

C语言既适用于**命令式**也适用于**结构化**。它非常适合8位和64位处理器，对于既有几字节内存也有太字节内存的系统，以及涉及庞大团队的大型项目，以及只有单个开发者的最小项目。

是的，我们将学习一种语言，它将打开你的思路，让你接触到全球和通用的编程概念！

## C语言无处不在

事实上，C语言提供了很多优点。它们如下：

+   *它体积小，易于学习*。

+   *它是处理器无关的*，因为几乎世界上所有的处理器都有相应的*编译器*。这种无关性为程序员提供了非常有用的东西：他们可以专注于算法和工作的应用层面，而不是在每一行代码中都要考虑硬件层面。

+   *它是一种非常“底层”的高级语言*。

    这是它的主要优势。Dennis M. Ritchie在他的与Brian W. Kernighan合著的《C程序设计语言》一书中对C语言评论道：

> C是一种相对“底层”的语言。这种描述并不是贬义的；它仅仅意味着C处理的是大多数计算机都处理的对象。这些对象可以用真实机器实现的算术和逻辑运算符组合和移动。

今天，这是唯一一种可以如此容易地与底层硬件引擎交互的语言，这也是为什么Arduino工具链基于C语言的原因。

## Arduino是用C和C++编写的

C++可以被认为是C的超集。这意味着C++为C带来了新的概念和元素。基本上，C++可以定义为具有面向对象实现的C（[http://en.wikipedia.org/wiki/Object-oriented_programming](http://en.wikipedia.org/wiki/Object-oriented_programming)），这是一个高级特性。这是一个非常好的特性，它带来了新的设计方式。

我们将在本书稍后更深入地探讨这个概念，但基本上，在面向对象的程序中，你定义称为**类**的结构，它们是一种模型，然后你创建这些类的**实例**，这些实例在运行时拥有自己的生命周期，并且尊重和继承它们所属类的结构。

**面向对象编程**（**OOP**）提供了四个非常有用且有趣的特点：

+   继承（类可以从其父类继承属性和行为）

+   数据封装（每个实例保留其数据和函数）

+   对象标识（每个实例都是独立的）

+   多态（每个行为都可以依赖于上下文）

在OOP中，我们首先定义类，然后使用称为**构造函数**的特定函数来创建这些类的实例。想象一下，一个类是一类房子的地图，而实例则是根据这个地图建造的所有房子。

几乎所有的Arduino库都是使用C++编写的，以便易于重用，这是编程中最重要的品质之一。

# Arduino原生库和其他库

**编程库**是一组可供程序使用的资源。

它们可以包括不同类型的东西，如下所示：

+   配置数据

+   帮助和文档资源

+   子程序和可重用代码部分

+   类

+   类型定义

我喜欢说图书馆提供了一种**行为封装**；您不需要知道如何实现该行为，只需使用它即可。

图书馆可以是非常具体的，也可以具有全局目的。

例如，如果您打算设计固件，将Arduino连接到互联网以从邮件服务器获取一些信息，并根据邮件服务器响应的内容以某种方式使LED矩阵闪烁，您有以下两种解决方案：

+   从头开始编写整个固件

+   使用库

即使我们都喜欢编写代码，但如果我们能专注于我们设计的全局目的，我们会更快乐，不是吗？

在这种情况下，我们将尝试找到已经为所需行为专门设计的库。例如，可能有一个专门用于LED矩阵控制的库，还有一个具有服务器连接目的的库。

## 发现Arduino原生库

原生库是为了一个非常基础和全局的目的而设计的。这意味着它可能不够用，但也意味着您将在所有固件设计中每次都使用它。

您可以在[http://arduino.cc/en/Reference/HomePage](http://arduino.cc/en/Reference/HomePage)找到它。现在您对这个页面应该很熟悉了！

它分为以下三个部分：

+   **结构**（从全局条件控制结构到更具体的结构）

+   **变量**（与类型和类型之间的转换相关）

+   **函数**（从I/O函数到数学计算函数等）

以下步骤可用于在IDE中直接查找帮助：

1.  打开您的IDE。

1.  前往**文件** | **示例**；您将看到以下屏幕截图：![发现Arduino原生库](img/7584_02_001.jpg)

    在菜单的第一部分（在先前的屏幕截图中），您有与原生库相关的许多示例。

1.  选择**02.Digital**按钮。

1.  将显示一个新窗口。右键单击代码中的彩色关键字，如图所示：![发现Arduino原生库](img/7584_02_002.jpg)

    在Arduino IDE中直接查找所有保留关键字的参考信息

1.  您可以在此上下文菜单的底部看到**在参考中查找***。这是一个您现在就会理解的非常有用的工具；点击它！

您的IDE直接调用了您的默认浏览器，并显示了一个与您点击的关键字帮助页面相对应的HTML页面。您可以在IDE内部保持专注并获取帮助。

![发现Arduino本地库](img/7584_02_003.jpg)

可用的有用本地帮助文件

## 包含但未直接提供的其他库

Arduino库逐步包括了必要的和有用的其他库。我们在前面的章节中看到，现在使用的库已经集成到Arduino分发的 *核心* 中，这有点滥用，但很好地总结了它们在您仅安装Arduino IDE包时即可使用的事实。

### 一些非常有用的包含库

+   **EEPROM**提供在硬件存储组件中读取/写的函数和类。这对于存储超出Arduino电源状态的内容非常有用，也就是说，即使在断电时。

+   **Ethernet**帮助在以太网网络上进行第2层和第3层通信。

+   **Firmata**用于串行通信。

+   **SD**提供了一种读取/写入SD卡的简单方法；它是对EEPROM解决方案更用户友好的替代方案。

+   **伺服**帮助控制伺服电机。

核心分发中还有一些其他库。有时，还会包含新的库。

### 一些外部库

我建议您检查链接 [http://arduino.cc/en/Reference/Libraries](http://arduino.cc/en/Reference/Libraries) 上同一页引用的库。

我特别使用了以下很多库：

+   **TLC5940**：用于平滑地控制16通道、12位LED控制器

+   **MsTimer2**：用于触发一个必须非常快且甚至每1毫秒就要执行一次的动作（这个库也是芯片组中包含的硬件定时器的一个很好的黑客技巧）

+   **Tone***：用于生成可听见的方波

您可以使用 *Google* 搜索更多库。您会发现很多库，但并非所有都同等文档化和维护。我们将在本书的最后一章中看到如何创建我们自己的库，当然也包括如何为其他用户和 ourselves 优雅地文档化。

# 检查所有基本开发步骤

我们在这里聚在一起不是为了理解代码编译的整个细节。但我想要提供一个全局的解释，这将帮助您更好地理解它的工作原理。这也有助于您理解如何调试源代码以及为什么在某些随机情况下某些东西不会工作。

让我们从一张流程图开始，展示整个流程。

![检查所有基本开发步骤](img/7584_02_004.jpg)

从源代码到二进制可执行代码

以下步骤用于将代码从源代码转换为可执行的生产阶段：

1.  **C和C++源代码**正是您在[第1章](ch01.html "第1章。让我们连接事物") *让我们连接事物* 中为 `Blink250ms` 项目编写的代码类型。

1.  **头文件**通常包含在代码的开头，并引用其他具有`.h`扩展名的文件，其中包含一些定义和类声明。这种设计，其中你有源代码（你目前正在编写的程序）和头文件（已制作元素）的单独文件，为你已经编写的代码的复用提供了一个很好的方式。

1.  **预处理器**是一种基本替换代码中文本元素的例程，考虑到*头文件*和其他*常量*的定义。

1.  **解析器**准备一个将被翻译的文件，该文件将被汇编以生成多个**目标**文件。

1.  **目标文件**包含机器代码，这些代码不能直接由任何硬件处理器执行。

1.  最后一个重要步骤是由**链接器**程序执行的**链接**。链接器将之前编译步骤产生的所有目标文件组合成一个单一的名为**程序**的可执行文件。

1.  从源代码到目标文件，所有过程都概括为`编译`。

1.  通常，库提供目标文件，供链接器链接。有时，特别是在开源世界中，库还附带源代码。这使得对库的任何更改都更容易。在这种情况下，库本身必须编译以生成在全局代码编译中使用的所需目标文件。

1.  因此，我们将**编译**定义为从源代码到程序的整体过程。

我甚至应该使用并介绍另一个术语：**交叉编译**。实际上，我们是在我们的计算机上编译源代码，但最终目标处理器是我们生成的程序（固件）的Arduino处理器。

通常，我们将交叉编译定义为使用一个处理器编译源代码以制作针对另一个处理器的程序的过程。

现在，让我们进一步学习如何精确地使用IDE控制台测试我们的初始C代码片段。

# 使用串行监视器

Arduino板本身可以使用基本的串行通信协议轻松通信。

基本上，**串行通信**是发送数据元素到通道的过程，通常称为**总线**。通常，数据元素是字节，但这完全取决于串行通信的实现。

在串行通信中，数据是**顺序地**发送的，一个接一个。这与**并行通信**相反，在并行通信中，数据通过多个通道同时发送。

## 波特率

因为想要使用串行通信进行通信的两个实体必须对“嘿，一个单词是什么？”这个问题有相同的答案，所以我们必须在双方使用相同的传输速度。实际上，如果我发送`001010101010`，这是一个完整的单词，还是有多个单词？我们必须定义，例如，一个单词是四位数长。然后，我们可以理解前面的例子包含三个单词：`0010`、`1010`和`1010`。这涉及到一个时钟。

那个时钟定义是通过在特定的**波特率**下初始化串行通信来实现的，也称为**波特率**。

1波特表示每秒传输1个符号。一个符号可以超过一个比特。

这就是为什么我们不必在bps（每秒比特数）、波特率之间产生混淆！

## 使用Arduino进行串行通信

每块Arduino板至少有一个串行端口。你可以通过使用数字引脚0和1，或者直接使用USB连接来使用它，当你想要通过串行通信与电脑通信时。

你可以检查[http://arduino.cc/en/Reference/serial](http://arduino.cc/en/Reference/serial)。

在Arduino板上，你可以分别在数字引脚0和1上读取RX和TX。**TX**代表发送，**RX**代表接收；实际上，最基本的串行通信只需要两根线。

我们将在第10章[第10章。一些高级技巧](ch10.html "第10章。一些高级技巧")的*使用I2C和SPI进行LCD、LED和其他有趣游戏*部分稍后描述许多其他类型的串行通信总线。

### 注意

如果你要在Arduino板上使用串行通信，你不能使用数字引脚0和1。

![使用Arduino进行串行通信](img/7584_02_005.jpg)

检查数字引脚1和0上的TX和RX

Arduino IDE提供了一个很好的串行监控器，它通过USB接口显示板通过USB接口发送给电脑的所有符号。它提供了从300波特到115,200波特的多种波特率。我们将在接下来的章节中检查如何使用它。

## 串行监控

串行监控是创建与我们的板非常基本和简单通信的方式！这意味着我们可以通过串行监控来编程它，让它对我们说话。

如果你必须调试某些东西，并且板的行为与你的预期不同，你想“验证问题是否源于固件”，你可以创建一些将消息写入你的例程。这些消息被称为**跟踪**。跟踪对于调试源代码可能是完全必要的。

跟踪将在下一章中详细介绍。

# 让Arduino与我们对话

想象一下，你已经仔细地跟随了`Blink250ms`项目，一切连接都正确无误，你也再次检查过，代码看起来也没有问题，但它就是不起作用。

我们的LED根本就没有闪烁。如何确保你的代码中的`loop()`结构正确运行呢？我们将稍微修改一下代码，以便追踪其步骤。

## 将串行通信添加到Blink250ms

在下面的代码中，我们将为 LED 添加串行通信，使其每 250 毫秒闪烁一次：

1.  打开您之前的代码。

1.  使用 **另存为** 创建一个名为 `TalkingAndBlink250ms` 的另一个项目。

    ### 注意

    从一个已经存在的代码开始，将其保存为另一个名称，并根据您的需求进行修改，这是一个好的实践。

1.  通过添加以下以 `Serial` 开头的所有行来修改当前代码：

    [PRE0]

    ### 注意

    请注意，我每次都会稍微突出显示注释代码，以便使内容更易于阅读。例如，在以下步骤中，我不会写出以下注释：

    // ---------- 循环例程

    您也可以在文件夹 `Chapter02/TalkingAndBlink250ms/` 中的 zip 文件中找到整个代码。

1.  点击 Arduino IDE 中的串行监视器按钮：![向 Blink250ms 添加串行通信](img/7584_02_006.jpg)

    点击右上角的玻璃图标以激活串行监视器

1.  选择与代码中相同的波特率，该波特率位于串行监视窗口的右下角菜单中，并观察正在发生的事情。![向 Blink250ms 添加串行通信](img/7584_02_007.jpg)

    您的 Arduino 板似乎正在与您对话！

您将注意到一些消息出现在串行监视器窗口中，与 LED 闪烁状态同步。

现在，我们可以确信我们的代码是正确的，因为每个消息都已发送，并且所有行都是顺序处理的；这意味着 `digitalWrite()` 函数也被正确调用（没有阻塞）。这些信息可以作为一个线索，例如，再次检查我们的电路，以尝试在那里而不是在代码中找到错误。

当然这是一个简单的例子，但我相信您理解了目标和追踪代码的力量！

## 更详细地了解串行函数

让我们检查我们在代码中添加了什么。

### Serial.begin()

一切都从 `Serial.begin()` 函数开始。这个函数在 `setup()` 例程中只执行一次，即当 Arduino 启动时。

在代码中，我设置了板子以 9,600 波特率启动串行通信。

### Serial.print() 和 Serial.println()

`Serial.print()` 和 `Serial.println()` 几乎相同：它们将某些内容写入串行输出，但 `ln` 版本还会添加回车和换行符。

这个函数的语法是 `Serial.print(val)` 或 `Serial.print(val,format)`。

您可以传递一个或两个参数。

基本上，如果 `Serial.print(5)` 将数字 `5` 打印为 ASCII 编码的十进制符号，那么 `Serial.print(5,OCT)` 将数字 `5` 打印为 ASCII 编码的八进制符号。

## 深入挖掘…

如果您仔细检查了代码（我相信您确实检查了），您会注意到我们放置了两组三行：一组在 `digitalWrite(ledPin,HIGH)` 函数之后，该函数点亮了 LED，另一组在关闭 LED 的行之后。

明白了？

我们要求Arduino板根据传递给数字引脚8（LED仍然连接的引脚）的最后一个命令发送消息。当请求引脚传递电流（LED开启时），板会发送消息；当引脚不传递电流（LED关闭时），板会发送另一条消息。

你刚刚编写了你的第一个跟踪例程。

## 从计算机与板通信

你可能注意到了串行监视器窗口中的文本字段和**发送**按钮：

![从计算机与板通信](img/7584_02_008.jpg)

我们可以通过串行通信将符号发送到我们的Arduino板

这意味着我们也可以使用这个工具从我们的计算机向板发送数据。然而，固件板必须实现一些其他功能，以便能够理解我们想要发送的内容。

在本书的后面部分，我们将看到如何使用串行监视器窗口、天才的Processing框架和Max 6框架轻松地向Arduino板发送消息。

# 摘要

在本章中，我们学习了使用C语言进行编程。我们还学习了如何使用Arduino IDE的串行监视功能，以便更了解我们的Arduino处理器在实时中使用跟踪时发生的情况。

我提到了串行通信，因为它非常有用，并且在许多需要计算机和Arduino板之间进行通信的实际情况项目中也被使用。它也可以用于两个Arduino板之间，或者Arduino板与其他电路之间。

在下一章中，我们将通过使用串行监视器窗口输入C代码，以便使事情更加具体化。
