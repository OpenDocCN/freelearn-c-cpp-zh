<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer391">
<h1 class="chapter-number" id="_idParaDest-219"><a id="_idTextAnchor247"/>12</h1>
<h1 id="_idParaDest-220"><a id="_idTextAnchor248"/>Animation Blending and Montages</h1>
<p>In the previous chapter, you were able to bring the player character to life by implementing movement animations in a Blend Space and using that Blend Space in an Animation Blueprint to drive the animations based on the player’s speed. You were then able to implement functionality in C++ based on player input to allow the character to sprint. Lastly, you took advantage of the Animation State Machine built-in Animation Blueprints to drive the character’s movement state and jumping states to allow fluid transitions between walking and jumping.</p>
<p>With the player character’s Animation Blueprint and State Machine working, it’s time to introduce Animation Montages and Anim Slots by implementing the character’s <strong class="source-inline">Throw</strong> animation. In this chapter, you will learn more about animation blending, see how Unreal Engine handles the blending of multiple animations by creating an Animation Montage, and work with a new Anim Slot for the player’s throwing animation. From there, you will use the Anim Slot in the player’s Animation Blueprint by implementing new functions such as <strong class="source-inline">Save Cached Pose</strong> and <strong class="source-inline">Layered blend per bone</strong> so that the player can correctly blend the movement animations you handled in the previous chapter with the new throwing animation you will implement in this chapter.</p>
<p>In this chapter, you’ll learn about the following topics:</p>
<ul>
<li>How to use Anim Slots to create layered animation blending for the player character</li>
<li>Creating an Animation Montage for the character’s <strong class="source-inline">Throw</strong> animation</li>
<li>Using the <strong class="source-inline">Layered blend per bone node</strong> within the Animation Blueprint to blend together the upper body <strong class="source-inline">Throw</strong> animation and the lower body movement animations of the character</li>
</ul>
<p>By the end of this chapter, you will be able to use the <strong class="source-inline">Animation Montage</strong> tool to create a unique throwing animation using the <strong class="source-inline">Throw</strong> animation sequence you imported in <a href="B18531_10.xhtml#_idTextAnchor199"><em class="italic">Chapter 10</em></a>, <em class="italic">Creating the SuperSideScroller Game</em>. With this montage, you will create and use Anim Slots that will allow you to blend animations in the Animation Blueprint for the player character. You will also get to know how to use blending nodes to effectively blend the movement and throwing animations of the character.</p>
<p>After finalizing the player character animation, you will create the required class and assets for the enemy AI and learn more about Materials and Material Instances, which will give this enemy a unique visual color so that it can be differentiated in-game. Finally, the enemy will be ready for <a href="B18531_13.xhtml#_idTextAnchor268"><em class="italic">Chapter 13</em></a>, <em class="italic">Creating and Adding the Enemy Artificial Intelligence</em>, where you will begin to create the AI behavior logic.</p>
<h1 id="_idParaDest-221"><a id="_idTextAnchor249"/>Technical requirements</h1>
<p>For this chapter, you will need Unreal Engine 5 installed</p>
<p>Let’s start by learning about what Animation Montages and Anim Slots are and how they can be used for character animation.</p>
<p>The project for this chapter can be found in the Chapter12 folder of the code bundle for this book, which can be downloaded here: <a href="https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition">https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition</a>. </p>
<h1 id="_idParaDest-222"><a id="_idTextAnchor250"/>Animation blending, Anim Slots, and Animation Montages</h1>
<p>Animation blending is <a id="_idIndexMarker984"/>the process of transitioning between multiple animations on a skeletal mesh as seamlessly as possible. You are already familiar with the techniques of animation blending because you created a <strong class="source-inline">Blend</strong> <strong class="source-inline">Spaces</strong> asset for the player character in <a href="B18531_11.xhtml#_idTextAnchor222"><em class="italic">Chapter 11</em></a>,<em class="italic"> Working with Blend Space 1D, Key Bindings, and State Machines</em>. In this Blend Space, the character smoothly blends between the <strong class="source-inline">Idle</strong>, <strong class="source-inline">Walking</strong>, and <strong class="source-inline">Running</strong> animations. You will now extend this knowledge by exploring and implementing new additive techniques to combine the movement animations of the character with a throwing animation. Through the use of an Anim Slot, you <a id="_idIndexMarker985"/>will send the throwing animation to a set of upper body bones, and its children’s bones, to allow movement and throwing animations to apply at the same time without negatively impacting the other. But first, let’s talk more about Animation Montages.</p>
<p>Animation Montages <a id="_idIndexMarker986"/>are very powerful assets that allow you to combine multiple animations and split these combined animations into what are called <strong class="bold">Sections</strong>. Sections<a id="_idIndexMarker987"/> can then be played back individually, in a specific sequence, or even looped. </p>
<p>Animation Montages<a id="_idIndexMarker988"/> are also useful because you can control animations through montages from Blueprints or C++; this means you can call logic, update variables, replicate data, and so on, based on the animation section being played, or if any Notifies are called within the montage. In C++, there is the <strong class="source-inline">UAnimInstance</strong> object, which you can use to call functions such as <strong class="source-inline">UAnimInstance::Montage_Play</strong>, which allows you to access and play montages from C++.</p>
<p class="callout-heading">Note</p>
<p class="callout">This method will be used in <a href="B18531_14.xhtml#_idTextAnchor298"><em class="italic">Chapter 14</em></a>, <em class="italic">Spawning the Player Projectile</em>, when you will begin to add polish to the game. More information about how animations and Notifies are handled by Unreal Engine 5 in C++ can be found at <a href="https://docs.unrealengine.com/en-US/API/Runtime/Engine/Animation/AnimNotifies/UAnimNotifyState/index.xhtml">https://docs.unrealengine.com/en-US/API/Runtime/Engine/Animation/AnimNotifies/UAnimNotifyState/index.xhtml</a>. You will learn more about Notifies in the first exercise of this chapter, and you will code your own notify state in <a href="B18531_14.xhtml#_idTextAnchor298"><em class="italic">Chapter 14</em></a>, <em class="italic">Spawning the Player Projectile</em>.</p>
<p>The following figure shows the <a id="_idIndexMarker989"/>Persona editor for Animation Montages. However, this will be broken down even further in <em class="italic">Exercise 12.01</em>, <em class="italic">Setting up the Animation Montage</em>:</p>
<div>
<div class="IMG---Figure" id="_idContainer358">
<img alt="Figure 12.1 – The Persona editor, which opens when editing an Animation Montage " height="838" src="image/Figure_12.01_B18531.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.1 – The Persona editor, which opens when editing an Animation Montage</p>
<p>Just like in <a id="_idIndexMarker990"/>Animation Sequences, Animation Montages allow Notifies to be triggered along the timeline of a section of an animation, which can then trigger sounds, particle effects, and events. Event Notifies will allow us to call logic from Blueprint or C++. Epic Games provides an example in their documentation of a weapon reload Animation Montage that is split between animations for <strong class="source-inline">reload start</strong>, <strong class="source-inline">reload loop</strong>, and <strong class="source-inline">reload complete</strong>. By splitting these animations and applying Notifies for sounds and events, developers have complete control over how long the <strong class="source-inline">reload loop</strong> animation will play based on internal variables, and control over any additional sounds or effects to play during the course of the animation.</p>
<p>Lastly, Animation Montages<a id="_idIndexMarker991"/> support <strong class="bold">Anim Slots</strong>. Anim Slots allow you <a id="_idIndexMarker992"/>to categorize an animation, or a set of animations, that can later be referenced in Animation Blueprints to allow unique blending behavior based on the slot. This means that you can define an Anim Slot that can later be used in Animation Blueprints to allow animations using this slot to blend on top of the base movement animations in any way you want; in our case, only affecting the upper body of the player character and not the lower body. </p>
<p>Let’s begin by creating the Animation Montage for the player character’s <strong class="source-inline">Throw</strong> animation in the first exercise.</p>
<h2 id="_idParaDest-223"><a id="_idTextAnchor251"/>Exercise 12.01 – Setting up the Animation Montage</h2>
<p>One of the<a id="_idIndexMarker993"/> first things you need to do for the player character is to set up the Anim Slot that will separately categorize this animation as an upper-body animation. You will use this Anim Slot in conjunction with blending functions in the Animation Blueprint to allow the player character to throw a projectile, while still correctly animating the lower body while moving and jumping.</p>
<p>By the end of this exercise, the player character will be able to play the <strong class="source-inline">Throw</strong> animation only with their upper body, while their lower body will still use the movement animation that you defined in the previous chapter.</p>
<p>Let’s begin by creating the Animation Montage for the character, throwing and setting up the Anim Slot there:</p>
<ol>
<li>First, navigate to the <strong class="source-inline">/MainCharacter/Animation</strong> directory, which is where all of the animation assets are located. </li>
<li>Now, right-click in the content drawer and hover over the <strong class="bold">Animation</strong> option from the available drop-down menu. </li>
<li>Then, left-click to select the <strong class="bold">Animation Montage</strong> option from the additional drop-down menu that appears. </li>
<li>Just as with creating other animation-based assets, such as <strong class="source-inline">Blend Spaces</strong> or <strong class="source-inline">Animation Blueprints</strong>, Unreal Engine will ask you to assign a <strong class="source-inline">Skeleton</strong> object for this Animation Montage. In this case, select <strong class="source-inline">MainCharacter_Skeleton</strong>.</li>
<li>Name the new Animation Montage <strong class="source-inline">AM_Throw</strong>. Now, double-left-click to open the montage.</li>
</ol>
<p>When you open the <strong class="source-inline">Animation Montage</strong> asset, you are presented with a similar editor layout as you would when opening an Animation Sequence. There is a <strong class="bold">Preview</strong> window that shows the main character skeleton in the default T pose, but once you add animations to this montage, the skeleton will update to reflect those changes.</p>
<p>With this exercise complete, you have successfully created an <strong class="bold">Animation Montage</strong> asset for the <strong class="bold">Super SideScroller</strong> project. Now, it is time to learn more about Animation Montages <a id="_idIndexMarker994"/>and how you can add the <strong class="source-inline">Throw</strong> animation and Anim Slot you need in order to blend the <strong class="source-inline">Throw</strong> animation with the existing character movement animations.</p>
<h1 id="_idParaDest-224"><a id="_idTextAnchor252"/>Animation Montages</h1>
<p>Have a <a id="_idIndexMarker995"/>look at the following figure:</p>
<div>
<div class="IMG---Figure" id="_idContainer359">
<img alt="Figure 12.2 – The Preview window alongside the Montage and Sections areas " height="821" src="image/Figure_12.02_B18531.jpg" width="1404"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.2 – The Preview window alongside the Montage and Sections areas</p>
<p>Underneath the <strong class="bold">Preview</strong> window, you have the main montage timeline, in addition to other sections. Let’s evaluate these sections from top to bottom:</p>
<ul>
<li><strong class="bold">Montage</strong>: The <strong class="bold">Montage</strong> section is a<a id="_idIndexMarker996"/> collection of animations that can have one or more animations. You can also right-click on any point in the timeline to create a section. </li>
<li><strong class="bold">Montage Sections</strong>: Sections allow you to compartmentalize the different parts of the montage into their own self-contained section, which allows you to set the order of how the individual animation sequences are played and whether a section should loop.</li>
</ul>
<p>For the purposes of<a id="_idIndexMarker997"/> the <strong class="source-inline">Throw</strong> montage, you do not need to use this feature since you will only be using one animation in this montage:</p>
<ul>
<li><strong class="bold">Timing</strong>: The <strong class="bold">Timing</strong> section gives you a preview of the montage and the sequential order of the varied aspects of the montage. The playback order of <strong class="bold">Notifies</strong>, the <strong class="bold">Montage</strong> section, and other elements will be visually displayed here to give you a quick preview of how the montage will work.</li>
<li><strong class="bold">Notifies</strong>: This gives you the ability to add points to an animation time frame that can then notify other systems to perform an action or to call logic from both Blueprints and C++. Notify options, such as <strong class="source-inline">Play Sound</strong> or <strong class="source-inline">Play Particle Effect</strong>, allow you to play a sound or particle at a specific time in the animation. You will use these Notifies later on in this project when you implement the throwing projectile:</li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer360">
<img alt="Figure 12.3 – The Timing and Notifies areas " height="370" src="image/Figure_12.03_B18531.jpg" width="1095"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.3 – The Timing and Notifies areas</p>
<p>Now that you are familiar with the interface for Animation Montages, you can add the <strong class="source-inline">Throw</strong> animation to the montage by following the next exercise.</p>
<h2 id="_idParaDest-225"><a id="_idTextAnchor253"/>Exercise 12.02 – Adding the Throw animation to the montage</h2>
<p>Now that<a id="_idIndexMarker998"/> you have a better <a id="_idIndexMarker999"/>understanding of what Animation Montages are and how these assets work, it is time to add the <strong class="source-inline">Throw</strong> animation to the montage you created in <em class="italic">Exercise 12.01</em>, <em class="italic">Setting up the Animation Montage</em>. Although you will only be adding one animation to this montage, it is important to emphasize that you can add multiple unique animations to a montage that you can then play back. Now, let’s start by adding the <strong class="source-inline">Throw</strong> animation you imported into the project in <a href="B18531_10.xhtml#_idTextAnchor199"><em class="italic">Chapter 10</em></a>, <em class="italic">Creating the SuperSideScroller Game</em>:</p>
<ol>
<li value="1">In <strong class="bold">Asset Browser</strong>, find the <strong class="source-inline">Throw</strong> animation asset. Then, left-click and drag it onto the timeline in the <strong class="bold">Montage</strong> section:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer361">
<img alt="Figure 12.4 – The Asset Browser window with animation-based assets " height="367" src="image/Figure_12.04_B18531.jpg" width="829"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.4 – The Asset Browser window with animation-based assets</p>
<p>Once an<a id="_idIndexMarker1000"/> animation<a id="_idIndexMarker1001"/> is added to the Animation Montage, the character skeleton in the <strong class="bold">Preview</strong> window will update to reflect this change and begin playing the animation:</p>
<div>
<div class="IMG---Figure" id="_idContainer362">
<img alt="Figure 12.5 – The player character begins to animate " height="914" src="image/Figure_12.05_B18531.jpg" width="1389"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.5 – The player character begins to animate</p>
<p>Now that the <strong class="source-inline">Throw</strong> animation <a id="_idIndexMarker1002"/>has been<a id="_idIndexMarker1003"/> added to the Animation Montage, you can move on to create the Anim Slot.</p>
<p>The <strong class="bold">Anim Slot Manager</strong> tab should be docked next to the <strong class="bold">Asset Browser</strong> tab on the right-hand side. If you don’t see the <strong class="bold">Anim Slot Manager</strong> tab, you can access it by navigating to the <strong class="bold">Window</strong> tab in the toolbar at the top of the <strong class="bold">Animation Montage</strong> editor window. There, left-click to select the option for <strong class="bold">Anim Slot Manager</strong>, and the window will appear. </p>
<p>By completing this exercise, you have added the <strong class="source-inline">Throw</strong> animation to your new Animation Montage and you were able to play back the animation to preview how it looks in the editor through <strong class="bold">Persona</strong>.</p>
<p>Now, you can move on to learn more about Anim Slots and Anim Slot Manager before adding your own unique Anim Slot to use for animation blending later in this chapter.</p>
<h1 id="_idParaDest-226"><a id="_idTextAnchor254"/>Anim Slot Manager</h1>
<p><strong class="bold">Anim Slot Manager</strong> is<a id="_idIndexMarker1004"/> where you, as the name suggests, manage your Anim Slots. From this tab, you can create new groups, which allows greater organization of your slots. For example, you can create a group by left-clicking on the <strong class="bold">Add Group</strong> option and labeling it <strong class="source-inline">Face</strong> to articulate to others that the slots within this group affect the face of the character. By default, Unreal Engine provides you with a group called <strong class="source-inline">DefaultGroup</strong> and an Anim Slot called <strong class="source-inline">DefaultSlot</strong>, which is in that group.</p>
<p>In the following exercise, we will create a new Anim Slot specifically for the upper body of the player character.</p>
<h2 id="_idParaDest-227"><a id="_idTextAnchor255"/>Exercise 12.03 – Adding a new Anim Slot</h2>
<p>Now that you<a id="_idIndexMarker1005"/> have a better understanding of Anim Slots and <strong class="bold">Anim Slot Manager</strong>, you can follow these steps to create a new Anim Slot, which you will call <strong class="source-inline">Upper Body</strong>. Once you have this new slot created, it can then be used and referenced in your Animation Blueprint to handle animation blending, which you will do in a later exercise.</p>
<p>Let’s create the Anim Slot by doing the following:</p>
<ol>
<li value="1">In <strong class="bold">Anim Slot Manager</strong>, left-click on the <strong class="bold">Add Slot</strong> option.</li>
<li>When adding a new slot, Unreal will ask you to give this Anim Slot a name. Name this slot <strong class="source-inline">Upper Body</strong>. Anim Slot naming is important, much like naming any other assets and parameters, as you will be referencing this slot in the Animation Blueprint later.</li>
</ol>
<p>With the Anim Slot created, you can now update the slot used for the Throw montage.</p>
<ol>
<li value="3">In the <strong class="bold">Montage</strong> section, there is a drop-down menu that displays the applied Anim Slot; by default, it’s set to <strong class="source-inline">DefaultGroup.DefaultSlot</strong>. Left-click, and from the drop-down menu, select <strong class="source-inline">DefaultGroup.Upper Body</strong>:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer363">
<img alt="Figure 12.6 – The new Anim Slot will appear in the drop-down list " height="320" src="image/Figure_12.06_B18531.jpg" width="735"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.6 – The new Anim Slot will appear in the drop-down list</p>
<p class="callout-heading">Note</p>
<p class="callout">After changing the Anim Slot, you may notice that the player character stops animating and returns to the T pose. Don’t worry – if this happens, just close the Animation Montage and reopen it. Once reopened, the character will play the <strong class="source-inline">Throw</strong> animation again.</p>
<p>With your Anim Slot created and in place in the <strong class="source-inline">Throw</strong> montage, it is now time for you to update the Animation Blueprint so that the player character is aware of this slot and animates correctly based on it.</p>
<p>With this<a id="_idIndexMarker1006"/> exercise complete, you have created your first Anim Slot using Anim Slot Manager, available in the Animation Montage. With this slot in place, it can now be used and referenced in the player character Animation Blueprint to handle the animation blending required to blend the <strong class="source-inline">Throw</strong> animation and the movement animations you implemented in the previous chapter. Before you do this, you need to learn more about the <strong class="source-inline">Save Cached Pose</strong> node in Animation Blueprints.</p>
<h1 id="_idParaDest-228"><a id="_idTextAnchor256"/>Save Cached Pose</h1>
<p>There are<a id="_idIndexMarker1007"/> cases when working with complex animations and characters requires you to reference a pose that is outputted by a State Machine in more than one place. If you hadn’t noticed already, the output pose from your <strong class="source-inline">Movement</strong> State Machine cannot be connected to more than one other node. This is where the <strong class="source-inline">Save Cached Pose</strong> node comes in handy; it allows you to cache (or store) a pose that can then be referenced in multiple places at once. You will need to use this to set up the new Anim Slot for the upper body animation. </p>
<p>In the next exercise, you will implement the <strong class="source-inline">Save Cached Pose</strong> node to cache the <strong class="source-inline">Movement</strong> State Machine.</p>
<h2 id="_idParaDest-229"><a id="_idTextAnchor257"/>Exercise 12.04 – Save Cached Pose of the Movement State Machine</h2>
<p>To effectively blend the <strong class="source-inline">Throw</strong> animation, which uses the <strong class="source-inline">Upper Body</strong> Anim Slot you created in the previous exercise with the movement animations already in place for the player character, you need to be able to<a id="_idIndexMarker1008"/> reference the <strong class="source-inline">Movement</strong> State Machine in the Animation Blueprint. To do this, do the following to implement the <strong class="source-inline">Save Cached Pose</strong> node in the Animation Blueprint: </p>
<ol>
<li value="1">In the Anim Graph of <strong class="source-inline">AnimBP_SuperSideScroller_MainCharacter</strong>, right-click and search for <strong class="source-inline">New Save Cached Pose</strong>. Name this <strong class="source-inline">Movement Cache</strong>:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer364">
<img alt="Figure 12.7 – The pose will be evaluated once per frame and then cached " height="281" src="image/Figure_12.07_B18531.jpg" width="941"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.7 – The pose will be evaluated once per frame and then cached</p>
<ol>
<li value="2">Now, instead of connecting your <strong class="source-inline">Movement</strong> state machine directly to the output pose, connect it to the cache node:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer365">
<img alt="Figure 12.8 – The Movement State Machine is being cached " height="218" src="image/Figure_12.08_B18531.jpg" width="537"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.8 – The Movement State Machine is being cached</p>
<ol>
<li value="3">With<a id="_idIndexMarker1009"/> the <strong class="source-inline">Movement</strong> State Machine pose being cached, all you have to do now is reference it. This can be done by searching for the <strong class="source-inline">Use Cached Pose</strong> node.</li>
</ol>
<p class="callout-heading">Note</p>
<p class="callout">All cached poses will show in the context-sensitive menu. Just make sure you select the cached pose with the name you gave it in <em class="italic">step 1</em>.</p>
<ol>
<li value="4">With the cached pose node available, connect it to <strong class="source-inline">Output Pose</strong> of the Anim Graph:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer366">
<img alt="Figure 12.9 – The cached pose is now feeding directly to Output Pose " height="582" src="image/Figure_12.09_B18531.jpg" width="948"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.9 – The cached pose is now feeding directly to Output Pose</p>
<p>You will notice now, after <em class="italic">step 4</em>, that the main character will animate correctly and move as you <a id="_idIndexMarker1010"/>expect after the last chapter. This proves that the caching of the <strong class="source-inline">Movement</strong> State Machine is working. The following figure shows the player character back in his <strong class="source-inline">Idle</strong> animation in the <strong class="bold">Preview</strong> window of the Animation Blueprint:</p>
<div>
<div class="IMG---Figure" id="_idContainer367">
<img alt="Figure 12.10 – The main character is animating as expected " height="597" src="image/Figure_12.10_B18531.jpg" width="1031"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.10 – The main character is animating as expected</p>
<p>Now that you <a id="_idIndexMarker1011"/>have the caching of the <strong class="source-inline">Movement</strong> State Machine working, you will use this cache to blend animations through the skeleton based on the Anim Slot you created:</p>
<p>With this exercise complete, you now have the ability to reference the cached <strong class="source-inline">Movement</strong> State Machine pose anywhere you would like within the Animation Blueprint. With this accessibility in place, you can now use the cached pose to begin the blending between the cached movement pose and the <strong class="source-inline">Upper Body</strong> Anim Slot using a function called <strong class="source-inline">Layered blend per bone</strong>.</p>
<h1 id="_idParaDest-230"><a id="_idTextAnchor258"/>Layered blend per bone</h1>
<p>The node that you will <a id="_idIndexMarker1012"/>use to blend animations here is called <strong class="source-inline">Layered blend per bone</strong>. This node masks out a set of bones on the character’s skeleton for an animation to ignore those bones.</p>
<p>In the case of our player character and the <strong class="source-inline">Throw</strong> animation, you will mask out the lower body so that only the upper body animates. The goal is to be able to perform the <strong class="source-inline">Throw</strong> and movement <a id="_idIndexMarker1013"/>animations at the same time and have these animations blend together; otherwise, when you perform the throw, the movement animations would completely break. </p>
<p>In the following exercise, you will use <strong class="source-inline">Layered blend per bone</strong> to mask out the lower half of the player character so that the <strong class="source-inline">Throw</strong> animation only affects the upper body of the character.</p>
<h2 id="_idParaDest-231"><a id="_idTextAnchor259"/>Exercise 12.05 – Blending animation with the Upper Body Anim Slot</h2>
<p>The <strong class="source-inline">Layered blend per bone</strong> function allows us to blend the <strong class="source-inline">Throw</strong> animation with the<a id="_idIndexMarker1014"/> movement animations you implemented in the previous chapter, and give you control over how much influence the <strong class="source-inline">Throw</strong> animation will have on the player character’s skeleton.</p>
<p>In this exercise, you will use the <strong class="source-inline">Layered blend per bone</strong> function to completely mask out the lower body of the character when playing the <strong class="source-inline">Throw</strong> animation so that it does not influence the character movement animation of the lower body.</p>
<p>Let’s begin by adding the <strong class="source-inline">Layered blend per bone</strong> node and discussing its input parameters and its settings:</p>
<ol>
<li value="1">Inside the Animation Blueprint, right-click and search for <strong class="source-inline">Layered blend per bone</strong> in the <strong class="bold">Context Sensitive</strong> search. <em class="italic">Figure 12.11</em> shows the <strong class="source-inline">Layered blend per bone</strong> node and its parameters:<ul><li>The first parameter, <strong class="source-inline">Base Pose</strong>, is for the base pose of the character; in this case, the cached pose of the <strong class="source-inline">Movement</strong> State Machine will be the base pose. </li><li>The second parameter is the <strong class="source-inline">Blend Poses 0</strong> node that you want to layer on top of <strong class="source-inline">Base Pose</strong>; keep in mind that selecting <strong class="bold">Add pin</strong> will create additional <strong class="source-inline">Blend Poses</strong> and <strong class="source-inline">Blend Weights</strong> parameters. For now, you will only be working with one <strong class="source-inline">Blend Poses</strong> node. </li><li>The last parameter is <strong class="source-inline">Blend Weights</strong>, which is how much <strong class="source-inline">Blend Poses</strong> will affect <strong class="source-inline">Base Pose</strong> on a scale from <strong class="source-inline">0.0</strong> to <strong class="source-inline">1.0</strong> as an alpha:</li></ul></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer368">
<img alt="Figure 12.11 – The Layered blend per bone node " height="243" src="image/Figure_12.11_B18531.jpg" width="652"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.11 – The Layered blend per bone node</p>
<p>Before you <a id="_idIndexMarker1015"/>connect anything to this node, you will need to add a layer to its properties. </p>
<ol>
<li value="2">Left-click to select the node and navigate to <strong class="bold">Details</strong>. You will need to left-click on the arrow next to <strong class="bold">Layer Setup</strong> to find the first index, <strong class="source-inline">0</strong>, of this setup. Left-click on <strong class="bold">+</strong> next to <strong class="bold">Branch Filters</strong> to create a new filter.</li>
</ol>
<p>There are again two parameters here, namely the following:</p>
<ul>
<li><strong class="source-inline">Bone Name</strong>: The bone to specify where the blending will take place and determine the child hierarchy of bones masked out. In the case of the main character skeleton for this project, set <strong class="source-inline">Bone Name</strong> to <strong class="source-inline">Spine</strong>. <em class="italic">Figure 12.12</em> shows how the <strong class="source-inline">Spine</strong> bone and its children are unassociated with the lower body of the main character. This can be seen in the <strong class="source-inline">Skeleton</strong> asset, <strong class="source-inline">MainCharacter_Skeleton</strong>:</li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer369">
<img alt="Figure 12.12 – The Spine bone and its children are associated with the upper body of the main character " height="165" src="image/Figure_12.12_B18531.jpg" width="629"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.12 – The Spine bone and its children are associated with the upper body of the main character</p>
<ul>
<li><strong class="source-inline">Blend Depth</strong>: The depth in which bones and their children will be affected by the animation. A value of <strong class="source-inline">0</strong> will not affect the rooted children of the selected bone.</li>
<li><strong class="source-inline">Mesh Space Rotation Blend</strong>: Determines whether or not to blend bone <a id="_idIndexMarker1016"/>rotations in mesh space or local space. Mesh space rotation refers to the skeletal mesh’s bounding box as its base rotation, while local space rotation refers to the local rotation of the bone name in question. In this case, we want the rotation blend to occur in mesh space, so we will set this parameter to <strong class="source-inline">true</strong>.</li>
</ul>
<p>Blending is propagated to all the children of a bone to stop blending on particular bones, add them to the array, and make their blend depth value <strong class="source-inline">0</strong>. The final result is as follows:</p>
<div>
<div class="IMG---Figure" id="_idContainer370">
<img alt="Figure 12.13 – You can set up multiple layers with one blend node " height="485" src="image/Figure_12.13_B18531.jpg" width="800"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.13 – You can set up multiple layers with one blend node</p>
<ol>
<li value="3">With the <a id="_idIndexMarker1017"/>settings in place on the <strong class="source-inline">Layered blend per bone</strong> node, you can connect the <strong class="source-inline">Movement Cache</strong> cached pose into the <strong class="source-inline">Base Pose</strong> node of the layered blend. Make sure you connect the output of the <strong class="source-inline">Layered blend per bone</strong> node to <strong class="source-inline">Output Pose</strong> of the Animation Blueprint:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer371">
<img alt="Figure 12.14 – Add the cached pose for the Movement State Machine to the Layered blend per bone node " height="471" src="image/Figure_12.14_B18531.jpg" width="1042"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.14 – Add the cached pose for the Movement State Machine to the Layered blend per bone node</p>
<p>Now, it’s time to use the Anim Slot you created earlier to filter only the animations using this slot through the <strong class="source-inline">Layered blend per bone</strong> node.</p>
<ol>
<li value="4">Right-click in <a id="_idIndexMarker1018"/>the Anim Graph and search for <strong class="source-inline">DefaultSlot</strong>. Left-click to select the <strong class="source-inline">Slot</strong> node and navigate to <strong class="bold">Details</strong>. There, you will find the <strong class="source-inline">Slot Name</strong> property. Left-click on this dropdown to find and select the <strong class="source-inline">DefaultGroup.Upper Body</strong> slot.</li>
</ol>
<p>When changing the <strong class="source-inline">Slot Name</strong> property, the <strong class="source-inline">Slot</strong> node will update to represent this new name. The <strong class="source-inline">Slot</strong> node requires a source pose, which will again be a reference to the <strong class="source-inline">Movement</strong> State Machine. This means that you need to create another <strong class="source-inline">Use Cached Pose</strong> node for the <strong class="source-inline">Movement Cache</strong> pose.</p>
<ol>
<li value="5">Connect the cached pose to the source of the <strong class="source-inline">Slot</strong> node:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer372">
<img alt="Figure 12.15 – Filtering the cached movement pose through the Anim Slot " height="168" src="image/Figure_12.15_B18531.jpg" width="629"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.15 – Filtering the cached movement pose through the Anim Slot</p>
<ol>
<li value="6">All that is<a id="_idIndexMarker1019"/> left to do now is to connect the <strong class="source-inline">Upper Body</strong> slot node to the <strong class="source-inline">Blend Poses 0</strong> input. Then, connect the final pose of the <strong class="source-inline">Layered blend per bone</strong> to the result of the <strong class="source-inline">Output Pose</strong> Animation Blueprint:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer373">
<img alt="Figure 12.16 – The final setup of the main character’s Animation Blueprint " height="492" src="image/Figure_12.16_B18531.jpg" width="1070"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.16 – The final setup of the main character’s Animation Blueprint</p>
<p>With the Anim Slot and the <strong class="source-inline">Layered blend per bone</strong> node in place within the main character’s Animation Blueprint, you are finally done with the animation side of the main character.</p>
<p>With the <a id="_idIndexMarker1020"/>Animation Blueprint updated, we can now move on to the next exercise, where we can finally preview the <strong class="source-inline">Throw</strong> animation in action.</p>
<h2 id="_idParaDest-232"><a id="_idTextAnchor260"/>Exercise 12.06 – Previewing the Throw animation</h2>
<p>In the <a id="_idIndexMarker1021"/>previous exercise, you did a lot of work<a id="_idIndexMarker1022"/> to allow animation blending between the player character’s <strong class="source-inline">Movement</strong> animations and the <strong class="source-inline">Throw</strong> animation by using the <strong class="source-inline">Save Cached Pose</strong> and <strong class="source-inline">Layered blend per bone</strong> nodes. Perform the following steps to preview the <strong class="source-inline">Throw</strong> animation in-game and see the fruits of your labor:</p>
<ol>
<li value="1">Navigate to the <strong class="source-inline">/MainCharacter/Blueprints/</strong> directory and open the character’s <strong class="source-inline">BP_SuperSideScroller_MainCharacter</strong> Blueprint. </li>
<li>If you recall, in the last chapter, you created <strong class="source-inline">Enhanced Input Action</strong> for throwing with <strong class="source-inline">IA_Throw</strong> . </li>
<li>Inside <strong class="source-inline">Event Graph</strong> of the character’s Blueprint, right-click and search for <strong class="source-inline">EnhancedInputAction IA_Throw</strong> in the <strong class="bold">Context Sensitive</strong> drop-down search. Select it with a left-click to create the event node in the graph. </li>
</ol>
<p>With this event in place, you need a function that allows you to play an Animation Montage when the player uses the left mouse button to throw.</p>
<ol>
<li value="4">Right-click in <strong class="source-inline">Event Graph</strong> and search for <strong class="source-inline">Play Montage</strong>. Make sure not to confuse this with a similar function, <strong class="source-inline">Play Anim Montage</strong>. </li>
</ol>
<p>The <strong class="source-inline">Play Montage</strong> function requires two important inputs:</p>
<ul>
<li><strong class="source-inline">Montage to Play</strong></li>
<li><strong class="source-inline">In Skeletal Mesh Component</strong></li>
</ul>
<p>Let’s first handle the <strong class="source-inline">Skeletal Mesh</strong> component. </p>
<ol>
<li value="5">The player character has a <strong class="source-inline">Skeletal Mesh</strong> component that can be found in the <strong class="bold">Components</strong> tab labeled <strong class="source-inline">Mesh</strong>. Left-click and drag out a <strong class="source-inline">Get</strong> reference to this <a id="_idIndexMarker1023"/>variable and connect it<a id="_idIndexMarker1024"/> to the <strong class="source-inline">In Skeletal Mesh Component</strong> input of this function:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer374">
<img alt="Figure 12.17 – The mesh of the player character connected to the In Skeletal Mesh Component input " height="389" src="image/Figure_12.17_B18531.jpg" width="1064"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.17 – The mesh of the player character connected to the In Skeletal Mesh Component input</p>
<p>The last thing to do now is to tell this function which montage to play. Luckily for you, there is only one montage that exists in this project: <strong class="source-inline">AM_Throw</strong>. </p>
<ol>
<li value="6">Left-click on the drop-down menu under the <strong class="source-inline">Montage to Play</strong> input and left-click to select <strong class="source-inline">AM_Throw</strong>. </li>
<li>Finally, connect the <strong class="source-inline">Triggered</strong> execution output of the <strong class="source-inline">EnhancedInputAction IA_Throw</strong> event to the execution input pin of the <strong class="source-inline">Play Montage</strong> function:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer375">
<img alt="Figure 12.18 – Now the AM_Throw montage plays when the ThrowProjectile input is pressed " height="419" src="image/Figure_12.18_B18531.jpg" width="1003"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.18 – Now the AM_Throw montage plays when the ThrowProjectile input is pressed</p>
<ol>
<li value="8">Now, when <a id="_idIndexMarker1025"/>you click your left mouse button, the player character will play the throwing Animation Montage. </li>
</ol>
<p>Notice now <a id="_idIndexMarker1026"/>how you can walk and run at the same time as throwing, and each animation blends together so as not to interfere with one another:</p>
<div>
<div class="IMG---Figure" id="_idContainer376">
<img alt="Figure 12.19 – The player character can now move and throw " height="413" src="image/Figure_12.19_B18531.jpg" width="1033"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.19 – The player character can now move and throw</p>
<p>Don’t worry about any bugs you might see when using the left mouse button action repeatedly to play the <strong class="source-inline">Throw</strong> montage; these issues will be addressed when you implement the projectile that will be thrown in a later chapter for this project. For now, you just want to <a id="_idIndexMarker1027"/>know that the work <a id="_idIndexMarker1028"/>done on the Anim Slot and the Animation Blueprint give the desired result for animation blending.</p>
<p>Let’s continue with the <strong class="bold">SuperSideScroller</strong> project by now creating the C++ class, the Blueprints, and the materials necessary to set up the enemy for use in the next chapter. </p>
<h1 id="_idParaDest-233"><a id="_idTextAnchor261"/>The SuperSideScroller game enemy</h1>
<p>With the player<a id="_idIndexMarker1029"/> character animating correctly when moving and performing the <strong class="source-inline">Throw</strong> animation, it is time to talk about the enemy type that the <strong class="bold">SuperSideScroller</strong> game will feature. </p>
<p>This enemy will have a basic back-and-forth movement pattern and will not support any attacks; only by colliding with the player character will it be able to inflict damage. </p>
<p>In the next exercise, you will set up the base enemy class in C++ for the first enemy type and configure the enemy’s Blueprint and Animation Blueprint in preparation for <a href="B18531_13.xhtml#_idTextAnchor268"><em class="italic">Chapter 13</em></a>, <em class="italic">Creating and Adding the Enemy Artificial Intelligence</em>, where you will implement the AI of this enemy. For the sake of efficiency and time, you will use the assets already provided by Unreal Engine 5 in the <strong class="bold">SideScroller</strong> template for the enemy. This means you will be using the skeleton, skeletal mesh, animations, and the Animation Blueprint of the default mannequin asset. Let’s begin by creating the first enemy class.</p>
<h2 id="_idParaDest-234"><a id="_idTextAnchor262"/>Exercise 12.07 – Creating the enemy base C++ class</h2>
<p>The <a id="_idIndexMarker1030"/>goal of this exercise is to create a new enemy class from scratch and to have the enemy ready to use in <a href="B18531_13.xhtml#_idTextAnchor268"><em class="italic">Chapter 13</em></a>, <em class="italic">Creating and Adding the Enemy Artificial Intelligence</em>, when you will develop the AI. To start, create a new enemy class in C++ by following these steps:</p>
<ol>
<li value="1">In the editor, navigate to <strong class="bold">Tools</strong> and select <strong class="bold">New C++ Class</strong> to get started with creating your new enemy class. In the editor, create a new C++ class that derives from the <strong class="source-inline">SuperSideScrollreCharacter</strong> parent class.</li>
<li>Give this class a name and select a directory. Name this class <strong class="source-inline">EnemyBase</strong> and do not change the directory path. When ready, left-click on the <strong class="bold">Create Class</strong> button to have Unreal Engine create the new class for you. </li>
</ol>
<p>Let’s<a id="_idIndexMarker1031"/> create the folder structure in the content drawer for the enemy assets next.</p>
<ol>
<li value="3">Head back to the Unreal Engine 5 editor, navigate to the content drawer, and create a new folder called <strong class="source-inline">Enemy</strong>:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer377">
<img alt="Figure 12.20 – The new Enemy folder " height="353" src="image/Figure_12.20_B18531.jpg" width="654"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.20 – The new Enemy folder</p>
<ol>
<li value="4">In the <strong class="source-inline">Enemy</strong> folder, create another folder called <strong class="source-inline">Blueprints</strong>, where you will create and save the Blueprint assets for the enemy. Right-click and select <strong class="bold">Blueprint Class</strong>. From <strong class="bold">Pick Parent Class</strong>, search for the new C++ class you just made, <strong class="source-inline">EnemyBase</strong>, as shown here:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer378">
<img alt="Figure 12.21 – Now, the new EnemyBase class is available for you to create a Blueprint from " height="628" src="image/Figure_12.21_B18531.jpg" width="869"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.21 – Now, the new EnemyBase class is available for you to create a Blueprint from</p>
<ol>
<li value="5">Name this <strong class="source-inline">BP_Enemy</strong>.</li>
</ol>
<p>Now that <a id="_idIndexMarker1032"/>you have the Blueprint for the first enemy using the <strong class="source-inline">EnemyBase</strong> class as the parent class, it is time to handle the Animation Blueprint. You will use the default Animation Blueprint that is provided to you by Unreal Engine in the <strong class="bold">SideScroller</strong> template project. Follow the steps in the next exercise to create a duplicate of the existing Animation Blueprint and move it to the <strong class="source-inline">/Enemy/Blueprints</strong> directory.</p>
<h2 id="_idParaDest-235"><a id="_idTextAnchor263"/>Exercise 12.08 – Creating and applying the enemy Animation Blueprint</h2>
<p>In the previous <a id="_idIndexMarker1033"/>exercise, you created a Blueprint for the first enemy using the <strong class="source-inline">EnemyBase</strong> class as the parent class. In <a id="_idIndexMarker1034"/>this exercise, you will be working with the Animation Blueprint.</p>
<p>The following steps will help you complete this exercise:</p>
<ol>
<li value="1">Navigate to the <strong class="source-inline">/Mannequin/Animations</strong> directory and find the <strong class="source-inline">ThirdPerson_AnimBP</strong> asset.</li>
<li>Now, duplicate the <strong class="source-inline">ThirdPerson_AnimBP</strong> asset. There are two ways to duplicate an asset:<ol><li>Select the desired asset in the content drawer and press <em class="italic">Ctrl</em> + <em class="italic">W</em>.</li><li>Right-click on the desired asset in the content drawer and select <strong class="source-inline">Duplicate</strong> from the drop-down menu. </li></ol></li>
<li>Now, left-click and drag this duplicate asset into the <strong class="source-inline">/Enemy/Blueprints</strong> directory and select the option to move when you release the left-click mouse button.</li>
<li>Name this duplicate asset <strong class="source-inline">AnimBP_Enemy</strong>. It is best to create a duplicate of an asset that you can later modify if you so desire without risking the functionality of the original.</li>
</ol>
<p>With the enemy Blueprint and Animation Blueprint created, it’s time to update the enemy Blueprint to use the default <strong class="source-inline">Skeletal Mesh</strong> mannequin and the new Animation Blueprint duplicate.</p>
<ol>
<li value="5">Navigate to <strong class="source-inline">/Enemy/Blueprints</strong> and open <strong class="source-inline">BP_Enemy</strong>. </li>
<li>Next, navigate to the <strong class="source-inline">Mesh</strong> component and select it to access its <strong class="bold">Details</strong> panel. First, assign <strong class="bold">SK_Mannequin</strong> to the <strong class="bold">Skeletal Mesh</strong> parameter, as shown here:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer379">
<img alt="Figure 12.22 – You will use the default SK_Mannequin skeletal mesh for the new enemy " height="124" src="image/Figure_12.22_B18531.jpg" width="683"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.22 – You will use the default SK_Mannequin skeletal mesh for the new enemy</p>
<ol>
<li value="7">Now, you<a id="_idIndexMarker1035"/> need to apply the <strong class="source-inline">AnimBP_Enemy</strong> Animation Blueprint to the <strong class="source-inline">Mesh</strong> component. Navigate to the <strong class="source-inline">Animation</strong> category of the <strong class="source-inline">Mesh</strong> component’s <strong class="bold">Details</strong> panel, and under <strong class="bold">Anim Class</strong>, assign <strong class="source-inline">AnimBP_Enemy</strong>:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer380">
<img alt="Figure 12.23 – Assign the new AnimBP_Enemy as the Anim class  " height="367" src="image/Figure_12.23_B18531.jpg" width="692"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.23 – Assign the new AnimBP_Enemy as the Anim class </p>
<ol>
<li value="8">Lastly, you will notice that the character mesh is positioned and rotated incorrectly when previewing the character in the <strong class="bold">Preview</strong> window. Fix this by setting the <strong class="bold">Transform</strong> property of the <strong class="bold">Mesh</strong> component to the following: <ul><li><strong class="bold">Location</strong>: (<strong class="source-inline">X</strong> = <strong class="source-inline">0.000000</strong>, <strong class="source-inline">Y</strong> = <strong class="source-inline">0.000000</strong>, <strong class="source-inline">Z</strong> = <strong class="source-inline">-90.000000</strong>)</li><li><strong class="bold">Rotation</strong>: (Roll= <strong class="source-inline">0.000000</strong>, Pitch= <strong class="source-inline">0</strong>, Yaw=<strong class="source-inline"> -90.000000</strong>)</li><li><strong class="bold">Scale</strong>: (<strong class="source-inline">X</strong> = <strong class="source-inline">1.000000</strong>, <strong class="source-inline">Y</strong> = <strong class="source-inline">1.000000</strong>, <strong class="source-inline">Z</strong> = <strong class="source-inline">1.000000</strong>)</li></ul></li>
</ol>
<p>The <strong class="source-inline">Transform</strong> settings will appear as follows:</p>
<div>
<div class="IMG---Figure" id="_idContainer381">
<img alt="Figure 12.24 – The final Transform settings for the enemy character " height="108" src="image/Figure_12.24_B18531.jpg" width="675"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.24 – The final Transform settings for the enemy character</p>
<p>The<a id="_idIndexMarker1036"/> following figure shows the settings of the <strong class="bold">Mesh</strong> component so far. Please make sure your settings match what is displayed in <em class="italic">Figure 12.25</em>: </p>
<div>
<div class="IMG---Figure" id="_idContainer382">
<img alt="Figure 12.25 – The settings for the Mesh component of your enemy character " height="416" src="image/Figure_12.25_B18531.jpg" width="873"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.25 – The settings for the Mesh component of your enemy character</p>
<p>The last thing to do here is to create a Material Instance of the mannequin’s primary material so that this enemy can have a unique color that helps differentiate it from the other enemy type.</p>
<p>Let’s begin by first learning more about Materials and Material Instances. </p>
<h1 id="_idParaDest-236"><a id="_idTextAnchor264"/>Materials and Material Instances</h1>
<p>Before moving on to the next exercise, we need to first briefly discuss what Material Instances are before <a id="_idIndexMarker1037"/>you can work with these assets and apply them to the new enemy character. Although this book is more focused on the technical aspects of game development using Unreal Engine 5, it is still important that you know, on a surface level, what <a id="_idIndexMarker1038"/>Material Instances are and how they are used in video games. A Material Instance is an extension of a Material, where you do not have access or control over the base Material from which the Material Instance derives, but you do have control over the parameters that the creator of the Material exposes to you. Many parameters can be exposed to you to work with from inside Material Instances.</p>
<p class="callout-heading">Note</p>
<p class="callout">For more information about Materials and Material Instances, please refer to the following Epic Games documentation pages: <a href="https://docs.unrealengine.com/en-US/Engine/Rendering/Materials/index.xhtml">https://docs.unrealengine.com/en-US/Engine/Rendering/Materials/index.xhtml</a> and <a href="https://docs.unrealengine.com/4.27/en-US/API/Runtime/Engine/Materials/UMaterialInstanceDynamic/">https://docs.unrealengine.com/4.27/en-US/API/Runtime/Engine/Materials/UMaterialInstanceDynamic/</a>.</p>
<p>Unreal Engine provides us with an<a id="_idIndexMarker1039"/> example of a Material Instance in the Side Scroller template project called <strong class="source-inline">M_UE4Man_ChestLogo</strong>, found in the <strong class="source-inline">/Mannequin/Character/Materials/</strong> directory. The following figure shows the set of exposed parameters given to the Material Instance based on the parent material, <strong class="source-inline">M_Male_Body</strong>. The most important parameter to focus on is the <strong class="source-inline">Vector</strong> parameter, called <strong class="source-inline">BodyColor</strong>. You will use this parameter in the Material Instance you create in the next exercise to give the enemy a unique color:</p>
<div>
<div class="IMG---Figure" id="_idContainer383">
<img alt="Figure 12.26 – The list of parameters for the M_UE4Man_ChestLogo Material Instance asset " height="736" src="image/Figure_12.26_B18531.jpg" width="864"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.26 – The list of parameters for the M_UE4Man_ChestLogo Material Instance asset</p>
<p>In the<a id="_idIndexMarker1040"/> following exercise, you will take this knowledge of Material Instances and apply them to create a unique Material Instance to be used for the enemy character you created earlier.</p>
<h2 id="_idParaDest-237"><a id="_idTextAnchor265"/>Exercise 12.09 – Creating and applying the enemy Material Instance</h2>
<p>Now that <a id="_idIndexMarker1041"/>you have a basic understanding of what Material Instances are, it is time to create your own Material Instance from the <strong class="source-inline">M_MannequinUE4_Body</strong> asset. With this Material Instance, you will adjust the <strong class="source-inline">BodyColor</strong> parameter to give the enemy character a unique visual representation. </p>
<p>The following steps will help you complete this exercise:</p>
<ol>
<li value="1">Navigate to the <strong class="source-inline">Characters/Mannequin_UE4/Materials</strong> directory to find the Material used by the default mannequin character, <strong class="source-inline">M_MannequinUE4_Body</strong>. </li>
<li>A Material Instance can be created by right-clicking on the <strong class="source-inline">Material</strong> asset, <strong class="source-inline">M_MannequinUE4_Body</strong>, and left-clicking on the <strong class="bold">Create Material Instance </strong>option. Name this asset as <strong class="source-inline">MI_Enemy01</strong>.</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer384">
<img alt="Figure 12.27 – Any material can be used to create a Material Instance " height="433" src="image/Figure_12.27_B18531.jpg" width="1587"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.27 – Any material can be used to create a Material Instance</p>
<p>Create <a id="_idIndexMarker1042"/>a new folder called <strong class="source-inline">Materials</strong> in the <strong class="source-inline">Enemy</strong> folder. Left-click and drag the Material Instance into the <strong class="source-inline">/Enemy/Materials</strong> directory to move the asset to this new folder:</p>
<div>
<div class="IMG---Figure" id="_idContainer385">
<img alt="Figure 12.28 – Rename the Material Instance MI_Enemy " height="345" src="image/Figure_12.28_B18531.jpg" width="841"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.28 – Rename the Material Instance MI_Enemy</p>
<ol>
<li value="3">Double-left-click the <a id="_idIndexMarker1043"/>Material Instance and <a id="_idIndexMarker1044"/>find the <strong class="bold">Details</strong> panel on the left-hand side. There, you will find a <strong class="bold">Vector Parameter</strong> property called <strong class="bold">BodyColor</strong>. Make sure the checkbox is checked to enable this parameter, and then change its value to a red color. Now, the Material Instance should be colored red, as shown here:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer386">
<img alt="Figure 12.29 – Now, the enemy material is red " height="744" src="image/Figure_12.29_B18531.jpg" width="1268"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.29 – Now, the enemy material is red</p>
<ol>
<li value="4">Save<a id="_idIndexMarker1045"/> the<strong class="bold"> Material Instance</strong> asset<a id="_idIndexMarker1046"/> and navigate back to the <strong class="source-inline">BP_Enemy01</strong> Blueprint. Select the <strong class="bold">Mesh</strong> component and update the <strong class="bold">Element 0</strong> material parameter to <strong class="source-inline">MI_Enemy</strong>:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer387">
<img alt="Figure 12.30 – Assign the MI_Enemy material instance to the enemy character Mesh " height="677" src="image/Figure_12.30_B18531.jpg" width="711"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.30 – Assign the MI_Enemy material instance to the enemy character Mesh</p>
<ol>
<li value="5">Now, the first<a id="_idIndexMarker1047"/> enemy type is <a id="_idIndexMarker1048"/>visually ready and has the appropriate Blueprint and Animation Blueprint assets prepared for the next chapter, where you will develop its AI:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer388">
<img alt="Figure 12.31 – The final enemy character set up " height="556" src="image/Figure_12.31_B18531.jpg" width="608"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.31 – The final enemy character set up</p>
<p>With this exercise complete, you <a id="_idIndexMarker1049"/>have <a id="_idIndexMarker1050"/>now created a Material Instance and applied it to the enemy character so that it has a unique visual representation. </p>
<p>Let’s conclude this chapter by moving on to a short activity that will help you better understand the blending of animations using the <strong class="source-inline">Layered blend per bone</strong> node that was used in the earlier exercises.</p>
<h2 id="_idParaDest-238"><a id="_idTextAnchor266"/>Activity 12.01 – Updating Blend Weights</h2>
<p>At the end of <em class="italic">Exercise 12.06</em>, <em class="italic">Previewing the Throw animation</em>, you were able to blend the movement animations and the <strong class="source-inline">Throw</strong> animation so that they could be played in tandem without <a id="_idIndexMarker1051"/>negatively influencing each other. The result is the player character animating correctly when walking or running, while also performing the <strong class="source-inline">Throw</strong> animation on the upper body. </p>
<p>In this activity, you will experiment with the blend bias values and parameters of the <strong class="source-inline">Layered blend per bone</strong> node to have a better understanding of how animation blending works.</p>
<p>The following steps will help you complete the activity:</p>
<ol>
<li value="1">Update the <strong class="source-inline">Blend Weights</strong> input parameter of the <strong class="source-inline">Layered blend per bone</strong> node so that there is absolutely no blending of the <strong class="source-inline">Throw</strong> animation additive pose with the base movement pose. Try using values here such as <strong class="source-inline">0.0f</strong> and <strong class="source-inline">0.5f</strong> to compare the differences in the animation.</li>
</ol>
<p class="callout-heading">Note</p>
<p class="callout">Make sure to return this value to <strong class="source-inline">1.0f</strong> after you are done so as not to affect the blending you set up in the previous exercise.</p>
<ol>
<li value="2">Update<a id="_idIndexMarker1052"/> the settings of the <strong class="source-inline">Layered blend per bone</strong> node to change which bone is affected by the blend so that the whole character’s body is affected by the blend. It’s a good idea to start with the root bone in the skeleton hierarchy of the <strong class="source-inline">MainCharacter_Skeleton</strong> asset.</li>
<li>Keeping the settings from the previous step in place, add a new array element to the branch filters and, in this new array element, add the bone name and a blend depth value of <strong class="source-inline">–1.0f</strong>, which allows only the character’s left leg to continue to animate the movement correctly when blending the <strong class="source-inline">Throw</strong> animation.</li>
</ol>
<p class="callout-heading">Note</p>
<p class="callout">After this activity, make sure to return the settings of the <strong class="source-inline">Layered blend per bone</strong> node to the values you set at the end of the first exercise to ensure no progress is lost in the character’s animation.</p>
<p>The expected output for the first part of the activity is shown here:</p>
<div>
<div class="IMG---Figure" id="_idContainer389">
<img alt="Figure 12.32 – Output showing the entire character’s body affected " height="416" src="image/Figure_12.32_B18531.jpg" width="779"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.32 – Output showing the entire character’s body affected</p>
<p>The expected <a id="_idIndexMarker1053"/>output for the last part of the activity is shown here:</p>
<div>
<div class="IMG---Figure" id="_idContainer390">
<img alt="Figure 12.33 – The left leg continues to animate the movement correctly when blending the Throw animation " height="458" src="image/Figure_12.33_B18531.jpg" width="904"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.33 – The left leg continues to animate the movement correctly when blending the Throw animation</p>
<p class="callout-heading">Note</p>
<p class="callout">The solution to this activity can be found on GitHub here: <a href="https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition/tree/main/Activity%20solutions">https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition/tree/main/Activity%20solutions</a>.</p>
<p class="callout">Before <a id="_idIndexMarker1054"/>concluding this activity, please return the <strong class="source-inline">Layered blend per bone</strong> settings to the values you set at the end of <em class="italic">Exercise 12.05</em>, <em class="italic">Blending animation with the Upper Body Anim Slot</em>. If you do not return these values back to their original settings, the animation results in upcoming exercises and activities in the next chapters will not be the same. You can either set the original values manually or refer to the file with these settings at the following link: <a href="https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition/tree/main/Chapter12/Exercise12.05">https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition/tree/main/Chapter12/Exercise12.05</a>.</p>
<p>With this activity complete, you now have a stronger understanding of how animation blending works and how blending weighting can affect the influence of additive poses on base poses <a id="_idIndexMarker1055"/>using the <strong class="source-inline">Layered blend per bone</strong> node. </p>
<p class="callout-heading">Note</p>
<p class="callout">There are a lot of techniques for animation blending that you haven’t used in this project, and it’s strongly recommended that you research these techniques, starting with the documentation at <a href="https://docs.unrealengine.com/en-US/Engine/Animation/AnimationBlending/index.xhtml">https://docs.unrealengine.com/en-US/Engine/Animation/AnimationBlending/index.xhtml</a>.</p>
<h1 id="_idParaDest-239"><a id="_idTextAnchor267"/>Summary</h1>
<p>With the enemy set up with the C++ class, Blueprint, and Material, you are ready to move on to the next chapter, where you will create the AI for this enemy by taking advantage of systems such as behavior trees in Unreal Engine 5.</p>
<p>From the exercises and activities of this chapter, you learned how to create an Animation Montage that allows the playing of animations. You also learned how to set up an Anim Slot within this montage to categorize it for the player character’s upper body.</p>
<p>Next, you learned how to cache the output pose of a State Machine by using the <strong class="source-inline">Use Cached Pose</strong> node so that this pose can be referenced in multiple instances for more complex Animation Blueprints. Then, by learning about the <strong class="source-inline">Layered blend per bone</strong> function, you were able to blend the base movement pose with the additive layer of the <strong class="source-inline">Throw</strong> animation by using the Anim Slot.</p>
<p>Lastly, you put together the base of the enemy by creating the C++ class, Blueprint, and other assets so that they will be ready for the next chapter. With the enemy ready, let’s move on to creating the AI of the enemy so that it can interact with the player.</p>
</div>
<div>
<div id="_idContainer392">
</div>
</div>
</div></body></html>