<html><head></head><body>
<div id="_idContainer081">
<h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">16</span></h1>
<h1 class="chapterTitle" id="_idParaDest-208"><span class="koboSpan" id="kobo.2.1">Designing Scalable Finite State Machines</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">A </span><strong class="keyWord"><span class="koboSpan" id="kobo.4.1">Finite State Machine</span></strong><span class="koboSpan" id="kobo.5.1"> (</span><code class="inlineCode"><span class="koboSpan" id="kobo.6.1">FSM</span></code><span class="koboSpan" id="kobo.7.1">) is an abstract computational module used to represent a system that can be in exactly one of a finite number </span><a id="_idIndexMarker663"/><span class="koboSpan" id="kobo.8.1">of states at any given time. </span><span class="koboSpan" id="kobo.8.2">An </span><code class="inlineCode"><span class="koboSpan" id="kobo.9.1">FSM</span></code><span class="koboSpan" id="kobo.10.1"> can transition from one state to another on a given input, and it can perform an action during the transition.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.11.1">In control theory, there is a classification of Moore and Mealy machines. </span><span class="koboSpan" id="kobo.11.2">Moore’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.12.1">FSM</span></code><span class="koboSpan" id="kobo.13.1"> output depends only on a state, that is, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.14.1">FSM</span></code><span class="koboSpan" id="kobo.15.1"> uses only entry actions. </span><span class="koboSpan" id="kobo.15.2">Mealy’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.16.1">FSM</span></code><span class="koboSpan" id="kobo.17.1"> output depends on the input and current state, that is, the action it performs is determined by both the current state and the input.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.18.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.19.1">FSM</span></code><span class="koboSpan" id="kobo.20.1">s that we will cover in this chapter are a combination of both Moore and Mealy </span><code class="inlineCode"><span class="koboSpan" id="kobo.21.1">FSM</span></code><span class="koboSpan" id="kobo.22.1">s as they support both actions performed during transitions and entry and exit actions that depend only on a current state. </span><code class="inlineCode"><span class="koboSpan" id="kobo.23.1">FSM</span></code><span class="koboSpan" id="kobo.24.1">s are also </span><a id="_idIndexMarker664"/><span class="koboSpan" id="kobo.25.1">called </span><strong class="keyWord"><span class="koboSpan" id="kobo.26.1">Unified Modeling Language</span></strong><span class="koboSpan" id="kobo.27.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.28.1">UML</span></strong><span class="koboSpan" id="kobo.29.1">) state machines and are used in real-life applications in embedded systems to describe and control machines. </span><span class="koboSpan" id="kobo.29.2">For example, </span><code class="inlineCode"><span class="koboSpan" id="kobo.30.1">FSM</span></code><span class="koboSpan" id="kobo.31.1">s are commonly used to control washing machines, elevator systems, or communication protocols in networking devices, for managing complex sequences of operations based on various inputs. </span><span class="koboSpan" id="kobo.31.2">Understanding </span><code class="inlineCode"><span class="koboSpan" id="kobo.32.1">FSM</span></code><span class="koboSpan" id="kobo.33.1">s will help you design more predictable and maintainable embedded systems.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.34.1">In this chapter, we’re going to cover the following main topics:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.35.1">FSM</span></code><span class="koboSpan" id="kobo.36.1"> – a simple implementation</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.37.1">FSM</span></code><span class="koboSpan" id="kobo.38.1"> – implementation using the State pattern</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.39.1">State pattern implementation using tag dispatching</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.40.1">Boost SML (State Machine Language)</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-209"><span class="koboSpan" id="kobo.41.1">Technical requirements</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.42.1">To get the most out of this chapter, I strongly recommend using Compiler Explorer (</span><a href="https://godbolt.org/"><span class="url"><span class="koboSpan" id="kobo.43.1">https://godbolt.org/</span></span></a><span class="koboSpan" id="kobo.44.1">) as you read through the examples. </span><span class="koboSpan" id="kobo.44.2">Select GCC as your compiler and target x86 architecture. </span><span class="koboSpan" id="kobo.44.3">This will allow you to see standard output (</span><code class="inlineCode"><span class="koboSpan" id="kobo.45.1">stdio</span></code><span class="koboSpan" id="kobo.46.1">) results and better observe the code’s behavior. </span><span class="koboSpan" id="kobo.46.2">As we are using a lot of modern C++ features, make sure to select the C++23 standard, by adding </span><code class="inlineCode"><span class="koboSpan" id="kobo.47.1">-std=c++23 </span></code><span class="koboSpan" id="kobo.48.1">in the compiler options box.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.49.1">Compiler Explorer makes it easy to try out the code, tweak it, and immediately see how it affects the output and generated assembly. </span><span class="koboSpan" id="kobo.49.2">Most of the examples can also be run in a Renode simulator on an ARM Cortex M0 target and are available on GitHub (</span><a href="https://github.com/PacktPublishing/Cpp-in-Embedded-Systems/tree/main/Chapter16"><span class="url"><span class="koboSpan" id="kobo.50.1">https://github.com/PacktPublishing/Cpp-in-Embedded-Systems/tree/main/Chapter16</span></span></a><span class="koboSpan" id="kobo.51.1">).</span></p>
<h1 class="heading-1" id="_idParaDest-210"><span class="koboSpan" id="kobo.52.1">FSM – a simple implementation</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.53.1">We will jump straight into an </span><a id="_idIndexMarker665"/><span class="koboSpan" id="kobo.54.1">example of an </span><code class="inlineCode"><span class="koboSpan" id="kobo.55.1">FSM</span></code><span class="koboSpan" id="kobo.56.1"> handling </span><strong class="keyWord"><span class="koboSpan" id="kobo.57.1">Bluetooth Low Energy </span></strong><span class="koboSpan" id="kobo.58.1">(</span><strong class="keyWord"><span class="koboSpan" id="kobo.59.1">BLE</span></strong><span class="koboSpan" id="kobo.60.1">) device </span><a id="_idIndexMarker666"/><span class="koboSpan" id="kobo.61.1">connection states, analyze its shortcomings, and see how we can improve it using the State design pattern.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.62.1">The example </span><code class="inlineCode"><span class="koboSpan" id="kobo.63.1">FSM</span></code><span class="koboSpan" id="kobo.64.1"> will be simplified for the purpose of clarity and easier understanding. </span><span class="koboSpan" id="kobo.64.2">We will have three states – </span><code class="inlineCode"><span class="koboSpan" id="kobo.65.1">idle</span></code><span class="koboSpan" id="kobo.66.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.67.1">advertising</span></code><span class="koboSpan" id="kobo.68.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.69.1">connected</span></code><span class="koboSpan" id="kobo.70.1">. </span><span class="koboSpan" id="kobo.70.2">Here is a state diagram of the example </span><code class="inlineCode"><span class="koboSpan" id="kobo.71.1">FSM</span></code><span class="koboSpan" id="kobo.72.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.73.1"><img alt="Figure 16.1 – BLE device connection state diagram" src="../Images/B22402_16_1.png"/></span></figure>
<p class="packt_figref"><span class="No-Break"><span class="koboSpan" id="kobo.74.1">Figure 16</span></span><span class="koboSpan" id="kobo.75.1">.1 – BLE device connection state diagram</span></p>
<p class="normal"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.76.1">Figure 16</span></em></span><em class="italic"><span class="koboSpan" id="kobo.77.1">.1</span></em><span class="koboSpan" id="kobo.78.1"> depicts the state diagram of the BLE device connection </span><code class="inlineCode"><span class="koboSpan" id="kobo.79.1">FSM</span></code><span class="koboSpan" id="kobo.80.1">. </span><span class="koboSpan" id="kobo.80.2">The diagram depicts transitions between states and </span><a id="_idIndexMarker667"/><span class="koboSpan" id="kobo.81.1">actions described as follows:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.82.1">The default state is </span><code class="inlineCode"><span class="koboSpan" id="kobo.83.1">idle</span></code><span class="koboSpan" id="kobo.84.1">. </span><span class="koboSpan" id="kobo.84.2">It transitions to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.85.1">advertising</span></code><span class="koboSpan" id="kobo.86.1"> state on a </span><code class="inlineCode"><span class="koboSpan" id="kobo.87.1">ble_button_pressed</span></code><span class="koboSpan" id="kobo.88.1"> event. </span><span class="koboSpan" id="kobo.88.2">During the transition, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.89.1">start_advertising</span></code><span class="koboSpan" id="kobo.90.1"> action is executed. </span><span class="koboSpan" id="kobo.90.2">In simple words, this means that if the device is in an </span><code class="inlineCode"><span class="koboSpan" id="kobo.91.1">idle</span></code><span class="koboSpan" id="kobo.92.1"> state and a user presses a designated button, it will start advertising and change state.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.93.1">From the </span><code class="inlineCode"><span class="koboSpan" id="kobo.94.1">advertising</span></code><span class="koboSpan" id="kobo.95.1"> state, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.96.1">FSM</span></code><span class="koboSpan" id="kobo.97.1"> can transition to </span><code class="inlineCode"><span class="koboSpan" id="kobo.98.1">connected</span></code><span class="koboSpan" id="kobo.99.1"> on a </span><code class="inlineCode"><span class="koboSpan" id="kobo.100.1">connection_request</span></code><span class="koboSpan" id="kobo.101.1"> event or go back to </span><code class="inlineCode"><span class="koboSpan" id="kobo.102.1">idle</span></code><span class="koboSpan" id="kobo.103.1"> on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.104.1">timer_expired</span></code><span class="koboSpan" id="kobo.105.1"> state while stopping the advertising by executing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.106.1">stop_advertising</span></code><span class="koboSpan" id="kobo.107.1"> action.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.108.1">When in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.109.1">connected</span></code><span class="koboSpan" id="kobo.110.1"> state, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.111.1">FSM</span></code><span class="koboSpan" id="kobo.112.1"> can go only to </span><code class="inlineCode"><span class="koboSpan" id="kobo.113.1">idle</span></code><span class="koboSpan" id="kobo.114.1"> on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.115.1">ble_button_pressed</span></code><span class="koboSpan" id="kobo.116.1"> event while executing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.117.1">disconnect</span></code><span class="koboSpan" id="kobo.118.1"> action.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.119.1">Keep in mind that this is an extremely simplified </span><code class="inlineCode"><span class="koboSpan" id="kobo.120.1">FSM</span></code><span class="koboSpan" id="kobo.121.1"> we are using for the purpose of an example, and a real-life </span><code class="inlineCode"><span class="koboSpan" id="kobo.122.1">FSM</span></code><span class="koboSpan" id="kobo.123.1"> would</span><a id="_idIndexMarker668"/><span class="koboSpan" id="kobo.124.1"> include more states and events to properly describe the connecting behavior of a BLE device.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.125.1">An </span><code class="inlineCode"><span class="koboSpan" id="kobo.126.1">FSM</span></code><span class="koboSpan" id="kobo.127.1"> can also be described using state transition tables. </span><span class="koboSpan" id="kobo.127.2">This table shows the state to which the </span><code class="inlineCode"><span class="koboSpan" id="kobo.128.1">FSM</span></code><span class="koboSpan" id="kobo.129.1"> moves based on the current state and input (received event), as well as the action it performs during the transition. </span><span class="koboSpan" id="kobo.129.2">Here is the transition table for the BLE device </span><code class="inlineCode"><span class="koboSpan" id="kobo.130.1">FSM</span></code><span class="koboSpan" id="kobo.131.1"> we are analyzing in this chapter: </span></p>
<table class="table-container" id="table001-1">
<thead>
<tr>
<th class="table-head">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.132.1">Current State</span></strong></p>
</th>
<th class="table-head">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.133.1">Event</span></strong></p>
</th>
<th class="table-head">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.134.1">Next State</span></strong></p>
</th>
<th class="table-head">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.135.1">Action</span></strong></p>
</th>
</tr>
</thead>
<tbody>
<tr>
<td class="table-cell">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.136.1">idle</span></strong></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.137.1">ble_button_pressed</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.138.1">advertising</span></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.139.1">start_advertising</span></code></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.140.1">advertising</span></strong></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.141.1">timer_expired</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.142.1">idle</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.143.1">stop_advertising</span></code></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.144.1">advertising</span></strong></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.145.1">connection_request</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.146.1">connected</span></p>
</td>
<td class="table-cell"/>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.147.1">connected</span></strong></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.148.1">ble_button_pressed</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.149.1">idle</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.150.1">disconnect</span></p>
</td>
</tr>
</tbody>
</table>
<p class="packt_figref"><span class="koboSpan" id="kobo.151.1">Table 16.1 – BLE device state transition table</span></p>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.152.1">Table 16.1</span></em><span class="koboSpan" id="kobo.153.1"> describes the BLE device </span><code class="inlineCode"><span class="koboSpan" id="kobo.154.1">FSM</span></code><span class="koboSpan" id="kobo.155.1"> by listing transitions in rows. </span><span class="koboSpan" id="kobo.155.2">It serves as an alternative to the state diagram for describing </span><code class="inlineCode"><span class="koboSpan" id="kobo.156.1">FSM</span></code><span class="koboSpan" id="kobo.157.1"> behavior. </span><span class="koboSpan" id="kobo.157.2">We will start with the implementation of this </span><code class="inlineCode"><span class="koboSpan" id="kobo.158.1">FSM</span></code><span class="koboSpan" id="kobo.159.1"> first by defining states and events.</span></p>
<h2 class="heading-2" id="_idParaDest-211"><span class="koboSpan" id="kobo.160.1">Describing states and events</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.161.1">We will model states and </span><a id="_idIndexMarker669"/><span class="koboSpan" id="kobo.162.1">events as </span><code class="inlineCode"><span class="koboSpan" id="kobo.163.1">enum</span></code><span class="koboSpan" id="kobo.164.1">erators, as shown in the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><code class="inlineCode"><span class="koboSpan" id="kobo.165.1">enum</span></code><span class="hljs-keyword"><span class="koboSpan" id="kobo.166.1"> class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.167.1">ble_state</span></span><span class="koboSpan" id="kobo.168.1"> {
    idle,
    advertising,
    connected
};
</span><code class="inlineCode"><span class="koboSpan" id="kobo.169.1">enum</span></code><span class="hljs-keyword"><span class="koboSpan" id="kobo.170.1"> class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.171.1">ble_event</span></span><span class="koboSpan" id="kobo.172.1"> {
    ble_button_pressed,
    connection_request,
    timer_expired
};
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.173.1">The preceding </span><code class="inlineCode"><span class="koboSpan" id="kobo.174.1">enum</span></code><span class="koboSpan" id="kobo.175.1">erators describe states and events for our BLE device </span><code class="inlineCode"><span class="koboSpan" id="kobo.176.1">FSM</span></code><span class="koboSpan" id="kobo.177.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-212"><span class="koboSpan" id="kobo.178.1">Tracking current state and handling events – the FSM class</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.179.1">Next, we will define a class </span><code class="inlineCode"><span class="koboSpan" id="kobo.180.1">ble_fsm</span></code><span class="koboSpan" id="kobo.181.1"> that will keep </span><a id="_idIndexMarker670"/><span class="koboSpan" id="kobo.182.1">track of the current state and </span><a id="_idIndexMarker671"/><span class="koboSpan" id="kobo.183.1">provide a public method, </span><code class="inlineCode"><span class="koboSpan" id="kobo.184.1">handle_event</span></code><span class="koboSpan" id="kobo.185.1">, which we will use to feed the </span><code class="inlineCode"><span class="koboSpan" id="kobo.186.1">FSM</span></code><span class="koboSpan" id="kobo.187.1"> with events. </span><span class="koboSpan" id="kobo.187.2">The code is as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.188.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.189.1">ble_fsm</span></span><span class="koboSpan" id="kobo.190.1"> {
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.191.1">public</span></span><span class="koboSpan" id="kobo.192.1">:
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.193.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.194.1">handle_event</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.195.1">(ble_event event)</span></span><span class="koboSpan" id="kobo.196.1">;
    </span><span class="hljs-function"><span class="koboSpan" id="kobo.197.1">ble_state </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.198.1">get_state</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.199.1">()</span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="koboSpan" id="kobo.200.1">const</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.201.1">{
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.202.1">return</span></span><span class="koboSpan" id="kobo.203.1"> current_state_;
    }
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.204.1">private</span></span><span class="koboSpan" id="kobo.205.1">:
    ble_state current_state_ = ble_state::idle;
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.206.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.207.1">start_advertising</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.208.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.209.1">{
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.210.1">printf</span></span><span class="koboSpan" id="kobo.211.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.212.1">"Action: start_advertising()\n"</span></span><span class="koboSpan" id="kobo.213.1">);
    }
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.214.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.215.1">stop_advertising</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.216.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.217.1">{
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.218.1">printf</span></span><span class="koboSpan" id="kobo.219.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.220.1">"Action: stop_advertising()\n"</span></span><span class="koboSpan" id="kobo.221.1">);
    }
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.222.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.223.1">disconnect</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.224.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.225.1">{
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.226.1">printf</span></span><span class="koboSpan" id="kobo.227.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.228.1">"Action: disconnect()\n"</span></span><span class="koboSpan" id="kobo.229.1">);
    }
};
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.230.1">In the code above, we define</span><a id="_idIndexMarker672"/><span class="koboSpan" id="kobo.231.1"> the class ble_fsm with the following members:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.232.1">ble_state current_state_</span></code><span class="koboSpan" id="kobo.233.1"> – A private member with the default value </span><code class="inlineCode"><span class="koboSpan" id="kobo.234.1">ble_state::idle</span></code><span class="koboSpan" id="kobo.235.1">. </span><span class="koboSpan" id="kobo.235.2">We use it to track the current state, and the initial value is set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.236.1">idle</span></code><span class="koboSpan" id="kobo.237.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.238.1">void start_advertising()</span></code><span class="koboSpan" id="kobo.239.1"> – A private</span><a id="_idIndexMarker673"/><span class="koboSpan" id="kobo.240.1"> method used to implement an action.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.241.1">void stop_advertising()</span></code><span class="koboSpan" id="kobo.242.1"> – A private method used to implement an action.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.243.1">void disconnect()</span></code><span class="koboSpan" id="kobo.244.1"> – A private method used to implement an action.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.245.1">ble_state get_state() const</span></code><span class="koboSpan" id="kobo.246.1"> – A private method used to retrieve the current state.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.247.1">void handle_event(ble_event event)</span></code><span class="koboSpan" id="kobo.248.1"> – A public method used to respond to events by executing actions and changing the current state depending on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.249.1">current_event_</span></code><span class="koboSpan" id="kobo.250.1">.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.251.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.252.1">handle_event</span></code><span class="koboSpan" id="kobo.253.1"> method implements the actual behavior of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.254.1">FSM</span></code><span class="koboSpan" id="kobo.255.1">, and the code for it is shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-type"><span class="koboSpan" id="kobo.256.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.257.1">ble_fsm::handle_event</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.258.1">(ble_event event)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.259.1">{
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.260.1">switch</span></span><span class="koboSpan" id="kobo.261.1"> (current_state_) {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.262.1">case</span></span><span class="koboSpan" id="kobo.263.1"> ble_state::idle:
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.264.1">if</span></span><span class="koboSpan" id="kobo.265.1"> (event == ble_event::ble_button_pressed)
    {
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.266.1">start_advertising</span></span><span class="koboSpan" id="kobo.267.1">();
        current_state_ = ble_state::advertising;
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.268.1">break</span></span><span class="koboSpan" id="kobo.269.1">;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.270.1">case</span></span><span class="koboSpan" id="kobo.271.1"> ble_state::advertising:
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.272.1">if</span></span><span class="koboSpan" id="kobo.273.1"> (event == ble_event::connection_request)
    {
        current_state_ = ble_state::connected;
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.274.1">else</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.275.1">if</span></span><span class="koboSpan" id="kobo.276.1"> (event == ble_event::timer_expired)
    {
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.277.1">stop_advertising</span></span><span class="koboSpan" id="kobo.278.1">();
        current_state_ = ble_state::idle;
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.279.1">break</span></span><span class="koboSpan" id="kobo.280.1">;
    
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.281.1">case</span></span><span class="koboSpan" id="kobo.282.1"> ble_state::connected:
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.283.1">if</span></span><span class="koboSpan" id="kobo.284.1"> (event ==ble_event::ble_button_pressed)
    {
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.285.1">disconnect</span></span><span class="koboSpan" id="kobo.286.1">();
        current_state_ = ble_state::idle;
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.287.1">break</span></span><span class="koboSpan" id="kobo.288.1">;
    
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.289.1">default</span></span><span class="koboSpan" id="kobo.290.1">:
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.291.1">break</span></span><span class="koboSpan" id="kobo.292.1">;
}
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.293.1">The preceding code shows the implementation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.294.1">handle_event</span></code><span class="koboSpan" id="kobo.295.1"> method for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.296.1">ble_fsm</span></code><span class="koboSpan" id="kobo.297.1"> class. </span><span class="koboSpan" id="kobo.297.2">It uses a </span><code class="inlineCode"><span class="koboSpan" id="kobo.298.1">switch</span></code><span class="koboSpan" id="kobo.299.1"> statement </span><a id="_idIndexMarker674"/><span class="koboSpan" id="kobo.300.1">on </span><code class="inlineCode"><span class="koboSpan" id="kobo.301.1">current_state_</span></code><span class="koboSpan" id="kobo.302.1"> to handle the event according to it and receive the event. </span><span class="koboSpan" id="kobo.302.2">The event is</span><a id="_idIndexMarker675"/><span class="koboSpan" id="kobo.303.1"> handled by calling an appropriate action and changing the state as described by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.304.1">FSM</span></code><span class="koboSpan" id="kobo.305.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.306.1">Next, we will see how to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.307.1">ble_fsm</span></code><span class="koboSpan" id="kobo.308.1"> class.</span></p>
<h2 class="heading-2" id="_idParaDest-213"><span class="koboSpan" id="kobo.309.1">Using the ble_fsm class</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.310.1">We will first define a helper</span><a id="_idIndexMarker676"/><span class="koboSpan" id="kobo.311.1"> function, </span><code class="inlineCode"><span class="koboSpan" id="kobo.312.1">state_to_string</span></code><span class="koboSpan" id="kobo.313.1">, used to debug our </span><code class="inlineCode"><span class="koboSpan" id="kobo.314.1">FSM</span></code><span class="koboSpan" id="kobo.315.1">. </span><span class="koboSpan" id="kobo.315.2">The </span><a id="_idIndexMarker677"/><span class="koboSpan" id="kobo.316.1">code is shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-type"><span class="koboSpan" id="kobo.317.1">static</span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="koboSpan" id="kobo.318.1">const</span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="koboSpan" id="kobo.319.1">char</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.320.1">* </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.321.1">state_to_string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.322.1">(ble_state state)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.323.1">{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.324.1">switch</span></span><span class="koboSpan" id="kobo.325.1"> (state) {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.326.1">case</span></span><span class="koboSpan" id="kobo.327.1"> ble_state::idle:        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.328.1">return</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.329.1">"</span></span><code class="inlineCode"><span class="koboSpan" id="kobo.330.1">idle</span></code><span class="hljs-string"><span class="koboSpan" id="kobo.331.1">"</span></span><span class="koboSpan" id="kobo.332.1">;
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.333.1">case</span></span><span class="koboSpan" id="kobo.334.1"> ble_state::advertising: </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.335.1">return</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.336.1">"advertising"</span></span><span class="koboSpan" id="kobo.337.1">;
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.338.1">case</span></span><span class="koboSpan" id="kobo.339.1"> ble_state::connected:   </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.340.1">return</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.341.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.342.1">connected"</span></span><span class="koboSpan" id="kobo.343.1">;
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.344.1">default</span></span><span class="koboSpan" id="kobo.345.1">:                     </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.346.1">return</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.347.1">"unknown"</span></span><span class="koboSpan" id="kobo.348.1">;
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.349.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.350.1">state_to_string</span></code><span class="koboSpan" id="kobo.351.1"> function returns a string literal for a given state </span><code class="inlineCode"><span class="koboSpan" id="kobo.352.1">enum</span></code><span class="koboSpan" id="kobo.353.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.354.1">Next, let us see how to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.355.1">ble_fsm</span></code><span class="koboSpan" id="kobo.356.1"> class, as shown in the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-type"><span class="koboSpan" id="kobo.357.1">int</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.358.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.359.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.360.1">{
    ble_fsm my_ble_fsm;
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.361.1">const</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.362.1">auto</span></span><span class="koboSpan" id="kobo.363.1"> print_current_state = [&amp;]() {
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.364.1">printf</span></span><span class="koboSpan" id="kobo.365.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.366.1">"Current State: %s\n"</span></span><span class="koboSpan" id="kobo.367.1">,
            </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.368.1">state_to_string</span></span><span class="koboSpan" id="kobo.369.1">(my_ble_fsm.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.370.1">get_state</span></span><span class="koboSpan" id="kobo.371.1">()));
    };
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.372.1">print_current_state</span></span><span class="koboSpan" id="kobo.373.1">();
    my_ble_fsm.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.374.1">handle_event</span></span><span class="koboSpan" id="kobo.375.1">(ble_event::ble_button_pressed);
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.376.1">print_current_state</span></span><span class="koboSpan" id="kobo.377.1">();
    my_ble_fsm.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.378.1">handle_event</span></span><span class="koboSpan" id="kobo.379.1">(ble_event::connection_request);
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.380.1">print_current_state</span></span><span class="koboSpan" id="kobo.381.1">();
    my_ble_fsm.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.382.1">handle_event</span></span><span class="koboSpan" id="kobo.383.1">(ble_event::ble_button_pressed);
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.384.1">print_current_state</span></span><span class="koboSpan" id="kobo.385.1">();
   
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.386.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.387.1">0</span></span><span class="koboSpan" id="kobo.388.1">;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.389.1">The preceding code in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.390.1">main</span></code><span class="koboSpan" id="kobo.391.1"> function </span><a id="_idIndexMarker678"/><span class="koboSpan" id="kobo.392.1">creates an object, </span><code class="inlineCode"><span class="koboSpan" id="kobo.393.1">my_ble_fsm</span></code><span class="koboSpan" id="kobo.394.1">, of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.395.1">ble_fsm</span></code><span class="koboSpan" id="kobo.396.1"> type, and it feeds it with events in</span><a id="_idIndexMarker679"/><span class="koboSpan" id="kobo.397.1"> the following order:</span></p>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.398.1">It first passes </span><code class="inlineCode"><span class="koboSpan" id="kobo.399.1">ble_event::ble_button_pressed</span></code><span class="koboSpan" id="kobo.400.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.401.1">FSM</span></code><span class="koboSpan" id="kobo.402.1"> handle_event method. </span><span class="koboSpan" id="kobo.402.2">The initial state of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.403.1">FSM</span></code><span class="koboSpan" id="kobo.404.1"> is </span><code class="inlineCode"><span class="koboSpan" id="kobo.405.1">idle</span></code><span class="koboSpan" id="kobo.406.1">, and after this event, it will transition to </span><code class="inlineCode"><span class="koboSpan" id="kobo.407.1">advertising</span></code><span class="koboSpan" id="kobo.408.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.409.1">Next, it passes the </span><code class="inlineCode"><span class="koboSpan" id="kobo.410.1">ble_event::connection_request</span></code><span class="koboSpan" id="kobo.411.1"> event to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.412.1">FSM</span></code><span class="koboSpan" id="kobo.413.1">, which will make it transition to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.414.1">connected</span></code><span class="koboSpan" id="kobo.415.1"> state.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.416.1">Finally, it passes the </span><code class="inlineCode"><span class="koboSpan" id="kobo.417.1">ble_event::ble_button_pressed</span></code><span class="koboSpan" id="kobo.418.1"> event to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.419.1">FSM</span></code><span class="koboSpan" id="kobo.420.1"> for the second time, making it transition back to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.421.1">idle</span></code><span class="koboSpan" id="kobo.422.1"> state.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.423.1">The code above uses the </span><code class="inlineCode"><span class="koboSpan" id="kobo.424.1">state_to_string</span></code><span class="koboSpan" id="kobo.425.1"> function to get the string literal from the state </span><code class="inlineCode"><span class="koboSpan" id="kobo.426.1">enum</span></code><span class="koboSpan" id="kobo.427.1">, and it uses it to print the current state of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.428.1">FSM</span></code><span class="koboSpan" id="kobo.429.1"> after it feeds it with an event.</span></p>
<h2 class="heading-2" id="_idParaDest-214"><span class="koboSpan" id="kobo.430.1">Analyzing the output</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.431.1">Running the full example will </span><a id="_idIndexMarker680"/><span class="koboSpan" id="kobo.432.1">provide the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.433.1">Current State: idle
Action: start_advertising()
Current State: advertising
Current State: connected
Action: disconnect()
Current State: idle
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.434.1">The preceding output shows </span><code class="inlineCode"><span class="koboSpan" id="kobo.435.1">FSM</span></code><span class="koboSpan" id="kobo.436.1"> states and the executed actions.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.437.1">You can run the full example in the </span><a id="_idIndexMarker681"/><span class="koboSpan" id="kobo.438.1">Renode simulator from the book’s GitHub repo. </span><span class="koboSpan" id="kobo.438.2">It is placed under </span><code class="inlineCode"><span class="koboSpan" id="kobo.439.1">Chapter16/fsm</span></code><span class="koboSpan" id="kobo.440.1">, and you can build and run it using the following commands:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.441.1">$ cmake –B build
$ cmake --build build --target run_in_renode
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.442.1">The approach for implementing an </span><code class="inlineCode"><span class="koboSpan" id="kobo.443.1">FSM</span></code><span class="koboSpan" id="kobo.444.1"> we just went through works well for simple </span><code class="inlineCode"><span class="koboSpan" id="kobo.445.1">FSM</span></code><span class="koboSpan" id="kobo.446.1">s. </span><span class="koboSpan" id="kobo.446.2">In real-life applications, </span><code class="inlineCode"><span class="koboSpan" id="kobo.447.1">FSM</span></code><span class="koboSpan" id="kobo.448.1">s are more complex – they have more states, actions, and events. </span><span class="koboSpan" id="kobo.448.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.449.1">handle_event</span></code><span class="koboSpan" id="kobo.450.1"> method in </span><code class="inlineCode"><span class="koboSpan" id="kobo.451.1">ble_fsm</span></code><span class="koboSpan" id="kobo.452.1"> doesn’t scale well as it is implemented using </span><code class="inlineCode"><span class="koboSpan" id="kobo.453.1">switch-case</span></code><span class="koboSpan" id="kobo.454.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.455.1">if-else</span></code><span class="koboSpan" id="kobo.456.1"> logic. </span><span class="koboSpan" id="kobo.456.2">Adding more states, and handling more events and actions, makes it less readable and harder to maintain.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.457.1">Next, we will see how we can utilize the State design pattern to mitigate these issues.</span></p>
<h1 class="heading-1" id="_idParaDest-215"><span class="koboSpan" id="kobo.458.1">FSM – implementation using the State pattern</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.459.1">Building on our switch-based </span><a id="_idIndexMarker682"/><span class="koboSpan" id="kobo.460.1">approach, we will now refactor the BLE device connection </span><code class="inlineCode"><span class="koboSpan" id="kobo.461.1">FSM</span></code><span class="koboSpan" id="kobo.462.1"> using the State design pattern. </span><span class="koboSpan" id="kobo.462.2">This pattern is “state-centric,” meaning each state is encapsulated as its own class. </span><span class="koboSpan" id="kobo.462.3">A common base class interface</span><a id="_idIndexMarker683"/><span class="koboSpan" id="kobo.463.1"> will allow the </span><code class="inlineCode"><span class="koboSpan" id="kobo.464.1">FSM</span></code><span class="koboSpan" id="kobo.465.1"> to store pointers to these concrete state classes in a container.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.466.1">In a typical </span><code class="inlineCode"><span class="koboSpan" id="kobo.467.1">FSM</span></code><span class="koboSpan" id="kobo.468.1">, states change dynamically at runtime in response to external interrupts and timers. </span><span class="koboSpan" id="kobo.468.2">In our example, we will continue using an </span><code class="inlineCode"><span class="koboSpan" id="kobo.469.1">enum</span></code><span class="koboSpan" id="kobo.470.1"> to differentiate states and store the current one in a private member variable. </span><span class="koboSpan" id="kobo.470.2">This </span><code class="inlineCode"><span class="koboSpan" id="kobo.471.1">enum</span></code><span class="koboSpan" id="kobo.472.1">-based approach still works well with the State pattern, since it lets us quickly locate and switch between the concrete state objects that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.473.1">FSM</span></code><span class="koboSpan" id="kobo.474.1"> manages. </span><span class="koboSpan" id="kobo.474.2">We will start the implementation with the state class interface.</span></p>
<h2 class="heading-2" id="_idParaDest-216"><span class="koboSpan" id="kobo.475.1">Understanding state class interfaces</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.476.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.477.1">state</span></code><span class="koboSpan" id="kobo.478.1"> class interface is </span><a id="_idIndexMarker684"/><span class="koboSpan" id="kobo.479.1">shown in the </span><a id="_idIndexMarker685"/><span class="koboSpan" id="kobo.480.1">following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.481.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.482.1">state</span></span><span class="koboSpan" id="kobo.483.1"> {
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.484.1">public</span></span><span class="koboSpan" id="kobo.485.1">:
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.486.1">virtual</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.487.1"> ble_state </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.488.1">handle_event</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.489.1">(ble_event event)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.490.1">= </span><span class="hljs-number"><span class="koboSpan" id="kobo.491.1">0</span></span><span class="koboSpan" id="kobo.492.1">;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.493.1">virtual</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.494.1"> ble_state </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.495.1">get_state_</span></span><code class="inlineCode"><span class="koboSpan" id="kobo.496.1">enum</span></code><span class="hljs-params"><span class="koboSpan" id="kobo.497.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.498.1">= </span><span class="hljs-number"><span class="koboSpan" id="kobo.499.1">0</span></span><span class="koboSpan" id="kobo.500.1">;
};
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.501.1">In the preceding code, we see that the state interface is simple and has two pure virtual methods:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.502.1">virtual ble_state handle_event(ble_event event)</span></code><span class="koboSpan" id="kobo.503.1"> – A method intended to be implemented by a derived class to handle an actual event. </span><span class="koboSpan" id="kobo.503.2">It returns a </span><code class="inlineCode"><span class="koboSpan" id="kobo.504.1">ble_state</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.505.1">enum</span></code><span class="koboSpan" id="kobo.506.1"> to signal a new state to an </span><code class="inlineCode"><span class="koboSpan" id="kobo.507.1">FSM</span></code><span class="koboSpan" id="kobo.508.1">. </span><span class="koboSpan" id="kobo.508.2">If handling an event doesn’t cause transition, it should return the </span><code class="inlineCode"><span class="koboSpan" id="kobo.509.1">enum</span></code><span class="koboSpan" id="kobo.510.1"> that corresponds to the current state.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.511.1">virtual ble_state get_state_enum()</span></code><span class="koboSpan" id="kobo.512.1"> – A method used to return a </span><code class="inlineCode"><span class="koboSpan" id="kobo.513.1">ble_state</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.514.1">enum</span></code><span class="koboSpan" id="kobo.515.1"> corresponding to an actual state.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.516.1">Next, we will go over the implementation of concrete state classes: </span><code class="inlineCode"><span class="koboSpan" id="kobo.517.1">idle</span></code><span class="koboSpan" id="kobo.518.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.519.1">advertising</span></code><span class="koboSpan" id="kobo.520.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.521.1">connected</span></code><span class="koboSpan" id="kobo.522.1">. </span><span class="koboSpan" id="kobo.522.2">We will start with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.523.1">idle</span></code><span class="koboSpan" id="kobo.524.1"> class, as shown in this code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.525.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.526.1">idle</span></span><span class="koboSpan" id="kobo.527.1"> : </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.528.1">public</span></span><span class="koboSpan" id="kobo.529.1"> state{
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.530.1">public</span></span><span class="koboSpan" id="kobo.531.1">:
    </span><span class="hljs-function"><span class="koboSpan" id="kobo.532.1">ble_state </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.533.1">handle_event</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.534.1">(ble_event event)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.535.1">{
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.536.1">if</span></span><span class="koboSpan" id="kobo.537.1"> (event == ble_event::ble_button_pressed) {
            </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.538.1">start_advertising</span></span><span class="koboSpan" id="kobo.539.1">();
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.540.1">return</span></span><span class="koboSpan" id="kobo.541.1"> ble_state::advertising;
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.542.1">return</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.543.1">get_state_enum</span></span><span class="koboSpan" id="kobo.544.1">();
    }
    </span><span class="hljs-function"><span class="koboSpan" id="kobo.545.1">ble_state </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.546.1">get_state_enum</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.547.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.548.1">{
       </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.549.1">return</span></span><span class="koboSpan" id="kobo.550.1"> ble_state::idle;
    }
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.551.1">private</span></span><span class="koboSpan" id="kobo.552.1">:
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.553.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.554.1">start_advertising</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.555.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.556.1">{
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.557.1">printf</span></span><span class="koboSpan" id="kobo.558.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.559.1">"Action: start_advertising()\n"</span></span><span class="koboSpan" id="kobo.560.1">);
    }
};
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.561.1">In the preceding code, we see</span><a id="_idIndexMarker686"/><span class="koboSpan" id="kobo.562.1"> that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.563.1">idle</span></code><span class="koboSpan" id="kobo.564.1"> class implements</span><a id="_idIndexMarker687"/><span class="koboSpan" id="kobo.565.1"> pure virtual methods defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.566.1">state</span></code><span class="koboSpan" id="kobo.567.1"> interface class:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.568.1">ble_state handle_event(ble_event event)</span></code><span class="koboSpan" id="kobo.569.1"> – The </span><code class="inlineCode"><span class="koboSpan" id="kobo.570.1">idle</span></code><span class="koboSpan" id="kobo.571.1"> class checks whether the received event is </span><code class="inlineCode"><span class="koboSpan" id="kobo.572.1">ble_event::ble_button_pressed</span></code><span class="koboSpan" id="kobo.573.1"> and calls </span><code class="inlineCode"><span class="koboSpan" id="kobo.574.1">start_advertising</span></code><span class="koboSpan" id="kobo.575.1"> if it is and returns the </span><code class="inlineCode"><span class="koboSpan" id="kobo.576.1">ble_state::advertising</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.577.1">enum</span></code><span class="koboSpan" id="kobo.578.1">. </span><span class="koboSpan" id="kobo.578.2">In the case that it receives any other event, it returns the state provided with </span><code class="inlineCode"><span class="koboSpan" id="kobo.579.1">get_state_enum</span></code><span class="koboSpan" id="kobo.580.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.581.1">ble_state get_state_enum()</span></code><span class="koboSpan" id="kobo.582.1"> – This returns the </span><code class="inlineCode"><span class="koboSpan" id="kobo.583.1">ble_state</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.584.1">enum</span></code><span class="koboSpan" id="kobo.585.1"> corresponding to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.586.1">idle</span></code><span class="koboSpan" id="kobo.587.1"> class, which is </span><code class="inlineCode"><span class="koboSpan" id="kobo.588.1">ble_state::idle</span></code><span class="koboSpan" id="kobo.589.1">.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.590.1">Next, we will go through the derived class </span><code class="inlineCode"><span class="koboSpan" id="kobo.591.1">advertising</span></code><span class="koboSpan" id="kobo.592.1">, as shown in the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.593.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.594.1">advertising</span></span><span class="koboSpan" id="kobo.595.1"> : </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.596.1">public</span></span><span class="koboSpan" id="kobo.597.1"> state{
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.598.1">public</span></span><span class="koboSpan" id="kobo.599.1">:
    </span><span class="hljs-function"><span class="koboSpan" id="kobo.600.1">ble_state </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.601.1">handle_event</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.602.1">(ble_event event)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.603.1">{
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.604.1">if</span></span><span class="koboSpan" id="kobo.605.1"> (event == ble_event::connection_request) {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.606.1">return</span></span><span class="koboSpan" id="kobo.607.1"> ble_state::connected;
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.608.1">if</span></span><span class="koboSpan" id="kobo.609.1"> (event == ble_event::timer_expired) {
            </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.610.1">stop_advertising</span></span><span class="koboSpan" id="kobo.611.1">();
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.612.1">return</span></span><span class="koboSpan" id="kobo.613.1"> ble_state::idle;
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.614.1">return</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.615.1">get_state_enum</span></span><span class="koboSpan" id="kobo.616.1">();
    }
    </span><span class="hljs-function"><span class="koboSpan" id="kobo.617.1">ble_state </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.618.1">get_state_enum</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.619.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.620.1">{
       </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.621.1">return</span></span><span class="koboSpan" id="kobo.622.1"> ble_state::advertising;
    }
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.623.1">private</span></span><span class="koboSpan" id="kobo.624.1">:
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.625.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.626.1">stop_advertising</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.627.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.628.1">{
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.629.1">printf</span></span><span class="koboSpan" id="kobo.630.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.631.1">"Action: stop_advertising()\n"</span></span><span class="koboSpan" id="kobo.632.1">);
    }
};
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.633.1">In this code, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.634.1">advertising</span></code><span class="koboSpan" id="kobo.635.1"> class implements pure virtual methods defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.636.1">state</span></code><span class="koboSpan" id="kobo.637.1"> interface class by handling the </span><a id="_idIndexMarker688"/><span class="koboSpan" id="kobo.638.1">events appropriately.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.639.1">Next, we will go over the </span><code class="inlineCode"><span class="koboSpan" id="kobo.640.1">connected</span></code><span class="koboSpan" id="kobo.641.1"> concrete </span><a id="_idIndexMarker689"/><span class="koboSpan" id="kobo.642.1">class:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.643.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.644.1">connected</span></span><span class="koboSpan" id="kobo.645.1"> : </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.646.1">public</span></span><span class="koboSpan" id="kobo.647.1"> state{
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.648.1">public</span></span><span class="koboSpan" id="kobo.649.1">:
    </span><span class="hljs-function"><span class="koboSpan" id="kobo.650.1">ble_state </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.651.1">handle_event</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.652.1">(ble_event event)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.653.1">{
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.654.1">if</span></span><span class="koboSpan" id="kobo.655.1"> (event == ble_event::ble_button_pressed) {
            </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.656.1">disconnect</span></span><span class="koboSpan" id="kobo.657.1">();
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.658.1">return</span></span><span class="koboSpan" id="kobo.659.1"> ble_state::idle;
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.660.1">return</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.661.1">get_state_enum</span></span><span class="koboSpan" id="kobo.662.1">();
    }
    </span><span class="hljs-function"><span class="koboSpan" id="kobo.663.1">ble_state </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.664.1">get_state_enum</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.665.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.666.1">{
       </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.667.1">return</span></span><span class="koboSpan" id="kobo.668.1"> ble_state::connected;
    }
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.669.1">private</span></span><span class="koboSpan" id="kobo.670.1">:
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.671.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.672.1">disconnect</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.673.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.674.1">{
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.675.1">printf</span></span><span class="koboSpan" id="kobo.676.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.677.1">"Action: disconnect()\n"</span></span><span class="koboSpan" id="kobo.678.1">);
    }
};
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.679.1">As we can see in the preceding code, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.680.1">connected</span></code><span class="koboSpan" id="kobo.681.1"> class implements a state interface and implements the virtual methods </span><code class="inlineCode"><span class="koboSpan" id="kobo.682.1">handle_event</span></code><span class="koboSpan" id="kobo.683.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.684.1">get_state_enum</span></code><span class="koboSpan" id="kobo.685.1"> appropriately.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.686.1">Next, we will refactor the </span><code class="inlineCode"><span class="koboSpan" id="kobo.687.1">ble_fsm</span></code><span class="koboSpan" id="kobo.688.1"> class to use the state class interface to store pointers to concrete class objects in a </span><a id="_idIndexMarker690"/><span class="koboSpan" id="kobo.689.1">container.</span></p>
<h2 class="heading-2" id="_idParaDest-217"><span class="koboSpan" id="kobo.690.1">Refactoring the ble_fsm class</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.691.1">We will start with</span><a id="_idIndexMarker691"/><span class="koboSpan" id="kobo.692.1"> refactoring the </span><code class="inlineCode"><span class="koboSpan" id="kobo.693.1">ble_fsm</span></code><span class="koboSpan" id="kobo.694.1"> class, as shown</span><a id="_idIndexMarker692"/><span class="koboSpan" id="kobo.695.1"> in the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.696.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.697.1">ble_fsm</span></span><span class="koboSpan" id="kobo.698.1"> {
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.699.1">public</span></span><span class="koboSpan" id="kobo.700.1">:
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.701.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.702.1">handle_event</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.703.1">(ble_event event)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.704.1">{
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.705.1">if</span></span><span class="koboSpan" id="kobo.706.1">(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.707.1">auto</span></span><span class="koboSpan" id="kobo.708.1"> the_state = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.709.1">get_the_state</span></span><span class="koboSpan" id="kobo.710.1">(current_state_)) { 
            current_state_ = the_state-&gt;</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.711.1">handle_event</span></span><span class="koboSpan" id="kobo.712.1">(event);
        }
    }
    </span><span class="hljs-function"><span class="koboSpan" id="kobo.713.1">ble_state </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.714.1">get_state</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.715.1">()</span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="koboSpan" id="kobo.716.1">const</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.717.1">{
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.718.1">return</span></span><span class="koboSpan" id="kobo.719.1"> current_state_;
    }
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.720.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.721.1">add_state</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.722.1">(state *the_state)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.723.1">{
        states_.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.724.1">push_back</span></span><span class="koboSpan" id="kobo.725.1">(the_state);
    }
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.726.1">private</span></span><span class="koboSpan" id="kobo.727.1">:
    ble_state current_state_ = ble_state::idle;
    etl::vector&lt;state*, 3&gt; states_;
    </span><span class="hljs-function"><span class="koboSpan" id="kobo.728.1">state* </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.729.1">get_the_state</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.730.1">(ble_state state_enum)</span></span><span class="koboSpan" id="kobo.731.1">; };
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.732.1">Let us break down the implementation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.733.1">ble_fsm</span></code><span class="koboSpan" id="kobo.734.1"> class:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.735.1">ble_state current_state_</span></code><span class="koboSpan" id="kobo.736.1"> – A private member with the default value </span><code class="inlineCode"><span class="koboSpan" id="kobo.737.1">ble_state::idle</span></code><span class="koboSpan" id="kobo.738.1">. </span><span class="koboSpan" id="kobo.738.2">We use it to track the current state, as we did previously.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.739.1">etl::vector&lt;state*, 3&gt; states_</span></code><span class="koboSpan" id="kobo.740.1"> – A container used to hold pointers to the state interface. </span><span class="koboSpan" id="kobo.740.2">If you are following this example using Compiler Explorer, you can replace it with </span><code class="inlineCode"><span class="koboSpan" id="kobo.741.1">std::vector</span></code><span class="koboSpan" id="kobo.742.1"> (and include a </span><code class="inlineCode"><span class="koboSpan" id="kobo.743.1">&lt;vector&gt;</span></code><span class="koboSpan" id="kobo.744.1"> header).</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.745.1">state* get_the_state(ble_state state_enum)</span></code><span class="koboSpan" id="kobo.746.1"> – A private method used to get an actual state using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.747.1">ble_state</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.748.1">enum</span></code><span class="koboSpan" id="kobo.749.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.750.1">void handle_event(ble_event event)</span></code><span class="koboSpan" id="kobo.751.1"> – A public method used to handle events. </span><span class="koboSpan" id="kobo.751.2">It calls the </span><code class="inlineCode"><span class="koboSpan" id="kobo.752.1">get_the_state</span></code><span class="koboSpan" id="kobo.753.1"> method provided with </span><code class="inlineCode"><span class="koboSpan" id="kobo.754.1">current_state_</span></code><span class="koboSpan" id="kobo.755.1"> to get a pointer to the actual </span><a id="_idIndexMarker693"/><span class="koboSpan" id="kobo.756.1">state object. </span><span class="koboSpan" id="kobo.756.2">If the pointer is valid, it calls </span><code class="inlineCode"><span class="koboSpan" id="kobo.757.1">handle_event</span></code><span class="koboSpan" id="kobo.758.1"> on the state object and </span><a id="_idIndexMarker694"/><span class="koboSpan" id="kobo.759.1">stores the return value in </span><code class="inlineCode"><span class="koboSpan" id="kobo.760.1">current_state_</span></code><span class="koboSpan" id="kobo.761.1">.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.762.1">Next, let us go through the </span><code class="inlineCode"><span class="koboSpan" id="kobo.763.1">get_the_state</span></code><span class="koboSpan" id="kobo.764.1"> method implementation, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-function"><span class="koboSpan" id="kobo.765.1">state* </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.766.1">ble_fsm::get_the_state</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.767.1">(ble_state state_enum)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.768.1">{
</span><span class="hljs-type"><span class="koboSpan" id="kobo.769.1">const</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.770.1">auto</span></span><span class="koboSpan" id="kobo.771.1"> is_state_enum = [&amp;](state* the_state) {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.772.1">return</span></span><span class="koboSpan" id="kobo.773.1"> the_state-&gt;</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.774.1">get_state_enum</span></span><span class="koboSpan" id="kobo.775.1">() == state_enum;
};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.776.1">auto</span></span><span class="koboSpan" id="kobo.777.1"> it = std::</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.778.1">find_if</span></span><span class="koboSpan" id="kobo.779.1">(states_.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.780.1">begin</span></span><span class="koboSpan" id="kobo.781.1">(), states_.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.782.1">end</span></span><span class="koboSpan" id="kobo.783.1">(), is_state_enum);
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.784.1">if</span></span><span class="koboSpan" id="kobo.785.1"> (it != states_.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.786.1">end</span></span><span class="koboSpan" id="kobo.787.1">()) {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.788.1">return</span></span><span class="koboSpan" id="kobo.789.1"> *it;
}
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.790.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.791.1">nullptr</span></span><span class="koboSpan" id="kobo.792.1">;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.793.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.794.1">get_the_state</span></code><span class="koboSpan" id="kobo.795.1"> method, we use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.796.1">std::find_if</span></code><span class="koboSpan" id="kobo.797.1"> function (from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.798.1">&lt;algorithm&gt;</span></code><span class="koboSpan" id="kobo.799.1"> header) to search for a pointer to a </span><code class="inlineCode"><span class="koboSpan" id="kobo.800.1">state</span></code><span class="koboSpan" id="kobo.801.1"> object that matches the given </span><code class="inlineCode"><span class="koboSpan" id="kobo.802.1">state_enum</span></code><span class="koboSpan" id="kobo.803.1">. </span><span class="koboSpan" id="kobo.803.2">The search uses the </span><code class="inlineCode"><span class="koboSpan" id="kobo.804.1">is_state_enum</span></code><span class="koboSpan" id="kobo.805.1"> lambda as a predicate, which compares each state’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.806.1">enum</span></code><span class="koboSpan" id="kobo.807.1"> value. </span><span class="koboSpan" id="kobo.807.2">If a matching state is found, the method returns a pointer to it; otherwise, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.808.1">nullptr</span></code><span class="koboSpan" id="kobo.809.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.810.1">Next, let us see how to use the</span><a id="_idIndexMarker695"/><span class="koboSpan" id="kobo.811.1"> refactored </span><code class="inlineCode"><span class="koboSpan" id="kobo.812.1">ble_fsm</span></code><span class="koboSpan" id="kobo.813.1"> class, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.814.1">state</span></code><span class="koboSpan" id="kobo.815.1"> interface, and the</span><a id="_idIndexMarker696"/><span class="koboSpan" id="kobo.816.1"> concrete classes </span><code class="inlineCode"><span class="koboSpan" id="kobo.817.1">idle</span></code><span class="koboSpan" id="kobo.818.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.819.1">advertising</span></code><span class="koboSpan" id="kobo.820.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.821.1">connected</span></code><span class="koboSpan" id="kobo.822.1"> to implement the </span><code class="inlineCode"><span class="koboSpan" id="kobo.823.1">FSM</span></code><span class="koboSpan" id="kobo.824.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-218"><span class="koboSpan" id="kobo.825.1">Implementing the State pattern</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.826.1">Next, we will see how to use the above implementation </span><a id="_idIndexMarker697"/><span class="koboSpan" id="kobo.827.1">of the State pattern in the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-type"><span class="koboSpan" id="kobo.828.1">int</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.829.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.830.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.831.1">{
    ble_fsm my_ble_fsm;
    idle idle_s;
    advertising advertising_s;
    connected connected_s;
    my_ble_fsm.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.832.1">add_state</span></span><span class="koboSpan" id="kobo.833.1">(&amp;idle_s);
    my_ble_fsm.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.834.1">add_state</span></span><span class="koboSpan" id="kobo.835.1">(&amp;advertising_s);
    my_ble_fsm.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.836.1">add_state</span></span><span class="koboSpan" id="kobo.837.1">(&amp;connected_s);
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.838.1">const</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.839.1">auto</span></span><span class="koboSpan" id="kobo.840.1"> print_current_state = [&amp;]() {
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.841.1">printf</span></span><span class="koboSpan" id="kobo.842.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.843.1">"Current State: %s\n"</span></span><span class="koboSpan" id="kobo.844.1">,
            </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.845.1">state_to_string</span></span><span class="koboSpan" id="kobo.846.1">(my_ble_fsm.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.847.1">get_state</span></span><span class="koboSpan" id="kobo.848.1">()));
    };
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.849.1">print_current_state</span></span><span class="koboSpan" id="kobo.850.1">();
    my_ble_fsm.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.851.1">handle_event</span></span><span class="koboSpan" id="kobo.852.1">(ble_event::ble_button_pressed);
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.853.1">print_current_state</span></span><span class="koboSpan" id="kobo.854.1">();
    my_ble_fsm.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.855.1">handle_event</span></span><span class="koboSpan" id="kobo.856.1">(ble_event::connection_request);
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.857.1">print_current_state</span></span><span class="koboSpan" id="kobo.858.1">();
    my_ble_fsm.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.859.1">handle_event</span></span><span class="koboSpan" id="kobo.860.1">(ble_event::ble_button_pressed);
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.861.1">print_current_state</span></span><span class="koboSpan" id="kobo.862.1">();
   
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.863.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.864.1">0</span></span><span class="koboSpan" id="kobo.865.1">;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.866.1">In this code, we see that after creating an object </span><code class="inlineCode"><span class="koboSpan" id="kobo.867.1">my_ble_fsm</span></code><span class="koboSpan" id="kobo.868.1"> of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.869.1">ble_fsm</span></code><span class="koboSpan" id="kobo.870.1"> type, we create instances of concrete states: </span><code class="inlineCode"><span class="koboSpan" id="kobo.871.1">idle</span></code><span class="koboSpan" id="kobo.872.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.873.1">advertising</span></code><span class="koboSpan" id="kobo.874.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.875.1">connected</span></code><span class="koboSpan" id="kobo.876.1">. </span><span class="koboSpan" id="kobo.876.2">Then, we add pointers to the concrete states to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.877.1">my_ble_fsm</span></code><span class="koboSpan" id="kobo.878.1"> object using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.879.1">add_state</span></code><span class="koboSpan" id="kobo.880.1"> method. </span><span class="koboSpan" id="kobo.880.2">Next, we use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.881.1">FSM</span></code><span class="koboSpan" id="kobo.882.1"> as we did in the initial implementation and feed it with events.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.883.1">You can run the full example</span><a id="_idIndexMarker698"/><span class="koboSpan" id="kobo.884.1"> in the Renode simulator from the book’s GitHub repo. </span><span class="koboSpan" id="kobo.884.2">It is placed under </span><code class="inlineCode"><span class="koboSpan" id="kobo.885.1">Chapter16/fsm</span></code><span class="koboSpan" id="kobo.886.1">, and you can build and run it using the following commands:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.887.1">$ cmake –B build -DMAIN_CPP_FILE_NAME=main_fsm_state_pattern.cpp
$ cmake --build build --target run_in_renode
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.888.1">The example we just went through is using the State design pattern. </span><span class="koboSpan" id="kobo.888.2">Next, we will go through the generic form of the State design pattern.</span></p>
<h2 class="heading-2" id="_idParaDest-219"><span class="koboSpan" id="kobo.889.1">State design pattern</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.890.1">Let us go over the UML diagram of</span><a id="_idIndexMarker699"/><span class="koboSpan" id="kobo.891.1"> the BLE device</span><a id="_idIndexMarker700"/><span class="koboSpan" id="kobo.892.1"> connection </span><code class="inlineCode"><span class="koboSpan" id="kobo.893.1">FSM</span></code><span class="koboSpan" id="kobo.894.1">, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.895.1">Figure 16</span></em></span><em class="italic"><span class="koboSpan" id="kobo.896.1">.2</span></em><span class="koboSpan" id="kobo.897.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.898.1"><img alt="Figure 16.2 – BLE device connection FSM – UML diagram" src="../Images/B22402_16_2.png"/></span></figure>
<p class="packt_figref"><span class="No-Break"><span class="koboSpan" id="kobo.899.1">Figure 16</span></span><span class="koboSpan" id="kobo.900.1">.2 – BLE device connection FSM – UML diagram</span></p>
<p class="normal"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.901.1">Figure 16</span></em></span><em class="italic"><span class="koboSpan" id="kobo.902.1">.2</span></em><span class="koboSpan" id="kobo.903.1"> depicts a UML diagram of the BLE device connection </span><code class="inlineCode"><span class="koboSpan" id="kobo.904.1">FSM</span></code><span class="koboSpan" id="kobo.905.1">. </span><span class="koboSpan" id="kobo.905.2">We already went through applying the State design</span><a id="_idIndexMarker701"/><span class="koboSpan" id="kobo.906.1"> pattern to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.907.1">FSM</span></code><span class="koboSpan" id="kobo.908.1"> implementation. </span><span class="koboSpan" id="kobo.908.2">Let us summarize it:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.909.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.910.1">FSM</span></code><span class="koboSpan" id="kobo.911.1"> class holds </span><a id="_idIndexMarker702"/><span class="koboSpan" id="kobo.912.1">pointers to the state class interface in a container.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.913.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.914.1">FSM</span></code><span class="koboSpan" id="kobo.915.1"> keeps track of the current state.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.916.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.917.1">FSM</span></code><span class="koboSpan" id="kobo.918.1"> delegates </span><code class="inlineCode"><span class="koboSpan" id="kobo.919.1">handle_event</span></code><span class="koboSpan" id="kobo.920.1"> calls to a current concrete state.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.921.1">Concrete states implement the state interface.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.922.1">Concrete states implement actions and call them appropriately when handling events.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.923.1">Concrete states return a new state from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.924.1">handle_event</span></code><span class="koboSpan" id="kobo.925.1"> method. </span><span class="koboSpan" id="kobo.925.2">This allows the </span><code class="inlineCode"><span class="koboSpan" id="kobo.926.1">FSM</span></code><span class="koboSpan" id="kobo.927.1"> to update the current state.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.928.1">The state design pattern is a simple </span><a id="_idIndexMarker703"/><span class="koboSpan" id="kobo.929.1">yet effective pattern that allows us to break down complex switch statements into more manageable code. </span><span class="koboSpan" id="kobo.929.2">Still, as we were able to see in the previous example, concrete states handle</span><a id="_idIndexMarker704"/><span class="koboSpan" id="kobo.930.1"> events using </span><code class="inlineCode"><span class="koboSpan" id="kobo.931.1">if-else</span></code><span class="koboSpan" id="kobo.932.1"> logic. </span><span class="koboSpan" id="kobo.932.2">With the increasing complexity of an </span><code class="inlineCode"><span class="koboSpan" id="kobo.933.1">FSM</span></code><span class="koboSpan" id="kobo.934.1">, the handle functions can also clutter. </span><span class="koboSpan" id="kobo.934.2">To mitigate this, we can apply the tag-dispatching technique.</span></p>
<h1 class="heading-1" id="_idParaDest-220"><span class="koboSpan" id="kobo.935.1">State pattern implementation using tag dispatching</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.936.1">In the previous example (in the previous sections), the </span><a id="_idIndexMarker705"/><span class="koboSpan" id="kobo.937.1">program flow in event handlers was determined at runtime using </span><code class="inlineCode"><span class="koboSpan" id="kobo.938.1">if-else</span></code><span class="koboSpan" id="kobo.939.1"> logic. </span><span class="koboSpan" id="kobo.939.2">Next, we will use the tag-dispatching </span><a id="_idIndexMarker706"/><span class="koboSpan" id="kobo.940.1">technique to decouple event handling of different events in separate methods. </span><span class="koboSpan" id="kobo.940.2">We will rely no longer on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.941.1">ble_event</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.942.1">enum</span></code><span class="koboSpan" id="kobo.943.1">, and will create empty types as events instead, as shown in the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.944.1">struct</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.945.1">ble_button_pressed</span></span><span class="koboSpan" id="kobo.946.1">{};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.947.1">struct</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.948.1">connection_request</span></span><span class="koboSpan" id="kobo.949.1">{};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.950.1">struct</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.951.1">timer_expired</span></span><span class="koboSpan" id="kobo.952.1">{};
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.953.1">Now, the class </span><code class="inlineCode"><span class="koboSpan" id="kobo.954.1">state</span></code><span class="koboSpan" id="kobo.955.1"> will overload </span><code class="inlineCode"><span class="koboSpan" id="kobo.956.1">handle_event</span></code><span class="koboSpan" id="kobo.957.1"> virtual methods for every defined event, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.958.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.959.1">state</span></span><span class="koboSpan" id="kobo.960.1"> {
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.961.1">public</span></span><span class="koboSpan" id="kobo.962.1">:
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.963.1">virtual</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.964.1"> ble_state </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.965.1">handle_event</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.966.1">(ble_button_pressed)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.967.1">{
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.968.1">return</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.969.1">get_state_enum</span></span><span class="koboSpan" id="kobo.970.1">();
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.971.1">virtual</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.972.1"> ble_state </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.973.1">handle_event</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.974.1">(connection_request)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.975.1">{
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.976.1">return</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.977.1">get_state_enum</span></span><span class="koboSpan" id="kobo.978.1">();
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.979.1">virtual</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.980.1"> ble_state </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.981.1">handle_event</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.982.1">(timer_expired)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.983.1">{
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.984.1">return</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.985.1">get_state_enum</span></span><span class="koboSpan" id="kobo.986.1">();
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.987.1">virtual</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.988.1"> ble_state </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.989.1">get_state_enum</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.990.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.991.1">= </span><span class="hljs-number"><span class="koboSpan" id="kobo.992.1">0</span></span><span class="koboSpan" id="kobo.993.1">;
};
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.994.1">In this code, we see that the class </span><code class="inlineCode"><span class="koboSpan" id="kobo.995.1">state</span></code><span class="koboSpan" id="kobo.996.1"> is no longer an interface but an abstract class (as not all virtual methods are pure). </span><span class="koboSpan" id="kobo.996.2">It overloads the </span><code class="inlineCode"><span class="koboSpan" id="kobo.997.1">handle_event</span></code><span class="koboSpan" id="kobo.998.1"> function for types </span><code class="inlineCode"><span class="koboSpan" id="kobo.999.1">ble_button_pressed</span></code><span class="koboSpan" id="kobo.1000.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1001.1">connection_request</span></code><span class="koboSpan" id="kobo.1002.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1003.1">timer_expired</span></code><span class="koboSpan" id="kobo.1004.1">. </span><span class="koboSpan" id="kobo.1004.2">It implements all overloads by returning the value </span><a id="_idIndexMarker707"/><span class="koboSpan" id="kobo.1005.1">generated by </span><code class="inlineCode"><span class="koboSpan" id="kobo.1006.1">get_state_enum</span></code><span class="koboSpan" id="kobo.1007.1"> – a pure virtual</span><a id="_idIndexMarker708"/><span class="koboSpan" id="kobo.1008.1"> method that will be implemented by derived classes, that is, concrete states.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1009.1">Next, let us see the implementation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1010.1">advertising</span></code><span class="koboSpan" id="kobo.1011.1"> class:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1012.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1013.1">advertising</span></span><span class="koboSpan" id="kobo.1014.1"> : </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1015.1">public</span></span><span class="koboSpan" id="kobo.1016.1"> state{
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1017.1">public</span></span><span class="koboSpan" id="kobo.1018.1">:
    </span><span class="hljs-function"><span class="koboSpan" id="kobo.1019.1">ble_state </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.1020.1">handle_event</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1021.1">(connection_request cr)</span></span><span class="koboSpan" id="kobo.1022.1">{
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1023.1">return</span></span><span class="koboSpan" id="kobo.1024.1"> ble_state::connected;
    }
    </span><span class="hljs-function"><span class="koboSpan" id="kobo.1025.1">ble_state </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.1026.1">handle_event</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1027.1">(timer_expired te)</span></span><span class="koboSpan" id="kobo.1028.1">{
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1029.1">stop_advertising</span></span><span class="koboSpan" id="kobo.1030.1">();
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1031.1">return</span></span><span class="koboSpan" id="kobo.1032.1"> ble_state::idle;
    }
    </span><span class="hljs-function"><span class="koboSpan" id="kobo.1033.1">ble_state </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.1034.1">get_state_enum</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1035.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.1036.1">{
       </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1037.1">return</span></span><span class="koboSpan" id="kobo.1038.1"> ble_state::advertising;
    }
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1039.1">private</span></span><span class="koboSpan" id="kobo.1040.1">:
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.1041.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1042.1">stop_advertising</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1043.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.1044.1">{
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1045.1">printf</span></span><span class="koboSpan" id="kobo.1046.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1047.1">"Action: stop_advertising()\n"</span></span><span class="koboSpan" id="kobo.1048.1">);
    }
};
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1049.1">In this code, we see that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1050.1">advertising</span></code><span class="koboSpan" id="kobo.1051.1"> class implements the following overloads of the virtual method </span><code class="inlineCode"><span class="koboSpan" id="kobo.1052.1">handle_event</span></code><span class="koboSpan" id="kobo.1053.1">:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1054.1">ble_state handle_event(connection_request cr)</span></code><span class="koboSpan" id="kobo.1055.1"> returns </span><code class="inlineCode"><span class="koboSpan" id="kobo.1056.1">ble_state::connected</span></code><span class="koboSpan" id="kobo.1057.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1058.1">ble_state handle_event(timer_expired te)</span></code><span class="koboSpan" id="kobo.1059.1"> calls </span><code class="inlineCode"><span class="koboSpan" id="kobo.1060.1">stop_advertising</span></code><span class="koboSpan" id="kobo.1061.1"> and returns </span><code class="inlineCode"><span class="koboSpan" id="kobo.1062.1">ble_state::idle</span></code><span class="koboSpan" id="kobo.1063.1">.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1064.1">By using overloaded functions, we can</span><a id="_idIndexMarker709"/><span class="koboSpan" id="kobo.1065.1"> implement the handling of different events in separate methods and easily dispatch calls</span><a id="_idIndexMarker710"/><span class="koboSpan" id="kobo.1066.1"> to them by calling </span><code class="inlineCode"><span class="koboSpan" id="kobo.1067.1">handle_event</span></code><span class="koboSpan" id="kobo.1068.1"> with different types. </span><span class="koboSpan" id="kobo.1068.2">To complete the implementation, we also need to overload the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1069.1">handle_event</span></code><span class="koboSpan" id="kobo.1070.1"> method in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1071.1">FSM</span></code><span class="koboSpan" id="kobo.1072.1"> for all possible events. </span><span class="koboSpan" id="kobo.1072.2">We can do this easily by making it a template method, as shown in the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1073.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1074.1">ble_fsm</span></span><span class="koboSpan" id="kobo.1075.1"> {
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1076.1">public</span></span><span class="koboSpan" id="kobo.1077.1">:
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1078.1">template</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1079.1">&lt;</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1080.1">typename</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1081.1"> E&gt;</span></span>
<span class="hljs-function"> </span><span class="hljs-type"><span class="koboSpan" id="kobo.1082.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1083.1">handle_event</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1084.1">(E event)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.1085.1">{
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1086.1">if</span></span><span class="koboSpan" id="kobo.1087.1">(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1088.1">auto</span></span><span class="koboSpan" id="kobo.1089.1"> the_state = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1090.1">get_the_state</span></span><span class="koboSpan" id="kobo.1091.1">(current_state_))
        {
            current_state_= the_state-&gt;</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1092.1">handle_event</span></span><span class="koboSpan" id="kobo.1093.1">(event);
        }
    }
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.1094.1">//...</span></span><span class="koboSpan" id="kobo.1095.1">
};
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1096.1">The preceding code shows the template method </span><code class="inlineCode"><span class="koboSpan" id="kobo.1097.1">handle_event</span></code><span class="koboSpan" id="kobo.1098.1"> from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1099.1">ble_fsm</span></code><span class="koboSpan" id="kobo.1100.1"> class, which makes our tag-dispatching technique application complete.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1101.1">You can run the full example in the Renode simulator from the book’s GitHub repo. </span><span class="koboSpan" id="kobo.1101.2">It is placed under </span><code class="inlineCode"><span class="koboSpan" id="kobo.1102.1">Chapter16/fsm</span></code><span class="koboSpan" id="kobo.1103.1">, and you can build and run it using the following commands:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1104.1">$ cmake –B build
-DMAIN_CPP_FILE_NAME=main_fsm_state_pattern_tag_dispatch.cpp
$ cmake --build build --target run_in_renode
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1105.1">Until this point, we saw three approaches in this chapter to implement an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1106.1">FSM</span></code><span class="koboSpan" id="kobo.1107.1"> in C++. </span><span class="koboSpan" id="kobo.1107.2">We started with a simple switch and if-else-based approach, applied the State design pattern, and then utilized tag dispatching. </span><span class="koboSpan" id="kobo.1107.3">Each </span><a id="_idIndexMarker711"/><span class="koboSpan" id="kobo.1108.1">step provided us with more flexibility in the design – making code more readable </span><a id="_idIndexMarker712"/><span class="koboSpan" id="kobo.1109.1">and easier to manage, which is important when working with complex </span><code class="inlineCode"><span class="koboSpan" id="kobo.1110.1">FSM</span></code><span class="koboSpan" id="kobo.1111.1">s.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1112.1">There are other approaches to implementing an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1113.1">FSM</span></code><span class="koboSpan" id="kobo.1114.1">, based on a state transition table, which describes transitions in a single place. </span><span class="koboSpan" id="kobo.1114.2">Boost </span><strong class="keyWord"><span class="koboSpan" id="kobo.1115.1">State Machine Language</span></strong><span class="koboSpan" id="kobo.1116.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.1117.1">SML</span></strong><span class="koboSpan" id="kobo.1118.1">) uses a table-based approach to describe an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1119.1">FSM</span></code><span class="koboSpan" id="kobo.1120.1"> using</span><a id="_idIndexMarker713"/><span class="koboSpan" id="kobo.1121.1"> descriptive syntax.</span></p>
<h1 class="heading-1" id="_idParaDest-221"><span class="koboSpan" id="kobo.1122.1">Boost SML</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1123.1">Boost SML is a highly expressive C++14 single </span><a id="_idIndexMarker714"/><span class="koboSpan" id="kobo.1124.1">header library used to implement </span><code class="inlineCode"><span class="koboSpan" id="kobo.1125.1">FSM</span></code><span class="koboSpan" id="kobo.1126.1">s. </span><span class="koboSpan" id="kobo.1126.2">We will jump straight ahead in using it by implementing the same BLE device connection </span><code class="inlineCode"><span class="koboSpan" id="kobo.1127.1">FSM</span></code><span class="koboSpan" id="kobo.1128.1">. </span><span class="koboSpan" id="kobo.1128.2">Here is the code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.1129.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1130.1">include</span></span><span class="hljs-meta"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.1131.1">"sml.hpp"</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1132.1">namespace</span></span><span class="koboSpan" id="kobo.1133.1"> sml = boost::sml;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1134.1">struct</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1135.1">ble_button_pressed</span></span><span class="koboSpan" id="kobo.1136.1">{};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1137.1">struct</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1138.1">connection_request</span></span><span class="koboSpan" id="kobo.1139.1">{};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1140.1">struct</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1141.1">timer_expired</span></span><span class="koboSpan" id="kobo.1142.1">{};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1143.1">constexpr</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1144.1">auto</span></span><span class="koboSpan" id="kobo.1145.1"> start_advertising = [](){
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1146.1">printf</span></span><span class="koboSpan" id="kobo.1147.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1148.1">"Action: start_advertising()\n"</span></span><span class="koboSpan" id="kobo.1149.1">);
};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1150.1">constexpr</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1151.1">auto</span></span><span class="koboSpan" id="kobo.1152.1"> stop_advertising = [](){
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1153.1">printf</span></span><span class="koboSpan" id="kobo.1154.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1155.1">"Action: stop_advertising()\n"</span></span><span class="koboSpan" id="kobo.1156.1">);
};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1157.1">constexpr</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1158.1">auto</span></span><span class="koboSpan" id="kobo.1159.1"> disconnect = [](){
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1160.1">printf</span></span><span class="koboSpan" id="kobo.1161.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1162.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1163.1">Action: disconnect()\n"</span></span><span class="koboSpan" id="kobo.1164.1">);
};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1165.1">struct</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1166.1">ble_fsm</span></span><span class="koboSpan" id="kobo.1167.1"> {
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1168.1">auto</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1169.1">operator</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1170.1">()()</span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="koboSpan" id="kobo.1171.1">const</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.1172.1">{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1173.1">using</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1174.1">namespace</span></span><span class="koboSpan" id="kobo.1175.1"> sml;
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1176.1">return</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1177.1">make_transition_table</span></span><span class="koboSpan" id="kobo.1178.1">(
        *</span><span class="hljs-string"><span class="koboSpan" id="kobo.1179.1">"idle"</span></span><span class="koboSpan" id="kobo.1180.1">_s + event&lt;ble_button_pressed&gt;
        / start_advertising                          = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1181.1">"advertising"</span></span><span class="koboSpan" id="kobo.1182.1">_s,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1183.1">"advertising"</span></span><span class="koboSpan" id="kobo.1184.1">_s  + event&lt;connection_request&gt; = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1185.1">"connected"</span></span><span class="koboSpan" id="kobo.1186.1">_s,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1187.1">"advertising"</span></span><span class="koboSpan" id="kobo.1188.1">_s  + event&lt;timer_expired&gt;     
        / stop_advertising                           = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1189.1">"idle"</span></span><span class="koboSpan" id="kobo.1190.1">_s,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1191.1">"connected"</span></span><span class="koboSpan" id="kobo.1192.1">_s + event&lt;ble_button_pressed&gt;
        / disconnect                                 = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1193.1">"idle"</span></span><span class="koboSpan" id="kobo.1194.1">_s
    );
  }
};
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1195.1">Let us break down this example:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.1196.1">The events are modeled </span><a id="_idIndexMarker715"/><span class="koboSpan" id="kobo.1197.1">as structs, the same as in our tag-dispatching implementation.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1198.1">Actions are defined as </span><code class="inlineCode"><span class="koboSpan" id="kobo.1199.1">constexpr</span></code><span class="koboSpan" id="kobo.1200.1"> lambdas.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1201.1">We define the type </span><code class="inlineCode"><span class="koboSpan" id="kobo.1202.1">ble_fsm</span></code><span class="koboSpan" id="kobo.1203.1"> as a struct with an overloaded </span><code class="inlineCode"><span class="koboSpan" id="kobo.1204.1">operator()</span></code><span class="koboSpan" id="kobo.1205.1">, which returns the result of a call to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1206.1">make_transition_table</span></code><span class="koboSpan" id="kobo.1207.1"> from the namespace </span><code class="inlineCode"><span class="koboSpan" id="kobo.1208.1">sml</span></code><span class="koboSpan" id="kobo.1209.1">.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1210.1">The code in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1211.1">make_transition_table</span></code><span class="koboSpan" id="kobo.1212.1"> allows SML to extract transition definitions, and within it, we are using the following syntax: </span><code class="inlineCode"><span class="koboSpan" id="kobo.1213.1">src_state + event [ guard ] / action = dst_state</span></code><span class="koboSpan" id="kobo.1214.1">. </span><span class="koboSpan" id="kobo.1214.2">Here is a breakdown of the syntax:</span></p>
<ul>
<li class="bulletList"> <code class="inlineCode"><span class="koboSpan" id="kobo.1215.1">src_state</span></code><span class="koboSpan" id="kobo.1216.1"> – This is the state from which the transition starts.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1217.1">+ event</span></code><span class="koboSpan" id="kobo.1218.1"> – This is the event that triggers checking for a possible transition. </span><span class="koboSpan" id="kobo.1218.2">If the event arrives and the guard is satisfied, then the transition proceeds.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1219.1">[ guard ]</span></code><span class="koboSpan" id="kobo.1220.1"> – The guard is an optional bool predicate that must evaluate to true for the transition to occur. </span><span class="koboSpan" id="kobo.1220.2">If omitted, the transition happens unconditionally at the specified event.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1221.1">/ action</span></code><span class="koboSpan" id="kobo.1222.1"> – The action is an optional lambda to execute whenever the transition takes place.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1223.1">= dst_state</span></code><span class="koboSpan" id="kobo.1224.1"> – The destination state is where the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1225.1">FSM</span></code><span class="koboSpan" id="kobo.1226.1"> will go if the transition occurs.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1227.1">The transition syntax is the essence of SML. </span><span class="koboSpan" id="kobo.1227.2">By writing </span><a id="_idIndexMarker716"/><span class="koboSpan" id="kobo.1228.1">multiple lines of these rules inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1229.1">operator()</span></code><span class="koboSpan" id="kobo.1230.1">, we fully describe the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1231.1">FSM</span></code><span class="koboSpan" id="kobo.1232.1">'s behavior in a declarative, human-readable way.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1233.1">Let us now see how to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1234.1">FSM</span></code><span class="koboSpan" id="kobo.1235.1"> we discussed using Boost SML:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1236.1">    sm&lt;ble_fsm&gt; my_ble_fsm{};
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.1237.1">const</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1238.1">auto</span></span><span class="koboSpan" id="kobo.1239.1"> print_current_state = [&amp;]() {
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1240.1">printf</span></span><span class="koboSpan" id="kobo.1241.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1242.1">"Current State: "</span></span><span class="koboSpan" id="kobo.1243.1">);
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1244.1">if</span></span><span class="koboSpan" id="kobo.1245.1">(my_ble_fsm.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1246.1">is</span></span><span class="koboSpan" id="kobo.1247.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1248.1">"idle"</span></span><span class="koboSpan" id="kobo.1249.1">_s)) {
            </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1250.1">printf</span></span><span class="koboSpan" id="kobo.1251.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1252.1">"idle\n"</span></span><span class="koboSpan" id="kobo.1253.1">);
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1254.1">if</span></span><span class="koboSpan" id="kobo.1255.1">(my_ble_fsm.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1256.1">is</span></span><span class="koboSpan" id="kobo.1257.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1258.1">"advertising"</span></span><span class="koboSpan" id="kobo.1259.1">_s)) {
            </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1260.1">printf</span></span><span class="koboSpan" id="kobo.1261.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1262.1">"advertising\n"</span></span><span class="koboSpan" id="kobo.1263.1">);
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1264.1">if</span></span><span class="koboSpan" id="kobo.1265.1">(my_ble_fsm.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1266.1">is</span></span><span class="koboSpan" id="kobo.1267.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1268.1">"connected"</span></span><span class="koboSpan" id="kobo.1269.1">_s)) {
            </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1270.1">printf</span></span><span class="koboSpan" id="kobo.1271.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1272.1">"connected\n"</span></span><span class="koboSpan" id="kobo.1273.1">);
        }
    };
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1274.1">print_current_state</span></span><span class="koboSpan" id="kobo.1275.1">();
    my_ble_fsm.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1276.1">process_event</span></span><span class="koboSpan" id="kobo.1277.1">(ble_button_pressed{});
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1278.1">print_current_state</span></span><span class="koboSpan" id="kobo.1279.1">();
    my_ble_fsm.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1280.1">process_event</span></span><span class="koboSpan" id="kobo.1281.1">(connection_request{});
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1282.1">print_current_state</span></span><span class="koboSpan" id="kobo.1283.1">();
    my_ble_fsm.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1284.1">process_event</span></span><span class="koboSpan" id="kobo.1285.1">(ble_button_pressed{});
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1286.1">print_current_state</span></span><span class="koboSpan" id="kobo.1287.1">();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1288.1">In this code, we create an object </span><code class="inlineCode"><span class="koboSpan" id="kobo.1289.1">my_ble_fsm</span></code><span class="koboSpan" id="kobo.1290.1"> of the type </span><code class="inlineCode"><span class="koboSpan" id="kobo.1291.1">sm&lt;ble_fsm&gt;</span></code><span class="koboSpan" id="kobo.1292.1">. </span><span class="koboSpan" id="kobo.1292.2">Then, we use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1293.1">process_event</span></code><span class="koboSpan" id="kobo.1294.1"> method to send an</span><a id="_idIndexMarker717"/><span class="koboSpan" id="kobo.1295.1"> event to it. </span><span class="koboSpan" id="kobo.1295.2">You can run the full example in the Renode simulator from the book’s GitHub repo. </span><span class="koboSpan" id="kobo.1295.3">It is placed under </span><code class="inlineCode"><span class="koboSpan" id="kobo.1296.1">Chapter16/fsm</span></code><span class="koboSpan" id="kobo.1297.1">, and you can build and run it using the following commands:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1298.1">$ cmake –B build -DMAIN_CPP_FILE_NAME=main_fsm_boost_sml.cpp
$ cmake --build build --target run_in_renode
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1299.1">Boost SML is a highly expressive library that reduces boilerplate code from the previous implementations of an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1300.1">FSM</span></code><span class="koboSpan" id="kobo.1301.1">. </span><span class="koboSpan" id="kobo.1301.2">It also offers features such as guard variables and composite states. </span><span class="koboSpan" id="kobo.1301.3">Here is a project link where you can explore more: </span><a href="https://github.com/boost-ext/sml"><span class="url"><span class="koboSpan" id="kobo.1302.1">https://github.com/boost-ext/sml</span></span></a><span class="koboSpan" id="kobo.1303.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1304.1">Boost SML is not only an expressive library but also highly performant, thanks to its use of compile-time template metaprogramming to aggressively optimize code. </span><span class="koboSpan" id="kobo.1304.2">Event dispatching relies on tag dispatching (resolved at compile time) paired with minimal runtime lookups, avoiding costly branching or indirection. </span><span class="koboSpan" id="kobo.1304.3">This approach typically outperforms both manual switch-</span><code class="inlineCode"><span class="koboSpan" id="kobo.1305.1">enum</span></code><span class="koboSpan" id="kobo.1306.1">-based solutions and State pattern-based implementations (which incur virtual call overhead). </span><span class="koboSpan" id="kobo.1306.2">For concrete performance comparisons, see the benchmark at the following link: </span><a href="https://github.com/boost-ext/sml?tab=readme-ov-file#benchmark"><span class="url"><span class="koboSpan" id="kobo.1307.1">https://github.com/boost-ext/sml?tab=readme-ov-file#benchmark</span></span></a><span class="koboSpan" id="kobo.1308.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1309.1">Summary</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1310.1">In this chapter, we went through </span><code class="inlineCode"><span class="koboSpan" id="kobo.1311.1">FSM</span></code><span class="koboSpan" id="kobo.1312.1"> implementation starting from the simple switch-case-based approach, to the State pattern, tag dispatching, and using the Boost SML library for highly expressive code.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1313.1">The most basic, switch-based implementation is suitable for small </span><code class="inlineCode"><span class="koboSpan" id="kobo.1314.1">FSM</span></code><span class="koboSpan" id="kobo.1315.1">s with a limited number of states and transitions. </span><span class="koboSpan" id="kobo.1315.2">When the complexity of an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1316.1">FSM</span></code><span class="koboSpan" id="kobo.1317.1"> increases, it gets hard to read and manage. </span><span class="koboSpan" id="kobo.1317.2">Moving to a State pattern-based solution increases code readability and makes changes easier. </span><span class="koboSpan" id="kobo.1317.3">Boost SML offers ultimate expressiveness, providing us with a human-readable syntax that allows us to write very complex </span><code class="inlineCode"><span class="koboSpan" id="kobo.1318.1">FSM</span></code><span class="koboSpan" id="kobo.1319.1">s in a concise manner.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1320.1">In the next chapter, we will go through an overview of libraries and frameworks in C++ usable for embedded systems development.</span></p>
</div>
</body></html>