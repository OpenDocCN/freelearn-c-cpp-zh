<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer178">
<h1 class="chapter-number" id="_idParaDest-229"><a id="_idTextAnchor230"/>13</h1>
<h1 id="_idParaDest-230"><a id="_idTextAnchor231"/>Finishing with Sound and Animation</h1>
<p>We’re in the home stretch. The effort we started back in <a href="B17473_09.xhtml#_idTextAnchor146"><em class="italic">Chapter 9</em></a>, <em class="italic">Designing the Level</em>, was resumed by making the level look more exciting in <a href="B17473_10.xhtml#_idTextAnchor165"><em class="italic">Chapter 10</em></a>, <em class="italic">Making Things Look Better with Lights and Shadows</em>, which led us to implement a basic user interface in <a href="B17473_11.xhtml#_idTextAnchor186"><em class="italic">Chapter 11</em></a>, <em class="italic">Creating the User Interface</em>. We built new mechanics in <a href="B17473_12.xhtml#_idTextAnchor206"><em class="italic">Chapter 12</em></a>, <em class="italic">Interacting with the World through Camera and Character Controllers</em>, so we could interact with the world we have created. As a result, Clara is now able to press the parchment left by her uncle, and she can also walk around. This is all very nice, and we can take it a step further by refining some rough edges. </p>
<p>It’s all quiet in here! As she’s walking, we should trigger an audio file that will simulate her footsteps. While we are at it, we will also add background music and effects that will better reflect the qualities of the environment Clara is in.</p>
<p>You must have noticed that, as Clara walks around, sconces and candles around the level illuminate her. Can she do the same with the torch she is holding in her hand? Of course! It might help her see the backpack behind the cart. In fact, she’s going to have to use her torch to see better because we’ll turn off all of the light sources in this chapter. </p>
<p>We’ll discover a new node in Godot to know whether a player character entered an area. Via this method, game designers usually trigger in-game events such as traps, a conversation with a quest giver, and so on. Our event choice will be Clara lighting the sconces and candles as she goes near them.</p>
<p>Eventually, she’ll reach the backpack where she’ll pick up the key. We are not concerned with an inventory system in this game, yet we will consider this key object as a requirement for opening the door. So, once the condition is satisfied, we need that door to open for us. However, the door did not come into Godot with its animation set up in Blender. This is our chance to see how basic animations can be created inside Godot.</p>
<p>When all of the conditions are in place, including the door opening that simulates a clear path upstairs, we’ll swap our current level with another one. That particular moment will signify the conclusion of our little game, but you can take it wherever you want to take it.</p>
<p>This is going to be another chapter with lots of distinct topics used together. Speaking of which, the following are the titles under which you’ll find us executing the plan we’ve presented so far:</p>
<ul>
<li>Playing music and sound effects</li>
<li>Creating reaction spots</li>
<li>Building simple animations in Godot</li>
<li>Loading another level</li>
</ul>
<p>By the end of this chapter, you’ll have finished the core mechanics of our point-and-click adventure game. Not only will you construct and work with new systems, but you’ll also make these systems conditional on world or character events.</p>
<p>Good luck and enjoy!</p>
<h1 id="_idParaDest-231"><a id="_idTextAnchor232"/>Technical requirements</h1>
<p>It’s perfectly fine if you would like to continue where you left off in the previous chapter. However, there are some extra resources you will need to finish the work in this chapter. You can merge these assets with the rest of your project files. They are in the <strong class="source-inline">Resources</strong> folder next to the <strong class="source-inline">Finish</strong> folder in this book’s repository that can be found at <a href="https://github.com/PacktPublishing/Game-Development-with-Blender-and-Godot">https://github.com/PacktPublishing/Game-Development-with-Blender-and-Godot</a>.</p>
<h1 id="_idParaDest-232"><a id="_idTextAnchor233"/>Playing music and sound effects</h1>
<p>Music and <a id="_idIndexMarker612"/>sound effects sometimes can make or break the enjoyment people<a id="_idIndexMarker613"/> get out of movies, theatre plays, and of course, video games. When done right, they will definitely add to the immersion. In this section, we’ll tackle the use of music and sound effects from a technical point of view. In your own free time, we suggest you investigate the artistic aspects of sound design in multimedia for which we’ll mention a few resources later on in the <em class="italic">Further reading</em> section. </p>
<p>In <a href="B17473_08.xhtml#_idTextAnchor129"><em class="italic">Chapter 8</em></a>, <em class="italic">Adding Sound Assets</em>, we discussed different nodes Godot uses to play sound in different dimensions, as follows:</p>
<ul>
<li><strong class="bold">AudioStreamPlayer3D</strong> for <a id="_idIndexMarker614"/>conveying 3D positional information to the player. It’s most commonly used in FPS games where not only front and back directions matter, but an audio stream coming from an elevated place is important as well.</li>
<li><strong class="bold">AudioStreamPlayer2D</strong> for <a id="_idIndexMarker615"/>games in which the direction the sound is coming from doesn’t need to have depth information. Most platformer games are a good example of this kind.</li>
<li><strong class="bold">AudioStreamPlayer</strong> for <a id="_idIndexMarker616"/>background music since it may be considered one-dimensional.</li>
</ul>
<p>Out of these three, two types seem to be the right candidates for our purposes. We want to play background music, so we will use <strong class="bold">AudioStreamPlayer</strong>. Then, when Clara is walking around, it makes sense to use <strong class="bold">AudioStreamPlayer3D</strong>. </p>
<p>The latter case may not seem obvious, and we can certainly use the regular <strong class="bold">AudioStreamPlayer</strong> as well for the footsteps, but we will cross that bridge when we come to it. Our most immediate concern is to set up the ambient music.</p>
<h2 id="_idParaDest-233"><a id="_idTextAnchor234"/>Setting background music</h2>
<p>In the <em class="italic">Understanding the camera system</em> section of <a href="B17473_12.xhtml#_idTextAnchor206"><em class="italic">Chapter 12</em></a>, <em class="italic">Interacting with the World through Camera and Character Controllers</em>, we showed the use of an outer scene structure, such as <strong class="source-inline">Game.tscn</strong>, to hold the level we built in <a href="B17473_09.xhtml#_idTextAnchor146"><em class="italic">Chapter 9</em></a>, <em class="italic">Designing the Level</em>. A <a id="_idIndexMarker617"/>wrapper structure such as ours is also a good place to place more global-scale constructs, such as audio streamers. Yet, we would like to discuss an alternative before we move on with our initial plan. </p>
<p>Although a player character is part of the game world, we decided to place it inside the level via a <strong class="bold">Player</strong> node. It was convenient to do so because we could easily see where to position <strong class="bold">Player</strong> inside the coordinate system of the <strong class="source-inline">Level-01.tscn</strong> scene. If you place it inside <strong class="source-inline">Game.tscn</strong>, for the sake of keeping things separate and sanitized, then you will have to figure out a way to connect both the <strong class="bold">Player</strong> and the <strong class="bold">Level-01</strong> nodes inside <strong class="source-inline">Game.tscn</strong>. This would not be impossible, but it would make things less convenient. </p>
<p>Similarly, where should you place the node that will play the background music? Although we may want every level to play its own thematic music, and this would guide us in the direction of using an <strong class="bold">AudioStreamPlayer</strong> node inside each level, we’ll still place it in <strong class="source-inline">Game.tscn</strong>. When we attack the topic of loading different levels in the <em class="italic">Loading another level</em> section, hopefully, the scheme we are suggesting will make more sense. </p>
<p>Let’s see how we can execute the<a id="_idIndexMarker618"/> original plan. Open the <strong class="source-inline">Game.tscn</strong> scene and perform the following steps:</p>
<ol>
<li>Add an <strong class="bold">AudioStreamPlayer</strong> node to the root and rename it as <strong class="bold">BackgroundMusic</strong>.</li>
<li>Drag <strong class="source-inline">Native Dream.mp3</strong> from <strong class="bold">FileSystem</strong> to the <strong class="bold">Stream</strong> property of this new node.</li>
<li>Turn on the <strong class="bold">Autoplay</strong> option in the <strong class="bold">Inspector</strong> panel.</li>
<li>Press <em class="italic">F5</em> and relax.</li>
</ol>
<p>The piece of music we are using is about 2 minutes long and it will be automatically looped by Godot. Thus, it won’t feel too repetitive while Clara or the player is discovering the level. </p>
<p>Speaking of<a id="_idIndexMarker619"/> placing a background music structure at a higher level, there is one more approach you can use: <strong class="bold">singletons</strong>, also known as <strong class="bold">AutoLoad</strong>. For absolute<a id="_idIndexMarker620"/> beginners, these<a id="_idIndexMarker621"/> are the ultimate top-level structures you can use in your project. These will always be present when you launch your game and loaded in the order you define them in the <strong class="bold">AutoLoad</strong> tab of <strong class="bold">Project Settings</strong>. Via this method, you can use a dedicated scene as a single source of music. You can read more about it at <a href="https://docs.godotengine.org/en/3.4/tutorials/scripting/singletons_autoload.xhtml">https://docs.godotengine.org/en/3.4/tutorials/scripting/singletons_autoload.xhtml</a>.</p>
<p>Some players turn off game music for the sake of focusing on sound effects. In the following section, we’ll introduce our first sound effect. We expect Clara’s walking to trigger a suitable sound effect, namely footsteps.</p>
<h2 id="_idParaDest-234"><a id="_idTextAnchor235"/>Conditionally playing a sound</h2>
<p>Let’s see how we can <a id="_idIndexMarker622"/>play a sound file conditionally in this section. There is actually nothing magical nor special in the way of achieving this goal. It’s similar to knowing when Clara walks or stands idly. In the <em class="italic">Playing the right action for Clara</em> section of <a href="B17473_12.xhtml#_idTextAnchor206"><em class="italic">Chapter 12</em></a>, <em class="italic">Interacting with the World through Camera and Character Controllers</em>, we implemented two extra lines of code inside the <strong class="source-inline">move_along</strong> function to trigger the correct actions for Clara to show, animation-wise, the state she is currently in.</p>
<p>We could still take advantage of the same function by enabling the execution of the sound file for her footsteps. That being said, now might be a good moment to discuss some of our practices. It would seem that we are overloading the meaning of the <strong class="source-inline">move_along</strong> function. You might consider our current efforts still a phase of building a prototype similar to, as is often said during a writing exercise, writing a draft, then focusing on edits later. </p>
<p>Sometimes, good <a id="_idIndexMarker623"/>architecture might be deduced before you start the bulk of the work, perhaps because you’ve done something similar before. Often, though, this may not be the case, and your discoveries, thus your decisions into coming up with an efficient architecture, might have to wait for later. As soon as you notice there are common parts you can extract out of the current structures, you should. However, concerning yourself with the fine details of creating the most efficient code structure and information flow might not be the best use of your time while you are still deciding on gameplay.</p>
<p>So, for now, we’ll add the footsteps sound as an extra element inside the <strong class="source-inline">move_along</strong> function until we need a much more efficient way, as follows:</p>
<ol>
<li value="1">Open the <strong class="source-inline">Player.tscn</strong> scene and add <strong class="bold">AudioStreamPlayer3D</strong> under the root node. Rename it as <strong class="source-inline">FootSteps</strong>.</li>
<li>Select <strong class="source-inline">FootSteps.wav</strong> and switch to the <strong class="bold">Import</strong> panel. Then do as follows:<ol><li>Turn on both the <strong class="bold">Loop</strong> and <strong class="bold">Normalize</strong> options.</li>
<li>Press <strong class="bold">Reimport</strong>. </li>
</ol></li>
<li>Drag <strong class="source-inline">Footsteps.wav</strong> from <strong class="bold">FileSystem</strong> to the <strong class="bold">Stream</strong> field in the <strong class="bold">Inspector</strong> panel.</li>
<li>Turn on both the <strong class="bold">Autoplay</strong> and <strong class="bold">Stream Paused</strong> properties.</li>
<li>In the <strong class="source-inline">Clara.gd</strong> script, do as follows:<ol><li>Type <strong class="source-inline">$FootSteps.stream_paused = false</strong> after you trigger her walk action. </li>
<li>Type <strong class="source-inline">$FootSteps.stream_paused = true</strong> after you trigger her idle action.</li>
</ol></li>
</ol>
<p>The method we are using <a id="_idIndexMarker624"/>here was discussed in the <em class="italic">Playing a sound effect on demand</em> section of <a href="B17473_08.xhtml#_idTextAnchor129"><em class="italic">Chapter 8</em></a>, <em class="italic">Adding Sound Assets</em>, when repeatedly triggering a sound file in a loop might sound like the sound is jammed.</p>
<p>Additionally, we turned on the loop feature and normalized the volume. The loop is self-explanatory since we will want her footsteps to repeat ceaselessly as long as she’s walking. The <strong class="bold">Normalize</strong> option deserves a few more words, though. The sound files we are using in this project have been collected from multiple sources. This makes it hard to have all these files have a similar level of volume. Some will be louder, some will be quieter. The feature we turned on adjusts the volume of the sound file, so it would be at a similar level to the other files. </p>
<p>When you run the game now, you’ll hear the background music as usual. Then, click around and wait for Clara to walk to the desired spot. Do you hear her footsteps? Most likely just barely. We’ll look into adjusting audio volume later in the <em class="italic">Understanding the volume through decibels</em> section.</p>
<p>For the time being, it might be better if we presented a handy feature in Godot. There might come a time when you would like to apply special effects to some of the sound files you are playing. Godot offers multiple audio channels, also known as an <strong class="bold">audio bus</strong>, via which you can decide which <a id="_idIndexMarker625"/>files will play on a specific channel so you can apply a particular effect only on select channels. </p>
<p>We’ll now pretend that there is a situation like this and play the footsteps sound in its own audio channel. Let’s see how it is done as follows:</p>
<ol>
<li value="1">Expand the <strong class="bold">Audio</strong> panel at the bottom section of Godot Engine. Click on the <strong class="bold">Add Bus</strong> button in the top right corner of the <strong class="bold">Audio</strong> panel.</li>
<li>Rename this <strong class="bold">New Bus</strong> as <strong class="source-inline">SFX</strong>. </li>
<li>Select the <strong class="bold">FootSteps</strong> node and choose the <strong class="bold">SFX</strong> option in the drop-down options for <strong class="bold">Bus</strong>.</li>
</ol>
<p>The footsteps sound will now be played on a different audio channel in Godot. The interface that’s reflecting the changes we have made is shown in <em class="italic">Figure 13.1</em>.</p>
<div>
<div class="IMG---Figure" id="_idContainer162">
<img alt="Figure 13.1 – We are playing the sound effect on its own bus " height="665" src="image/Figure_13.1_B17473.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.1 – We are playing the sound effect on its own bus</p>
<p>Via this method, a dedicated <a id="_idIndexMarker626"/>audio channel will play the sound you want. As you can see at the bottom of the <strong class="bold">SFX</strong> bus in the <strong class="bold">Audio</strong> panel in <em class="italic">Figure 13.1</em>, the audio is sent to the <strong class="bold">Master</strong> channel. When all the audio sources are merged and processed, it’s delivered to <strong class="bold">Speakers</strong>. Furthermore, by using the <strong class="bold">Add Effect</strong> dropdown for an audio bus, you can apply and stack effects that go through this channel. </p>
<p>Although you hear both pieces of audio, they might be competing volume-wise. In the following section, we’ll get a bit technical about how audio volume works.</p>
<h2 id="_idParaDest-235"><a id="_idTextAnchor236"/>Understanding the volume through decibels</h2>
<p>Every vocation has its trade secrets and unique practices, and this is also true for sound engineers. When they talk about volume as how loud a sound is, they use a unit called <strong class="bold">decibel</strong>, marked as <strong class="bold">dB</strong>. If you<a id="_idIndexMarker627"/> are used to the metric system, this is one-tenth of a bel, similar to a decimeter as one-tenth of a meter. However, what exactly is a bel?</p>
<p>Wikipedia has a page that provides a decent amount of technical information for the decibel. Therefore, we’ll provide you with the practical aspects and/or pitfalls of working with decibels in your projects.</p>
<p>Similar to how earthquake magnitude is measured, a decibel is a relative scale where every time you increase the sound level by 6 dB, you double the amplitude of the sound. Consequently, -6 dB means you are halving the amplitude. As far as values go, 0 dB is the maximum amplitude a digital audio system will use. Anything above this value, which means positive values, will be clipped. So, you might still hear something above 0 dB, but it will be distorted the higher you go in decibels. Thus, you’ll be using the negative range when it comes to picking values. </p>
<p>Moreover, there are physical limits to human hearing. Sound is no longer audible between -60 dB and -80 dB. So, in the <a id="_idIndexMarker628"/>end, you have from -60 dB to 0 dB as a workable range. If all of this is confusing, there is perhaps one important fact you might want to keep in mind about decibels. 0 dB denotes the normal amplitude of the sound when it was exported from an audio application. If the base level at 0 dB is too quiet, you might have to fix it at the source rather than messing with it by choosing a higher dB value in Godot. </p>
<p>That being said, we can decrease the amplitude easily. This is indeed what we are going to do with the background music as follows:</p>
<ol>
<li value="1">Open <strong class="source-inline">Game.tscn</strong> and select the <strong class="bold">BackgroundMusic</strong> node.</li>
<li>Adjust <strong class="bold">Volume Db</strong> in the <strong class="bold">Inspector</strong> panel to <strong class="source-inline">-12</strong>, or even <strong class="source-inline">-18</strong>.</li>
</ol>
<p>Since you are now able to discern the footsteps from the background music better, did you notice how Clara’s footsteps get louder as she approaches the camera and quieter as she walks toward the end of the cave? This is thanks to the <strong class="bold">AudioStreamPlayer3D</strong> node’s behavior of processing audio in 3D. If you want to perceive this effect more clearly, feel free to temporarily turn off the background music and focus on the directionality of Clara’s footsteps.</p>
<p class="callout-heading">Who is listening?</p>
<p class="callout">The <strong class="bold">Camera</strong> node has a built-in <strong class="bold">Listener</strong> construct that makes it possible for us to identify from which direction the sound is coming. In some cases, we may want the camera to be in one corner of the world and the listener in another corner. Thus, creating a separate <strong class="bold">Listener</strong> node is not only possible, but it will also be beneficial when you want to simulate a situation where a microphone is placed away from the camera.</p>
<p>If you would like to practice more on playing sound files, we suggest you add a sound effect to the <strong class="bold">Close</strong> button we used in the note user interface. You already know when the button is clicked since we wait for that moment to close the interface. That is the right moment to play a sound effect such as <strong class="source-inline">ButtonPress.wav</strong> in the <strong class="source-inline">Audio</strong> folder.</p>
<p>It seems the world is reacting to our actions by playing animations and sound files, which is nice. In all of these efforts, we’ve had a direct involvement mainly by a mouse click. In the following section, we’ll discover how the world can react to our player character without the player’s direct intervention.</p>
<h1 id="_idParaDest-236"><a id="_idTextAnchor237"/>Creating reaction spots</h1>
<p>When the player<a id="_idIndexMarker629"/> clicks on the parchment, the game shows the content written on that parchment via a user interface. When the player clicks on a particular location in the world, Clara walks to that spot by playing a walking animation and playing a footsteps sound. These are all direct interactions at the player’s end, which brings us to discuss cases when the game should react to indirect events.</p>
<p>Although not lit, Clara is holding a torch. You already know how to use the <strong class="bold">Light</strong> nodes in Godot. So, it’s easy to place <strong class="bold">OmniLight</strong> near the torch mesh inside the <strong class="bold">Clara</strong> node. Our basic expectation is that, when she walks by the candles on the floor and the sconces on the walls, she’ll be lighting those up using her torch. Thus, the game needs to know when she’s near some objects. </p>
<p>Let’s first give Clara a torch she can carry around, then we can proceed to discuss how this torch can affect other objects in the level, as follows:</p>
<ol>
<li value="1">Create a scene out of <strong class="source-inline">Clara.glb</strong> and place an <strong class="bold">OmniLight</strong> node under <strong class="bold">Torch002</strong>.</li>
<li>Position <strong class="bold">OmniLight</strong> according to the torch so it’s slightly above. <strong class="source-inline">0.75</strong> on the <strong class="bold">Y</strong> axis might be enough.</li>
<li>Select <strong class="source-inline">d6d58e</strong> for <strong class="bold">Color</strong> and turn on <strong class="bold">Enable</strong> in the <strong class="bold">Shadow</strong> section.</li>
</ol>
<p>Since <strong class="bold">OmniLight</strong> is a child of the torch mesh, whenever the <strong class="bold">AnimationPlayer</strong> node controls the torch, the light will follow along. This is also a nice example of taking Blender animations and enhancing them with Godot nodes.</p>
<p>We have a dedicated <strong class="source-inline">Clara.tscn</strong> scene, but the <strong class="source-inline">Player.tscn</strong> scene is still unaware of this new development. It’s still using the old model reference. Therefore, you must delete the <strong class="bold">Clara</strong> node in <strong class="source-inline">Player.tscn</strong> and instance <strong class="source-inline">Clara.tscn</strong> instead. The <strong class="bold">Scene</strong> panel won’t look that much different but it’s now going to have Clara holding a lit torch. Test your scene and have Clara walk around, especially near the door. The torchlight will synchronize with her walking cycle. </p>
<p>Clara seems to be<a id="_idIndexMarker630"/> carrying the right tool in her hand to light those candles and sconces. It’s time we added the trigger zones so that the world can react to her presence. That’s what’s coming up next.</p>
<h2 id="_idParaDest-237"><a id="_idTextAnchor238"/>Placing trigger points in the world</h2>
<p>We made use of a <strong class="bold">StaticBody</strong> node to detect user clicks in the <em class="italic">Preparing a clickable area for raycasting</em> section of <a href="B17473_12.xhtml#_idTextAnchor206"><em class="italic">Chapter 12</em></a>, <em class="italic">Interacting with the World through Camera and Character Controllers</em>, so we could deduce where to move Clara. This is useful when you<a id="_idIndexMarker631"/> know that an agent, most likely the player, will directly trigger a system. There are cases when game objects act freely on their own and they should also initiate a response from systems that are waiting to be triggered. This section will cover this kind of situation.</p>
<p>By now, you may have noticed an odd behavior regarding pathfinding and the player’s destination. <strong class="bold">StaticBody</strong> that we set up goes as far as where the floor pieces meet the wall pieces. Therefore, it successfully captures the clicks on the floor tiles. However, if you click anywhere far away or along the walls, the pathfinding may give you an unexpected result. If you extend <strong class="bold">StaticBody</strong> further out, similar to how it covers the water, it will be alright. You can refer to <em class="italic">Figure 12.11</em> of <a href="B17473_12.xhtml#_idTextAnchor206"><em class="italic">Chapter 12</em></a>, <em class="italic">Interacting with the World through Camera and Character Controllers</em>, to observe the placement of <strong class="bold">StaticBody</strong> and adjust it to account for extra space to catch faraway clicks.</p>
<p>Once the destination is determined, Clara will move toward it by getting closer to the props. Some of these objects are good candidates to trigger certain events. For this, we’ll use the <strong class="bold">Area</strong> node, which is inheriting from the same internal structure as <strong class="bold">StaticBody</strong>. These are similar nodes since they both originate from the same place but provide different results.</p>
<p>Although we could place and position an <strong class="bold">Area</strong> node per trigger zone in the level just as we did with many other nodes, keeping in mind that we want to do this for lighting the sconces and candles, it makes more sense to open the dedicated scenes we already have for these. To<a id="_idIndexMarker632"/> that end, you will do as follows:</p>
<ol>
<li value="1">Open <strong class="source-inline">Candles_1.tscn</strong> and place an <strong class="bold">Area</strong> node under the root.</li>
<li>Bring up the <strong class="bold">Node</strong> panel and double-click the <strong class="bold">body_entered(body: Node)</strong> item.</li>
<li>Press the <strong class="bold">Connect</strong> button right away, which will automatically add an event handler to the <strong class="source-inline">LightSwitch.gd</strong> script. Change it as follows:<p class="source-code">func _on_Area_body_entered(body):</p><p class="source-code">    print(body)</p></li>
<li>Place a <strong class="bold">CollisionShape</strong> node under the <strong class="bold">Area</strong> node you have just added.</li>
<li>Define <strong class="bold">New BoxShape</strong> for the <strong class="bold">Shape</strong> property in the <strong class="bold">Inspector</strong> panel.</li>
</ol>
<p>The number from the <strong class="source-inline">print</strong> statement might look different in your machine, but you’ll see something like <strong class="bold">StaticBody:[StaticBody:2025]</strong> in the <strong class="bold">Output</strong> panel when you run the game. We’ve just got a collision result from the <strong class="bold">Area</strong> node we’ve added, but what is it that it hit? It is detecting the catch-all area that covered all of the floor pieces and some portion of the water. </p>
<p>We need to exclude all unwanted candidates so that this trigger zone only responds to our player’s activities. There are multiple ways to do this. We’ll explain an elaborate version right after we present a very simple method. For now, swap the function you just saw with the following code:</p>
<pre class="source-code">func _on_Area_body_entered(body):
    if body.name == "Player":
        print("Hello, Clara!")</pre>
<p>The changes we are making are in <strong class="source-inline">Candles_1.tscn</strong>, which holds the candle group by the barrel when Clara turns right after she clears the docking area. So, press <em class="italic">F5</em> to run the game and move her near the candles as described. You’ll see the <strong class="bold">Output</strong> area display the print message only when she enters the space of those candles. <em class="italic">Figure 13.2</em> will help you see what’s expected.</p>
<div>
<div class="IMG---Figure" id="_idContainer163">
<img alt="Figure 13.2 – It’s as if the candles sensed Clara coming nearby and welcomed her " height="859" src="image/Figure_13.2_B17473.jpg" width="1588"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.2 – It’s as if the candles sensed Clara coming nearby and welcomed her</p>
<p>With this method, we are <a id="_idIndexMarker633"/>only interested in knowing whether <strong class="source-inline">name</strong> of the body that entered the <strong class="bold">Area</strong> node’s space is equal to <strong class="source-inline">Player</strong>. If so, we can trigger the next chain of events. However, before we start tackling our initial intentions, the following are a few words about a more advanced detection method we mentioned.</p>
<h2 id="_idParaDest-238"><a id="_idTextAnchor239"/>Getting to know a better collision detection method</h2>
<p>Godot’s <strong class="bold">PhysicsServer</strong>, a system<a id="_idIndexMarker634"/> that’s responsible for undertaking all of the <a id="_idIndexMarker635"/>calculations for the objects that should be affected by physical rules (such as gravity, collision, intersection, and so on) uses a layer system to keep track of where objects reside. This is not a visual layer as you might see in a graphics editing application such as Adobe Photoshop. Nevertheless, it’s similar because if the objects are on separate layers, then you can define how these layers will interact with each other. Aptly so, the structure that allows this kind of functionality is called <strong class="bold">Layer</strong> in Godot.</p>
<p>Moreover, if all objects are always in the same layer, then you would have to resort to solutions such as name checking. It’s simple and effective, but it could easily get unwieldy because who would want to pick a unique name for each game object? Unquestionably, that <strong class="source-inline">if</strong> block we wrote earlier would get longer and longer to filter which particular object entered the area. To eliminate such situations, Godot has another construct that is called <strong class="bold">Mask</strong>.</p>
<p>Through a clever way of creating multiple <strong class="bold">Layer</strong> and <strong class="bold">Mask</strong> options, and defining their relationship, you can reduce the load of writing unnecessarily long and inconvenient <strong class="source-inline">if</strong> blocks where you check what’s colliding with what. In a way, that sort of check will be done for you in <strong class="bold">PhysicsServer</strong>, so you can only account for completely necessary <strong class="source-inline">if</strong> checks for controlling other less trivial cases. </p>
<p>The following <a id="_idIndexMarker636"/>figure shows where you can find the <strong class="bold">Layer</strong> and <strong class="bold">Mask</strong> options for the <strong class="bold">Area</strong> node we are currently configuring:</p>
<div>
<div class="IMG---Figure" id="_idContainer164">
<img alt="Figure 13.3 – Using collision layers might be another detection method " height="595" src="image/Figure_13.3_B17473.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.3 – Using collision layers might be another detection method</p>
<p>While this method is effective and valuable, setting it up in our current situation and explaining it via the pages of this book would be inefficient. Instead, we will use the available space to present other practical applications. Still, it is a vital architectural choice you might have to rely on in your future projects. So, we suggest you read about this by visiting the <em class="italic">Collision layers and masks</em> section at <a href="https://docs.godotengine.org/en/3.4/tutorials/physics/physics_introduction.xhtml">https://docs.godotengine.org/en/3.4/tutorials/physics/physics_introduction.xhtml</a>.</p>
<p>Our more immediate concern is what we do when Clara goes near those candles. Let’s see her influence on the world.</p>
<h2 id="_idParaDest-239"><a id="_idTextAnchor240"/>Lighting the candles and sconces</h2>
<p>We’ve been laying the <a id="_idIndexMarker637"/>groundwork for Clara to interact with the world around her. Our latest<a id="_idIndexMarker638"/> effort involved proximity detection by <strong class="source-inline">Candles_1.tscn</strong> through the use of an <strong class="bold">Area</strong> node. The reaction is not useful at this point since it’s just a silly <strong class="source-inline">print</strong> statement, but we are at a good spot to make it more interesting.</p>
<p>To truly appreciate Clara’s impact on the world, we should start by turning off some of the lights on the level. Switch to the <strong class="source-inline">Level-01.tscn</strong> scene and perform the following steps: </p>
<ol>
<li value="1">Select all instances of <strong class="source-inline">Candles_1.tscn</strong> and <strong class="source-inline">Candles_2.tscn</strong>.</li>
<li>Turn off the <strong class="bold">Is Lit</strong> property in the <strong class="bold">Inspector</strong> panel.</li>
<li>Repeat the first two steps for all sconces in the level. </li>
<li>Press <em class="italic">F5</em> to run the game and move Clara around.</li>
</ol>
<p>Atmospheric, isn’t it? When Clara goes to the same spot that triggered the message in the <strong class="bold">Output</strong> panel, the level will look like the following:</p>
<div>
<div class="IMG---Figure" id="_idContainer165">
<img alt="Figure 13.4 – Clara is depending on the torch she’s holding in her hand " height="595" src="image/Figure_13.4_B17473.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.4 – Clara is depending on the torch she’s holding in her hand</p>
<p>The torch she’s holding is enough for her to see where she’s going. However, it would be nice to light those candles she’s just standing by. We’ve already done the hard work in <strong class="source-inline">Candles_1.tscn</strong> so all there is left to do is to turn on <strong class="bold">OmniLight</strong> internally as follows:</p>
<ol>
<li value="1">Open the <strong class="source-inline">LightSwitch.gd</strong> script.</li>
<li>Replace the <strong class="source-inline">print</strong> statement in the <strong class="source-inline">_on_Area_body_entered</strong> function by typing <strong class="source-inline">is_lit = true</strong>. The function will look like the following example after your changes:<p class="source-code">func _on_Area_body_entered(body):</p><p class="source-code">    if body.name == "Player":</p><p class="source-code">        is_lit = true</p></li>
<li>Press <em class="italic">F5</em> to run the game and move Clara first to the same area, then to a different location.</li>
</ol>
<p>When Clara goes near the <a id="_idIndexMarker639"/>same candles this time, those candles will be lit. It might be a bit <a id="_idIndexMarker640"/>difficult to see the effect depending on exactly where she’s standing. So, when she walks away from those candles, you’ll truly feel her mark on the world, as seen in <em class="italic">Figure 13.5</em>:</p>
<div>
<div class="IMG---Figure" id="_idContainer166">
<img alt="Figure 13.5 – Clara is getting some help from those candles she just lit " height="595" src="image/Figure_13.5_B17473.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.5 – Clara is getting some help from those candles she just lit</p>
<p>This was just one candle game object Clara interacted with. We have another candle scene, <strong class="source-inline">Candles_2.tscn</strong>, and a separate scene for the sconces, <strong class="source-inline">Sconce.tscn</strong>. We could easily replicate what we have done to this point for these other scenes, as follows:</p>
<ol>
<li value="1">Open <strong class="source-inline">Candles_1.tscn</strong> first, then right-click the <strong class="bold">Area</strong> node, and select <strong class="bold">Copy</strong> in the context menu.</li>
<li>Open <strong class="source-inline">Candles_2.tscn</strong> next, then right-click the root node, and select <strong class="bold">Paste</strong> in the context menu.</li>
<li>Bring up the <strong class="bold">Node</strong> panel and then do as follows:<ol><li>Right-click the <strong class="bold">body_entered</strong> item in the list and select the <strong class="bold">Disconnect All</strong> option. Press the <strong class="bold">OK</strong> button on the upcoming confirmation screen.</li>
<li>Double-click the <strong class="bold">body_entered</strong> item in the list. Press the <strong class="bold">Connect</strong> button on the upcoming screen.</li>
</ol></li>
</ol>
<p>Normally, we shouldn’t <a id="_idIndexMarker641"/>have to do the third step. When you copy and paste nodes<a id="_idIndexMarker642"/> between scenes, the signals are not transferred. So, we had to manually remove what seemed to be an active signal and rebind it. Luckily, both candle scenes are using the same script and we already have the event handler. That’s why we didn’t have to write the programming parts. When you transfer nodes between scenes as we did, keep in mind to reconnect the signals. Godot 4 might have a fix for this behavior.</p>
<p>So, run the game and have Clara walk by all of the candles. They will be lit one after another as she gets close, and the following is what you’ll experience when she does so:</p>
<div>
<div class="IMG---Figure" id="_idContainer167">
<img alt="Figure 13.6 – All of the candles were lit after Clara walked by them " height="753" src="image/Figure_13.6_B17473.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.6 – All of the candles were lit after Clara walked by them</p>
<p>We suggest you <a id="_idIndexMarker643"/>apply the same procedure to the <strong class="source-inline">Sconce.tscn</strong> scene. This<a id="_idIndexMarker644"/> time around though, alter the <strong class="bold">Z</strong> axis of <strong class="bold">BoxShape</strong> for the <strong class="bold">CollisionShape</strong> node to simulate the extra distance the sconces must have between the walls and Clara. We chose a value of <strong class="source-inline">2</strong>, but you might want to adjust it to something that suits your conditions. Alternatively, you could move the whole <strong class="bold">Area</strong> node a bit forward to line it up with the two extensions of the sconce that connect to a wall. As long as there is enough area extended out of sconces, Clara will trigger it.</p>
<p>So, where else can you take this idea? A simple case might be to introduce traps or enemies reacting to the player’s position. In the case of enemies, they can also take advantage of pathfinding via the same <strong class="bold">Navigation</strong> node we placed in the level. Also, it’s common, in a case like this, when enemies give up after following the player for a certain period of time. If the distance is not getting any shorter and the player is getting away fast enough, the enemy will usually return to their designated patrol zone instead of trying to catch up with the player.</p>
<p>We aren’t going to introduce such mechanics in this game. However, it might be something you can pursue as a more advanced game feature. If you are really interested in enemy versus player behavior, then we suggest you read a few <strong class="bold">artificial intelligence</strong> books on game development. There are a plethora of options out there and we’ll give you a brief list in the <em class="italic">Further reading</em> section.</p>
<p>There are two more trigger zones we should create. One is for the backpack behind the cart when Clara goes near that area. The other one is when she approaches the door that leads upstairs. Let’s start with the backpack.</p>
<h2 id="_idParaDest-240"><a id="_idTextAnchor241"/>Adding the trigger for the backpack</h2>
<p>This effort will be<a id="_idIndexMarker645"/> similar to the way we did it for the candles and sconces. Since you already know that by using an <strong class="bold">Area</strong> node you can introduce interactivity, we’ll present something slightly new. </p>
<p>When players interact with the world, more specifically with the game objects, they feel that they have agency over these items. For example, players have just discovered that walking near candles will light them. This is part of the fun besides the narrative and story elements a game can have. At this point, it’s up to the game designer to interweave another layer of complexity. Perhaps, being close to the candles is only a precondition and the player is also expected to click on the candles. </p>
<p>Regardless of the conditions a game designer will expect the player to satisfy, giving feedback to the player is quintessential. When players try things on their own, they will get negative or positive feedback. This kind of harmless trial and error could easily be used in lieu of a tutorial. An easy and reliable way to provide feedback is something we’ve already looked at. It is playing sound.</p>
<p>For the backpack exercise, we’ll combine both playing an audio file and reacting to an area effect. Once Clara approaches the backpack as she did with the candles, the backpack will play a sound file that will inform the player that she picked up the key. The following steps show you how you do it:</p>
<ol>
<li value="1">Create a scene out of <strong class="source-inline">Backpack.glb</strong> and save it as <strong class="source-inline">Backpack.tscn</strong> in its original folder.</li>
<li>Place an <strong class="bold">AudioStreamPlayer</strong> node under the root. Assign <strong class="source-inline">CollectItem.wav</strong> to its <strong class="bold">Stream</strong> field.</li>
<li>Add an <strong class="bold">Area</strong> node with <strong class="bold">CollisionShape</strong> under the root, similar to how you did it for the candles. Position it at <strong class="source-inline">-2</strong> on both the <strong class="bold">X</strong> and <strong class="bold">Z</strong> axes. You may want to pick values that make sense in your scene. As long as there is ample room for Clara to reach this zone, things should be fine. Use <em class="italic">Figure 13.7</em> as a reference.</li>
<li>Create <a id="_idIndexMarker646"/>a <strong class="source-inline">Backpack.gd</strong> script for the root node and save it in the same folder. Activate the <strong class="bold">body_entered</strong> signal for the <strong class="bold">Area</strong> node, which will add a boilerplate function to the script. Then, change the script as follows:<p class="source-code">extends Spatial</p><p class="source-code">signal key_collected</p><p class="source-code">func _on_Area_body_entered(body):</p><p class="source-code">    if body.name == "Player":</p><p class="source-code">        $AudioStreamPlayer.play()</p><p class="source-code">        emit_signal("key_collected")</p></li>
<li>Swap the <strong class="bold">Backpack</strong> node in <strong class="source-inline">Level-01.tscn</strong> with an instance of <strong class="source-inline">Backpack.tscn</strong>.</li>
</ol>
<p>We are following the same principles we used in player detection for the candles. This time, instead of enabling lights, we are playing a short sound effect. We chose the <strong class="bold">AudioStreamPlayer</strong> node instead of its 3D version because we don’t want this sound effect to be affected by its distance to the camera. However, this is a perfect situation for you to swap and try both to see the difference. </p>
<p>The sound effect command is followed by the emission of a custom signal. In simple terms, we have converted the <strong class="bold">body_entered</strong> signal into a <strong class="bold">key_collected</strong> signal, which will be used in a more advanced scenario in the <em class="italic">Playing the door animation on a condition</em> section. </p>
<p>As mentioned in the third step, <em class="italic">Figure 13.7</em> shows the relative position of the <strong class="bold">Area</strong> node.</p>
<div>
<div class="IMG---Figure" id="_idContainer168">
<img alt="Figure 13.7 – The trigger area for the backpack is offset so Clara can reach it " height="832" src="image/Figure_13.7_B17473.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.7 – The trigger area for the backpack is offset so Clara can reach it</p>
<p>As they are now, the<a id="_idIndexMarker647"/> sconces and candles don’t play a sound effect when they are lit. This might be a short and nice exercise for which you can use the <strong class="source-inline">TorchWhoosh.ogg</strong> file. By default, the file’s <strong class="bold">Loop</strong> feature will be on. So, remember to press the <strong class="bold">Reimport</strong> button after you turn the loop off in the <strong class="bold">Import</strong> panel.</p>
<p>Last on the list of making some of the game objects interactive is the arched door. Our workflow will be similar but additionally accounts for that <strong class="source-inline">key_collected</strong> signal we defined in this section. </p>
<h2 id="_idParaDest-241"><a id="_idTextAnchor242"/>Interacting with the door</h2>
<p>You’ve been <a id="_idIndexMarker648"/>using the <strong class="bold">Area</strong> node quite liberally for a while. So, you must be used to it by now. In this section, you will use it one last time to complete the topic of interactivity. It will be for the door where you’ll also make use of that custom signal we have recently created.</p>
<p>Since some of the steps will be so similar, we will give shorter instructions for the sake of focusing on the unique parts, as follows:</p>
<ol>
<li value="1">Create a scene out of <strong class="source-inline">Doors_RoundArch.glb</strong> and save it in its original folder. </li>
<li>Attach the <strong class="source-inline">Doors_RoundArch.gd</strong> script from the <strong class="source-inline">Scripts</strong> folder to the root node.</li>
<li>Add two <strong class="bold">AudioStreamPlayer</strong> nodes under the root. Rename them as <strong class="source-inline">LockFiddling</strong> and <strong class="source-inline">OpenDoor</strong>. For these two nodes, use <strong class="source-inline">LockFiddling.wav</strong> and <strong class="source-inline">OpenDoor.wav</strong>, respectively, for their <strong class="bold">Stream</strong> property.</li>
<li>Add an <strong class="bold">Area</strong> node to the root with its dependencies and requirements, such as its collision, signal, and position. <em class="italic">Figure 13.8</em> should be helpful to show where we are placing <strong class="bold">Area</strong>.</li>
<li>Swap the existing door asset in the <strong class="source-inline">Level-01.tscn</strong> scene with this new scene. Also, assign the backpack asset to the <strong class="bold">Backpack</strong> property in <strong class="bold">Inspector</strong>.</li>
<li>Press <em class="italic">F5</em> and<a id="_idIndexMarker649"/> have Clara walk directly to the door.</li>
</ol>
<p>We’ll pay closer attention to the script this new scene is using after you see how things look in the editor with our most recent changes.</p>
<div>
<div class="IMG---Figure" id="_idContainer169">
<img alt="Figure 13.8 – This should be enough space in front of the door for Clara " height="770" src="image/Figure_13.8_B17473.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.8 – This should be enough space in front of the door for Clara</p>
<p>The scene layout is <a id="_idIndexMarker650"/>pretty similar to the other examples you have created, but instead of one, there are two audio stream nodes. Their names indicate the kind of functionality we are trying to achieve. This time around, Clara standing in front of the door won’t be enough by itself because we expect her to have found the key first.</p>
<p>Let’s analyze the <strong class="source-inline">Doors_RoundArch.gd</strong> script and see how we are working it out. You can refer to this code block at <a href="https://github.com/PacktPublishing/Game-Development-with-Blender-and-Godot/blob/main/Chapter%2013/Resources/Scripts/Doors_RoundArch.gd">https://github.com/PacktPublishing/Game-Development-with-Blender-and-Godot/blob/main/Chapter%2013/Resources/Scripts/Doors_RoundArch.gd</a>.</p>
<p>We have a flag variable to keep track of whether the key has been collected. The value of this variable becomes true only when the <strong class="source-inline">on_key_collected</strong> function is run. All of this relies on whether the backpack variable emits the appropriate event, which is set up in the <strong class="source-inline">_ready</strong> function. That’s why you are binding the backpack object to the door using the <strong class="bold">Inspector</strong> panel so that these two can communicate.</p>
<p>In the <strong class="bold">body_entered</strong> function, we check whether the intruding object is the player. This is where the flag variable comes into play. If the condition to open the door is satisfied, then we request the door opening sound. Otherwise, the game engine will play a sound file that indicates Clara fiddling with the lock.</p>
<p class="callout-heading">One type of solution may not always cut it</p>
<p class="callout">The solutions we show you throughout this book may not always be ideal if your level or game structure is different. Even the game we are building right now might benefit from a drastically and much more efficient architecture. The concept of architecture means the hierarchy of game objects you lay out in your scenes, how scripts share common variables, and ultimately how your systems talk to each other. There is no golden solution, rather best practices that come with more exposure to coding, perusing forums, and attending conferences where seasoned developers share their battle scars. </p>
<p>We suggest you try both cases where Clara walks directly to the door to hear the no-go sound. Then, have her pick up the key, which is already notifying the player with its pickup sound. Lastly, she can go in front of the door again to hear the door creaking. That door sure needs some greasing! </p>
<p>Even though the<a id="_idIndexMarker651"/> squeaking sound makes us think the door is opening with some protest, we don’t see it yet. So far, we’ve successfully mixed different disciplines we learned in the <em class="italic">Playing music and sound effects</em> and <em class="italic">Creating reaction spots</em> sections. It’s time we added the missing animation component to our workflow. </p>
<h1 id="_idParaDest-242"><a id="_idTextAnchor243"/>Building simple animations in Godot</h1>
<p>Back in <a href="B17473_05.xhtml#_idTextAnchor075"><em class="italic">Chapter 5</em></a>, <em class="italic">Setting Up Animation and Rigging</em>, we discussed variances between Blender and Godot Engine for animation needs. In summary, we claimed that you’d be better off with <a id="_idIndexMarker652"/>Blender for animating anything more complex<a id="_idIndexMarker653"/> than bouncing balls and simple rotating objects. To drive the point home, we <strong class="bold">rigged</strong> and animated a snake model. Similarly, we have been using a humanoid character, Clara, done in Blender as well.</p>
<p>However, there comes a time when it might be suitable to animate some of the models in the game engine. The topic we have at hand is the opening animation of the arched door Clara is standing in front of. If you prefer so, you could still open the model in Blender, implement the necessary steps that represent the opening of the door, and reimport your work in Godot. It’ll be no different than any other imported model that came with its animation. </p>
<p>For such a simple task, it’s a bit of an overkill, though. We’ll still use <strong class="bold">AnimationPlayer</strong>, but instead of triggering imported actions, we’ll create our own by manually placing keyframes in the timeline to match the creaking sound we play when the door opens.</p>
<h2 id="_idParaDest-243"><a id="_idTextAnchor244"/>Creating the door animation</h2>
<p>Before you start <a id="_idIndexMarker654"/>tackling any kind of manual animation in Godot, we suggest you take a closer look at the <strong class="bold">MeshInstance</strong> nodes the model uses. In our case, we are fortunate that there are only two. However, this might also be a problem too. </p>
<p>The model’s mesh shows metal rings for grabbing and pulling to open such a heavy door. Sadly, they are part of the same <strong class="bold">MeshInstance</strong> nodes. This means that they can’t be individually animated. To be able to do it, you’d have to go to Blender and separate those pieces and reexport the model. Then, you’ll have more <strong class="bold">MeshInstance</strong> nodes you can work with. Keep in mind, though, that any one of these options is fine but comes with a trade-off. More individual objects often signal freedom, but they also clutter the <strong class="bold">Scene</strong> panel if you don’t need them in the first place.</p>
<p>We’re not concerned about the rings on the door for the time being. Our goal here is to learn the basics of animation in Godot, which starts by opening the <strong class="source-inline">Doors_RoundArch.tscn</strong> scene. After that, you will perform the following steps: </p>
<ol>
<li value="1">Place an <strong class="bold">AnimationPlayer</strong> node under the root. This will automatically bring up the <strong class="bold">Animation</strong> panel at the bottom. If not, press the <strong class="bold">Animation</strong> button in the bottom menu.</li>
<li>Press the <strong class="bold">Animation</strong> button in this panel’s top area to bring a context menu and select <strong class="bold">New</strong> in the options. As a reminder, you used the <strong class="bold">Load</strong> option in that context menu in <a href="B17473_05.xhtml#_idTextAnchor075"><em class="italic">Chapter 5</em></a>, <em class="italic">Setting Up Animation and Rigging</em>.</li>
<li>Type <strong class="source-inline">Open</strong> and press the <strong class="bold">OK</strong> button to confirm.</li>
<li>Set the animation length to <strong class="source-inline">2.3</strong> by typing it in the area between the clock and loop icons on the right side of the panel.</li>
</ol>
<p>There are a lot of <a id="_idIndexMarker655"/>similar named buttons or options in the last set of steps. Thus, <em class="italic">Figure 13.9</em> will help you see what the editor will look like after your latest effort.</p>
<div>
<div class="IMG---Figure" id="_idContainer170">
<img alt="Figure 13.9 – Scaffolding for the open animation is done " height="518" src="image/Figure_13.9_B17473.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.9 – Scaffolding for the open animation is done</p>
<p>The animation track is empty, but the groundwork is done. We need to tell <strong class="bold">AnimationPlayer</strong> how a specific property of an object is changing over time. To that end, you should do as follows:</p>
<ol>
<li value="1">Select<a id="_idIndexMarker656"/> the <strong class="bold">Doors_RoundArch_L</strong> node in the <strong class="bold">Scene</strong> panel.</li>
<li>Expand the <strong class="bold">Transform</strong> section in the <strong class="bold">Inspector</strong> panel. Press the key icon for the <strong class="bold">Rotation Degrees</strong> property. A confirmation popup will appear.</li>
<li>Press the <strong class="bold">Create</strong> button to accept the proposed changes.</li>
<li>Click and drag your mouse over the numbers in the timeline of the <strong class="bold">Animation</strong> panel. We want to set the time to the end of the animation, which is <strong class="source-inline">2.3</strong>. Alternatively, you can type it in the area above the timeline to move the time marker.</li>
<li>Change the <strong class="bold">Y</strong> value in <strong class="bold">Rotation Degrees</strong> to <strong class="source-inline">-60</strong> and press the key icon again. There won’t be a confirmation popup this time.</li>
</ol>
<p>If you scrub the timeline back and forth as you did to move the time marker, you’ll now see the door pivot around its hinges. Speaking of which, this was covered in the <em class="italic">Setting origin points</em> section of <a href="B17473_06.xhtml#_idTextAnchor092"><em class="italic">Chapter 6</em></a>, <em class="italic">Exporting Blender Assets</em>.</p>
<p>Also, feel free to use the forward and backward play buttons to test the <strong class="bold">Open</strong> action. We’ll trigger it programmatically soon, but we should take care of the other portion of the door first as follows:</p>
<ol>
<li value="1">Select the <strong class="bold">Doors_RoundArch_R</strong> node in the <strong class="bold">Scene</strong> panel.</li>
<li>Reset the time marker to <strong class="source-inline">0</strong> in the <strong class="bold">Animation</strong> panel.</li>
<li>Follow <em class="italic">steps 2–5</em> from the <em class="italic">preceding set of instructions</em> with only one difference. Mark the <strong class="bold">Y</strong> value as positive <strong class="source-inline">60</strong> this time since the directions are reversed.</li>
</ol>
<p>After the two sets of changes, the editor will resemble what you see in <em class="italic">Figure 13.10</em>:</p>
<div>
<div class="IMG---Figure" id="_idContainer171">
<img alt="Figure 13.10 – Two sections of the door model have been keyframed, hence animated " height="518" src="image/Figure_13.10_B17473.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.10 – Two sections of the door model have been keyframed, hence animated</p>
<p>This will add the<a id="_idIndexMarker657"/> necessary keyframes to the timeline at points where changes occur. Since we want the door to open in one go without any slowing down or stuck effect, we are not introducing more keyframes other than those we are using. If you fancy more complex scenarios, you can position the time marker along the track to where you want to introduce more keyframes.</p>
<p>The <strong class="bold">Open</strong> animation you have just created should run on a condition. We’ve already discussed and even implemented the necessary condition to a certain extent. However, we didn’t really place the animation part in the door script. Let’s do that right away.</p>
<h2 id="_idParaDest-244"><a id="_idTextAnchor245"/>Playing the door animation on a condition</h2>
<p>Earlier <a id="_idIndexMarker658"/>in the <em class="italic">Interacting with the door</em> section, we attached a script to the door scene. This script had all of the necessary rules to check whether the player satisfied the conditions to open this door. We’ve also done a whole bunch of other things since then. So, let’s summarize what we’ve got so far. </p>
<p>The arched door scene has an <strong class="bold">Area</strong> node that reacts to the player’s presence. The door provides an auditory effect either way, but if Clara has already claimed the key, we expect the door to open with a creaking sound effect. Aptly named, we should trigger the <strong class="bold">Open</strong> animation. The change is simple enough, and it requires you to do as follows:</p>
<ol>
<li value="1">Open the <strong class="source-inline">Doors_RoundArch.gd</strong> script. </li>
<li>Replace <strong class="source-inline">print(“Open Sesame!”)</strong> with <strong class="source-inline">$AnimationPlayer.play(“Open”)</strong>.</li>
<li>Press <em class="italic">F5</em> to run the game. Have Clara first go for the key and then stand in front of the door.</li>
</ol>
<p>Voila! A big obstacle in the way of going upstairs has been eliminated. </p>
<p>Although it’s not<a id="_idIndexMarker659"/> possible to convey sound and visual effects via a still image, nevertheless, the following is the fruit of your hard work in <em class="italic">Figure 13.11</em>:</p>
<div>
<div class="IMG---Figure" id="_idContainer172">
<img alt="Figure 13.11 – Clara opened the door only after she collected the key from the backpack " height="686" src="image/Figure_13.11_B17473.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.11 – Clara opened the door only after she collected the key from the backpack</p>
<p>If you move Clara away and come back near the door, the animation and sound will trigger over and over. Coming up with the necessary conditions to execute an event is important. However, it might sometimes be equally important to stop it from happening again. You might have already noticed a similar, and maybe annoying, repeating behavior with the candles as well. Some effects should only fire once. </p>
<p>We still have quite a few things to do in this chapter. That’s why we will give you a quick guideline for eliminating this kind of repeating behavior. By nesting or combining <strong class="source-inline">if</strong> blocks, not only can you make sure the condition has been met just then, but also that it has been met before. For this, you might want to take advantage of simple Boolean variables. If the solution doesn’t come to you, you can always check the GitHub repository for the finished work.</p>
<p>What’s left for Clara to do at this point? Well, she’s currently standing there waiting to go upstairs. In this context, upstairs means loading another level, which we will discover in the <em class="italic">Loading another level</em> section<a id="_idIndexMarker660"/> later. For the time being, we still don’t know exactly when we are supposed to load the next level. Let’s see how we can determine that.</p>
<h2 id="_idParaDest-245"><a id="_idTextAnchor246"/>Waiting for the door animation to trigger an event</h2>
<p>It’s tempting to load the <a id="_idIndexMarker661"/>next level when we start opening the door. That being said, you’ve worked hard to keep track of what Clara has been doing as a precondition to start the door’s opening animation. If you switch to a new level right away, the animation will be for naught.</p>
<p>Instead, we should wait for the <strong class="bold">Open</strong> animation to finish. Only after that does it make more sense to switch things up. There are two common but equally awkward ways to do this. We’ll discuss both, so you get to know them before we dismiss them for the sake of a better alternative, and they are as follows:</p>
<ul>
<li><strong class="source-inline">yield</strong>: You can add <strong class="source-inline">yield($AnimationPlayer, “animation_finished”)</strong> after you trigger the <strong class="bold">Open</strong> animation. Whatever comes after the <strong class="source-inline">yield</strong> line, such as loading a new level, will have to wait for the animation to be finished. This is, in a way, like holding the line. Nothing else will happen unless, well, the program yields. This concept will change in Godot 4 in favor of the <strong class="bold">await</strong> command, which is a more permissive architectural choice than blocking things during the execution of your code.</li>
<li><strong class="bold">Timer</strong>: An alternative to <strong class="source-inline">yield</strong> where you are still letting things run is introducing a <strong class="bold">Timer</strong> node to your <strong class="bold">Scene</strong> tree. This is just like any other node you could add. Its <strong class="bold">Wait Time</strong> field in the <strong class="bold">Inspector</strong> panel could be set to when you want it to go off, in our case, <strong class="source-inline">2.3</strong> seconds, since that’s the length of our <strong class="bold">Open</strong> animation. Then, once the time is out, this node will fire a <strong class="bold">timeout</strong> signal for which you can write a listener. </li>
</ul>
<p>This method’s usage in our situation would be to start the timer as soon as you initiate the <strong class="bold">Open</strong> animation. Since the timer’s <strong class="bold">Wait Time</strong> would be synced with the action you are playing, it would look like loading a new level right after the action is finished.</p>
<p>We will not use either of these methods because why would you make your life more complicated when there is already a way to accomplish something with the toolset you are familiar with? Instead of switching gears, we’ll see how <strong class="bold">AnimationPlayer</strong> can still help us as follows:</p>
<ol>
<li value="1">Add the <a id="_idIndexMarker662"/>following function somewhere in the <strong class="source-inline">Doors_RoundArch.gd</strong> script:<p class="source-code">func load_level():</p><p class="source-code">    print("What level?") </p></li>
<li>Select the <strong class="bold">AnimationPlayer</strong> node and expand a context menu by pressing the <strong class="bold">Add Track</strong> button.</li>
<li>Choose <strong class="bold">Call Method Track</strong> among the options. You’ll be presented with a list of nodes to pick from. So, select the root node, <strong class="bold">Doors_RoundArch</strong>, on the upcoming screen.</li>
<li>Move the timeline marker to <strong class="source-inline">2.3</strong> seconds. Right-click where the blue timeline marker meets <strong class="bold">Functions</strong> for the <strong class="bold">Doors_RoundArch</strong> entry in the animation tracks. To get a better idea, refer to <em class="italic">Figure 13.12</em> to see the location we are talking about.</li>
<li>Search and choose <strong class="bold">load_level</strong> from the upcoming list. Press <em class="italic">F5</em> to run the game and follow the necessary steps as before to open the door.</li>
</ol>
<p>Everything will be exactly the same, except when the door animation is finished playing the <strong class="bold">Open</strong> sequence, the <strong class="source-inline">load_level</strong> function will run too. Since showing the door animation won’t make sense, we’d rather show you the editor’s status as mentioned in the fourth step:</p>
<div>
<div class="IMG---Figure" id="_idContainer173">
<img alt="Figure 13.12 – The load_level function will be triggered when the timeline arrives at the keyframe we set " height="561" src="image/Figure_13.12_B17473.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.12 – The load_level function will be triggered when the timeline arrives at the keyframe we set</p>
<p>The last frame<a id="_idIndexMarker663"/> of the <strong class="bold">Open</strong> action is where we are firing the function responsible for loading the next level. For now, it’s printing only a statement. We’ll be looking into swapping our current level with a new one later in the <em class="italic">Loading another level</em> section. </p>
<p>While we are still working on building simple animations, we could take care of the light sources that kind of look static.</p>
<h2 id="_idParaDest-246"><a id="_idTextAnchor247"/>Let there be flickering lights</h2>
<p>The work we did<a id="_idIndexMarker664"/> with the sconces and candles for introducing the <strong class="bold">Light</strong> nodes to our game in <a href="B17473_10.xhtml#_idTextAnchor165"><em class="italic">Chapter 10</em></a> , <em class="italic">Making Things Look Better with Lights and Shadows</em>, didn’t include animations. Nevertheless, we’ve been gradually improving everything else ever since. </p>
<p>Consequently, it would be nice to add some oomph to our light sources as follows:</p>
<ol>
<li value="1">Open <strong class="source-inline">Sconce.tscn</strong> and add an <strong class="bold">AnimationPlayer</strong> node to the root.</li>
<li>Introduce a new action. Choose <strong class="source-inline">Flicker</strong> for its name.</li>
<li>Set the length to <strong class="source-inline">2</strong> seconds. Also, turn on <strong class="bold">Animation Looping</strong> and <strong class="bold">Autoplay on Load</strong>. </li>
<li>Press the <strong class="bold">Add Track</strong> button and choose <strong class="bold">Property Track</strong>. Select <strong class="bold">OmniLight</strong> from the list that pops up. This will display another list to pick from.</li>
<li>Pick <strong class="bold">omni_range</strong>. Right-click the track in the <strong class="bold">Animation</strong> panel at <strong class="source-inline">0.0</strong>, <strong class="source-inline">0.4</strong>, <strong class="source-inline">1.3</strong>, and <strong class="source-inline">1.9</strong> seconds to open a context menu and select <strong class="bold">Insert Key</strong>.</li>
<li>Select each one of these keyframes and enter <strong class="source-inline">8</strong>, <strong class="source-inline">6</strong>, <strong class="source-inline">7</strong>, and <strong class="source-inline">5</strong>, respectively, in their <strong class="bold">Value</strong> property in the <strong class="bold">Inspector</strong> panel.</li>
<li>Press <em class="italic">F5</em> and have Clara light the sconces. They should start to flicker.</li>
</ol>
<p>Before we discuss a more refined and advanced version of what we have done, the following is what we have in the <strong class="bold">Animation</strong> panel:</p>
<div>
<div class="IMG---Figure" id="_idContainer174">
<img alt="Figure 13.13 – The Flicker action has been defined for OmniLight in sconces " height="516" src="image/Figure_13.13_B17473.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.13 – The Flicker action has been defined for OmniLight in sconces</p>
<p>Things now <a id="_idIndexMarker665"/>must look more organic when you light the first sconce. Then, perhaps after the second or the third one, the cozy flickering effect will look disturbingly repetitive, won’t it? If only there was a delay between different sconces so they wouldn’t all fire the <strong class="bold">Flicker</strong> action at the same time. </p>
<p>Achieving that will be relatively easy, but we suggest you first copy the <strong class="bold">AnimationPlayer</strong> node inside <strong class="source-inline">Sconce.tscn</strong> and paste it into both the <strong class="source-inline">Candles_01.tscn</strong> and <strong class="source-inline">Candles_02.tscn</strong> scenes. It’ll be easier to notice the effect of randomness when we use the animation everywhere.</p>
<p>When all of the light sources are lit, the whole level will look like it’s pulsing. Let’s see how we can break the unanimity and introduce some randomness to what we have, as follows:</p>
<ol>
<li value="1">Turn off <strong class="bold">AutoPlay on Load</strong> in <strong class="bold">AnimationPlayer</strong> for all of the three scenes you are using it for.</li>
<li>Open the <strong class="source-inline">LightSwitch.gd</strong> script and alter the <strong class="source-inline">_process</strong> function as follows:<p class="source-code">func _process(_delta: float) -&gt; void:</p><p class="source-code">    $OmniLight.visible = is_lit</p><p class="source-code">    if is_lit:</p><p class="source-code">        yield(get_tree().create_timer(randf()*2.0),</p><p class="source-code">              "timeout")</p><p class="source-code">        $AnimationPlayer.play("Flicker")</p></li>
</ol>
<p>All our light <a id="_idIndexMarker666"/>sources share this script. So, the changes will apply to all instances. While we were not in favor of using the <strong class="source-inline">yield</strong> command, it was relatively harmless to do so in this case. The last three lines tell the engine to create <strong class="bold">Timer</strong> on the fly and it randomly picks <strong class="bold">Wait Time</strong> for it between 0 and 2 seconds. When this timer goes off, the <strong class="bold">Flicker</strong> action plays. </p>
<p>Although you copied and pasted the same <strong class="bold">AnimationPlayer</strong> node that forced the light sources to share the same length and keyframes with exactly the same values, since the <strong class="bold">Flicker</strong> action for each light starts with a delay thanks to our latest change, it will induce enough visual differences. </p>
<p>Additionally, if you want to be really fancy, you could add another track such as <strong class="bold">light_energy</strong> to vary the brightness of the light sources.</p>
<h2 id="_idParaDest-247"><a id="_idTextAnchor248"/>Wrapping up</h2>
<p>Slowly but surely, you will have a more complete and believable feeling game by introducing small variations here and there, either by placing them in the world in a non-repeating pattern or by animating some of the game objects’ key features. </p>
<p>Sometimes the method to do this will be completely different. For example, the shader we are using to simulate the body of water doesn’t use a node such as <strong class="bold">AnimationPlayer</strong>, but we still have motion. That being said, it’s disillusive to have that boat look so still while the water is in motion. With the knowledge you have gained in this section, we suggest you turn the boat model into a scene and animate it to show an oscillating motion like a boat would do.</p>
<p>While you should feel confident that you know how to animate the basic properties of game objects, you have left out something important: Clara was supposed to head upstairs. Let’s help her do that.</p>
<h1 id="_idParaDest-248"><a id="_idTextAnchor249"/>Loading another level</h1>
<p>Before we started to<a id="_idIndexMarker667"/> animate the light sources in the <em class="italic">Let there be flickering lights</em> section, we were ready to move Clara upstairs. To that end, we used a nifty feature of the <strong class="bold">AnimationPlayer</strong> node to fire the <strong class="source-inline">load_level</strong> function, which printed a statement to the <strong class="bold">Output</strong> panel, a substitution for the real thing. In this section, we’ll investigate how to swap the existing level with another.</p>
<p>Let us remind you that our current level, <strong class="source-inline">Level-01.tscn</strong>, is instanced inside the <strong class="source-inline">Game.tscn</strong> scene, which is holding a <strong class="bold">Camera</strong> and an <strong class="bold">AudioStreamPlayer</strong> type of nodes. Godot has a built-in function, <strong class="source-inline">change_scene</strong>, that can change the current scene to another scene. However, this might be dangerous since it’ll replace the entire structure. In our case, this is not <strong class="source-inline">Level-01.tscn</strong> but everything in <strong class="source-inline">Game.tscn</strong> because that’s the main scene. </p>
<p>The solution we’ll offer is a process that’s operational at a higher level than <strong class="source-inline">Level-01.tscn</strong> itself. Ideally, your scenes should notify a higher authority of the changes they would like to introduce to the overall system. As it happens, this could very well be the <strong class="source-inline">Game.tscn</strong> scene via which not only can you use it to load a new level, but you could also be taking care of other stuff in your game such as keeping a log file, contacting a database to store important changes, or even reaching to a third-party service to show ads.</p>
<p>Now that we’ve established the importance of the <strong class="source-inline">Game.tscn</strong> taking over the task of loading a new level, how are we going to let it know when to do it? You have used signals before to facilitate a way between different game objects to know each other. This involved placing a reference of an object inside another by exposing a script variable to the <strong class="bold">Inspector</strong> panel. Although we could still try this, there is a better way.</p>
<h2 id="_idParaDest-249"><a id="_idTextAnchor250"/>Using an event bus</h2>
<p>When we expose <a id="_idIndexMarker668"/>variables to the <strong class="bold">Inspector</strong> panel so that scripts can recognize other game objects to be able to connect to their signals, we are coupling things, in a sense. When the number of objects and signals grows, this method will be difficult to maintain. There is an alternative, a concept called <strong class="bold">event bus</strong>, that might be helpful in an ever-growing list of dependencies. </p>
<p>We’ll revisit this concept in more detail in the <em class="italic">Further reading</em> section since the notion is part of a much bigger family of options available to you. For the time being, we’ll be satisfied with a practical application of it. This is what it entails:</p>
<ol>
<li value="1">Create an <strong class="source-inline">EventBus.gd</strong> script in the <strong class="source-inline">Scripts</strong> folder. Add the following line to it:<p class="source-code">signal change_level(level)</p></li>
<li>Open <strong class="bold">Project Settings</strong> and switch to the <strong class="bold">AutoLoad</strong> tab.</li>
<li>Use the button with the folder icon to find the <strong class="source-inline">EventBus.gd</strong> script.</li>
<li>Press the <strong class="bold">Add</strong> button to add this script to the list underneath. </li>
</ol>
<p><em class="italic">Figure 13.14</em> shows what the editor will look like.</p>
<div>
<div class="IMG---Figure" id="_idContainer175">
<img alt="Figure 13.14 – Our first singleton is set up and ready to use " height="459" src="image/Figure_13.14_B17473.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.14 – Our first singleton is set up and ready to use</p>
<p>We have just added a script to the <strong class="bold">AutoLoad</strong> list. A <strong class="bold">singleton</strong> is also another common name that is used in the industry for this concept. It<a id="_idIndexMarker669"/> means that there can only be one instance of the script. Besides the conventional description, in a Godot-specific context, as soon as you introduce it to the <strong class="bold">AutoLoad</strong> tab, there will always be one and only copy of this script; it will also be loaded for you and be made available to all of the constructs in your project.</p>
<p>So, who’s going to<a id="_idIndexMarker670"/> make use of this new script since it doesn’t seem to be attached to anything? After all, it just exists there, but since <strong class="bold">AutoLoad</strong> makes it accessible at all times, we can use it when the door animation is finished. </p>
<p>Let’s reassess our work from the <em class="italic">Waiting for the door animation to trigger an event</em> section. When we run and wait for the <strong class="bold">Open</strong> action in the <strong class="source-inline">Doors_RoundArch.tscn</strong> scene, <strong class="bold">AnimationPlayer</strong> eventually triggers the <strong class="source-inline">load_level</strong> function. There is currently a line of placeholder code in the body of that function in the form of printing a short statement: <strong class="bold">What level?</strong></p>
<p>That’s where we originally intended to load the next level. However, in light of the discussion we had in the opening lines of the <em class="italic">Loading another level</em> section, we now want to delegate this to the <strong class="source-inline">Game.tscn</strong> scene. To that end, we have created an <strong class="source-inline">EventBus.gd</strong> script that will communicate our request to the relevant recipient. Therefore, you will have to make the following change:</p>
<ol>
<li value="1">Open the <strong class="source-inline">Doors_RoundArch.tscn</strong> scene.</li>
<li>Update the <strong class="source-inline">load_level</strong> function as follows:<p class="source-code">func load_level():</p><p class="source-code">    EventBus.emit_signal("change_level", </p><p class="source-code">                         "Level-02.tscn")</p></li>
</ol>
<p>In our earlier efforts, game objects were directly using the <strong class="source-inline">emit_signal</strong> command. For example, the backpack was emitting a <strong class="source-inline">key_collected</strong> signal. Here, we generalize the idea. We no longer care about knowing which object is emitting. We use a high-level construct such as <strong class="source-inline">EventBus</strong> to do this for us. <em class="italic">Figure 13.15</em> shows a diagram of the new architecture we are proposing.</p>
<div>
<div class="IMG---Figure" id="_idContainer176">
<img alt="Figure 13.15 – We no longer need to couple structures anymore thanks to EventBus " height="590" src="image/Figure_13.15_B17473.jpg" width="962"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.15 – We no longer need to couple structures anymore thanks to EventBus</p>
<p>In the backpack <a id="_idIndexMarker671"/>example, the emitted signal was directly captured by the door so that the game could decide whether the player has completed a necessary condition. So, similar to how communication works in real life, there are two main parts to an event: an emitter and a receiver. We’ve made updates to the emitting situation. Let’s see what we can improve at the receiver’s end. </p>
<h2 id="_idParaDest-250"><a id="_idTextAnchor251"/>Listening to the EventBus signal</h2>
<p>Going back to the <a id="_idIndexMarker672"/>relationship the door and the backpack objects had, the backpack wasn’t aware of the door, but the door had a field we set in the <strong class="bold">Inspector</strong> field to reference the backpack. So, when the backpack emitted an event, the door was already keeping an eye on the backpack in a manner. </p>
<p>We are now trying to stay away from this type of architecture. Instead of directly using an object to emit an event, we tell the <strong class="source-inline">EventBus</strong> to do it for us. However, who is the door in our new example? In other words, who is listening to our event and how? The short answer is the <strong class="source-inline">Game.tscn</strong> scene.</p>
<p>Let’s implement<a id="_idIndexMarker673"/> some code first. Sometimes, it serves the purpose of showing instead of telling. Then, we’ll explain the rationale behind it. The following steps show what you should do after you open <strong class="source-inline">Game.tscn</strong>:</p>
<ol>
<li value="1">Create a new <strong class="bold">Spatial</strong> node under the root node. Rename it as <strong class="source-inline">Level</strong>.</li>
<li>Drag the <strong class="bold">Level-01</strong> node into this new <strong class="bold">Level</strong> node.</li>
<li>Make a new script as <strong class="source-inline">Game.gd</strong> and attach it to the root node. You can save it alongside the scene file. Then, you type in the following code:<p class="source-code">extends Node</p><p class="source-code">func _ready():</p><p class="source-code">    EventBus.connect("change_level", self, </p><p class="source-code">                     "change_level")</p><p class="source-code">func change_level(level:String):</p><p class="source-code">    var new_level = load("res://Scenes/" + </p><p class="source-code">                         level).instance()</p><p class="source-code">    </p><p class="source-code">    $Level.remove_child($Level.get_child(0))</p><p class="source-code">    $Level.add_child(new_level)</p></li>
</ol>
<p>Do you see that <strong class="source-inline">_ready</strong> function where we make use of the <strong class="source-inline">EventBus</strong> architecture? That’s the sweet part. This way, neither <strong class="source-inline">Game.tscn</strong> nor <strong class="source-inline">Doors_RoundArch.tscn</strong> need to know anything about each other. They share and deal with their responsibilities through <strong class="source-inline">EventBus</strong>.</p>
<p>Somewhere, at some point, a structure may fire a <strong class="source-inline">change_level</strong> signal. That is all we care for, and after we express our interest in it, we also prepare ourselves for what to do with it, in case the event comes to fruition. If that’s the case, we handle it inside the <strong class="source-inline">change_level</strong> function. </p>
<p class="callout-heading">Naming conventions</p>
<p class="callout">Some people keep their signal and event handler (function) names the same for the sake of treating the function as an extension of the signal. Godot’s signal bindings will add an <strong class="source-inline">_on_</strong> prefix, though. Keeping your own event handlers’ names the same as the signal name might help you distinguish them from Godot’s own bindings. However, you could always follow Godot’s naming convention in your bindings too. </p>
<p>Let’s now <a id="_idIndexMarker674"/>analyze what’s going on in the <strong class="source-inline">change_level</strong> event handler. When we fired the signal in the arched door scene, <strong class="source-inline">EventBus</strong> was passed a parameter in the form of a string: <strong class="source-inline">Level-02.tscn</strong>. The first line in the <strong class="source-inline">change_level</strong> function looks up and loads this string in the project’s <strong class="source-inline">Scenes</strong> folder. After finding a match and creating an instance of it, we want to store this new scene because we still have some work to do with the current scene. We should dispose of it before we add the new scene.</p>
<p>Since we’ve made some changes to the <strong class="bold">Scene</strong> tree, the current level, <strong class="bold">Level-01</strong>, is now inside a <strong class="bold">Level</strong> node that acts like a receptacle. Thus, we are instructing it to first find then remove its only child with <strong class="source-inline">$Level.remove_child($Level.get_child(0))</strong>. Only after that do we add the new level. </p>
<p>There is only one thing left for you to do. Press <em class="italic">F5</em> and have Clara go through all of the steps necessary to trigger the door’s opening. As soon as the door is open, the game will take you upstairs to a new level. You should expect to see what <em class="italic">Figure 13.16</em> shows.</p>
<div>
<div class="IMG---Figure" id="_idContainer177">
<img alt="Figure 13.16 – Welcome to our new level " height="710" src="image/Figure_13.16_B17473.jpg" width="1221"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.16 – Welcome to our new level</p>
<p>Congratulations! You<a id="_idIndexMarker675"/> have guided Clara to find her way in the darkness to collect a key that unlocked the door to this new level. She can continue her adventures from here. Is that a chest over there? There is a trapdoor right in front of it though, so watch out for that. Using the tools that we have shown you, you can go on and create new conditions and obstacles for the player to tackle. It’s up to your imagination.</p>
<p>We’ll now dedicate the rest of this chapter to discussing some of the choices you’ve made by following our guidelines and what you could also do differently.</p>
<h2 id="_idParaDest-251"><a id="_idTextAnchor252"/>Discussing some of the choices we can all make</h2>
<p>Our goal in this book is to teach you just the necessary parts of Godot Engine to build a simple point-and-click adventure game. It’s a simple statement, and yet it entails two separate efforts. On one hand, we should teach you as much as possible about the game engine without making it look like you are reading documentation.</p>
<p>On the other hand, the game we planned to build must be advanced enough but also simple to the point that you can easily follow its progress by reading as little as possible. Also, the fact is that there are only so many pages in a book. Thus, some of the choices we made during the production of the game were limited by these factors.</p>
<p>You might also face similar but different limitations and conundrums in your own projects. An early plan, even the worst one, might often be better than not having a plan at all. Even then, some cases might be really hard to nail and prepare beforehand, such as making your gameplay fun or achieving a decent user experience. </p>
<p>For example, the level switch is technically done. However, the change is happening so abruptly that the player might want to feel a moment of respite to collect their thoughts and savor their journey throughout the level. You can easily achieve this by extending the animation length and pushing the <strong class="source-inline">load_level</strong> function to later frames. It might look like there is a healthy pause between the door animation and the loading of the next level.</p>
<p>Even better, having the screen fade out before the switch actually happens might be a good idea. In fact, this might even be useful from a technical point of view. Our second level is so small, thus it’s easy to load it from the disk. However, in more ambitious projects, your levels might be chuck-full of game objects waiting to be loaded. </p>
<p>Furthermore, if your game loads previous sessions, you will have to reset your game objects’ states to their last known values. A generic loading screen in between switching levels or loading a previous game session might be a much better architecture. By following this practice, you’ll most likely find yourself abstracting more and more systems from more directly implemented systems. </p>
<p>Thus, this is perhaps the most valuable piece of advice we can offer you: if you are feeling stuck or unsure of how to tackle a topic, first focus on the special case and its implementation, then try to generalize it if possible and necessary.</p>
<h1 id="_idParaDest-252"><a id="_idTextAnchor253"/>Summary</h1>
<p>This was another chapter with a lot of moving parts that incorporated so many different aspects of the game engine. Let’s break down some of your activities that helped to add the finishing touches on so many things we carried over from the previous chapters.</p>
<p>First, you tackled background music and sound effects. You had already seen the usage of sound in <a href="B17473_08.xhtml#_idTextAnchor129"><em class="italic">Chapter 8</em></a>, <em class="italic">Adding Sound Assets</em>, which covered simple scenarios. In this chapter, you’ve learned how to use sound assets in a proper context. </p>
<p>Next, you reexamined a topic you saw in <a href="B17473_12.xhtml#_idTextAnchor206"><em class="italic">Chapter 12</em></a>, <em class="italic">Interacting with the World through Camera and Character Controllers</em> – player detection. This time, you used <strong class="bold">Area</strong> nodes as trigger zones since there would not be direct player interaction, such as mouse clicks and motion. Instead, Clara triggers predetermined events when she’s in the right zone.</p>
<p>You were also able to communicate information between game objects, essentially separate and distant systems, when an <strong class="bold">Area</strong> node was actively used. For instance, when the player reached the backpack, the condition to open the door was satisfied. The backpack let the door know what was going on through the use of a custom signal.</p>
<p>You symbolized the pickup of the key with a sound effect. Perhaps, a short piece of animation would have been used to display a 3D key moving up and fading out. Sometimes, an icon appears at the bottom of your monitor and finds its place in what’s called a <strong class="bold">quickbar</strong> in some games. Both approaches are fine, but we didn’t want to do either one of them.</p>
<p>Since this chapter was supposed to teach the creation of animations in Godot, we wanted to show off cases that were sufficiently complex, such as flickering light sources or opening two sections of an arched door, rather than simply moving a key up in the game world. We believe our effort has a more didactic value that you can transfer to other simple use cases.</p>
<p>After finishing simple animations, particularly the door’s opening action, it was time for Clara to go upstairs. To achieve that, you looked into swapping the current level with a new one. Although you could have achieved this by letting game objects pass information between each other, you were introduced to a more generic way of doing this via an <strong class="source-inline">EventBus</strong> architecture. </p>
<p>Even though there is still one more chapter, this is the moment you should pat yourself on the back. You have built a fully functional, however small, point-and-click adventure game. The following chapter will show you how to export your game. We’ll also discuss what other options you can consider on your game development journey.</p>
<h1 id="_idParaDest-253"><a id="_idTextAnchor254"/>Further reading</h1>
<p>As promised, we want to share with you a few words on the artistic aspects of sound management. Sometimes, a piece of music will have a high tempo. It means it’ll have a higher value of <strong class="bold">beats per minute</strong> (<strong class="bold">BPM</strong>). Depending on the game or the level you are building, you might want to select or create your music with the most appropriate BPM value to convey the best emotions.</p>
<p>There are also situations where gameplay will ask for a mix between a higher and lower tempo. This is common in role-playing or action games where players would like to feel they are under tension when they get involved in a sticky situation. For example, it would absolutely break the immersion if your burly, gun-toting player character is hiding behind a cover under heavy enemy fire when classic or chillout music is playing in the background. Likewise, when all is supposed to look calm between two action zones, if the game is playing a piece of high-tempo music, you will needlessly stress out and confuse your players.</p>
<p>Luckily, there are plenty of courses on this topic on Udemy. Giving a list of courses here would do injustice to all of the others we couldn’t mention since the list is long. We suggest you look it up on their website by using the <strong class="bold">music for games</strong> keywords.</p>
<p>Last in the sound management topic is the use of supplemental technologies. Either of the following two will help you create on-the-fly solutions to ever-changing circumstances if your game can’t make use of prearranged sound assets:</p>
<ul>
<li>FMOD</li>
<li>Wwise</li>
</ul>
<p>We also briefly mentioned artificial intelligence in this chapter. This is a vast topic, but a pertinent list of books would be the following:</p>
<ul>
<li><em class="italic">AI for Games</em> by Ian Millington</li>
<li><em class="italic">Behavioral Mathematics for Game AI</em> by Dave Mark</li>
<li>The <em class="italic">Game AI Pro 360</em> series by Steve Rabin: <ul><li><em class="italic">Game AI Pro 360: Guide to Character Behavior</em></li>
<li><em class="italic">Game AI Pro 360: Guide to Movement and Pathfinding</em></li>
<li><em class="italic">Game AI Pro 360: Guide to Architecture</em></li>
<li><em class="italic">Game AI Pro 360: Guide to Tactics and Strategy</em></li>
</ul></li>
</ul>
<p>The <strong class="source-inline">EventBus</strong> solution we presented in this chapter is frequently utilized in many programming circles. It’s sometimes called a <strong class="bold">Publish/Subscribe</strong> model or an <strong class="bold">Observer</strong> pattern. Referring to <em class="italic">Figure 13.15</em>, imagine you replaced <strong class="source-inline">EventBus</strong> with the post office. When a magazine you are subscribed to has its latest issue coming out, the publisher will notify the post office and you’ll be delivered your subscription.</p>
<p>Since the inception of computer science, and more particularly software programming, developers have noticed problems that exhibited a particular behavior or nature. Solutions to these common problems are called <strong class="bold">design patterns</strong>. There are a lot of resources out there that deal with this topic in the framework of classic software. However, game developers have also gotten some love in recent years. Regardless of domain specificity, a few examples are the following:</p>
<ul>
<li><a href="https://gameprogrammingpatterns.com">https://gameprogrammingpatterns.com</a></li>
<li><a href="https://www.udemy.com/course/design-patterns-for-game-programming/">https://www.udemy.com/course/design-patterns-for-game-programming/</a></li>
<li><em class="italic">Head First Design Patterns: Building Extensible and Maintainable Object-Oriented Software</em> by Eric Freeman</li>
<li><em class="italic">Learn Design Patterns with Game Programming</em> by Philippe-Henri Gosselin</li>
</ul>
</div>
</div>
</body></html>