# 前言

*《使用 Godot 4.0 创建多人游戏的必备指南*》是理解如何使用开源 Godot 引擎制作在线多人游戏的终极实践指南。在其第四版中，Godot 引擎引入了一个高级网络 API，使用户能够专注于创建有趣和有趣的机制，同时让引擎完成繁重的工作。

通过这本书，你将学习网络的基础知识，包括基本的 UDP、TCP 和 HTTP 协议。你将看到 Godot 引擎如何使用其 ENet 库实现将这些协议无缝集成到其游戏开发工作流程中。通过包括五个游戏在内的九个项目，其中一个是在线多人冒险游戏，你将学习到连接玩家在一起进行令人惊叹的共享体验所需的所有知识。

# 本书面向的对象

这本书是为中级 Godot 引擎用户所写，这些人已经知道 Godot 引擎的工作原理、其设计理念、编辑器、文档和其核心功能。这些用户已经使用 Godot 引擎制作了游戏。他们正在寻找能让他们的下一个项目脱颖而出的东西，而添加在线多人功能就是那件事。

# 本书涵盖的内容

*第一章*，*设置服务器*，解释了网络是什么以及 Godot 引擎如何通过其 ENet 库实现来实施网络功能。你将学习如何进行第一次握手，以有效地连接服务器和客户端机器。

*第二章*，*发送和接收数据*，讨论了网络的基础，即多台计算机之间交换数据。在本章中，你将了解到我们使用一种称为数据包的数据结构，并将数据序列化以在网络中重新创建游戏状态。为此，我们使用 UDP 协议。最后，我们将有一个登录屏幕，有效地从服务器检索数据。

*第三章*，*创建大厅以聚集玩家*，解释了 Godot 引擎如何通过提供**远程过程调用**（**RPCs**）来简化使用行业标准 UDP 协议进行序列化和交换数据的过程，使我们能够本质上对远程对象上的方法进行调用。到本章结束时，我们将登录屏幕扩展为大厅，向等式中添加另一个客户端，并将三台计算机连接在一起。

*第四章*，*创建在线聊天*，解释了有了 RPCs 的力量，我们现在可以轻松地远程更改对象的状态。在本章中，我们学习如何使用 RPCs 允许玩家在聊天中交换消息。我们讨论了如何使用 RPCs 和通道来防止网络瓶颈。有了这些，我们为实施实际游戏功能做好准备。到本章结束时，我们将拥有一个完全功能性的聊天。

*第五章*, *制作在线问答游戏*，解释了我们可以如何根据通用游戏状态同步玩家的游戏状态。我们将设置一个服务器，该服务器将对玩家交互做出反应，并将游戏状态从等待响应更改为处理比赛胜者、宣布胜者、开始新比赛以及达到可用问答问题的尽头，从而有效结束游戏。到本章结束时，我们将拥有一个多玩家在线问答游戏，多个玩家竞争回答最多正确的问题。

*第六章*, *构建在线国际象棋游戏*，继续实现基于回合制的多人在线游戏，而经典国际象棋是这方面的最佳选择。在本章中，我们将学习如何在保持玩家机器上大量处理的同时，最大限度地发挥我们的 RPC（远程过程调用）的作用。我们还将讨论 MultiplayerSynchronizer 节点，它允许我们轻松远程同步节点属性。我们还将了解什么是 Multiplayer Authority，它防止玩家干扰其他玩家的对象。到本章结束时，我们将拥有一个完全功能性的在线国际象棋游戏。

*第七章*, *开发在线乒乓球游戏*，开始了从回合制到动作的转变。动作游戏高度依赖玩家的反应时间，游戏世界应该快速更新其状态，以便玩家能够获得流畅的体验。在这里，我们将开发一个在线乒乓球游戏，并使用 MultiplayerSynchronizer 节点同步玩家的拍子和球。我们还将了解到某些功能应该使用不同的同步过程。我们将更深入地探讨 Multiplayer Authority 领域，以防止一个玩家的输入干扰另一个玩家的拍子移动。到本章结束时，我们将拥有一个可玩的多玩家在线乒乓球游戏。

*第八章*, *设计一个在线合作平台游戏*，是我们的小步前进停止的地方，我们开始为自定义游戏实现有趣的功能。我们将原型化一个物理益智平台游戏，玩家需要抓取并移动箱子来克服障碍并达到关卡目标。应用我们在前几章中学到的所有知识，我们将通过在对象位置上同步动画来扩展 MultiplayerSynchronizer 的使用。到本章结束时，我们将拥有一个物理益智合作平台游戏的可行原型。

*第九章*，*创建在线冒险原型*，如果我们说实话，这正是你在整本书中一直在寻找的东西。在这里，我们将运用所有技能来创建一个在线多人冒险游戏。玩家可以随时加入和离开，世界是持久的，保持玩家在任务中的进度。我们将讨论制作 MMORPG 游戏的基础知识，将玩家的任务进度存储和检索到数据库中，同步玩家的太空船和子弹，以及使他们的行为影响其他玩家的体验。到本章结束时，我们将拥有一个在线多人从上到下的太空射击冒险游戏的原型。

*第十章*，*调试和性能分析网络*，在实现我们的从上到下的太空射击原型在线多人游戏功能之后继续。我们现在需要为成千上万的玩家同时玩我们的游戏铺平道路。为此，我们将使用 Godot 引擎内置的调试和性能分析工具来评估我们游戏中可能需要改进的潜在区域。我们将重点关注网络性能分析器和监控调试工具，以评估和提出针对我们在原型中发现的瓶颈的潜在解决方案。到本章结束时，我们将拥有开发者可以拥有的最强大和必要的两种技能：调试和优化游戏的能力。

*第十一章*，*优化数据请求*，基于我们对现有工具的理解来评估我们需要发现潜在改进区域的信息；现在，是时候动手实践了。在本章中，我们将学习如何创建自定义监控器来收集关于特定游戏功能的数据，并决定最佳策略来优化它们。到本章结束时，我们将重构我们的从上到下的太空射击冒险游戏，减少我们产生的带宽和 RPC 数量，从而有效地减轻我们的网络消耗。我们还将实施几种减少网络负载的技术，使用网络性能分析器和自定义监控器评估每次改进，看看游戏变得有多好。

*第十二章*，*实现延迟补偿*，讨论了由于为了减少网络使用而进行的改进，我们的游戏可能在玩家的机器上不准确复制的这个问题。随着 RPC（远程过程调用）的减少和更稀疏的同步，游戏可能在玩家之间变得异步。再加上延迟和丢包，实际上会恶化玩家的体验。没有人喜欢游戏中出现延迟。在本章中，我们将学习如何使用 Tweens 来实现插值、预测和外推，以补偿所有这些问题。到本章结束时，我们将拥有一个带有一些虚假延迟和解决这个破坏性问题的解决方案的从上到下的太空射击原型版本。

*第十三章*，*通过缓存数据减少带宽*，处理了一个重要问题：在我们进行网络工程的过程中，我们了解到带宽是我们的核心资源，我们应该始终寻求优化其使用。在本章中，我们将学习如何使用 HTTP 下载一些数据并将其存储在玩家的机器上，以便在需要时可以重用。到本章结束时，我们将实现一个功能，允许玩家为他们的太空船使用自定义图片，并且这个新图片将被复制到所有其他玩家的游戏实例中。为了节省带宽，我们将使用用户数据文件夹实现缓存。

# 要充分利用本书

本书使用 Godot 引擎的 ENet 库实现来创建几个原型，探索这项技术的边界。为了充分利用本书，您需要了解 Godot 引擎的工作原理、如何使用 GDScript 编程、如何使用 Git 以及 UDP、TCP 和 HTTP 协议的基础知识。

| **本书涵盖的软件/硬件** | **操作系统要求** |
| --- | --- |
| Godot Engine 4.0 | Windows, macOS, 或 Linux |

在整本书中，我们使用书中 GitHub 仓库中可用的项目。本书专注于每个项目的网络方面，因此为了节省您的时间，我们提供了现成的项目供您使用，这样您就不必烦恼于实现与网络工程无关的其他功能。从这个意义上讲，建议您安装 Git，尽管这不是强制性的，因为您也可以通过提供的链接直接下载代码。

**如果您使用的是本书的电子版，我们建议您亲自输入代码或从书的 GitHub 仓库（下一节中有一个链接）获取代码。这样做将帮助您避免与代码的复制和粘贴相关的任何潜在错误。**

# 下载示例代码文件

您可以从 GitHub 下载本书的示例代码文件[`github.com/PacktPublishing/The-Essential-Guide-to-Creating-Multiplayer-Games-with-Godot-4.0/`](https://github.com/PacktPublishing/The-Essential-Guide-to-Creating-Multiplayer-Games-with-Godot-4.0/)。如果代码有更新，它将在 GitHub 仓库中更新。

我们还有其他来自我们丰富的图书和视频目录的代码包，可在[`github.com/PacktPublishing/`](https://github.com/PacktPublishing/)找到。查看它们吧！

# 使用的约定

本书使用了多种文本约定。

`文本中的代码`：表示文本中的代码单词、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟 URL、用户输入和 Twitter 昵称。以下是一个示例：“Godot 引擎的 Network API 核心功能之一是`ENetMultiplayerPeer`类。”

代码块设置如下：

```cpp
func _process(delta):
    server.poll()
    if server.is_connection_available():
        var peer = server.take_connection()
        var message = JSON.parse_string(peer.get_var())
        if "authenticate_credentials" in message:
            authenticate_player(peer, message)
        elif "get_authentication_token" in message:
            get_authentication_token(peer, message)
```

**粗体**：表示新术语、重要单词或您在屏幕上看到的单词。例如，菜单或对话框中的单词以**粗体**显示。以下是一个示例：“从那里，我们首先需要一个服务器。所以，选择一个实例并按下**ServerButton**。”

小贴士或重要注意事项

看起来像这样。

# 联系我们

我们始终欢迎读者的反馈。

**一般反馈**：如果您对本书的任何方面有疑问，请通过 mailto:customercare@packtpub.com 给我们发邮件，并在邮件主题中提及书名。

**勘误**：尽管我们已经尽一切努力确保内容的准确性，但错误仍然可能发生。如果您在这本书中发现了错误，我们将不胜感激，如果您能向我们报告这一点。请访问[www.packtpub.com/support/errata](http://www.packtpub.com/support/errata)并填写表格。

**盗版**：如果您在互联网上以任何形式遇到我们作品的非法副本，如果您能提供位置地址或网站名称，我们将不胜感激。请通过 mailto:copyright@packt.com 与我们联系，并提供材料的链接。

**如果您有兴趣成为作者**：如果您在某个领域有专业知识，并且您有兴趣撰写或为书籍做出贡献，请访问[authors.packtpub.com](http://authors.packtpub.com)。

# 分享您的想法

读完《Godot 4.0 创建多人游戏必备指南》后，我们很乐意听听您的想法！请[点击此处直接转到此书的 Amazon 评论页面](https://packt.link/r/1803232617)并分享您的反馈。

您的评论对我们和科技社区都很重要，并将帮助我们确保我们提供高质量的内容。

# 下载此书的免费 PDF 副本

感谢您购买此书！

您喜欢边走边读，但又无法携带您的印刷书籍到处走？

您的电子书购买是否与您选择的设备不兼容？

别担心，现在，随着每本 Packt 书籍，您都可以免费获得该书的 DRM 免费 PDF 版本。

在任何地方、任何设备上阅读。直接从您喜欢的技术书籍中搜索、复制和粘贴代码到您的应用程序中。

优惠远不止于此，您还可以获得独家折扣、时事通讯和每日免费内容的每日邮箱访问权限。

按照以下简单步骤获取优惠：

1.  扫描下面的二维码或访问以下链接

![](img/B18527_QR_Free_PDF.jpg)

[`packt.link/free-ebook/9781803232614`](https://packt.link/free-ebook/9781803232614)

1.  提交您的购买证明

1.  就这些！我们将直接将免费 PDF 和其他优惠发送到您的邮箱

# 第一部分：握手和网络

在本书的这一部分，我们迈出了网络领域的第一步。我们首先使用 Godot 引擎的高级 `EnetMultiplayerPeer` 类进行握手。我们还学习了如何使用 UDP 协议交换数据，最后学习了如何使用 **远程过程调用**（**RPC**）。

本部分包含以下章节：

+   *第一章*, *设置服务器*

+   *第二章*, *发送和接收数据*

+   *第三章**,* *创建大厅以聚集玩家*

+   *第四章**,* *创建在线聊天*
