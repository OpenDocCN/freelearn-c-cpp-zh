<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer016">
<h1 class="chapter-number" id="_idParaDest-15"><a id="_idTextAnchor014"/>1</h1>
<h1 id="_idParaDest-16"><a id="_idTextAnchor015"/>Getting Your C++ Project Lua-Ready</h1>
<p>Throughout the course of this book, you will learn how to integrate Lua into your C++ projects. Each chapter will be based on the knowledge learned from the previous chapters. This chapter teaches you how to prepare a C++ project in which to integrate Lua and introduces the tools used in this book so that you can understand the examples better. If you already know how to use some of the tools, please feel free to skip those sections. If not, feel free to do a deeper dive after going through <span class="No-Break">this chapter.</span></p>
<p>In this chapter, we will cover the <span class="No-Break">following topics:</span></p>
<ul>
<li>Compiling the Lua <span class="No-Break">source code</span></li>
<li>Building a C++ project with the <span class="No-Break">Lua library</span></li>
<li>Building a C++ project with the Lua <span class="No-Break">source code</span></li>
<li>Executing a simple <span class="No-Break">Lua script</span></li>
<li>Other <span class="No-Break">toolchain options</span></li>
</ul>
<h1 id="_idParaDest-17"><a id="_idTextAnchor016"/>Technical requirements</h1>
<p>To follow this chapter and this book, you will require <span class="No-Break">the following:</span></p>
<ul>
<li>A working C++ compiler, preferably the <strong class="bold">GNU C++ Compiler</strong> <span class="No-Break">or </span><span class="No-Break"><strong class="bold">Clang/LLVM</strong></span></li>
<li>A build automation tool, <span class="No-Break">preferably </span><span class="No-Break"><strong class="bold">Make</strong></span></li>
<li>The code editor of <span class="No-Break">your choice</span></li>
<li>The Lua <span class="No-Break">source code</span></li>
<li>The source code for this <span class="No-Break">chapter: </span><a href="https://github.com/PacktPublishing/Integrate-Lua-with-CPP/tree/main/Chapter01"><span class="No-Break">https://github.com/PacktPublishing/Integrate-Lua-with-CPP/tree/main/Chapter01</span></a></li>
</ul>
<p>You do not need prior Lua programming knowledge to understand this chapter. If you have any doubts relating to the Lua code examples in this chapter, that is fine; you can read it as C++ code, although there are syntax differences. You will learn Lua as you progress through this book. While it would be beneficial, you do not need to be a Lua expert if your focus is only on the <span class="No-Break">C++ side.</span></p>
<p>We decided to use open-source compilers and build tools to work with the code examples in this book because they are readily available to everyone and are also the tools of choice in most <span class="No-Break">large-scale projects.</span></p>
<p>If you are using a Linux or Mac development machine, the GNU C++ Compiler (or Clang/LLVM) and Make should already be installed. If not, please install the versions that are supported by your system. If you are a Windows user, you can go to the last section of this chapter first: <em class="italic">Other </em><span class="No-Break"><em class="italic">toolchain options</em></span><span class="No-Break">.</span></p>
<p>The build tool used is called Make. In real projects, you might use other build tools. But Make is a fundamental option with no other dependencies, and other build tools share similar ideas, which makes it suitable for the purpose of this book. If you wish to, you can adapt the examples in this book to another build tool of <span class="No-Break">your choice.</span></p>
<p>You can download the Lua source code from <a href="https://www.lua.org/download.xhtml">https://www.lua.org/download.xhtml</a>. You can select a specific version, but you will most likely wish to use the latest release. You can also clone the source code from Lua’s Git repository, here: <a href="https://www.github.com/lua/lua">https://www.github.com/lua/lua</a>. However, this is not officially recommended because Lua is stable and compact with <span class="No-Break">infrequent changes.</span></p>
<h1 id="_idParaDest-18"><a id="_idTextAnchor017"/>Compiling the Lua source code</h1>
<p>There are many ways to access the Lua language. If you are using Linux, you can install Lua for <a id="_idIndexMarker000"/>development with the distribution’s package manager. For Windows, you can also find prebuilt binaries. However, since our goal is to integrate Lua into your C++ project, instead of using it as a standalone interpreter, it’s best to build from the source code yourself. When studying Lua, this will help you learn more about Lua. For example, in a modern code editor,<em class="italic"> Visual Studio Code</em> included, you can easily check the declaration and implementation of Lua <span class="No-Break">library functions.</span></p>
<p>In this section, we will focus on compiling Lua from its source code. Unarchive the downloaded Lua source code archive. Most compression tools support this, and the Lua download site also gives instructions. When you have done this, you will see a simple <span class="No-Break">folder structure:</span></p>
<pre class="source-code">
lua-5.4.6 % ls
Makefile README doc src</pre>
<p>We will learn <a id="_idIndexMarker001"/>what the preceding code block does in the <span class="No-Break">next section.</span></p>
<p>The Lua source code package has a typical <strong class="bold">POSIX</strong> (think Linux and Unix) <span class="No-Break">folder structure.</span></p>
<ul>
<li><strong class="source-inline">Makefile</strong> is the root <strong class="source-inline">Makefile</strong> for <span class="No-Break">the package</span></li>
<li><strong class="source-inline">src</strong> subfolder contains the <span class="No-Break">source code</span></li>
<li><strong class="source-inline">doc</strong> subfolder contains <span class="No-Break">the documentation</span></li>
</ul>
<h2 id="_idParaDest-19"><a id="_idTextAnchor018"/>Introducing shell</h2>
<p>In this section, we will <a id="_idIndexMarker002"/>learn <a id="_idIndexMarker003"/>what a <strong class="bold">shell</strong> does. Throughout this book, examples are given and tested using <strong class="source-inline">zsh</strong> (<strong class="source-inline">Z</strong> <strong class="source-inline">shell</strong>) on a POSIX machine. Another popular shell is <strong class="source-inline">bash</strong>, using which you can also run the examples in this <a id="_idIndexMarker004"/>book directly. Even if you use an <strong class="bold">Integrated Development Environment</strong> (<strong class="bold">IDE</strong>) and adapt the examples manually to your IDE, understanding the basics of shell commands can help you understand the examples better. All IDEs internally use various command line programs to do their work, which is similar to what we will be doing in <span class="No-Break">a shell.</span></p>
<p>In very basic terms, a shell provides a command-line interface to the system. When you access a shell interactively, it could also be said that you are accessing a terminal. The words shell and terminal are sometimes used interchangeably, although they are technically different things. Thankfully, we do not need to worry about the terminology differences here. All systems with graphic user interfaces will also provide an application in which to <a id="_idIndexMarker005"/>start a shell. Often, those <a id="_idIndexMarker006"/>applications are called a <strong class="bold">terminal</strong> or <span class="No-Break">a </span><span class="No-Break"><strong class="bold">console</strong></span><span class="No-Break">.</span></p>
<p>You can start a shell and try the following commands. To find out which shell you are using, <span class="No-Break">use this:</span></p>
<pre class="source-code">
% echo $SHELL
/bin/zsh</pre>
<p>The output <strong class="source-inline">/bin/zsh</strong> indicates that the shell in use is the <span class="No-Break"><strong class="source-inline">Z</strong></span><span class="No-Break"> shell.</span></p>
<p>To go to a directory, use the <span class="No-Break">following command:</span></p>
<pre class="source-code">
cd ~/Downloads/lua-5.4.6
lua-5.4.6 %</pre>
<p><strong class="source-inline">cd</strong> is the command <a id="_idIndexMarker007"/>to change the current working directory. This goes <a id="_idIndexMarker008"/>into the Lua source <span class="No-Break">code folder.</span></p>
<p>And, as you have seen previously, <strong class="source-inline">ls</strong> is the command to list the contents of <span class="No-Break">a directory:</span></p>
<pre class="source-code">
lua-5.4.6 % ls
Makefile README doc src</pre>
<p>Another thing of importance is the <strong class="source-inline">%</strong> sign. It signifies a shell prompt, and different shells or user roles may see a different sign. The part before <strong class="source-inline">%</strong> is the current working directory. The part after <strong class="source-inline">%</strong> is what command you would type into <span class="No-Break">the terminal.</span></p>
<p>This section is only meant to be a brief explanation. If you encounter a shell command that you do not know, check it <span class="No-Break">out online.</span></p>
<h2 id="_idParaDest-20"><a id="_idTextAnchor019"/>Building Lua</h2>
<p>In a shell terminal, go to the unarchived Lua source code folder and execute <strong class="source-inline">make all test</strong>. If your toolchain <a id="_idIndexMarker009"/>is found to be working, you will have compiled the Lua library and command-line interpreter. Now, let’s inspect the files <span class="No-Break">of interest:</span></p>
<pre class="source-code">
lua-5.4.6 % ls src/*.a src/lua
src/liblua.a src/lua</pre>
<p><strong class="source-inline">liblua.a</strong> is the Lua library you can link with. <strong class="source-inline">lua</strong> is the Lua <span class="No-Break">command-line interpreter.</span></p>
<p>Let’s now try the interpreter to see if we can run <span class="No-Break">it successfully:</span></p>
<pre class="source-code">
lua-5.4.6 % src/lua
Lua 5.4.6 Copyright (C) 1994-2022 Lua.org, PUC-Rio
&gt; 1+1
2
&gt; os.exit()</pre>
<p>In the terminal, execute <strong class="source-inline">src/lua</strong> to start the interactive Lua interpreter. First, enter <strong class="source-inline">1+1</strong>: Lua will print <a id="_idIndexMarker010"/>back a result of <strong class="source-inline">2</strong>. Then enter <strong class="source-inline">os.exit()</strong> to exit the <span class="No-Break">Lua interpreter.</span></p>
<p>You have now successfully compiled the Lua library from its source code. Next, we will see how to use it in <span class="No-Break">your project.</span></p>
<h1 id="_idParaDest-21"><a id="_idTextAnchor020"/>Building a C++ project with the Lua library</h1>
<p>Building your C++ project with the Lua library has the benefit of not having to include the 100+ Lua <a id="_idIndexMarker011"/>source files in your project and your <a id="_idIndexMarker012"/>source control system. However, it has some disadvantages as well. For example, if your project needs to support multiple platforms, you will need to maintain multiple pre-compiled libraries. In such a case, building from the Lua source code might <span class="No-Break">be easier.</span></p>
<h2 id="_idParaDest-22"><a id="_idTextAnchor021"/>Creating a project to work with the Lua library</h2>
<p>In the previous section, we built the Lua library from the source code. Now, let’s extract it <a id="_idIndexMarker013"/>to use within <span class="No-Break">our project.</span></p>
<p>Remember the <strong class="source-inline">Makefile</strong> in the root of the source code folder? Open it and you will find the two lines <span class="No-Break">shown here:</span></p>
<pre class="source-code">
TO_INC= lua.h luaconf.h lualib.h lauxlib.h lua.hpp
TO_LIB= liblua.a</pre>
<p>These are the header files and the static library <span class="No-Break">you need.</span></p>
<p>Create a folder for your project. Within it, create an empty source file named <strong class="source-inline">main.cpp</strong>, an empty <strong class="source-inline">Makefile</strong>, and two empty folders named <strong class="source-inline">include</strong> and <strong class="source-inline">lib</strong>. Copy the header files into the <strong class="source-inline">include</strong> folder and the library file into the <strong class="source-inline">lib</strong> folder. The project folder should look <span class="No-Break">like this:</span></p>
<pre class="source-code">
project-with-lua-lib % tree
.
├── Makefile
├── lua
│   ├── include
│   │   ├── lauxlib.h
│   │   ├── lua.h
│   │   ├── lua.hpp
│   │   ├── luaconf.h
│   │   └── lualib.h
│   └── lib
│       └── liblua.a
└── main.cpp</pre>
<p>If you are <a id="_idIndexMarker014"/>using Linux, <strong class="source-inline">tree</strong> is a shell program used to print a folder’s hierarchy. If you don’t have <strong class="source-inline">tree</strong> installed, no need to worry. You can also examine the folder structure inside your <span class="No-Break">preferred IDE.</span></p>
<h2 id="_idParaDest-23"><a id="_idTextAnchor022"/>Writing the C++ code</h2>
<p>We will write <a id="_idIndexMarker015"/>a simple C++ program to test whether we can link to the Lua library. In C++, you only need to include one header file for <span class="No-Break">Lua: </span><span class="No-Break"><strong class="source-inline">lua.hpp</strong></span><span class="No-Break">.</span></p>
<p>Write <strong class="source-inline">main.cpp</strong> as <span class="No-Break">shown here:</span></p>
<pre class="source-code">
#include &lt;iostream&gt;
#include &lt;lua.hpp&gt;
int main()
{
    lua_State *L = luaL_newstate();
    std::cout &lt;&lt; "Lua version number is "
              &lt;&lt; lua_version(L)
              &lt;&lt; std::endl;
    lua_close(L);
    return 0;
}</pre>
<p>The preceding <a id="_idIndexMarker016"/>source code opens Lua, prints its build number, and then <span class="No-Break">closes Lua.</span></p>
<h2 id="_idParaDest-24"><a id="_idTextAnchor023"/>Writing the Makefile</h2>
<p>As part of the first project, writing the <strong class="source-inline">Makefile</strong> is very simple. Let’s use this as a chance to <a id="_idIndexMarker017"/>learn some more details about the <strong class="source-inline">Makefile</strong>, if you haven’t <a id="_idIndexMarker018"/>got a good understanding already. For more information, you can check out the official website <span class="No-Break">at </span><a href="https://www.gnu.org/software/make/"><span class="No-Break">https://www.gnu.org/software/make/</span></a><span class="No-Break">.</span></p>
<p>Write the <strong class="source-inline">Makefile</strong><span class="Strong"> </span>as shown in the <span class="No-Break">following code:</span></p>
<pre class="source-code">
project-with-lua-lib: main.cpp
    g++ -o project-with-lua-lib main.cpp -Ilua/include \
        -Llua/lib -llua</pre>
<p>This is a very basic <strong class="source-inline">Makefile</strong>. In a real project, you would need a more complex <strong class="source-inline">Makefile</strong> to make it more flexible. You will see more flexible examples later in this chapter. Here, the focus is <a id="_idIndexMarker019"/>simplicity for the first encounter. This initial <strong class="source-inline">Makefile</strong> has the <span class="No-Break">following elements:</span></p>
<ul>
<li><strong class="source-inline">project-with-lua-lib</strong> is a <strong class="source-inline">Makefile</strong> target. You can have as many targets as needed in a <strong class="source-inline">Makefile</strong>. When you invoke <strong class="source-inline">make</strong> without an explicit target, it will execute the first one defined in <span class="No-Break">the file.</span></li>
<li><strong class="source-inline">main.cpp</strong> is the target’s dependency. You can depend on another target or a file. You can have as many dependencies <span class="No-Break">as needed.</span></li>
<li>The target invokes a <strong class="source-inline">g++</strong> command to compile <strong class="source-inline">main.cpp</strong> and link it with the Lua library. You will <a id="_idIndexMarker020"/>need to use a tab instead of spaces before the <span class="No-Break">target commands.</span></li>
<li><strong class="source-inline">-o project-with-lua-lib</strong> specifies the name of the compiled executable file. You can change <strong class="source-inline">project-with-lua-lib</strong> to any name <span class="No-Break">you want.</span></li>
<li><strong class="source-inline">-Ilua/include</strong> adds <strong class="source-inline">lua/include</strong> to the search path for <span class="No-Break">header files.</span></li>
<li><strong class="source-inline">-Llua/lib</strong> adds <strong class="source-inline">lua/lib</strong> to the linker search path <span class="No-Break">for libraries.</span></li>
<li><strong class="source-inline">-llua</strong> tells the linker to link with the static Lua <span class="No-Break">library: </span><span class="No-Break"><strong class="source-inline">liblua.a</strong></span><span class="No-Break">.</span></li>
</ul>
<h2 id="_idParaDest-25"><a id="_idTextAnchor024"/>Testing the project</h2>
<p>In a terminal, execute <strong class="source-inline">make</strong> to build the project. Then execute <strong class="source-inline">./project-with-lua-lib</strong> to run <a id="_idIndexMarker021"/>the <span class="No-Break">compiled project:</span></p>
<pre class="source-code">
project-with-lua-lib % make
project-with-lua-lib % ./project-with-lua-lib
Lua version number is 504</pre>
<p>As shown in the preceding code, the C++ program will execute and print: <strong class="source-inline">Lua version number </strong><span class="No-Break"><strong class="source-inline">is 504</strong></span><span class="No-Break">.</span></p>
<p>Congratulations! You have finished your first C++ project with Lua by linking to the pre-compiled Lua library. In the next section, we will explore how to use Lua source code directly to avoid the disadvantages stated at the beginning of <span class="No-Break">this section.</span></p>
<h1 id="_idParaDest-26"><a id="_idTextAnchor025"/>Building a C++ project with the Lua source code</h1>
<p>Building your <a id="_idIndexMarker022"/>C++ project with the Lua source <a id="_idIndexMarker023"/>code has the benefit that it is always compiled as part of your project, and there is no possibility of any surprises arising from <span class="No-Break">compiler incompatibilities.</span></p>
<p>The major difference from linking with a pre-compiled Lua library is that we will now compile the Lua library from its source code first. It is also better to use the source code package <a id="_idIndexMarker024"/>without modifying it or copying only <a id="_idIndexMarker025"/>a few selected files into a new folder hierarchy. This will help in the future if you need to use a newer Lua version. In such a case, all you will need to do is to replace the Lua source code folder with the <span class="No-Break">new version.</span></p>
<h2 id="_idParaDest-27"><a id="_idTextAnchor026"/>Creating a project to work with the Lua source code</h2>
<p>To create <a id="_idIndexMarker026"/>a project using the Lua source code, we need to go back to the Lua source <span class="No-Break">code package:</span></p>
<pre class="source-code">
lua-5.4.6 % ls
Makefile README doc src</pre>
<p>You will need the <span class="No-Break"><strong class="source-inline">src</strong></span><span class="No-Break"> subfolder.</span></p>
<p>Create a folder for a new project. Within it, create an empty <strong class="source-inline">main.cpp</strong> and an empty <strong class="source-inline">Makefile</strong>, and copy the <strong class="source-inline">src</strong> subfolder shown in the preceding shell output as the <strong class="source-inline">lua</strong> subfolder in your project folder. The project structure should look <span class="No-Break">as follows:</span></p>
<pre class="source-code">
project-with-lua-src % tree
.
├── Makefile
├── lua
│   ├── Makefile
│   ├── lapi.c
│   ├── ...
│   ├── lzio.c
│   └── lzio.h
└── main.cpp</pre>
<h2 id="_idParaDest-28"><a id="_idTextAnchor027"/>Writing the C++ code</h2>
<p>You can <a id="_idIndexMarker027"/>write the C++ code in exactly the same way that you did when building with the <span class="No-Break">Lua library.</span></p>
<h2 id="_idParaDest-29"><a id="_idTextAnchor028"/>Writing the Makefile</h2>
<p>Let’s go <a id="_idIndexMarker028"/>one step further compared to the last project, and write two targets for the <strong class="source-inline">Makefile</strong> <span class="No-Break">as follows:</span></p>
<pre class="source-code">
pr<a id="_idTextAnchor029"/>oject-with-lua-src: main.cpp
    cd lua &amp;&amp; make
    g++ -o project-with-lua-src main.cpp -Ilua -Llua -llua
clean:
    rm -f project-with-lua-src
    cd lua &amp;&amp; make clean</pre>
<p>This <strong class="source-inline">Makefile</strong> first goes into the <strong class="source-inline">lua</strong> subfolder and then it builds the Lua library. After this, it compiles the C++ code and links it with the Lua library. The <strong class="source-inline">lua</strong> subfolder is a copy of the <strong class="source-inline">src</strong> folder from the Lua source code archive. If you accidentally copied the whole archive there, you may see some <span class="No-Break">compile errors.</span></p>
<p>The <strong class="source-inline">Makefile</strong> also includes a <strong class="source-inline">clean</strong> target. This will delete compiled files. Usually, all build systems will have a <strong class="source-inline">clean</strong> <span class="No-Break">target implemented.</span></p>
<h2 id="_idParaDest-30"><a id="_idTextAnchor030"/>Testing the project</h2>
<p>In a <a id="_idIndexMarker029"/>terminal, enter <strong class="source-inline">make</strong> to build the project. Then enter <strong class="source-inline">./project-with-lua-src</strong> to execute the <span class="No-Break">compiled project:</span></p>
<pre class="source-code">
project-with-lua-src % make
project-with-lua-src % ./project-with-lua-arc
Lua version number is 504</pre>
<p>The C++ program will execute and print : <strong class="source-inline">Lua version number </strong><span class="No-Break"><strong class="source-inline">is 504</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-31"><a id="_idTextAnchor031"/>Testing the clean target</h2>
<p>Since we <a id="_idIndexMarker030"/>have implemented a <strong class="source-inline">clean</strong> target, let’s also <span class="No-Break">test that:</span></p>
<pre class="source-code">
project-with-lua-src % make clean
rm -f project-with-lua-src
cd lua &amp;&amp; make clean
rm -f liblua.a lua luac lapi.o lcode.o lctype.o ldebug.o
ldo.o ldump.o lfunc.o lgc.o llex.o lmem.o lobject.o
lopcodes.o lparser.o lstate.o lstring.o ltable.o ltm.o
lundump.o lvm.o lzio.o lauxlib.o lbaselib.o lcorolib.o
ldblib.o liolib.o lmathlib.o loadlib.o loslib.o lstrlib.o
ltablib.o lutf8lib.o linit.o lua.o luac.o</pre>
<p>This cleans the working folder by deleting compiler-generated files. In a production-ready project, you would do more by first outputting all intermediate files to a separate folder during building, most likely called <strong class="source-inline">build</strong> or <strong class="source-inline">output</strong>, and exclude that folder from the source <span class="No-Break">control system.</span></p>
<p>So far, we have learned two ways to integrate Lua with C++ projects. Next, let’s learn how to execute real Lua scripts <span class="No-Break">from C++.</span></p>
<h1 id="_idParaDest-32"><a id="_idTextAnchor032"/>Executing a simple Lua script</h1>
<p>To execute a <a id="_idIndexMarker031"/>Lua script, you can choose to use either the Lua library or the Lua source code. For production projects, I personally recommend using the source code. For learning purposes, either way is fine. We will use Lua source code in the rest of <span class="No-Break">this book.</span></p>
<p class="callout-heading">Can you notice this?</p>
<p class="callout">Even if you choose to use the Lua source code, in the <strong class="source-inline">Makefile</strong>, you are first building the Lua source code into the Lua library and then make your project link to the library. Compared to using the Lua library directly, using the Lua source code is just doing one more step in your project. You can focus more on the similarities rather than <span class="No-Break">the differences.</span></p>
<p>Now, let’s look <a id="_idIndexMarker032"/>at a more general <span class="No-Break">project structure.</span></p>
<h2 id="_idParaDest-33"><a id="_idTextAnchor033"/>Creating a project</h2>
<p>As said, there will be more complex projects in the following chapters. For now, we will explore a more <a id="_idIndexMarker033"/>general project structure. We will build and link to Lua in a shared location instead of making a copy for <span class="No-Break">each project.</span></p>
<p>The following is the structure of the project as shown within its <span class="No-Break">parent folders:</span></p>
<pre class="source-code">
% tree
.
├── Chapter01
│   ├── execute-lua-script
│   │   ├── Makefile
│   │   ├── main.cpp
│   │   └── script.lua
│   ├── project-with-lua-lib
│   └── project-with-lua-src
└── lua
     ├── Makefile
     ├── README
     ├── doc
     └── src</pre>
<p>The two relevant folders for this project are <span class="No-Break">as follows:</span></p>
<ul>
<li>The <strong class="source-inline">execute-lua-script</strong> folder contains the main project, inside which there is a C++ source file, a <strong class="source-inline">Makefile</strong>, and a Lua <span class="No-Break">script file</span></li>
<li>The <strong class="source-inline">lua</strong> folder contains the Lua source code package, which is unarchived and <span class="No-Break">used as-is</span></li>
</ul>
<p>The other folders <a id="_idIndexMarker034"/>shown indicate how the source code of this book is organized – first into chapters and then into projects. Following the exact structure is optional, as long as you can make <span class="No-Break">it work.</span></p>
<h2 id="_idParaDest-34"><a id="_idTextAnchor034"/>Writing the Makefile</h2>
<p>We’ve seen <a id="_idIndexMarker035"/>two simple <strong class="source-inline">Makefiles</strong> in the previous two projects. Let’s write a more flexible <strong class="source-inline">Makefile</strong> <span class="No-Break">as follows:</span></p>
<pre class="source-code">
LUA_PATH = ../../lua
CXX = g++
CXXFLAGS = -Wall -Werror
CPPFLAGS = -I ${LUA_PATH}/src
LDFLAGS = -L ${LUA_PATH}/src
EXECUTABLE = executable
all: lua project
lua:
    @cd  ${LUA_PATH} &amp;&amp; make
project: main.cpp
    $(CXX) $(CXXFLAGS) $(CPPFLAGS) $(LDFLAGS) \
        -o $(EXECUTABLE) main.cpp -llua
clean:
    rm -f $(EXECUTABLE)</pre>
<p>This <strong class="source-inline">Makefile</strong> is more flexible and should be good enough to use as a template for study purposes. It differs <a id="_idIndexMarker036"/>from the previous ones in the <span class="No-Break">following aspects:</span></p>
<ul>
<li>It defines a few variables at the beginning of the file. The benefit is that in a real-life project, you would need to compile multiple files. This way, you do not need to repeat yourself in each target. This is also clearer <span class="No-Break">to read.</span></li>
<li>The default target, conventionally named <strong class="source-inline">all</strong>, depends on two <span class="No-Break">other targets.</span></li>
<li>In the <strong class="source-inline">lua</strong> target, there is an <strong class="source-inline">@</strong> sign before the command. This will stop printing out the command content in the terminal when <span class="No-Break"><strong class="source-inline">make</strong></span><span class="No-Break"> executes.</span></li>
<li><strong class="source-inline">LUA_PATH</strong> is the path to the Lua source code relative to the folder where this <span class="No-Break"><strong class="source-inline">Makefile</strong></span><span class="No-Break"> resides.</span></li>
<li><strong class="source-inline">CXX</strong> is the conventional variable name to define the C++ compiler program. Use <strong class="source-inline">CC</strong> for the <span class="No-Break">C compiler.</span></li>
<li><strong class="source-inline">CXXFLAGS</strong> defines the parameters provided to the C++ compiler. Use <strong class="source-inline">CFLAGS</strong> for the <span class="No-Break">C compiler.</span></li>
<li><strong class="source-inline">CPPFLAGS</strong> defines the parameters provided to the C preprocessor, and C++ shares the <span class="No-Break">same preprocessor.</span></li>
<li><strong class="source-inline">LDFLAGS</strong> defines the parameters provided to the linker. In some development systems, you may need to put <strong class="source-inline">LDFLAGS</strong> after <strong class="source-inline">-</strong><span class="No-Break"><strong class="source-inline">o $(EXECUTABLE)</strong></span><span class="No-Break">.</span></li>
</ul>
<p>With the <strong class="source-inline">Makefile</strong> ready, let’s write the <span class="No-Break">C++ code.</span></p>
<h2 id="_idParaDest-35"><a id="_idTextAnchor035"/>Writing the C++ code</h2>
<p>To execute <a id="_idIndexMarker037"/>a Lua script, we need some real actions, which we can get by calling some Lua library functions. Write <strong class="source-inline">main.cpp</strong> <span class="No-Break">as follows:</span></p>
<pre class="source-code">
#include &lt;iostream&gt;
#include &lt;lua.hpp&gt;
int main()
{
    lua_State *L = luaL_newstate();
    luaL_openlibs(L);
    if (luaL_loadfile(L, "script.lua") ||
        lua_pcall(L, 0, 0, 0))
    {
        std::cout &lt;&lt; "Error: "
                  &lt;&lt; lua_tostring(L, -1)
                  &lt;&lt; std::endl;
        lua_pop(L, 1);
    }
    lua_close(L);
    return 0;
}</pre>
<p>The code <a id="_idIndexMarker038"/>is doing the <span class="No-Break">following things:</span></p>
<ol>
<li>Opening Lua and creating a Lua state <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">luaL_newstate</strong></span><span class="No-Break">.</span></li>
<li>Opening Lua standard libs <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">luaL_openlibs</strong></span><span class="No-Break">.</span></li>
<li>Loading a Lua script named <strong class="source-inline">script.lua</strong> with <strong class="source-inline">luaL_loadfile</strong> and executing it with <strong class="source-inline">lua_pcall</strong>. We will write <span class="No-Break"><strong class="source-inline">script.lua</strong></span><span class="No-Break"> soon.</span></li>
<li>Outputting an error if the script has failed to execute. This is done inside the <span class="No-Break"><strong class="source-inline">if</strong></span><span class="No-Break"> clause.</span></li>
<li>Closing Lua <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">lua_close</strong></span><span class="No-Break">.</span></li>
</ol>
<p>The Lua functions used here, as well as the Lua state, will be explained in detail in <span class="No-Break"><em class="italic">Chapter 3</em></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-36"><a id="_idTextAnchor036"/>Testing the project</h2>
<p>If you have <a id="_idIndexMarker039"/>created an empty <strong class="source-inline">script.lua</strong>, delete it. Compile and run <span class="No-Break">the project:</span></p>
<pre class="source-code">
execute-lua-script % make
execute-lua-script % ./executable
Error: cannot open script.lua: No such file or directory</pre>
<p>As expected, it says <strong class="source-inline">script.lua</strong> is not found. Don’t worry. You will write it next. The important thing to note is that you have finished coding the C++ part of the project and have already compiled <span class="No-Break">the project.</span></p>
<h2 id="_idParaDest-37"><a id="_idTextAnchor037"/>Writing the Lua script</h2>
<p>Write <strong class="source-inline">script.lua</strong> as the one-liner <span class="No-Break">shown here:</span></p>
<pre class="source-code">
print("Hello C++!")</pre>
<p>This will <a id="_idIndexMarker040"/>print <span class="No-Break"><strong class="source-inline">Hello C++!</strong></span><span class="No-Break">.</span></p>
<p>Execute the project again without recompiling the <span class="No-Break">C++ code:</span></p>
<pre class="source-code">
execute-lua-script % ./executable
Hello C++!</pre>
<p>Congratulations! You have now executed a Lua script from a C++ program and changed what the C++ program does after it has <span class="No-Break">been compiled.</span></p>
<p>The next section offers some ideas to set up your development <span class="No-Break">environment differently.</span></p>
<h1 id="_idParaDest-38"><a id="_idTextAnchor038"/>Other toolchain options</h1>
<p>If you do not <a id="_idIndexMarker041"/>have access to a native POSIX system, there are many other toolchain options. Here we have given two examples. Because your development platform may be different and OS updates and situations change, these only serve as some ideas. You can always research online and experiment to get a comfortable setup <span class="No-Break">for yourself.</span></p>
<h2 id="_idParaDest-39"><a id="_idTextAnchor039"/>Using Visual Studio or Xcode</h2>
<p>The Lua source <a id="_idIndexMarker042"/>code is written in C and does not need other dependencies. You can copy the <strong class="source-inline">src</strong> folder from the Lua source code <a id="_idIndexMarker043"/>package into Visual Studio or Xcode, either into your project directly or by configuring it as a Lua project that your main project depends on. Tweak the project settings as you need. This is <span class="No-Break">quite doable.</span></p>
<p>Whatever IDE you choose to use, remember to check its license to see whether you can use the IDE for <span class="No-Break">your purpose.</span></p>
<h2 id="_idParaDest-40"><a id="_idTextAnchor040"/>Using Cygwin</h2>
<p>If you <a id="_idIndexMarker044"/>use Windows, you can get Cygwin for a <span class="No-Break">POSIX experience:</span></p>
<ol>
<li>Download <a id="_idIndexMarker045"/>the Cygwin installer from <a href="https://sourceware.org/cygwin/">https://sourceware.org/cygwin/</a> and run <span class="No-Break">the installer.</span></li>
<li>During package selection, search for the two packages called <strong class="source-inline">make</strong> and <strong class="source-inline">gcc-g++</strong>. Select them <span class="No-Break">for installation.</span></li>
<li>Change all your shell commands and project <strong class="source-inline">Makefiles</strong> related to Lua slightly. You need to build the Linux flavor of the library explicitly. For example, change <strong class="source-inline">cd lua &amp;&amp; make</strong> to <strong class="source-inline">cd lua &amp;&amp; make linux</strong>. This is because the Lua <strong class="source-inline">Makefile</strong> could not detect Cygwin as a <span class="No-Break">Linux flavor.</span></li>
<li>Open the Cygwin terminal, and you can build and run projects as shown in the examples in <span class="No-Break">this chapter.</span></li>
</ol>
<h1 id="_idParaDest-41"><a id="_idTextAnchor041"/>Summary</h1>
<p>In this chapter, we have learned how to compile the Lua source code, how to link to the Lua library, and how to include the Lua source code directly in your project. Finally, we executed a Lua script from C++ code. By following these steps yourself, you should be comfortable and confident in including Lua in your C++ projects and prepared for more <span class="No-Break">complex work.</span></p>
<p>In the next chapter, we will learn the basics of the Lua programming language. If you are already familiar with the Lua programming language, feel free to skip <span class="No-Break"><em class="italic">Chapter 2</em></span><em class="italic">, Lua Fundamentals</em>. We will come back to the communications between Lua and C++ in <span class="No-Break"><em class="italic">Chapter 3</em></span><em class="italic">, How to Call Lua </em><span class="No-Break"><em class="italic">from C++</em></span><span class="No-Break">.</span></p>
</div>
</div></body></html>