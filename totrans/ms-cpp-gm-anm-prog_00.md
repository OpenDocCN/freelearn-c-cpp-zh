# 前言

你是否曾发现自己在一款第一人称或第三人称游戏中，看着你的玩家角色和敌人四处奔跑、跳跃、射击和躲避，而你正按着按钮，对着目标射击，并问自己：

等等...所有角色是如何保持在地面上的？他们是如何知道墙壁在哪里？按钮又是如何知道是我而不是我的队友按下的？

为了回答这些问题，你需要启动一个现代的 3D 引擎，如 Unreal Engine、Unity 或 Godot。你会玩弄模型和动画、关卡、资产、菜单和其他对象。通过完成教程和视频，你会学习如何构建一个类似于你喜爱的游戏的虚拟世界，并对你所取得的成就感到满意。

但如果你的对底层细节、对几个功能的实现的需求仍然存在？即使从可视化编程转向 3D 引擎的底层编程语言，你仍然不满意。代码的复杂性太高，仅从中学到基础知识。所以，你又走上了寻找那些问题的答案的道路...

这听起来熟悉吗？许多游戏程序员都是从这种好奇心开始的，他们想要探究他们所看到事物背后的机制，并迫切想要了解模型是如何被动画化和动画是如何融合的。这可能包括面部动画的工作原理，或者简单的“点头”动作是如何完成的，或者如何让角色在关卡的地形多边形上行走和奔跑，而不是穿墙而过。

本书旨在回答你关于 3D 游戏角色动画实现细节的问题。你将从最基本的 OpenGL 或 Vulkan 渲染器开始，它只用来在屏幕上绘制三角形——然后你将被引导一路向上，从从文件中加载单个角色模型到多个不同模型在游戏地图上漫游，检测和避开虚拟世界中的墙壁和其他实例，遵循预定义的路径，并能够与其他实例交互。

通过本书获得的知识，你将以不同的视角看待游戏中的动画，你会经常微笑，因为你知道它们是如何制作的。

# 本书面向的对象

如果你已经熟悉 C++和角色动画，但想了解更多关于实现细节和高级角色动画主题，类似于 3D 游戏中的动画，这本书适合你。

# 本书涵盖的内容

*第一章*，*使用 Open Asset Import Library*，概述了**Open Asset Import Library**（或**assimp**）的数据结构，并解释了如何从文件中加载角色模型。文件加载过程将通过添加基于 ImGui 的**打开文件**对话框来增强。此外，还将涵盖在运行时添加和删除模型和实例的代码。

*第二章*，*将动画计算从 CPU 迁移到 GPU*，介绍了计算着色器以将计算卸载到图形处理器并将查找数据存储在 GPU 内存中。通过使用 GPU 的巨大并行架构，计算所有实例的节点位置将得到加速，CPU 将再次空闲以执行其他任务。

*第三章*，*添加视觉选择*，解释了如何支持应用程序用户在角色实例选择任务中的操作。除了在屏幕上突出显示当前选定的实例外，还将添加通过使用鼠标选择任何实例的能力。

*第四章*，*增强应用程序处理*，介绍了将应用程序分为视图模式和编辑模式，这两种模式具有部分不同的配置。此外，还将实现撤销和重做操作。

*第五章*，*保存和加载配置*，涵盖了将应用程序的当前配置以及加载的模型和创建的实例存储在 YAML 文件中，以及从文件中加载配置回应用程序。

*第六章*，*扩展相机处理*，展示了如何添加不同类型的相机和配置。新的相机设置包括正交投影和第一人称和第三人称视角。

*第七章*，*增强动画控制*，涵盖了基本的动画混合、动作状态以及将动作状态与动画剪辑相连接。到本章结束时，您将能够使用键盘和鼠标控制实例，包括额外的动作，如跳跃、翻滚或挥手。

*第八章*，*碰撞检测简介*，基于四叉树、轴对齐边界框和边界球体，解释了实例/实例碰撞检测的路径以及碰撞的反应。

*第九章*，*添加行为和交互*，添加了一个基于节点的图形编辑器，通过创建和连接简单的节点来控制实例行为。节点将被扩展以覆盖实例之间的可配置交互。

*第十章*，*高级动画混合*，介绍了面部动画以表达情感，以及独立于角色模型身体其他部分的加性动画混合来移动头部。

*第十一章*，*加载游戏地图*，解释了动态角色模型实例与静态水平几何形状之间的区别，以及如何加载和处理水平数据以实现良好的性能。

*第十二章*，*高级碰撞检测*，将碰撞检测扩展到在第*第十一章*中添加的水平几何形状。将添加简单的重力以保持模型实例位于水平地板上，您将看到如何避免实例与墙壁的碰撞。

*第十三章*，*添加简单导航*，涵盖了在加载的游戏地图内的路径查找和导航。将使用一个著名的路径查找算法，以便实例在关卡中自由漫游。

*第十四章*，*创建沉浸式交互式世界*，提供了有关如何向角色模型编辑器添加更多酷炫功能的提示和资源，逐步将代码推进到一个简单的游戏引擎。

# 要充分利用这本书

要充分利用这本书，你应该至少具备中级 C++经验以及向量/矩阵数学知识，以及了解骨骼动画的基础。任何特殊或高级功能都将进行解释，并在它们首次使用章节中包含学习这些功能的资源。但你应该能够自己调试简单的 C++问题（即，通过使用日志语句或通过将调试器附加到应用程序）。

代码是为 OpenGL 4.6 Core 和 Vulkan 1.1+编写的。这两个图形 API 在现代 GPU 中得到了广泛的支持。已知可以与这些 API 版本一起工作的最老图形卡是大约 10 年前制造的英特尔 HD 4000 系列。

| 书中涵盖的软件 | 操作系统要求 |  |
| --- | --- | --- |
| OpenGL 4.6 和 Vulkan 1.1+ | Windows 或 Linux | C++17 及以上（至 C++26） |

书中提供的示例代码应在任何运行最新版本 Windows 和 Linux 的台式计算机或笔记本电脑上编译。代码已经与以下组合进行了测试：

+   Windows 10 与 Visual Studio 2022

+   Windows 10 与 Eclipse 2024-09，使用 MSYS2 中的 GCC

+   Ubuntu 24.04 LTS 与 Eclipse 2024-09，使用 GCC 或 Clang

+   Ubuntu 24.04 LTS，使用 GCC 或 Clang 在命令行上编译

如果你使用的是这本书的数字版，我们建议你亲自输入代码或从书的 GitHub 仓库中获取代码（下一节中提供了链接）。这样做将帮助你避免与代码复制粘贴相关的任何潜在错误。

示例代码的完整源代码可在书的 GitHub 仓库中找到（下一节中提供了链接）。书中章节仅包含代码的摘录，涵盖了重要的部分。

## 下载示例代码文件

你可以从 GitHub 下载这本书的示例代码文件[`github.com/PacktPublishing/Mastering-Cpp-Game-Animation-Programming`](https://github.com/PacktPublishing/Mastering-Cpp-Game-Animation-Programming)。如果代码有更新，它将在 GitHub 仓库中更新。

我们还有来自我们丰富的书籍和视频目录中的其他代码包，可在[`github.com/PacktPublishing`](https://github.com/PacktPublishing)找到。查看它们吧！

## 下载彩色图像

我们还提供了一份包含书中使用的截图/图表彩色图像的 PDF 文件。你可以从这里下载：[`packt.link/gbp/9781835881927`](https://packt.link/gbp/9781835881927)。

## 使用的约定

本书使用了多种文本约定：

`CodeInText`：表示文本中的代码单词、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟 URL、用户输入和 Twitter 昵称。例如：“通常，你会使用`nullptr`来表示对象实例不存在。”

**粗体**：表示新术语、重要单词或你在屏幕上看到的单词。例如，菜单或对话框中的单词在文本中显示如下。例如：“**导入模型**按钮可能看起来有点放错位置，但现在我们有改变功能的机会。”

代码块设置如下：

```cpp
std::shared_ptr<AssimpModel> nullModel = std::make_shared<AssimpModel>();
mModelInstData.miModelList.emplace_back(nullModel) 
```

当我们希望引起你对代码块中特定部分的注意时，相关的行或项目将以粗体显示：

```cpp
**mat4** **worldPosSkinMat = worldPos[****gl_InstanceID****] * skinMat;**
gl_Position = projection * view * **worldPosSkinMat** * vec4(aPos.x, aPos.y, aPos.z, 1.0);
...
normal = transpose(inverse(**worldPosSkinMat**)) * vec4(aNormal.x, aNormal.y, aNormal.z, 1.0); 
```

任何命令行输入或输出都按以下方式编写：

```cpp
$ cd chapter01/01_assimp_opengl
$ mkdir build && cd build
$ cmake -G Ninja .. && ninja && ./Main 
```

警告或重要注意事项如下所示。

技巧和窍门如下所示。

# 联系我们

我们始终欢迎读者的反馈。

**一般反馈**：请发送电子邮件至`feedback@packtpub.com`，并在邮件主题中提及书籍标题。如果你对此书的任何方面有疑问，请发送电子邮件至`questions@packtpub.com`。

**勘误表**：尽管我们已经尽一切努力确保内容的准确性，但错误仍然可能发生。如果你在此书中发现错误，我们将不胜感激，如果你能向我们报告，请访问[`www.packtpub.com/submit-errata`](http://www.packtpub.com/submit-errata)，点击**提交勘误表**并填写表格。

**盗版**：如果你在互联网上发现我们作品的任何形式的非法副本，如果你能提供位置地址或网站名称，我们将不胜感激。请通过`copyright@packtpub.com`与我们联系，并提供材料的链接。

**如果你有兴趣成为作者**：如果你在某个领域有专业知识，并且你感兴趣的是撰写或为书籍做出贡献，请访问[`authors.packtpub.com`](http://authors.packtpub.com)。

# 分享你的想法

一旦你阅读了《精通 C++游戏动画编程》，我们很乐意听听你的想法！请[点击此处直接访问此书的亚马逊评论页面](https://packt.link/r/1835881939)并分享你的反馈。

你的评论对我们和科技社区都很重要，并将帮助我们确保我们提供高质量的内容。

# 下载此书的免费 PDF 副本

感谢你购买此书！

你喜欢在路上阅读，但无法携带你的印刷书籍到处走吗？

你的电子书购买是否与你的选择设备不兼容？

别担心，现在，随着每本 Packt 书籍，你都可以免费获得该书的 DRM 免费 PDF 版本。 

在任何地方、任何时间、任何设备上阅读。直接从你最喜欢的技术书籍中搜索、复制和粘贴代码到你的应用程序中。

优惠远不止于此，你还可以获得独家折扣、时事通讯和每日免费内容的每日电子邮件。

按照以下简单步骤获取好处：

1.  扫描下面的二维码或访问以下链接

![二维码描述自动生成](img/B22428_QR_Free_PDF.png)

[`packt.link/free-ebook/978-1-83588-192-7`](https://packt.link/free-ebook/978-1-83588-192-7)

1.  提交您的购买证明

1.  就这些！我们将直接将您的免费 PDF 和其他好处发送到您的电子邮件
