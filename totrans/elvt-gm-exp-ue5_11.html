<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer356">
<h1 class="chapter-number" id="_idParaDest-194"><a id="_idTextAnchor222"/>11</h1>
<h1 id="_idParaDest-195"><a id="_idTextAnchor223"/>Working with Blend Space 1D, Key Bindings, and State Machines</h1>
<p>In the previous chapter, we had a high-level look at animation and developing the game design for our <strong class="source-inline">SuperSideScroller</strong> project. You were provided with just the beginning steps in terms of developing the project itself. Then, you prepared the player character’s Animation Blueprint and character Blueprint, and also imported all of the required skeletal and animation assets. </p>
<p>In this chapter, we will set up the walking and jumping animations of our player character so that the movement has a sense of locomotion. To accomplish this, you will be introduced to <strong class="bold">Blend Spaces</strong>, <strong class="bold">Animation Blueprints</strong>, and <strong class="bold">Animation State Machines</strong>, the three pillars behind how character animations are controlled.</p>
<p>At this point, the character can move around the level, but is stuck in the T-Pose and does not animate at all. This can be fixed by creating a new Blend Space for the player character, which will be done in the very first exercise of this chapter. Once the Blend Space is complete, you will use it to implement the character Animation Blueprint for the character to animate while moving.</p>
<p>In this chapter, we’re going to cover the following main topics:</p>
<ul>
<li>Creating Blend Spaces</li>
<li>Main character Animation Blueprint</li>
<li>What are velocity vectors?</li>
<li>Enhanced input system</li>
<li>Using Animation State Machines</li>
</ul>
<p>By the end of the chapter, the player character will be able to walk, sprint, and jump, thus providing a better game feel to how the character will move in our game. By creating and learning about Blend Space 1D and Animation Blueprint assets, you will add a layer of sophistication to how the player movement is handled, while also establishing the groundwork for further animations, such as the projectile throw.</p>
<h1 id="_idParaDest-196"><a id="_idTextAnchor224"/>Technical requirements</h1>
<p>For this chapter, you will need the following:</p>
<ul>
<li>Unreal Engine 5 installed</li>
<li>Visual Studio 2019 installed</li>
</ul>
<p>The project for this chapter can be found in the <strong class="source-inline">Chapter11</strong> folder of the code bundle for this book, which can be downloaded here: <a href="https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition">https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition</a>.</p>
<p>We’ll start this chapter by learning about Blend Spaces before creating the Blend Space asset that you will need to animate the player character.</p>
<h1 id="_idParaDest-197"><a id="_idTextAnchor225"/>Creating Blend Spaces</h1>
<p>Blend Spaces <a id="_idIndexMarker846"/>allow you to blend between multiple animations based on one or more conditions. Blend Spaces are used in different types of video games, but, more often than not, in games where the player can view the entire character. Blend Spaces are not usually used when the player can only see the character’s arms, such as in the <strong class="bold">First-Person</strong> project template provided in UE5, as shown here:</p>
<div>
<div class="IMG---Figure" id="_idContainer299">
<img alt="Figure 11.1 – The first-person perspective of the default character in the First-Person project template in UE5 " height="668" src="image/Figure_11.01_B18531.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.1 – The first-person perspective of the default character in the First-Person project template in UE5</p>
<p>It is more common in third-person games where there is a need to use Blend Spaces to smoothly blend movement-based animations of the character. A good example is the <strong class="bold">Third-Person</strong> template <a id="_idIndexMarker847"/>project provided in UE5, as shown here:</p>
<div>
<div class="IMG---Figure" id="_idContainer300">
<img alt="Figure 11.2 – The third-person perspective of the default character in the First-Person project template in UE5 " height="768" src="image/Figure_11.02_B18531.jpg" width="1494"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.2 – The third-person perspective of the default character in the First-Person project template in UE5</p>
<p>Let’s look at the Blend Space asset provided by Unreal Engine when creating the <strong class="source-inline">Third Person template</strong> project template by opening <strong class="source-inline">/Characters/Mannequins/Animations/Quinn/BS_MF_Unarmed_WalkRun</strong>. This is a Blend Space 1D asset created for the <strong class="source-inline">Side Scroller</strong> mannequin skeletal mesh so that the player character can smoothly blend between <strong class="source-inline">Idle</strong>, <strong class="source-inline">Walking</strong>, and <strong class="source-inline">Running</strong> animations based on the speed of the character.</p>
<p>If you check <strong class="bold">Persona</strong> in the <strong class="bold">Asset Details</strong> panel on the left-hand side, you will see the <strong class="bold">AXIS SETTINGS</strong> category, which contains the <strong class="source-inline">Horizontal Axis</strong> parameter, where we have settings for this axis, which essentially acts as a variable that we can reference in our Animation Blueprint. Please refer to the following screenshot to see the <strong class="bold">AXIS SETTINGS</strong> category <a id="_idIndexMarker848"/>within <strong class="bold">Persona</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer301">
<img alt="Figure 11.3 – The axis settings for the Blend Space 1D " height="486" src="image/Figure_11.03_B18531.jpg" width="1450"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.3 – The axis settings for the Blend Space 1D</p>
<p>Below the preview window, we will also see a small graph with points along the line from left to right; one of these points will be highlighted <strong class="source-inline">green</strong>, while the others will be <strong class="source-inline">white</strong>. We can hold <em class="italic">Shift</em> and drag this <strong class="source-inline">green</strong> point along the horizontal axis to preview the blended animation based on its value. At speed <strong class="source-inline">0</strong>, our character is in an <strong class="source-inline">Idle</strong> state. As we move our preview along the axis, the animation will begin to blend into <strong class="source-inline">Walking</strong>, followed <a id="_idIndexMarker849"/>by <strong class="source-inline">Running</strong>. The following screenshot shows the single-axis graph:</p>
<div>
<div class="IMG---Figure" id="_idContainer302">
<img alt="Figure 11.4 – The key frame timeline of the 1D Blend Space 1D " height="817" src="image/Figure_11.04_B18531.jpg" width="1575"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.4 – The key frame timeline of the 1D Blend Space 1D</p>
<p>In the next section, we will look at Blend Space 1Ds versus a normal Blend Space, and when to use them based on your animation needs.</p>
<h2 id="_idParaDest-198"><a id="_idTextAnchor226"/>Blend Space 1D versus normal Blend Space</h2>
<p>Before<a id="_idIndexMarker850"/> moving forward with the Blend Space 1D, let’s <a id="_idIndexMarker851"/>take a moment to look at the main differences between a Blend Space 1D and a normal Blend Space in UE5: </p>
<ul>
<li>The Blend Space in Unreal Engine is controlled by two variables, represented by the X and <em class="italic">Y</em> axes of the Blend Space graph.</li>
<li>On the other hand, the Blend Space 1D only supports one axis.</li>
</ul>
<p>Try to imagine this as a 2D graph. Since you know that each axis has a direction, you can visualize why and when you would need to use this Blend Space rather than a Blend Space 1D, which only supports a single axis.</p>
<p>Say, for example, you wanted to make the player character strafe left and right while also supporting forward and backward movement. If you were to map this movement out on a graph, it would look as follows:</p>
<div>
<div class="IMG---Figure" id="_idContainer303">
<img alt="Figure 11.5 – What a Blend Space movement would look like on a simple graph " height="657" src="image/Figure_11.05_B18531.jpg" width="1168"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.5 – What a Blend Space movement would look like on a simple graph</p>
<p>Now, visualize the movement of the player character, keeping in mind the fact that the game is a <strong class="source-inline">Side Scroller</strong>. The character won’t be supporting left or right strafing or forward and backward movement. The player character will only need to animate in one direction because the <strong class="source-inline">Side Scroller</strong> character rotates toward the direction of movement by default. Having to only support one direction is why you are using a Blend Space 1D instead of a normal Blend Space.</p>
<p>We will need to set up this type of Blend Space asset for our main character and use the Blend <a id="_idIndexMarker852"/>Space <a id="_idIndexMarker853"/>for the same purpose, for movement-based animation blending. In the next exercise, we’ll create the Blend Space asset using our custom animation assets.</p>
<h2 id="_idParaDest-199"><a id="_idTextAnchor227"/>Exercise 11.01 – creating the CharacterMovement Blend Space 1D</h2>
<p>To get the player <a id="_idIndexMarker854"/>character to animate while they move, you need to create a Blend Space.</p>
<p>In this exercise, you will create the <strong class="bold">Blend Space</strong> asset, add the idle animation, and update the <strong class="source-inline">CharacterMovement</strong> component so that you assign an appropriate walking speed value that corresponds with the Blend Space.</p>
<p>Follow these steps to complete this exercise:</p>
<ol>
<li>Navigate to the <strong class="source-inline">/MainCharacter/Animation</strong> folder in the <strong class="bold">Content Drawer</strong> window, where all the new animations you imported in the previous chapter are located. </li>
<li>Now, <em class="italic">right-click</em> in the main area of the <strong class="bold">Content Drawer</strong> window and, from the drop-down menu, hover over the <strong class="bold">Animation</strong> option. From its additional drop-down menu, select <strong class="bold">Blend Space 1D</strong>. </li>
<li>Make sure to select <strong class="source-inline">MainCharacter_Skeleton</strong>, not <strong class="source-inline">UE4_Mannequin_Skeleton</strong>, as the skeleton for the Blend Space. </li>
</ol>
<p class="callout-heading">Note</p>
<p class="callout">If you apply the incorrect skeleton, the Blend Space will not be functional for the player character, nor will the custom skeletal mesh when you select the skeleton assets, such as Blend Spaces or Animation Blueprints, that are required. Here, you are telling this asset which skeleton it is compatible with. By doing so, in the case of a Blend Space, you can use animations that have been made for this skeleton, thereby ensuring that everything is compatible with everything else.</p>
<ol>
<li value="4">Name this Blend Space asset <strong class="source-inline">SideScroller_IdleRun_1D</strong>.</li>
<li>Next, open the <strong class="source-inline">SideScroller_IdleRun_</strong>Blend Space 1D asset. You can see the single-axis graph below the preview window:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer304">
<img alt="Figure 11.6 – The editing tool used to create Blend Spaces in UE5 " height="891" src="image/Figure_11.06_B18531.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.6 – The editing tool used to create Blend Spaces in UE5</p>
<p>On the left-hand<a id="_idIndexMarker855"/> side of the editor, you have the <strong class="bold">Asset Details</strong> panel, which contains the <strong class="bold">AXIS SETTING</strong> category. Here, you can label the axis and provide both a minimum and maximum float value that will be of use to you in the <strong class="source-inline">Animation Blueprint</strong> property for the player character. The following screenshot shows the default values that have been set for <strong class="source-inline">Horizontal Axis</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer305">
<img alt="Figure 11.7 – The axis settings that affect the axis of the Blend Space " height="485" src="image/Figure_11.07_B18531.jpg" width="1068"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.7 – The axis settings that affect the axis of the Blend Space</p>
<ol>
<li value="6">Now, change<a id="_idIndexMarker856"/> the name of <strong class="bold">Horizontal Axis</strong> to <strong class="source-inline">Speed</strong>:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer306">
<img alt="Figure 11.8 – The horizontal axis is now named Speed " height="451" src="image/Figure_11.08_B18531.jpg" width="1150"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.8 – The horizontal axis is now named Speed</p>
<ol>
<li value="7">The next step is to establish <strong class="bold">Minimum Axis Value</strong> and <strong class="bold">Maximum Axis Value</strong>. You will want the minimum value to be <strong class="source-inline">0.0f</strong>, which is set by default, because the player character will be in an <strong class="source-inline">Idle</strong> state when they are not moving at all.</li>
</ol>
<p>But what about <strong class="bold">Maximum Axis Value</strong>? This one is a little trickier because you need to bear the following points in mind:</p>
<ul>
<li>You will be supporting a sprinting behavior for the character that allows the player to move faster when holding down the <em class="italic">Left Shift</em> keyboard button. When released, the player will return to the default walking speed.</li>
<li>The <a id="_idIndexMarker857"/>walking speed must match the characters’ <strong class="source-inline">Max Walk Speed</strong> parameter of <strong class="source-inline">CharacterMovementComponent</strong>.</li>
<li>Before you set <strong class="bold">Maximum Axis Value</strong>, you need to set the character’s <strong class="bold">Max Walk Speed</strong> to a value that suits the <strong class="source-inline">SuperSideScroller</strong> game. </li>
</ul>
<ol>
<li value="8">For this, navigate to <strong class="source-inline">/Game/MainCharacter/Blueprints/</strong> and open the <strong class="source-inline">BP_SuperSideScroller_MainCharacter</strong> Blueprint.</li>
<li>Select the <strong class="source-inline">Character Movement</strong> component and, in the <strong class="bold">Details</strong> panel, under the <strong class="bold">Character Movement: Walking</strong> category, find the <strong class="source-inline">Max Walk Speed</strong> parameter and set its value to <strong class="source-inline">300.0f</strong>. </li>
</ol>
<p>With the <strong class="source-inline">Max Walk Speed</strong> parameter set, return to the <strong class="source-inline">SideScroller_IdleRun_</strong>Blend Space 1D and set the <strong class="source-inline">Maximum Axis Value</strong> parameter. If the walking speed was <strong class="source-inline">300.0f</strong>, what should the maximum value be? Keeping in mind that you will support sprinting for the player character, this maximum value needs to be more than the walking speed.</p>
<ol>
<li value="10">Update the <strong class="source-inline">Maximum Axis Value</strong> parameter so that its value is <strong class="source-inline">500.0f</strong>. </li>
<li>Lastly, set the <strong class="source-inline">Number of Grid Divisions</strong> parameter to a value of <strong class="source-inline">5</strong>. The reason for this is that when working with divisions, a <strong class="source-inline">100</strong> unit spacing between each grid point makes it easier to work with since <strong class="source-inline">Maximum Axis Value</strong> is <strong class="source-inline">500.0f</strong>. This is useful in the case of grid point snapping when you apply the movement animations along the grid. </li>
<li>Leave the remaining properties set as their defaults:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer307">
<img alt="Figure 11.9 – The final axis settings for the Blend Space " height="488" src="image/Figure_11.09_B18531.jpg" width="1141"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.9 – The final axis settings for the Blend Space</p>
<p>With these<a id="_idIndexMarker858"/> settings, you are telling the Blend Space to use an incoming float value between <strong class="source-inline">0.0f</strong> and <strong class="source-inline">500.0f</strong> to blend between the animations that you will place in the next step and the activity. By dividing the grid into <strong class="source-inline">5</strong> divisions, you can easily add the animations needed at the correct float value along the axis graph.</p>
<p>Let’s continue creating the Blend Space by adding our first animation to the axis graph: the <strong class="source-inline">Idle</strong> animation.</p>
<ol>
<li value="13">To the right of the grid, there is the <strong class="bold">Asset Browser</strong> tab. Notice that the list of assets includes all of the animations of the player character that you imported in <a href="B18531_10.xhtml#_idTextAnchor199"><em class="italic">Chapter 10</em></a>, <em class="italic">Creating the SuperSideScroller Game</em>. This is because you selected the <strong class="source-inline">MainCharacter_Skeleton</strong> asset when creating the Blend Space.</li>
<li>Next, left-click and drag the <strong class="source-inline">Idle</strong> animation to our grid at position <strong class="source-inline">0.0</strong>:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer308">
<img alt="Figure 11.10 – Dragging the Idle animation to our grid at position 0.0 " height="329" src="image/Figure_11.10_B18531.jpg" width="1239"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.10 – Dragging the Idle animation to our grid at position 0.0</p>
<p>Notice<a id="_idIndexMarker859"/> that when dragging this animation to the grid, it will snap to the grid point. Once the animation has been added to the Blend Space, the player character will change from its default T-Pose and start to play the <strong class="source-inline">Idle</strong> animation:</p>
<div>
<div class="IMG---Figure" id="_idContainer309">
<img alt="Figure 11.11 – With the Idle animation added to the Blend Space 1D, the player character begins to animate " height="865" src="image/Figure_11.11_B18531.jpg" width="1128"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.11 – With the Idle animation added to the Blend Space 1D, the player character begins to animate</p>
<p>With this exercise<a id="_idIndexMarker860"/> complete, you now have an understanding of how to create a Blend Space 1D and, more importantly, you know the differences between a Blend Space 1D and a normal Blend Space. Additionally, you know the importance of aligning the values between the player character movement component and the Blend Space and why you need to ensure that the walking speed correlates appropriately with the values in the Blend Space.</p>
<p>Now, let’s move on to the first activity of this chapter, where you will be applying the remaining <strong class="source-inline">Walking</strong> and <strong class="source-inline">Running</strong> animations to the Blend Space, just as you added the <strong class="source-inline">Idle</strong> animation.</p>
<h2 id="_idParaDest-200"><a id="_idTextAnchor228"/>Activity 11.01 – adding the Walking and Running animations to the Blend Space</h2>
<p>The 1D movement Blend <a id="_idIndexMarker861"/>Space is coming<a id="_idIndexMarker862"/> together nicely so far, but you are missing the <strong class="source-inline">Walking</strong> and <strong class="source-inline">Running</strong> animations. In this activity, you will finish the Blend Space by adding these animations to the Blend Space at the appropriate horizontal axis values that make sense for the main character.</p>
<p>Using the knowledge you acquired from <em class="italic">Exercise 11.01 – creating the CharacterMovement Blend Space 1D</em>, follow these steps to finish up the character movement Blend Space:</p>
<ol>
<li value="1">Continuing from <em class="italic">Exercise 11.01 – creating the CharacterMovement Blend Space 1D</em>, head back to the <strong class="bold">Asset Browser</strong> window.</li>
<li>Now, add the <strong class="source-inline">Walking</strong> animation to the horizontal grid position <strong class="source-inline">300.0f</strong>.</li>
<li>Finally, add the <strong class="source-inline">Running</strong> animation to the horizontal grid position <strong class="source-inline">500.0f</strong>.</li>
</ol>
<p class="callout-heading">Note</p>
<p class="callout">Remember that you can hold <em class="italic">shift</em> and drag the green preview grid point along the grid axis to see how the animation blends together based on the axis value, so pay attention to the character animation preview window to make sure that it looks correct.</p>
<p>The expected output is as follows:</p>
<div>
<div class="IMG---Figure" id="_idContainer310">
<img alt="Figure 11.12 – The Running animation in the Blend Space " height="504" src="image/Figure_11.12_B18531.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"> </p>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.12 – The Running animation in the Blend Space</p>
<p>At this point, you should have a functional Blend Space that blends the character movement animations from <strong class="source-inline">Idle</strong> to <strong class="source-inline">Walking</strong> to <strong class="source-inline">Running</strong> based on the value of the horizontal axis<a id="_idIndexMarker863"/> that <a id="_idIndexMarker864"/>represents the player character’s speed.</p>
<p class="callout-heading">Note</p>
<p class="callout">The solution to this activity can be found on GitHub here: <a href="https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition/tree/main/Activity%20solutions">https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition/tree/main/Activity%20solutions</a>.</p>
<h1 id="_idParaDest-201"><a id="_idTextAnchor229"/>The Main Character Animation Blueprint</h1>
<p>With the<a id="_idIndexMarker865"/> animations added to the Blend Space, you should be able to walk around and see those animations at work, right? Well, no. If you select <strong class="bold">Play-In-Editor</strong>, you will notice that the main character is still moving in the T-Pose. The reason is that you aren’t telling the Animation Blueprint to use our Blend Space asset yet, which you will do later in this chapter. </p>
<h2 id="_idParaDest-202"><a id="_idTextAnchor230"/>Animation Blueprints</h2>
<p>Before jumping into<a id="_idIndexMarker866"/> using the Animation Blueprint you created in the previous chapter, let’s briefly discuss what this type of Blueprint is, and what its main function is. An Animation Blueprint is a type of Blueprint that allows you to control the animation of a skeleton and skeletal mesh – in this instance, the player character skeleton and mesh you imported in the previous chapter.</p>
<p>An Animation Blueprint is broken <a id="_idIndexMarker867"/>into two main graphs:</p>
<ul>
<li>Event Graph</li>
<li>Anim Graph</li>
</ul>
<p>The Event Graph works as in a normal Blueprint where you can use events, functions, and variables to script gameplay logic. The Anim Graph, on the other hand, is unique to an Animation Blueprint, and this is where you use logic to determine the final pose of the skeleton and skeletal mesh at any given frame. It is here where you can use elements such as State Machines, anim slots, Blend Spaces, and other animation-related nodes to then output the final animation for the character.</p>
<p>Let’s look at an example.</p>
<p>Open the <strong class="source-inline">AnimBP_SuperSideScroller_MainCharacter</strong> Animation Blueprint in the <strong class="source-inline">MainCharacter/Blueprints</strong> directory.</p>
<p>By default, <strong class="bold">AnimGraph</strong> should open, where you will see the character preview, the <strong class="bold">Asset Browser</strong> window, and the main graph. It is inside this <strong class="bold">AnimGraph</strong> that you will implement the Blend Space you just created to have the player character animate correctly when moving around the level. </p>
<p>Let’s get started with the next exercise, where we will do this and learn more about Animation Blueprints.</p>
<h2 id="_idParaDest-203"><a id="_idTextAnchor231"/>Exercise 11.02 – adding the Blend Space to the character Animation Blueprint</h2>
<p>For this <a id="_idIndexMarker868"/>exercise, you will add the <a id="_idIndexMarker869"/>Blend Space to the Animation Blueprint and prepare the necessary variable to help control this Blend Space based on the movement speed of the player character. Let’s begin by adding the Blend Space to <strong class="bold">AnimGraph</strong>.</p>
<p>Follow these steps to complete this exercise:</p>
<ol>
<li value="1">Add the Blend Space to <strong class="bold">AnimGraph</strong> by finding the <strong class="bold">Asset Browser</strong> window on the right-hand side and left-clicking and dragging the <strong class="source-inline">SideScroller_IdleRun_</strong>Blend Space 1D asset into <strong class="bold">AnimGraph</strong>.</li>
</ol>
<p>Notice that the variable input for this Blend Space node is labeled <strong class="source-inline">Speed</strong>, just like the horizontal axis inside the Blend Space. Please refer to <em class="italic">Figure 11.14</em> to see<a id="_idIndexMarker870"/> the<a id="_idIndexMarker871"/> Blend Space in the <strong class="bold">Asset Browser</strong> window:</p>
<p class="callout-heading">Note</p>
<p class="callout">If you were to name <strong class="bold">Horizontal Axis</strong> differently, the new name would be shown as the input parameter of the Blend Space.</p>
<div>
<div class="IMG---Figure" id="_idContainer311">
<img alt="Figure 11.13 – Asset Browser gives you access to all animation assets related to MainCharacter_Skeleton " height="391" src="image/Figure_11.13_B18531.jpg" width="890"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.13 – Asset Browser gives you access to all animation assets related to MainCharacter_Skeleton</p>
<ol>
<li value="2">Next, connect <a id="_idIndexMarker872"/>the <strong class="source-inline">Output Pose</strong> asset <a id="_idIndexMarker873"/>of the Blend Space node to the <strong class="source-inline">Result</strong> pin of the <strong class="source-inline">Output Pose</strong> node. Now, the animation pose in the preview will show the character in the <strong class="source-inline">Idle</strong> animation pose:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer312">
<img alt="Figure 11.14 – You now have limited control of the Blend Space and can manually enter values into the Speed parameter " height="385" src="image/Figure_11.14_B18531.jpg" width="924"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.14 – You now have limited control of the Blend Space and can manually enter values into the Speed parameter</p>
<ol>
<li value="3">If <a id="_idIndexMarker874"/>you <a id="_idIndexMarker875"/>use <strong class="bold">Play In Editor </strong>(<strong class="bold">PIE</strong>), the player character will be moving around, but will play the <strong class="source-inline">Idle</strong> animation instead of remaining in the T-Pose position:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer313">
<img alt="Figure 11.15 – The player character now plays the Idle animation in-game " height="490" src="image/Figure_11.15_B18531.jpg" width="887"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.15 – The player character now plays the Idle animation in-game</p>
<p>Now, we<a id="_idIndexMarker876"/> can <a id="_idIndexMarker877"/>control our Blend Space with our <strong class="source-inline">Speed</strong> input variable. With the ability to use the Blend Space in place, you need a way to store the character’s movement speed and pass that value to the <strong class="source-inline">Speed</strong> input parameter of the Blend Space. Let’s learn how to do this.</p>
<ol>
<li value="4">Navigate to the <strong class="source-inline">Event Graph</strong> property of our Animation Blueprint. By default, there will be the <strong class="source-inline">Event Blueprint Update Animation</strong> event and a pure <strong class="source-inline">Try Get Pawn Owner</strong> function. The following screenshot shows the default setup of <strong class="source-inline">Event Graph</strong>. The event is updated each frame that the animation is updated, and returns the <strong class="bold">Delta Time</strong> property between each frame update and the owning pawn of this Animation Blueprint. You need to make sure that the owning pawn is of the <strong class="source-inline">SuperSideScroller</strong> player character Blueprint class before attempting to get any more information:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer314">
<img alt="Figure 11.16 – Animation Blueprints include this event and function pair by default for use in your Event Graph " height="441" src="image/Figure_11.16_B18531.jpg" width="907"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.16 – Animation Blueprints include this event and function pair by default for use in your Event Graph</p>
<p class="callout-heading">Note</p>
<p class="callout">The main <a id="_idIndexMarker878"/>difference <a id="_idIndexMarker879"/>between a <strong class="source-inline">Pure</strong> and <strong class="source-inline">Impure</strong> function in UE5 is that a <strong class="source-inline">Pure</strong> function implies that the logic it contains will not modify a variable or member of the class that it is being used in. In the case of <strong class="source-inline">Try</strong> <strong class="source-inline">Get</strong> <strong class="source-inline">Pawn</strong> <strong class="source-inline">Owner</strong>, it is simply returning a reference to the <strong class="source-inline">Pawn</strong> owner of the Animation Blueprint. <strong class="source-inline">Impure</strong> functions do not have this implication and are free to modify any variable or member it wants.</p>
<ol>
<li value="5">Get the <strong class="source-inline">Return Value</strong> property from the <strong class="source-inline">Try Get Pawn Owner</strong> function and, from the <strong class="source-inline">Context Sensitive</strong> menu that appears, search for the cast to <strong class="source-inline">SuperSideScrollerCharacter</strong>:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer315">
<img alt="Figure 11.17 – Casting ensures we are working with the correct class " height="452" src="image/Figure_11.17_B18531.jpg" width="992"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.17 – Casting ensures we are working with the correct class</p>
<ol>
<li value="6">Connect<a id="_idIndexMarker880"/> the<a id="_idIndexMarker881"/> execution output pin from <strong class="source-inline">Event Blueprint Update Animation</strong> to the execution input pin of the cast:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer316">
<img alt="Figure 11.18 – Use the Try Get Pawn Owner function to cast the returned Pawn object to the SuperSideScrollerCharacter class " height="286" src="image/Figure_11.18_B18531.jpg" width="797"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.18 – Use the Try Get Pawn Owner function to cast the returned Pawn object to the SuperSideScrollerCharacter class</p>
<p>The<a id="_idIndexMarker882"/> character <a id="_idIndexMarker883"/>Blueprint you created inherits from the <strong class="source-inline">SuperSideScrollerCharacter</strong> class. Since the owning pawn of this Animation Blueprint is your <strong class="source-inline">BP_SuperSideScroller_MainCharacter</strong> character Blueprint and this Blueprint inherits from the <strong class="source-inline">SuperSideScrollerCharacter</strong> class, the cast function will execute successfully.</p>
<ol>
<li value="7">Next, store the returned value from the cast to its own variable; that way, we have a reference to it in case we need to use it again in our Animation Blueprint. Refer to <em class="italic">Figure 11.20</em> and make sure to name this new variable <strong class="source-inline">MainCharacter</strong>:</li>
</ol>
<p class="callout-heading">Note</p>
<p class="callout">The <strong class="source-inline">Promote to Variable</strong> option is available in the context-sensitive dropdown, and allows you to store any valid value type in its own variable.</p>
<div>
<div class="IMG---Figure" id="_idContainer317">
<img alt="Figure 11.19 – So long as the cast is successful, you will want to keep track of the owning character " height="368" src="image/Figure_11.19_B18531.jpg" width="1085"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.19 – So long as the cast is successful, you will want to keep track of the owning character</p>
<ol>
<li value="8">Now, to track the character’s speed, use the <strong class="source-inline">Get Velocity</strong> function from the <strong class="source-inline">MainCharacter</strong> variable. Every object from the <strong class="source-inline">Actor</strong> class has access to this function <a id="_idIndexMarker884"/>and<a id="_idIndexMarker885"/> returns the magnitude and direction vector that the object is moving in:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer318">
<img alt="Figure 11.20 – The GetVelocity function can be found under Utilities/Transformation " height="609" src="image/Figure_11.20_B18531.jpg" width="1270"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.20 – The GetVelocity function can be found under Utilities/Transformation</p>
<ol>
<li value="9">From <strong class="source-inline">Get Velocity</strong>, you can use the <strong class="source-inline">VectorLength</strong> function to get the actual speed:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer319">
<img alt="Figure 11.21 – The VectorLength function returns the magnitude of the vector " height="402" src="image/Figure_11.21_B18531.jpg" width="1032"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.21 – The VectorLength function returns the magnitude of the vector</p>
<ol>
<li value="10"><strong class="source-inline">Return Value</strong> from the <strong class="source-inline">VectorLength</strong> function can then be promoted to its own variable named <strong class="source-inline">Speed</strong>:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer320">
<img alt="Figure 11.22 – Every actor has the Get Velocity function " height="261" src="image/Figure_11.22_B18531.jpg" width="1461"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.22 – Every actor has the Get Velocity function</p>
<p>In this <a id="_idIndexMarker886"/>exercise, you<a id="_idIndexMarker887"/> obtained the player character speed by using the <strong class="source-inline">GetVelocity</strong> function. The vector that was returned from the <strong class="source-inline">GetVelocity</strong> function gives the length of the vector to ascertain the actual speed. By storing this value in the <strong class="source-inline">Speed</strong> variable, you can now reference this value in the <strong class="bold">AnimGraph</strong> property of the Animation Blueprint to update your Blend Space, which you will do in the next exercise. But first, let’s briefly discuss velocity vectors and how we use vector mathematics to determine the speed of our player character.</p>
<h1 id="_idParaDest-204"><a id="_idTextAnchor232"/>What are velocity vectors?</h1>
<p>Before moving on <a id="_idIndexMarker888"/>to the next step, let’s explain what you are doing when you get the velocity of the character and promote the vector length of that vector to the <strong class="source-inline">Speed</strong> variable.</p>
<p>What is velocity? Velocity is a vector that has a given <strong class="bold">magnitude</strong> and <strong class="bold">direction</strong>. To think about it another way, a vector can be drawn like an <em class="italic">arrow</em>. </p>
<p>The l<em class="italic">ength of the arrow</em> represents the <strong class="bold">magnitude</strong>, or <em class="italic">strength</em>, while <em class="italic">the direction of the arrowhead</em> represents the <strong class="bold">direction</strong>. So, if you want to know how fast the player character is moving, you will want to get the length of that vector. That is exactly what you are doing when you use the <strong class="source-inline">GetVelocity</strong> function and the <strong class="source-inline">VectorLength</strong> function on the returned velocity vector; you are getting the value of the <strong class="source-inline">Speed</strong> variable of your character. That is why you store that value in a variable and use it to control the Blend Space, as shown in the following diagram. Here, you can see an example of vectors. One has a positive (right) direction with a magnitude of <strong class="source-inline">100</strong>, while the other has a negative (left) direction with a magnitude of <strong class="source-inline">35</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer321">
<img alt="Figure 11.23 – Two different vectors " height="196" src="image/Figure_11.23_B18531.jpg" width="1324"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.23 – Two different vectors</p>
<p>In the following exercise, you will use the <strong class="source-inline">Speed</strong> variable you created from the <strong class="source-inline">VectorLength</strong> function of the velocity parameter of the player character from the previous exercise to drive how the Blend Space 1D will animate the character.</p>
<h2 id="_idParaDest-205"><a id="_idTextAnchor233"/>Exercise 11.03 – passing the character’s Speed variable into the Blend Space</h2>
<p>Now that <a id="_idIndexMarker889"/>you have a better understanding <a id="_idIndexMarker890"/>of vectors and how to store the <strong class="source-inline">Speed</strong> variable of the player character from the previous exercise, let’s apply the speed to the Blend Space 1D you created earlier in this chapter.</p>
<p>Follow these steps to complete this exercise:</p>
<ol>
<li value="1">Navigate to the <strong class="bold">AnimGraph</strong> property within your <strong class="source-inline">AnimBP_SuperSideScroller_MainCharacter</strong> Animation Blueprint.</li>
<li>Use the <strong class="source-inline">Speed</strong> variable to update the Blend Space in real time in <strong class="bold">AnimGraph</strong> by <em class="italic">left-clicking</em> and dragging the <strong class="source-inline">Speed</strong> variable onto the graph, and connecting the variable to the input of the <strong class="source-inline">Blendspace Player</strong> function:<div class="IMG---Figure" id="_idContainer322"><img alt="Figure 11.24 – Using the Speed variable to update the Blend Space on every frame " height="350" src="image/Figure_11.24_B18531.jpg" width="1418"/></div></li>
</ol>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"> </p>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.24 – Using the Speed variable to update the Blend Space on every frame</p>
<ol>
<li value="3">Next, compile <a id="_idIndexMarker891"/>the Animation<a id="_idIndexMarker892"/> Blueprint.</li>
</ol>
<p>With that, you can update the Blend Space based on the speed of the player character. When you use PIE, you will see the character in the <strong class="source-inline">Idle</strong> state and the <strong class="source-inline">Walking</strong> state when you move:</p>
<div>
<div class="IMG---Figure" id="_idContainer323">
<img alt="Figure 11.25 – The player character is finally able to walk around in the level " height="654" src="image/Figure_11.25_B18531.jpg" width="1099"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.25 – The player character is finally able to walk around in the level</p>
<p>Finally, the main character is using the movement animations based on movement speed. In the<a id="_idIndexMarker893"/> next <a id="_idIndexMarker894"/>activity, you will update the character movement component so that you can preview the character’s <strong class="source-inline">Running</strong> animation from the Blend Space.</p>
<h2 id="_idParaDest-206"><a id="_idTextAnchor234"/>Activity 11.02 – previewing the Running animation in-game</h2>
<p>With the <a id="_idIndexMarker895"/>Animation Blueprint updating and getting the speed of the player character, you can preview the <strong class="source-inline">Idle</strong> and <strong class="source-inline">Walking</strong> animations in-game.</p>
<p>In this activity, you will update the <strong class="source-inline">CharacterMovement</strong> component of the player character Blueprint so that you can preview the <strong class="source-inline">Running</strong> animation in-game as well.</p>
<p>Follow these steps to complete this activity:</p>
<ol>
<li value="1">Navigate to, and open, the <strong class="source-inline">BP_SuperSideScroller_MainCharacter</strong> player character Blueprint.</li>
<li>Access the <strong class="source-inline">CharacterMovement</strong> component.</li>
<li>Modify the <strong class="source-inline">Max Walk Speed</strong> parameter to a value of <strong class="source-inline">500.0</strong> so that your character can move fast enough to blend its animation from <strong class="source-inline">Idle</strong> to <strong class="source-inline">Walking</strong> and, finally, to <strong class="source-inline">Running</strong>.</li>
</ol>
<p>By doing this, the player character can reach a speed that allows you to preview the <strong class="source-inline">Running</strong> animation in-game.</p>
<p>The expected<a id="_idIndexMarker896"/> output is as follows:</p>
<div>
<div class="IMG---Figure" id="_idContainer324">
<img alt="Figure 11.26 – The player character running " height="534" src="image/Figure_11.26_B18531.jpg" width="916"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.26 – The player character running</p>
<p class="callout-heading">Note</p>
<p class="callout">The solution to this activity can be found on GitHub here: <a href="https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition/tree/main/Activity%20solutions">https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition/tree/main/Activity%20solutions</a>.</p>
<p>Now that you have <a id="_idIndexMarker897"/>handled the player character movement blending from <strong class="source-inline">Idle</strong> to <strong class="source-inline">Walking</strong> and finally to <strong class="source-inline">Running</strong>, let’s add the functionality that allows the player character to move even quicker by sprinting.</p>
<h1 id="_idParaDest-207"><a id="_idTextAnchor235"/>Enhanced input system</h1>
<p>Every game requires <a id="_idIndexMarker898"/>input from the player, whether it is the keys on a keyboard such as <em class="italic">W</em>, <em class="italic">A</em>, <em class="italic">S</em>, and <em class="italic">D</em> for moving the player character, or the thumb sticks on a controller; this is what makes video games an interactive experience. We will be using the Enhanced Input System to add an input binding for the sprint action of the player character. For a refresher on how to enable and set up the Enhanced Input System plugin, please review <a href="B18531_04.xhtml#_idTextAnchor099"><em class="italic">Chapter 4</em></a>, <em class="italic">Getting Started with Player Input</em>; moving forward, the exercises in this chapter assume you have enabled the plugin.</p>
<p>UE5 allows us to map keyboard, mouse, gamepad, and other types of controls to labeled actions or axes that you can then reference in Blueprints or C++ to allow character or gameplay functionality to occur. It is important to point out that each unique action or axis mapping can have one or more key bindings, and that the same key binding can be used for multiple mappings. Input bindings are saved into an initialization file called <strong class="source-inline">DefaultInput.ini</strong> and can be found in the <strong class="source-inline">Config</strong> folder of your project directory.</p>
<p class="callout-heading">Note</p>
<p class="callout">Legacy input bindings can be edited directly via the <strong class="source-inline">DefaultInput.ini</strong> file or through <strong class="bold">Project Settings</strong> in the editor itself. The latter is more easily accessible and less error-prone when editing.</p>
<p>In the next exercise, we’ll add a new input binding for the player character’s <strong class="source-inline">Sprint</strong> functionality.</p>
<h2 id="_idParaDest-208"><a id="_idTextAnchor236"/>Exercise 11.04 – adding input for sprinting</h2>
<p>With the <a id="_idIndexMarker899"/>player character moving around the<a id="_idIndexMarker900"/> level, you will now implement a unique character class for the player character that derives from the base <strong class="source-inline">SuperSideScrollerCharacter</strong> C++ class. The reason to do this is so that you can easily differentiate between classes of the player character and the enemy later on, instead of relying solely on unique Blueprint classes. </p>
<p>While creating the unique C++ character class, you will implement the <em class="italic">sprinting</em> behavior to allow the player character to <em class="italic">walk</em> and <em class="italic">sprint</em> as desired.</p>
<p>Let’s begin by implementing the <strong class="source-inline">Sprinting</strong> mechanic by adding an <strong class="source-inline">Input Action</strong> for <strong class="source-inline">Sprint</strong>:</p>
<ol>
<li value="1">Navigate to the <strong class="bold">Content Drawer</strong> window and, under the <strong class="source-inline">Content</strong> directory, add a new folder called <strong class="source-inline">Input</strong>.</li>
<li>In the <strong class="bold">Input</strong> directory, create another folder called <strong class="source-inline">Sprint</strong>. It is in this directory that we will create both the <strong class="source-inline">Input Action</strong> and <strong class="source-inline">Input Mapping Context</strong> assets.</li>
<li>In the <strong class="source-inline">Sprint</strong> folder, right-click and find the <strong class="bold">Input Action</strong> option, under the <strong class="bold">Input</strong> category<a id="_idIndexMarker901"/> of the menu, as shown<a id="_idIndexMarker902"/> here:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer325">
<img alt="Figure 11.27 – The Input Action class " height="158" src="image/Figure_11.27_B18531.jpg" width="876"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.27 – The Input Action class</p>
<ol>
<li value="4">Name this <strong class="bold">Input Action</strong> <strong class="source-inline">IA_Sprint</strong> and open the asset.</li>
<li>Under the <strong class="bold">Triggers</strong> section, add a new <strong class="bold">Trigger</strong> by left-clicking on the <strong class="bold">+</strong> icon. Under the <strong class="bold">Index[0]</strong> parameter, select the <strong class="bold">Down</strong> type:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer326">
<img alt="Figure 11.28 – The IA_Sprint Input Action class using the Down Trigger type " height="268" src="image/Figure_11.28_B18531.jpg" width="879"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.28 – The IA_Sprint Input Action class using the Down Trigger type</p>
<p>Now that we have our <strong class="bold">Input Action</strong>, let’s create the <strong class="bold">Input Mapping Context</strong> asset and add the action to it. </p>
<ol>
<li value="6">In the <strong class="bold">Input</strong> directory, right-click and find the <strong class="bold">Input Mapping Context</strong> option, under the <strong class="bold">Input</strong> category of the menu, as shown here:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer327">
<img alt="Figure 11.29 – The Input Mapping Context class " height="227" src="image/Figure_11.29_B18531.jpg" width="770"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.29 – The Input Mapping Context class</p>
<ol>
<li value="7">Name<a id="_idIndexMarker903"/> this <strong class="bold">Input Mapping Context</strong> <strong class="source-inline">IC_SideScrollerCharacter</strong> and <a id="_idIndexMarker904"/>open the asset.</li>
<li>In the <strong class="bold">Mappings</strong> section, add a new mapping by left-clicking the <strong class="bold">+</strong> icon and then assigning <strong class="source-inline">IA_Sprint</strong>.</li>
<li>Next, we want to assign <em class="italic">Left Shift</em> as the binding to use for sprinting. </li>
<li>In the <strong class="bold">Triggers</strong> section, add a new <strong class="bold">Trigger</strong> by left-clicking on the <strong class="bold">+</strong> icon. Under the <strong class="bold">Index[0]</strong> parameter, select <strong class="bold">Down</strong>. The final <strong class="bold">Input Mapping Context</strong> should look like this:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer328">
<img alt="Figure 11.30 – IC_SideScrollerCharacter using the IA_Sprint Input Action mapping " height="276" src="image/Figure_11.30_B18531.jpg" width="861"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.30 – IC_SideScrollerCharacter using the IA_Sprint Input Action mapping</p>
<p>With the <strong class="source-inline">Sprint</strong> input binding in place, you need to create a new C++ class for the player character based on the <strong class="source-inline">SuperSideScrollerCharacter</strong> class.</p>
<ol>
<li value="11">Make sure that you update the <strong class="source-inline">SuperSideScroller.Build.cs</strong> file so that it <a id="_idIndexMarker905"/>includes<a id="_idIndexMarker906"/> the Enhanced Input plugin; otherwise, your code will not compile. Add the following line inside the <strong class="source-inline">public SuperSideScroller(ReadOnlyTargetRues Target) : base(Target)</strong> function:</li>
</ol>
<p><strong class="source-inline">PrivateDependencyModuleNames.AddRange(new string[] {“EnhancedInput”});</strong></p>
<ol>
<li value="12">Then, head back inside the editor, navigate to <strong class="bold">Tools</strong>, and, from the drop-down list, select the <strong class="bold">New C++ Class</strong> option.</li>
<li>The new player character class will inherit from the <strong class="source-inline">SuperSideScrollerCharacter</strong> parent class because this base class contains the majority of the functionality needed for the player character. After selecting the parent class, click <strong class="bold">Next</strong>. The following screenshot shows where you can find the <strong class="source-inline">SuperSideScrollerCharacter</strong> class:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer329">
<img alt="Figure 11.31 – Selecting the SuperSideScrollerCharacter parent class " height="572" src="image/Figure_11.31_B18531.jpg" width="1016"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.31 – Selecting the SuperSideScrollerCharacter parent class</p>
<ol>
<li value="14">Name this<a id="_idIndexMarker907"/> new<a id="_idIndexMarker908"/> class <strong class="source-inline">SuperSideScroller_Player</strong>. Leave the path as the default that Unreal Engine provides for you unless you need to adjust the file directory of this new class. After naming the new class and selecting the directory to save the class in, click <strong class="source-inline">Create Class</strong>.</li>
</ol>
<p>After selecting <strong class="source-inline">Create Class</strong>, Unreal Engine will generate the source and header files for you, and Visual Studio will automatically open these files. You will notice that both the header file and the source file are almost empty. This is OK because you are inheriting from the <strong class="source-inline">SuperSideScrollerCharacter</strong> class and much of the logic you want is done in that class.</p>
<ol>
<li value="15">In <strong class="source-inline">SuperSideScroller_Player</strong>, you will only add the functionality you need on top of what you inherit. You can view the line where the inheritance is taking place inside <strong class="source-inline">SuperSideScroller_Player.h</strong>:<p class="source-code">class SUPERSIDESCROLLER_API ASuperSideScroller_Player : public ASuperSideScrollerCharacter</p></li>
</ol>
<p>This class declaration is saying that the new <strong class="source-inline">ASuperSideScroller_Player</strong> class inherits from the <strong class="source-inline">ASuperSideScrollerCharacter</strong> class.</p>
<p>By completing this exercise, you added an <strong class="bold">Enhanced Input Binding</strong> for the <strong class="source-inline">Sprint</strong> mechanic that can then be referenced in C++ and used to allow the player to sprint. Now that you have also created the C++ class for the player character, you can update the code with the <strong class="source-inline">Sprint</strong> functionality, but first, you will need to update the <strong class="source-inline">Blueprint</strong> character and the Animation Blueprint to reference this new class. We’ll do this in the next exercise.</p>
<p>What happens when you reparent a Blueprint to a new class? Each Blueprint inherits from a parent class. In most cases, this is <strong class="source-inline">Actor</strong>, but in the case of your character Blueprint, its parent class is <strong class="source-inline">SuperSideScrollerCharacter</strong>. Inheriting from a parent class allows a Blueprint to inherit the functionality and variables of that class so that the logic can be reused at the Blueprint level. </p>
<p>For<a id="_idIndexMarker909"/> example, when <a id="_idIndexMarker910"/>inheriting from the <strong class="source-inline">SuperSideScrollerCharacter</strong> class, the Blueprint inherits components such as the <strong class="source-inline">CharacterMovement</strong> component and the <strong class="source-inline">Mesh</strong> skeletal mesh component, which can then be modified in the Blueprint. </p>
<h2 id="_idParaDest-209"><a id="_idTextAnchor237"/>Exercise 11.05 – reparenting the character Blueprint</h2>
<p>Now that you have <a id="_idIndexMarker911"/>created a new character class for the player character, you need to update the <strong class="source-inline">BP_SuperSideScroller_MainCharacter</strong> Blueprint so that it uses the <strong class="source-inline">SuperSideScroller_Player</strong> class as its parent class. If you don’t, then any logic you add to the new class will not affect the character made in the Blueprint.</p>
<p>Follow these steps to reparent the Blueprint to the new character class:</p>
<ol>
<li value="1">Navigate to <strong class="source-inline">/Game/MainCharacter/Blueprints/</strong> and open the <strong class="source-inline">BP_SuperSideScroller_MainCharacter</strong> Blueprint.</li>
<li>Select the <strong class="bold">File</strong> option on the toolbar and, from the drop-down menu, select the <strong class="bold">Reparent Blueprint</strong> option.</li>
<li>When selecting the <strong class="bold">Reparent Blueprint</strong> option, Unreal Engine will ask for the new class to reparent the Blueprint to. Search for <strong class="source-inline">SuperSideScroller_Player</strong> and select that option from the dropdown by left-clicking.</li>
</ol>
<p>Once you select the new parent class for the Blueprint, Unreal Engine will reload the Blueprint and recompile it, both of which will happen automatically. </p>
<p class="callout-heading">Note</p>
<p class="callout">Be careful when reparenting Blueprints to new parent classes as this can lead to compile errors or settings to be erased or reverted to class defaults. Unreal Engine will display any warnings or errors that may occur after compiling the Blueprint and reparenting it to a new class. These warnings and errors usually occur if there is Blueprint logic that references variables or other class members that no longer exist in the new parent class. Even if there are no compile errors, it is best to confirm that any logic or settings you have added to your Blueprint are still present after the reparenting before moving on with your work.</p>
<p>Now that your<a id="_idIndexMarker912"/> character Blueprint has been correctly reparented to the new <strong class="source-inline">SuperSideScroller_Player</strong> class, you need to update the <strong class="source-inline">AnimBP_SuperSideScroller_MainCharacter</strong> Animation Blueprint to ensure that you are casting to the correct class when using the <strong class="source-inline">Try Get Pawn Owner</strong> function.</p>
<ol>
<li value="4">Next, navigate to the <strong class="source-inline">/MainCharacter/Blueprints/</strong> directory and open the <strong class="source-inline">AnimBP_SuperSideScroller_MainCharacter</strong> Animation Blueprint. </li>
<li>Open <strong class="bold">Event Graph</strong>. From the <strong class="source-inline">Return Value</strong> property of the <strong class="source-inline">Try Get Pawn Owner</strong> function, search for <strong class="source-inline">Cast</strong> <strong class="source-inline">to</strong> <strong class="source-inline">SuperSideScroller_Player</strong>:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer330">
<img alt="Figure 11.32 – Casting to the new SuperSideScroller_Player class " height="560" src="image/Figure_11.32_B18531.jpg" width="1225"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.32 – Casting to the new SuperSideScroller_Player class</p>
<ol>
<li value="6">Now, you can connect the output as a <strong class="source-inline">SuperSideScroller_Player</strong> cast to the <strong class="source-inline">MainCharacter</strong> variable. This works because the <strong class="source-inline">MainCharacter</strong> variable is of the <strong class="source-inline">SuperSideScrollerCharacter</strong> type and the new <strong class="source-inline">SuperSideScroller_Player</strong> class inherits from that class:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer331">
<img alt="Figure 11.33 – You can still use the MainCharacter variable because SuperSideScroller_Player is based on SuperSideScrollerCharacter due to inheritance " height="416" src="image/Figure_11.33_B18531.jpg" width="1242"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.33 – You can still use the MainCharacter variable because SuperSideScroller_Player is based on SuperSideScrollerCharacter due to inheritance</p>
<p>Now that <a id="_idIndexMarker913"/>both the <strong class="source-inline">BP_SuperSideScroller_MainCharacter</strong> character Blueprint and the <strong class="source-inline">AnimBP_SuperSideScroller_MainCharacter</strong> Animation Blueprint are referencing your new <strong class="source-inline">SuperSideScroller_Player</strong> class, it is safe to venture into C++ and code the character’s sprint functionality.</p>
<h2 id="_idParaDest-210"><a id="_idTextAnchor238"/>Exercise 11.06 – coding the character’s sprint functionality</h2>
<p>With the <a id="_idIndexMarker914"/>new <strong class="source-inline">SuperSideScroller_Player</strong> class reference correctly implemented in a Blueprint, it is time to start coding the functionality that will allow the player character to sprint. </p>
<p>Follow these steps to add the <strong class="source-inline">Sprinting</strong> mechanic to the character:</p>
<ol>
<li value="1">The first thing to take care of is the constructor of the <strong class="source-inline">SuperSideScroller_Player</strong> class. Navigate back to Visual Studio and open the <strong class="source-inline">SuperSideScroller_Player.h</strong> header file.</li>
<li>You will use the <strong class="source-inline">constructor</strong> function later in this exercise to set initialized values for variables. For now, it will be an empty constructor. Make sure that the declaration is made under the <strong class="source-inline">public</strong> access modifier heading, as shown in the following code:<p class="source-code">//Constructor</p><p class="source-code">ASuperSideScroller_Player();</p></li>
<li>With the constructor declared, create the constructor function definition in the <strong class="source-inline">SuperSideScroller_Player.cpp</strong> source file:<p class="source-code">ASuperSideScroller_Player::ASuperSideScroller_Player()</p><p class="source-code">{</p><p class="source-code">}</p></li>
</ol>
<p>With the constructor in place, it’s time to create the <strong class="source-inline">SetupPlayerInputComponent</strong> function so that you can use the key bindings you created earlier to call functions within the <strong class="source-inline">SuperSideScroller_Player</strong> class.</p>
<p>The <strong class="source-inline">SetupPlayerInputComponent</strong> function is a function that the character class has built-in by default, so you need to declare it as a <strong class="source-inline">virtual</strong> function with the <strong class="source-inline">override</strong> specifier. This tells Unreal Engine that you are using this function and intend to redefine its functionality in this new class. Make sure that the declaration is made under the <strong class="source-inline">Protected</strong> access modifier heading.</p>
<ol>
<li value="4">The <strong class="source-inline">SetupPlayerInputComponent</strong> function requires an object of the <strong class="source-inline">UInputComponent</strong> class to be passed into the function, like so:<p class="source-code">protected:</p><p class="source-code">//Override base character class function to setup our </p><p class="source-code">//player </p><p class="source-code">  input component</p><p class="source-code">virtual void SetupPlayerInputComponent(class UInputComponent* </p><p class="source-code">  PlayerInputComponent) override;</p></li>
</ol>
<p>The <strong class="source-inline">UInputComponent* PlayerInputComponent</strong> variable is inherited from<a id="_idIndexMarker915"/> the <strong class="source-inline">UCharacter</strong> base class that our <strong class="source-inline">ASuperSideScroller_Player()</strong> class derives from, so it must be used as the input parameter of the <strong class="source-inline">SetupPlayerInputComponent()</strong> function. Using any other name will result in a compilation error.</p>
<ol>
<li value="5">Now, in the source file, create the definition of the <strong class="source-inline">SetupPlayerInputComponent</strong> function. In the body of the function, we will use the <strong class="source-inline">Super</strong> keyword to call it:<p class="source-code">//Not always necessary, but good practice to call the </p><p class="source-code">//function inthe base class with Super.</p><p class="source-code">Super::SetupPlayerInputComponent(PlayerInputComponent);</p></li>
</ol>
<p>The <strong class="source-inline">Super</strong> keyword enables us to call the <strong class="source-inline">SetupPlayerInputComponent</strong> parent method. With the <strong class="source-inline">SetupPlayerInputComponent</strong> function ready, you need to include the following header files to continue with this exercise without any compile errors:</p>
<ul>
<li><strong class="source-inline">#include “Components/InputComponent.h”</strong></li>
<li><strong class="source-inline">#include “GameFramework/CharacterMovementComponent.h”</strong></li>
</ul>
<p>You will need to include the header for the input component to bind the key mappings to the sprint functions you will be creating next. The header for the <strong class="source-inline">Character Movement</strong> component will be necessary for the sprint functions because you will be updating the <strong class="source-inline">Max Walk Speed</strong> parameter based on whether the player is sprinting. The following code contains all of the headers that need to be<a id="_idIndexMarker916"/> included for the player character:</p>
<p class="source-code">#include "SuperSideScroller_Player.h"</p>
<p class="source-code">#include "Components/InputComponent"</p>
<p class="source-code">#include "GameFramework/CharacterMovementComponent.h"</p>
<p>With the necessary headers included in the source file of the <strong class="source-inline">SuperSideScroller_Player</strong> class, you can create the sprint functions to make the player character move faster. Let’s begin by declaring the required variable and functions.</p>
<ol>
<li value="6">Under the <strong class="source-inline">Private</strong> access modifier in the header file of the <strong class="source-inline">SuperSideScroller_Player</strong> class, declare a new Boolean variable called <strong class="source-inline">bIsSprinting</strong>. This variable will be used as a failsafe so that you know whether the player character is sprinting before making any changes to the movement speed:<p class="source-code">private:</p><p class="source-code">//Bool to control if we are sprinting. Failsafe.</p><p class="source-code">bool bIsSprinting;</p></li>
<li>Next, declare two new functions, <strong class="source-inline">Sprint();</strong> and <strong class="source-inline">StopSprinting();</strong>. These two functions will not take any arguments and will not return anything. Declare these functions under the <strong class="source-inline">Protected</strong> access modifier: <p class="source-code">//Sprinting</p><p class="source-code">void Sprint();</p><p class="source-code">//StopSprinting</p><p class="source-code">void StopSprinting();</p></li>
</ol>
<p>The <strong class="source-inline">Sprint();</strong> function will be called when the player presses/holds the <strong class="source-inline">Sprint</strong> key <a id="_idIndexMarker917"/>mapped to the binding; <strong class="source-inline">StopSprinting()</strong> will be called when the player releases the key mapped to the binding. </p>
<ol>
<li value="8">Start with the definition of the <strong class="source-inline">Sprint();</strong> function. In the source file of the <strong class="source-inline">SuperSideScroller_Player</strong> class, create the definition for this function, as shown here:<p class="source-code">void ASuperSideScroller_Player::Sprint()</p><p class="source-code">{</p><p class="source-code">}</p></li>
<li>Within the function, you will want to check the value of the <strong class="source-inline">bIsSprinting</strong> variable. If the player is <em class="italic">NOT</em> sprinting, meaning that <strong class="source-inline">bIsSprinting</strong> is <strong class="source-inline">False</strong>, then you can create the rest of the function. </li>
<li>Within the <strong class="source-inline">If</strong> statement, set the <strong class="source-inline">bIsSprinting</strong> variable to <strong class="source-inline">True</strong>. Then, access the <strong class="source-inline">GetCharacterMovement()</strong> function and modify the <strong class="source-inline">MaxWalkSpeed</strong> parameter. Set <strong class="source-inline">MaxWalkSpeed</strong> to <strong class="source-inline">500.0f</strong>. Remember that the <strong class="source-inline">Maximum Axis Value</strong> parameter of the movement Blend Space is <strong class="source-inline">500.0f</strong>. This means that the player character will reach the speed necessary to use the <strong class="source-inline">Running</strong> animation:<p class="source-code">void ASuperSideScroller_Player::Sprint()</p><p class="source-code">{</p><p class="source-code">    if (!bIsSprinting)</p><p class="source-code">      {</p><p class="source-code">        bIsSprinting = true;</p><p class="source-code">        GetCharacterMovement()-&gt;MaxWalkSpeed = 500.0f;</p><p class="source-code">      }</p><p class="source-code">}</p></li>
</ol>
<p>The <strong class="source-inline">StopSprinting()</strong> function will look almost identical to the <strong class="source-inline">Sprint()</strong> function you<a id="_idIndexMarker918"/> just wrote, but it works in the opposite manner. First, you want to check whether the player is sprinting, meaning that <strong class="source-inline">bIsSprinting</strong> is <strong class="source-inline">True</strong>. If so, you can create the rest of the function. </p>
<ol>
<li value="11">Inside the <strong class="source-inline">If</strong> statement, set <strong class="source-inline">bIsSprinting</strong> to <strong class="source-inline">False</strong>. Then, access the <strong class="source-inline">GetCharacterMovement()</strong> function to modify <strong class="source-inline">MaxWalkSpeed</strong>. Set <strong class="source-inline">MaxWalkSpeed</strong> back to <strong class="source-inline">300.0f</strong>, which is the default speed for the player character when they’re walking. This means that the player character will only reach the speed that’s necessary for the <strong class="source-inline">Walking</strong> animation:<p class="source-code">void ASuperSideScroller_Player::StopSprinting()</p><p class="source-code">{</p><p class="source-code">   if (bIsSprinting)</p><p class="source-code">    {</p><p class="source-code">     bIsSprinting = false;</p><p class="source-code">      GetCharacterMovement()-&gt;MaxWalkSpeed = 300.0f;</p><p class="source-code">    }</p><p class="source-code">}</p></li>
</ol>
<p>Now that you have the functions needed for sprinting, it is time to bind these functions to the action mappings you created earlier. To do this, you need to create variables that hold a reference to the Input Mapping Context and Input Action that were created earlier in this chapter.</p>
<ol>
<li value="12">Inside the <strong class="source-inline">SuperSideScroller_Player</strong> header file, under the <strong class="bold">Protected</strong> category, add the following lines of code to create the properties for the Input Mapping <a id="_idIndexMarker919"/>Context and Input Action:<p class="source-code">UPROPERTY(EditAnywhere, Category = "Input")</p><p class="source-code">class UInputMappingContext* IC_Character;</p><p class="source-code">UPROPERTY(EditAnywhere, Category = "Input")</p><p class="source-code">class UInputAction* IA_Sprint;</p></li>
</ol>
<p>We must remember to assign these properties within our character Blueprint before we attempt to test the sprinting functionality.</p>
<ol>
<li value="13">Next, inside the <strong class="source-inline">SuperSideScroller_Player</strong> source file, within the <strong class="source-inline">SetupPlayerInputComponent()</strong> function, we need to get a reference to the Enhanced Input Component by writing the following code:<p class="source-code">UEnhancedInputComponent* EnhancedPlayerInput = Cast&lt;UEnhancedInputComponent&gt;(PlayerInputComponent);</p></li>
</ol>
<p>Now that we are referencing <strong class="source-inline">UEnhancedInputComponent</strong>, we need to remember to include this class as well:</p>
<p class="source-code">#include "EnhancedInputComponent.h"</p>
<p>Since we want to support both legacy input and the Enhanced Input System, let’s add a specific <strong class="source-inline">if</strong> statement to our code to check if the <strong class="source-inline">EnhancedPlayerInput</strong> variable is valid:</p>
<p class="source-code">if(EnhancedPlayerInput)</p>
<p class="source-code">{}</p>
<p>If the <strong class="source-inline">EnhancedPlayerInput</strong> variable is valid, then we want to get a reference to our Player Controller so that we can get access to the <strong class="source-inline">EnhancedInputLocalPlayerSubsystem</strong> class, which will allow us to assign our Input Mapping Context:</p>
<p class="source-code">if(EnhancedPlayerInput)</p>
<p class="source-code">{</p>
<p class="source-code">   APlayerController* PlayerController = </p>
<p class="source-code">   Cast&lt;APlayerController&gt;(GetController());</p>
<p class="source-code">UEnhancedInputLocalPlayerSubsystem* EnhancedSubsystem = ULocalPlayer::GetSubsystem&lt;UEnhancedInputLocal PlayerSubsystem&gt; (PlayerController-&gt;GetLocalPlayer());</p>
<p class="source-code">}</p>
<ol>
<li value="14">Now that <a id="_idIndexMarker920"/>we are referencing the <strong class="source-inline">UEnhancedInputLocalPlayerSubsystem</strong> class, we need to add the following <strong class="source-inline">include</strong> header file:<p class="source-code">#include "EnhancedInputSubsystems.h"</p></li>
<li>Finally, we will add another <strong class="source-inline">if</strong> statement that checks if the <strong class="source-inline">EnhancedSubsystem</strong> variable is valid and then call the <strong class="source-inline">AddMappingContext</strong> function to add our <strong class="source-inline">IC_Character</strong> Input Mapping Context to our Player Controller:<p class="source-code">if(EnhancedSubsystem)</p><p class="source-code">{</p><p class="source-code">   EnhancedSubsystem-&gt;AddMappingContext(IC_Character, </p><p class="source-code">   1);</p><p class="source-code">}</p></li>
</ol>
<p>Now that we have applied the Input Mapping Context to the player characters’ <strong class="source-inline">EnhancedSubsystem</strong>, we can bind the <strong class="source-inline">Sprint()</strong> and <strong class="source-inline">StopSprinting()</strong> functions to the Input Action we created earlier.</p>
<ol>
<li value="16">At the end of the <strong class="source-inline">if(EnhancedPlayerInput)</strong> statement, we will add a <strong class="source-inline">BindAction</strong> to bind <strong class="source-inline">ETriggerEvent::Triggered</strong> to the <strong class="source-inline">Sprint()</strong> function:<p class="source-code">//Bind pressed action Sprint to your Sprint function</p><p class="source-code">EnhancedPlayerInput-&gt;BindAction(IA_Sprint, ETriggerEvent::Triggered, this, &amp;ASuperSideScroller_Player::Sprint);</p></li>
<li>Finally, we <a id="_idIndexMarker921"/>can add our <strong class="source-inline">BindAction</strong> to bind <strong class="source-inline">ETriggerEvent::Completed</strong> to the <strong class="source-inline">StopSprinting()</strong> function:<p class="source-code">//Bind released action Sprint to your StopSprinting </p><p class="source-code">//function</p><p class="source-code">EnhancedPlayerInput-&gt;BindAction(IA_Sprint, ETriggerEvent::Completed, this, &amp;ASuperSideScroller_Player::StopSprinting);</p></li>
</ol>
<p class="callout-heading">Note</p>
<p class="callout">For more information regarding the <strong class="source-inline">ETriggerEvent</strong> enumerator type, as well as more details about the Enhanced Input System, please revisit <a href="B18531_04.xhtml#_idTextAnchor099"><em class="italic">Chapter 4</em></a>, <em class="italic">Getting Started with Player Input</em>, or refer to the following documentation from Epic Games: <a href="https://docs.unrealengine.com/5.0/en-US/GameplayFeatures/EnhancedInput/%0D">https://docs.unrealengine.com/5.0/en-US/GameplayFeatures/EnhancedInput/.</a></p>
<p>With <strong class="source-inline">Action Mappings</strong> bound to the sprint functions, the last thing you need to do is set the default initialized values of the <strong class="source-inline">bIsSprinting</strong> variable and the <strong class="source-inline">MaxWalkSpeed</strong> parameter from the <strong class="source-inline">Character Movement</strong> component.</p>
<ol>
<li value="18">Inside the <strong class="source-inline">constructor</strong> function in the source file of your <strong class="source-inline">SuperSideScroller_Player</strong> class, add the <strong class="source-inline">bIsSprinting = false</strong> line. This variable is constructed as false because the player character should not be sprinting by default.</li>
<li>Finally, set the <strong class="source-inline">MaxWalkSpeed</strong> parameter of the character movement component to <strong class="source-inline">300.0f</strong> by adding <strong class="source-inline">GetCharacterMovement()-&gt;MaxWalkSpeed = 300.0f</strong>. Please<a id="_idIndexMarker922"/> review the following code:<p class="source-code">ASuperSideScroller_Player::ASuperSideScroller_Player()</p><p class="source-code">{</p><p class="source-code">  //Set sprinting to false by default.</p><p class="source-code">   bIsSprinting = false;</p><p class="source-code">  //Set our max Walk Speed to 300.0f</p><p class="source-code">   GetCharacterMovement()-&gt;MaxWalkSpeed = 300.0f;</p><p class="source-code">}</p></li>
</ol>
<p>With the variables that have been added to the constructor initialized, the <strong class="source-inline">SuperSideScroller_Player</strong> class is done, for now. Return to Unreal Engine and left-click on the <strong class="bold">Compile</strong> button on the toolbar. This will recompile the code and perform a hot-reload of the editor. </p>
<p>After recompiling and hot-reloading the editor, we need to remember to assign both the Input Mapping Context and the Input Action inside our player character.</p>
<ol>
<li value="20">Navigate to the <strong class="source-inline">MainCharacter/Blueprints</strong> directory and open the <strong class="source-inline">BP_SuperSideScroller_MainCharacter</strong> Blueprint.</li>
<li>In the <strong class="bold">Details</strong> panel, under the <strong class="bold">Input</strong> category, you will find parameters for <strong class="source-inline">IC_Character</strong> and <strong class="source-inline">IA_Sprint</strong>. Assign the Input Context Mapping and Input Action assets we created earlier to these parameters:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer332">
<img alt="Figure 11.34 – The IC_Character and IA_Sprint parameters " height="177" src="image/Figure_11.34_B18531.jpg" width="675"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.34 – The IC_Character and IA_Sprint parameters</p>
<p>Upon <a id="_idIndexMarker923"/>compiling the <strong class="source-inline">BP_SuperSideScroller_MainCharacter</strong> Blueprint, you can use <strong class="bold">Play In Editor</strong> to see the fruits of your labor. The base movement behavior is the same as it was previously, but now, if you hold <em class="italic">Left Shift</em> or <em class="italic">Gamepad Right Shoulder</em> on a controller, the player character will sprint and begin to play the <strong class="source-inline">Running</strong> animation:</p>
<div>
<div class="IMG---Figure" id="_idContainer333">
<img alt="Figure 11.35 – The player character can now sprint " height="581" src="image/Figure_11.35_B18531.jpg" width="1149"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.35 – The player character can now sprint</p>
<p>With the player <a id="_idIndexMarker924"/>character able to sprint, let’s move on to the next activity, where you will implement the base <strong class="source-inline">Throw</strong> functionality in a very similar way.</p>
<h2 id="_idParaDest-211"><a id="_idTextAnchor239"/>Activity 11.03 – implementing the throwing input</h2>
<p>One of the features<a id="_idIndexMarker925"/> included with this game is the ability for the player to throw projectiles at the enemy. You won’t be creating the projectile or implementing the animation in this chapter, but you will set up the key bindings and the C++ implementation for use in the next chapter. </p>
<p>In this activity, you need to set up the Enhanced Input Mapping for the <strong class="source-inline">Throw</strong> projectile functionality and implement a debug log in C++ for when the player presses the key(s) mapped to <strong class="source-inline">Throw</strong>.</p>
<p>Follow these steps to complete this activity:</p>
<ol>
<li value="1">Create a new folder inside of the <strong class="bold">Input</strong> directory named <strong class="source-inline">Throw</strong>, and create a new <strong class="bold">Input Action</strong> called <strong class="source-inline">IA_Throw</strong>.</li>
<li>Use the <strong class="source-inline">Trigger</strong> type called <strong class="source-inline">Pressed</strong> inside <strong class="source-inline">IA_Throw</strong>.</li>
<li>Add the new <strong class="source-inline">IA_Throw</strong> <strong class="bold">Input Action</strong> to <strong class="source-inline">IC_SideScrollerCharacter</strong> with bindings to both <strong class="source-inline">Left Mouse Button</strong> and <strong class="source-inline">Gamepad Right Trigger</strong>.</li>
<li>Within Visual Studio, add a new <strong class="source-inline">UInputAction</strong> variable called <strong class="source-inline">IA_Throw</strong> and add the appropriate <strong class="source-inline">UPROPERTY()</strong> macro to the variable.</li>
<li>Add a new function to the header file of <strong class="source-inline">SuperSideScroller_Player</strong>. Name this function <strong class="source-inline">ThrowProjectile()</strong>. This will be a void function without parameters.</li>
<li>Create the definition in the source file of the <strong class="source-inline">SuperSideScroller_Player</strong> class. In the definition of this function, use <strong class="source-inline">UE_LOG</strong> to print a message that lets you know that the function is being called successfully.</li>
<li>Add a new <strong class="source-inline">BindAction</strong> function call using the <strong class="source-inline">EnhancedPlayerInput</strong> variable to <a id="_idIndexMarker926"/>bind the new <strong class="source-inline">Throw</strong> <strong class="bold">Input Action</strong> to the <strong class="source-inline">ThrowProjectile()</strong> function.</li>
</ol>
<p class="callout-heading">Note</p>
<p class="callout">You can learn more about <strong class="source-inline">UE_LOG</strong> here: <a href="https://nerivec.github.io/old-ue4-wiki/pages/logs-printing-messages-to-yourself-during-runtime.xhtml">https://nerivec.github.io/old-ue4-wiki/pages/logs-printing-messages-to-yourself-during-runtime.xhtml</a>.</p>
<ol>
<li value="8">Compile the code and return to the editor. Next, add <strong class="source-inline">IA_Throw</strong> to the <strong class="source-inline">BP_SuperSideScroller_MainCharacter</strong> parameter, <strong class="source-inline">IA_Throw</strong>.</li>
</ol>
<p>The expected result is that when you use the <em class="italic">left mouse button</em> or the <em class="italic">gamepad right trigger</em>, a log will appear in <strong class="source-inline">Output Log</strong>, letting you know that the <strong class="source-inline">ThrowProjectile</strong> function is being called successfully. You will use this function later to spawn your projectile.</p>
<p>The expected output is as follows:</p>
<div>
<div class="IMG---Figure" id="_idContainer334">
<img alt="Figure 11.36 – The expected output log " height="223" src="image/Figure_11.36_B18531.jpg" width="736"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.36 – The expected output log</p>
<p class="callout-heading">Note</p>
<p class="callout">The solution to this activity can be found on GitHub here: <a href="https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition/tree/main/Activity%20solutions">https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition/tree/main/Activity%20solutions</a>.</p>
<p>With this activity complete, you now have functionality in place for when you create the player projectile in <a href="B18531_13.xhtml#_idTextAnchor268"><em class="italic">Chapter 13</em></a>, <em class="italic">Creating and Adding the Enemy Artificial Intelligence</em>. You also have the knowledge and experience of adding new key mappings to your game and implementing functionality in C++ that utilizes these mappings to enable gameplay functionality. Now, you will continue<a id="_idIndexMarker927"/> updating the player character’s movement to allow the jumping animation to play correctly when the player jumps. But first, let’s take a moment to learn about Animation State Machines.</p>
<h1 id="_idParaDest-212"><a id="_idTextAnchor240"/>Using Animation State Machines</h1>
<p>State Machines <a id="_idIndexMarker928"/>are a means of categorizing an animation, or sets of animations, into a state. A state can be thought of as a condition that the player character is in at a specific time. Is the player currently walking? Is the player jumping? In many third-person games such as <em class="italic">The Last of Us</em>, this involves separating the movement, jumping, crouching, and climbing animations into their own states. Each state is then accessible when certain conditions are met while the game is played. Conditions can include whether the player is jumping, the speed of the player character, and whether or not the player is in the crouched state. The job of the state machine is to transition between each state using logical decisions <a id="_idIndexMarker929"/>called <strong class="bold">Transition Rules</strong>. When you create multiple states with multiple Transition Rules that intertwine with one another, the state machine begins to look like a web. Please refer to the following screenshot to see what the state machine looks like for the <strong class="source-inline">ThirdPerson_AnimBP</strong> Animation Blueprint:</p>
<p class="callout-heading">Note</p>
<p class="callout">A general overview of State Machines can be found here: <a href="https://docs.unrealengine.com/en-US/Engine/Animation/StateMachines/Overview/index.xhtml">https://docs.unrealengine.com/en-US/Engine/Animation/StateMachines/Overview/index.xhtml</a>.</p>
<div>
<div class="IMG---Figure" id="_idContainer335">
<img alt="Figure 11.37 – The state machine of ThirdPerson_AnimBP " height="691" src="image/Figure_11.37_B18531.jpg" width="1148"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.37 – The state machine of ThirdPerson_AnimBP</p>
<p>In the case of the <a id="_idIndexMarker930"/>state machine for the player character, this state machine will handle the states of the default player’s movement and jumping. Currently, you have the player character animating simply by using a Blend Space that is controlled by the speed of the character. In the next exercise, you will create a new state machine and move the movement Blend Space logic into its own state within that state machine. Let’s start creating the new state machine.</p>
<h2 id="_idParaDest-213"><a id="_idTextAnchor241"/>Exercise 11.07 – player character movement and jump state machine</h2>
<p>In this exercise, you <a id="_idIndexMarker931"/>will<a id="_idIndexMarker932"/> implement a new animation state machine and integrate the existing movement Blend Space into the state machine. Additionally, you will set up the states for when the player jump starts, and for when the player is in the air during that jump.</p>
<p>Let’s start by adding this new state machine:</p>
<ol>
<li value="1">Navigate to the <strong class="source-inline">/MainCharacter/Blueprints/</strong> directory and open the <strong class="source-inline">AnimBP_SuperSideScroller_MainCharacter</strong> Animation Blueprint.</li>
<li>In <strong class="bold">AnimGraph</strong>, <em class="italic">right-click</em> in the empty space of the graph and search for <strong class="source-inline">state machine</strong> inside the context-sensitive search to find the <strong class="source-inline">Add New State Machine</strong> option. Name this new state machine <strong class="source-inline">Movement</strong>.</li>
<li>Now, instead of plugging the output pose of the <strong class="source-inline">SideScroller_IdleRun</strong> Blend Space, we can connect the output pose of the new state machine, <strong class="source-inline">Movement</strong>, to the output pose of the animation:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer336">
<img alt="Figure 11.38 – The new Movement state machine replaces the old Blend Space " height="501" src="image/Figure_11.38_B18531.jpg" width="961"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.38 – The new Movement state machine replaces the old Blend Space</p>
<p>Connecting an empty state machine to the <strong class="source-inline">Output Pose</strong> property of the Animation Blueprint will result in the warnings shown in the following screenshot. All this means is that nothing is happening within that state machine and that the result will be invalid to <strong class="source-inline">Output Pose</strong>. Don’t worry; you will fix this next:</p>
<div>
<div class="IMG---Figure" id="_idContainer337">
<img alt="Figure 11.39 – The empty state machine results in compile warnings " height="166" src="image/Figure_11.39_B18531.jpg" width="1298"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.39 – The empty state machine results in compile warnings</p>
<p>Double left-click on<a id="_idIndexMarker933"/> the <strong class="source-inline">Movement</strong> state <a id="_idIndexMarker934"/>machine to open the state machine itself. </p>
<p>You will start by adding a new state that will handle what the character was doing previously; that is <strong class="source-inline">Idle</strong>, <strong class="source-inline">Walking</strong>, or <strong class="source-inline">Running</strong>.</p>
<ol>
<li value="4">From the <strong class="source-inline">Entry</strong> point, left-click and drag out to open the context-sensitive search. You will notice that there are only two options – <strong class="source-inline">Add Conduit</strong> and <strong class="source-inline">Add State</strong>. For now, you will add a new state and name this state <strong class="source-inline">Movement</strong>. The following screenshot shows how the <strong class="source-inline">Movement</strong> state was created:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer338">
<img alt="Figure 11.40 – Inside the state machine, you need to add a new state " height="214" src="image/Figure_11.40_B18531.jpg" width="650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.40 – Inside the state machine, you need to add a new state</p>
<ol>
<li value="5">After <a id="_idIndexMarker935"/>selecting <strong class="source-inline">Add</strong> <strong class="source-inline">State</strong>, you can rename the state to <strong class="source-inline">Movement</strong> and it should automatically connect to the <strong class="source-inline">Entry</strong> node of the State Machine.</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer339">
<img alt="Figure 11.41 – The new Movement state " height="198" src="image/Figure_11.41_B18531.jpg" width="812"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.41 – The new Movement state</p>
<ol>
<li value="6">Copy and paste the logic you had where you connected the <strong class="source-inline">Speed</strong> variable to the <strong class="source-inline">SideScroller_IdleRun</strong> Blend Space into the new <strong class="source-inline">Movement</strong> state you created<a id="_idIndexMarker936"/> in the previous <a id="_idIndexMarker937"/>step. Connect it to the <strong class="source-inline">Result</strong> pin of the <strong class="source-inline">Output Animation Pose</strong> node of this state:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer340">
<img alt="Figure 11.42 – Connecting the output pose of the Blend Space to the output pose of this state " height="366" src="image/Figure_11.42_B18531.jpg" width="1015"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.42 – Connecting the output pose of the Blend Space to the output pose of this state</p>
<p>Now, if you recompile the Animation Blueprint, you will notice that the warnings you saw earlier are now gone. This is because you added a new state that outputs an animation to <strong class="source-inline">Output Animation Pose</strong> instead of having an empty state machine.</p>
<p>By completing this exercise, you have constructed your very first state machine. Although it is a very simple one, you are now telling the character to enter and use the <strong class="source-inline">Movement</strong> state by default. Now, if you use <strong class="source-inline">PIE</strong>, you will see that the player character is moving around like they were earlier before you made the state machine. This means that your state machine is functioning and that you can continue to the next step, which will be adding the<a id="_idIndexMarker938"/> initial states <a id="_idIndexMarker939"/>that are required for jumping. Let’s start by creating the <strong class="source-inline">JumpStart</strong> state.</p>
<h2 id="_idParaDest-214"><a id="_idTextAnchor242"/>Transition rules</h2>
<p>Conduits are a <a id="_idIndexMarker940"/>way of telling each state the<a id="_idIndexMarker941"/> conditions under which it can transition from one state to another. In this case, a Transition Rule is created as a connection between the <strong class="source-inline">Movement</strong> and <strong class="source-inline">JumpStart</strong> states. This is indicated by the directional arrow of the connection between the states again. The tooltip mentions the term Transition Rule, which means that you need to define how the transition between these states will happen, using a Boolean value to do so:</p>
<div>
<div class="IMG---Figure" id="_idContainer341">
<img alt="Figure 11.43 – There needs to be a Transition Rule to go from Movement to the start of JumpStart " height="385" src="image/Figure_11.43_B18531.jpg" width="867"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.43 – There needs to be a Transition Rule to go from Movement to the start of JumpStart</p>
<p>The main difference between a simple Transition Rule and a conduit is that a Transition Rule can only connect between two states, whereas a conduit can serve as a means to transition between one and many other states. For more information, please refer to the following documentation: <a href="https://docs.unrealengine.com/5.0/en-US/state-machines-in-unreal-engine/#conduits">https://docs.unrealengine.com/5.0/en-US/state-machines-in-unreal-engine/#conduits</a>.</p>
<p>In the next<a id="_idIndexMarker942"/> exercise, you will be adding this new <strong class="source-inline">JumpStart</strong> state and adding the proper Transition Rule necessary for the character to go from the <strong class="source-inline">Movement</strong> state to the <strong class="source-inline">JumpStart</strong> state.</p>
<h2 id="_idParaDest-215"><a id="_idTextAnchor243"/>Exercise 11.08 – adding states and transition rules to the state machine</h2>
<p>In the case <a id="_idIndexMarker943"/>of transitioning<a id="_idIndexMarker944"/> from<a id="_idIndexMarker945"/> the player character’s default movement Blend Space to the beginning of the jump animation, you will need to know when the player decides to jump. This can be done using a useful function called <strong class="source-inline">IsFalling</strong> from the <strong class="source-inline">Character Movement</strong> component of the player character. You will want to track whether the player is currently falling to transition in and out of jumping. The best way to do this is to store the result of the <strong class="source-inline">IsFalling</strong> function in its own variable, just like you did when tracking the player’s speed.</p>
<p>Follow these steps to complete this exercise:</p>
<ol>
<li value="1">Back in the overview of the state machine itself, left-click and drag from the edge of the <strong class="source-inline">Movement</strong> state to open the context-sensitive menu.</li>
<li>Select the <strong class="bold">Add State</strong> option and name this state <strong class="source-inline">JumpStart</strong>. When you do this, Unreal Engine will automatically connect these states and implement an empty Transition Rule for you:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer342">
<img alt="Figure 11.44 – The Transition Rule that Unreal automatically creates for you when connecting two states " height="385" src="image/Figure_11.44_B18531.jpg" width="1006"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.44 – The Transition Rule that Unreal automatically creates for you when connecting two states</p>
<ol>
<li value="3">Navigate back to <strong class="bold">Event Graph</strong> inside the Animation Blueprint, where you used the Event Blueprint update animation event to store the <strong class="source-inline">Speed</strong> value of the player <a id="_idIndexMarker946"/>character:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer343">
<img alt="Figure 11.45 – We are now storing the Vector Length of the Main Character as Speed " height="539" src="image/Figure_11.45_B18531.jpg" width="1118"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.45 – We are now storing the Vector Length of the Main Character as Speed</p>
<ol>
<li value="4">Create a <a id="_idIndexMarker947"/>getter<a id="_idIndexMarker948"/> variable for <strong class="source-inline">MainCharacter</strong> and access the <strong class="source-inline">Character Movement</strong> component. From the <strong class="source-inline">Character Movement</strong> component, left-click and drag to access the context-sensitive menu. Search for <strong class="source-inline">IsFalling</strong>:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer344">
<img alt="Figure 11.46 – How to find the IsFalling function " height="574" src="image/Figure_11.46_B18531.jpg" width="1345"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.46 – How to find the IsFalling function</p>
<ol>
<li value="5">The character movement component can tell you whether the player character is <a id="_idIndexMarker949"/>currently <a id="_idIndexMarker950"/>in <a id="_idIndexMarker951"/>the air with the help of the <strong class="source-inline">IsFalling</strong> function:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer345">
<img alt="Figure 11.47 – The Character Movement component showing the state of the player character " height="347" src="image/Figure_11.47_B18531.jpg" width="754"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.47 – The Character Movement component showing the state of the player character</p>
<ol>
<li value="6">From the <strong class="source-inline">Return Value</strong> Boolean of the <strong class="source-inline">IsFalling</strong> function, left-click and drag to search for the <strong class="bold">Promote to Variable</strong> option from the context-sensitive menu. Name this variable <strong class="source-inline">bIsInAir</strong>. When promoting to a variable, the <strong class="source-inline">Return Value</strong> output pin should automatically connect to the input pin of the newly promoted variable. If it doesn’t, remember to connect them: </li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer346">
<img alt="Figure 11.48 – A new variable, bIsInAir, that contains the value of the IsFalling function " height="402" src="image/Figure_11.48_B18531.jpg" width="594"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.48 – A new variable, bIsInAir, that contains the value of the IsFalling function</p>
<p>Now that you <a id="_idIndexMarker952"/>are storing <a id="_idIndexMarker953"/>the <a id="_idIndexMarker954"/>state of the player and whether or not they are falling, this is the perfect candidate for the Transition Rule between the <strong class="source-inline">Movement</strong> and <strong class="source-inline">JumpStart</strong> states.</p>
<ol>
<li value="7">In the <strong class="source-inline">Movement State</strong> machine, double left-click on <strong class="source-inline">Transition Rule</strong> to enter its graph. You will find only one output node, <strong class="source-inline">Result</strong>, with the <strong class="source-inline">Can Enter Transition</strong> parameter. All you need to do here is use the <strong class="source-inline">bIsInAir</strong> variable and connect it to that output. Now, <strong class="source-inline">Transition Rule</strong> is saying that if the player is in the air, the transition between the <strong class="source-inline">Movement</strong> state and the <strong class="source-inline">JumpStart</strong> states can happen:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer347">
<img alt="Figure 11.49 – When in the air, the player will transition to the start of the jumping animation " height="221" src="image/Figure_11.49_B18531.jpg" width="554"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.49 – When in the air, the player will transition to the start of the jumping animation</p>
<p>With your <strong class="source-inline">Transition Rule</strong> in place between the <strong class="source-inline">Movement</strong> and <strong class="source-inline">JumpStart</strong> states, all you must do is tell the <strong class="source-inline">JumpStart</strong> state which animation to use. </p>
<ol>
<li value="8">From the state machine graph, double left-click on the <strong class="source-inline">JumpStart</strong> state to enter <a id="_idIndexMarker955"/>its <a id="_idIndexMarker956"/>graph. From<a id="_idIndexMarker957"/> the <strong class="bold">Asset Browser</strong> window, left-click and drag the <strong class="source-inline">JumpingStart</strong> animation to the graph:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer348">
<img alt="Figure 11.50 – Ensure you have the JumpingStart animation selected in Asset Browser " height="364" src="image/Figure_11.50_B18531.jpg" width="734"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.50 – Ensure you have the JumpingStart animation selected in Asset Browser</p>
<ol>
<li value="9">Connect the output of the <strong class="source-inline">Play JumpingStart</strong> node to the <strong class="source-inline">Result</strong> pin of the <strong class="source-inline">Output Animation Pose</strong> node:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer349">
<img alt="Figure 11.51 – Connecting the JumpingStart animation to Output Animation Pose of the JumpStart state " height="236" src="image/Figure_11.51_B18531.jpg" width="744"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.51 – Connecting the JumpingStart animation to Output Animation Pose of the JumpStart state</p>
<p>Before you<a id="_idIndexMarker958"/> can <a id="_idIndexMarker959"/>move<a id="_idIndexMarker960"/> forward with the next state, some settings need to be changed on the <strong class="source-inline">JumpingStart</strong> animation node. </p>
<ol>
<li value="10">Left-click on the <strong class="source-inline">Play JumpingStart</strong> animation node and update the <strong class="bold">Details</strong> panel so that it contains the following settings:<ul><li><strong class="source-inline">Loop Animation = False</strong></li><li><strong class="source-inline">Play Rate = 2.0</strong></li></ul></li>
</ol>
<p>The following screenshot shows the final settings for the <strong class="source-inline">Play JumpingStart</strong> animation node:</p>
<div>
<div class="IMG---Figure" id="_idContainer350">
<img alt="Figure 11.52 – Increasing the play rate will result in a smoother jumping animation overall " height="407" src="image/Figure_11.52_B18531.jpg" width="702"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.52 – Increasing the play rate will result in a smoother jumping animation overall</p>
<p>Here, you<a id="_idIndexMarker961"/> are <a id="_idIndexMarker962"/>setting<a id="_idIndexMarker963"/> the <strong class="source-inline">Loop Animation</strong> parameter to <strong class="source-inline">False</strong> because there is no reason that this animation should loop; it should only play once in any case. The only way that this animation would loop is if the player character is somehow stuck in this state, but this will never happen because of the next state you will create. The reason for setting <strong class="source-inline">Play Rate</strong> to <strong class="source-inline">2.0</strong> is because the animation itself, <strong class="source-inline">JumpingStart</strong>, is too long for the game you are making. The animation has the character bend their knees drastically, and jump upward for more than a second. For the <strong class="source-inline">JumpStart</strong> state, you want the character to play this animation quicker so that it is more fluid and offers a smoother transition to the next state; that is, <strong class="source-inline">JumpLoop</strong>. To give additional context to the <strong class="source-inline">Play Rate</strong> parameter that’s available in an animation, there is both <strong class="source-inline">Play Rate</strong> and <strong class="source-inline">Play Rate Basis</strong>. The <strong class="source-inline">Play Rate Basis</strong> parameter allows you to change where the <strong class="source-inline">Play Rate</strong> parameter is expressed; so, by default, this is set to 1.0. If you wanted to, you could change this value to 10.0, meaning that the <strong class="source-inline">Play Rate</strong> input will be divided by 10. So, depending on <strong class="source-inline">Play Rate Basis</strong>, the value that’s used in <strong class="source-inline">Play Rate</strong> can lead to different results; for simplicity, we will keep <strong class="source-inline">Play Rate Basis</strong> at its default value of 1.0.</p>
<p>Once the player character has begun the <strong class="source-inline">JumpStart</strong> animation, there is a point in time during that animation where the player is in the air and should transition to a new state. This new state will loop until the player is no longer in the air and can transition into the final state of ending the jump. Next, we will create a new state that will transition from the <strong class="source-inline">JumpStart</strong> state.</p>
<ol>
<li value="11">From the state machine graph, <em class="italic">left-click</em> and drag from the <strong class="source-inline">JumpStart</strong> state and select the <strong class="source-inline">Add State</strong> option. Name this new state <strong class="source-inline">JumpLoop</strong>. Again, Unreal Engine will automatically provide you with a <strong class="source-inline">Transition Rule</strong> between <a id="_idIndexMarker964"/>these states that you will add to in the next exercise. Finally, recompile the Animation Blueprint and ignore any warnings that may appear under <strong class="bold">Compiler Results</strong>:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer351">
<img alt="Figure 11.53 – A new state to handle the animation of the character while they’re in the air  " height="481" src="image/Figure_11.53_B18531.jpg" width="867"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.53 – A new state to handle the animation of the character while they’re in the air </p>
<p>By completing this exercise, you have added and connected states for <strong class="source-inline">JumpStart</strong> and <strong class="source-inline">JumpLoop</strong>. Each of these states is connected via a <strong class="source-inline">Transition Rule</strong>. You should now have a better understanding of how states within a state machine transition from one to <a id="_idIndexMarker965"/>another via the <a id="_idIndexMarker966"/>rules <a id="_idIndexMarker967"/>established in each Transition Rule.</p>
<p>In the next exercise, you will learn how to transition from the <strong class="source-inline">JumpStart</strong> state to the <strong class="source-inline">JumpLoop</strong> state via the <strong class="source-inline">Time Remaining Ratio</strong> function.</p>
<h2 id="_idParaDest-216"><a id="_idTextAnchor244"/>Exercise 11.09 – The Time Remaining Ratio function</h2>
<p>For <a id="_idIndexMarker968"/>the <strong class="source-inline">JumpStart</strong> state to smoothly<a id="_idIndexMarker969"/> transition to the <strong class="source-inline">JumpLoop</strong> state, you need to take a moment to think about exactly how you want this transition to work. Based on how the <strong class="source-inline">JumpStart</strong> and <strong class="source-inline">JumpLoop</strong> animations work, it is best to transition to the <strong class="source-inline">JumpLoop</strong> animation after a specified set of time has elapsed on the <strong class="source-inline">JumpStart</strong> animation. That way, the <strong class="source-inline">JumpLoop</strong> state plays smoothly after <strong class="source-inline">X</strong> seconds of the <strong class="source-inline">JumpStart</strong> animation playing.</p>
<p>Perform the following steps to achieve this: </p>
<ol>
<li value="1">Double left-click on the <strong class="source-inline">Transition Rule</strong> property between <strong class="source-inline">JumpStart</strong> and <strong class="source-inline">JumpLoop</strong> to open its graph. This <strong class="source-inline">Transition Rule</strong> will check how much time is remaining from the <strong class="source-inline">JumpingStart</strong> animation. This is done because a certain percentage of time remains in the <strong class="source-inline">JumpingStart</strong> animation, and you can safely assume that the player is in the air and is ready to transition to the <strong class="source-inline">JumpingLoop</strong> animation state. </li>
<li>To do this, make sure that the <strong class="source-inline">JumpingStart</strong> animation is selected in the <strong class="bold">Asset Browser</strong> window. Then, right-click <strong class="source-inline">Event Graph</strong> of <strong class="source-inline">Transition Rule</strong> and find the <strong class="source-inline">Time Remaining Ratio</strong> function. </li>
</ol>
<p>Let’s take a moment to talk about the <strong class="source-inline">Time Remaining Ratio</strong> function and what it is doing. This function returns a float between <strong class="source-inline">0.0f</strong> and <strong class="source-inline">1.0f</strong> that tells you how much time is remaining in the specified animation. The values <strong class="source-inline">0.0f</strong> and <strong class="source-inline">1.0f</strong> can directly be translated into a percentage value so that they are easier<a id="_idIndexMarker970"/> to consider. In the <a id="_idIndexMarker971"/>case of the <strong class="source-inline">JumpingStart</strong> animation, you want to know whether less than 60% of the animation is remaining to transition successfully to the <strong class="source-inline">JumpingLoop</strong> state. This is what you will do now.</p>
<ol>
<li value="3">From the <strong class="source-inline">Return Value</strong> float output parameter of the <strong class="source-inline">Time Remaining Ratio</strong> function, search for the <strong class="source-inline">Less Than comparative operative</strong> node from the context-sensitive search menu. Since you are working with a returned value between <strong class="source-inline">0.0f</strong> and <strong class="source-inline">1.0f</strong> to find out whether less than 60% of the animation remains, you need to compare this returned value with a value of <strong class="source-inline">0.6f</strong>. The final result is as follows:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer352">
<img alt="Figure 11.54 – The new Transition Rule between the JumpingStart and JumpingLoop states " height="368" src="image/Figure_11.54_B18531.jpg" width="787"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.54 – The new Transition Rule between the JumpingStart and JumpingLoop states</p>
<p>With this <strong class="source-inline">Transition Rule</strong> in place, all you need to do is add the <strong class="source-inline">JumpLoop</strong> animation to the <strong class="source-inline">JumpLoop</strong> state. </p>
<ol>
<li value="4">In the <strong class="source-inline">Movement</strong> state machine, double left-click on the <strong class="source-inline">JumpLoop</strong> state to enter its graph. With the <strong class="source-inline">JumpLoop</strong> animation asset selected in the <strong class="bold">Asset Browser</strong> window, left-click and drag it onto the graph. Connect its output to the <strong class="source-inline">Result</strong> input of <strong class="source-inline">Output Animation Pose</strong>, as shown in the following screenshot. The<a id="_idIndexMarker972"/> default <a id="_idIndexMarker973"/>settings of the <strong class="source-inline">Play JumpLoop</strong> node will remain unchanged:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer353">
<img alt="Figure 11.55 – The JumpLoop animation connected to Output Animation Pose of the new state " height="287" src="image/Figure_11.55_B18531.jpg" width="739"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.55 – The JumpLoop animation connected to Output Animation Pose of the new state</p>
<p>With the <strong class="source-inline">JumpLoop</strong> animation in place in the <strong class="source-inline">JumpLoop</strong> state, you can compile the Animation Blueprint and PIE. You will notice that the movement and sprinting animations are still present, but what happens when you try to jump? The player character begins the <strong class="source-inline">JumpStart</strong> state and plays the <strong class="source-inline">JumpLoop</strong> animation while in the air. This is great – the state machine is working, but what happens when the player character reaches the ground and is no longer in the air? The player character does not transition back to the <strong class="source-inline">Movement</strong> state, which makes sense because you haven’t added the state for <strong class="source-inline">JumpEnd</strong>, nor the transitions between <strong class="source-inline">JumpLoop</strong> and <strong class="source-inline">JumpEnd</strong>, and from <strong class="source-inline">JumpEnd</strong> back to the <strong class="source-inline">Movement</strong> state. You will do this in the next activity. The following screenshot<a id="_idIndexMarker974"/> shows an example <a id="_idIndexMarker975"/>of a player character stuck in the <strong class="source-inline">JumpLoop</strong> state:</p>
<div>
<div class="IMG---Figure" id="_idContainer354">
<img alt="Figure 11.56 – The player character can now play the JumpingStart and JumpLoop animations " height="584" src="image/Figure_11.56_B18531.jpg" width="1158"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.56 – The player character can now play the JumpingStart and JumpLoop animations</p>
<p>By completing this exercise, you successfully transitioned from the <strong class="source-inline">JumpStart</strong> state to the <strong class="source-inline">JumpLoop</strong> state by using the <strong class="source-inline">Time Remaining Ratio</strong> function. This function allows you to know how far along an animation has played, and with this information, you had the state machine transition into the <strong class="source-inline">JumpLoop</strong> state. The player can now successfully transition from the default <strong class="source-inline">Movement</strong> state to the <strong class="source-inline">JumpStart</strong> state and then to the <strong class="source-inline">JumpLoop</strong> state. However, this results in an interesting issue: the player is now stuck in the <strong class="source-inline">JumpLoop</strong> state because the state machine does not contain the transition <a id="_idIndexMarker976"/>backs<a id="_idIndexMarker977"/> to the <strong class="source-inline">Movement</strong> state. We’ll fix this in the next activity.</p>
<h2 id="_idParaDest-217"><a id="_idTextAnchor245"/>Activity 11.04 – finishing the Movement and Jumping state machines</h2>
<p>With half of the <a id="_idIndexMarker978"/>state <a id="_idIndexMarker979"/>machine completed, it’s time to add the state for when the jump ends, as well as the Transition Rules that allow you to transition from the <strong class="source-inline">JumpLoop</strong> state to this new state, and then transition from this new state back to the <strong class="source-inline">Movement</strong> state. </p>
<p>Follow these steps to complete the <strong class="source-inline">Movement</strong> state machine:</p>
<ol>
<li value="1">Add a new state for <strong class="source-inline">Jump End</strong> that transitions from <strong class="source-inline">JumpLoop</strong>. Name this state <strong class="source-inline">JumpEnd</strong>.</li>
<li>Add the <strong class="source-inline">JumpEnd</strong> animation to the new <strong class="source-inline">JumpEnd</strong> state.</li>
<li>Based on the <strong class="source-inline">JumpEnd</strong> animation and how quickly we want to transition between the <strong class="source-inline">JumpLoop</strong>, <strong class="source-inline">JumpEnd</strong>, and <strong class="source-inline">Movement</strong> states, consider modifying the parameters of the animation like you did for the <strong class="source-inline">JumpStart</strong> animation. The <strong class="source-inline">loop animation</strong> parameter needs to be <strong class="source-inline">False</strong> and the <strong class="source-inline">Play Rate</strong> parameter needs to be set to <strong class="source-inline">3.0</strong>.</li>
<li>Add a <strong class="source-inline">Transition Rule</strong> from the <strong class="source-inline">JumpLoop</strong> state to the <strong class="source-inline">JumpEnd</strong> state based on the <strong class="source-inline">bIsInAir</strong> variable.</li>
<li>Add a <strong class="source-inline">Transition Rule</strong> from the <strong class="source-inline">JumpEnd</strong> state to the <strong class="source-inline">Movement</strong> state based on the <strong class="source-inline">Time Remaining Ratio</strong> function of the <strong class="source-inline">JumpEnd</strong> animation. (Look at the <strong class="source-inline">JumpStart</strong> to <strong class="source-inline">JumpLoop</strong> Transition Rule).</li>
</ol>
<p>By the end <a id="_idIndexMarker980"/>of<a id="_idIndexMarker981"/> this activity, you will have a fully functioning movement state machine that allows the player character to idle, walk, and sprint, as well as jump and animate correctly at the start of the jump, while in the air, and when landing.</p>
<p>The expected output is as follows:</p>
<div>
<div class="IMG---Figure" id="_idContainer355">
<img alt="Figure 11.57 – The player character can now idle, walk, sprint, and jump " height="633" src="image/Figure_11.57_B18531.jpg" width="1288"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.57 – The player character can now idle, walk, sprint, and jump</p>
<p class="callout-heading">Note</p>
<p class="callout">The solution to this activity can be found on GitHub here: <a href="https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition/tree/main/Activity%20solutions">https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition/tree/main/Activity%20solutions</a>. </p>
<p>By completing this activity, you have finished the <strong class="source-inline">Movement</strong> state machine for the player character. By adding the remaining <strong class="source-inline">JumpEnd</strong> state and <strong class="source-inline">Transition Rules</strong> to transition to <a id="_idIndexMarker982"/>the <a id="_idIndexMarker983"/><strong class="source-inline">JumpEnd</strong> state from the <strong class="source-inline">JumpLoop</strong> state, and to transition from the <strong class="source-inline">JumpEnd</strong> state back to the <strong class="source-inline">Movement</strong> state, you have successfully created your first animation state machine. Now, you can run around the map and jump onto elevated platforms, all while animating correctly and transitioning between the <strong class="source-inline">Movement</strong> and jump states.</p>
<h1 id="_idParaDest-218"><a id="_idTextAnchor246"/>Summary</h1>
<p>With the player movement Blend Space created and the player character Animation Blueprint using a State Machine to transition from movement to jumping, you are ready to move on to the next chapter, where you will prepare the required animation slot and animation montage, and then update the Animation Blueprint for the throw animation, which will only use the upper body of the character.</p>
<p>From the exercises and activities in this chapter, you learned how to create a Blend Space 1D that allows you to smoothly blend movement-based animations such as idling, walking, and running using the speed of the player character to control the blending of animations. </p>
<p>Additionally, you learned how to integrate new key bindings into the project settings and bind those keys in C++ to enable character gameplay mechanics such as sprinting and throwing.</p>
<p>Lastly, you learned how to implement your very own animation state machine within the character Animation Blueprint for the player to transition between movement animations, to the various states of jumping, and back to movement again. With all of this logic in place, in the next chapter, we’ll create the assets and logic that allow the player character to play the throwing animation, and set up the base class for the enemy.</p>
</div>
<div>
<div id="_idContainer357">
</div>
</div>
</div></body></html>