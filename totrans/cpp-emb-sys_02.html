<html><head></head><body>
<div id="_idContainer012">
<h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">1</span></h1>
<h1 class="chapterTitle" id="_idParaDest-17"><span class="koboSpan" id="kobo.2.1">Debunking Common Myths about C++</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">Writing software for microcontrollers and embedded systems is challenging. </span><span class="koboSpan" id="kobo.3.2">In order to get the most out of resource-constrained systems, embedded developers need to have a good knowledge of platform architecture. </span><span class="koboSpan" id="kobo.3.3">They need to be aware of available resources, including processor capabilities, available memory, and peripherals. </span><span class="koboSpan" id="kobo.3.4">The need to have direct access to hardware through memory-mapped peripherals has made </span><strong class="keyWord"><span class="koboSpan" id="kobo.4.1">C</span></strong><span class="koboSpan" id="kobo.5.1"> the language of choice for embedded systems for half a century.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.6.1">The goal of any programming language is to carry out the process of converting application-specific </span><a id="_idIndexMarker000"/><span class="koboSpan" id="kobo.7.1">abstractions into code that can be transformed into machine code. </span><span class="koboSpan" id="kobo.7.2">For instance, </span><strong class="keyWord"><span class="koboSpan" id="kobo.8.1">Common Business-Oriented Language</span></strong><span class="koboSpan" id="kobo.9.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.10.1">COBOL</span></strong><span class="koboSpan" id="kobo.11.1">) is used for banking applications, and </span><strong class="keyWord"><span class="koboSpan" id="kobo.12.1">Fortran</span></strong><span class="koboSpan" id="kobo.13.1"> is used </span><a id="_idIndexMarker001"/><span class="koboSpan" id="kobo.14.1">for scientific research and heavy mathematic calculations. </span><span class="koboSpan" id="kobo.14.2">C is, on the other hand, a general-purpose programming language </span><a id="_idIndexMarker002"/><span class="koboSpan" id="kobo.15.1">commonly used in </span><strong class="keyWord"><span class="koboSpan" id="kobo.16.1">operating systems</span></strong><span class="koboSpan" id="kobo.17.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.18.1">OSs</span></strong><span class="koboSpan" id="kobo.19.1">) and embedded system applications.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.20.1">C is a language with a simple and easy-to-learn syntax. </span><span class="koboSpan" id="kobo.20.2">Having a simple syntax means it is incapable of expressing complex ideas. </span><span class="koboSpan" id="kobo.20.3">C allows for complex operations but requires more explicit and detailed code to manage complexity, compared to higher-level languages that abstract these details away.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.21.1">In the late 1970s, high-level languages couldn’t meet the performance of C. </span><span class="koboSpan" id="kobo.21.2">This motivated Danish computer scientist Bjarne Stroustrup to start working on </span><strong class="keyWord"><span class="koboSpan" id="kobo.22.1">C with Classes</span></strong><span class="koboSpan" id="kobo.23.1">, a predecessor to C++. </span><span class="koboSpan" id="kobo.23.2">Nowadays, C++ is a multiparadigm language designed with performance in mind. </span><span class="koboSpan" id="kobo.23.3">The origin of C++ is still a source of some myths, which often causes hesitation in adopting it for embedded systems programming. </span><span class="koboSpan" id="kobo.23.4">This chapter will introduce you to those myths and debunk them. </span><span class="koboSpan" id="kobo.23.5">The following topics will be covered in this chapter:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.24.1">A short history of C++</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.25.1">C with Classes</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.26.1">Bloat and runtime overhead</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-18"><span class="koboSpan" id="kobo.27.1">Technical requirements</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.28.1">To get the most out of this chapter, I strongly recommend using Compiler Explorer (</span><a href="https://godbolt.org/"><span class="url"><span class="koboSpan" id="kobo.29.1">https://godbolt.org/</span></span></a><span class="koboSpan" id="kobo.30.1">) as you read through the examples. </span><span class="koboSpan" id="kobo.30.2">Select GCC as your compiler and target x86 architecture. </span><span class="koboSpan" id="kobo.30.3">This will allow you to see standard output (stdio) results and better observe the code’s behavior. </span><span class="koboSpan" id="kobo.30.4">The examples from this chapter are available on GitHub (</span><a href="https://github.com/PacktPublishing/Cpp-in-Embedded-Systems/tree/main/Chapter01"><span class="url"><span class="koboSpan" id="kobo.31.1">https://github.com/PacktPublishing/Cpp-in-Embedded-Systems/tree/main/Chapter01</span></span></a><span class="koboSpan" id="kobo.32.1">).</span></p>
<h1 class="heading-1" id="_idParaDest-19"><span class="koboSpan" id="kobo.33.1">A short history of C++</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.34.1">In the mid-60s, the simulation programming language </span><strong class="keyWord"><span class="koboSpan" id="kobo.35.1">SIMULA</span></strong><span class="koboSpan" id="kobo.36.1"> introduced classes and objects to the </span><a id="_idIndexMarker003"/><span class="koboSpan" id="kobo.37.1">world of software </span><a id="_idIndexMarker004"/><span class="koboSpan" id="kobo.38.1">development. </span><strong class="keyWord"><span class="koboSpan" id="kobo.39.1">Classes</span></strong><span class="koboSpan" id="kobo.40.1"> are abstractions that allow us to represent real-world concepts in programming in a concise way, making </span><a id="_idIndexMarker005"/><span class="koboSpan" id="kobo.41.1">the code </span><a id="_idIndexMarker006"/><span class="koboSpan" id="kobo.42.1">more human-readable. </span><span class="koboSpan" id="kobo.42.2">In embedded development, </span><strong class="keyWord"><span class="koboSpan" id="kobo.43.1">UART</span></strong><span class="koboSpan" id="kobo.44.1">, </span><strong class="keyWord"><span class="koboSpan" id="kobo.45.1">SPI</span></strong><span class="koboSpan" id="kobo.46.1">, </span><strong class="keyWord"><span class="koboSpan" id="kobo.47.1">TemperatureSensor</span></strong><span class="koboSpan" id="kobo.48.1">, </span><strong class="keyWord"><span class="koboSpan" id="kobo.49.1">PidController</span></strong><span class="koboSpan" id="kobo.50.1">, and </span><strong class="keyWord"><span class="koboSpan" id="kobo.51.1">TemperatureController</span></strong><span class="koboSpan" id="kobo.52.1"> are some </span><a id="_idIndexMarker007"/><span class="koboSpan" id="kobo.53.1">concepts that </span><a id="_idIndexMarker008"/><span class="koboSpan" id="kobo.54.1">can be implemented as </span><a id="_idIndexMarker009"/><span class="koboSpan" id="kobo.55.1">classes. </span><span class="koboSpan" id="kobo.55.2">SIMULA also introduced hierarchical relationships between classes. </span><span class="koboSpan" id="kobo.55.3">For example, </span><code class="inlineCode"><span class="koboSpan" id="kobo.56.1">PT100</span></code><span class="koboSpan" id="kobo.57.1"> class is also a </span><code class="inlineCode"><span class="koboSpan" id="kobo.58.1">TemperatureSensor</span></code><span class="koboSpan" id="kobo.59.1"> class, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.60.1">TemperatureController</span></code><span class="koboSpan" id="kobo.61.1"> class has a member instance (object) of </span><code class="inlineCode"><span class="koboSpan" id="kobo.62.1">TemperatureSensor</span></code><span class="koboSpan" id="kobo.63.1"> and a </span><code class="inlineCode"><span class="koboSpan" id="kobo.64.1">PidController</span></code><span class="koboSpan" id="kobo.65.1">. </span><span class="koboSpan" id="kobo.65.2">This </span><a id="_idIndexMarker010"/><span class="koboSpan" id="kobo.66.1">became known as </span><strong class="keyWord"><span class="koboSpan" id="kobo.67.1">object-oriented programming</span></strong><span class="koboSpan" id="kobo.68.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.69.1">OOP</span></strong><span class="koboSpan" id="kobo.70.1">).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.71.1">In reflecting on the evolution of programming languages, Bjarne Stroustrup, the creator of C++, shared his approach to designing C++. </span><span class="koboSpan" id="kobo.71.2">Stroustrup aimed to bridge the gap between high-level abstractions and low-level efficiency. </span><span class="koboSpan" id="kobo.71.3">He said the following:</span></p>
<blockquote class="packt_quote">
<p class="quote"><span class="koboSpan" id="kobo.72.1"> My idea was very simple. </span><span class="koboSpan" id="kobo.72.2">To take ideas from SIMULA for general abstractions for the benefits of humans representing things, so humans could get it, with low-level stuff, which at that time the best language for that was C, which was done at Bell Labs by Dennis Ritchie. </span><span class="koboSpan" id="kobo.72.3">And take those two ideas and bring them together so that you could do high-level abstraction, but efficiently enough and close enough to hardware, for really demanding computing tasks</span></p>
</blockquote>
<p class="normal"><span class="koboSpan" id="kobo.73.1">Originally started as C with Classes by Bjarne Stroustrup, C++ transformed into a modern programming language that still provides direct access to hardware and memory-mapped peripherals. </span><span class="koboSpan" id="kobo.73.2">Using powerful abstractions makes writing expressive and highly modular code possible in C++. </span><span class="koboSpan" id="kobo.73.3">C++ is a general-purpose, multiparadigm language supporting procedural, object-oriented, and, to some extent, functional programming paradigms.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.74.1">While C is still the </span><a id="_idIndexMarker011"/><span class="koboSpan" id="kobo.75.1">language of choice for embedded development, accounting for up to 60% of embedded projects, the adoption of C++ has grown steadily. </span><span class="koboSpan" id="kobo.75.2">With an estimated usage of 20-30% in the embedded development field, C++ offers classes, improved type safety, and compile-time computation, among other features.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.76.1">Despite the features that C++ offers, C is still dominant in embedded programming. </span><span class="koboSpan" id="kobo.76.2">There are many reasons for this, and this chapter will address some of them. </span><span class="koboSpan" id="kobo.76.3">C++ is a more complex language than C, making it harder for beginner developers. </span><span class="koboSpan" id="kobo.76.4">C is easier to learn and makes it possible to involve beginner developers in a project faster.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.77.1">The simplicity of C is good as it allows beginner developers to start contributing to projects faster, but it also makes writing complex logic too verbose. </span><span class="koboSpan" id="kobo.77.2">This usually results in a larger code base due to a lack of expressiveness. </span><span class="koboSpan" id="kobo.77.3">This is where C++ steps in with higher abstractions, which, if embraced, make code easier to read and comprehend.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.78.1">The other reasons why C++ is not more widely adopted are related to myths about C++. </span><span class="koboSpan" id="kobo.78.2">It is still believed that C++ is just “C with classes,” that using C++ is absolutely unacceptable for safety-critical systems due to dynamic memory allocation in the standard library, or that it produces bloat code and adds space and time overhead. </span><span class="koboSpan" id="kobo.78.3">This chapter will address some of the most common myths about C++ in the context of embedded development. </span><span class="koboSpan" id="kobo.78.4">Let’s debunk these myths and shine a new light on C++ in embedded systems!</span></p>
<h1 class="heading-1" id="_idParaDest-20"><span class="koboSpan" id="kobo.79.1">C with Classes</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.80.1">Historically speaking, C++ started as C with Classes. </span><span class="koboSpan" id="kobo.80.2">The </span><a id="_idIndexMarker012"/><span class="koboSpan" id="kobo.81.1">first C++ compiler, </span><strong class="keyWord"><span class="koboSpan" id="kobo.82.1">Cfront</span></strong><span class="koboSpan" id="kobo.83.1">, converted C++ to C, but that </span><a id="_idIndexMarker013"/><span class="koboSpan" id="kobo.84.1">was a long time ago. </span><span class="koboSpan" id="kobo.84.2">Over time, C and C++ evolved separately and are now defined by separate language standards. </span><span class="koboSpan" id="kobo.84.3">C has maintained its simplicity, while C++ has become a modern language that enables abstract solutions for problems without sacrificing performance levels. </span><span class="koboSpan" id="kobo.84.4">But C++ is still sometimes called C with Classes, which implies that there is no added value in C++ except the classes.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.85.1">The C++11 standard was released in 2011, and it is the second major version of C++. </span><span class="koboSpan" id="kobo.85.2">It is packed with features that modernize the language, such as range-based loops, lambdas, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.86.1">constexpr</span></code><span class="koboSpan" id="kobo.87.1">. </span><span class="koboSpan" id="kobo.87.2">Subsequent releases, C++14, C++17, C++20, and C++23, kept modernizing the language and introducing features that make C with Classes merely a distant predecessor of modern C++.</span></p>
<h2 class="heading-2" id="_idParaDest-21"><span class="koboSpan" id="kobo.88.1">Modern C++</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.89.1">To demonstrate that C++ is not just C with Classes, let’s explore a couple of short C code examples and </span><a id="_idIndexMarker014"/><span class="koboSpan" id="kobo.90.1">their modern C++ equivalents. </span><span class="koboSpan" id="kobo.90.2">Let’s start with a </span><a id="_idIndexMarker015"/><span class="koboSpan" id="kobo.91.1">simple example of printing elements from an integer buffer:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.92.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.93.1">define</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.94.1"> N 20</span></span>
<span class="hljs-type"><span class="koboSpan" id="kobo.95.1">int</span></span><span class="koboSpan" id="kobo.96.1"> buffer[N];
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.97.1">for</span></span><span class="koboSpan" id="kobo.98.1">(</span><span class="hljs-type"><span class="koboSpan" id="kobo.99.1">int</span></span><span class="koboSpan" id="kobo.100.1"> i = </span><span class="hljs-number"><span class="koboSpan" id="kobo.101.1">0</span></span><span class="koboSpan" id="kobo.102.1">; i &lt; N; i ++) {
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.103.1">printf</span></span><span class="koboSpan" id="kobo.104.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.105.1">"%d "</span></span><span class="koboSpan" id="kobo.106.1">, buffer[i]);
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.107.1">The preceding C code can be translated into the following C++ code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.108.1">std::array&lt;</span><span class="hljs-type"><span class="koboSpan" id="kobo.109.1">int</span></span><span class="koboSpan" id="kobo.110.1">, 20&gt; buffer;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.111.1">for</span></span><span class="koboSpan" id="kobo.112.1">(</span><span class="hljs-type"><span class="koboSpan" id="kobo.113.1">const</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.114.1">auto</span></span><span class="koboSpan" id="kobo.115.1">&amp; element : buffer) {
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.116.1">printf</span></span><span class="koboSpan" id="kobo.117.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.118.1">"%d "</span></span><span class="koboSpan" id="kobo.119.1">, element);
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.120.1">The first thing we notice is that the C++ version is shorter. </span><span class="koboSpan" id="kobo.120.2">It has fewer words, and it’s closer to English than the C code. </span><span class="koboSpan" id="kobo.120.3">It is easier to read. </span><span class="koboSpan" id="kobo.120.4">Now, if you come from a C background and have not been exposed to higher-level languages, the first version may look easier to read, but let’s compare them. </span><span class="koboSpan" id="kobo.120.5">The first thing we notice is that the C code has defined the constant </span><code class="inlineCode"><span class="koboSpan" id="kobo.121.1">N</span></code><span class="koboSpan" id="kobo.122.1">, which determines the size of </span><code class="inlineCode"><span class="koboSpan" id="kobo.123.1">buffer</span></code><span class="koboSpan" id="kobo.124.1">. </span><span class="koboSpan" id="kobo.124.2">This constant is used to define </span><code class="inlineCode"><span class="koboSpan" id="kobo.125.1">buffer</span></code><span class="koboSpan" id="kobo.126.1"> and as a boundary for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.127.1">for</span></code><span class="koboSpan" id="kobo.128.1"> loop.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.129.1">Range-based loops, introduced in C++11, remove the cognitive burden of using the size of the container in the loop stop condition. </span><span class="koboSpan" id="kobo.129.2">The size information is already contained in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.130.1">std::array</span></code><span class="koboSpan" id="kobo.131.1"> container, which is utilized by the range-based loop to iterate through the array effortlessly. </span><span class="koboSpan" id="kobo.131.2">Also, there is no indexing of the buffer, as elements are accessed using constant reference, ensuring that the elements are not modified inside the loop.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.132.1">Let’s look at some simple C code that copies all elements from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.133.1">array_a</span></code><span class="koboSpan" id="kobo.134.1"> integer to </span><code class="inlineCode"><span class="koboSpan" id="kobo.135.1">array_b</span></code><span class="koboSpan" id="kobo.136.1"> if smaller than </span><code class="inlineCode"><span class="koboSpan" id="kobo.137.1">10</span></code><span class="koboSpan" id="kobo.138.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-type"><span class="koboSpan" id="kobo.139.1">int</span></span><span class="koboSpan" id="kobo.140.1"> w_idx = </span><span class="hljs-number"><span class="koboSpan" id="kobo.141.1">0</span></span><span class="koboSpan" id="kobo.142.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.143.1">for</span></span><span class="koboSpan" id="kobo.144.1">(</span><span class="hljs-type"><span class="koboSpan" id="kobo.145.1">int</span></span><span class="koboSpan" id="kobo.146.1"> i = </span><span class="hljs-number"><span class="koboSpan" id="kobo.147.1">0</span></span><span class="koboSpan" id="kobo.148.1">; i &lt; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.149.1">sizeof</span></span><span class="koboSpan" id="kobo.150.1">(array_a)/</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.151.1">sizeof</span></span><span class="koboSpan" id="kobo.152.1">(</span><span class="hljs-type"><span class="koboSpan" id="kobo.153.1">int</span></span><span class="koboSpan" id="kobo.154.1">); i++) {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.155.1">if</span></span><span class="koboSpan" id="kobo.156.1">(array_a[i] &lt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.157.1">10</span></span><span class="koboSpan" id="kobo.158.1">) {
        array_b[w_idx++] = array_a[i];
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.159.1">Here is the C++ code with the same functionality:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.160.1">auto</span></span><span class="koboSpan" id="kobo.161.1"> less_than_10 =  [](</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.162.1">auto</span></span><span class="koboSpan" id="kobo.163.1"> x) -&gt; </span><span class="hljs-type"><span class="koboSpan" id="kobo.164.1">bool</span></span><span class="koboSpan" id="kobo.165.1"> {
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.166.1">    return</span></span><span class="koboSpan" id="kobo.167.1"> x &lt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.168.1">10</span></span><span class="koboSpan" id="kobo.169.1">;
};
std::</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.170.1">copy_if</span></span><span class="koboSpan" id="kobo.171.1">(std::</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.172.1">begin</span></span><span class="koboSpan" id="kobo.173.1">(array_a), std::</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.174.1">end</span></span><span class="koboSpan" id="kobo.175.1">(array_a), std::</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.176.1">begin</span></span><span class="koboSpan" id="kobo.177.1">(array_b), less_than_10);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.178.1">Instead of manually iterating through </span><code class="inlineCode"><span class="koboSpan" id="kobo.179.1">array_a</span></code><span class="koboSpan" id="kobo.180.1"> and copying elements to </span><code class="inlineCode"><span class="koboSpan" id="kobo.181.1">array_b</span></code><span class="koboSpan" id="kobo.182.1"> only if they exceed </span><code class="inlineCode"><span class="koboSpan" id="kobo.183.1">10</span></code><span class="koboSpan" id="kobo.184.1">, we can use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.185.1">copy_if</span></code><span class="koboSpan" id="kobo.186.1"> function from C++’s standard template library. </span><span class="koboSpan" id="kobo.186.2">The first two arguments for </span><code class="inlineCode"><span class="koboSpan" id="kobo.187.1">std::copy_if</span></code><span class="koboSpan" id="kobo.188.1"> are iterators that define the range of elements to consider in </span><code class="inlineCode"><span class="koboSpan" id="kobo.189.1">array_a</span></code><span class="koboSpan" id="kobo.190.1">: the first iterator points to the beginning of the array, and the second iterator points </span><a id="_idIndexMarker016"/><span class="koboSpan" id="kobo.191.1">to the position just beyond the last element. </span><span class="koboSpan" id="kobo.191.2">The third argument </span><a id="_idIndexMarker017"/><span class="koboSpan" id="kobo.192.1">is the iterator pointing to the start of </span><code class="inlineCode"><span class="koboSpan" id="kobo.193.1">array_b</span></code><span class="koboSpan" id="kobo.194.1">, and the fourth is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.195.1">less_than_10</span></code><span class="koboSpan" id="kobo.196.1"> lambda expression.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.197.1">A lambda expression is an anonymous function object that can be declared at a location where it’s invoked or passed as an argument to a function. </span><span class="koboSpan" id="kobo.197.2">Please note that lambdas will be covered in more detail in </span><a href="Chapter_10.xhtml"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.198.1">Chapter 10</span></em></span></a><span class="koboSpan" id="kobo.199.1">. </span><span class="koboSpan" id="kobo.199.2">In the case of </span><code class="inlineCode"><span class="koboSpan" id="kobo.200.1">std::copy_if</span></code><span class="koboSpan" id="kobo.201.1">, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.202.1">less_than_10</span></code><span class="koboSpan" id="kobo.203.1"> lambda is used to determine whether elements from </span><code class="inlineCode"><span class="koboSpan" id="kobo.204.1">array_a</span></code><span class="koboSpan" id="kobo.205.1"> are to be copied to </span><code class="inlineCode"><span class="koboSpan" id="kobo.206.1">array_b</span></code><span class="koboSpan" id="kobo.207.1">. </span><span class="koboSpan" id="kobo.207.2">We could also define a standalone </span><code class="inlineCode"><span class="koboSpan" id="kobo.208.1">less_than_10</span></code><span class="koboSpan" id="kobo.209.1"> function that accepts an integer and returns a Boolean if it is larger than 10, but using a lambda, we can write this functionality close to the place where we pass it to an algorithm, which makes code more compact and expressive.</span></p>
<h2 class="heading-2" id="_idParaDest-22"><span class="koboSpan" id="kobo.210.1">Generic types</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.211.1">Previous examples used the </span><code class="inlineCode"><span class="koboSpan" id="kobo.212.1">std::array</span></code><span class="koboSpan" id="kobo.213.1"> standard library container. </span><span class="koboSpan" id="kobo.213.2">It is a class template that wraps </span><a id="_idIndexMarker018"/><span class="koboSpan" id="kobo.214.1">a C-style array along with its size information. </span><span class="koboSpan" id="kobo.214.2">Please note that templates will be covered in more detail in </span><a href="Chapter_08.xhtml"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.215.1">Chapter 8</span></em></span></a><span class="koboSpan" id="kobo.216.1">. </span><span class="koboSpan" id="kobo.216.2">When you use </span><code class="inlineCode"><span class="koboSpan" id="kobo.217.1">std::array</span></code><span class="koboSpan" id="kobo.218.1"> with a specific underlying type and size, the compiler defines a new type in the process of </span><strong class="keyWord"><span class="koboSpan" id="kobo.219.1">instantiation</span></strong><span class="koboSpan" id="kobo.220.1">.</span></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.221.1">std::array&lt;int, 10&gt;</span></code><span class="koboSpan" id="kobo.222.1"> creates a container type that has an underlying C-style array of integers with </span><a id="_idIndexMarker019"/><span class="koboSpan" id="kobo.223.1">a size of </span><code class="inlineCode"><span class="koboSpan" id="kobo.224.1">10</span></code><span class="koboSpan" id="kobo.225.1">. </span><span class="koboSpan" id="kobo.225.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.226.1">std::array&lt;int, 20&gt;</span></code><span class="koboSpan" id="kobo.227.1"> is a container type that has an underlying C-style array of integers with a size of </span><code class="inlineCode"><span class="koboSpan" id="kobo.228.1">20</span></code><span class="koboSpan" id="kobo.229.1">. </span><span class="koboSpan" id="kobo.229.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.230.1">std::array&lt;int, 10&gt;</span></code><span class="koboSpan" id="kobo.231.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.232.1">std::array&lt;int, 20&gt;</span></code><span class="koboSpan" id="kobo.233.1"> are different types. </span><span class="koboSpan" id="kobo.233.2">Both have the same underlying type, but a different size.</span></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.234.1">std::array&lt;float, 10&gt;</span></code><span class="koboSpan" id="kobo.235.1"> would result in a third type, as it differs from </span><code class="inlineCode"><span class="koboSpan" id="kobo.236.1">std::array&lt;int, 10&gt;</span></code><span class="koboSpan" id="kobo.237.1"> by the underlying type. </span><span class="koboSpan" id="kobo.237.2">Using different parameters yields different types. </span><span class="koboSpan" id="kobo.237.3">Template types are generic types that become concrete only upon instantiation.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.238.1">To better understand generic types and appreciate them, let’s examine the implementation of a ring buffer in C and compare it with a template-based solution in C++.</span></p>
<h3 class="heading-3" id="_idParaDest-23"><span class="koboSpan" id="kobo.239.1">Ring buffer in C</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.240.1">A </span><strong class="keyWord"><span class="koboSpan" id="kobo.241.1">ring</span></strong><span class="koboSpan" id="kobo.242.1"> or </span><strong class="keyWord"><span class="koboSpan" id="kobo.243.1">circular buffer</span></strong><span class="koboSpan" id="kobo.244.1"> is a commonly </span><a id="_idIndexMarker020"/><span class="koboSpan" id="kobo.245.1">used data structure in embedded </span><a id="_idIndexMarker021"/><span class="koboSpan" id="kobo.246.1">programming. </span><span class="koboSpan" id="kobo.246.2">It is commonly implemented as a set of functions </span><a id="_idIndexMarker022"/><span class="koboSpan" id="kobo.247.1">around an array with write and read indexes used to access elements of the array. </span><span class="koboSpan" id="kobo.247.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.248.1">count</span></code><span class="koboSpan" id="kobo.249.1"> variable is used for array space management. </span><span class="koboSpan" id="kobo.249.2">The interface consists of push and pop functions, which are explained here:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.250.1">A </span><strong class="keyWord"><span class="koboSpan" id="kobo.251.1">push</span></strong><span class="koboSpan" id="kobo.252.1"> function is </span><a id="_idIndexMarker023"/><span class="koboSpan" id="kobo.253.1">used to store elements in a ring buffer. </span><span class="koboSpan" id="kobo.253.2">On every push, a data element is stored in the array, and the write index is incremented. </span><span class="koboSpan" id="kobo.253.3">If the write index becomes equal to the number of elements in the data array, it is reset to 0.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.254.1">A </span><strong class="keyWord"><span class="koboSpan" id="kobo.255.1">pop</span></strong><span class="koboSpan" id="kobo.256.1"> function is </span><a id="_idIndexMarker024"/><span class="koboSpan" id="kobo.257.1">used to retrieve an element from a ring buffer. </span><span class="koboSpan" id="kobo.257.2">On every pop, if the underlying array is not empty, we return an element of the array indexed with the read index. </span><span class="koboSpan" id="kobo.257.3">We increment the read index.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.258.1">On every push, we increment the </span><code class="inlineCode"><span class="koboSpan" id="kobo.259.1">count</span></code><span class="koboSpan" id="kobo.260.1"> variable and decrement it on pop. </span><span class="koboSpan" id="kobo.260.2">If the count becomes equal to the size of the data array, we need to move the read index forward.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.261.1">Let us define </span><a id="_idIndexMarker025"/><span class="koboSpan" id="kobo.262.1">the implementation requirements of the ring buffer we want to implement in our C module:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.263.1">It should not use dynamic memory allocation</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.264.1">When the buffer is full, we will overwrite the oldest element</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.265.1">Provide push and pop functions for storing data in the buffer and retrieving it</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.266.1">Integers will be stored in the ring buffer</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.267.1">Here is a simple solution for the preceding requirements in C:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.268.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.269.1">include</span></span><span class="hljs-meta"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.270.1">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.271.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.272.1">define</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.273.1"> BUFFER_SIZE 5</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.274.1">typedef</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.275.1">struct</span></span><span class="hljs-class"><span class="koboSpan" id="kobo.276.1"> {</span></span>
<span class="hljs-type"><span class="koboSpan" id="kobo.277.1">int</span></span><span class="koboSpan" id="kobo.278.1"> arr[BUFFER_SIZE]; </span><span class="hljs-comment"><span class="koboSpan" id="kobo.279.1">// Array to store int values directly</span></span>
<span class="hljs-type"><span class="koboSpan" id="kobo.280.1">size_t</span></span><span class="koboSpan" id="kobo.281.1"> write_idx;     </span><span class="hljs-comment"><span class="koboSpan" id="kobo.282.1">// Index of the next element to write (push)</span></span>
<span class="hljs-type"><span class="koboSpan" id="kobo.283.1">size_t</span></span><span class="koboSpan" id="kobo.284.1"> read_idx;      </span><span class="hljs-comment"><span class="koboSpan" id="kobo.285.1">// Index of the next element to read (pop)</span></span>
<span class="hljs-type"><span class="koboSpan" id="kobo.286.1">size_t</span></span><span class="koboSpan" id="kobo.287.1"> count;         </span><span class="hljs-comment"><span class="koboSpan" id="kobo.288.1">// Number of elements in the buffer</span></span><span class="koboSpan" id="kobo.289.1">
} int_ring_buffer;
</span><span class="hljs-type"><span class="koboSpan" id="kobo.290.1">void</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.291.1">int_ring_buffer_init</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.292.1">(int_ring_buffer *rb)</span></span><span class="koboSpan" id="kobo.293.1"> {
  rb-&gt;write_idx = </span><span class="hljs-number"><span class="koboSpan" id="kobo.294.1">0</span></span><span class="koboSpan" id="kobo.295.1">;
  rb-&gt;read_idx = </span><span class="hljs-number"><span class="koboSpan" id="kobo.296.1">0</span></span><span class="koboSpan" id="kobo.297.1">;
  rb-&gt;count = </span><span class="hljs-number"><span class="koboSpan" id="kobo.298.1">0</span></span><span class="koboSpan" id="kobo.299.1">;
}
</span><span class="hljs-type"><span class="koboSpan" id="kobo.300.1">void</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.301.1">int_ring_buffer_push</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.302.1">(int_ring_buffer *rb, </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.303.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.304.1"> value)</span></span><span class="koboSpan" id="kobo.305.1"> {
  rb-&gt;arr[rb-&gt;write_idx] = value;
  rb-&gt;write_idx = (rb-&gt;write_idx + </span><span class="hljs-number"><span class="koboSpan" id="kobo.306.1">1</span></span><span class="koboSpan" id="kobo.307.1">) % BUFFER_SIZE;
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.308.1">if</span></span><span class="koboSpan" id="kobo.309.1"> (rb-&gt;count &lt; BUFFER_SIZE) {
    rb-&gt;count++;
  } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.310.1">else</span></span><span class="koboSpan" id="kobo.311.1"> {
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.312.1">// Buffer is full, move read_idx forward</span></span><span class="koboSpan" id="kobo.313.1">
    rb-&gt;read_idx = (rb-&gt;read_idx + </span><span class="hljs-number"><span class="koboSpan" id="kobo.314.1">1</span></span><span class="koboSpan" id="kobo.315.1">) % BUFFER_SIZE;
  }
}
</span><span class="hljs-type"><span class="koboSpan" id="kobo.316.1">int</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.317.1">int_ring_buffer_pop</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.318.1">(int_ring_buffer *rb)</span></span><span class="koboSpan" id="kobo.319.1"> {
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.320.1">if</span></span><span class="koboSpan" id="kobo.321.1"> (rb-&gt;count == </span><span class="hljs-number"><span class="koboSpan" id="kobo.322.1">0</span></span><span class="koboSpan" id="kobo.323.1">) {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.324.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.325.1">0</span></span><span class="koboSpan" id="kobo.326.1">;
  }
  </span><span class="hljs-type"><span class="koboSpan" id="kobo.327.1">int</span></span><span class="koboSpan" id="kobo.328.1"> value = rb-&gt;arr[rb-&gt;read_idx];
  rb-&gt;read_idx = (rb-&gt;read_idx + </span><span class="hljs-number"><span class="koboSpan" id="kobo.329.1">1</span></span><span class="koboSpan" id="kobo.330.1">) % BUFFER_SIZE;
  rb-&gt;count--;
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.331.1">return</span></span><span class="koboSpan" id="kobo.332.1"> value;
}
</span><span class="hljs-type"><span class="koboSpan" id="kobo.333.1">int</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.334.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.335.1">()</span></span><span class="koboSpan" id="kobo.336.1"> {
  int_ring_buffer rb;
  int_ring_buffer_init(&amp;rb);
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.337.1">for</span></span><span class="koboSpan" id="kobo.338.1"> (</span><span class="hljs-type"><span class="koboSpan" id="kobo.339.1">int</span></span><span class="koboSpan" id="kobo.340.1"> i = </span><span class="hljs-number"><span class="koboSpan" id="kobo.341.1">0</span></span><span class="koboSpan" id="kobo.342.1">; i &lt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.343.1">10</span></span><span class="koboSpan" id="kobo.344.1">; i++) {
    int_ring_buffer_push(&amp;rb, i);
  }
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.345.1">while</span></span><span class="koboSpan" id="kobo.346.1"> (rb.count &gt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.347.1">0</span></span><span class="koboSpan" id="kobo.348.1">) {
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.349.1">int</span></span><span class="koboSpan" id="kobo.350.1"> value = int_ring_buffer_pop(&amp;rb);
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.351.1">printf</span></span><span class="koboSpan" id="kobo.352.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.353.1">"%d\n"</span></span><span class="koboSpan" id="kobo.354.1">, value);
  }
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.355.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.356.1">0</span></span><span class="koboSpan" id="kobo.357.1">;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.358.1">We are using a </span><code class="inlineCode"><span class="koboSpan" id="kobo.359.1">for</span></code><span class="koboSpan" id="kobo.360.1"> loop to </span><a id="_idIndexMarker026"/><span class="koboSpan" id="kobo.361.1">initialize the buffer. </span><span class="koboSpan" id="kobo.361.2">As the buffer size is </span><code class="inlineCode"><span class="koboSpan" id="kobo.362.1">5</span></code><span class="koboSpan" id="kobo.363.1">, values from </span><code class="inlineCode"><span class="koboSpan" id="kobo.364.1">5</span></code><span class="koboSpan" id="kobo.365.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.366.1">9</span></code><span class="koboSpan" id="kobo.367.1"> will be stored in the buffer as the ring buffer overwrites the existing data. </span><span class="koboSpan" id="kobo.367.2">Now, what if we want to store floats in our ring buffer, chars, or a user-defined data structure? </span><span class="koboSpan" id="kobo.367.3">We could implement the same logic for different types and create a new set of data structures and functions called </span><code class="inlineCode"><span class="koboSpan" id="kobo.368.1">float_ring_buffer</span></code><span class="koboSpan" id="kobo.369.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.370.1">char_ring_buffer</span></code><span class="koboSpan" id="kobo.371.1">. </span><span class="koboSpan" id="kobo.371.2">Can we make a solution that could store different data types and use the same functions?</span></p>
<p class="normal"><span class="koboSpan" id="kobo.372.1">We could use an </span><code class="inlineCode"><span class="koboSpan" id="kobo.373.1">unsigned char</span></code><span class="koboSpan" id="kobo.374.1"> array as storage for different data types and use a </span><code class="inlineCode"><span class="koboSpan" id="kobo.375.1">void</span></code><span class="koboSpan" id="kobo.376.1"> pointer to pass different data types to push and pop functions. </span><span class="koboSpan" id="kobo.376.2">The only thing that’s missing is knowing the </span><a id="_idIndexMarker027"/><span class="koboSpan" id="kobo.377.1">size of the data type, and we can address that by adding a </span><code class="inlineCode"><span class="koboSpan" id="kobo.378.1">size_t elem_size</span></code><span class="koboSpan" id="kobo.379.1"> member to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.380.1">ring_buffer</span></code><span class="koboSpan" id="kobo.381.1"> structure:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.382.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.383.1">include</span></span><span class="hljs-meta"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.384.1">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.385.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.386.1">include</span></span><span class="hljs-meta"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.387.1">&lt;string.h&gt;</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.388.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.389.1">define</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.390.1"> BUFFER_SIZE 20 </span></span><span class="hljs-comment"><span class="koboSpan" id="kobo.391.1">// Total bytes available in the buffer</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.392.1">typedef</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.393.1">struct</span></span><span class="hljs-class"><span class="koboSpan" id="kobo.394.1"> {</span></span>
<span class="hljs-type"><span class="koboSpan" id="kobo.395.1">unsigned</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.396.1">char</span></span><span class="koboSpan" id="kobo.397.1"> data[BUFFER_SIZE]; </span><span class="hljs-comment"><span class="koboSpan" id="kobo.398.1">// Array to store byte values</span></span>
<span class="hljs-type"><span class="koboSpan" id="kobo.399.1">size_t</span></span><span class="koboSpan" id="kobo.400.1"> write_idx;                </span><span class="hljs-comment"><span class="koboSpan" id="kobo.401.1">// Index of the next byte to write</span></span>
<span class="hljs-type"><span class="koboSpan" id="kobo.402.1">size_t</span></span><span class="koboSpan" id="kobo.403.1"> read_idx;                 </span><span class="hljs-comment"><span class="koboSpan" id="kobo.404.1">// Index of the next byte to read</span></span>
<span class="hljs-type"><span class="koboSpan" id="kobo.405.1">size_t</span></span><span class="koboSpan" id="kobo.406.1"> count;     </span><span class="hljs-comment"><span class="koboSpan" id="kobo.407.1">// Number of bytes currently used in the buffer</span></span>
<span class="hljs-type"><span class="koboSpan" id="kobo.408.1">size_t</span></span><span class="koboSpan" id="kobo.409.1"> elem_size; </span><span class="hljs-comment"><span class="koboSpan" id="kobo.410.1">// Size of each element in bytes</span></span><span class="koboSpan" id="kobo.411.1">
} ring_buffer;
</span><span class="hljs-type"><span class="koboSpan" id="kobo.412.1">void</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.413.1">ring_buffer_init</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.414.1">(ring_buffer *rb, </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.415.1">size_t</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.416.1"> elem_size)</span></span><span class="koboSpan" id="kobo.417.1"> {
  rb-&gt;write_idx = </span><span class="hljs-number"><span class="koboSpan" id="kobo.418.1">0</span></span><span class="koboSpan" id="kobo.419.1">;
  rb-&gt;read_idx = </span><span class="hljs-number"><span class="koboSpan" id="kobo.420.1">0</span></span><span class="koboSpan" id="kobo.421.1">;
  rb-&gt;count = </span><span class="hljs-number"><span class="koboSpan" id="kobo.422.1">0</span></span><span class="koboSpan" id="kobo.423.1">;
  rb-&gt;elem_size = elem_size;
}
</span><span class="hljs-type"><span class="koboSpan" id="kobo.424.1">void</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.425.1">ring_buffer_push</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.426.1">(ring_buffer *rb, </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.427.1">void</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.428.1"> *value)</span></span><span class="koboSpan" id="kobo.429.1"> {
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.430.1">if</span></span><span class="koboSpan" id="kobo.431.1"> (rb-&gt;count + rb-&gt;elem_size &lt;= BUFFER_SIZE) {
    rb-&gt;count += rb-&gt;elem_size;
  } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.432.1">else</span></span><span class="koboSpan" id="kobo.433.1"> {
    rb-&gt;read_idx = (rb-&gt;read_idx + rb-&gt;elem_size) % BUFFER_SIZE;
  }
  </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.434.1">memcpy</span></span><span class="koboSpan" id="kobo.435.1">(&amp;rb-&gt;data[rb-&gt;write_idx], value, rb-&gt;elem_size);
  rb-&gt;write_idx = (rb-&gt;write_idx + rb-&gt;elem_size) % BUFFER_SIZE;
}
</span><span class="hljs-type"><span class="koboSpan" id="kobo.436.1">int</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.437.1">ring_buffer_pop</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.438.1">(ring_buffer *rb, </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.439.1">void</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.440.1"> *value)</span></span><span class="koboSpan" id="kobo.441.1"> {
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.442.1">if</span></span><span class="koboSpan" id="kobo.443.1"> (rb-&gt;count &lt; rb-&gt;elem_size) {
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.444.1">// Not enough data to pop</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.445.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.446.1">0</span></span><span class="koboSpan" id="kobo.447.1">;
  }
  </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.448.1">memcpy</span></span><span class="koboSpan" id="kobo.449.1">(value, &amp;rb-&gt;data[rb-&gt;read_idx], rb-&gt;elem_size);
  rb-&gt;read_idx = (rb-&gt;read_idx + rb-&gt;elem_size) % BUFFER_SIZE;
  rb-&gt;count -= rb-&gt;elem_size;
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.450.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.451.1">1</span></span><span class="koboSpan" id="kobo.452.1">; </span><span class="hljs-comment"><span class="koboSpan" id="kobo.453.1">// Success</span></span><span class="koboSpan" id="kobo.454.1">
}
</span><span class="hljs-type"><span class="koboSpan" id="kobo.455.1">int</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.456.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.457.1">()</span></span><span class="koboSpan" id="kobo.458.1"> {
  ring_buffer rb;
  ring_buffer_init(&amp;rb, </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.459.1">sizeof</span></span><span class="koboSpan" id="kobo.460.1">(</span><span class="hljs-type"><span class="koboSpan" id="kobo.461.1">int</span></span><span class="koboSpan" id="kobo.462.1">)); </span><span class="hljs-comment"><span class="koboSpan" id="kobo.463.1">// Initialize buffer for int values</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.464.1">for</span></span><span class="koboSpan" id="kobo.465.1"> (</span><span class="hljs-type"><span class="koboSpan" id="kobo.466.1">int</span></span><span class="koboSpan" id="kobo.467.1"> i = </span><span class="hljs-number"><span class="koboSpan" id="kobo.468.1">0</span></span><span class="koboSpan" id="kobo.469.1">; i &lt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.470.1">10</span></span><span class="koboSpan" id="kobo.471.1">; i++) {
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.472.1">int</span></span><span class="koboSpan" id="kobo.473.1"> val = i;
    ring_buffer_push(&amp;rb, &amp;val);
  }
  </span><span class="hljs-type"><span class="koboSpan" id="kobo.474.1">int</span></span><span class="koboSpan" id="kobo.475.1"> pop_value;
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.476.1">while</span></span><span class="koboSpan" id="kobo.477.1"> (ring_buffer_pop(&amp;rb, &amp;pop_value)) {
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.478.1">printf</span></span><span class="koboSpan" id="kobo.479.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.480.1">"%d\n"</span></span><span class="koboSpan" id="kobo.481.1">, pop_value);
  }
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.482.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.483.1">0</span></span><span class="koboSpan" id="kobo.484.1">;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.485.1">This ring buffer solution can be used to store different data types. </span><span class="koboSpan" id="kobo.485.2">As we avoid using dynamic memory </span><a id="_idIndexMarker028"/><span class="koboSpan" id="kobo.486.1">allocation and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.487.1">data</span></code><span class="koboSpan" id="kobo.488.1"> buffer size was determined at compile time, we are not flexible when it comes to defining the size of the memory needed for different instances of the ring buffer. </span><span class="koboSpan" id="kobo.488.2">Another problem we have is type safety. </span><span class="koboSpan" id="kobo.488.3">We can easily call </span><code class="inlineCode"><span class="koboSpan" id="kobo.489.1">ring_buffer_push</span></code><span class="koboSpan" id="kobo.490.1"> with a pointer to a float and </span><code class="inlineCode"><span class="koboSpan" id="kobo.491.1">ring_buffer_pop</span></code><span class="koboSpan" id="kobo.492.1"> with a pointer to an integer. </span><span class="koboSpan" id="kobo.492.2">The compiler can’t address this concern, and the possibility of a catastrophe is real. </span><span class="koboSpan" id="kobo.492.3">Also, by using a void pointer, we added a layer of indirection as we have to rely on memory to retrieve data from the data buffer.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.493.1">Can we address type-safety concerns and make it possible to define the size of the ring buffer in C? </span><span class="koboSpan" id="kobo.493.2">We can use the token-pasting (</span><code class="inlineCode"><span class="koboSpan" id="kobo.494.1">##</span></code><span class="koboSpan" id="kobo.495.1">) operator to create a set of functions for different types and sizes using macros. </span><span class="koboSpan" id="kobo.495.2">Let’s quickly go through a simple example of using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.496.1">##</span></code><span class="koboSpan" id="kobo.497.1"> operator before jumping into ring buffer implementation using this technique:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.498.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.499.1">include</span></span><span class="hljs-meta"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.500.1">&lt;stdio.h&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.501.1">// Macro to define a function for summing two numbers</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.502.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.503.1">define</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.504.1"> DEFINE_SUM_FUNCTION(TYPE) \</span></span><span class="koboSpan" id="kobo.505.1">
TYPE sum_##TYPE(TYPE a, TYPE b) { \
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.506.1">return</span></span><span class="koboSpan" id="kobo.507.1"> a + b; \
}
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.508.1">// Define sum functions for int and float</span></span><span class="koboSpan" id="kobo.509.1">
DEFINE_SUM_FUNCTION(</span><span class="hljs-type"><span class="koboSpan" id="kobo.510.1">int</span></span><span class="koboSpan" id="kobo.511.1">)
DEFINE_SUM_FUNCTION(</span><span class="hljs-type"><span class="koboSpan" id="kobo.512.1">float</span></span><span class="koboSpan" id="kobo.513.1">)
</span><span class="hljs-type"><span class="koboSpan" id="kobo.514.1">int</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.515.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.516.1">()</span></span><span class="koboSpan" id="kobo.517.1"> {
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.518.1">int</span></span><span class="koboSpan" id="kobo.519.1"> result_int = sum_int(</span><span class="hljs-number"><span class="koboSpan" id="kobo.520.1">5</span></span><span class="koboSpan" id="kobo.521.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.522.1">3</span></span><span class="koboSpan" id="kobo.523.1">);
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.524.1">printf</span></span><span class="koboSpan" id="kobo.525.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.526.1">"Sum of integers: %d\n"</span></span><span class="koboSpan" id="kobo.527.1">, result_int);
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.528.1">float</span></span><span class="koboSpan" id="kobo.529.1"> result_float = sum_float(</span><span class="hljs-number"><span class="koboSpan" id="kobo.530.1">3.5f</span></span><span class="koboSpan" id="kobo.531.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.532.1">2.5f</span></span><span class="koboSpan" id="kobo.533.1">);
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.534.1">printf</span></span><span class="koboSpan" id="kobo.535.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.536.1">"Sum of floats: %.2f\n"</span></span><span class="koboSpan" id="kobo.537.1">, result_float);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.538.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.539.1">0</span></span><span class="koboSpan" id="kobo.540.1">;
}
</span></code></pre>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.541.1">DEFINE_SUM_FUNCTION(int)</span></code><span class="koboSpan" id="kobo.542.1"> will create a </span><code class="inlineCode"><span class="koboSpan" id="kobo.543.1">sum_int</span></code><span class="koboSpan" id="kobo.544.1"> function that accepts and returns integers. </span><span class="koboSpan" id="kobo.544.2">If we call the </span><code class="inlineCode"><span class="koboSpan" id="kobo.545.1">DEFINE_SUM_FUNCTION</span></code><span class="koboSpan" id="kobo.546.1"> macro with </span><code class="inlineCode"><span class="koboSpan" id="kobo.547.1">float</span></code><span class="koboSpan" id="kobo.548.1">, it will result in creating </span><code class="inlineCode"><span class="koboSpan" id="kobo.549.1">sum_float</span></code><span class="koboSpan" id="kobo.550.1">. </span><span class="koboSpan" id="kobo.550.2">Now that </span><a id="_idIndexMarker029"/><span class="koboSpan" id="kobo.551.1">we have a good understanding of the token-pasting operator, let’s continue with ring buffer implementation:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.552.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.553.1">include</span></span><span class="hljs-meta"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.554.1">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.555.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.556.1">include</span></span><span class="hljs-meta"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.557.1">&lt;string.h&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.558.1">// Macro to declare ring buffer type and functions for a specific type and size</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.559.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.560.1">define</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.561.1"> DECLARE_RING_BUFFER(TYPE, SIZE) \</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.562.1">typedef</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.563.1">struct</span></span><span class="hljs-class"><span class="koboSpan" id="kobo.564.1"> {</span></span><span class="koboSpan" id="kobo.565.1"> \
    TYPE data[SIZE]; \
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.566.1">size_t</span></span><span class="koboSpan" id="kobo.567.1"> write_idx; \
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.568.1">size_t</span></span><span class="koboSpan" id="kobo.569.1"> read_idx; \
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.570.1">size_t</span></span><span class="koboSpan" id="kobo.571.1"> count; \
} ring_buffer_##TYPE##_##SIZE; \
</span><span class="hljs-type"><span class="koboSpan" id="kobo.572.1">void</span></span><span class="koboSpan" id="kobo.573.1"> ring_buffer_init_##TYPE##_##SIZE(ring_buffer_##TYPE##_##SIZE *rb) { \
    rb-&gt;write_idx = </span><span class="hljs-number"><span class="koboSpan" id="kobo.574.1">0</span></span><span class="koboSpan" id="kobo.575.1">; \
    rb-&gt;read_idx = </span><span class="hljs-number"><span class="koboSpan" id="kobo.576.1">0</span></span><span class="koboSpan" id="kobo.577.1">; \
    rb-&gt;count = </span><span class="hljs-number"><span class="koboSpan" id="kobo.578.1">0</span></span><span class="koboSpan" id="kobo.579.1">; \
} \
</span><span class="hljs-type"><span class="koboSpan" id="kobo.580.1">void</span></span><span class="koboSpan" id="kobo.581.1"> ring_buffer_push_##TYPE##_##SIZE(ring_buffer_##TYPE##_##SIZE *rb, TYPE value) { \
    rb-&gt;data[rb-&gt;write_idx] = value; \
    rb-&gt;write_idx = (rb-&gt;write_idx + </span><span class="hljs-number"><span class="koboSpan" id="kobo.582.1">1</span></span><span class="koboSpan" id="kobo.583.1">) % SIZE; \
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.584.1">if</span></span><span class="koboSpan" id="kobo.585.1"> (rb-&gt;count &lt; SIZE) { \
        rb-&gt;count++; \
    } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.586.1">else</span></span><span class="koboSpan" id="kobo.587.1"> { \
        rb-&gt;read_idx = (rb-&gt;read_idx + </span><span class="hljs-number"><span class="koboSpan" id="kobo.588.1">1</span></span><span class="koboSpan" id="kobo.589.1">) % SIZE; \
    } \
} \
</span><span class="hljs-type"><span class="koboSpan" id="kobo.590.1">int</span></span><span class="koboSpan" id="kobo.591.1"> ring_buffer_pop_##TYPE##_##SIZE(ring_buffer_##TYPE##_##SIZE *rb, TYPE *value) { \
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.592.1">if</span></span><span class="koboSpan" id="kobo.593.1"> (rb-&gt;count == </span><span class="hljs-number"><span class="koboSpan" id="kobo.594.1">0</span></span><span class="koboSpan" id="kobo.595.1">) { \
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.596.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.597.1">0</span></span><span class="koboSpan" id="kobo.598.1">; </span><span class="hljs-comment"><span class="koboSpan" id="kobo.599.1">/* Buffer is empty */</span></span><span class="koboSpan" id="kobo.600.1"> \
    } \
    *value = rb-&gt;data[rb-&gt;read_idx]; \
    rb-&gt;read_idx = (rb-&gt;read_idx + </span><span class="hljs-number"><span class="koboSpan" id="kobo.601.1">1</span></span><span class="koboSpan" id="kobo.602.1">) % SIZE; \
    rb-&gt;count--; \
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.603.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.604.1">1</span></span><span class="koboSpan" id="kobo.605.1">; </span><span class="hljs-comment"><span class="koboSpan" id="kobo.606.1">/* Success */</span></span><span class="koboSpan" id="kobo.607.1"> \
}
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.608.1">// Example usage with int type and size 5</span></span><span class="koboSpan" id="kobo.609.1">
DECLARE_RING_BUFFER(</span><span class="hljs-type"><span class="koboSpan" id="kobo.610.1">int</span></span><span class="koboSpan" id="kobo.611.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.612.1">5</span></span><span class="koboSpan" id="kobo.613.1">) </span><span class="hljs-comment"><span class="koboSpan" id="kobo.614.1">// Declare the ring buffer type and functions for integers</span></span>
<span class="hljs-type"><span class="koboSpan" id="kobo.615.1">int</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.616.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.617.1">()</span></span><span class="koboSpan" id="kobo.618.1"> {
    ring_buffer_int_5 rb;
    ring_buffer_init_int_5(&amp;rb); </span><span class="hljs-comment"><span class="koboSpan" id="kobo.619.1">// Initialize the ring buffer</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.620.1">// Push values into the ring buffer</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.621.1">for</span></span><span class="koboSpan" id="kobo.622.1"> (</span><span class="hljs-type"><span class="koboSpan" id="kobo.623.1">int</span></span><span class="koboSpan" id="kobo.624.1"> i = </span><span class="hljs-number"><span class="koboSpan" id="kobo.625.1">0</span></span><span class="koboSpan" id="kobo.626.1">; i &lt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.627.1">10</span></span><span class="koboSpan" id="kobo.628.1">; ++i) {
        ring_buffer_push_int_5(&amp;rb, i);
    }
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.629.1">// Pop values from the ring buffer and print them</span></span>
<span class="hljs-type"><span class="koboSpan" id="kobo.630.1">int</span></span><span class="koboSpan" id="kobo.631.1"> value;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.632.1">while</span></span><span class="koboSpan" id="kobo.633.1"> (ring_buffer_pop_int_5(&amp;rb, &amp;value)) {
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.634.1">printf</span></span><span class="koboSpan" id="kobo.635.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.636.1">"%d\n"</span></span><span class="koboSpan" id="kobo.637.1">, value);
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.638.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.639.1">0</span></span><span class="koboSpan" id="kobo.640.1">;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.641.1">Now, this solution </span><a id="_idIndexMarker030"/><span class="koboSpan" id="kobo.642.1">solves our problems of type safety and defining the size of a ring buffer, but it suffers from readability, both in implementation and when using it. </span><span class="koboSpan" id="kobo.642.2">We need to “call” </span><code class="inlineCode"><span class="koboSpan" id="kobo.643.1">DECLARE_RING_BUFFER</span></code><span class="koboSpan" id="kobo.644.1"> outside of any function, as it is basically a macro that defines a set of functions. </span><span class="koboSpan" id="kobo.644.2">We also need to know what it does and the signature of functions it will generate. </span><span class="koboSpan" id="kobo.644.3">We can do this better with templates. </span><span class="koboSpan" id="kobo.644.4">Let’s see what an implementation of a ring buffer looks like in C++.</span></p>
<h3 class="heading-3" id="_idParaDest-24"><span class="koboSpan" id="kobo.645.1">Ring buffer in C++</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.646.1">Let’s make </span><a id="_idIndexMarker031"/><span class="koboSpan" id="kobo.647.1">a generic implementation of a ring buffer using templates. </span><span class="koboSpan" id="kobo.647.2">We can use a </span><code class="inlineCode"><span class="koboSpan" id="kobo.648.1">std::array</span></code><span class="koboSpan" id="kobo.649.1"> class template as the underlying type and wrap our push-and-pop logic around it. </span><span class="koboSpan" id="kobo.649.2">The following is code that illustrates how the </span><code class="inlineCode"><span class="koboSpan" id="kobo.650.1">ring_buffer</span></code><span class="koboSpan" id="kobo.651.1"> type could look in C++:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.652.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.653.1">include</span></span><span class="hljs-meta"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.654.1">&lt;array&gt;</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.655.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.656.1">include</span></span><span class="hljs-meta"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.657.1">&lt;cstdio&gt;</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.658.1">template</span></span><span class="koboSpan" id="kobo.659.1"> &lt;</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.660.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.661.1">T</span></span><span class="koboSpan" id="kobo.662.1">, std::</span><span class="hljs-type"><span class="koboSpan" id="kobo.663.1">size_t</span></span><span class="koboSpan" id="kobo.664.1"> N&gt; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.665.1">struct</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.666.1">ring_buffer</span></span><span class="koboSpan" id="kobo.667.1"> {
  std::array&lt;T, N&gt; arr;
  std::</span><span class="hljs-type"><span class="koboSpan" id="kobo.668.1">size_t</span></span><span class="koboSpan" id="kobo.669.1"> write_idx = </span><span class="hljs-number"><span class="koboSpan" id="kobo.670.1">0</span></span><span class="koboSpan" id="kobo.671.1">; </span><span class="hljs-comment"><span class="koboSpan" id="kobo.672.1">// Index of the next element to write (push)</span></span><span class="koboSpan" id="kobo.673.1">
  std::</span><span class="hljs-type"><span class="koboSpan" id="kobo.674.1">size_t</span></span><span class="koboSpan" id="kobo.675.1"> read_idx = </span><span class="hljs-number"><span class="koboSpan" id="kobo.676.1">0</span></span><span class="koboSpan" id="kobo.677.1">;  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.678.1">// Index of the next element to read (pop)</span></span><span class="koboSpan" id="kobo.679.1">
  std::</span><span class="hljs-type"><span class="koboSpan" id="kobo.680.1">size_t</span></span><span class="koboSpan" id="kobo.681.1"> count = </span><span class="hljs-number"><span class="koboSpan" id="kobo.682.1">0</span></span><span class="koboSpan" id="kobo.683.1">;     </span><span class="hljs-comment"><span class="koboSpan" id="kobo.684.1">// Number of elements in the buffer</span></span>
<span class="hljs-type"><span class="koboSpan" id="kobo.685.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.686.1">push</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.687.1">(T t)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.688.1">{
    arr.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.689.1">at</span></span><span class="koboSpan" id="kobo.690.1">(write_idx) = t;
    write_idx = (write_idx + </span><span class="hljs-number"><span class="koboSpan" id="kobo.691.1">1</span></span><span class="koboSpan" id="kobo.692.1">) % N;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.693.1">if</span></span><span class="koboSpan" id="kobo.694.1"> (count &lt; N) {
      count++;
    } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.695.1">else</span></span><span class="koboSpan" id="kobo.696.1"> {
      </span><span class="hljs-comment"><span class="koboSpan" id="kobo.697.1">// buffer is full, move forward read_idx</span></span><span class="koboSpan" id="kobo.698.1">
      read_idx = (read_idx + </span><span class="hljs-number"><span class="koboSpan" id="kobo.699.1">1</span></span><span class="koboSpan" id="kobo.700.1">) % N;
    }
  }
  </span><span class="hljs-function"><span class="koboSpan" id="kobo.701.1">T </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.702.1">pop</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.703.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.704.1">{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.705.1">if</span></span><span class="koboSpan" id="kobo.706.1"> (count == </span><span class="hljs-number"><span class="koboSpan" id="kobo.707.1">0</span></span><span class="koboSpan" id="kobo.708.1">) {
      </span><span class="hljs-comment"><span class="koboSpan" id="kobo.709.1">// Buffer is empty, return a default-constructed T.</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.710.1">return</span></span><span class="koboSpan" id="kobo.711.1"> T{};
    }
    T value = arr.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.712.1">at</span></span><span class="koboSpan" id="kobo.713.1">(read_idx);
    read_idx = (read_idx + </span><span class="hljs-number"><span class="koboSpan" id="kobo.714.1">1</span></span><span class="koboSpan" id="kobo.715.1">) % N;
    --count;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.716.1">return</span></span><span class="koboSpan" id="kobo.717.1"> value;
  }
  </span><span class="hljs-type"><span class="koboSpan" id="kobo.718.1">bool</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.719.1">is_empty</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.720.1">()</span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="koboSpan" id="kobo.721.1">const</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.722.1">{ </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.723.1">return</span></span><span class="koboSpan" id="kobo.724.1"> count == </span><span class="hljs-number"><span class="koboSpan" id="kobo.725.1">0</span></span><span class="koboSpan" id="kobo.726.1">; }
};
</span><span class="hljs-type"><span class="koboSpan" id="kobo.727.1">int</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.728.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.729.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.730.1">{
  ring_buffer&lt;</span><span class="hljs-type"><span class="koboSpan" id="kobo.731.1">int</span></span><span class="koboSpan" id="kobo.732.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.733.1">5</span></span><span class="koboSpan" id="kobo.734.1">&gt; rb;
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.735.1">for</span></span><span class="koboSpan" id="kobo.736.1"> (</span><span class="hljs-type"><span class="koboSpan" id="kobo.737.1">int</span></span><span class="koboSpan" id="kobo.738.1"> i = </span><span class="hljs-number"><span class="koboSpan" id="kobo.739.1">0</span></span><span class="koboSpan" id="kobo.740.1">; i &lt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.741.1">10</span></span><span class="koboSpan" id="kobo.742.1">; ++i) {
    rb.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.743.1">push</span></span><span class="koboSpan" id="kobo.744.1">(i);
  }
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.745.1">while</span></span><span class="koboSpan" id="kobo.746.1"> (!rb.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.747.1">is_empty</span></span><span class="koboSpan" id="kobo.748.1">()) {
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.749.1">printf</span></span><span class="koboSpan" id="kobo.750.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.751.1">"%d\n"</span></span><span class="koboSpan" id="kobo.752.1">, rb.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.753.1">pop</span></span><span class="koboSpan" id="kobo.754.1">());
  }
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.755.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.756.1">0</span></span><span class="koboSpan" id="kobo.757.1">;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.758.1">The ring buffer implementation in C++ using templates is more readable and easier to use than the token-pasting-based solution in C. </span><span class="koboSpan" id="kobo.758.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.759.1">ring_buffer</span></code><span class="koboSpan" id="kobo.760.1"> template class can be used to instantiate ring </span><a id="_idIndexMarker032"/><span class="koboSpan" id="kobo.761.1">buffer types with integer, float, or any other underlying types with different sizes. </span><span class="koboSpan" id="kobo.761.2">The same push-and-pop logic can be applied to ring buffers </span><a id="_idIndexMarker033"/><span class="koboSpan" id="kobo.762.1">with different underlying types. </span><span class="koboSpan" id="kobo.762.2">We can apply the </span><strong class="keyWord"><span class="koboSpan" id="kobo.763.1">Don’t Repeat Yourself</span></strong><span class="koboSpan" id="kobo.764.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.765.1">DRY</span></strong><span class="koboSpan" id="kobo.766.1">) principle to </span><a id="_idIndexMarker034"/><span class="koboSpan" id="kobo.767.1">different types thanks to templates. </span><strong class="keyWord"><span class="koboSpan" id="kobo.768.1">Templates</span></strong><span class="koboSpan" id="kobo.769.1"> make generic types easy to implement, something that’s quite challenging and verbose in C.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.770.1">Templates are </span><a id="_idIndexMarker035"/><span class="koboSpan" id="kobo.771.1">also used for </span><strong class="keyWord"><span class="koboSpan" id="kobo.772.1">template metaprogramming</span></strong><span class="koboSpan" id="kobo.773.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.774.1">TMP</span></strong><span class="koboSpan" id="kobo.775.1">), a programming technique in which a compiler uses templates to generate temporary source code, which is merged by the compiler with the rest of the source code and then compiled. </span><span class="koboSpan" id="kobo.775.2">One of the most famous examples of TMP is calculating a </span><strong class="keyWord"><span class="koboSpan" id="kobo.776.1">factorial at compile time</span></strong><span class="koboSpan" id="kobo.777.1">. </span><span class="koboSpan" id="kobo.777.2">TMP is an advanced technique that will be covered in </span><a href="Chapter_08.xhtml"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.778.1">Chapter 8</span></em></span></a><span class="koboSpan" id="kobo.779.1">. </span><span class="koboSpan" id="kobo.779.2">Modern C++ also features the </span><code class="inlineCode"><span class="koboSpan" id="kobo.780.1">constexpr</span></code><span class="koboSpan" id="kobo.781.1"> specifier, a much more beginner-friendly technique for compile-time computation.</span></p>
<h2 class="heading-2" id="_idParaDest-25"><span class="koboSpan" id="kobo.782.1">constexpr</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.783.1">C++11 introduced the </span><code class="inlineCode"><span class="koboSpan" id="kobo.784.1">constexpr</span></code><span class="koboSpan" id="kobo.785.1"> specifier, which </span><a id="_idIndexMarker036"/><span class="koboSpan" id="kobo.786.1">declares that it is possible to evaluate the value of the function or a variable at compile time. </span><span class="koboSpan" id="kobo.786.2">The specifier evolved over time, extending the functionality. </span><span class="koboSpan" id="kobo.786.3">A </span><code class="inlineCode"><span class="koboSpan" id="kobo.787.1">constexpr</span></code><span class="koboSpan" id="kobo.788.1"> variable must be immediately initialized, and its type must be a </span><code class="inlineCode"><span class="koboSpan" id="kobo.789.1">literal</span></code><span class="koboSpan" id="kobo.790.1"> type (int, float, etc.). </span><span class="koboSpan" id="kobo.790.2">This is how we declare a </span><code class="inlineCode"><span class="koboSpan" id="kobo.791.1">constexpr</span></code><span class="koboSpan" id="kobo.792.1"> variable:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.793.1">constexpr</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.794.1">double</span></span><span class="koboSpan" id="kobo.795.1"> pi = </span><span class="hljs-number"><span class="koboSpan" id="kobo.796.1">3.14159265359</span></span><span class="koboSpan" id="kobo.797.1">;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.798.1">Using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.799.1">constexpr</span></code><span class="koboSpan" id="kobo.800.1"> specifier is the preferred way of declaring compile-time constants in C++ over using a C-style approach with macros. </span><span class="koboSpan" id="kobo.800.2">Let’s analyze a simple example using C-style macros:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.801.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.802.1">include</span></span><span class="hljs-meta"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.803.1">&lt;cstdio&gt;</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.804.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.805.1">define</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.806.1"> VOLTAGE 3300</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.807.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.808.1">define</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.809.1"> CURRENT 1000</span></span>
<span class="hljs-type"><span class="koboSpan" id="kobo.810.1">int</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.811.1">main</span></span> <span class="hljs-params"><span class="koboSpan" id="kobo.812.1">()</span></span><span class="koboSpan" id="kobo.813.1"> {
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.814.1">const</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.815.1">float</span></span><span class="koboSpan" id="kobo.816.1"> resistance = VOLTAGE / CURRENT;
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.817.1">printf</span></span><span class="koboSpan" id="kobo.818.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.819.1">"resistance = %.2f\r\n"</span></span><span class="koboSpan" id="kobo.820.1">, resistance);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.821.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.822.1">0</span></span><span class="koboSpan" id="kobo.823.1">;
}
</span></code></pre>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.824.1">The output of this simple program might be surprising:
resistance = 3.00
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.825.1">Both </span><code class="inlineCode"><span class="koboSpan" id="kobo.826.1">VOLTAGE</span></code><span class="koboSpan" id="kobo.827.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.828.1">CURRENT</span></code><span class="koboSpan" id="kobo.829.1"> are parsed as integer </span><code class="inlineCode"><span class="koboSpan" id="kobo.830.1">literal</span></code><span class="koboSpan" id="kobo.831.1">s, and so is the result of the division. </span><span class="koboSpan" id="kobo.831.2">Floating-point </span><code class="inlineCode"><span class="koboSpan" id="kobo.832.1">literal</span></code><span class="koboSpan" id="kobo.833.1">s are declared using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.834.1">f</span></code><span class="koboSpan" id="kobo.835.1"> suffix, which was omitted in this case. </span><span class="koboSpan" id="kobo.835.2">Using </span><code class="inlineCode"><span class="koboSpan" id="kobo.836.1">constexpr</span></code><span class="koboSpan" id="kobo.837.1"> to define </span><a id="_idIndexMarker037"/><span class="koboSpan" id="kobo.838.1">compile-time constants is safer, as it allows us to specify the type of a constant. </span><span class="koboSpan" id="kobo.838.2">This is how we would write the same example using </span><code class="inlineCode"><span class="koboSpan" id="kobo.839.1">constexpr</span></code><span class="koboSpan" id="kobo.840.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.841.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.842.1">include</span></span><span class="hljs-meta"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.843.1">&lt;cstdio&gt;</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.844.1">constexpr</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.845.1">float</span></span><span class="koboSpan" id="kobo.846.1"> voltage = </span><span class="hljs-number"><span class="koboSpan" id="kobo.847.1">3300</span></span><span class="koboSpan" id="kobo.848.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.849.1">constexpr</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.850.1">float</span></span><span class="koboSpan" id="kobo.851.1"> current = </span><span class="hljs-number"><span class="koboSpan" id="kobo.852.1">1000</span></span><span class="koboSpan" id="kobo.853.1">;
</span><span class="hljs-type"><span class="koboSpan" id="kobo.854.1">int</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.855.1">main</span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="koboSpan" id="kobo.856.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.857.1">{
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.858.1">const</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.859.1">float</span></span><span class="koboSpan" id="kobo.860.1"> resistance = voltage / current;
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.861.1">printf</span></span><span class="koboSpan" id="kobo.862.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.863.1">"resistance = %.2f\r\n"</span></span><span class="koboSpan" id="kobo.864.1">, resistance);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.865.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.866.1">0</span></span><span class="koboSpan" id="kobo.867.1">;
}
</span></code></pre>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.868.1">This would result in
resistance = 3.30
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.869.1">This simple example shows that </span><code class="inlineCode"><span class="koboSpan" id="kobo.870.1">constexpr</span></code><span class="koboSpan" id="kobo.871.1"> compile-time constants are both safer and easier to read than traditional C-style macro constants. </span><span class="koboSpan" id="kobo.871.2">The other major usage of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.872.1">constexpr</span></code><span class="koboSpan" id="kobo.873.1"> specifier is to hint to the compiler that a function can be evaluated at compile time. </span><span class="koboSpan" id="kobo.873.2">Some of the requirements that a </span><code class="inlineCode"><span class="koboSpan" id="kobo.874.1">constexpr</span></code><span class="koboSpan" id="kobo.875.1"> function must meet are as follows:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.876.1">The return type must be a </span><code class="inlineCode"><span class="koboSpan" id="kobo.877.1">literal</span></code><span class="koboSpan" id="kobo.878.1"> type</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.879.1">Each of the function parameters must be a </span><code class="inlineCode"><span class="koboSpan" id="kobo.880.1">literal</span></code><span class="koboSpan" id="kobo.881.1"> type </span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.882.1">If the </span><code class="inlineCode"><span class="koboSpan" id="kobo.883.1">constexpr</span></code><span class="koboSpan" id="kobo.884.1"> function is not a constructor, it needs to have precisely one </span><code class="inlineCode"><span class="koboSpan" id="kobo.885.1">return</span></code><span class="koboSpan" id="kobo.886.1"> statement</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.887.1">Let us examine </span><a id="_idIndexMarker038"/><span class="koboSpan" id="kobo.888.1">a simple example utilizing </span><code class="inlineCode"><span class="koboSpan" id="kobo.889.1">constexpr</span></code><span class="koboSpan" id="kobo.890.1"> functions:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-type"><span class="koboSpan" id="kobo.891.1">int</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.892.1">square</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.893.1">(</span></span><span class="hljs-type"><span class="koboSpan" id="kobo.894.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.895.1"> a)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.896.1">{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.897.1">return</span></span><span class="koboSpan" id="kobo.898.1"> a*a;
}
</span><span class="hljs-type"><span class="koboSpan" id="kobo.899.1">int</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.900.1">main</span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="koboSpan" id="kobo.901.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.902.1">{
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.903.1">int</span></span><span class="koboSpan" id="kobo.904.1"> ret = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.905.1">square</span></span><span class="koboSpan" id="kobo.906.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.907.1">2</span></span><span class="koboSpan" id="kobo.908.1">);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.909.1">return</span></span><span class="koboSpan" id="kobo.910.1"> ret;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.911.1">To better understand what is going on under the hood, we will inspect the assembly output of the preceding code. </span><span class="koboSpan" id="kobo.911.2">Assembly is quite close to the machine code, or the instructions that will be executed on our target, thus inspecting it gives us an estimate of the work (number of instructions) performed by the processor. </span><span class="koboSpan" id="kobo.911.3">The assembly output of the compilation of the preceding program for the ARM architecture using an ARM GCC compiler and no optimization is shown in the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-symbol"><span class="koboSpan" id="kobo.912.1">square</span></span><span class="koboSpan" id="kobo.913.1">(int):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.914.1">push</span></span><span class="koboSpan" id="kobo.915.1">    {</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.916.1">r7</span></span><span class="koboSpan" id="kobo.917.1">}
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.918.1">sub</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.919.1">sp</span></span><span class="koboSpan" id="kobo.920.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.921.1">sp</span></span><span class="koboSpan" id="kobo.922.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.923.1">#12</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.924.1">add</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.925.1">r7</span></span><span class="koboSpan" id="kobo.926.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.927.1">sp</span></span><span class="koboSpan" id="kobo.928.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.929.1">#0</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.930.1">str</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.931.1">r0</span></span><span class="koboSpan" id="kobo.932.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.933.1">r7</span></span><span class="koboSpan" id="kobo.934.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.935.1">#4</span></span><span class="koboSpan" id="kobo.936.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.937.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.938.1">r3</span></span><span class="koboSpan" id="kobo.939.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.940.1">r7</span></span><span class="koboSpan" id="kobo.941.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.942.1">#4</span></span><span class="koboSpan" id="kobo.943.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.944.1">mul</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.945.1">r3</span></span><span class="koboSpan" id="kobo.946.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.947.1">r3</span></span><span class="koboSpan" id="kobo.948.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.949.1">r3</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.950.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.951.1">r0</span></span><span class="koboSpan" id="kobo.952.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.953.1">r3</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.954.1">adds</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.955.1">r7</span></span><span class="koboSpan" id="kobo.956.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.957.1">r7</span></span><span class="koboSpan" id="kobo.958.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.959.1">#12</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.960.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.961.1">sp</span></span><span class="koboSpan" id="kobo.962.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.963.1">r7</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.964.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.965.1">r7</span></span><span class="koboSpan" id="kobo.966.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.967.1">sp</span></span><span class="koboSpan" id="kobo.968.1">], </span><span class="hljs-number"><span class="koboSpan" id="kobo.969.1">#4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.970.1">bx</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.971.1">lr</span></span>
<span class="hljs-symbol"><span class="koboSpan" id="kobo.972.1">main:</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.973.1">push</span></span><span class="koboSpan" id="kobo.974.1">    {</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.975.1">r7</span></span><span class="koboSpan" id="kobo.976.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.977.1">lr</span></span><span class="koboSpan" id="kobo.978.1">}
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.979.1">sub</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.980.1">sp</span></span><span class="koboSpan" id="kobo.981.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.982.1">sp</span></span><span class="koboSpan" id="kobo.983.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.984.1">#8</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.985.1">add</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.986.1">r7</span></span><span class="koboSpan" id="kobo.987.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.988.1">sp</span></span><span class="koboSpan" id="kobo.989.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.990.1">#0</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.991.1">movs</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.992.1">r0</span></span><span class="koboSpan" id="kobo.993.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.994.1">#2</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.995.1">bl</span></span><span class="koboSpan" id="kobo.996.1">      square(int)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.997.1">str</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.998.1">r0</span></span><span class="koboSpan" id="kobo.999.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1000.1">r7</span></span><span class="koboSpan" id="kobo.1001.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1002.1">#4</span></span><span class="koboSpan" id="kobo.1003.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1004.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1005.1">r3</span></span><span class="koboSpan" id="kobo.1006.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1007.1">r7</span></span><span class="koboSpan" id="kobo.1008.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1009.1">#4</span></span><span class="koboSpan" id="kobo.1010.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1011.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1012.1">r0</span></span><span class="koboSpan" id="kobo.1013.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1014.1">r3</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1015.1">adds</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1016.1">r7</span></span><span class="koboSpan" id="kobo.1017.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1018.1">r7</span></span><span class="koboSpan" id="kobo.1019.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1020.1">#8</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1021.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1022.1">sp</span></span><span class="koboSpan" id="kobo.1023.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1024.1">r7</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1025.1">pop</span></span><span class="koboSpan" id="kobo.1026.1">     {</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1027.1">r7</span></span><span class="koboSpan" id="kobo.1028.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1029.1">pc</span></span><span class="koboSpan" id="kobo.1030.1">}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1031.1">The resulting </span><a id="_idIndexMarker039"/><span class="koboSpan" id="kobo.1032.1">assembly code is doing the following:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.1033.1">Manipulating the stack pointer</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1034.1">Calling the square function</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1035.1">Storing value returned by </span><code class="inlineCode"><span class="koboSpan" id="kobo.1036.1">r0</span></code><span class="koboSpan" id="kobo.1037.1"> to address contained into </span><code class="inlineCode"><span class="koboSpan" id="kobo.1038.1">r7</span></code><span class="koboSpan" id="kobo.1039.1"> with offset </span><code class="inlineCode"><span class="koboSpan" id="kobo.1040.1">4</span></code></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1041.1">Loading the value from address stored in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1042.1">r7</span></code><span class="koboSpan" id="kobo.1043.1"> with offset </span><code class="inlineCode"><span class="koboSpan" id="kobo.1044.1">4</span></code><span class="koboSpan" id="kobo.1045.1"> into </span><code class="inlineCode"><span class="koboSpan" id="kobo.1046.1">r3</span></code></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1047.1">Moving the value from </span><code class="inlineCode"><span class="koboSpan" id="kobo.1048.1">r3</span></code><span class="koboSpan" id="kobo.1049.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1050.1">r0</span></code><span class="koboSpan" id="kobo.1051.1">, which is the ARM calling convention’s designated register for storing return values</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1052.1">We can see that there are some unnecessary operations in the output binary, which both increase the binary size and affect the performance. </span><span class="koboSpan" id="kobo.1052.2">This example is, both valid C and valid C++ code, and compiling it with both C and C++ compilers will yield the same assembly code.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1053.1">If we use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1054.1">constexpr</span></code><span class="koboSpan" id="kobo.1055.1"> specifier for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1056.1">square</span></code><span class="koboSpan" id="kobo.1057.1"> function, we are instructing the compiler that it is possible to evaluate it at compile time:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1058.1">constexpr</span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="koboSpan" id="kobo.1059.1">int</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1060.1">square</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1061.1">(</span></span><span class="hljs-type"><span class="koboSpan" id="kobo.1062.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1063.1"> a)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.1064.1">{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1065.1">return</span></span><span class="koboSpan" id="kobo.1066.1"> a*a;
}
</span><span class="hljs-type"><span class="koboSpan" id="kobo.1067.1">int</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1068.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1069.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.1070.1">{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1071.1">constexpr</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.1072.1">int</span></span><span class="koboSpan" id="kobo.1073.1"> val = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1074.1">square</span></span><span class="koboSpan" id="kobo.1075.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1076.1">2</span></span><span class="koboSpan" id="kobo.1077.1">);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1078.1">return</span></span><span class="koboSpan" id="kobo.1079.1"> ret;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1080.1">This code results in a compile-time evaluation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1081.1">square(2)</span></code><span class="koboSpan" id="kobo.1082.1"> expression, making the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1083.1">val</span></code><span class="koboSpan" id="kobo.1084.1"> integer a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1085.1">constexpr</span></code><span class="koboSpan" id="kobo.1086.1"> variable, that is, a compile-time constant. </span><span class="koboSpan" id="kobo.1086.2">The following is the resulting assembly code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-symbol"><span class="koboSpan" id="kobo.1087.1">main:</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1088.1">push</span></span><span class="koboSpan" id="kobo.1089.1">    {</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1090.1">r7</span></span><span class="koboSpan" id="kobo.1091.1">}
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1092.1">sub</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1093.1">sp</span></span><span class="koboSpan" id="kobo.1094.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1095.1">sp</span></span><span class="koboSpan" id="kobo.1096.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1097.1">#12</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1098.1">add</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1099.1">r7</span></span><span class="koboSpan" id="kobo.1100.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1101.1">sp</span></span><span class="koboSpan" id="kobo.1102.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1103.1">#0</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1104.1">movs</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1105.1">r3</span></span><span class="koboSpan" id="kobo.1106.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1107.1">#4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1108.1">str</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1109.1">r3</span></span><span class="koboSpan" id="kobo.1110.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1111.1">r7</span></span><span class="koboSpan" id="kobo.1112.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1113.1">#4</span></span><span class="koboSpan" id="kobo.1114.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1115.1">movs</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1116.1">r3</span></span><span class="koboSpan" id="kobo.1117.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1118.1">#4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1119.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1120.1">r0</span></span><span class="koboSpan" id="kobo.1121.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1122.1">r3</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1123.1">adds</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1124.1">r7</span></span><span class="koboSpan" id="kobo.1125.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1126.1">r7</span></span><span class="koboSpan" id="kobo.1127.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1128.1">#12</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1129.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1130.1">sp</span></span><span class="koboSpan" id="kobo.1131.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1132.1">r7</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1133.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1134.1">r7</span></span><span class="koboSpan" id="kobo.1135.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1136.1">sp</span></span><span class="koboSpan" id="kobo.1137.1">], </span><span class="hljs-number"><span class="koboSpan" id="kobo.1138.1">#4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1139.1">bx</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1140.1">lr</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1141.1">As we can see, the program returns the value </span><code class="inlineCode"><span class="koboSpan" id="kobo.1142.1">4</span></code><span class="koboSpan" id="kobo.1143.1">, which is the result of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1144.1">square(2)</span></code><span class="koboSpan" id="kobo.1145.1"> compile-time computation. </span><span class="koboSpan" id="kobo.1145.2">There is no </span><code class="inlineCode"><span class="koboSpan" id="kobo.1146.1">square</span></code><span class="koboSpan" id="kobo.1147.1"> function in the generated assembly, just the result of the calculation that the compiler performed for us. </span><span class="koboSpan" id="kobo.1147.2">This simple example demonstrates the power of compile-time computing. </span><span class="koboSpan" id="kobo.1147.3">We can move heavy computation from runtime to compile </span><a id="_idIndexMarker040"/><span class="koboSpan" id="kobo.1148.1">time whenever we know all the computation parameters, which is often. </span><span class="koboSpan" id="kobo.1148.2">This approach can be used to generate lookup tables or complex mathematical signals, which will be demonstrated in the following chapters of this book.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1149.1">C++ has come a long way since C with Classes. </span><span class="koboSpan" id="kobo.1149.2">The examples in this chapter show what C++ can offer over C – expressive, more readable, compact code; standard template library containers; algorithms; user-defined generic types; and compile-time computation, just to start with. </span><span class="koboSpan" id="kobo.1149.3">I hope I managed to debunk the myth that C++ is just C with classes. </span><span class="koboSpan" id="kobo.1149.4">The next common myth about C++ is that it makes bloated code and adds runtime overhead. </span><span class="koboSpan" id="kobo.1149.5">Let’s keep debunking the myths about C++!</span></p>
<h1 class="heading-1" id="_idParaDest-26"><span class="koboSpan" id="kobo.1150.1">Bloat and runtime overhead</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1151.1">The term </span><strong class="keyWord"><span class="koboSpan" id="kobo.1152.1">bloatware</span></strong><span class="koboSpan" id="kobo.1153.1"> describes </span><a id="_idIndexMarker041"/><span class="koboSpan" id="kobo.1154.1">unwanted software that is preinstalled with an OS on a device. </span><span class="koboSpan" id="kobo.1154.2">Unwanted software in the world of programming describes code inserted in a binary by a framework, a library, or a language construct itself. </span><span class="koboSpan" id="kobo.1154.3">Language constructs in C++ that are blamed for causing code bloat are constructors, destructors, and templates. </span><span class="koboSpan" id="kobo.1154.4">We will analyze these misconceptions by examining assembly output generated from C++ code.</span></p>
<h2 class="heading-2" id="_idParaDest-27"><span class="koboSpan" id="kobo.1155.1">Constructors and destructors</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1156.1">The first thing that comes to mind to non-C++ developers when you mention C++ is that it is an object-oriented </span><a id="_idIndexMarker042"/><span class="koboSpan" id="kobo.1157.1">language and that you are bound to instantiate objects. </span><span class="koboSpan" id="kobo.1157.2">Objects are instances of classes. </span><span class="koboSpan" id="kobo.1157.3">They are variables that occupy memory. </span><span class="koboSpan" id="kobo.1157.4">Special functions, called </span><strong class="keyWord"><span class="koboSpan" id="kobo.1158.1">constructors</span></strong><span class="koboSpan" id="kobo.1159.1">, are used to construct or instantiate objects.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1160.1">Constructors are used to initialize objects, including the initialization of class members, and destructors are used to clean up resources. </span><span class="koboSpan" id="kobo.1160.2">They are tightly tied to an object’s life cycle. </span><span class="koboSpan" id="kobo.1160.3">An object is created using a constructor, and when the object variable goes out of scope, the </span><strong class="keyWord"><span class="koboSpan" id="kobo.1161.1">destructor</span></strong><span class="koboSpan" id="kobo.1162.1"> is called.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1163.1">Constructors </span><a id="_idIndexMarker043"/><span class="koboSpan" id="kobo.1164.1">and destructors both increase the size of the binary and add runtime overhead, as their execution takes time. </span><span class="koboSpan" id="kobo.1164.2">We will examine the impact of constructors and destructors on a simple example of a class with one private member, a constructor, a destructor, and a getter:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1165.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1166.1">MyClass</span></span><span class="koboSpan" id="kobo.1167.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1168.1">private</span></span><span class="koboSpan" id="kobo.1169.1">:
         </span><span class="hljs-type"><span class="koboSpan" id="kobo.1170.1">int</span></span><span class="koboSpan" id="kobo.1171.1"> num;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1172.1">public</span></span><span class="koboSpan" id="kobo.1173.1">:
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1174.1">MyClass</span></span><span class="koboSpan" id="kobo.1175.1">(</span><span class="hljs-type"><span class="koboSpan" id="kobo.1176.1">int</span></span><span class="koboSpan" id="kobo.1177.1"> t_num):</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1178.1">num</span></span><span class="koboSpan" id="kobo.1179.1">(t_num){}
        ~</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1180.1">MyClass</span></span><span class="koboSpan" id="kobo.1181.1">(){}
        </span><span class="hljs-type"><span class="koboSpan" id="kobo.1182.1">int</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1183.1">getNum</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1184.1">()</span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="koboSpan" id="kobo.1185.1">const</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.1186.1">{
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1187.1">return</span></span><span class="koboSpan" id="kobo.1188.1"> num;
        }
};
</span><span class="hljs-type"><span class="koboSpan" id="kobo.1189.1">int</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1190.1">main</span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="koboSpan" id="kobo.1191.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.1192.1">{
   </span><span class="hljs-function"><span class="koboSpan" id="kobo.1193.1">MyClass </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.1194.1">obj</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1195.1">(</span></span><span class="hljs-number"><span class="koboSpan" id="kobo.1196.1">1</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1197.1">)</span></span><span class="koboSpan" id="kobo.1198.1">;
   </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1199.1">return</span></span><span class="koboSpan" id="kobo.1200.1"> obj.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1201.1">getNum</span></span><span class="koboSpan" id="kobo.1202.1">();
}
</span></code></pre>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.1203.1">MyClass</span></code><span class="koboSpan" id="kobo.1204.1"> is a very simple class </span><a id="_idIndexMarker044"/><span class="koboSpan" id="kobo.1205.1">that has one private member, which we set through the constructor. </span><span class="koboSpan" id="kobo.1205.2">We can access it through a getter, and just for good measure, we declared </span><a id="_idIndexMarker045"/><span class="koboSpan" id="kobo.1206.1">a destructor, which is empty. </span><span class="koboSpan" id="kobo.1206.2">The following is the assembly equivalent of the preceding code compiled with no optimization enabled:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-symbol"><span class="koboSpan" id="kobo.1207.1">MyClass:</span></span><span class="koboSpan" id="kobo.1208.1">:MyClass(int) [base object constructor]:
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1209.1">push</span></span><span class="koboSpan" id="kobo.1210.1">    {</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1211.1">r7</span></span><span class="koboSpan" id="kobo.1212.1">}
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1213.1">sub</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1214.1">sp</span></span><span class="koboSpan" id="kobo.1215.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1216.1">sp</span></span><span class="koboSpan" id="kobo.1217.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1218.1">#12</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1219.1">add</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1220.1">r7</span></span><span class="koboSpan" id="kobo.1221.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1222.1">sp</span></span><span class="koboSpan" id="kobo.1223.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1224.1">#0</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1225.1">str</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1226.1">r0</span></span><span class="koboSpan" id="kobo.1227.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1228.1">r7</span></span><span class="koboSpan" id="kobo.1229.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1230.1">#4</span></span><span class="koboSpan" id="kobo.1231.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1232.1">str</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1233.1">r1</span></span><span class="koboSpan" id="kobo.1234.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1235.1">r7</span></span><span class="koboSpan" id="kobo.1236.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1237.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1238.1">r3</span></span><span class="koboSpan" id="kobo.1239.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1240.1">r7</span></span><span class="koboSpan" id="kobo.1241.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1242.1">#4</span></span><span class="koboSpan" id="kobo.1243.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1244.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1245.1">r2</span></span><span class="koboSpan" id="kobo.1246.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1247.1">r7</span></span><span class="koboSpan" id="kobo.1248.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1249.1">str</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1250.1">r2</span></span><span class="koboSpan" id="kobo.1251.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1252.1">r3</span></span><span class="koboSpan" id="kobo.1253.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1254.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1255.1">r3</span></span><span class="koboSpan" id="kobo.1256.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1257.1">r7</span></span><span class="koboSpan" id="kobo.1258.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1259.1">#4</span></span><span class="koboSpan" id="kobo.1260.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1261.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1262.1">r0</span></span><span class="koboSpan" id="kobo.1263.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1264.1">r3</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1265.1">adds</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1266.1">r7</span></span><span class="koboSpan" id="kobo.1267.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1268.1">r7</span></span><span class="koboSpan" id="kobo.1269.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1270.1">#12</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1271.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1272.1">sp</span></span><span class="koboSpan" id="kobo.1273.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1274.1">r7</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1275.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1276.1">r7</span></span><span class="koboSpan" id="kobo.1277.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1278.1">sp</span></span><span class="koboSpan" id="kobo.1279.1">], </span><span class="hljs-number"><span class="koboSpan" id="kobo.1280.1">#4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1281.1">bx</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1282.1">lr</span></span>
<span class="hljs-symbol"><span class="koboSpan" id="kobo.1283.1">MyClass:</span></span><span class="koboSpan" id="kobo.1284.1">:~MyClass() [base object destructor]:
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1285.1">push</span></span><span class="koboSpan" id="kobo.1286.1">    {</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1287.1">r7</span></span><span class="koboSpan" id="kobo.1288.1">}
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1289.1">sub</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1290.1">sp</span></span><span class="koboSpan" id="kobo.1291.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1292.1">sp</span></span><span class="koboSpan" id="kobo.1293.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1294.1">#12</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1295.1">add</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1296.1">r7</span></span><span class="koboSpan" id="kobo.1297.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1298.1">sp</span></span><span class="koboSpan" id="kobo.1299.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1300.1">#0</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1301.1">str</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1302.1">r0</span></span><span class="koboSpan" id="kobo.1303.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1304.1">r7</span></span><span class="koboSpan" id="kobo.1305.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1306.1">#4</span></span><span class="koboSpan" id="kobo.1307.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1308.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1309.1">r3</span></span><span class="koboSpan" id="kobo.1310.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1311.1">r7</span></span><span class="koboSpan" id="kobo.1312.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1313.1">#4</span></span><span class="koboSpan" id="kobo.1314.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1315.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1316.1">r0</span></span><span class="koboSpan" id="kobo.1317.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1318.1">r3</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1319.1">adds</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1320.1">r7</span></span><span class="koboSpan" id="kobo.1321.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1322.1">r7</span></span><span class="koboSpan" id="kobo.1323.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1324.1">#12</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1325.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1326.1">sp</span></span><span class="koboSpan" id="kobo.1327.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1328.1">r7</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1329.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1330.1">r7</span></span><span class="koboSpan" id="kobo.1331.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1332.1">sp</span></span><span class="koboSpan" id="kobo.1333.1">], </span><span class="hljs-number"><span class="koboSpan" id="kobo.1334.1">#4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1335.1">bx</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1336.1">lr</span></span>
<span class="hljs-symbol"><span class="koboSpan" id="kobo.1337.1">MyClass:</span></span><span class="koboSpan" id="kobo.1338.1">:getNum() const:
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1339.1">push</span></span><span class="koboSpan" id="kobo.1340.1">    {</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1341.1">r7</span></span><span class="koboSpan" id="kobo.1342.1">}
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1343.1">sub</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1344.1">sp</span></span><span class="koboSpan" id="kobo.1345.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1346.1">sp</span></span><span class="koboSpan" id="kobo.1347.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1348.1">#12</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1349.1">add</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1350.1">r7</span></span><span class="koboSpan" id="kobo.1351.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1352.1">sp</span></span><span class="koboSpan" id="kobo.1353.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1354.1">#0</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1355.1">str</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1356.1">r0</span></span><span class="koboSpan" id="kobo.1357.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1358.1">r7</span></span><span class="koboSpan" id="kobo.1359.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1360.1">#4</span></span><span class="koboSpan" id="kobo.1361.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1362.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1363.1">r3</span></span><span class="koboSpan" id="kobo.1364.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1365.1">r7</span></span><span class="koboSpan" id="kobo.1366.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1367.1">#4</span></span><span class="koboSpan" id="kobo.1368.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1369.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1370.1">r3</span></span><span class="koboSpan" id="kobo.1371.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1372.1">r3</span></span><span class="koboSpan" id="kobo.1373.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1374.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1375.1">r0</span></span><span class="koboSpan" id="kobo.1376.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1377.1">r3</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1378.1">adds</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1379.1">r7</span></span><span class="koboSpan" id="kobo.1380.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1381.1">r7</span></span><span class="koboSpan" id="kobo.1382.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1383.1">#12</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1384.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1385.1">sp</span></span><span class="koboSpan" id="kobo.1386.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1387.1">r7</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1388.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1389.1">r7</span></span><span class="koboSpan" id="kobo.1390.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1391.1">sp</span></span><span class="koboSpan" id="kobo.1392.1">], </span><span class="hljs-number"><span class="koboSpan" id="kobo.1393.1">#4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1394.1">bx</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1395.1">lr</span></span>
<span class="hljs-symbol"><span class="koboSpan" id="kobo.1396.1">main:</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1397.1">push</span></span><span class="koboSpan" id="kobo.1398.1">    {</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1399.1">r4</span></span><span class="koboSpan" id="kobo.1400.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1401.1">r7</span></span><span class="koboSpan" id="kobo.1402.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1403.1">lr</span></span><span class="koboSpan" id="kobo.1404.1">}
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1405.1">sub</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1406.1">sp</span></span><span class="koboSpan" id="kobo.1407.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1408.1">sp</span></span><span class="koboSpan" id="kobo.1409.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1410.1">#12</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1411.1">add</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1412.1">r7</span></span><span class="koboSpan" id="kobo.1413.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1414.1">sp</span></span><span class="koboSpan" id="kobo.1415.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1416.1">#0</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1417.1">adds</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1418.1">r3</span></span><span class="koboSpan" id="kobo.1419.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1420.1">r7</span></span><span class="koboSpan" id="kobo.1421.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1422.1">#4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1423.1">movs</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1424.1">r1</span></span><span class="koboSpan" id="kobo.1425.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1426.1">#1</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1427.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1428.1">r0</span></span><span class="koboSpan" id="kobo.1429.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1430.1">r3</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1431.1">bl</span></span><span class="koboSpan" id="kobo.1432.1">      MyClass::MyClass(int) [complete object constructor]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1433.1">adds</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1434.1">r3</span></span><span class="koboSpan" id="kobo.1435.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1436.1">r7</span></span><span class="koboSpan" id="kobo.1437.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1438.1">#4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1439.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1440.1">r0</span></span><span class="koboSpan" id="kobo.1441.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1442.1">r3</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1443.1">bl</span></span><span class="koboSpan" id="kobo.1444.1">      MyClass::getNum() const
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1445.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1446.1">r4</span></span><span class="koboSpan" id="kobo.1447.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1448.1">r0</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1449.1">nop</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1450.1">adds</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1451.1">r3</span></span><span class="koboSpan" id="kobo.1452.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1453.1">r7</span></span><span class="koboSpan" id="kobo.1454.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1455.1">#4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1456.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1457.1">r0</span></span><span class="koboSpan" id="kobo.1458.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1459.1">r3</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1460.1">bl</span></span><span class="koboSpan" id="kobo.1461.1">      MyClass::~MyClass() [complete object destructor]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1462.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1463.1">r3</span></span><span class="koboSpan" id="kobo.1464.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1465.1">r4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1466.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1467.1">r0</span></span><span class="koboSpan" id="kobo.1468.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1469.1">r3</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1470.1">adds</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1471.1">r7</span></span><span class="koboSpan" id="kobo.1472.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1473.1">r7</span></span><span class="koboSpan" id="kobo.1474.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1475.1">#12</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1476.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1477.1">sp</span></span><span class="koboSpan" id="kobo.1478.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1479.1">r7</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1480.1">pop</span></span><span class="koboSpan" id="kobo.1481.1">     {</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1482.1">r4</span></span><span class="koboSpan" id="kobo.1483.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1484.1">r7</span></span><span class="koboSpan" id="kobo.1485.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1486.1">pc</span></span><span class="koboSpan" id="kobo.1487.1">}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1488.1">Don’t worry about the assembly if you don’t understand it. </span><span class="koboSpan" id="kobo.1488.2">We can see there are some labels for functions and a whole lot of instructions. </span><span class="koboSpan" id="kobo.1488.3">That’s a lot of instructions for a simple abstraction of a class; this is the bloat code that we don’t want in our binary. </span><span class="koboSpan" id="kobo.1488.4">To be more precise, we have 59 lines of assembly code. </span><span class="koboSpan" id="kobo.1488.5">If we were to enable optimization, the resulting assembly would be </span><a id="_idIndexMarker046"/><span class="koboSpan" id="kobo.1489.1">a couple of lines long, but let’s keep analyzing this problem with </span><a id="_idIndexMarker047"/><span class="koboSpan" id="kobo.1490.1">no optimization involved. </span><span class="koboSpan" id="kobo.1490.2">The first thing we are noticing is that the destructor doesn’t do anything useful. </span><span class="koboSpan" id="kobo.1490.3">If we remove it from the C++ code, the resulting assembly is 44 lines long:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-symbol"><span class="koboSpan" id="kobo.1491.1">MyClass:</span></span><span class="koboSpan" id="kobo.1492.1">:MyClass(int) [base object constructor]:
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1493.1">push</span></span><span class="koboSpan" id="kobo.1494.1">    {</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1495.1">r7</span></span><span class="koboSpan" id="kobo.1496.1">}
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1497.1">sub</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1498.1">sp</span></span><span class="koboSpan" id="kobo.1499.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1500.1">sp</span></span><span class="koboSpan" id="kobo.1501.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1502.1">#12</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1503.1">add</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1504.1">r7</span></span><span class="koboSpan" id="kobo.1505.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1506.1">sp</span></span><span class="koboSpan" id="kobo.1507.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1508.1">#0</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1509.1">str</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1510.1">r0</span></span><span class="koboSpan" id="kobo.1511.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1512.1">r7</span></span><span class="koboSpan" id="kobo.1513.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1514.1">#4</span></span><span class="koboSpan" id="kobo.1515.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1516.1">str</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1517.1">r1</span></span><span class="koboSpan" id="kobo.1518.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1519.1">r7</span></span><span class="koboSpan" id="kobo.1520.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1521.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1522.1">r3</span></span><span class="koboSpan" id="kobo.1523.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1524.1">r7</span></span><span class="koboSpan" id="kobo.1525.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1526.1">#4</span></span><span class="koboSpan" id="kobo.1527.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1528.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1529.1">r2</span></span><span class="koboSpan" id="kobo.1530.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1531.1">r7</span></span><span class="koboSpan" id="kobo.1532.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1533.1">str</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1534.1">r2</span></span><span class="koboSpan" id="kobo.1535.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1536.1">r3</span></span><span class="koboSpan" id="kobo.1537.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1538.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1539.1">r3</span></span><span class="koboSpan" id="kobo.1540.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1541.1">r7</span></span><span class="koboSpan" id="kobo.1542.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1543.1">#4</span></span><span class="koboSpan" id="kobo.1544.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1545.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1546.1">r0</span></span><span class="koboSpan" id="kobo.1547.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1548.1">r3</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1549.1">adds</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1550.1">r7</span></span><span class="koboSpan" id="kobo.1551.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1552.1">r7</span></span><span class="koboSpan" id="kobo.1553.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1554.1">#12</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1555.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1556.1">sp</span></span><span class="koboSpan" id="kobo.1557.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1558.1">r7</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1559.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1560.1">r7</span></span><span class="koboSpan" id="kobo.1561.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1562.1">sp</span></span><span class="koboSpan" id="kobo.1563.1">], </span><span class="hljs-number"><span class="koboSpan" id="kobo.1564.1">#4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1565.1">bx</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1566.1">lr</span></span>
<span class="hljs-symbol"><span class="koboSpan" id="kobo.1567.1">MyClass:</span></span><span class="koboSpan" id="kobo.1568.1">:getNum() const:
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1569.1">push</span></span><span class="koboSpan" id="kobo.1570.1">    {</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1571.1">r7</span></span><span class="koboSpan" id="kobo.1572.1">}
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1573.1">sub</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1574.1">sp</span></span><span class="koboSpan" id="kobo.1575.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1576.1">sp</span></span><span class="koboSpan" id="kobo.1577.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1578.1">#12</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1579.1">add</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1580.1">r7</span></span><span class="koboSpan" id="kobo.1581.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1582.1">sp</span></span><span class="koboSpan" id="kobo.1583.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1584.1">#0</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1585.1">str</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1586.1">r0</span></span><span class="koboSpan" id="kobo.1587.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1588.1">r7</span></span><span class="koboSpan" id="kobo.1589.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1590.1">#4</span></span><span class="koboSpan" id="kobo.1591.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1592.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1593.1">r3</span></span><span class="koboSpan" id="kobo.1594.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1595.1">r7</span></span><span class="koboSpan" id="kobo.1596.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1597.1">#4</span></span><span class="koboSpan" id="kobo.1598.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1599.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1600.1">r3</span></span><span class="koboSpan" id="kobo.1601.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1602.1">r3</span></span><span class="koboSpan" id="kobo.1603.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1604.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1605.1">r0</span></span><span class="koboSpan" id="kobo.1606.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1607.1">r3</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1608.1">adds</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1609.1">r7</span></span><span class="koboSpan" id="kobo.1610.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1611.1">r7</span></span><span class="koboSpan" id="kobo.1612.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1613.1">#12</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1614.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1615.1">sp</span></span><span class="koboSpan" id="kobo.1616.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1617.1">r7</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1618.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1619.1">r7</span></span><span class="koboSpan" id="kobo.1620.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1621.1">sp</span></span><span class="koboSpan" id="kobo.1622.1">], </span><span class="hljs-number"><span class="koboSpan" id="kobo.1623.1">#4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1624.1">bx</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1625.1">lr</span></span>
<span class="hljs-symbol"><span class="koboSpan" id="kobo.1626.1">main:</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1627.1">push</span></span><span class="koboSpan" id="kobo.1628.1">    {</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1629.1">r7</span></span><span class="koboSpan" id="kobo.1630.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1631.1">lr</span></span><span class="koboSpan" id="kobo.1632.1">}
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1633.1">sub</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1634.1">sp</span></span><span class="koboSpan" id="kobo.1635.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1636.1">sp</span></span><span class="koboSpan" id="kobo.1637.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1638.1">#8</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1639.1">add</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1640.1">r7</span></span><span class="koboSpan" id="kobo.1641.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1642.1">sp</span></span><span class="koboSpan" id="kobo.1643.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1644.1">#0</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1645.1">adds</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1646.1">r3</span></span><span class="koboSpan" id="kobo.1647.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1648.1">r7</span></span><span class="koboSpan" id="kobo.1649.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1650.1">#4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1651.1">movs</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1652.1">r1</span></span><span class="koboSpan" id="kobo.1653.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1654.1">#1</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1655.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1656.1">r0</span></span><span class="koboSpan" id="kobo.1657.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1658.1">r3</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1659.1">bl</span></span><span class="koboSpan" id="kobo.1660.1">      MyClass::MyClass(int) [complete object constructor]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1661.1">adds</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1662.1">r3</span></span><span class="koboSpan" id="kobo.1663.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1664.1">r7</span></span><span class="koboSpan" id="kobo.1665.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1666.1">#4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1667.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1668.1">r0</span></span><span class="koboSpan" id="kobo.1669.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1670.1">r3</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1671.1">bl</span></span><span class="koboSpan" id="kobo.1672.1">      MyClass::getNum() const
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1673.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1674.1">r3</span></span><span class="koboSpan" id="kobo.1675.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1676.1">r0</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1677.1">nop</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1678.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1679.1">r0</span></span><span class="koboSpan" id="kobo.1680.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1681.1">r3</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1682.1">adds</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1683.1">r7</span></span><span class="koboSpan" id="kobo.1684.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1685.1">r7</span></span><span class="koboSpan" id="kobo.1686.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1687.1">#8</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1688.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1689.1">sp</span></span><span class="koboSpan" id="kobo.1690.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1691.1">r7</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1692.1">pop</span></span><span class="koboSpan" id="kobo.1693.1">     {</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1694.1">r7</span></span><span class="koboSpan" id="kobo.1695.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1696.1">pc</span></span><span class="koboSpan" id="kobo.1697.1">}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1698.1">As we can see, there is no call to the destructor, and there is no destructor code in the binary. </span><span class="koboSpan" id="kobo.1698.2">The lesson is </span><em class="italic"><span class="koboSpan" id="kobo.1699.1">you don’t pay for what you don’t use</span></em><span class="koboSpan" id="kobo.1700.1">. </span><span class="koboSpan" id="kobo.1700.2">This is one of the design principles of C++. </span><span class="koboSpan" id="kobo.1700.3">By deleting </span><a id="_idIndexMarker048"/><span class="koboSpan" id="kobo.1701.1">the destructor, there is no need for the compiler to generate any code for it and to call it when the object variable goes out of the scope.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1702.1">The next thing </span><a id="_idIndexMarker049"/><span class="koboSpan" id="kobo.1703.1">we must realize is that C++ is not an OOP language. </span><span class="koboSpan" id="kobo.1703.2">It is a multiparadigm language. </span><span class="koboSpan" id="kobo.1703.3">It is procedural, object-oriented, generic, and even a little bit functional at the same time. </span><span class="koboSpan" id="kobo.1703.4">If we want to have private members that can be set only through constructors, then we need to pay the price for that. </span><span class="koboSpan" id="kobo.1703.5">Structs in C++ have public members by default, so let’s change the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1704.1">MyClass</span></code><span class="koboSpan" id="kobo.1705.1"> class to a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1706.1">MyClass</span></code><span class="koboSpan" id="kobo.1707.1"> struct with no constructor:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1708.1">struct</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1709.1">MyClass</span></span><span class="koboSpan" id="kobo.1710.1">
{
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.1711.1">int</span></span><span class="koboSpan" id="kobo.1712.1"> num;
};
</span><span class="hljs-type"><span class="koboSpan" id="kobo.1713.1">int</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1714.1">main</span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="koboSpan" id="kobo.1715.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.1716.1">{
   </span><span class="hljs-function"><span class="koboSpan" id="kobo.1717.1">MyClass </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.1718.1">obj</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1719.1">(</span></span><span class="hljs-number"><span class="koboSpan" id="kobo.1720.1">1</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1721.1">)</span></span><span class="koboSpan" id="kobo.1722.1">;
  
   </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1723.1">return</span></span><span class="koboSpan" id="kobo.1724.1"> obj.num;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1725.1">Setter and getter functions are common in the OOP paradigm, but C++ is not (just) an OOP language and we are not bound to using setters and getters. </span><span class="koboSpan" id="kobo.1725.2">When we remove the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1726.1">getNum</span></code><span class="koboSpan" id="kobo.1727.1"> getter, we have a very basic example of a struct with just one member. </span><span class="koboSpan" id="kobo.1727.2">The resulting assembly is only 14 lines long:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-symbol"><span class="koboSpan" id="kobo.1728.1">main:</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1729.1">push</span></span><span class="koboSpan" id="kobo.1730.1">    {</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1731.1">r7</span></span><span class="koboSpan" id="kobo.1732.1">}
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1733.1">sub</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1734.1">sp</span></span><span class="koboSpan" id="kobo.1735.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1736.1">sp</span></span><span class="koboSpan" id="kobo.1737.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1738.1">#12</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1739.1">add</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1740.1">r7</span></span><span class="koboSpan" id="kobo.1741.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1742.1">sp</span></span><span class="koboSpan" id="kobo.1743.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1744.1">#0</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1745.1">movs</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1746.1">r3</span></span><span class="koboSpan" id="kobo.1747.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1748.1">#1</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1749.1">str</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1750.1">r3</span></span><span class="koboSpan" id="kobo.1751.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1752.1">r7</span></span><span class="koboSpan" id="kobo.1753.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1754.1">#4</span></span><span class="koboSpan" id="kobo.1755.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1756.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1757.1">r3</span></span><span class="koboSpan" id="kobo.1758.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1759.1">r7</span></span><span class="koboSpan" id="kobo.1760.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1761.1">#4</span></span><span class="koboSpan" id="kobo.1762.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1763.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1764.1">r0</span></span><span class="koboSpan" id="kobo.1765.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1766.1">r3</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1767.1">adds</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1768.1">r7</span></span><span class="koboSpan" id="kobo.1769.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1770.1">r7</span></span><span class="koboSpan" id="kobo.1771.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1772.1">#12</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1773.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1774.1">sp</span></span><span class="koboSpan" id="kobo.1775.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1776.1">r7</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1777.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1778.1">r7</span></span><span class="koboSpan" id="kobo.1779.1">, [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1780.1">sp</span></span><span class="koboSpan" id="kobo.1781.1">], </span><span class="hljs-number"><span class="koboSpan" id="kobo.1782.1">#4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1783.1">bx</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1784.1">lr</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1785.1">As trivial as this example is, its purpose is to establish two ground truths:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.1786.1">You don’t pay for what you don’t use</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1787.1">Using C++ doesn’t mean you are bound to an OOP paradigm</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1788.1">We need to pay the price in binary size if we want to use abstractions such as constructors and destructors. </span><span class="koboSpan" id="kobo.1788.2">Using types (classes and structs) without instantiating objects in C++ offers significant benefits </span><a id="_idIndexMarker050"/><span class="koboSpan" id="kobo.1789.1">to your embedded software design beyond traditional </span><a id="_idIndexMarker051"/><span class="koboSpan" id="kobo.1790.1">object-oriented approaches. </span><span class="koboSpan" id="kobo.1790.2">We’ll explore this through detailed examples in the upcoming chapters.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1791.1">In this and previous examples, we compiled C++ code with disabled optimizations, and we were able to see the resulting assembly code results in unnecessary operations that can be removed. </span><span class="koboSpan" id="kobo.1791.2">Let’s check the assembly code for the last example with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1792.1">O3</span></code><span class="koboSpan" id="kobo.1793.1"> optimization level enabled:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-symbol"><span class="koboSpan" id="kobo.1794.1">main:</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1795.1">movs</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1796.1">r0</span></span><span class="koboSpan" id="kobo.1797.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1798.1">#1</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1799.1">bx</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1800.1">lr</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1801.1">The preceding assembly is the output of the original example with the class, constructor, destructor, and getter function. </span><span class="koboSpan" id="kobo.1801.2">The resulting program has just two instructions. </span><span class="koboSpan" id="kobo.1801.3">The value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1802.1">num</span></code><span class="koboSpan" id="kobo.1803.1"> member of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1804.1">obj</span></code><span class="koboSpan" id="kobo.1805.1"> variable is stored in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1806.1">r0</span></code><span class="koboSpan" id="kobo.1807.1"> register as the return value. </span><span class="koboSpan" id="kobo.1807.2">Assembly code is stripped of all necessary instructions related to stack manipulation and usage of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1808.1">r3</span></code><span class="koboSpan" id="kobo.1809.1"> to store a value in a stack pointer with an offset of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1810.1">4</span></code><span class="koboSpan" id="kobo.1811.1">, reload it to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1812.1">r3</span></code><span class="koboSpan" id="kobo.1813.1">, and move it to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1814.1">r0</span></code><span class="koboSpan" id="kobo.1815.1">. </span><span class="koboSpan" id="kobo.1815.2">The resulting assembly is just a few lines of code.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1816.1">Removing unnecessary instructions is a job for the optimization process. </span><span class="koboSpan" id="kobo.1816.2">Yet, optimization is often avoided in embedded projects, as some claim that it breaks code. </span><span class="koboSpan" id="kobo.1816.3">But is that true?</span></p>
<h2 class="heading-2" id="_idParaDest-28"><span class="koboSpan" id="kobo.1817.1">Optimization</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1818.1">Unoptimized code results in unnecessary instructions affecting binary size and performance. </span><span class="koboSpan" id="kobo.1818.2">However, many embedded </span><a id="_idIndexMarker052"/><span class="koboSpan" id="kobo.1819.1">projects are still built with disabled optimization, as developers </span><em class="italic"><span class="koboSpan" id="kobo.1820.1">do not trust the compiler</span></em><span class="koboSpan" id="kobo.1821.1"> and are afraid it will </span><em class="italic"><span class="koboSpan" id="kobo.1822.1">break the program</span></em><span class="koboSpan" id="kobo.1823.1">. </span><span class="koboSpan" id="kobo.1823.2">There is some truth to this, but as it turns out, this happens when the program is not well formed. </span><span class="koboSpan" id="kobo.1823.3">The program is not well formed if it contains undefined behavior.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1824.1">One of the best-known </span><a id="_idIndexMarker053"/><span class="koboSpan" id="kobo.1825.1">examples of undefined behavior is signed </span><strong class="keyWord"><span class="koboSpan" id="kobo.1826.1">integer overflow</span></strong><span class="koboSpan" id="kobo.1827.1">. </span><span class="koboSpan" id="kobo.1827.2">The standard doesn’t define what happens if you add </span><code class="inlineCode"><span class="koboSpan" id="kobo.1828.1">1</span></code><span class="koboSpan" id="kobo.1829.1"> to the maximum value of the signed integer on your platform. </span><span class="koboSpan" id="kobo.1829.2">The compiled program is not required to do anything meaningful. </span><span class="koboSpan" id="kobo.1829.3">A program is not well formed. </span><span class="koboSpan" id="kobo.1829.4">Let’s examine the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.1830.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1831.1">include</span></span><span class="hljs-meta"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.1832.1">&lt;cstdio&gt;</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.1833.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1834.1">include</span></span><span class="hljs-meta"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.1835.1">&lt;limits&gt;</span></span>
<span class="hljs-type"><span class="koboSpan" id="kobo.1836.1">int</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1837.1">foo</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1838.1">(</span></span><span class="hljs-type"><span class="koboSpan" id="kobo.1839.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1840.1"> x)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.1841.1">{
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.1842.1">int</span></span><span class="koboSpan" id="kobo.1843.1"> y = x + </span><span class="hljs-number"><span class="koboSpan" id="kobo.1844.1">1</span></span><span class="koboSpan" id="kobo.1845.1">;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1846.1">return</span></span><span class="koboSpan" id="kobo.1847.1"> y &gt; x;
}
</span><span class="hljs-type"><span class="koboSpan" id="kobo.1848.1">int</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1849.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1850.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.1851.1">{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1852.1">if</span></span><span class="koboSpan" id="kobo.1853.1">(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1854.1">foo</span></span><span class="koboSpan" id="kobo.1855.1">(std::numeric_limits&lt;</span><span class="hljs-type"><span class="koboSpan" id="kobo.1856.1">int</span></span><span class="koboSpan" id="kobo.1857.1">&gt;::</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1858.1">max</span></span><span class="koboSpan" id="kobo.1859.1">())) {
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1860.1">printf</span></span><span class="koboSpan" id="kobo.1861.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1862.1">"X is larger than X + 1\r\n"</span></span><span class="koboSpan" id="kobo.1863.1">);
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1864.1">else</span></span><span class="koboSpan" id="kobo.1865.1"> {
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1866.1">printf</span></span><span class="koboSpan" id="kobo.1867.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1868.1">"X is NOT larger than X + 1. </span><span class="koboSpan" id="kobo.1868.2">Oh nooo !\r\n"</span></span><span class="koboSpan" id="kobo.1869.1">);
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1870.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.1871.1">0</span></span><span class="koboSpan" id="kobo.1872.1">;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1873.1">Compiling the code using GCC for both x86 and Arm Cortex-M4 will yield the same results. </span><span class="koboSpan" id="kobo.1873.2">If the program is compiled without the optimization, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1874.1">foo</span></code><span class="koboSpan" id="kobo.1875.1"> function returns </span><code class="inlineCode"><span class="koboSpan" id="kobo.1876.1">0</span></code><span class="koboSpan" id="kobo.1877.1">, and you can see </span><strong class="screenText"><span class="koboSpan" id="kobo.1878.1">X is NOT larger than X + 1. </span><span class="koboSpan" id="kobo.1878.2">Oh nooo !</span></strong><span class="koboSpan" id="kobo.1879.1"> in the output. </span><span class="koboSpan" id="kobo.1879.2">The compiler does the integer overflow, and if we pass the maximum integer value to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1880.1">foo</span></code><span class="koboSpan" id="kobo.1881.1">, it will return </span><code class="inlineCode"><span class="koboSpan" id="kobo.1882.1">0</span></code><span class="koboSpan" id="kobo.1883.1">. </span><span class="koboSpan" id="kobo.1883.2">Keep in mind that the standard does not specify this, and this behavior depends on the compiler. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1884.1">If we compile the program with optimization enabled, the output is </span><strong class="screenText"><span class="koboSpan" id="kobo.1885.1">X is larger than X + 1</span></strong><code class="inlineCode"><span class="koboSpan" id="kobo.1886.1">,</span></code><span class="koboSpan" id="kobo.1887.1"> which means that </span><code class="inlineCode"><span class="koboSpan" id="kobo.1888.1">foo</span></code><span class="koboSpan" id="kobo.1889.1"> returns </span><code class="inlineCode"><span class="koboSpan" id="kobo.1890.1">1</span></code><span class="koboSpan" id="kobo.1891.1">. </span><span class="koboSpan" id="kobo.1891.2">Let’s examine the assembly output of the program compiled with the optimization:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-symbol"><span class="koboSpan" id="kobo.1892.1">foo</span></span><span class="koboSpan" id="kobo.1893.1">(int):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1894.1">movs</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1895.1">r0</span></span><span class="koboSpan" id="kobo.1896.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1897.1">#1</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1898.1">bx</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1899.1">lr</span></span>
<span class="hljs-symbol"><span class="koboSpan" id="kobo.1900.1">.LC0:</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.1901.1">.ascii</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1902.1">"X is larger then X + 1\015\000"</span></span>
<span class="hljs-symbol"><span class="koboSpan" id="kobo.1903.1">main:</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1904.1">push</span></span><span class="koboSpan" id="kobo.1905.1">    {</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1906.1">r3</span></span><span class="koboSpan" id="kobo.1907.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1908.1">lr</span></span><span class="koboSpan" id="kobo.1909.1">}
        movw    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1910.1">r0</span></span><span class="koboSpan" id="kobo.1911.1">, #:lower16:.LC0
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1912.1">movt</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1913.1">r0</span></span><span class="koboSpan" id="kobo.1914.1">, #:upper16:.LC0
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1915.1">bl</span></span><span class="koboSpan" id="kobo.1916.1">      puts
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1917.1">movs</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1918.1">r0</span></span><span class="koboSpan" id="kobo.1919.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1920.1">#0</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1921.1">pop</span></span><span class="koboSpan" id="kobo.1922.1">     {</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1923.1">r3</span></span><span class="koboSpan" id="kobo.1924.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1925.1">pc</span></span><span class="koboSpan" id="kobo.1926.1">}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1927.1">As we can see, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1928.1">foo</span></code><span class="koboSpan" id="kobo.1929.1"> doesn’t perform any calculations. </span><span class="koboSpan" id="kobo.1929.2">The compiler assumes that the program is well formed and that there is no undefined behavior. </span><code class="inlineCode"><span class="koboSpan" id="kobo.1930.1">foo</span></code><span class="koboSpan" id="kobo.1931.1"> will always return </span><code class="inlineCode"><span class="koboSpan" id="kobo.1932.1">1</span></code><span class="koboSpan" id="kobo.1933.1">. </span><span class="koboSpan" id="kobo.1933.2">It is up to the developer to ensure that there is no undefined behavior in the program. </span><span class="koboSpan" id="kobo.1933.3">This is exactly the reason why the myth that the optimization breaks the program is still alive. </span><span class="koboSpan" id="kobo.1933.4">It is easier to blame the compiler for not handling the undefined behavior.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1934.1">Of course, it is possible that there is a bug in a compiler that breaks the functionality of the program if the optimization is used, and the program works fine if it is disabled. </span><span class="koboSpan" id="kobo.1934.2">This is very rare but not unheard of, and that’s why there are verification techniques such as unit and integration testing that ensure the functionality of the code, whether it is built with or without the optimization enabled.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1935.1">Optimization is </span><a id="_idIndexMarker054"/><span class="koboSpan" id="kobo.1936.1">reducing the binary size and improving performance by removing unnecessary instructions from the machine code. </span><span class="koboSpan" id="kobo.1936.2">Undefined behavior is compiler-dependent and must be handled by the developer to ensure the program is well formed. </span><span class="koboSpan" id="kobo.1936.3">Techniques such as unit and integration testing should be put in place to validate the functionality of the program, mitigating the risk of compiler malforming the program. </span><span class="koboSpan" id="kobo.1936.4">The optimization process is essential for using abstractions in C++ code while keeping the binary footprint minimum and performance at a maximum. </span><span class="koboSpan" id="kobo.1936.5">We will use the highest optimization level, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1937.1">O3</span></code><span class="koboSpan" id="kobo.1938.1">, in the rest of the book.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1939.1">The next suspect for code bloat that we will examine are templates. </span><span class="koboSpan" id="kobo.1939.2">How do they cause the code bloat, and what value do they bring to our embedded code bases?</span></p>
<h2 class="heading-2" id="_idParaDest-29"><span class="koboSpan" id="kobo.1940.1">Templates</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1941.1">Instantiating </span><strong class="keyWord"><span class="koboSpan" id="kobo.1942.1">templates</span></strong><span class="koboSpan" id="kobo.1943.1"> with different </span><a id="_idIndexMarker055"/><span class="koboSpan" id="kobo.1944.1">parameters will result in the compiler generating distinct types, which effectively increases the binary size. </span><span class="koboSpan" id="kobo.1944.2">This is to be expected. </span><span class="koboSpan" id="kobo.1944.3">We have the exact same situation with the generic implementation of a ring buffer in C using the token-pasting operator and macros. </span><span class="koboSpan" id="kobo.1944.4">An alternative is type erasure, which we used in C implementation using a void pointer. </span><span class="koboSpan" id="kobo.1944.5">It suffers in flexibility if we impose the restriction of static data allocation and performance due to pointer indirection.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1945.1">Using generic types is a choice of design. </span><span class="koboSpan" id="kobo.1945.2">We can use them and pay the price in increased binary size, but that would also happen if we were to implement ring buffers for different data types separately (</span><code class="inlineCode"><span class="koboSpan" id="kobo.1946.1">ring_buffer_int</span></code><span class="koboSpan" id="kobo.1947.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1948.1">ring_buffer_float</span></code><span class="koboSpan" id="kobo.1949.1">, etc.). </span><span class="koboSpan" id="kobo.1949.2">Maintaining a single templated type is much easier than fixing the same bug in a few different places in the code base. </span><span class="koboSpan" id="kobo.1949.3">The usage of generic types doesn’t result in a binary size any larger than the size of an equivalent implementation </span><a id="_idIndexMarker056"/><span class="koboSpan" id="kobo.1950.1">of individual types. </span><span class="koboSpan" id="kobo.1950.2">Let’s examine the impact of templates on binary size in relation to separate implementations using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1951.1">ring_buffer</span></code><span class="koboSpan" id="kobo.1952.1"> example:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-type"><span class="koboSpan" id="kobo.1953.1">int</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1954.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1955.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.1956.1">{
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.1957.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1958.1">ifdef</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.1959.1"> USE_TEMPLATES</span></span><span class="koboSpan" id="kobo.1960.1">
  ring_buffer&lt;</span><span class="hljs-type"><span class="koboSpan" id="kobo.1961.1">int</span></span><span class="koboSpan" id="kobo.1962.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1963.1">10</span></span><span class="koboSpan" id="kobo.1964.1">&gt; buffer1;
  ring_buffer&lt;</span><span class="hljs-type"><span class="koboSpan" id="kobo.1965.1">float</span></span><span class="koboSpan" id="kobo.1966.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1967.1">10</span></span><span class="koboSpan" id="kobo.1968.1">&gt; buffer2;
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.1969.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1970.1">else</span></span><span class="koboSpan" id="kobo.1971.1">
  ring_buffer_int buffer1;
  ring_buffer_float buffer2;
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.1972.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1973.1">endif</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1974.1">for</span></span><span class="koboSpan" id="kobo.1975.1"> (</span><span class="hljs-type"><span class="koboSpan" id="kobo.1976.1">int</span></span><span class="koboSpan" id="kobo.1977.1"> i = </span><span class="hljs-number"><span class="koboSpan" id="kobo.1978.1">0</span></span><span class="koboSpan" id="kobo.1979.1">; i &lt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.1980.1">20</span></span><span class="koboSpan" id="kobo.1981.1">; i++) {
    buffer</span><span class="hljs-number"><span class="koboSpan" id="kobo.1982.1">1.</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1983.1">push</span></span><span class="koboSpan" id="kobo.1984.1">(i);
    buffer</span><span class="hljs-number"><span class="koboSpan" id="kobo.1985.1">2.</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1986.1">push</span></span><span class="koboSpan" id="kobo.1987.1">(i + </span><span class="hljs-number"><span class="koboSpan" id="kobo.1988.1">0.2f</span></span><span class="koboSpan" id="kobo.1989.1">);
  }
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1990.1">for</span></span><span class="koboSpan" id="kobo.1991.1"> (</span><span class="hljs-type"><span class="koboSpan" id="kobo.1992.1">int</span></span><span class="koboSpan" id="kobo.1993.1"> i = </span><span class="hljs-number"><span class="koboSpan" id="kobo.1994.1">0</span></span><span class="koboSpan" id="kobo.1995.1">; i &lt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.1996.1">10</span></span><span class="koboSpan" id="kobo.1997.1">; i++) {
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1998.1">printf</span></span><span class="koboSpan" id="kobo.1999.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2000.1">"%d, %.2f\r\n"</span></span><span class="koboSpan" id="kobo.2001.1">, buffer</span><span class="hljs-number"><span class="koboSpan" id="kobo.2002.1">1.</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2003.1">pop</span></span><span class="koboSpan" id="kobo.2004.1">(), buffer</span><span class="hljs-number"><span class="koboSpan" id="kobo.2005.1">2.</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2006.1">pop</span></span><span class="koboSpan" id="kobo.2007.1">());
  }
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2008.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.2009.1">0</span></span><span class="koboSpan" id="kobo.2010.1">;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2011.1">The program will use a generic </span><code class="inlineCode"><span class="koboSpan" id="kobo.2012.1">ring_buffer type</span></code><span class="koboSpan" id="kobo.2013.1"> if built with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2014.1">USE_TEMPLATES</span></code><span class="koboSpan" id="kobo.2015.1"> defined, and it will use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2016.1">ring_buffer_int</span></code><span class="koboSpan" id="kobo.2017.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2018.1">ring_buffer_float</span></code><span class="koboSpan" id="kobo.2019.1"> types otherwise. </span><span class="koboSpan" id="kobo.2019.2">If we build this example with GCC with no optimization enabled, it will result in a slightly bigger binary size in the template version (24 bytes). </span><span class="koboSpan" id="kobo.2019.3">This is due to larger symbols in the symbol table when using the templated version. </span><span class="koboSpan" id="kobo.2019.4">If we strip the symbol table from the object files, they will result in the same size. </span><span class="koboSpan" id="kobo.2019.5">Also, building two versions with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2020.1">O3</span></code><span class="koboSpan" id="kobo.2021.1"> results in the same binary size.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2022.1">Generic types do not increase the binary size more than if we wrote instantiated types by hand as separate types. </span><span class="koboSpan" id="kobo.2022.2">Templates have an effect on the build time due to the instantiation of concrete types in different compilation units, and there are techniques to avoid this if needed. </span><span class="koboSpan" id="kobo.2022.3">All functions related to the instantiated types </span><a id="_idIndexMarker057"/><span class="koboSpan" id="kobo.2023.1">with the same parameters will result in a single function in the binary, as the linker will remove duplicate symbols.</span></p>
<h2 class="heading-2" id="_idParaDest-30"><span class="koboSpan" id="kobo.2024.1">RTTI and exceptions</span></h2>
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.2025.1">Runtime type information</span></strong><span class="koboSpan" id="kobo.2026.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.2027.1">RTTI</span></strong><span class="koboSpan" id="kobo.2028.1">) in C++ is a mechanism that allows the type of an object to be determined </span><a id="_idIndexMarker058"/><span class="koboSpan" id="kobo.2029.1">at runtime. </span><span class="koboSpan" id="kobo.2029.2">Most compilers implement RTTI using the virtual tables. </span><span class="koboSpan" id="kobo.2029.3">Each polymorphic class (a class with at least one virtual function) has a virtual table that, among other things, includes type information for runtime type identification. </span><span class="koboSpan" id="kobo.2029.4">RTTI imposes both time and space costs. </span><span class="koboSpan" id="kobo.2029.5">It increases binary size and affects the runtime performance if type identification is used. </span><span class="koboSpan" id="kobo.2029.6">This is the reason why compilers have a way of disabling RTTI. </span><span class="koboSpan" id="kobo.2029.7">Let’s examine a simple example with a base and derived class:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.2030.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2031.1">include</span></span><span class="hljs-meta"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.2032.1">&lt;cstdio&gt;</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2033.1">struct</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2034.1">Base</span></span><span class="koboSpan" id="kobo.2035.1"> {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2036.1">virtual</span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="koboSpan" id="kobo.2037.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.2038.1">print</span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="koboSpan" id="kobo.2039.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.2040.1">{
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2041.1">printf</span></span><span class="koboSpan" id="kobo.2042.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2043.1">"Base\r\n"</span></span><span class="koboSpan" id="kobo.2044.1">);
    }
};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2045.1">struct</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2046.1">Derived</span></span><span class="koboSpan" id="kobo.2047.1"> : </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2048.1">public</span></span><span class="koboSpan" id="kobo.2049.1"> Base {
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.2050.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.2051.1">print</span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="koboSpan" id="kobo.2052.1">()</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2053.1">override</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.2054.1">{
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2055.1">printf</span></span><span class="koboSpan" id="kobo.2056.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2057.1">"Derived\r\n"</span></span><span class="koboSpan" id="kobo.2058.1">);
    }
};
</span><span class="hljs-type"><span class="koboSpan" id="kobo.2059.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.2060.1">printer</span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="koboSpan" id="kobo.2061.1">(Base &amp;base)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.2062.1">{
    base.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2063.1">print</span></span><span class="koboSpan" id="kobo.2064.1">();
}
</span><span class="hljs-type"><span class="koboSpan" id="kobo.2065.1">int</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.2066.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2067.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.2068.1">{
    Base base;
    Derived derived;
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2069.1">printer</span></span><span class="koboSpan" id="kobo.2070.1">(base);
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2071.1">printer</span></span><span class="koboSpan" id="kobo.2072.1">(derived);
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2073.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.2074.1">0</span></span><span class="koboSpan" id="kobo.2075.1">;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2076.1">The output of the program is as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2077.1">Base
Derived
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2078.1">Classes with virtual functions have vtables that are used for dynamic dispatching. </span><span class="koboSpan" id="kobo.2078.2">Dynamic dispatch is a process of selecting which implementation of a polymorphic function is used. </span><span class="koboSpan" id="kobo.2078.3">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2079.1">printer</span></code><span class="koboSpan" id="kobo.2080.1"> function accepts a reference to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2081.1">Base</span></code><span class="koboSpan" id="kobo.2082.1"> class. </span><span class="koboSpan" id="kobo.2082.2">Depending on the type of reference passed to </span><code class="inlineCode"><span class="koboSpan" id="kobo.2083.1">printer</span></code><span class="koboSpan" id="kobo.2084.1"> (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2085.1">Base</span></code><span class="koboSpan" id="kobo.2086.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.2087.1">Derived</span></code><span class="koboSpan" id="kobo.2088.1">), the dynamic dispatching process will select the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2089.1">print</span></code><span class="koboSpan" id="kobo.2090.1"> method from either the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2091.1">Base</span></code><span class="koboSpan" id="kobo.2092.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.2093.1">Derived</span></code><span class="koboSpan" id="kobo.2094.1"> class. </span><span class="koboSpan" id="kobo.2094.2">Vtables are also used to store type information.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2095.1">By using </span><code class="inlineCode"><span class="koboSpan" id="kobo.2096.1">dynamic_cast</span></code><span class="koboSpan" id="kobo.2097.1">, as a part of the RTTI mechanism, we can find the information about the type using </span><a id="_idIndexMarker059"/><span class="koboSpan" id="kobo.2098.1">a reference or pointer to the superclass. </span><span class="koboSpan" id="kobo.2098.2">Let’s modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2099.1">printer</span></code><span class="koboSpan" id="kobo.2100.1"> method from the previous example:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-type"><span class="koboSpan" id="kobo.2101.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.2102.1">printer</span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="koboSpan" id="kobo.2103.1">(Base &amp;base)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.2104.1">{
    base.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2105.1">print</span></span><span class="koboSpan" id="kobo.2106.1">();
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2107.1">if</span></span><span class="koboSpan" id="kobo.2108.1">(Derived *derived = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2109.1">dynamic_cast</span></span><span class="koboSpan" id="kobo.2110.1">&lt;Derived*&gt;(&amp;base); derived!=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.2111.1">nullptr</span></span><span class="koboSpan" id="kobo.2112.1">) {
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2113.1">printf</span></span><span class="koboSpan" id="kobo.2114.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2115.1">"We found Base using RTTI!\r\n"</span></span><span class="koboSpan" id="kobo.2116.1">);
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2117.1">The output is as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2118.1">Base
Derived
We found Base using RTTI!
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2119.1">As we already mentioned, RTTI can be disabled. </span><span class="koboSpan" id="kobo.2119.2">In GCC, we can do this by passing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2120.1">-fno-rtti</span></code><span class="koboSpan" id="kobo.2121.1"> flag to the compiler. </span><span class="koboSpan" id="kobo.2121.2">If we try to compile the modified example using this flag, the compiler will raise </span><code class="inlineCode"><span class="koboSpan" id="kobo.2122.1">error: dynamic_cast' not permitted with '-fno-rtti'</span></code><span class="koboSpan" id="kobo.2123.1">. </span><span class="koboSpan" id="kobo.2123.2">If we restore the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2124.1">printer</span></code><span class="koboSpan" id="kobo.2125.1"> method to the original implementation, remove the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2126.1">if</span></code><span class="koboSpan" id="kobo.2127.1"> statement, and build it with both RTTI enabled and then disabled, we can notice that the binary size is larger when RTTI is enabled. </span><span class="koboSpan" id="kobo.2127.2">RTTI is useful in certain scenarios, but it adds a massive overhead to resource-constrained devices, so we will leave it disabled.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2128.1">Another C++ feature that is often disabled in embedded projects in C++ is exceptions. </span><strong class="keyWord"><span class="koboSpan" id="kobo.2129.1">Exceptions</span></strong><span class="koboSpan" id="kobo.2130.1"> are an </span><a id="_idIndexMarker060"/><span class="koboSpan" id="kobo.2131.1">error-handling mechanism based on a try-catch block. </span><span class="koboSpan" id="kobo.2131.2">Let’s take a look at a simple example utilizing exceptions to understand them better:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.2132.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2133.1">include</span></span><span class="hljs-meta"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.2134.1">&lt;cstdio&gt;</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2135.1">struct</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2136.1">A</span></span><span class="koboSpan" id="kobo.2137.1"> {
  </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2138.1">A</span></span><span class="koboSpan" id="kobo.2139.1">() { </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2140.1">printf</span></span><span class="koboSpan" id="kobo.2141.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2142.1">"A is created!\r\n"</span></span><span class="koboSpan" id="kobo.2143.1">); }
  ~</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2144.1">A</span></span><span class="koboSpan" id="kobo.2145.1">() { </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2146.1">printf</span></span><span class="koboSpan" id="kobo.2147.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2148.1">"A is destroyed!\r\n"</span></span><span class="koboSpan" id="kobo.2149.1">); }
};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2150.1">struct</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2151.1">B</span></span><span class="koboSpan" id="kobo.2152.1"> {
  </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2153.1">B</span></span><span class="koboSpan" id="kobo.2154.1">() { </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2155.1">printf</span></span><span class="koboSpan" id="kobo.2156.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2157.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2158.1">B is created!\r\n"</span></span><span class="koboSpan" id="kobo.2159.1">); }
  ~</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2160.1">B</span></span><span class="koboSpan" id="kobo.2161.1">() { </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2162.1">printf</span></span><span class="koboSpan" id="kobo.2163.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2164.1">"B is destroyed!\r\n"</span></span><span class="koboSpan" id="kobo.2165.1">); }
};
</span><span class="hljs-type"><span class="koboSpan" id="kobo.2166.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.2167.1">bar</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2168.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.2169.1">{
    B b;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2170.1">throw</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.2171.1">0</span></span><span class="koboSpan" id="kobo.2172.1">;
}
</span><span class="hljs-type"><span class="koboSpan" id="kobo.2173.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.2174.1">foo</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2175.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.2176.1">{
  A a;
  </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2177.1">bar</span></span><span class="koboSpan" id="kobo.2178.1">();
  A a1;
}
</span><span class="hljs-type"><span class="koboSpan" id="kobo.2179.1">int</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.2180.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2181.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.2182.1">{
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2183.1">try</span></span><span class="koboSpan" id="kobo.2184.1"> {
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2185.1">foo</span></span><span class="koboSpan" id="kobo.2186.1">();
  } </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2187.1">catch</span></span><span class="koboSpan" id="kobo.2188.1"> (</span><span class="hljs-type"><span class="koboSpan" id="kobo.2189.1">int</span></span><span class="koboSpan" id="kobo.2190.1"> &amp;p) {
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2191.1">printf</span></span><span class="koboSpan" id="kobo.2192.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2193.1">"Catching an exception!\r\n"</span></span><span class="koboSpan" id="kobo.2194.1">);
  }
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2195.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.2196.1">0</span></span><span class="koboSpan" id="kobo.2197.1">;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2198.1">The output of the program is as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2199.1">A is created!
</span><span class="koboSpan" id="kobo.2199.2">B is created!
</span><span class="koboSpan" id="kobo.2199.3">B is destroyed!
</span><span class="koboSpan" id="kobo.2199.4">A is destroyed!
</span><span class="koboSpan" id="kobo.2199.5">Catching an exception!
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2200.1">In this simple example, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2201.1">foo</span></code><span class="koboSpan" id="kobo.2202.1"> is called in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2203.1">try</span></code><span class="koboSpan" id="kobo.2204.1"> block. </span><span class="koboSpan" id="kobo.2204.2">It creates a local object, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2205.1">a</span></code><span class="koboSpan" id="kobo.2206.1">, and calls </span><code class="inlineCode"><span class="koboSpan" id="kobo.2207.1">bar</span></code><span class="koboSpan" id="kobo.2208.1">. </span><span class="koboSpan" id="kobo.2208.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2209.1">bar</span></code><span class="koboSpan" id="kobo.2210.1"> function creates a local object, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2211.1">b</span></code><span class="koboSpan" id="kobo.2212.1">, and throws an exception. </span><span class="koboSpan" id="kobo.2212.2">In the output, we see that </span><code class="inlineCode"><span class="koboSpan" id="kobo.2213.1">A</span></code><span class="koboSpan" id="kobo.2214.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2215.1">B</span></code><span class="koboSpan" id="kobo.2216.1"> are created, then </span><code class="inlineCode"><span class="koboSpan" id="kobo.2217.1">B</span></code><span class="koboSpan" id="kobo.2218.1"> gets destroyed, then </span><code class="inlineCode"><span class="koboSpan" id="kobo.2219.1">A</span></code><span class="koboSpan" id="kobo.2220.1"> gets destroyed, and we finally see that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2221.1">catch</span></code><span class="koboSpan" id="kobo.2222.1"> block gets </span><a id="_idIndexMarker061"/><span class="koboSpan" id="kobo.2223.1">executed. </span><span class="koboSpan" id="kobo.2223.2">This is called </span><strong class="keyWord"><span class="koboSpan" id="kobo.2224.1">stack unwinding</span></strong><span class="koboSpan" id="kobo.2225.1">, and for it to happen, standard implementations most commonly utilize unwind tables, which store information about catch handlers, destructors to be called, and so on. </span><span class="koboSpan" id="kobo.2225.2">Unwind tables can grow large and become complex, which increases the memory footprint of the application and introduces non-determinism due to the mechanism used at runtime for exception handling. </span><span class="koboSpan" id="kobo.2225.3">This is why exceptions are often disabled in embedded system projects.</span></p>
<h1 class="heading-1" id="_idParaDest-31"><span class="koboSpan" id="kobo.2226.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2227.1">C++ is guided by the </span><strong class="keyWord"><span class="koboSpan" id="kobo.2228.1">zero-overhead principle</span></strong><span class="koboSpan" id="kobo.2229.1">. </span><span class="koboSpan" id="kobo.2229.2">The only two language features that do not follow it are RTTI and exceptions, and that’s why compilers support a switch for turning them off.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2230.1">The zero-overhead principle is based on two statements that we established in this chapter:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2231.1">You don’t pay for what you don’t use</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2232.1">What you do use is just as efficient as what you could reasonably write by hand</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.2233.1">RTTI and exceptions are disabled in most embedded projects, so you don’t pay for them. </span><span class="koboSpan" id="kobo.2233.2">Using generic types and templates is a design choice and is no more expensive than writing individual types by hand (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2234.1">ring_buffer_int</span></code><span class="koboSpan" id="kobo.2235.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2236.1">ring_buffer_float</span></code><span class="koboSpan" id="kobo.2237.1">, and so on), but it lets you reuse the code logic for different types, makes the code more readable and easier for maintenance.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2238.1">Working on high-risk systems is not a reason to disable compiler optimization capabilities. </span><span class="koboSpan" id="kobo.2238.2">Code functionality needs to be verified whether we are building a program with optimization disabled or enabled. </span><span class="koboSpan" id="kobo.2238.3">The most common source of bugs when optimization is enabled is undefined behavior. </span><span class="koboSpan" id="kobo.2238.4">Understanding the undefined behavior and preventing it is up to the developer.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2239.1">Modern C++ is a language that has a lot to offer to the embedded world. </span><span class="koboSpan" id="kobo.2239.2">The mission of this book is to help you discover C++ and what it can do for your embedded projects, so let’s embark on the path of discovering C++ and utilizing it to solve problems in the embedded domain.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2240.1">In the next chapter, we will go over challenges in embedded systems with limited resources and dynamic memory management in C++.</span></p>
<h1 class="heading-1" id="_idParaDest-32"><span class="koboSpan" id="kobo.2241.1">Join our community on Discord</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2242.1">Join our community’s Discord space for discussions with the author and other readers:</span></p>
<p class="normal"><a href="https://packt.link/embeddedsystems"><span class="url"><span class="koboSpan" id="kobo.2243.1">https://packt.link/embeddedsystems</span></span></a></p>
<p class="normal"><span class="koboSpan" id="kobo.2244.1"><img alt="" role="presentation" src="../Images/QR_code_Discord.png"/></span></p>
</div>
</body></html>