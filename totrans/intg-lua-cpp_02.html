<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer017">
<h1 class="chapter-number" id="_idParaDest-42"><a id="_idTextAnchor042"/>2</h1>
<h1 id="_idParaDest-43"><a id="_idTextAnchor043"/>Lua Fundamentals</h1>
<p>In this chapter, we will learn the basics of the Lua programming language. You do not need to be a Lua expert or even write any Lua code if you only work on the C++ side. However, understanding the basics will make you more efficient when integrating Lua <span class="No-Break">into C++.</span></p>
<p>If you already know Lua programming, you can skip this chapter. If you have not used Lua for a while, you can use this chapter to recap. If you want to learn more about Lua programming, you can get the official Lua book: <em class="italic">Programming in Lua</em>. If you do not know Lua programming, this chapter is for you. Coming from C++, you can read any Lua code with the brief explanations on Lua code in this book. You can believe in yourself and research online when you <span class="No-Break">need to.</span></p>
<p>We will talk about the following <span class="No-Break">language features:</span></p>
<ul>
<li>Variables <span class="No-Break">and types</span></li>
<li><span class="No-Break">Control structures</span></li>
</ul>
<h1 id="_idParaDest-44"><a id="_idTextAnchor044"/>Technical requirements</h1>
<p>You will use the interactive Lua interpreter to follow the code examples in this chapter. We have built it from the Lua source code in <span class="No-Break"><em class="italic">Chapter 1</em></span>. You can also use a Lua interpreter from another channel, for example, the one installed by your operating system’s package manager. Before continuing, make sure you have access <span class="No-Break">to one.</span></p>
<p>When you see code examples in this chapter, like the following one, you should try the example in an interactive <span class="No-Break">Lua shell:</span></p>
<pre class="source-code">
Lua 5.4.6  Copyright (C) 1994-2022 Lua.org, PUC-Rio
&gt; os.exit()
%</pre>
<p>The first line is what the Lua interpreter outputs when it starts. Use <strong class="source-inline">os.exit()</strong> to quit <span class="No-Break">the interpreter.</span></p>
<p>You can find the source code for this chapter within the book’s GitHub <span class="No-Break">repository: </span><a href="https://github.com/PacktPublishing/Integrate-Lua-with-CPP/tree/main/Chapter02"><span class="No-Break">https://github.com/PacktPublishing/Integrate-Lua-with-CPP/tree/main/Chapter02</span></a></p>
<h1 id="_idParaDest-45"><a id="_idTextAnchor045"/>Variables and types</h1>
<p>While you may<a id="_idIndexMarker046"/> well know that C++ is a statically-typed language, Lua is a dynamically-typed language. In C++, when you declare a variable, you give it a clear type. In Lua, each value carries its own type, and you do not need to explicitly specify a type. Also, you do not need to define a global variable before referencing it. Although you are encouraged to declare it – or better yet, use local variables. We will learn about local variables later in <span class="No-Break">this chapter.</span></p>
<p>In Lua, there are eight basic types: <strong class="bold">nil</strong>, <strong class="bold">boolean</strong>, <strong class="bold">number</strong>, <strong class="bold">string</strong>, <strong class="bold">userdata</strong>, <strong class="bold">function</strong>, <strong class="bold">thread</strong>, <span class="No-Break">and </span><span class="No-Break"><strong class="bold">table</strong></span><span class="No-Break">.</span></p>
<p>We will learn about six of these in this chapter: <strong class="source-inline">nil</strong>, <strong class="source-inline">boolean</strong>, <strong class="source-inline">number</strong>, <strong class="source-inline">string</strong>, <strong class="source-inline">table</strong>, and <strong class="source-inline">function</strong>. Let’s try some before we go into <span class="No-Break">the details:</span></p>
<pre class="source-code">
Lua 5.4.6 Copyright (C) 1994-2022 Lua.org, PUC-Rio
&gt; a
nil
&gt; type(a)
nil
&gt; a = true
&gt; type(a)
boolean
&gt; a = 6
&gt; type(a)
number
&gt; a = "bonjour"
&gt; type(a)
string</pre>
<p>What happens here is <span class="No-Break">as follows:</span></p>
<ol>
<li>Interactively, type <strong class="source-inline">a</strong> to check the value of the global variable <strong class="source-inline">a</strong>. Since it’s not defined yet, its value <span class="No-Break">is </span><span class="No-Break"><strong class="source-inline">nil</strong></span><span class="No-Break">.</span></li>
<li>Check the type of variable <strong class="source-inline">a</strong> with <strong class="source-inline">type(a)</strong>. The value is <strong class="source-inline">nil</strong> in this case because it is <span class="No-Break">not defined.</span></li>
<li>Assign <strong class="source-inline">true</strong> to <strong class="source-inline">a</strong>. Use <strong class="source-inline">=</strong> for assignment; the same as <span class="No-Break">in C++.</span></li>
<li>Now, its type <span class="No-Break">is </span><span class="No-Break"><strong class="source-inline">boolean</strong></span><span class="No-Break">.</span></li>
<li>Assign <strong class="source-inline">6</strong> <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">a</strong></span><span class="No-Break">.</span></li>
<li>Now, its type <span class="No-Break">is </span><span class="No-Break"><strong class="source-inline">number</strong></span><span class="No-Break">.</span></li>
<li>Assign <strong class="source-inline">"bonjour"</strong> <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">a</strong></span><span class="No-Break">.</span></li>
<li>Now, its type <span class="No-Break">is </span><span class="No-Break"><strong class="source-inline">string</strong></span><span class="No-Break">.</span></li>
</ol>
<p>Every line executed<a id="_idIndexMarker047"/> there is also a Lua statement. Unlike a C++ statement, you do not need to put a semicolon at the end <span class="No-Break">of it.</span></p>
<p>Next, we will learn more about some of <span class="No-Break">the types.</span></p>
<h2 id="_idParaDest-46"><a id="_idTextAnchor046"/>Nil</h2>
<p>The <strong class="source-inline">nil</strong> type has <a id="_idIndexMarker048"/>only one <a id="_idIndexMarker049"/>value to represent a non-value: <strong class="source-inline">nil</strong>. Its meaning <a id="_idIndexMarker050"/>is<a id="_idIndexMarker051"/> similar to that of <strong class="bold">nullptr</strong> (or <strong class="bold">NULL</strong>) <span class="No-Break">in C++.</span></p>
<h2 id="_idParaDest-47"><a id="_idTextAnchor047"/>Booleans</h2>
<p>The <strong class="source-inline">boolean</strong> type has<a id="_idIndexMarker052"/> two <a id="_idIndexMarker053"/>values. They are <em class="italic">true</em> and <em class="italic">false</em>. It does what <strong class="bold">bool</strong> does <span class="No-Break">in C++.</span></p>
<h2 id="_idParaDest-48"><a id="_idTextAnchor048"/>Numbers</h2>
<p>The <strong class="source-inline">number</strong> type<a id="_idIndexMarker054"/> covers C++’s <strong class="bold">int</strong>, <strong class="bold">float</strong>, and <strong class="bold">double</strong>, and <a id="_idIndexMarker055"/>their variants (such <span class="No-Break">as </span><span class="No-Break"><strong class="bold">long</strong></span><span class="No-Break">).</span></p>
<p>Here, we will also learn about Lua arithmetic operators and relational operators, as these are<a id="_idIndexMarker056"/> mostly used <span class="No-Break">on numbers.</span></p>
<h3>Arithmetic operators</h3>
<p>An arithmetic <a id="_idIndexMarker057"/>operator is an operator that performs <a id="_idIndexMarker058"/>arithmetic operations on numbers. Lua supports <em class="italic">six</em> <span class="No-Break">arithmetic operators:</span></p>
<ul>
<li><strong class="source-inline">+</strong>: <span class="No-Break">Addition</span></li>
<li><strong class="source-inline">-</strong>: <span class="No-Break">Subtraction</span></li>
<li><strong class="source-inline">*</strong>: <span class="No-Break">Multiplication</span></li>
<li><strong class="source-inline">/</strong>: <span class="No-Break">Division</span></li>
<li><strong class="source-inline">%</strong>: <span class="No-Break">Modulus</span></li>
<li><strong class="source-inline">//</strong>: <span class="No-Break">Floor Division</span></li>
</ul>
<p>C++ has seven arithmetic operators: +, -, *, /, %, ++ and --. Lua’s arithmetic operators are similar to their C++ counterparts, except for the <span class="No-Break">following differences:</span></p>
<ol>
<li>There is no ++ or -- <span class="No-Break">operator.</span></li>
<li>C++ does not have the <strong class="source-inline">//</strong> operator, which returns the integer part of the result after division. C++ can achieve the same implicitly with normal division because C++ is strongly-typed. This we can see in the <span class="No-Break">following example:</span><pre class="source-code">
Lua 5.4.6 Copyright (C) 1994-2022 Lua.org, PUC-Rio</pre><pre class="source-code">
&gt; 5 / 3</pre><pre class="source-code">
1.6666666666667</pre><pre class="source-code">
&gt; 5 // 3</pre><pre class="source-code">
1</pre></li>
<li>Note that Lua is a <a id="_idIndexMarker059"/>dynamically-typed language. This <a id="_idIndexMarker060"/>means 5 / 3 does not produce 1 as C++ <span class="No-Break">would do.</span></li>
</ol>
<h3>Relational operators</h3>
<p>A relational <a id="_idIndexMarker061"/>operator is an operator that tests some kind of <a id="_idIndexMarker062"/>relation between two values. Lua supports <em class="italic">six</em> <span class="No-Break">relational operators:</span></p>
<ul>
<li><strong class="source-inline">&lt;</strong>: <span class="No-Break">Less than</span></li>
<li><strong class="source-inline">&gt;</strong>: <span class="No-Break">Greater than</span></li>
<li><strong class="source-inline">&lt;=</strong>: Less than or <span class="No-Break">equal to</span></li>
<li><strong class="source-inline">&gt;=</strong>: Greater than or <span class="No-Break">equal to</span></li>
<li><strong class="source-inline">==</strong>: <span class="No-Break">Equal to</span></li>
<li><strong class="source-inline">~=</strong>: Not <span class="No-Break">equal to</span></li>
</ul>
<p>The <strong class="source-inline">~=</strong> operator tests the negation of equality. This is the same as the <strong class="source-inline">!=</strong> operator in C++. The other ones are the same as they are <span class="No-Break">in C++.</span></p>
<h2 id="_idParaDest-49"><a id="_idTextAnchor049"/>Strings</h2>
<p>Strings are always<a id="_idIndexMarker063"/> a constant in Lua. You <a id="_idIndexMarker064"/>cannot change one character in a string and make it represent another string. You create a new string <span class="No-Break">for that.</span></p>
<p>We can delimit literal strings with double or single quotes. The rest is quite similar to C++ strings, as shown in the <span class="No-Break">following example:</span></p>
<pre class="source-code">
Lua 5.4.6 Copyright (C) 1994-2022 Lua.org, PUC-Rio
&gt; a = "Hello\n" .. 'C++'
&gt; a
Hello
C++
&gt; #a
9</pre>
<p>We have two operators on strings that cannot be found in C++. To concatenate two strings, you can use the <strong class="source-inline">..</strong> operator. To check the length of the string, you can use the <strong class="source-inline">#</strong> <span class="No-Break">operator.</span></p>
<p>Like the C++ escape sequence, use <strong class="source-inline">\</strong> to escape special characters, as you can see in the line break in the preceding output. If you do not want to insert the newline escape sequence, <strong class="source-inline">\n</strong>, you <a id="_idIndexMarker065"/>can use a long <span class="No-Break">string</span><span class="No-Break"><a id="_idIndexMarker066"/></span><span class="No-Break"> instead.</span></p>
<h3>Long strings</h3>
<p>You can use <strong class="source-inline">[[</strong> and <strong class="source-inline">]]</strong> to <a id="_idIndexMarker067"/>delimit multiple-line strings, <span class="No-Break">for example:</span></p>
<pre class="source-code">
a = [[
Hello
C++
]]</pre>
<p>This defines a string that is equal to the single-line <span class="No-Break">definition </span><span class="No-Break"><strong class="source-inline">"Hello\nC++\n"</strong></span><span class="No-Break">.</span></p>
<p>Long strings can make strings more readable. You<a id="_idIndexMarker068"/> can define <strong class="bold">XML</strong> or <strong class="bold">JSON</strong> strings <a id="_idIndexMarker069"/>easily in Lua source code with <span class="No-Break">long strings.</span></p>
<p>If your long string contains <strong class="source-inline">[[</strong> or <strong class="source-inline">]]</strong> in its content, you can add some equal signs between the opening brackets, <span class="No-Break">for example:</span></p>
<pre class="source-code">
<strong class="source-inline">a = [=[</strong>
<strong class="source-inline">x[y[1]]</strong>
<strong class="source-inline">]=]</strong>
<strong class="source-inline">b = [==[</strong>
<strong class="source-inline">x[y[2]]</strong>
<strong class="source-inline">]==]</strong></pre>
<p>How many equal signs you add is up to you. However, one is <span class="No-Break">usually enough.</span></p>
<h2 id="_idParaDest-50"><a id="_idTextAnchor050"/>Tables</h2>
<p>Lua tables <a id="_idIndexMarker070"/>are<a id="_idIndexMarker071"/> like <strong class="bold">C++ std::map</strong> containers but are more flexible. A table is the only way to construct complex data structures <span class="No-Break">in Lua.</span></p>
<p>Let’s try a Lua table with some actions. In a Lua interpreter, type the following statements one by one and observe <span class="No-Break">the outputs:</span></p>
<pre class="source-code">
Lua 5.4.6 Copyright (C) 1994-2022 Lua.org, PUC-Rio
&gt; a = {}
&gt; a['x'] = 100
&gt; a['x']
100
&gt; a.x
100</pre>
<p>This creates a table with the <strong class="source-inline">{}</strong> constructor and assigns a value of <strong class="source-inline">100</strong> to the <strong class="source-inline">'x'</strong> string key. Another way to construct this table is <strong class="source-inline">a = {x = 100}</strong>. To initialize a table with more keys, use <strong class="source-inline">a = {x = 100, y = </strong><span class="No-Break"><strong class="source-inline">200}</strong></span><span class="No-Break">.</span></p>
<p><strong class="source-inline">a.x</strong> is an alternative syntax for <strong class="source-inline">a['x']</strong>. Which one you use is a style preference. But usually, the dot syntax implies that the table is used as a record or in an <span class="No-Break">object-oriented way.</span></p>
<p>Except for <strong class="source-inline">nil</strong>, you <a id="_idIndexMarker072"/>can use all Lua types as table keys. You can also use different types as values in the same table. You have complete control, as <span class="No-Break">seen next:</span></p>
<pre class="source-code">
Lua 5.4.6 Copyright (C) 1994-2022 Lua.org, PUC-Rio
&gt; b = {"Monday", "Tomorrow"}
&gt; b[1]
Monday
&gt; b[2]
Tomorrow
&gt; #b
2
&gt; a = {}
&gt; b[a] = "a table"
&gt; b[a]
a table
&gt; b.a
nil
&gt; #b
2</pre>
<p>This example <a id="_idIndexMarker073"/>explains<a id="_idIndexMarker074"/> four points related to <span class="No-Break">the table:</span></p>
<ol>
<li>It first creates a table in the form of an array. Note that it is indexed starting from 1, not 0. When you give a value-only entry to the table constructor, it will be treated as part of the array. Do you recall that <strong class="source-inline">#</strong> is the length operator? It can tell the length of the table when it is used to represent a sequence or <span class="No-Break">an array.</span></li>
<li>Then it adds another entry using another table, <strong class="source-inline">a</strong>, as the key and the <strong class="source-inline">"a table"</strong> string as the value. This is <span class="No-Break">perfectly fine.</span></li>
<li>Note that <strong class="source-inline">b.a</strong> is <strong class="source-inline">nil</strong> because <strong class="source-inline">b.a</strong> means <strong class="source-inline">b['a']</strong> with the <strong class="source-inline">'a'</strong> string key, <span class="No-Break">not </span><span class="No-Break"><strong class="source-inline">b[a]</strong></span><span class="No-Break">.</span></li>
<li>Finally, we try to check the length of the table again. We have added 3 entries in the table, but it outputs a length of 2. Coming from C++, this may surprise you: Lua does not provide a built-in way to check table length. The length operator only provides convenience when a table is an array. You are able to use a table as an array and a map at the same time, but you would need to take <span class="No-Break">full responsibility.</span></li>
</ol>
<p>Later in this chapter, when we learn about the <strong class="source-inline">for</strong> control structure, we will find out more about table <a id="_idIndexMarker075"/>traversal. Now we will learn about <span class="No-Break">Lua functions.</span></p>
<h2 id="_idParaDest-51"><a id="_idTextAnchor051"/>Functions</h2>
<p>Lua functions serve <a id="_idIndexMarker076"/>a similar purpose as C++ functions. But <a id="_idIndexMarker077"/>unlike in C++, they are also a first-class citizen as one of the basic <span class="No-Break">data types.</span></p>
<p>We can define a function by doing <span class="No-Break">the following:</span></p>
<ol>
<li>Start with the <span class="No-Break"><strong class="source-inline">function</strong></span><span class="No-Break"> keyword.</span></li>
<li>Follow it with a function name and a pair of parentheses, inside which you can define function parameters <span class="No-Break">if needed.</span></li>
<li>Implement the <span class="No-Break">function body.</span></li>
<li>End the function definition with the <span class="No-Break"><strong class="source-inline">end</strong></span><span class="No-Break"> keyword.</span></li>
</ol>
<p>For example, we can define a function <span class="No-Break">as follows:</span></p>
<pre class="source-code">
function hello()
    print("Hello C++")
end</pre>
<p>This will print out <strong class="source-inline">"</strong><span class="No-Break"><strong class="source-inline">Hello C++"</strong></span><span class="No-Break">.</span></p>
<p>To define a function to use with the Lua interpreter, you have <span class="No-Break">two choice:</span></p>
<ul>
<li>In an interactive interpreter, just start to type the function. When you end each line, the interpreter will know, and you can continue to type the next line of the <span class="No-Break">function definition.</span></li>
<li>Alternatively, you can define your functions in another file that can be later imported into the interpreter. This is easier to work on. We will use this way from now on. Try to put your functions in this section in a file <span class="No-Break">named </span><span class="No-Break"><strong class="source-inline">1-functions.lua</strong></span><span class="No-Break">.</span></li>
</ul>
<p>To invoke a function, use its name and a pair of parentheses. This is the same as how you invoke a C++ function, <span class="No-Break">for example:</span></p>
<pre class="source-code">
Lua 5.4.6 Copyright (C) 1994-2022 Lua.org, PUC-Rio
&gt; dofile("Chapter02/1-functions.lua")
&gt; hello()
Hello C++</pre>
<p><strong class="source-inline">dofile()</strong> is the Lua library method to load another Lua script. Here, we load the file where we have defined our Lua functions. If you have changed the script file, you can execute it<a id="_idIndexMarker078"/> again to<a id="_idIndexMarker079"/> load the <span class="No-Break">latest script.</span></p>
<p>Next, we will learn about function parameters and function <span class="No-Break">return values.</span></p>
<h3>Function parameters</h3>
<p>Function parameters, also <a id="_idIndexMarker080"/>called arguments, are values provided to the function when the function <span class="No-Break">is called.</span></p>
<p>You can define function parameters by providing parameter declarations inside the parentheses after the function name. This is the same as in C++, but you do not need to provide parameter types, <span class="No-Break">for example:</span></p>
<pre class="source-code">
function bag(a, b, c)
    print(a)
    print(b)
    print(c)
end</pre>
<p>When calling the function, you can pass in fewer or more parameters than defined. For example, you can call the <strong class="source-inline">bag</strong> function we <span class="No-Break">just defined:</span></p>
<pre class="source-code">
Lua 5.4.6 Copyright (C) 1994-2022 Lua.org, PUC-Rio
&gt; dofile("Chapter02/1-functions.lua")
&gt; bag(1)
1
nil
nil
&gt; bag(1, 2, 3, 4)
1
2
3</pre>
<p>You can see what happens when the number of parameters provided is different from the <span class="No-Break">number defined:</span></p>
<ul>
<li>When not enough parameters are passed, the remaining ones will have a <span class="No-Break"><strong class="source-inline">nil</strong></span><span class="No-Break"> value.</span></li>
<li>When more parameters are passed, the additional ones will <span class="No-Break">be discarded.</span></li>
</ul>
<p>You cannot define a<a id="_idIndexMarker081"/> default value for function parameters because Lua does not support it at the language level. But you can check in your function, and if a parameter is <strong class="source-inline">nil</strong>, assign it a <span class="No-Break">default value.</span></p>
<h3>Function results</h3>
<p>You can use the <strong class="source-inline">return</strong> keyword to <a id="_idIndexMarker082"/>return function results. It is possible to return multiple values. Let us define two functions that return one and two <span class="No-Break">values, respectively:</span></p>
<pre class="source-code">
function square(a)
    return a * a
end
function sincos(a)
    return math.sin(a), math.cos(a)
end</pre>
<p>The first function returns the <strong class="source-inline">square</strong> for the given parameter. The second function returns the <strong class="source-inline">sin</strong> and <strong class="source-inline">cos</strong> of the given parameter. Let us give our two functions <span class="No-Break">a try:</span></p>
<pre class="source-code">
Lua 5.4.6 Copyright (C) 1994-2022 Lua.org, PUC-Rio
&gt; dofile("Chapter02/1-functions.lua")
&gt; square(2)
4
&gt; sincos(math.pi / 3)
0.86602540378444        0.5</pre>
<p>You can see from the output that the functions return one and two values, respectively. In this example, <strong class="source-inline">math.pi</strong>, <strong class="source-inline">math.sin</strong>, and <strong class="source-inline">math.cos</strong> are from the Lua <strong class="source-inline">math</strong> library, which is loaded<a id="_idIndexMarker083"/> by default in the interactive interpreter. Have you wondered how to make a basic library for our <span class="No-Break"><strong class="source-inline">sincos</strong></span><span class="No-Break"> function?</span></p>
<h3>Putting a function in a table</h3>
<p>From a holistic <a id="_idIndexMarker084"/>point of view, the Lua <strong class="source-inline">math</strong> library – and any other library – is just tables holding functions and constant values. You can define <span class="No-Break">your own:</span></p>
<pre class="source-code">
Lua 5.4.6 Copyright (C) 1994-2022 Lua.org, PUC-Rio
&gt; dofile("Chapter02/1-functions.lua")
&gt; mathx = {sincos = sincos}
&gt; mathx.sincos(math.pi / 3)
0.86602540378444        0.5
&gt; mathx["sincos"]
function: 0x13ca052d0
&gt; mathx["sincos"](math.pi / 3)
0.86602540378444        0.5</pre>
<p>We created a table here named <strong class="source-inline">mathx</strong> and assigned our <strong class="source-inline">sincos</strong> function to the <strong class="source-inline">"</strong><span class="No-Break"><strong class="source-inline">sincos"</strong></span><span class="No-Break"> key.</span></p>
<p>Now you know <a id="_idIndexMarker085"/>how to create your own Lua library. To finish our introduction to the Lua types, let us see why we should use <span class="No-Break">local variables.</span></p>
<h2 id="_idParaDest-52"><a id="_idTextAnchor052"/>Local variables and scopes</h2>
<p>So far, we have <a id="_idIndexMarker086"/>been using <a id="_idIndexMarker087"/>global variables because we just reference one when we need to, right? Yes, it is convenient. But the downside is that they will never go out of scope and can be accessed by all functions, related or not. Coming from a C++ background, you will not agree <span class="No-Break">to this.</span></p>
<p>We can use <a id="_idIndexMarker088"/>the <strong class="bold">local</strong> keyword to declare a variable as local to the block. A Lua block has a similar concept as a C++ block, within an <strong class="source-inline">if</strong> branch, within a <strong class="source-inline">for</strong> loop, or within <span class="No-Break">a function.</span></p>
<p>Local variables are good for preventing pollution of the global environment. Try to define two functions to <span class="No-Break">test this:</span></p>
<pre class="source-code">
function test_variable_leakage()
    abc_leaked = 3
end
function test_local_variable()
    local abc_local = 4
end</pre>
<p>In the first<a id="_idIndexMarker089"/> function, a local variable is not used, so a global variable named <strong class="source-inline">abc_leaked</strong> will be created. In the second function, a local variable – <strong class="source-inline">abc_local</strong> – is used, which will be unknown outside its function scope. Let us see <span class="No-Break">the effects:</span></p>
<pre class="source-code">
Lua 5.4.6 Copyright (C) 1994-2022 Lua.org, PUC-Rio
&gt; dofile("Chapter02/1-functions.lua")
&gt; abc_leaked
nil
&gt; test_variable_leakage()
&gt; abc_leaked
3
&gt; test_local_variable()
&gt; abc_local
nil</pre>
<p>From the outputs, we can verify <span class="No-Break">the following:</span></p>
<ol>
<li>First, we try the first function that does not use a local variable. Before calling the function, we verify that there is no global variable named <strong class="source-inline">abc_leaked</strong>. After calling the function, a global variable – <strong class="source-inline">abc_leaked</strong> – <span class="No-Break">is created.</span></li>
<li>Then we try the second function that uses a local variable. No global variable is created in <span class="No-Break">this case.</span></li>
</ol>
<p>You<a id="_idIndexMarker090"/> should <a id="_idIndexMarker091"/>always use local variables when you can. Next, let us familiarize ourselves with Lua’s <span class="No-Break">control structures.</span></p>
<h1 id="_idParaDest-53"><a id="_idTextAnchor053"/>Control structures</h1>
<p>The Lua control <a id="_idIndexMarker092"/>structures are quite similar to the C++ control structures. Try to compare them with their C++ counterparts as you learn <span class="No-Break">about them.</span></p>
<p>For the code shown in this section, you can put them in another Lua script file named <strong class="source-inline">2-controls.lua</strong>, and import it with <strong class="source-inline">dofile</strong> in the Lua interpreter. You can put each example in a separate function so that you can test the code with different parameters. By now, you should be comfortable using the Lua interpreter, so we will not show how to do it in the rest of <span class="No-Break">this chapter.</span></p>
<p>We will first explore<a id="_idIndexMarker093"/> how to do conditional branching in Lua, and then we will venture <span class="No-Break">into loops.</span></p>
<h2 id="_idParaDest-54"><a id="_idTextAnchor054"/>if then else</h2>
<p>The Lua <strong class="source-inline">if</strong> control<a id="_idIndexMarker094"/> structure is similar to the C++ one. However, you do not need the parentheses around the test condition, and you do not use the curly brackets. Instead, you will need the <strong class="source-inline">then</strong> keyword and the <strong class="source-inline">end</strong> keyword to delimit the code branches, <span class="No-Break">for example:</span></p>
<pre class="source-code">
if a &lt; 0 then a = 0 end
if a &gt; 0 then return a else return 0 end
if a &lt; 0 then
    a = 0
    print("changed")
else
    print("unchanged")
end</pre>
<p>The <strong class="source-inline">else</strong> branch is optional if you have no operation for that. If you have only one statement in each branch, you can also choose to write everything in <span class="No-Break">one line.</span></p>
<p>The Lua language design emphasizes simplicity, so the <strong class="source-inline">if</strong> control structure is the only conditional branching control. What if you want to implement something that resembles a C++ <strong class="bold">switch</strong> <span class="No-Break">control structure?</span></p>
<h3>Simulating switch</h3>
<p>There is no switch<a id="_idIndexMarker095"/> control structure in Lua. To simulate it, you can use <strong class="source-inline">elseif</strong>. The following code <span class="No-Break">does that:</span></p>
<pre class="source-code">
if day == 1 then
    return "Monday"
elseif day == 2 then
    return "Tuesday"
elseif day == 3 then
    return "Wednesday"
elseif day == 4 then
    return "Thursday"
elseif day == 5 then
    return "Friday"
elseif day == 6 then
    return "Saturday"
elseif day == 7 then
    return "Sunday"
else
    return nil
end</pre>
<p>This behaves the same as a C++ <strong class="source-inline">if..else if</strong> control structure. The <strong class="source-inline">if</strong> and <strong class="source-inline">elseif</strong> conditions will be <a id="_idIndexMarker096"/>checked one by one until one condition is met and the name of the day of the week <span class="No-Break">is returned.</span></p>
<h2 id="_idParaDest-55"><a id="_idTextAnchor055"/>while</h2>
<p>The Lua <strong class="bold">while</strong> control<a id="_idIndexMarker097"/> structure also resembles <a id="_idIndexMarker098"/>the C++ version. You can put a code block between the <strong class="source-inline">do</strong> keyword and the <strong class="source-inline">end</strong> keyword. The following example prints the days of <span class="No-Break">the week:</span></p>
<pre class="source-code">
local days = {
    "Monday", "Tuesday", "Wednesday", "Thursday",
    "Friday", "Saturday", "Sunday"
}
local i = 1
while days[i] do
    print(days[i])
    i = i + 1
end</pre>
<p>We declare a table named <strong class="source-inline">days</strong> and use it as an array. When the <strong class="source-inline">i</strong> index reaches <strong class="source-inline">8</strong>, the loop will end because <strong class="source-inline">days[8]</strong> is <strong class="source-inline">nil</strong> and tests as <strong class="source-inline">false</strong>. Coming from C++, you may wonder why we can access the eighth element of a seven-element array. In Lua, there is no index out of bound issue when a table is accessed <span class="No-Break">this way.</span></p>
<p>You can <a id="_idIndexMarker099"/>use <strong class="source-inline">break</strong> to end the loop<a id="_idIndexMarker100"/> immediately. This works for the <strong class="source-inline">repeat</strong> loop and the <strong class="source-inline">for</strong> loop as well, which we will <span class="No-Break">explain next.</span></p>
<h2 id="_idParaDest-56"><a id="_idTextAnchor056"/>repeat</h2>
<p>The Lua <strong class="bold">repeat</strong> does <a id="_idIndexMarker101"/>what the C++ <strong class="source-inline">do..while</strong> control <a id="_idIndexMarker102"/>structure does, but the ending condition is treated differently. Lua uses the <strong class="source-inline">until</strong> condition to end the loop instead of <span class="No-Break">C++’s </span><span class="No-Break"><strong class="source-inline">while</strong></span><span class="No-Break">.</span></p>
<p>Let us implement the same code shown for the <strong class="source-inline">while</strong> control structure but with <strong class="source-inline">repeat</strong> <span class="No-Break">this time:</span></p>
<pre class="source-code">
local days = {
    "Monday", "Tuesday", "Wednesday", "Thursday",
    "Friday", "Saturday", "Sunday"
}
local i = 0
repeat
    i = i + 1
    print(days[i])
until i == #days</pre>
<p><strong class="source-inline">#days</strong> returns the length of the <strong class="source-inline">day</strong> array. The code block within <strong class="source-inline">repeat..until</strong> will loop until <strong class="source-inline">i</strong> reaches <span class="No-Break">this length.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">Keep in mind that for a Lua array, the index starts <span class="No-Break">from 1.</span></p>
<p>To implement the same code with <strong class="source-inline">do..while</strong> in C++, do <span class="No-Break">the following:</span></p>
<pre class="source-code">
const std::vector&lt;std::string&gt; days {
    "Monday", "Tuesday", "Wednesday", "Thursday",
    "Friday", "Saturday", "Sunday"
};
size_t i = 0;
do {
    std::cout &lt;&lt; days[i] &lt;&lt; std::endl;
    i++;
} while (i &lt; days.size());</pre>
<p>The C++ implementation <a id="_idIndexMarker103"/>looks very similar to the Lua version, except for <a id="_idIndexMarker104"/>the ending condition as pointed out earlier: <strong class="source-inline">i &lt; days.size()</strong>. We are checking for less than, not <span class="No-Break">equal to.</span></p>
<h2 id="_idParaDest-57"><a id="_idTextAnchor057"/>for, numerical</h2>
<p>The<a id="_idIndexMarker105"/> numerical <strong class="bold">for</strong> loops<a id="_idIndexMarker106"/> through a list of numbers. It takes <span class="No-Break">this form:</span></p>
<pre class="source-code">
for var = exp1, exp2, exp3 do
    do_something
end</pre>
<ul>
<li><strong class="source-inline">var</strong> is treated as a local variable scoped to the <span class="No-Break"><strong class="source-inline">for</strong></span><span class="No-Break"> block.</span></li>
<li><strong class="source-inline">exp1</strong> is the <span class="No-Break">start value.</span></li>
<li><strong class="source-inline">exp2</strong> is the <span class="No-Break">end value.</span></li>
<li><strong class="source-inline">exp3</strong> is the step and is optional. When not provided, the default step <span class="No-Break">is 1.</span></li>
</ul>
<p>To understand this better, let us see <span class="No-Break">an example:</span></p>
<pre class="source-code">
local days = {
    "Monday", "Tuesday", "Wednesday", "Thursday",
    "Friday", "Saturday", "Sunday"
}
for i = 1, #days, 4 do
    print(i, days[i])
end</pre>
<p><strong class="source-inline">i</strong> is the local variable and has an initial value of <strong class="source-inline">1</strong>. The loop will end when <strong class="source-inline">i</strong> becomes greater than <strong class="source-inline">#days</strong>. A step of <strong class="source-inline">4</strong> is also provided. So, after each iteration, the effect is <strong class="source-inline">i = i + 4</strong>. Once you run this code, you will find out that only Monday and Friday <span class="No-Break">are printed.</span></p>
<p>And, maybe to your surprise, the float type will work <span class="No-Break">as well:</span></p>
<pre class="source-code">
Lua 5.4.6  Copyright (C) 1994-2022 Lua.org, PUC-Rio
&gt; for a = 1.0, 4.0, 1.5 do print(a) end
1.0
2.5
4.0</pre>
<p>As can be <a id="_idIndexMarker107"/>verified by the output, the <strong class="source-inline">for</strong> loop <a id="_idIndexMarker108"/>prints from <strong class="source-inline">1.0</strong> and increases the value by <strong class="source-inline">1.5</strong> every time, as long as the value is not greater <span class="No-Break">than </span><span class="No-Break"><strong class="source-inline">4.0</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-58"><a id="_idTextAnchor058"/>for, generic</h2>
<p>The generic <strong class="source-inline">for</strong> loop <a id="_idIndexMarker109"/>traverses <a id="_idIndexMarker110"/>all values returned by an <strong class="source-inline">iterator function</strong>. This form of <strong class="source-inline">for</strong> loops is very convenient for <span class="No-Break">traversing tables.</span></p>
<p>When we talked about numerical <strong class="source-inline">for</strong> loops, we saw how they can traverse index-based tables. However, a table in Lua can be more than an array. The most common iterators on tables are <strong class="source-inline">pairs</strong> and <strong class="source-inline">ipairs</strong>. They return the key and value pairs for the table. <strong class="source-inline">pairs</strong> return pairs in an undefined order, as in most hash map implementations. <strong class="source-inline">ipairs</strong> returns pairs in a <span class="No-Break">sorted order.</span></p>
<p>Even for an index-based table, if you want to traverse everything, the generic <strong class="source-inline">for</strong> loop can also be <span class="No-Break">more convenient:</span></p>
<pre class="source-code">
local days = {
    "Monday", "Tuesday", "Wednesday", "Thursday",
    "Friday", "Saturday", "Sunday"
}
for index, day in pairs(days) do
    print(index, day)
end</pre>
<p>This loops through the whole array without referring to the array length. The <strong class="source-inline">pairs</strong> iterator returns<a id="_idIndexMarker111"/> the key and value pair, one by one, for<a id="_idIndexMarker112"/> each loop iteration until all elements in the table are enumerated. After this, the <span class="No-Break">loop ends.</span></p>
<h1 id="_idParaDest-59"><a id="_idTextAnchor059"/>Summary</h1>
<p>In this chapter, we have learned about six out of the eight data types in Lua and the four control structures. We have also learned about local variables and why you should use them. This knowledge will prepare you for the rest of <span class="No-Break">the book.</span></p>
<p>By now, you should be able to read and understand most of the Lua code out there. Some details and topics were intentionally not included in this chapter. You can study more about them when you <span class="No-Break">encounter them.</span></p>
<p>In the next chapter, we will learn how to call Lua code <span class="No-Break">from C++.</span></p>
<h1 id="_idParaDest-60"><a id="_idTextAnchor060"/>Exercises</h1>
<ol>
<li>Locate the standard string manipulation library in the Lua reference manual. Learn about <strong class="source-inline">string.gmatch</strong>, <strong class="source-inline">string.gsub</strong>, and pattern matching. What pattern represents all <span class="No-Break">non-space characters?</span></li>
<li>Using <strong class="source-inline">string.gmatch</strong> and a generic <strong class="source-inline">for</strong> loop, reverse the sentence “C++ loves Lua.” The output should be “Lua <span class="No-Break">loves C++.”</span></li>
<li>Can you use <strong class="source-inline">string.gsub</strong> and achieve the same with one line <span class="No-Break">of code?</span></li>
</ol>
<h1 id="_idParaDest-61"><a id="_idTextAnchor061"/>References</h1>
<p>The official Lua reference <span class="No-Break">manual: </span><a href="https://www.lua.org/manual/5.4/"><span class="No-Break">https://www.lua.org/manual/5.4/</span></a></p>
</div>
</div>

<div id="sbo-rt-content"><div class="Content" id="_idContainer018">
<h1 id="_idParaDest-62" lang="en-US" xml:lang="en-US"><a id="_idTextAnchor062"/>Part 2 – Calling Lua from C++</h1>
<p>Now that you are familiar with setting up C++ projects with Lua, you will start to learn how to call Lua code <span class="No-Break">from C++.</span></p>
<p>You will start to implement a general C++ utility class to load and execute Lua code. First, you will learn how to load Lua scripts and call a Lua function. Then, you will explore how to pass arguments to Lua functions and handle return values. Finally, you will dig deeper to master working with <span class="No-Break">Lua tables.</span></p>
<p>This part comprises the <span class="No-Break">following chapters:</span></p>
<ul>
<li><em class="italic">Chapter 3</em>, <em class="italic">How to Call Lua from C++</em></li>
<li><em class="italic">Chapter 4</em>, <em class="italic">Mapping Lua Types to C++</em></li>
<li><em class="italic">Chapter 5</em>, <em class="italic">Working with Lua Tables</em></li>
</ul>
</div>
<div>
<div id="_idContainer019">
</div>
</div>
<div>
<div id="_idContainer020">
</div>
</div>
<div>
<div id="_idContainer021">
</div>
</div>
<div>
<div id="_idContainer022">
</div>
</div>
<div>
<div id="_idContainer023">
</div>
</div>
<div>
<div class="Basic-Graphics-Frame" id="_idContainer024">
</div>
</div>
<div>
<div class="Basic-Graphics-Frame" id="_idContainer025">
</div>
</div>
<div>
<div id="_idContainer026">
</div>
</div>
<div>
<div id="_idContainer027">
</div>
</div>
<div>
<div class="Basic-Graphics-Frame" id="_idContainer028">
</div>
</div>
</div></body></html>