<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer529">
<h1 class="chapter-number" id="_idParaDest-317"><a id="_idTextAnchor345"/>16</h1>
<h1 id="_idParaDest-318"><a id="_idTextAnchor346"/>Getting Started with Multiplayer Basics</h1>
<p>In the previous chapter, we completed the SuperSideScroller game and used 1D Blend Spaces, animation blueprints, and animation montages. In this chapter, we’re going to build on that knowledge and learn how to add multiplayer functionality to a game using Unreal Engine.</p>
<p>Multiplayer games have grown quite a lot in the last decade. Games such as Fortnite, League of Legends, Rocket League, Overwatch, and Counter-Strike: Global Offensive have gained a lot of popularity in the gaming community and have had great success. Nowadays, almost all games need to have some kind of multiplayer experience to be more relevant and successful.</p>
<p>The reason for this is it adds a new layer of possibilities on top of the existing gameplay, such as being able to remotely play with friends in cooperative mode (also known as online co-op) or against people from all around the world, which greatly increases the longevity and value of a game.</p>
<p>In this chapter, we’re going to cover the following main topics:</p>
<ul>
<li>Introduction to multiplayer basics</li>
<li>Understanding the server</li>
<li>Understanding the client</li>
<li>Packaging the project</li>
<li>Exploring connections and ownership</li>
<li>Getting to know roles</li>
<li>Understanding variable replication</li>
<li>Exploring 2D Blend Spaces</li>
<li>Transforming (modifying) bones</li>
</ul>
<p>By the end of this chapter, you’ll know basic multiplayer concepts such as the server-client architecture, connections, actor ownership, roles and variable replication so that you can create a multiplayer game of your own. You’ll also be able to make a 2D Blend Space, which allows you to blend between animations laid out in a 2D grid. Finally, you’ll learn how to use Transform (Modify) Bone nodes to control Skeletal Mesh bones at runtime.</p>
<h1 id="_idParaDest-319"><a id="_idTextAnchor347"/>Technical requirements</h1>
<p>For this chapter, you will need the following technical requirements:</p>
<ul>
<li>Unreal Engine 5 installed</li>
<li>Visual Studio 2019 installed</li>
</ul>
<p>The project for this chapter can be found in the <strong class="source-inline">Chapter16</strong> folder of the code bundle for this book, which can be downloaded here: <a href="https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition">https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition</a>. </p>
<p>In the next section, we will discuss the basics of multiplayer.</p>
<h1 id="_idParaDest-320"><a id="_idTextAnchor348"/>Introduction to multiplayer basics</h1>
<p>You may have heard the term <a id="_idIndexMarker1369"/>multiplayer a lot while gaming, but what does it mean for game developers? Multiplayer, in reality, is just a set of instructions sent through the network (internet or local area network) between the server and its connected clients to give players the illusion of a shared world.</p>
<p>For this to work, the server needs to be able to talk to clients, but also the other way around (client to server). This is because clients are typically the ones that affect the game world, so they need a way to be able to inform the server of their intentions while playing the game.</p>
<p>An example of this back and forth communication between the server and a client is when a player tries to fire a<a id="_idIndexMarker1370"/> weapon during a game. Have a look at the following diagram, which shows a client-server interaction:</p>
<div>
<div class="IMG---Figure" id="_idContainer502">
<img alt="Figure 16.1 – Client-server interaction when firing a weapon " height="825" src="image/Figure_16..01_B18531.jpg" width="985"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.1 – Client-server interaction when firing a weapon</p>
<p>Let’s understand the preceding diagram:</p>
<ol>
<li>The player holds the left mouse button down and the client of that player tells the server that it wants to fire a weapon.</li>
<li>The server validates whether the player can fire the weapon by checking the following:<ul><li>If the player is alive</li><li>If the player has the weapon equipped</li><li>If the player has enough ammo</li></ul></li>
<li>If all of the conditions are valid, then the server will do the following: <ul><li>Run the logic to deduct ammo.</li><li>Spawn the projectile actor on the server, which is automatically sent to all of the clients.</li><li>Play the fire animation on that character instance in all of the clients to ensure synchronicity between all of them, which helps to sell the idea that it’s the same world, even though it’s not.</li></ul></li>
<li>If any of the conditions fail, then the server tells the specific client what to do: <ul><li>The player is dead: Don’t do anything.</li><li>The player doesn’t have the weapon equipped: Don’t do anything.</li><li>The player doesn’t have enough ammo: Play an empty click sound.</li></ul></li>
</ol>
<p>Remember, if you want your <a id="_idIndexMarker1371"/>game to support multiplayer, then it’s highly recommended that you do that as soon as possible in your development cycle. If you try to run a single-player project with multiplayer enabled, you’ll notice that some functionalities might just work, but probably most of them won’t be working properly or as expected.</p>
<p>The reason for that is when you execute the game in single-player, the code runs locally and instantly, but when you add multiplayer into the equation, you are adding external factors such as an authoritative server that talks to clients on a network with latency, as you saw in <em class="italic">Figure 16.1</em>.</p>
<p>To get everything working properly, you need to break the existing code into the following components:</p>
<ul>
<li>Code that only runs on the server</li>
<li>Code that only runs on the client</li>
<li>Code that runs on both the server and the client</li>
</ul>
<p>To add multiplayer<a id="_idIndexMarker1372"/> support to games, UE5 comes with a very powerful and bandwidth-efficient network framework already built in that uses an authoritative server-client architecture.</p>
<p>Here is a diagram of how it works:</p>
<div>
<div class="IMG---Figure" id="_idContainer503">
<img alt="Figure 16.2 – Server-client architecture in UE5 " height="612" src="image/Figure_16..02_B18531.jpg" width="643"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.2 – Server-client architecture in UE5</p>
<p>Here, you can see how the server-client architecture works in UE5. Each player controls a client that communicates with the server using a two-way connection. The server runs a specific level with a <a id="_idIndexMarker1373"/>game mode (that only exists in the server) and controls the flow of information so that the clients can see and interact with each other in the game world.</p>
<p class="callout-heading">Note</p>
<p class="callout">Multiplayer can be a very advanced topic, so these next few chapters will serve as an introduction to help you understand the essentials, but it will not be an in-depth look. For that reason, some concepts might be omitted for the sake of simplicity.</p>
<p>At this point, you have an idea of how multiplayer basics work. Now, let’s dive in and see how servers work and what their responsibilities are.</p>
<h1 id="_idParaDest-321"><a id="_idTextAnchor349"/>Understanding the server</h1>
<p>The server is the most critical part of the architecture since it’s responsible for handling most of the work and making important decisions.</p>
<p>Here is an overview of the <a id="_idIndexMarker1374"/>main responsibilities of a server: </p>
<ul>
<li><strong class="bold">Creating and managing the shared world instance</strong>: The server runs its instance of the game in a specific level and game mode (this will be covered in <a href="B18531_18.xhtml#_idTextAnchor404"><em class="italic">Chapter 18</em></a>, <em class="italic">Using Gameplay Framework Classes in Multiplayer</em>), which will serve as the shared world between all of the connected clients. The level being used can be changed at any point in time and, if applicable, the server can bring along all of the connected clients with it automatically. </li>
<li><strong class="bold">Handling client join and leave requests</strong>: If a client wants to connect to a server, it needs to ask for permission. To do this, the client sends a join request to the server, through a direct IP connection (explained in the next section) or an online subsystem such as Steam. Once the join request reaches the server, it will perform some validations to determine whether the request is accepted or rejected. </li>
</ul>
<p>Some of the most common reasons why the server rejects a request are if the server is already at full capacity and can’t take any more clients or if the client is using an out-of-date version of the game. If the server accepts the request, then a player controller with a connection is assigned to the client and the <strong class="source-inline">PostLogin</strong> function in the game mode is called. From that point on, the client will enter the game and is <a id="_idIndexMarker1375"/>now part of the shared world, where the player will be able to see and interact with other clients. If a client disconnects at any point in time, then all of the other clients will be notified and the <strong class="source-inline">Logout</strong> function in the game mode will be called.</p>
<ul>
<li><strong class="bold">Spawning the actors that all of the clients need to know about</strong>: If you want to spawn an actor that exists in all of the clients, then you need to do that on the server. The reason for this is that the server has the authority and is the only one that can tell each client to create an instance of that actor.</li>
</ul>
<p>This is the most common way of spawning actors in multiplayer since most actors need to exist in all of the clients. An example of this would be with a power-up, which is something that all clients can see and interact with.</p>
<ul>
<li><strong class="bold">Running critical gameplay logic</strong>: To make sure that the game is fair to all of the clients, the critical gameplay logic needs to be executed on the server only. If the clients were responsible for handling the deduction of health, it would be very exploitable, because a player could use a tool to change the current value of health to 100% all the time in memory, so the player would never die in the game. </li>
<li><strong class="bold">Handling variable replication</strong>: If you have a replicated variable (covered in the <em class="italic">Understanding variable replication</em> section), then its value should only be changed on the server. This will ensure that all of the clients will have the value updated automatically. You can still change the value on the client, but it will always be replaced with the latest value from the server to prevent cheating and to make sure all of the clients are in sync.</li>
<li><strong class="bold">Handling RPCs from the client</strong>: The server needs to process the <strong class="bold">remote procedure calls</strong> (<strong class="bold">RPCs</strong>) (covered in <a href="B18531_17.xhtml#_idTextAnchor386"><em class="italic">Chapter 17</em></a>, <em class="italic">Using Remote Procedure Calls</em>) that are sent from the clients.</li>
</ul>
<p>Now that you know what<a id="_idIndexMarker1376"/> a server does, we can talk about the two different ways of creating a server in UE5.</p>
<h2 id="_idParaDest-322"><a id="_idTextAnchor350"/>Dedicated server</h2>
<p>The dedicated server only runs the<a id="_idIndexMarker1377"/> server logic, so you won’t see the typical <a id="_idIndexMarker1378"/>window with the game running where you control a character as a normal player. This means that all the clients will connect to this server and its only job is to coordinate them and execute the critical gameplay logic. Additionally, if you run the dedicated server with the <strong class="source-inline">-log</strong> command prompt, you’ll have a console window that logs relevant information about what is happening on the server, such as if a client has connected or disconnected, and so on. You, as a developer, can also log your information by using the <strong class="source-inline">UE_LOG</strong> macro.</p>
<p>Using dedicated servers is a very common way of creating servers for multiplayer games, and since it’s more lightweight than a listen server (covered in the next section), you could just host it on a server stack and leave it running. Another advantage of dedicated servers is that it will make the game fairer for all players because the network conditions will be the same for everyone, and also because none of the clients has authority, so the possibility of a hack is reduced.</p>
<p>To start a dedicated server in UE5, you can use the following command arguments:</p>
<ul>
<li>Run the following command to start a dedicated server inside an editor through a shortcut or Command Prompt:<p class="source-code"><strong class="bold">"&lt;UE5 Install Folder&gt;\Engine\Binaries\Win64\UnrealEditor.exe" </strong></p><p class="source-code"><strong class="bold">"&lt;UProject Location&gt;" &lt;Map Name&gt; -server -game -log</strong></p></li>
</ul>
<p>Here’s an example:</p>
<p class="source-code"><strong class="bold">"C:\Program Files\Epic </strong></p>
<p class="source-code"><strong class="bold">Games\UE_5.0\Engine\Binaries\Win64\UnrealEditor.exe" </strong></p>
<p class="source-code"><strong class="bold">"D:\TestProject\TestProject.uproject" TestMap -server -game -log</strong></p>
<ul>
<li>Creating a packaged <a id="_idIndexMarker1379"/>dedicated server requires a build of the project that’s been built specifically to serve as a<a id="_idIndexMarker1380"/> dedicated server. </li>
</ul>
<p class="callout-heading">Note</p>
<p class="callout">You can find out more about setting up a packaged dedicated server at <a href="https://docs.unrealengine.com/5.0/en-US/InteractiveExperiences/Networking/HowTo/DedicatedServers/">https://docs.unrealengine.com/5.0/en-US/InteractiveExperiences/Networking/HowTo/DedicatedServers/</a>.</p>
<h2 id="_idParaDest-323"><a id="_idTextAnchor351"/>The listen server</h2>
<p>The listen server acts as<a id="_idIndexMarker1381"/> a server and client at the same time, so you’ll also have a <a id="_idIndexMarker1382"/>window where you can play the game as a client with this server type. It also has the advantage of being the quickest way of getting a server running in a packaged build, but it’s not as lightweight as a dedicated server, so the number of clients that can be connected at the same time will be limited.</p>
<p>To start a listen server, you can use the following command arguments:</p>
<ul>
<li>Run the following command to start a listen server inside an editor through a shortcut or Command Prompt:<p class="source-code"><strong class="bold">"&lt;UE5 Install Folder&gt;\Engine\Binaries\Win64\UnrealEditor.exe" </strong></p><p class="source-code"><strong class="bold">"&lt;UProject Location&gt;" &lt;Map Name&gt;?Listen -game</strong></p></li>
</ul>
<p>Here’s an example: </p>
<p class="source-code"><strong class="bold">"C:\Program Files\Epic </strong></p>
<p class="source-code"><strong class="bold">Games\UE_5.0\Engine\Binaries\Win64\UnrealEditor.exe" </strong></p>
<p class="source-code"><strong class="bold">"D:\TestProject\TestProject.uproject" TestMap?Listen -game</strong></p>
<ul>
<li>Using a packaged development build through a shortcut or Command Prompt:<p class="source-code"><strong class="bold">"&lt;Project Name&gt;.exe" &lt;Map Name&gt;?Listen -game</strong></p></li>
</ul>
<p>Here’s an example: </p>
<p class="source-code"><strong class="bold">"D:\Packaged\TestProject\TestProject.exe" TestMap?Listen –game</strong></p>
<p>Now that you<a id="_idIndexMarker1383"/> know about the<a id="_idIndexMarker1384"/> two different types of servers you have in Unreal Engine, we can now move on to its counterpart – the client and its responsibilities.</p>
<h1 id="_idParaDest-324"><a id="_idTextAnchor352"/>Understanding the client</h1>
<p>The client is the simplest part of <a id="_idIndexMarker1385"/>the architecture because most of the actors will have the authority on the server, so in those cases, the work will be done on the server and the client will just obey its orders. </p>
<p>Here is an overview of the main responsibilities of a client:</p>
<ul>
<li><strong class="bold">Enforcing variable replication from the server</strong>: The server typically has authority over all<a id="_idIndexMarker1386"/> of the actors that the client knows, so when the value of a replicated variable is changed on the server, the client needs to enforce that value as well.</li>
<li><strong class="bold">Handling RPCs from the server</strong>: The client needs to process the RPCs (covered in <a href="B18531_17.xhtml#_idTextAnchor386"><em class="italic">Chapter 17</em></a>, <em class="italic">Using Remote Procedure Calls</em>) that are sent from the server.</li>
<li><strong class="bold">Predicting movement when simulating</strong>: When a client is simulating an actor (covered in the <em class="italic">Getting to know roles</em> section), it needs to locally predict where it’s going to be based on the actor’s velocity.</li>
<li><strong class="bold">Spawning the actors that only a client needs to know about</strong>: If you want to spawn an actor that only exists on a client, then you need to do it on that specific client.</li>
</ul>
<p>This is the least common way of spawning actors since there are fewer cases where you want an actor to only exist on a client. An example of this is the placement preview actor you see in multiplayer survival games, where the player controls a semi-transparent version of a wall that other players can’t see until it’s placed. </p>
<p>A client can join a server in<a id="_idIndexMarker1387"/> a couple of different ways. Here is a list of the most common methods:</p>
<ul>
<li>By opening the UE5 console (by default, this can be done with the <strong class="source-inline">`</strong> key) in a development build and typing the following:<p class="source-code"><strong class="bold">open &lt;Server IP Address&gt;</strong></p></li>
</ul>
<p>Here’s an example:</p>
<p class="source-code"><strong class="bold">open 194.56.23.4</strong></p>
<ul>
<li>Using the <strong class="source-inline">Execute Console Command</strong> Blueprint node. An example is as follows:</li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer504">
<img alt="Figure 16.3 – Joining a server with an example IP with the Execute Console Command node " height="139" src="image/Figure_16..03_B18531.jpg" width="231"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.3 – Joining a server with an example IP with the Execute Console Command node</p>
<ul>
<li>Using the <strong class="source-inline">ConsoleCommand</strong> function in <strong class="source-inline">APlayerController</strong>, as follows:<p class="source-code"><strong class="bold">PlayerController-&gt;ConsoleCommand("open &lt;Server IP Address&gt;");</strong></p></li>
</ul>
<p>Here’s an example: </p>
<p class="source-code"><strong class="bold">PlayerController-&gt;ConsoleCommand("open 194.56.23.4");</strong></p>
<ul>
<li>Using the editor executable through a shortcut or Command Prompt:<p class="source-code"><strong class="bold">"&lt;UE5 Install Folder&gt;\Engine\Binaries\Win64\UnrealEditor.exe" </strong></p><p class="source-code"><strong class="bold">"&lt;UProject Location&gt;" &lt;Server IP Address&gt; -game</strong></p></li>
</ul>
<p>Here’s an example:</p>
<p class="source-code"><strong class="bold">"C:\Program Files\Epic Games\UE_5.0\Engine\Binaries\Win64\UnrealEditor.exe" "D:\TestProject\TestProject.uproject" 194.56.23.4 -game</strong></p>
<ul>
<li>Using a packaged <a id="_idIndexMarker1388"/>development build through a shortcut or Command Prompt: <p class="source-code"><strong class="bold">"&lt;Project Name&gt;.exe" &lt;Server IP Address&gt;</strong></p></li>
</ul>
<p>Here’s an example: </p>
<p class="source-code"><strong class="bold">"D:\Packaged\TestProject\TestProject.exe" 194.56.23.4</strong></p>
<p>In the following exercise, we will test the <strong class="bold">Third Person</strong> template that comes with UE5 in multiplayer.</p>
<h2 id="_idParaDest-325"><a id="_idTextAnchor353"/>Exercise 16.01 – Testing the Third Person template in multiplayer</h2>
<p>In this exercise, we’re going<a id="_idIndexMarker1389"/> to create a <strong class="bold">Third Person</strong> template project and play it in multiplayer.</p>
<p>Follow these steps to complete this exercise:</p>
<ol>
<li value="1">Create a new <strong class="bold">Third Person</strong> template project using <strong class="bold">Blueprints</strong> called <strong class="source-inline">TestMultiplayer</strong> and save it to a location of your choosing.</li>
</ol>
<p>Once the project has been created, it should open the editor. Now, let’s test the project in multiplayer to see how it behaves.</p>
<ol>
<li value="2">In the editor, to the right of the <strong class="bold">Play</strong> button, you have a button with three vertical dots. Click on it and you should see a list of options. Under the <strong class="bold">Multiplayer Options</strong> section, you can configure how many clients you want and specify the net mode, which has the following options:<ul><li><strong class="bold">Play Standalone</strong>: Runs the game in single player</li><li><strong class="bold">Play As Listen Server</strong>: Runs the game with a listen server</li><li><strong class="bold">Play As Client</strong>: Runs the game with a dedicated server</li></ul></li>
<li>Make sure the <strong class="bold">Net Mode</strong> option is set to <strong class="bold">Play As Listen Server</strong>, change <strong class="bold">Number of Players</strong> to <strong class="source-inline">3</strong>, and click on <strong class="bold">New Editor Window (PIE)</strong>.</li>
</ol>
<p>You should see three <a id="_idIndexMarker1390"/>windows on top of each other representing the three clients:</p>
<div>
<div class="IMG---Figure" id="_idContainer505">
<img alt="Figure 16.4 – Launching three client windows with a listen server " height="681" src="image/Figure_16..04_B18531.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.4 – Launching three client windows with a listen server</p>
<p>As you can see, the server window is bigger than the client windows, so let’s change its size. Press <em class="italic">Esc</em> on your keyboard to stop playing.</p>
<ol>
<li value="4">Once again, click on the button with the three vertical dots next to the <strong class="bold">Play</strong> button and pick the last option, <strong class="bold">Advanced Settings</strong>.</li>
<li>Search for the <strong class="bold">Game Viewport Settings</strong> section. Change <strong class="bold">New Viewport Resolution</strong> to <strong class="source-inline">640x480</strong> and close the <strong class="bold">Editor Preferences</strong> tab.</li>
</ol>
<p class="callout-heading">Note</p>
<p class="callout">This option will only change the size of the server window. If you want to change the size of the client window, you can modify the value of the <strong class="bold">Multiplayer Viewport Size</strong> option, which you can find by scrolling down a bit more in the same menu.</p>
<ol>
<li value="6">Play the game<a id="_idIndexMarker1391"/> again; you should see the following:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer506">
<img alt="Figure 16.5 – Launching three client windows using a 640x480 resolution with a listen server  " height="681" src="image/Figure_16..05_B18531.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.5 – Launching three client windows using a 640x480 resolution with a listen server </p>
<p>Once you start playing, you’ll notice that the title bars of the windows say <strong class="bold">Server</strong>, <strong class="bold">Client 1</strong>, and <strong class="bold">Client 2</strong>. Since you can control a character in the <strong class="bold">Server</strong> window, that means we’re running a listen server, where you have the server and a client running in the same window. When that happens, you should interpret the window title as <strong class="bold">Server + Client 0</strong> instead of just <strong class="bold">Server</strong> to avoid confusion.</p>
<p>By completing this exercise, you have a setup where you have a server and three clients running (<strong class="bold">Client 0</strong>, <strong class="bold">Client 1</strong>, and <strong class="bold">Client 2</strong>).</p>
<p class="callout-heading">Note</p>
<p class="callout">When you have multiple windows running at the same time, you’ll notice that you can only have input focus on one window at a time. To shift the focus to another window, just press <em class="italic">Shift</em> + <em class="italic">F1</em> to lose the current input focus, and then click on the new window you want to focus on.</p>
<p>If you play the game in one of the windows, you’ll notice that you can move around and jump. When you do those actions the other clients will also be able to see that.</p>
<p>The reason why everything works is because the character movement component, which comes with the character <a id="_idIndexMarker1392"/>class, replicates the location, rotation, and falling state (used to determine whether you are in the air or not) for you automatically. If you want to add a custom behavior such as an attack animation, you can’t just tell the client to play an animation locally when a key is pressed, because that will not work on the other clients. That’s why you need the server – to serve as an intermediary and tell all the clients to play the animation when one client presses the key.</p>
<p>In this exercise, we’ve learned how to test multiplayer in the editor. Now, let’s learn how to do the same on a packaged build.</p>
<h1 id="_idParaDest-326"><a id="_idTextAnchor354"/>Packaging the project</h1>
<p>Once you’ve finished the<a id="_idIndexMarker1393"/> project, it’s good practice to package it so that you have a pure standalone version that doesn’t use the Unreal Engine editor. This will run faster and be more lightweight.</p>
<p>Follow these steps to create the packaged version of the file in <em class="italic">Exercise 16.01 – Testing the Third Person template in multiplayer</em>:</p>
<ol>
<li value="1">Go to <strong class="bold">Platforms</strong> (to the right of the <strong class="bold">Play</strong> button) | <strong class="bold">Windows</strong> | <strong class="bold">Package Project</strong>.</li>
<li>Pick a folder to place the packaged build and wait for it to finish.</li>
<li>Once it has finished, go to the selected folder and open the <strong class="source-inline">Windows</strong> folder inside it.</li>
<li>Right-click on <strong class="bold">TestMultiplayer.exe</strong> and pick <strong class="bold">Create Shortcut</strong>.</li>
<li>Rename the new shortcut <strong class="bold">Run Server</strong>.</li>
<li>Right-click on it and pick <strong class="bold">Properties</strong>.</li>
<li>On the target, append <strong class="source-inline">ThirdPersonMap?Listen -server</strong>, which will create a listen server using <strong class="source-inline">ThirdPersonMap</strong>. You should end up with this:<p class="source-code"><strong class="bold">"&lt;Packaged Path&gt;\Windows\TestMultiplayer.exe" </strong></p><p class="source-code"><strong class="bold">  ThirdPersonMap?Listen -server</strong></p></li>
<li>Click <strong class="bold">OK</strong> and run the shortcut.</li>
<li>You should get a Windows Firewall prompt; allow it.</li>
<li>Leave the server running, go back to the folder (using ALT+TAB or pressing the Windows Key and selecting another window from the taskbar), and create another shortcut from <strong class="bold">TestMultiplayer.exe</strong>.</li>
<li>Rename it <strong class="source-inline">Run Client</strong>.</li>
<li>Right-click on it and pick <strong class="bold">Properties</strong>.</li>
<li>On the target, append <strong class="source-inline">127.0.0.1</strong>, which is the IP of your local server. You should end up with <strong class="source-inline">"&lt;Packaged Path&gt;\Windows\TestMultiplayer.exe" 127.0.0.1</strong>.</li>
<li>Click <strong class="bold">OK</strong> and run the shortcut.</li>
</ol>
<p>You are now <a id="_idIndexMarker1394"/>connected to the listen server, which means you can see each other’s characters. Every time you click on the <strong class="bold">Run Client</strong> shortcut, you’ll add a new client to the server so that you can have a few clients running on the same machine.</p>
<p>Once you are done testing the packaged build, you can hit ALT+F4 to close each window.</p>
<p>Now that we know how to test our packaged project in multiplayer, let’s take a look at connections and ownership, which allow us to have a two-way communication line between the server and the client.</p>
<h1 id="_idParaDest-327"><a id="_idTextAnchor355"/>Exploring connections and ownership</h1>
<p>When using multiplayer<a id="_idIndexMarker1395"/> in Unreal Engine, an important concept to understand is that of a connection. When a client joins a server, it will get a new Player Controller with a connection associated with it.</p>
<p>If an actor doesn’t have a valid connection with the server, then it won’t be able to do replication operations such as variable replication (covered in the <em class="italic">Understanding variable replication</em> section) or call RPCs (covered in <a href="B18531_17.xhtml#_idTextAnchor386"><em class="italic">Chapter 17</em></a>, <em class="italic">Using Remote Procedure Calls</em>).</p>
<p>If the Player Controller is the only actor that holds a connection, then does that mean that it’s the only place you can do replication operations? No, and that’s where the <strong class="source-inline">GetNetConnection</strong> function, defined in <strong class="source-inline">AActor</strong>, comes into play.</p>
<p>When doing replication operations (such as variable replication or calling RPCs) on an actor, the network framework will get the actor’s connection by calling the <strong class="source-inline">GetNetConnection()</strong> function on it. If the connection is valid, then the replication operation will be processed; if it’s not, nothing will happen. The most common implementations of <strong class="source-inline">GetNetConnection()</strong> are from <strong class="source-inline">APawn</strong> and <strong class="source-inline">AActor</strong>.</p>
<p>Let’s take a look at how the <strong class="source-inline">APawn</strong> class implements the <strong class="source-inline">GetNetConnection()</strong> function, which is typically used for characters:</p>
<pre class="source-code">
class UNetConnection* APawn::GetNetConnection() const
{
  // If we have a controller, then use its net connection
  if ( Controller )
  {
    return Controller-&gt;GetNetConnection();
  }
  return Super::GetNetConnection();
}</pre>
<p>The preceding implementation, which is part of the UE5 source code, will first check whether the pawn has a valid controller. If the controller is valid, then it will use its connection. If the controller is not valid, then it will use the parent implementation of the <strong class="source-inline">GetNetConnection()</strong> function, which is on <strong class="source-inline">AActor</strong>:</p>
<pre class="source-code">
UNetConnection* AActor::GetNetConnection() const
{
  return Owner ? Owner-&gt;GetNetConnection() : nullptr;
}</pre>
<p>The preceding<a id="_idIndexMarker1396"/> implementation, which is also part of the UE5 source code, will check if the actor has a valid owner. If it does, it will use the owner’s connection; if it doesn’t, it will return an invalid connection. So, what is this <strong class="source-inline">Owner</strong> variable? Every actor has a variable called <strong class="source-inline">Owner</strong> (where you can set its value by calling the <strong class="source-inline">SetOwner</strong> function) that stores which actor owns it, so you can think of it as its parent actor.</p>
<p class="callout-heading">Note</p>
<p class="callout">In a listen server, the connection for the character that’s controlled by its client will always be invalid. This is because that client is already a part of the server and therefore doesn’t need a connection.</p>
<p>Using the owner’s connection in this implementation of <strong class="source-inline">GetNetConnection()</strong> will work like a hierarchy. If, while going up the hierarchy of owners, it finds an owner that is a Player Controller or is being controlled by one, then it will have a valid connection and will be able to process replication operations. Have a look at the following example:</p>
<p>Imagine that a weapon actor was placed in the world and it’s just sitting there. In that situation, the weapon won’t have an owner, so if the weapon tries to do any replication operations, such as variable replication or calling RPCs, nothing will happen.</p>
<p>However, if a client picks up the weapon and calls <strong class="source-inline">SetOwner</strong> on the server with the value of the character, then the weapon will now have a valid connection. The reason for this is because the weapon is an actor, so to get its connection, it will use the <strong class="source-inline">AActor</strong> implementation of <strong class="source-inline">GetNetConnection()</strong>, which returns the connection of its owner. Since the owner is the client’s character, it will use the implementation of <strong class="source-inline">GetNetConnection()</strong> of <strong class="source-inline">APawn</strong>. The character has a valid Player Controller, so that is the connection returned by the function.</p>
<p>Here is a diagram to help you understand this logic:</p>
<div>
<div class="IMG---Figure" id="_idContainer507">
<img alt="Figure 16.6 – Connections and ownership example of a weapon actor " height="934" src="image/Figure_16..06_B18531.jpg" width="677"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.6 – Connections and ownership example of a weapon actor</p>
<p>If the weapon has an<a id="_idIndexMarker1397"/> invalid owner, then this is what will happen:</p>
<ul>
<li> <strong class="source-inline">AWeapon</strong> doesn’t override the <strong class="source-inline">GetNetConnection</strong> function, so it will call the first implementation found in the class hierarchy, which is <strong class="source-inline">AActor::GetNetConnection</strong>.</li>
<li>The implementation of <strong class="source-inline">AActor::GetNetConnection</strong> calls <strong class="source-inline">GetNetConnection</strong> on its owner. Since there is no owner, the connection is invalid.</li>
</ul>
<p>If the weapon has an valid <a id="_idIndexMarker1398"/>owner, then this is what will happen:</p>
<ul>
<li><strong class="source-inline">AWeapon</strong> doesn’t override the <strong class="source-inline">GetNetConnection</strong> function, so it will call the first implementation found in the class hierarchy, which is <strong class="source-inline">AActor::GetNetConnection</strong>.</li>
<li>The implementation of <strong class="source-inline">AActor::GetNetConnection</strong> calls <strong class="source-inline">GetNetConnection</strong> on its owner. Since the owner of the weapon is the character that picked it up, then it will call <strong class="source-inline">GetNetConnection</strong> on it.</li>
<li><strong class="source-inline">ACharacter</strong> doesn’t override the <strong class="source-inline">GetNetConnection</strong> function, so it will call the first implementation found in the class hierarchy, which is <strong class="source-inline">APawn::GetNetConnection</strong>.</li>
<li>The implementation of <strong class="source-inline">APawn::GetNetConnection</strong> uses the connection from the owning player controller. Since the owning player controller is valid, then it will use that connection for the weapon.</li>
</ul>
<p class="callout-heading">Note</p>
<p class="callout">For <strong class="source-inline">SetOwner</strong> to work as intended, it needs to be executed on the authority, which, in most cases, means the server. If you execute <strong class="source-inline">SetOwner</strong> on a game instance that is not the authority, it won’t be able to execute replication operations.</p>
<p>In this section, we learned how connections and ownership allow the server and client to communicate in both directions. Next, we’re going to learn about the concept of the roles of an actor, which tells us the version of the actor that is executing the code.</p>
<h1 id="_idParaDest-328"><a id="_idTextAnchor356"/>Getting to know roles</h1>
<p>When an <a id="_idIndexMarker1399"/>actor is spawned on the server, it will create a version on the server, as well as one on each client. Since there are different versions of the same actor on different instances of the game (<strong class="source-inline">Server</strong>, <strong class="source-inline">Client 1</strong>, <strong class="source-inline">Client 2</strong>, and so on), it is important to know which version of the actor is which. This will allow us to know what logic can be executed in each of these instances.</p>
<p>To help with this situation, every actor has the following two variables:</p>
<ul>
<li><strong class="bold">Local Role</strong>: The role that the <a id="_idIndexMarker1400"/>actor has on the current game instance. For example, if the actor was spawned on the server and the current game instance is also the server, then that version of the actor has authority, so you can run more critical gameplay logic on it. It’s accessed by calling the <strong class="source-inline">GetLocalRole()</strong> function.</li>
<li><strong class="bold">Remote Role</strong>: The role that the <a id="_idIndexMarker1401"/>actor has on remote game instances. For example, if the current game instance is the server, then it returns the role the actor has on clients and vice versa. It’s accessed by calling the <strong class="source-inline">GetRemoteRole()</strong> function.</li>
</ul>
<p>The return type of the <strong class="source-inline">GetLocalRole()</strong> and <strong class="source-inline">GetRemoteRole()</strong> functions is <strong class="source-inline">ENetRole</strong>, which is an enumeration that can have the following possible values:</p>
<ul>
<li><strong class="source-inline">ROLE_None</strong>: The actor doesn’t have a role because it’s not being replicated.</li>
<li><strong class="source-inline">ROLE_SimulatedProxy</strong>: The current game instance doesn’t have authority over the actor and it’s not being controlled by a Player Controller. This means that its movement will be simulated/predicted by using the last value of the actor’s velocity.</li>
<li><strong class="source-inline">ROLE_AutonomousProxy</strong>: The current game instance doesn’t have authority over the actor, but it’s being controlled by a Player Controller. This means that we can send more accurate movement information to the server, based on the player’s inputs, instead of just using the last value of the actor’s velocity.</li>
<li><strong class="source-inline">ROLE_Authority</strong>: The current game instance has complete authority over the actor. This means that if the actor is on the server, the changes that are made to its replicated <a id="_idIndexMarker1402"/>variables will be treated as the value that every client needs to enforce through variable replication.</li>
</ul>
<p>Let’s have a look at the following example code snippet:</p>
<pre class="source-code">
ENetRole MyLocalRole = GetLocalRole();
ENetRole MyRemoteRole = GetRemoteRole();
FString String;
if(MyLocalRole == ROLE_Authority)
{
  if(MyRemoteRole == ROLE_AutonomousProxy)
  {
    String = "This version of the actor is the authority 
    and it's being controlled by a player on its client";
  }
  else if(MyRemoteRole == ROLE_SimulatedProxy)
  {
    String = "This version of the actor is the authority 
    but it's not being controlled by a player on its 
    client";
  }
}
else String = "This version of the actor isn't the authority";
GEngine-&gt;AddOnScreenDebugMessage(-1, 0.0f, FColor::Red, String);</pre>
<p>The preceding code snippet will store the values of the local role and remote role in <strong class="source-inline">MyLocalRole</strong> and <strong class="source-inline">MyRemoteRole</strong>, respectively. After that, it will print different messages on the screen, depending on whether that version of the actor is the authority or whether it’s being <a id="_idIndexMarker1403"/>controlled by a player on its client.</p>
<p class="callout-heading">Note</p>
<p class="callout">It is important to understand that if an actor has a local role of <strong class="source-inline">ROLE_Authority</strong>, it doesn’t mean that it’s on the server; it means that it’s on the game instance that originally spawned it and therefore has authority over it.</p>
<p class="callout">If a client spawns an actor, even though the server and the other clients won’t know about it, its local role will still be <strong class="source-inline">ROLE_Authority</strong>. Most of the actors in a multiplayer game will be spawned by the server; that’s why it’s easy to misunderstand that the authority is always referring to the server.</p>
<p>Here is a table to help you understand the roles that an actor will have in different scenarios:</p>
<div>
<div class="IMG---Figure" id="_idContainer508">
<img alt="Figure 16.7 – Roles that an actor can have in different scenarios " height="479" src="image/Figure_16..07_B18531.jpg" width="1474"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.7 – Roles that an actor can have in different scenarios</p>
<p>In the preceding table, you can see the roles that an actor will have in different scenarios. </p>
<p>We’ll analyze each scenario and explain why the actor has that role in the following sections.</p>
<h2 id="_idParaDest-329"><a id="_idTextAnchor357"/>Actor spawned on the server</h2>
<p>The actor spawns on the server, so<a id="_idIndexMarker1404"/> the server’s version of that actor will have the local role of <strong class="source-inline">ROLE_Authority</strong> and the remote role of <strong class="source-inline">ROLE_SimulatedProxy</strong>. For the client’s version of that actor, its local role will be <strong class="source-inline">ROLE_SimulatedProxy</strong> and the remote role will be <strong class="source-inline">ROLE_Authority</strong>.</p>
<h2 id="_idParaDest-330"><a id="_idTextAnchor358"/>Actor spawned on the client</h2>
<p>The actor was spawned on the client, so the client’s version of that actor will have the local role of <strong class="source-inline">ROLE_Authority</strong> and the remote role of <strong class="source-inline">ROLE_SimulatedProxy</strong>. Since the actor wasn’t spawned on the server, then it will only exist on the client that spawned it.</p>
<h2 id="_idParaDest-331"><a id="_idTextAnchor359"/>Player-owned pawn spawned on the server</h2>
<p>The pawn was spawned on the server, so the <a id="_idIndexMarker1405"/>server’s version of that pawn will have the local role of <strong class="source-inline">ROLE_Authority</strong> and the remote role of <strong class="source-inline">ROLE_AutonomousProxy</strong>. For the client’s version of that pawn, its local role will be <strong class="source-inline">ROLE_AutonomousProxy</strong>, because it’s being controlled by a Player Controller, and the remote role of <strong class="source-inline">ROLE_Authority</strong>.</p>
<h2 id="_idParaDest-332"><a id="_idTextAnchor360"/>Player-owned pawn spawned on the client</h2>
<p>The pawn was spawned on the client, so the <a id="_idIndexMarker1406"/>client’s version of that pawn will have the local role of <strong class="source-inline">ROLE_Authority</strong> and the remote role of <strong class="source-inline">ROLE_SimulatedProxy</strong>. Since the pawn wasn’t spawned on the server, then it will only exist on the client that spawned it.</p>
<h2 id="_idParaDest-333"><a id="_idTextAnchor361"/>Exercise 16.02 – Implementing ownership and roles</h2>
<p>In this exercise, we’re <a id="_idIndexMarker1407"/>going to create a <strong class="bold">C++</strong> project that uses the <strong class="bold">Third Person</strong> template as a base and make it do the following:</p>
<ul>
<li>Create a new actor called <strong class="bold">OwnershipTestActor</strong> that has a static mesh component as the root component. On every tick, it’ll do the following:<ul><li>On the authority, it will check which character is closest to it within a certain radius (configured by the <strong class="source-inline">EditAnywhere</strong> variable called <strong class="source-inline">OwnershipRadius</strong>) and will set that character as its owner. When no character is within the radius, then the owner will be <strong class="source-inline">nullptr</strong>.</li><li>Display its local role, remote role, owner, and connection.</li></ul></li>
<li>Edit <strong class="bold">OwnershipRolesCharacter</strong> and override the <strong class="bold">Tick</strong> function so that it displays its local role, remote role, owner, and connection.</li>
<li>Add a macro called <strong class="bold">ROLE_TO_STRING </strong>on<strong class="bold"> OwnershipRoles.h</strong>, which converts <strong class="source-inline">ENetRole</strong> into an <strong class="source-inline">FString</strong> value that can be printed on the screen.</li>
</ul>
<p>Follow these steps to <a id="_idIndexMarker1408"/>complete this exercise:</p>
<ol>
<li value="1">Create a new <strong class="bold">Third Person</strong> template project using <strong class="bold">C++</strong> called <strong class="bold">OwnershipRoles </strong>and save it to a location of your liking. </li>
<li>Once the project has been created, it should open the editor as well as the Visual Studio solution.</li>
<li>Using the editor, create a new C++ class called <strong class="bold">OwnershipTestActor</strong> that derives from <strong class="source-inline">Actor</strong>.</li>
<li>Once it finishes compiling, Visual Studio should pop up with the newly created <strong class="source-inline">.h</strong> and <strong class="source-inline">.cpp</strong> files.</li>
<li>Close the editor and go back to Visual Studio.</li>
<li>In Visual Studio, open the <strong class="source-inline">OwnershipRoles.h</strong> file and add the following macro:<p class="source-code">#define ROLE_TO_STRING(Value) FindObject&lt;UEnum&gt;(ANY_PACKAGE, TEXT("ENetRole"), true)-&gt;GetNameStringByIndex(static_cast&lt;int32&gt;(Value))</p></li>
</ol>
<p>This macro will be used to convert the <strong class="source-inline">ENetRole</strong> enumeration that we get from the <strong class="source-inline">GetLocalRole()</strong> function and <strong class="source-inline">GetRemoteRole()</strong> into an <strong class="source-inline">FString</strong>. The way it works is by finding the <strong class="source-inline">ENetRole</strong> enumeration type through Unreal Engine’s reflection system. From there, it converts the <strong class="source-inline">Value</strong> parameter into an <strong class="source-inline">FString</strong> variable so that it can be printed on the screen.</p>
<ol>
<li value="7">Now, open the <strong class="source-inline">OwnershipTestActor.h</strong> file and declare the protected variables for the static<a id="_idIndexMarker1409"/> mesh component and the ownership radius, as shown in the following code snippet:<p class="source-code">UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "Ownership Test Actor")</p><p class="source-code">UStaticMeshComponent* Mesh;</p><p class="source-code">UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "Ownership Test Actor")</p><p class="source-code">float OwnershipRadius = 400.0f;</p></li>
</ol>
<p>In the preceding code snippet, we declared the static mesh component and the <strong class="source-inline">OwnershipRadius</strong> variable, which allows you to configure the radius of the ownership.</p>
<ol>
<li value="8">Next, delete the declaration of <strong class="source-inline">BeginPlay</strong> and move the constructor and the <strong class="source-inline">Tick</strong> function declarations to the protected area.</li>
<li>Now, open the <strong class="source-inline">OwnershipTestActor.cpp</strong> file and add the required header files, as shown in the following code snippet:<p class="source-code">#include "OwnershipRoles.h"</p><p class="source-code">#include "OwnershipRolesCharacter.h"</p><p class="source-code">#include "Kismet/GameplayStatics.h"</p></li>
</ol>
<p>In the preceding code snippet, we included <strong class="source-inline">OwnershipRoles.h</strong>, <strong class="source-inline">OwnershipRolesCharacter.h</strong>, and <strong class="source-inline">GameplayStatics.h</strong> because we’ll be calling the <strong class="source-inline">GetAllActorsOfClass</strong> function.</p>
<ol>
<li value="10">In the constructor definition, create the static mesh component and set it as the root component:<p class="source-code">Mesh = CreateDefaultSubobject&lt;UStaticMeshComponent&gt;("Mesh");</p><p class="source-code">RootComponent = Mesh;</p></li>
<li>Still in the constructor, set <strong class="source-inline">bReplicates</strong> to <strong class="source-inline">true</strong> to tell Unreal Engine that this actor replicates and should also exist in all of the clients:<p class="source-code">bReplicates = true;</p></li>
<li>Delete the <strong class="source-inline">BeginPlay</strong> function definition.</li>
<li>In the <strong class="source-inline">Tick</strong> function, draw a <a id="_idIndexMarker1410"/>debug sphere to help visualize the ownership radius, as shown in the following code snippet:<p class="source-code">DrawDebugSphere(GetWorld(), GetActorLocation(), OwnershipRadius, 32, FColor::Yellow);</p></li>
<li>Still in the <strong class="source-inline">Tick</strong> function, create the authority-specific logic that will get the closest <strong class="source-inline">AOwnershipRolesCharacter</strong> within the ownership radius. If it’s different from the current one, set it as the owner:<p class="source-code">if (HasAuthority())</p><p class="source-code">{</p><p class="source-code">  AActor* NextOwner = nullptr;</p><p class="source-code">  float MinDistance = OwnershipRadius;</p><p class="source-code">  TArray&lt;AActor*&gt; Actors;</p><p class="source-code">  UGameplayStatics::GetAllActorsOfClass(this,</p><p class="source-code">    AOwnershipRolesCharacter::StaticClass(), Actors);</p><p class="source-code">  for (AActor* Actor : Actors)</p><p class="source-code">  {</p><p class="source-code">    const float Distance = GetDistanceTo(Actor);</p><p class="source-code">    if (Distance &lt;= MinDistance)</p><p class="source-code">    {</p><p class="source-code">      MinDistance = Distance;</p><p class="source-code">      NextOwner = Actor;</p><p class="source-code">    }</p><p class="source-code">  }</p><p class="source-code">  if (GetOwner() != NextOwner)</p><p class="source-code">  {</p><p class="source-code">    SetOwner(NextOwner);</p><p class="source-code">  }</p><p class="source-code">}</p></li>
</ol>
<p class="callout-heading">Note</p>
<p class="callout">The preceding code is for demonstration purposes only, because running <strong class="source-inline">GetAllActorsOfClass</strong> on the <strong class="source-inline">Tick</strong> function every frame will take a big toll on performance. Ideally, you should execute this code only once (on <strong class="source-inline">BeginPlay</strong>, for example) and store the values so that we can query them in <strong class="source-inline">Tick</strong>.</p>
<ol>
<li value="15">Still in the <strong class="source-inline">Tick</strong> function, convert<a id="_idIndexMarker1411"/> the values for the local/remote roles (using the <strong class="source-inline">ROLE_TO_STRING</strong> macro we created earlier), the current owner, and the connection into strings:<p class="source-code">const FString LocalRoleString = ROLE_TO_STRING(GetLocalRole());</p><p class="source-code">const FString RemoteRoleString = ROLE_TO_STRING(GetRemoteRole());</p><p class="source-code">const FString OwnerString = GetOwner() != nullptr ? GetOwner()-&gt;GetName() : TEXT("No Owner");</p><p class="source-code">const FString ConnectionString = GetNetConnection() != nullptr ? TEXT("Valid Connection") : TEXT("Invalid Connection");</p></li>
<li>To finalize the <strong class="source-inline">Tick</strong> function, use <strong class="source-inline">DrawDebugString</strong> to print<a id="_idIndexMarker1412"/> the strings we converted in the previous step on the screen:<p class="source-code">const Fstring Values = Fstring::Printf(TEXT("LocalRole = %s\nRemoteRole = %s\nOwner = %s\nConnection = %s"), </p><p class="source-code">  *LocalRoleString, *RemoteRoleString, *OwnerString, </p><p class="source-code">  *ConnectionString);</p><p class="source-code">DrawDebugString(GetWorld(), GetActorLocation(), Values, nullptr, Fcolor::White, 0.0f, true);</p></li>
</ol>
<p class="callout-heading">Note</p>
<p class="callout">Instead of constantly using <strong class="source-inline">GetLocalRole() == ROLE_Authority</strong> to check whether the actor has authority, you can use the <strong class="source-inline">HasAuthority()</strong> helper function, defined in <strong class="source-inline">AActor</strong>.</p>
<ol>
<li value="17">Next, open <strong class="source-inline">OwnershipRolesCharacter.h</strong> and declare the <strong class="source-inline">Tick</strong> function as protected:<p class="source-code">virtual void Tick(float DeltaTime) override;</p></li>
<li>Now, open <strong class="source-inline">OwnershipRolesCharacter.cpp</strong> and include <strong class="source-inline">OwnershipRoles.h</strong>, as shown in the following code snippet:<p class="source-code">#include "OwnershipRoles.h"</p></li>
<li>Implement the <strong class="source-inline">Tick</strong> function:<p class="source-code">void AOwnershipRolesCharacter::Tick(float DeltaTime)</p><p class="source-code">{</p><p class="source-code">  Super::Tick(DeltaTime);</p><p class="source-code">}</p></li>
<li>Inside of the Tick function, convert the values<a id="_idIndexMarker1413"/> for the local/remote roles (using the <strong class="source-inline">ROLE_TO_STRING</strong> macro we created earlier), the current owner, and the connection into strings:<p class="source-code">const FString LocalRoleString = ROLE_TO_STRING(GetLocalRole());</p><p class="source-code">const FString RemoteRoleString = ROLE_TO_STRING(GetRemoteRole());</p><p class="source-code">const FString OwnerString = GetOwner() != nullptr ? GetOwner()- &gt;GetName() : TEXT("No Owner");</p><p class="source-code">const FString ConnectionString = GetNetConnection() != nullptr ? </p><p class="source-code">  TEXT("Valid Connection") : TEXT("Invalid </p><p class="source-code">  Connection");</p></li>
<li>Use <strong class="source-inline">DrawDebugString</strong> to print the strings we converted in the previous step on the screen:<p class="source-code">const FString Values = FString::Printf(TEXT("LocalRole = </p><p class="source-code">  %s\nRemoteRole = %s\nOwner = %s\nConnection = %s"), </p><p class="source-code">  *LocalRoleString, *RemoteRoleString, *OwnerString, </p><p class="source-code">  *ConnectionString);</p><p class="source-code">DrawDebugString(GetWorld(), GetActorLocation(), Values, nullptr, FColor::White, 0.0f, true);</p></li>
</ol>
<p>Finally, we can test the project.</p>
<ol>
<li value="22">Run the code and wait for the editor to fully load.</li>
<li>Create a new Blueprint called <strong class="source-inline">OwnershipTestActor_BP</strong> in the <strong class="source-inline">Content</strong> folder that derives <a id="_idIndexMarker1414"/>from <strong class="source-inline">OwnershipTestActor</strong>. Set <strong class="source-inline">Mesh</strong> to use a cube mesh, and drop an instance of it in the world.</li>
<li>Go to <strong class="source-inline">Multiplayer Options</strong>, set <strong class="bold">Net Mode</strong> to <strong class="bold">Play As Listen Server</strong>, and set <strong class="bold">Number of Players</strong> to <strong class="source-inline">2</strong>.</li>
<li>Set the window size to <strong class="source-inline">800x600</strong>.</li>
<li>Play using <strong class="bold">New Editor Window (PIE)</strong>.</li>
</ol>
<p>You should get the following output:</p>
<div>
<div class="IMG---Figure" id="_idContainer509">
<img alt="Figure 16.8 – Expected result on the Server and Client 1 windows " height="473" src="image/Figure_16..08_B18531.jpg" width="1194"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.8 – Expected result on the Server and Client 1 windows</p>
<p>By completing this exercise, you’ll have a better understanding of how connections and ownership work. These are important concepts to know as everything related to replication is dependent on them.</p>
<p>The next time you see that an actor is not doing replication operations, you’ll know that you need to check whether it has a valid connection and an owner.</p>
<p>Now, let’s analyze the values that are displayed in the server and client windows.</p>
<p class="callout-heading">Note</p>
<p class="callout">The two figures for the server and client window will have three text blocks that say <strong class="source-inline">Server Character</strong>, <strong class="source-inline">Client 1 Character</strong>, and <strong class="source-inline">Ownership Test Actor</strong>, but that was added to the original screenshot to help you understand<a id="_idTextAnchor362"/> which character and actor are which.</p>
<h2 id="_idParaDest-334"><a id="_idTextAnchor363"/>Output for the Server window</h2>
<p>Have a look at the <a id="_idIndexMarker1415"/>following output screenshot of the <strong class="bold">Server</strong> window from the previous exercise:</p>
<div>
<div class="IMG---Figure" id="_idContainer510">
<img alt="Figure 16.9 – The Server window " height="640" src="image/Figure_16..09_B18531.jpg" width="806"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.9 – The Server window</p>
<p>In the preceding screenshot, you can see <strong class="bold">Server Character</strong>, <strong class="bold">Client 1 Character</strong>, and the <strong class="bold">Ownership Test</strong> cube actor.</p>
<p>First, let’s ana<a id="_idTextAnchor364"/>lyze the values for <strong class="bold">Server Character</strong>.</p>
<h2 id="_idParaDest-335"><a id="_idTextAnchor365"/>Server Character</h2>
<p>This is the character<a id="_idIndexMarker1416"/> that the listen server is controlling. The values associated with this character are as follows:</p>
<ul>
<li><strong class="source-inline">LocalRole = ROLE_Authority</strong>: This character was spawned on the server, which is the current game instance.</li>
<li><strong class="source-inline">RemoteRole = ROLE_SimulatedProxy</strong>: Because this character was spawned on the server, the other clients should only simulate it.</li>
<li><strong class="source-inline">Owner = PlayerController_0</strong>: This character is being controlled by the client of the listen server, which uses the first <strong class="source-inline">PlayerController</strong> instance called <strong class="source-inline">PlayerController_0</strong>.</li>
<li><strong class="source-inline">Connection = Invalid Connection</strong>: Because we’re the client of the listen server, there is <a id="_idIndexMarker1417"/>no need for a connection.</li>
</ul>
<p>Next, we are going to look at<a id="_idTextAnchor366"/> <strong class="bold">Client 1 Character</strong> in the same window.</p>
<h2 id="_idParaDest-336"><a id="_idTextAnchor367"/>Client 1 Character</h2>
<p>This is the <a id="_idIndexMarker1418"/>character that <strong class="bold">Client 1</strong> is controlling. The values associated with this character are as follows:</p>
<ul>
<li><strong class="source-inline">LocalRole = ROLE_Authority</strong>: This character was spawned on the server, which is the current game instance.</li>
<li><strong class="source-inline">RemoteRole = ROLE_AutonomousProxy</strong>: Because this character was spawned on the server, but it’s being controlled by another client.</li>
<li><strong class="source-inline">Owner = PlayerController_1</strong>: This character is being controlled by another client, which uses the second <strong class="source-inline">PlayerController</strong> instance called <strong class="source-inline">PlayerController_1</strong>.</li>
<li><strong class="source-inline">Connection = Valid Connection</strong>: Because this character is being controlled by another client, so a connection to the server is required.</li>
</ul>
<p>Next, we are going to look at the<a id="_idTextAnchor368"/> <strong class="bold">OwnershipTest</strong> actor in the same window.</p>
<h2 id="_idParaDest-337"><a id="_idTextAnchor369"/>The OwnershipTest actor</h2>
<p>This is the cube actor that will set its <a id="_idIndexMarker1419"/>owner to the closest character within a certain ownership radius. The values associated with this actor are as follows:</p>
<ul>
<li><strong class="source-inline">LocalRole = ROLE_Authority</strong>: This actor was placed in the level and spawned on the server, which is the current game instance.</li>
<li><strong class="source-inline">RemoteRole = ROLE_SimulatedProxy</strong>: This actor was spawned in the server, but it’s not being controlled by any client.</li>
<li><strong class="source-inline">Owner</strong> and <strong class="source-inline">Connection</strong>: They will have their values based on the closest character. If there isn’t a character inside the ownership radius, then they will have the values of <strong class="source-inline">No Owner</strong> and <strong class="source-inline">Invalid Connection</strong>, respectively.</li>
</ul>
<p>Now, let’s analyze the values t<a id="_idTextAnchor370"/>hat are displayed in the <strong class="source-inline">Client 1</strong> window.</p>
<h2 id="_idParaDest-338"><a id="_idTextAnchor371"/>Output for the Client 1 window</h2>
<p>Have a look at the following <a id="_idIndexMarker1420"/>output screenshot of the <strong class="source-inline">Client 1</strong> window from the previous exercise:</p>
<div>
<div class="IMG---Figure" id="_idContainer511">
<img alt="Figure 16.10 – The Client 1 window " height="640" src="image/Figure_16..10_B18531.jpg" width="806"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.10 – The Client 1 window</p>
<p>The values for the <strong class="source-inline">Client 1</strong> window will be the same as those for the <strong class="source-inline">Server</strong> window, except the values of <strong class="source-inline">LocalRole</strong> and <strong class="source-inline">RemoteRole</strong> will be reversed because they are always relative to the game instance that you are in.</p>
<p>Another exception is <a id="_idIndexMarker1421"/>that the server character has no owner and the other connected clients won’t have a valid connection. The reason for that is that clients don’t store player controllers and connections of other clients, only the server does, but this will be covered in more depth in <a href="B18531_18.xhtml#_idTextAnchor404"><em class="italic">Chapter 18</em></a>, <em class="italic">Using Gameplay Framework Classes in Multiplayer</em>.</p>
<p>In this section, we’ve covered how roles are used to know which version of the actor the code is executing, which we can leverage to run specific code. In the next section, we will look at variable replication, which is one of the techniques that’s used by the server to keep the clients synchronized.</p>
<h1 id="_idParaDest-339"><a id="_idTextAnchor372"/>Understanding variable replication</h1>
<p>One of the ways the server<a id="_idIndexMarker1422"/> can keep the clients synchronized is by using variable replication. The way it works is that every specific number of times per second (defined per actor in the <strong class="source-inline">AActor::NetUpdateFrequency</strong> variable, which is also exposed to blueprints) the variable replication system in the server will check whether there are any replicated variables (explained in the next section) in the client that need to be updated with the latest value.</p>
<p>If the variable meets all of<a id="_idIndexMarker1423"/> the replication conditions, then the server will send an update to the client and enforce the new value.</p>
<p>For example, if you have a replicated <strong class="source-inline">Health</strong> variable and the client on its end uses a hacking tool to set the value of the variable from <strong class="source-inline">10</strong> to <strong class="source-inline">100</strong>, then the replication system will enforce the real value from the server and change it back to <strong class="source-inline">10</strong>, which nullifies the hack.</p>
<p>Variables are only sent to the client to be updated in the following situations: </p>
<ul>
<li>The variable is set to replicate.</li>
<li>The value was changed on the server.</li>
<li>The value on the client is different on the server.</li>
<li>The actor has replication enabled.</li>
<li>The actor is relevant and meets all of the replication conditions.</li>
</ul>
<p>One important thing to take into consideration is that the logic that determines whether a variable should be replicated or not is only executed <strong class="source-inline">Actor::NetUpdateFrequency</strong> times a second. In other words, the server doesn’t send an update request to a client immediately after you change the value of a variable on the server.</p>
<p>An example of this would be if you had an integer replicated variable called <strong class="source-inline">Test</strong> that has a default value of <strong class="source-inline">5</strong>. If you call a function on the server that sets <strong class="source-inline">Test</strong> to <strong class="source-inline">3</strong> and in the next line changes it to <strong class="source-inline">8</strong>, then only the latter change would send an update request to the clients. The reason for this is these two changes were made in-between the <strong class="source-inline">NetUpdateFrequency</strong> interval, so when the variable replication system executes, the current value is <strong class="source-inline">8</strong>, and because that is different from the value stored on the clients (which is still <strong class="source-inline">5</strong>), it will update them. If instead of setting it to <strong class="source-inline">8</strong>, you set it back to <strong class="source-inline">5</strong>, then no changes would be sent to the clients because the values haven’t changed.</p>
<p>In the following sections, we are going to cover how to replicate variables by using the <strong class="source-inline">Replicated</strong> and <strong class="source-inline">ReplicatedUsing</strong> specifiers, as well as the <strong class="source-inline">DOREPLIFETIME</strong> and <strong class="source-inline">DOREPLIFETIME_CONDITION</strong> macros.</p>
<h2 id="_idParaDest-340"><a id="_idTextAnchor373"/>Replicated variables</h2>
<p>In Unreal Engine, almost any variable type that <a id="_idIndexMarker1424"/>can use the <strong class="source-inline">UPROPERTY</strong> macro can be set to replicate, and you can use two specifiers to do that. We will look at them in the following sections.</p>
<h3>Replicated</h3>
<p>If you just want to say that a <a id="_idIndexMarker1425"/>variable is replicated, then you can use the <strong class="source-inline">Replicated</strong> specifier. </p>
<p>Have a look at the following example:</p>
<pre class="source-code">
UPROPERTY(Replicated) 
float Health = 100.0f; </pre>
<p>In the preceding code snippet, we declared a float variable called <strong class="source-inline">Health</strong>, as we normally do. The difference is that we added <strong class="source-inline">UPROPERTY(Replicated)</strong> to let Unreal Engine know that the <strong class="source-inline">Health</strong> variable will be replicated.</p>
<h3>ReplicatedUsing</h3>
<p>If you want to say that<a id="_idIndexMarker1426"/> a variable is replicated and should call a function every time it’s updated, then you can use the <strong class="source-inline">ReplicatedUsing=&lt;Function Name&gt;</strong> specifier. Have a look at the following example:</p>
<pre class="source-code">
UPROPERTY(ReplicatedUsing=OnRep_Health) 
float Health = 100.0f;
UFUNCTION() 
void OnRep_Health()
{
  UpdateHUD(); 
}</pre>
<p>In the preceding code snippet, we declared a float variable called <strong class="source-inline">Health</strong>. The difference is that we added <strong class="source-inline">UPROPERTY(ReplicatedUsing=OnRep_Health)</strong> to let Unreal Engine know that this variable will be replicated and should call the <strong class="source-inline">OnRep_Health</strong><a id="_idIndexMarker1427"/> function every time it’s updated, which, in this specific case, calls a function to update the HUD.</p>
<p>Typically, the naming scheme for the callback function is <strong class="source-inline">OnRep_&lt;Variable Name&gt;</strong>. </p>
<p class="callout-heading">Note</p>
<p class="callout">The function that’s used in the <strong class="source-inline">ReplicatedUsing</strong> specifier needs to be marked as <strong class="source-inline">UFUNCTION()</strong>.</p>
<h3>GetLifetimeReplicatedProps</h3>
<p>Besides marking the variable as replicated, you’ll also need to implement the <strong class="source-inline">GetLifetimeReplicatedProps</strong> function in the actor’s <strong class="source-inline">cpp</strong> file. One thing to take into consideration is <a id="_idIndexMarker1428"/>that this function is automatically declared internally once you have at least one replicated variable, so you shouldn’t declare it in the actor’s header file. The purpose of this function is for you to tell how each replicated variable should replicate. You can do this by using the <strong class="source-inline">DOREPLIFETIME</strong> macro and its variants on every variable that you want to replicate.</p>
<h3>DOREPLIFETIME</h3>
<p>This macro specifies<a id="_idIndexMarker1429"/> that the replicated variable in a class (entered as arguments) will replicate to all the clients, without an extra condition.</p>
<p>Here’s its syntax:</p>
<pre class="source-code">
DOREPLIFETIME(&lt;Class Name&gt;, &lt;Replicated Variable Name&gt;); </pre>
<p>Have a look at the following example:</p>
<pre class="source-code">
void AVariableReplicationActor::GetLifetimeReplicatedProps(TArray&lt; 
  FLifetimeProperty &gt;&amp; OutLifetimeProps) const
{
  Super::GetLifetimeReplicatedProps(OutLifetimeProps);
  DOREPLIFETIME(AVariableReplicationActor, Health);
}</pre>
<p>In the preceding code snippet, we<a id="_idIndexMarker1430"/> used the <strong class="source-inline">DOREPLIFETIME</strong> macro to tell the replication system that the <strong class="source-inline">Health</strong> variable in the <strong class="source-inline">AVariableReplicationActor</strong> class will replicate without an extra condition.</p>
<h3>DOREPLIFETIME_CONDITION</h3>
<p>This macro specifies that the replicated<a id="_idIndexMarker1431"/> variable in a class (entered as arguments) will replicate only to the clients that meet the condition (entered as an argument).</p>
<p>Here’s the syntax:</p>
<pre class="source-code">
DOREPLIFETIME_CONDITION(&lt;Class Name&gt;, &lt;Replicated Variable Name&gt;, &lt;Condition&gt;); </pre>
<p>The condition parameter can be one of the following values: </p>
<ul>
<li><strong class="source-inline">COND_InitialOnly</strong>: The variable will only replicate once, with the initial replication.</li>
<li><strong class="source-inline">COND_OwnerOnly</strong>: The variable will only replicate to the owner of the actor.</li>
<li><strong class="source-inline">COND_SkipOwner</strong>: The variable won’t replicate to the owner of the actor.</li>
<li><strong class="source-inline">COND_SimulatedOnly</strong>: The variable will only replicate to actors that are simulating.</li>
<li><strong class="source-inline">COND_AutonomousOnly</strong>: The variable will only replicate to autonomous actors.</li>
<li><strong class="source-inline">COND_SimulatedOrPhysics</strong>: The variable will only replicate to actors that are simulating or to actors with <strong class="source-inline">bRepPhysics</strong> set to true.</li>
<li><strong class="source-inline">COND_InitialOrOwner</strong>: The variable will only replicate once, with the initial replication or to the owner of the actor.</li>
<li><strong class="source-inline">COND_Custom</strong>: The variable will only replicate if its <strong class="source-inline">SetCustomIsActiveOverride</strong> Boolean condition (used in the <strong class="source-inline">AActor::PreReplication</strong> function) is true.</li>
</ul>
<p>Have a look at the<a id="_idIndexMarker1432"/> following example:</p>
<pre class="source-code">
void AVariableReplicationActor::GetLifetimeReplicatedProps(TArray&lt; 
  FLifetimeProperty &gt;&amp; OutLifetimeProps) const
{
  Super::GetLifetimeReplicatedProps(OutLifetimeProps);
  DOREPLIFETIME_CONDITION(AVariableReplicationActor, 
  Health, COND_OwnerOnly);
}</pre>
<p>In the preceding code snippet, we used the <strong class="source-inline">DOREPLIFETIME_CONDITION</strong> macro to tell the replication system that the <strong class="source-inline">Health</strong> variable in the <strong class="source-inline">AVariableReplicationActor</strong> class will replicate only for the owner of this actor.</p>
<p class="callout-heading">Note</p>
<p class="callout">There are more <strong class="source-inline">DOREPLIFETIME</strong> macros available, but they won’t be covered in this book. To see all of the variants, please check the <strong class="source-inline">UnrealNetwork.h</strong> file from the UE5 source code at <a href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Engine/Public/Net/UnrealNetwork.h">https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Engine/Public/Net/UnrealNetwork.h</a>.</p>
<p>Now that you have an<a id="_idIndexMarker1433"/> idea of how variable replication works, let’s complete an exercise that uses the <strong class="source-inline">Replicated</strong> and <strong class="source-inline">ReplicatedUsing</strong> specifiers, as well as the <strong class="source-inline">DOREPLIFETIME</strong> and <strong class="source-inline">DOREPLIFETIME_CONDITION</strong> macros.</p>
<h2 id="_idParaDest-341"><a id="_idTextAnchor374"/>Exercise 16.03 – Replicating variables using Replicated, ReplicatedUsing, DOREPLIFETIME, and DOREPLIFETIME_CONDITION </h2>
<p>In this exercise, we’re going to create a <strong class="bold">C++</strong> project that uses the <strong class="bold">Third Person</strong> template as a base and add two variables to the character that replicate in the following way:</p>
<ul>
<li>Variable <strong class="source-inline">A</strong> is a float that will <a id="_idIndexMarker1434"/>use the <strong class="source-inline">Replicated</strong> specifier and the <strong class="source-inline">DOREPLIFETIME</strong> macro.</li>
<li>Variable <strong class="source-inline">B</strong> is an integer that<a id="_idIndexMarker1435"/> will use the <strong class="source-inline">ReplicatedUsing</strong> specifier <a id="_idIndexMarker1436"/>and the <strong class="source-inline">DOREPLIFETIME_CONDITION</strong> macro.</li>
<li>The Tick function of the character should increment A and B by 1 every frame, if it has authority, and call <strong class="source-inline">DrawDebugString</strong> to display theirs values on the location of the character.</li>
</ul>
<p>Follow these steps to complete <a id="_idIndexMarker1437"/>this exercise:</p>
<ol>
<li value="1">Create a new <strong class="bold">Third Person</strong> template project using <strong class="bold">C++</strong> called <strong class="source-inline">VariableReplication</strong> and save it to a location of your choosing. </li>
<li>Once the project has been created, it should open the editor as well as the Visual Studio solution.</li>
<li>Close the editor and go back to Visual Studio.</li>
<li>Open the <strong class="source-inline">VariableReplicationCharacter.h</strong> file and declare the protected <strong class="source-inline">A</strong> and <strong class="source-inline">B</strong> variables as <strong class="source-inline">UPROPERTY</strong> using their respective replication specifiers: <p class="source-code">UPROPERTY(Replicated) </p><p class="source-code">float A = 100.0f; </p><p class="source-code">UPROPERTY(ReplicatedUsing = OnRepNotify_B) </p><p class="source-code">int32 B; </p></li>
<li>Declare the <strong class="source-inline">Tick</strong> function as protected: <p class="source-code">virtual void Tick(float DeltaTime) override;</p></li>
<li>Since we’ve declared the <strong class="source-inline">B</strong> variable as <strong class="source-inline">ReplicatedUsing = OnRepNotify_B</strong>, we also need to <a id="_idIndexMarker1438"/>declare the protected <strong class="source-inline">OnRepNotify_B</strong> callback function as <strong class="source-inline">UFUNCTION</strong>: <p class="source-code">UFUNCTION() </p><p class="source-code">void OnRepNotify_B(); </p></li>
<li>Now, open the <strong class="source-inline">VariableReplicationCharacter.cpp</strong> file and include the <strong class="source-inline">UnrealNetwork.h</strong> header<a id="_idIndexMarker1439"/> file, which<a id="_idIndexMarker1440"/> contains the definition of the <strong class="source-inline">DOREPLIFETIME</strong> macros that <a id="_idIndexMarker1441"/>we’re going to use:<p class="source-code">#include "Net/UnrealNetwork.h"</p></li>
<li>Implement the <strong class="source-inline">GetLifetimeReplicatedProps</strong> function:<p class="source-code">void AVariableReplicationCharacter::GetLifetimeReplicatedProps (TArray&lt;FLifetimeProperty &gt;&amp; OutLifetimeProps) const</p><p class="source-code">{</p><p class="source-code">  Super::GetLifetimeReplicatedProps(OutLifetimeProps);</p><p class="source-code">}</p></li>
<li>Let the replication system know that the <strong class="source-inline">A</strong> variable won’t have any extra replication conditions:<p class="source-code">DOREPLIFETIME(AVariableReplicationCharacter, A);</p></li>
<li>Let the replication system <a id="_idIndexMarker1442"/>know that the <strong class="source-inline">B</strong> variable <a id="_idIndexMarker1443"/>will only replicate to the owner of this actor:<p class="source-code">DOREPLIFETIME_CONDITION(AVariableReplicationCharacter, B, COND_OwnerOnly);</p></li>
<li>Implement the <strong class="source-inline">Tick</strong> function:<p class="source-code">void AVariableReplicationCharacter::Tick(float DeltaTime) </p><p class="source-code">{</p><p class="source-code">  Super::Tick(DeltaTime);</p><p class="source-code">}</p></li>
<li>Next, run the <a id="_idIndexMarker1444"/>authority-specific logic that adds <strong class="source-inline">1</strong> to <strong class="source-inline">A</strong> and <strong class="source-inline">B</strong>:<p class="source-code">if (HasAuthority()) </p><p class="source-code">{ </p><p class="source-code">  A++; </p><p class="source-code">  B++; </p><p class="source-code">} </p></li>
</ol>
<p>Since this character will be <a id="_idIndexMarker1445"/>spawned on the server, only the server will execute this logic.</p>
<ol>
<li value="13">Display the values of <strong class="source-inline">A</strong> and <strong class="source-inline">B</strong> on the location of the character:<p class="source-code">const FString Values = FString::Printf(TEXT("A = %.2f    B = %d"), A, B); </p><p class="source-code">DrawDebugString(GetWorld(), GetActorLocation(), Values, nullptr, FColor::White, 0.0f, true);</p></li>
<li>Implement the <strong class="source-inline">RepNotify</strong> function for the <strong class="source-inline">B</strong> variable, which displays a message on the screen saying<a id="_idIndexMarker1446"/> that the <strong class="source-inline">B</strong> variable was changed to a new value: <p class="source-code">void AVariableReplicationCharacter::OnRepNotify_B() </p><p class="source-code">{</p><p class="source-code">  const FString String = FString::Printf(TEXT("B was </p><p class="source-code">  changed by the server and is now %d!"), B); </p><p class="source-code">  GEngine-&gt;AddOnScreenDebugMessage(-1, 0.0f, </p><p class="source-code">  FColor::Red,String); </p><p class="source-code">}</p></li>
</ol>
<p>Finally, you can test the<a id="_idIndexMarker1447"/> project.</p>
<ol>
<li value="15">Run the code and wait for <a id="_idIndexMarker1448"/>the editor to fully load.</li>
<li>Go to <strong class="source-inline">Multiplayer Options</strong>, set <strong class="bold">Net Mode</strong> to <strong class="bold">Play As Listen Server</strong>, and set <strong class="bold">Number of Players</strong> to <strong class="source-inline">2</strong>.</li>
<li>Set the window size to <strong class="source-inline">800x600</strong>.</li>
<li>Play using <strong class="source-inline">New Editor Window (PIE)</strong>.</li>
</ol>
<p>By completing this exercise, you <a id="_idIndexMarker1449"/>will be able to play on each client and you’ll notice that the characters are displaying their respective values for <strong class="source-inline">A</strong> and <strong class="source-inline">B</strong>. </p>
<p>Now, let’s analyze the values that are displayed in the <strong class="source-inline">Server</strong> and <strong class="source-inline">Client 1</strong> windows.</p>
<p class="callout-heading">Note</p>
<p class="callout">The two figures for the server and client window will have two text blocks that say <strong class="source-inline">Server Character</strong> and <strong class="source-inline">Client 1 Character</strong>, but that was added to the original <a id="_idTextAnchor375"/>screenshot to help you understand which character is which.</p>
<h2 id="_idParaDest-342"><a id="_idTextAnchor376"/>Output for the Server window</h2>
<p>In the <strong class="bold">Server</strong> window, you have<a id="_idIndexMarker1450"/> the values for <strong class="bold">Server Character</strong>, which is the character controlled by the server<a id="_idTextAnchor377"/>, while in the background, you have the values for <strong class="bold">Client 1 Character</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer512">
<img alt="Figure 16.11 – The Server window " height="600" src="image/Figure_16..11_B18531.jpg" width="754"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.11 – The Server window</p>
<p>The outputs that can be observed are as follows:</p>
<ul>
<li><strong class="bold">Server Character</strong>: <strong class="source-inline">A = 651.00 B = 551</strong></li>
<li><strong class="bold">Client 1 Character</strong>: <strong class="source-inline">A = 592.00 B = 492</strong></li>
</ul>
<p>At this specific point in time, <strong class="bold">Server Character</strong> has a value of <strong class="source-inline">651</strong> for <strong class="source-inline">A</strong> and <strong class="source-inline">551</strong> for <strong class="source-inline">B</strong>. The reason why <strong class="source-inline">A</strong> and <strong class="source-inline">B</strong> have different values is that <strong class="source-inline">A</strong> starts at <strong class="source-inline">100</strong> and <strong class="source-inline">B</strong> starts at <strong class="source-inline">0</strong>, which is the correct value after <strong class="source-inline">551</strong> ticks of <strong class="source-inline">A++</strong> and <strong class="source-inline">B++</strong>. </p>
<p><strong class="bold">Client 1 Character</strong> doesn’t have<a id="_idIndexMarker1451"/> the same values as <strong class="bold">Server Character</strong> because <strong class="bold">Client 1</strong> was created slightly after the server, so in this case, the count was off<a id="_idTextAnchor378"/> by <strong class="source-inline">59</strong> ticks of <strong class="source-inline">A++</strong> and <strong class="source-inline">B++</strong>.</p>
<p>Next, we will look at the <strong class="bold">Client 1</strong> window.</p>
<h2 id="_idParaDest-343"><a id="_idTextAnchor379"/>Output for the Client 1 window</h2>
<p>In the <strong class="bold">Client 1</strong> window, you <a id="_idIndexMarker1452"/>have the values for <strong class="bold">Client 1 Character</strong>, which is the character controlled by <strong class="bold">Client 1</strong>, while in the background, you have the values for <strong class="bold">Server Character</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer513">
<img alt="Figure 16.12 – The Client 1 window " height="640" src="image/Figure_16..12_B18531.jpg" width="805"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.12 – The Client 1 window</p>
<p>The outputs that can be observed are as follows:</p>
<ul>
<li><strong class="bold">Server Character</strong>: <strong class="source-inline">A = 651.00 B = 0</strong></li>
<li><strong class="bold">Client 1 Character</strong>: <strong class="source-inline">A = 592.00 B = 492</strong></li>
</ul>
<p><strong class="bold">Client 1 Character</strong> has the correct values from the server, so the variable replication is working as intended. If you look at <strong class="bold">Server Character</strong>, <strong class="source-inline">A</strong> is <strong class="source-inline">651</strong>, which is correct, but <strong class="source-inline">B</strong> is <strong class="source-inline">0</strong>. The reason for this is that <strong class="source-inline">A</strong> is using <strong class="source-inline">DOREPLIFETIME</strong>, which doesn’t add any additional replication conditions, so it will replicate the variable and keep the client up to date every time the variable is changed on the server. </p>
<p>The <strong class="source-inline">B</strong> variable, on the other<a id="_idIndexMarker1453"/> hand, uses <strong class="source-inline">DOREPLIFETIME_CONDITION</strong> with <strong class="source-inline">COND_OwnerOnly</strong>, and since <strong class="bold">Client 1</strong> is not the client that owns <strong class="bold">Server Character</strong> (the client of the listen server does), then the value is not replicated and remains unchanged from the default value of <strong class="source-inline">0</strong>.</p>
<p>If you go back to the code and change the replication condition of <strong class="source-inline">B</strong> to use <strong class="source-inline">COND_SimulatedOnly</strong> instead of <strong class="source-inline">COND_OwnerOnly</strong>, you’ll notice that the results will be reversed in the <strong class="bold">Client 1</strong> window. The value of <strong class="source-inline">B</strong> will be replicated for <strong class="bold">Server Character</strong>, but it won’t replicate for its own character. </p>
<p class="callout-heading">Note</p>
<p class="callout">The reason why the <strong class="source-inline">RepNotify</strong> message is showing in the <strong class="bold">Server</strong> window instead of the <strong class="bold">Client</strong> window is that, when playing in the editor, both windows share the same process, so printing text on the screen won’t be accurate. To get the correct behavior, you’ll need to run the packaged version of the game.</p>
<h1 id="_idParaDest-344"><a id="_idTextAnchor380"/>Exploring 2D Blend Spaces</h1>
<p>In <a href="B18531_02.xhtml#_idTextAnchor043"><em class="italic">Chapter 2</em></a>, <em class="italic">Working with Unreal Engine</em>, we created a 1D Blend Space to blend between the movement <a id="_idIndexMarker1454"/>states (idle, walk, and run) of a character based on the value of the <strong class="source-inline">Speed</strong> axis. For that specific example, it worked pretty well because you only needed one axis, but if we wanted the character to also be able to strafe, then we couldn’t do that.</p>
<p>To contemplate that case, Unreal Engine allows you to create 2D Blend Spaces. The concept is almost the same; the only difference is that you have an extra axis for animations, so you can blend between them not only horizontally, but also vertically.</p>
<p>Let’s apply our knowledge of 1D Blend Spaces to the next exercise, where we will create a 2D Blend Space for the movement of a character that can also strafe.</p>
<h2 id="_idParaDest-345"><a id="_idTextAnchor381"/>Exercise 16.04 – Creating a movement 2D Blend Space</h2>
<p>In this exercise, we’re going to<a id="_idIndexMarker1455"/> create a Blend Space that uses two axes instead of one. The vertical axis will be <strong class="source-inline">Speed</strong>, which will be between <strong class="source-inline">0</strong> and <strong class="source-inline">200</strong>. The horizontal axis will be <strong class="source-inline">Direction</strong>, which represents the relative angle (<strong class="source-inline">-180 to 180</strong>) between the velocity and the rotation/forward vector of the pawn. </p>
<p>The following diagram will help you calculate the direction in this exercise:</p>
<div>
<div class="IMG---Figure" id="_idContainer514">
<img alt="Figure 16.13 – Direction values based on the angle between the forward vector and the velocity " height="611" src="image/Figure_16..13_B18531.jpg" width="485"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.13 – Direction values based on the angle between the forward vector and the velocity</p>
<p>The preceding diagram shows how the direction will be calculated. The forward vector represents the direction that the character is currently facing, while the numbers represent the angle that the<a id="_idIndexMarker1456"/> forward vector would make with the velocity vector if it was pointing in that direction. If the character was looking in a certain direction and you pressed a key to move the character to the right, then the velocity vector would be perpendicular to the forward vector. This would mean that the angle would be 90º, so that would be our direction.</p>
<p>If we set up our 2D Blend Space with that logic in mind, we can use the correct animation based on the character’s movement angle.</p>
<p>Follow these steps to complete this exercise:</p>
<ol>
<li value="1">Create a new <strong class="bold">Third Person</strong> template project using <strong class="bold">Blueprints</strong> called <strong class="source-inline">Blendspace2D</strong> and save it to a location of your choosing. </li>
<li>Once the project has been created, it should open the editor.</li>
<li>Next, you will be importing the movement animations. In the editor, go to the <strong class="bold">Content\Characters\Mannequins\Animations</strong> folder.</li>
<li>Click on the <strong class="bold">Import</strong> button.</li>
<li>Go to the <strong class="bold">Chapter16\Exercise16.04\Assets</strong> folder, select all of the .<strong class="source-inline">fbx</strong> files, and hit the <strong class="bold">Open</strong> button.</li>
<li>In the import dialog, make <a id="_idIndexMarker1457"/>sure you pick the <strong class="source-inline">SK_Mannequin</strong> skeleton and hit the <strong class="bold">Import All</strong> button.</li>
<li>Save all of the new files in the <strong class="source-inline">Assets</strong> folder.</li>
</ol>
<p>If you open any of the new animations, you will notice that the mesh is quite stretched on the <em class="italic">Z</em>-axis. So, let’s fix that by adjusting the skeleton retargeting settings.</p>
<ol>
<li value="8">Go to <strong class="bold">Content/Characters/Mannequins/Meshes/SK_Mannequin</strong>. On the left, you should see the list of bones.</li>
<li>Click on the cog icon to the right of the search box on the top and enable <strong class="bold">Show Retargeting Options</strong>.</li>
<li><em class="italic">Right-click</em> on the <strong class="source-inline">root</strong> bone and pick <strong class="bold">Recursively Set Translation Retargeting Skeleton</strong>.</li>
<li>Finally, pick <strong class="bold">Animation</strong> from the drop-down for the <strong class="bold">root</strong> and <strong class="bold">pelvis</strong> bones.</li>
<li>Save and close <strong class="bold">SK_Mannequin</strong>.</li>
<li>Once that’s done, open the <strong class="bold">Content Browser</strong> area, click on the <strong class="bold">Add</strong> button, and pick <strong class="bold">Animation | Blend Space</strong>.</li>
<li>Next, select the <strong class="bold">SK_Mannequin</strong> skeleton.</li>
<li>Rename the Blend Space <strong class="bold">BS_Movement</strong> and open it.</li>
<li>Set the horizontal <strong class="bold">Direction</strong> axis to <strong class="source-inline">(-180 to 180)</strong> and the vertical <strong class="bold">Speed</strong> axis to <strong class="source-inline">(0 to 200)</strong>, and make <a id="_idIndexMarker1458"/>sure that you turn on <strong class="source-inline">Snap to Grid</strong> on both. You should end up with the following settings:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer515">
<img alt="Figure 16.14 – 2D Blend Space – Axis Settings " height="616" src="image/Figure_16..14_B18531.jpg" width="359"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.14 – 2D Blend Space – Axis Settings</p>
<ol>
<li value="17">Drag the <strong class="bold">Idle_Rifle_Ironsights</strong> animation where <strong class="bold">Speed</strong> is <strong class="source-inline">0</strong> and <strong class="bold">Direction</strong> is <strong class="source-inline">-180</strong>, <strong class="source-inline">0</strong>, and <strong class="source-inline">180</strong>.</li>
<li>Drag the <strong class="bold">Walk_Fwd_Rifle_Ironsights</strong> animation where <strong class="bold">Speed</strong> is <strong class="source-inline">200</strong> and <strong class="bold">Direction</strong> is <strong class="source-inline">0</strong>.</li>
<li>Drag the <strong class="bold">Walk_Lt_Rifle_Ironsights</strong> animation where <strong class="bold">Speed</strong> is <strong class="source-inline">200</strong> and <strong class="bold">Direction</strong> is <strong class="source-inline">-90</strong>.</li>
<li>Drag the <strong class="bold">Walk_Rt_Rifle_Ironsights</strong> animation where <strong class="bold">Speed</strong> is <strong class="source-inline">200</strong> and <strong class="bold">Direction</strong> is <strong class="source-inline">90</strong>.</li>
<li>Drag the <strong class="bold">Walk_Bwd_Rifle_Ironsights</strong> animation where <strong class="bold">Speed</strong> is <strong class="source-inline">200</strong> and <strong class="bold">Direction</strong> is -<strong class="source-inline">180</strong> and <strong class="source-inline">180</strong>.</li>
</ol>
<p>You should end up with a <a id="_idIndexMarker1459"/>Blend Space that can be previewed by holding <em class="italic">Ctrl</em> and moving the mouse.</p>
<ol>
<li value="22">Now, on the <strong class="bold">Asset Details</strong> panel, set the <strong class="bold">Weight Speed</strong> variable to <strong class="source-inline">5</strong> to make the interpolation faster.</li>
<li>Save and close the Blend Space. </li>
<li>Now, let’s update the animation Blueprint so that it uses the new Blend Space.</li>
<li>Go to <strong class="bold">Content\Characters\Mannequins\Animations</strong> and open <strong class="bold">ABP_Manny</strong>.</li>
<li>Next, go to the event graph and create a new float variable called <strong class="source-inline">Direction</strong>.</li>
<li>Add a new pin to the sequence and set the value of <strong class="bold">Direction</strong> with the result of the <strong class="bold">Calculate Direction</strong> function, which calculates the angle (<strong class="source-inline">-180</strong> to 1<strong class="source-inline">80</strong>) between the character’s <strong class="bold">velocity</strong> and <strong class="bold">rotation</strong>:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer516">
<img alt="Figure 16.15 – Calculating the direction to use on the 2D Blend Space " height="373" src="image/Figure_16..15_B18531.jpg" width="933"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.15 – Calculating the direction to use on the 2D Blend Space</p>
<ol>
<li value="28">In <strong class="bold">AnimGraph</strong>, find the <strong class="bold">Control Rig</strong> node and set <strong class="bold">Alpha</strong> to<strong class="source-inline"> 0.0</strong> to disable the automatic feet adjustment.</li>
<li>Go to the <strong class="bold">Walk / Run</strong> state inside the <strong class="bold">Locomotion</strong> state machine where the old 1D Blend Space is being <a id="_idIndexMarker1460"/>used, as shown in the following screenshot:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer517">
<img alt="Figure 16.16 – The Walk / Run state in the AnimGraph " height="289" src="image/Figure_16..16_B18531.jpg" width="648"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.16 – The Walk / Run state in the AnimGraph</p>
<ol>
<li value="30">Replace that Blend Space with <strong class="bold">BS_Movement</strong> and use the <strong class="bold">Direction </strong>variable, like so:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer518">
<img alt="Figure 16.17 – The 1D Blend Space has been replaced with the new 2D Blend Space " height="278" src="image/Figure_16..17_B18531.jpg" width="628"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.17 – The 1D Blend Space has been replaced with the new 2D Blend Space</p>
<ol>
<li value="31">Go to the <strong class="source-inline">Idle</strong> state inside the <strong class="bold">Locomotion</strong> state machine and change the animation to use <strong class="bold">Idle_Rifle_Ironsights</strong> instead.</li>
<li>Save and close the <a id="_idIndexMarker1461"/>animation Blueprint. Now, you need to update the character.</li>
<li>Go to the <strong class="bold">Content\ThirdPerson\Blueprints</strong> folder and open <strong class="bold">BP_ThirdPersonCharacter</strong>.</li>
<li>On the <strong class="bold">Details</strong> panel for the character, set <strong class="bold">Use Controller Rotation Yaw</strong> to<strong class="bold"> true</strong>, which will make the character’s <strong class="source-inline">Yaw</strong> rotation always face the control rotation’s <strong class="source-inline">Yaw</strong>.</li>
<li>Go to the character movement component and set <strong class="bold">Max Walk Speed</strong> to <strong class="source-inline">200</strong>.</li>
<li>Set <strong class="bold">Orient Rotation to Movement</strong> to <strong class="source-inline">false</strong>, which will prevent the character from rotating toward the direction of the movement.</li>
<li>Select the <strong class="source-inline">Mesh</strong> component and on the <strong class="bold">Details</strong> panel, pick the <strong class="bold">ABP_Manny</strong> animation blueprint and the <strong class="bold">SKM_Manny_Simple</strong> skeletal mesh.</li>
<li>Save and close the character Blueprint.</li>
</ol>
<p>If you play the game now with two clients and move the character, it will walk forward and backward, but it will also strafe, as shown in the following screenshot:</p>
<div>
<div class="IMG---Figure" id="_idContainer519">
<img alt="Figure 16.18 – Expected output on the Server and Client 1 windows " height="422" src="image/Figure_16..18_B18531.jpg" width="1047"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.18 – Expected output on the Server and Client 1 windows</p>
<p>By completing this exercise, you <a id="_idIndexMarker1462"/>have improved your understanding of how to create 2D Blend Spaces, how they work, and the advantages they provide compared to just using a regular 1D Blend Space.</p>
<p>In the next section, we will learn how to transform a character’s bone so that we can rotate the torso of the player up and down based on the camera’s pitch.</p>
<h1 id="_idParaDest-346"><a id="_idTextAnchor382"/>Transforming (modifying) bones</h1>
<p>There is a very useful node that you <a id="_idIndexMarker1463"/>can use in <strong class="bold">AnimGraph</strong> called the <strong class="bold">Transform (Modify) Bone</strong> node, which allows you to translate, rotate, and scale a bone of a skeleton at runtime.</p>
<p>You can add it to <strong class="bold">AnimGraph</strong> by <em class="italic">right-clicking</em> on an empty space, typing <strong class="source-inline">transform modify</strong>, and picking the node from the list. If you click on the <strong class="bold">Transform (Modify) Bone</strong> node, you’ll have quite a few options on the <strong class="bold">Details</strong> panel. </p>
<p>Here’s an explanation of what the most relevant options do:</p>
<ul>
<li><strong class="bold">Bone to Modify</strong>: This option will tell the node what bone is going to be transformed.</li>
</ul>
<p>Slightly below that option, you have three sections representing each transform operation (<strong class="bold">Translation</strong>, <strong class="bold">Rotation</strong>, and <strong class="bold">Scale</strong>). In each section, you can do the following:</p>
<ul>
<li><strong class="bold">Translation</strong>, <strong class="bold">Rotation</strong>, <strong class="bold">Scale</strong>: This option will tell the node how much of that specific transform operation you want to apply. The final result will depend on the mode you have selected (covered in the next section).</li>
</ul>
<p>    There are four ways you can set this value:</p>
<ul>
<li>Setting a constant value such as (<strong class="source-inline">X=0.0,Y=0.0,Z=0.0</strong>).</li>
<li>Binding it to a function <a id="_idIndexMarker1464"/>or a variable, by clicking on the drop-down on the right-hand side and picking one of the functions or variables available from the list.</li>
<li>Using a dynamic value that can be set from a function, even if it’s not exposed as a pin.</li>
<li>Using a variable so that it can be changed at runtime. To enable this, you need to perform the following steps (this example is for <strong class="bold">Rotation</strong>, but the same concepts apply for <strong class="bold">Translation</strong> and <strong class="bold">Scale</strong>):<ol><li>Click the dropdown to the right of the constant value and make sure that you select <strong class="screen-inline">Expose As Pin</strong>. Once you do that, the text boxes for the constant value will disappear:</li></ol></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer520">
<img alt="Figure 16.19 – Selecting Expose As Pin " height="109" src="image/Figure_16..19_B18531.jpg" width="471"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.19 – Selecting Expose As Pin</p>
<ol>
<li value="2">The <strong class="bold">Transform (Modify) Bone </strong>node will add an input so that you can plug in your variable:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer521">
<img alt="Figure 16.20 – Variable used as an input on the Transform (Modify) Bone node " height="125" src="image/Figure_16..20_B18531.jpg" width="379"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.20 – Variable used as an input on the Transform (Modify) Bone node</p>
<ol>
<li value="3"><strong class="bold">Setting the mode</strong></li>
</ol>
<p>This will tell the node what to do<a id="_idIndexMarker1465"/> with the value. You can pick from one of these three options:</p>
<ul>
<li><strong class="bold">Ignore</strong>: Don’t do anything with the supplied value.</li>
<li><strong class="bold">Add to Existing</strong>: Grab the current value of the bone and add the supplied value to it.</li>
<li><strong class="bold">Replace Existing</strong>: Replace the current value of the bone with the supplied value.</li>
</ul>
<ol>
<li value="4"><strong class="bold">Setting the space</strong></li>
</ol>
<p>This will define the space where the node should apply the transform. You can pick from one of these four options:</p>
<ul>
<li><strong class="bold">World Space</strong>: The transform will happen in the world space.</li>
<li><strong class="bold">Component Space</strong>: The transform will happen in the skeletal mesh component space.</li>
<li><strong class="bold">Parent Bone Space</strong>: The transform will happen in the parent bone’s space of the selected bone.</li>
<li><strong class="bold">Bone Space</strong>: The transform will happen in the space of the selected bone.</li>
</ul>
<ol>
<li value="5"><strong class="bold">Alpha</strong> </li>
</ol>
<p>This option allows you to control the amount of transform that you want to apply. As an example, if you have the <strong class="source-inline">Alpha</strong> value as a float, then you’ll have the following behavior with different values:</p>
<ul>
<li>If <strong class="source-inline">Alpha</strong> is <strong class="source-inline">0.0</strong>, then no transform will be applied.</li>
<li>If <strong class="source-inline">Alpha</strong> is <strong class="source-inline">0.5</strong>, then it will only apply half of the transform.</li>
<li>If <strong class="source-inline">Alpha</strong> is <strong class="source-inline">1.0</strong>, then it will apply the entire transform.</li>
</ul>
<p>In the next exercise, we will use the <strong class="bold">Transform (Modify) Bone</strong> node to enable the character from <em class="italic">Exercise 16.04 – creating a movement 2D Blend Space</em>, to look up and down based on the camera’s<a id="_idIndexMarker1466"/> rotation.</p>
<h2 id="_idParaDest-347"><a id="_idTextAnchor383"/>Exercise 16.05 – Creating a character that looks up and down</h2>
<p>In this exercise, we’re going to use the project from <em class="italic">Exercise 16.04 – Creating a movement 2D Blend Space</em>, and enable the <a id="_idIndexMarker1467"/>character to look up and down based on the camera’s rotation. To achieve this, we’re going to use the <strong class="bold">Transform (Modify) Bone</strong> node to rotate the <strong class="bold">spine_03</strong> bone in the component space based on the pitch of the camera.</p>
<p>Follow these steps to complete this exercise:</p>
<ol>
<li value="1">First, you need to open the project from <em class="italic">Exercise 16.04 – Creating a movement 2D Blend Space</em>.</li>
<li>Go to <strong class="bold">Content\Characters\Mannequins\Animations</strong> and open <strong class="bold">ABP_Manny</strong>.</li>
<li>Go to <strong class="bold">Event Graph</strong> and create a float variable called <strong class="bold">Pitch</strong>.</li>
<li>Add a new pin to the sequence and set the value of <strong class="bold">Pitch</strong> with the subtraction (or delta) between the character’s <strong class="bold">rotation</strong> and <strong class="bold">base aim rotation</strong>, as shown here:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer522">
<img alt="Figure 16.21 – Calculating the Pitch " height="329" src="image/Figure_16..21_B18531.jpg" width="970"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.21 – Calculating the Pitch</p>
<p>This will allow you to get the value of <strong class="bold">Pitch</strong> from the rotator, which is the only part of the delta rotation that we are interested in.</p>
<p class="callout-heading">Note</p>
<p class="callout">The <strong class="bold">Break Rotator</strong> node allows you to separate a <strong class="bold">Rotator</strong> variable into three float variables that represent <strong class="bold">Pitch</strong>, <strong class="bold">Yaw</strong>, and <strong class="bold">Roll</strong>. This is useful when you want to access the value of each component or if you only want to work with one or two components, and not with the whole rotation.</p>
<p>As an alternative to using the <strong class="bold">Break Rotator</strong> node, you can right-click on <strong class="bold">Return Value</strong> and pick <strong class="bold">Split Struct Pin</strong>. Take into consideration that the <strong class="bold">Split Struct Pin</strong> option will only appear if <strong class="bold">Return Value</strong> is not connected to anything. Once you <a id="_idIndexMarker1468"/>do the split, it will create three separate wires for <strong class="bold">Roll, Pitch</strong>, and <strong class="bold">Yaw,</strong> just like a break but without the extra node.</p>
<p>You should end up with the following:</p>
<div>
<div class="IMG---Figure" id="_idContainer523">
<img alt="Figure 16.22 – Calculating the Pitch to look up using the Split Struct Pin option " height="327" src="image/Figure_16..22_B18531.jpg" width="920"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.22 – Calculating the Pitch to look up using the Split Struct Pin option</p>
<p>This logic uses the<a id="_idIndexMarker1469"/> rotation of the pawn and subtracts it from the camera’s rotation to get the difference in <strong class="bold">Pitch</strong>, as shown in the following diagram:</p>
<div>
<div class="IMG---Figure" id="_idContainer524">
<img alt="Figure 16.23 – How to calculate the delta Pitch " height="472" src="image/Figure_16..23_B18531.jpg" width="659"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.23 – How to calculate the delta Pitch</p>
<p class="callout-heading">Note</p>
<p class="callout">You can double-click on a wire to create a reroute node, which allows you to bend the wire so that it doesn’t overlap with other nodes, which makes the code easier to read.</p>
<ol>
<li value="5">Next, go to <strong class="bold">AnimGraph</strong> and add a <strong class="bold">Transform (Modify)</strong><strong class="source-inline"> Bone</strong> node with the following settings:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer525">
<img alt="Figure 16.24 – Settings for the Transform (Modify) Bone node " height="731" src="image/Figure_16..24_B18531.jpg" width="372"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.24 – Settings for the Transform (Modify) Bone node</p>
<p>In the preceding<a id="_idIndexMarker1470"/> screenshot, we’ve set <strong class="bold">Bone to Modify</strong> to <strong class="bold">spine_03</strong> because that is the bone that we want to rotate. We’ve also set <strong class="bold">Rotation Mode</strong> to <strong class="bold">Add to Existing</strong> because we want to keep the original rotation from the animation and add an offset to it. We can set the rest of the options to <strong class="bold">Ignore</strong> and remove <strong class="bold">Expose As Pin</strong> from the dropdown.</p>
<ol>
<li value="6">Connect the <strong class="bold">Transform (Modify) Bone</strong> node to <strong class="bold">Control Rig</strong> and the <strong class="bold">Output Pose</strong>, as shown in the following screenshot:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer526">
<img alt="Figure 16.25 – The Transform (Modify) Bone node connected to Output Pose " height="312" src="image/Figure_16..25_B18531.jpg" width="1121"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.25 – The Transform (Modify) Bone node connected to Output Pose</p>
<p>In the preceding<a id="_idIndexMarker1471"/> screenshot, you can see the <strong class="bold">AnimGraph</strong>, which will allow the character to look up and down by rotating the <strong class="bold">spine_03</strong> bone based on the camera’s pitch. To connect the <strong class="bold">Control Rig</strong> node to the <strong class="bold">Transform</strong> (<strong class="bold">Modify</strong>) <strong class="bold">Bone</strong> node, we need to convert from local to component space. After the <strong class="bold">Transform</strong> (<strong class="bold">Modify</strong>) <strong class="bold">Bone</strong> node is executed we need to convert back to local space to be able to connect to the <strong class="bold">Output Pose</strong> node.</p>
<p class="callout-heading">Note</p>
<p class="callout">We connect the <strong class="bold">Pitch</strong> variable to <strong class="bold">Roll</strong> because that bone in the skeleton is internally rotated that way. You can use <strong class="bold">Split Struct Pin</strong> on input parameters as well, so you don’t have to add a <strong class="bold">Make Rotator</strong> node.</p>
<p>If you test the project with two clients and move the mouse up and down on one of the characters, you’ll notice that it will pitch up and down, as shown in the following screenshot:</p>
<div>
<div class="IMG---Figure" id="_idContainer527">
<img alt="Figure 16.26 – Characters looking up and down, based on the camera rotation " height="486" src="image/Figure_16..26_B18531.jpg" width="1207"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.26 – Characters looking up and down, based on the camera rotation</p>
<p>By completing this final exercise, you <a id="_idIndexMarker1472"/>should understand how to modify bones at runtime using the <strong class="bold">Transform (Modify) Bone</strong> node in an animation blueprint. This node can be used in various scenarios, so it may prove useful for you.</p>
<p>In the next activity, you’re going to put everything you’ve learned to the test by creating the character we’re going to use for our multiplayer FPS project.</p>
<h1 id="_idParaDest-348"><a id="_idTextAnchor384"/>Activity 16.01 – Creating the character for the multiplayer FPS project</h1>
<p>In this activity, you’ll <a id="_idIndexMarker1473"/>create the character for the multiplayer FPS project that we’re going to build in the next few chapters. The character will have a few different mechanics, but for this activity, you just need to create a character that walks, jumps, looks up/down, and has two replicated stats: health and armor.</p>
<p>Follow these steps to complete this activity:</p>
<ol>
<li value="1">Create a <strong class="bold">Blank</strong> project using <strong class="bold">C++</strong> called <strong class="source-inline">MultiplayerFPS</strong> without the starter content.</li>
<li>Import the skeletal mesh and the animations from the <strong class="source-inline">Activity16.01\Assets</strong> folder and place them in the <strong class="bold">Content\Player\Mesh </strong>and<strong class="bold"> Content\Player\Animations</strong> folders, respectively.</li>
<li>Import the following sounds from the <strong class="source-inline">Activity16.01\Assets</strong> folder into <strong class="source-inline">Content\Player\Sounds</strong>:<ul><li><strong class="source-inline">Jump.wav</strong>: Play this sound on the <strong class="source-inline">Jump_From_Stand_Ironsights</strong> animation with a <strong class="source-inline">Play Sound</strong> anim notify.</li><li><strong class="source-inline">Footstep.wav</strong>: Play this sound every time a foot is on the floor in every walk animation by using the <strong class="source-inline">Play Sound</strong> anim notify.</li><li><strong class="source-inline">Spawn.wav</strong>: Use this on the <strong class="source-inline">SpawnSound</strong> variable in the character.</li></ul></li>
<li>Set up the skeletal mesh<a id="_idIndexMarker1474"/> by retargeting its bones and creating a socket called <strong class="source-inline">Camera</strong> that is a child of the head bone and has a <strong class="source-inline">Relative Location</strong> of (<strong class="source-inline">X=7.88, Y=4.73, Z=-10.00</strong>).</li>
<li>Create a 2D Blend Space in <strong class="bold">Content\Player\Animations</strong> called <strong class="bold">BS_Movement</strong> that uses the imported movement animations and a <strong class="bold">Weight Speed</strong> of <strong class="source-inline">5</strong>.</li>
<li>Create the input actions using the knowledge you acquired in <a href="B18531_04.xhtml#_idTextAnchor099"><em class="italic">Chapter 4</em></a>, <em class="italic">Getting Started with Player Input</em>:<ul><li><strong class="bold">IA_Move (Axis 2D)</strong>: <strong class="source-inline">W</strong>, <strong class="source-inline">S</strong>, <strong class="source-inline">A</strong>, <strong class="source-inline">D</strong></li><li><strong class="bold">IA_Look (Axis 2D)</strong>: <strong class="source-inline">Mouse X</strong>, <strong class="source-inline">Mouse Y</strong></li><li><strong class="bold">IA_Jump (Digital)</strong>: <strong class="source-inline">Spacebar</strong></li></ul></li>
<li>Add the new input actions to a new input mapping context called <strong class="bold">IMC_Player</strong>.</li>
<li>Create a C++ class called <strong class="bold">FPSCharacter</strong> that does the following:<ul><li>Derives from the <strong class="bold">Character</strong> class.</li><li>Has a camera component attached to the skeletal mesh on the <strong class="bold">Camera</strong> socket and has <strong class="bold">Pawn Control Rotation</strong> set to <strong class="bold">true</strong>.</li><li>Has variables for <strong class="bold">Health</strong> and <strong class="bold">Armor</strong> that only replicate to the owner.</li><li>Has variables for <strong class="bold">Max Health</strong> and <strong class="bold">Max Armor</strong>.</li><li>Has a variable for <strong class="source-inline">Armor Absorption</strong>, which is the percentage of how much damage the armor absorbs.</li><li>Has a constructor that<a id="_idIndexMarker1475"/> initializes the camera, disables ticking, and sets <strong class="bold">Max Walk Speed</strong> to <strong class="source-inline">800</strong> and <strong class="bold">Jump Z Velocity</strong> to <strong class="source-inline">600</strong>.</li><li>On <strong class="bold">BeginPlay</strong>, plays the spawning sound and initializes <strong class="bold">Health</strong> with <strong class="bold">Max Health</strong> if it has authority.</li><li>Adds the input mapping context and binds the input actions.</li><li>Has functions to add/remove/set health. It also should have a function that returns where the character is dead or not.</li><li>Has functions to add/set/absorb armor. The armor absorption reduces the armor based on the <strong class="source-inline">Armor Absorption</strong> variable and changes the damage value based on the following formula:</li></ul></li>
</ol>
<p> <strong class="source-inline">Damage = (Damage * (1 - ArmorAbsorption)) - FMath::Min(RemainingArmor, 0);</strong></p>
<ol>
<li value="9">Create an animation Blueprint in <strong class="source-inline">Content\Player\Animations</strong> called <strong class="source-inline">ABP_Player</strong> that has a <strong class="source-inline">State Machine</strong> with the following states:<ul><li><strong class="source-inline">Idle/Run</strong>: Uses <strong class="source-inline">BS_Movement</strong> with the <strong class="source-inline">Speed</strong> and <strong class="source-inline">Direction</strong> variables.</li><li><strong class="source-inline">Jump</strong>: Plays the jump animation and transitions from the <strong class="source-inline">Idle/Run</strong> states when the <strong class="source-inline">Is Jumping</strong> variable is <strong class="source-inline">true</strong>.</li><li>It also uses <strong class="source-inline">Transform (Modify) Bone</strong> to make the character look up and down based on the camera’s pitch.</li></ul></li>
<li>Create a <strong class="source-inline">UMG</strong> widget in <strong class="source-inline">Content\UI</strong> called <strong class="source-inline">WBP_HUD</strong> that displays the <strong class="source-inline">Health</strong> and <strong class="source-inline">Armor</strong> properties of the character in the <strong class="source-inline">Health: 100</strong> and <strong class="source-inline">Armor: 100</strong> formats using the knowledge you acquired in <a href="B18531_15.xhtml#_idTextAnchor322"><em class="italic">Chapter 15</em></a>, <em class="italic">Exploring Collectibles, Power-Ups, and Pickups</em>.</li>
<li>Create a Blueprint in <strong class="source-inline">Content\Player</strong> called <strong class="source-inline">BP_Player</strong> that derives from <strong class="source-inline">FPSCharacter</strong>:<ul><li>Set up the mesh<a id="_idIndexMarker1476"/> component so that it has the following values:<ul><li><strong class="bold">Skeletal Mesh</strong>: <strong class="source-inline">Content\Player\Mesh\SK_Mannequin</strong></li><li><strong class="bold">Animation Blueprint</strong>: <strong class="source-inline">Content\Player\Animations\ABP_Player</strong> </li><li><strong class="bold">Location</strong>: <strong class="source-inline">(X=0.0, Y=0.0, Z=-88.0)</strong></li><li><strong class="bold">Rotation</strong>: <strong class="source-inline">(X=0.0, Y=0.0, Z=-90.0)</strong></li><li><strong class="bold">Move Input Action</strong>: <strong class="source-inline">Content\Player\Inputs\IA_Move</strong></li><li><strong class="bold">Look Input Action</strong>: <strong class="source-inline">Content\Player\Inputs\IA_Look</strong></li><li><strong class="bold">Jump Input Action</strong>: <strong class="source-inline">Content\Player\Inputs\IA_Jump</strong></li><li>On the <strong class="source-inline">Begin Play</strong> event, it needs to create a widget instance of <strong class="source-inline">WBP_HUD</strong> and add it to the viewport.</li></ul></li></ul></li>
<li>Create a Blueprint in <strong class="bold">Content\Blueprints</strong> called<strong class="bold"> </strong><strong class="source-inline">BP_GameMode</strong> that derives from <strong class="bold">MultiplayerFPSGameModeBase</strong>, which will use <strong class="source-inline">BP_Player</strong> as the <strong class="bold">DefaultPawn</strong> class.</li>
<li>Create a test map in <strong class="bold">Content\Maps</strong> called <strong class="bold">DM-Test</strong> and set it as the default map in <strong class="bold">Project Settings</strong>.</li>
</ol>
<p><strong class="bold">Expected output</strong>:</p>
<p>The result should be a project where each client will have a first-person character that can move, jump, and look around. These actions will also be replicated so that each client will be able to see<a id="_idIndexMarker1477"/> what the other client’s character is doing. </p>
<p>Each client will also have a HUD that displays the health and the armor values:</p>
<div>
<div class="IMG---Figure" id="_idContainer528">
<img alt="Figure 16.27 – Expected output " height="640" src="image/Figure_16..27_B18531.jpg" width="1612"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.27 – Expected output</p>
<p class="callout-heading">Note</p>
<p class="callout">The solution for this activity can be found on GitHub here: <a href="https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition/tree/main/Activity%20solutions">https://github.com/PacktPublishing/Elevating-Game-Experiences-with-Unreal-Engine-5-Second-Edition/tree/main/Activity%20solutions</a>.</p>
<p>By completing this activity, you should have a good idea of how the server-client architecture, variable replication, roles, 2D Blend Spaces, and the <strong class="bold">Transform (Modify) Bone</strong> node work.</p>
<h1 id="_idParaDest-349"><a id="_idTextAnchor385"/>Summary</h1>
<p>In this chapter, we learned about some critical multiplayer concepts, such as how the server-client architecture works, the responsibilities of the server and the client, how the listen server is quicker to set up than a dedicated server but not as lightweight, ownership and connections, roles, and variable replication. </p>
<p>We also learned about some useful techniques for animation, such as how to use 2D Blend Spaces, which allow you to have a two-axis grid to blend between animations, and the <strong class="source-inline">Transform (Modify) Bone</strong> node, which can modify the bones of a skeletal mesh at runtime. To finish off this chapter, we created a first-person multiplayer project where you have characters that can walk, look, and jump around. This will be the foundation of the multiplayer first-person shooter project that we will be working on for the next few chapters.</p>
<p>In the next chapter, we’ll learn how to use RPCs, which allows clients and servers to execute functions on each other. We’ll also cover how to use enumerations in the editor and how to use array index wrapping to iterate an array in both directions and loop around when you go beyond its limits.</p>
</div>
</div></body></html>