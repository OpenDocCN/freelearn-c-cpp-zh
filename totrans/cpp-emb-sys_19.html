<html><head></head><body>
<div id="_idContainer078">
<h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">15</span></h1>
<h1 class="chapterTitle" id="_idParaDest-199"><span class="koboSpan" id="kobo.2.1">Practical Patterns – Building a Temperature Publisher</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">Design patterns are tools for solving common problems. </span><span class="koboSpan" id="kobo.3.2">So far, we have covered a few design patterns in this book, such as the Command and Adapter patterns. </span><span class="koboSpan" id="kobo.3.3">In this chapter, we will go over the </span><strong class="keyWord"><span class="koboSpan" id="kobo.4.1">Observer pattern</span></strong><span class="koboSpan" id="kobo.5.1"> and apply it to a common problem in embedded systems – handling temperature readings in different parts of the system.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.6.1">We will start by </span><a id="_idIndexMarker642"/><span class="koboSpan" id="kobo.7.1">looking at the Observer pattern and how it can be implemented at runtime. </span><span class="koboSpan" id="kobo.7.2">This pattern is particularly useful when multiple components need to react to changes in data from a central source. </span><span class="koboSpan" id="kobo.7.3">Imagine a temperature sensor in an embedded device that reports changes to multiple listeners. </span><span class="koboSpan" id="kobo.7.4">This could be part of a smart thermostat, an industrial machine monitor, or an HVAC control board – each with components such as a screen, a logger, or a fan controller that react to temperature updates.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.8.1">Next, we will transition to a compile-time implementation of the same pattern using modern C++ techniques such as variadic templates and fold expressions. </span><span class="koboSpan" id="kobo.8.2">By leveraging these techniques, we can generate highly optimized code at compile time, avoiding virtual dispatch, associated with runtime polymorphism. </span><span class="koboSpan" id="kobo.8.3">This approach results in a smaller memory footprint and faster code that’s better suited to systems with limited resources.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.9.1">In this chapter, we’re going to cover the following main topics:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.10.1">The Observer pattern</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.11.1">Runtime implementation</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.12.1">Compile-time implementation</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-200"><span class="koboSpan" id="kobo.13.1">Technical requirements</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.14.1">To get the most out of this chapter, I strongly recommend using Compiler Explorer (</span><a href="https://godbolt.org/"><span class="url"><span class="koboSpan" id="kobo.15.1">https://godbolt.org/</span></span></a><span class="koboSpan" id="kobo.16.1">) as you read through the examples. </span><span class="koboSpan" id="kobo.16.2">Add an execution pane with GCC as your compiler for x86 architecture. </span><span class="koboSpan" id="kobo.16.3">This will allow you to see standard output and better observe the code’s behavior. </span><span class="koboSpan" id="kobo.16.4">As we are using a lot of modern C++ features, make sure to select C++23 standard, by adding </span><code class="inlineCode"><span class="koboSpan" id="kobo.17.1">-std=c++23</span></code><span class="koboSpan" id="kobo.18.1"> in the </span><strong class="screenText"><span class="koboSpan" id="kobo.19.1">compiler options</span></strong><span class="koboSpan" id="kobo.20.1"> box, and set the optimization level to </span><code class="inlineCode"><span class="koboSpan" id="kobo.21.1">-O3</span></code><span class="koboSpan" id="kobo.22.1">. </span><span class="koboSpan" id="kobo.22.2">Also, add a compiler pane using </span><code class="inlineCode"><span class="koboSpan" id="kobo.23.1">ARM gcc 11.2.1 (none)</span></code><span class="koboSpan" id="kobo.24.1"> to inspect the assembly output of the examples.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.25.1">You can try the examples from this chapter in the Renode simulator in the Docker container you set up in </span><a href="Chapter_04.xhtml"><em class="italic"><span class="koboSpan" id="kobo.26.1">Chapter 4</span></em></a><span class="koboSpan" id="kobo.27.1">. </span><span class="koboSpan" id="kobo.27.2">Make sure that the Docker container is running.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.28.1">You can find the files for this chapter on GitHub at </span><a href="https://github.com/PacktPublishing/Cpp-in-Embedded-Systems/tree/main/Chapter15/observer"><span class="url"><span class="koboSpan" id="kobo.29.1">https://github.com/PacktPublishing/Cpp-in-Embedded-Systems/tree/main/Chapter15/observer</span></span></a><span class="koboSpan" id="kobo.30.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-201"><span class="koboSpan" id="kobo.31.1">The Observer pattern</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.32.1">The </span><strong class="keyWord"><span class="koboSpan" id="kobo.33.1">Observer pattern</span></strong><span class="koboSpan" id="kobo.34.1"> is often used in event-driven systems to publish events to subscribed objects, usually by </span><a id="_idIndexMarker643"/><span class="koboSpan" id="kobo.35.1">calling a method on them. </span><span class="koboSpan" id="kobo.35.2">An object that publishes </span><a id="_idIndexMarker644"/><span class="koboSpan" id="kobo.36.1">events is called a </span><strong class="keyWord"><span class="koboSpan" id="kobo.37.1">subject</span></strong><span class="koboSpan" id="kobo.38.1"> or </span><strong class="keyWord"><span class="koboSpan" id="kobo.39.1">publisher</span></strong><span class="koboSpan" id="kobo.40.1">. </span><span class="koboSpan" id="kobo.40.2">Objects that receive events from a publisher are </span><a id="_idIndexMarker645"/><span class="koboSpan" id="kobo.41.1">called </span><strong class="keyWord"><span class="koboSpan" id="kobo.42.1">observers</span></strong><span class="koboSpan" id="kobo.43.1"> or </span><strong class="keyWord"><span class="koboSpan" id="kobo.44.1">subscribers</span></strong><span class="koboSpan" id="kobo.45.1">. </span><span class="koboSpan" id="kobo.45.2">From now on, we will use the terms </span><strong class="keyWord"><span class="koboSpan" id="kobo.46.1">publisher</span></strong><span class="koboSpan" id="kobo.47.1"> and </span><strong class="keyWord"><span class="koboSpan" id="kobo.48.1">subscriber</span></strong><span class="koboSpan" id="kobo.49.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.50.1">A publisher has </span><a id="_idIndexMarker646"/><span class="koboSpan" id="kobo.51.1">an internal list of subscribers and provides an interface to register and unregister a subscriber from the internal list. </span><span class="koboSpan" id="kobo.51.2">It also provides the </span><code class="inlineCode"><span class="koboSpan" id="kobo.52.1">notify</span></code><span class="koboSpan" id="kobo.53.1"> method, used by its client, which in turn calls </span><code class="inlineCode"><span class="koboSpan" id="kobo.54.1">update</span></code><span class="koboSpan" id="kobo.55.1"> methods on subscribers – that’s why we say that the publisher notifies subscribers.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.56.1">An example of a publisher-subscriber mechanism that is common in embedded systems would be a temperature publisher, which notifies the logger, display, and data sender at regular intervals. </span><span class="koboSpan" id="kobo.56.2">Before we go on to the implementation of this example, we will first go through a UML diagram of the Observer pattern.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.57.1"><img alt="Figure 15.1 – UML diagram of the Observer pattern" src="../Images/B22402_15_01.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.58.1">Figure 15.1 – UML diagram of the Observer pattern</span></p>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.59.1">Figure 15.1</span></em><span class="koboSpan" id="kobo.60.1"> depicts the UML </span><a id="_idIndexMarker647"/><span class="koboSpan" id="kobo.61.1">class diagram of the Observer pattern. </span><span class="koboSpan" id="kobo.61.2">In the diagram, we see that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.62.1">publisher</span></code><span class="koboSpan" id="kobo.63.1"> class has the following members:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.64.1">etl::vector&lt;subscribers_, 8&gt;</span></code><span class="koboSpan" id="kobo.65.1">: Internal list of pointers to the subscriber interface, for which we will use </span><code class="inlineCode"><span class="koboSpan" id="kobo.66.1">vector</span></code><span class="koboSpan" id="kobo.67.1"> from ETL.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.68.1">register_sub(subscriber *)</span></code><span class="koboSpan" id="kobo.69.1">: The method used to register a subscriber. </span><span class="koboSpan" id="kobo.69.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.70.1">register</span></code><span class="koboSpan" id="kobo.71.1"> keyword is reserved in C++ and used as a storage specifier, so we are using </span><code class="inlineCode"><span class="koboSpan" id="kobo.72.1">register_sub</span></code><span class="koboSpan" id="kobo.73.1"> as the name for this method.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.74.1">unregister(subscriber *)</span></code><span class="koboSpan" id="kobo.75.1">: The method used to unregister a subscriber.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.76.1">notify(float)</span></code><span class="koboSpan" id="kobo.77.1">: The method used by the publisher’s client to trigger the updating of subscribers.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.78.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.79.1">subscriber</span></code><span class="koboSpan" id="kobo.80.1"> interface class </span><a id="_idIndexMarker648"/><span class="koboSpan" id="kobo.81.1">has one pure virtual method – </span><code class="inlineCode"><span class="koboSpan" id="kobo.82.1">void update(float)</span></code><span class="koboSpan" id="kobo.83.1">. </span><span class="koboSpan" id="kobo.83.2">This method is overridden in the concrete implementation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.84.1">subscriber</span></code><span class="koboSpan" id="kobo.85.1"> class. </span><span class="koboSpan" id="kobo.85.2">To see this in action, we will proceed with the runtime implementation of the Observer pattern.</span></p>
<h1 class="heading-1" id="_idParaDest-202"><span class="koboSpan" id="kobo.86.1">Runtime implementation</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.87.1">We will go </span><a id="_idIndexMarker649"/><span class="koboSpan" id="kobo.88.1">through the runtime implementation of the Observer pattern on the example of temperature publisher. </span><span class="koboSpan" id="kobo.88.2">Subscribers will be a logger, display, and data sender. </span><span class="koboSpan" id="kobo.88.3">The code of the subscriber interface and concrete subscribers is shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.89.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.90.1">include</span></span><span class="hljs-meta"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.91.1">&lt;cstdio&gt;</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.92.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.93.1">include</span></span><span class="hljs-meta"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.94.1">“etl/vector.h”</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.95.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.96.1">include</span></span><span class="hljs-meta"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.97.1">&lt;algorithm&gt;</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.98.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.99.1">subscriber</span></span><span class="koboSpan" id="kobo.100.1"> {
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.101.1">public</span></span><span class="koboSpan" id="kobo.102.1">:
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.103.1">virtual</span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="koboSpan" id="kobo.104.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.105.1">update</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.106.1">(</span></span><span class="hljs-type"><span class="koboSpan" id="kobo.107.1">float</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.108.1">)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.109.1">= </span><span class="hljs-number"><span class="koboSpan" id="kobo.110.1">0</span></span><span class="koboSpan" id="kobo.111.1">;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.112.1">virtual</span></span><span class="koboSpan" id="kobo.113.1"> ~</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.114.1">subscriber</span></span><span class="koboSpan" id="kobo.115.1">() = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.116.1">default</span></span><span class="koboSpan" id="kobo.117.1">;
};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.118.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.119.1">display</span></span><span class="koboSpan" id="kobo.120.1"> : </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.121.1">public</span></span><span class="koboSpan" id="kobo.122.1"> subscriber {
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.123.1">public</span></span><span class="koboSpan" id="kobo.124.1">:
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.125.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.126.1">update</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.127.1">(</span></span><span class="hljs-type"><span class="koboSpan" id="kobo.128.1">float</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.129.1"> temp)</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.130.1">override</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.131.1">{
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.132.1">printf</span></span><span class="koboSpan" id="kobo.133.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.134.1">“Displaying temperature %.2f \r\n”</span></span><span class="koboSpan" id="kobo.135.1">, temp);
    }
};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.136.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.137.1">data_sender</span></span><span class="koboSpan" id="kobo.138.1"> : </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.139.1">public</span></span><span class="koboSpan" id="kobo.140.1"> subscriber {
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.141.1">public</span></span><span class="koboSpan" id="kobo.142.1">:
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.143.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.144.1">update</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.145.1">(</span></span><span class="hljs-type"><span class="koboSpan" id="kobo.146.1">float</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.147.1"> temp)</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.148.1">override</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.149.1">{
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.150.1">printf</span></span><span class="koboSpan" id="kobo.151.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.152.1">“Sending temperature %.2f \r\n”</span></span><span class="koboSpan" id="kobo.153.1">, temp);
    }
};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.154.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.155.1">logger</span></span><span class="koboSpan" id="kobo.156.1"> : </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.157.1">public</span></span><span class="koboSpan" id="kobo.158.1"> subscriber {
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.159.1">public</span></span><span class="koboSpan" id="kobo.160.1">:
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.161.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.162.1">update</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.163.1">(</span></span><span class="hljs-type"><span class="koboSpan" id="kobo.164.1">float</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.165.1"> temp)</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.166.1">override</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.167.1">{
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.168.1">printf</span></span><span class="koboSpan" id="kobo.169.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.170.1">“Logging temperature %.2f \r\n”</span></span><span class="koboSpan" id="kobo.171.1">, temp);
    }
};
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.172.1">The preceding code defines the </span><code class="inlineCode"><span class="koboSpan" id="kobo.173.1">subscriber</span></code><span class="koboSpan" id="kobo.174.1"> interface and concrete subscriber classes: </span><code class="inlineCode"><span class="koboSpan" id="kobo.175.1">display</span></code><span class="koboSpan" id="kobo.176.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.177.1">data_sender</span></code><span class="koboSpan" id="kobo.178.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.179.1">logger</span></code><span class="koboSpan" id="kobo.180.1">. </span><span class="koboSpan" id="kobo.180.2">Concrete classes override the pure virtual </span><code class="inlineCode"><span class="koboSpan" id="kobo.181.1">update</span></code><span class="koboSpan" id="kobo.182.1"> method from the interface class. </span><span class="koboSpan" id="kobo.182.2">For the sake of simplicity of the example, all concrete implementations </span><a id="_idIndexMarker650"/><span class="koboSpan" id="kobo.183.1">are printing temperature to standard output.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.184.1">Using the interface class allows the publisher to depend on the interface. </span><span class="koboSpan" id="kobo.184.2">The publisher maintains an internal container of pointers to the subscriber interface. </span><span class="koboSpan" id="kobo.184.3">This makes it possible to add different implementations of the subscriber interface through the pointer on the base interface class. </span><span class="koboSpan" id="kobo.184.4">The code for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.185.1">publisher</span></code><span class="koboSpan" id="kobo.186.1"> class is provided here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.187.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.188.1">publisher</span></span><span class="koboSpan" id="kobo.189.1"> {
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.190.1">public</span></span><span class="koboSpan" id="kobo.191.1">:
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.192.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.193.1">register_sub</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.194.1">(subscriber * sub)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.195.1">{
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.196.1">if</span></span><span class="koboSpan" id="kobo.197.1">(std::</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.198.1">find</span></span><span class="koboSpan" id="kobo.199.1">(subs_.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.200.1">begin</span></span><span class="koboSpan" id="kobo.201.1">(), subs_.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.202.1">end</span></span><span class="koboSpan" id="kobo.203.1">(), sub) == subs_.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.204.1">end</span></span><span class="koboSpan" id="kobo.205.1">())
        {
            subs_.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.206.1">push_back</span></span><span class="koboSpan" id="kobo.207.1">(sub);
        }
    }
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.208.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.209.1">unregister</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.210.1">(subscriber * sub)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.211.1">{
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.212.1">if</span></span><span class="koboSpan" id="kobo.213.1">(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.214.1">auto</span></span><span class="koboSpan" id="kobo.215.1"> it = std::</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.216.1">find</span></span><span class="koboSpan" id="kobo.217.1">(subs_.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.218.1">begin</span></span><span class="koboSpan" id="kobo.219.1">(), subs_.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.220.1">end</span></span><span class="koboSpan" id="kobo.221.1">(),
                                  sub); it != subs_.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.222.1">end</span></span><span class="koboSpan" id="kobo.223.1">())
        {
            subs_.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.224.1">erase</span></span><span class="koboSpan" id="kobo.225.1">(it);
        }
    }
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.226.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.227.1">notify</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.228.1">(</span></span><span class="hljs-type"><span class="koboSpan" id="kobo.229.1">float</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.230.1"> value)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.231.1">{
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.232.1">for</span></span><span class="koboSpan" id="kobo.233.1">(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.234.1">auto</span></span><span class="koboSpan" id="kobo.235.1"> sub: subs_) {
            sub-&gt;</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.236.1">update</span></span><span class="koboSpan" id="kobo.237.1">(value);
        }
    }
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.238.1">private</span></span><span class="koboSpan" id="kobo.239.1">:
    etl::vector&lt;subscriber*, 8&gt; subs_;
};
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.240.1">In the preceding </span><code class="inlineCode"><span class="koboSpan" id="kobo.241.1">publisher</span></code><span class="koboSpan" id="kobo.242.1"> class, we see the following members:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.243.1">etl::vector&lt;subscriber*, 8&gt; subs_</span></code><span class="koboSpan" id="kobo.244.1">: A private container used to maintain subscribers. </span><span class="koboSpan" id="kobo.244.2">If you are running this example in Compiler Explorer, make sure to add the ETL library using the </span><strong class="screenText"><span class="koboSpan" id="kobo.245.1">Libraries</span></strong><span class="koboSpan" id="kobo.246.1"> option.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.247.1">void register_sub(subscriber * sub)</span></code><span class="koboSpan" id="kobo.248.1">: A method used to register the subscriber. </span><span class="koboSpan" id="kobo.248.2">It uses the </span><code class="inlineCode"><span class="koboSpan" id="kobo.249.1">std::find</span></code><span class="koboSpan" id="kobo.250.1"> algorithm to check if a subscriber has already been added.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.251.1">void unregister(subscriber * sub)</span></code><span class="koboSpan" id="kobo.252.1">: A method used to unregister a subscriber. </span><span class="koboSpan" id="kobo.252.2">It uses the </span><code class="inlineCode"><span class="koboSpan" id="kobo.253.1">std::find</span></code><span class="koboSpan" id="kobo.254.1"> algorithm to check if a subscriber is added before the calling method </span><code class="inlineCode"><span class="koboSpan" id="kobo.255.1">erase</span></code><span class="koboSpan" id="kobo.256.1"> to remove it from a vector. </span><span class="koboSpan" id="kobo.256.2">The method </span><code class="inlineCode"><span class="koboSpan" id="kobo.257.1">erase</span></code><span class="koboSpan" id="kobo.258.1"> is provided by the iterator returned by </span><code class="inlineCode"><span class="koboSpan" id="kobo.259.1">std::find</span></code><span class="koboSpan" id="kobo.260.1"> if it is different from </span><code class="inlineCode"><span class="koboSpan" id="kobo.261.1">subs_.end()</span></code><span class="koboSpan" id="kobo.262.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.263.1">void notify(float value)</span></code><span class="koboSpan" id="kobo.264.1">: Loops through registered subscribers and calls the method </span><code class="inlineCode"><span class="koboSpan" id="kobo.265.1">update</span></code><span class="koboSpan" id="kobo.266.1"> on them.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.267.1">Now, let us see </span><a id="_idIndexMarker651"/><span class="koboSpan" id="kobo.268.1">how to use the preceding publisher and subscribers in the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-type"><span class="koboSpan" id="kobo.269.1">int</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.270.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.271.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.272.1">{   
    logger temp_logger;
    display temp_display;
    data_sender temp_data_sender;
    publisher temp_publisher;
    temp_publisher.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.273.1">register_sub</span></span><span class="koboSpan" id="kobo.274.1">(&amp;temp_logger);
    temp_publisher.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.275.1">register_sub</span></span><span class="koboSpan" id="kobo.276.1">(&amp;temp_display);
    temp_publisher.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.277.1">notify</span></span><span class="koboSpan" id="kobo.278.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.279.1">24.02f</span></span><span class="koboSpan" id="kobo.280.1">);
    temp_publisher.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.281.1">unregister</span></span><span class="koboSpan" id="kobo.282.1">(&amp;temp_logger);
    temp_publisher.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.283.1">register_sub</span></span><span class="koboSpan" id="kobo.284.1">(&amp;temp_data_sender);
    temp_publisher.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.285.1">notify</span></span><span class="koboSpan" id="kobo.286.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.287.1">44.02f</span></span><span class="koboSpan" id="kobo.288.1">);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.289.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.290.1">0</span></span><span class="koboSpan" id="kobo.291.1">;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.292.1">In the code, we perform the following steps:</span></p>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.293.1">Instantiate the following concrete subscribers: </span><code class="inlineCode"><span class="koboSpan" id="kobo.294.1">temp_logger</span></code><span class="koboSpan" id="kobo.295.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.296.1">temp_display</span></code><span class="koboSpan" id="kobo.297.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.298.1">temp_data_sender</span></code><span class="koboSpan" id="kobo.299.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.300.1">Instantiate the publisher </span><code class="inlineCode"><span class="koboSpan" id="kobo.301.1">temp_publisher</span></code><span class="koboSpan" id="kobo.302.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.303.1">Register the subscribers </span><code class="inlineCode"><span class="koboSpan" id="kobo.304.1">temp_logger</span></code><span class="koboSpan" id="kobo.305.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.306.1">temp_display</span></code><span class="koboSpan" id="kobo.307.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.308.1">Call </span><code class="inlineCode"><span class="koboSpan" id="kobo.309.1">notify(24.02f)</span></code><span class="koboSpan" id="kobo.310.1"> on </span><code class="inlineCode"><span class="koboSpan" id="kobo.311.1">temp_publisher</span></code><span class="koboSpan" id="kobo.312.1">.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.313.1">After these steps, we expect the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.314.1">Logging temperature 24.02
Displaying temperature 24.02
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.315.1">Next, we perform </span><a id="_idIndexMarker652"/><span class="koboSpan" id="kobo.316.1">the following steps:</span></p>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.317.1">Unregister the subscriber </span><code class="inlineCode"><span class="koboSpan" id="kobo.318.1">temp_logger</span></code><span class="koboSpan" id="kobo.319.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.320.1">Register the subscriber </span><code class="inlineCode"><span class="koboSpan" id="kobo.321.1">temp_data_sender</span></code><span class="koboSpan" id="kobo.322.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.323.1">Call </span><code class="inlineCode"><span class="koboSpan" id="kobo.324.1">notify(44.02f)</span></code><span class="koboSpan" id="kobo.325.1"> on </span><code class="inlineCode"><span class="koboSpan" id="kobo.326.1">temp_publisher</span></code><span class="koboSpan" id="kobo.327.1">.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.328.1">After these steps, we expect the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.329.1">Displaying temperature 44.02
Sending temperature 44.02
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.330.1">As an </span><em class="italic"><span class="koboSpan" id="kobo.331.1">exercise</span></em><span class="koboSpan" id="kobo.332.1">, create a new subscriber class </span><code class="inlineCode"><span class="koboSpan" id="kobo.333.1">eeprom_writer</span></code><span class="koboSpan" id="kobo.334.1"> that records temperature if it goes under or above a set threshold.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.335.1">You can run the full example in Renode. </span><span class="koboSpan" id="kobo.335.2">Start Visual Studio Code, attach it to the running container, open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.336.1">Chapter15/observer</span></code><span class="koboSpan" id="kobo.337.1"> project as described in </span><a href="Chapter_04.xhtml"><em class="italic"><span class="koboSpan" id="kobo.338.1">Chapter 4</span></em></a><span class="koboSpan" id="kobo.339.1">, and run the following commands in the Visual Studio Code terminal, or run them directly in the container terminal:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.340.1">$ cmake –B build
$ cmake --build build --target run_in_renode
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.341.1">Next, we will go through the compile-time implementation of the Observer pattern.</span></p>
<h1 class="heading-1" id="_idParaDest-203"><span class="koboSpan" id="kobo.342.1">Compile-time implementation</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.343.1">In most embedded applications, we know a lot about the system’s behavior at compile time. </span><span class="koboSpan" id="kobo.343.2">This means </span><a id="_idIndexMarker653"/><span class="koboSpan" id="kobo.344.1">that when using the Observer pattern, we already know all the subscribers. </span><span class="koboSpan" id="kobo.344.2">If we assume that subscribers are only registered once and never unregistered, we can create a compile-time version of the Observer pattern.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.345.1">To enable this, we’ll first break down the key C++17 features that make compile-time implementation feasible.</span></p>
<h2 class="heading-2" id="_idParaDest-204"><span class="koboSpan" id="kobo.346.1">Leveraging variadic templates</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.347.1">We will base the implementation on variadic templates. </span><span class="koboSpan" id="kobo.347.2">We will start with a simplified implementation </span><a id="_idIndexMarker654"/><span class="koboSpan" id="kobo.348.1">to explain variadic templates, parameter packs, and fold expressions – C++ features that will allow us to create a compile-time version of the Observer pattern. </span><span class="koboSpan" id="kobo.348.2">Let us proceed with the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.349.1">#</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.350.1">include</span></span><span class="hljs-meta"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.351.1">&lt;cstdio&gt;</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.352.1">struct</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.353.1">display</span></span><span class="koboSpan" id="kobo.354.1"> {
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.355.1">static</span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="koboSpan" id="kobo.356.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.357.1">update</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.358.1">(</span></span><span class="hljs-type"><span class="koboSpan" id="kobo.359.1">float</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.360.1"> temp)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.361.1">{
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.362.1">printf</span></span><span class="koboSpan" id="kobo.363.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.364.1">“Displaying temperature %.2f \r\n”</span></span><span class="koboSpan" id="kobo.365.1">, temp);
    }
};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.366.1">struct</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.367.1">data_sender</span></span><span class="koboSpan" id="kobo.368.1"> {
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.369.1">static</span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="koboSpan" id="kobo.370.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.371.1">update</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.372.1">(</span></span><span class="hljs-type"><span class="koboSpan" id="kobo.373.1">float</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.374.1"> temp)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.375.1">{
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.376.1">printf</span></span><span class="koboSpan" id="kobo.377.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.378.1">“Sending temperature %.2f \r\n”</span></span><span class="koboSpan" id="kobo.379.1">, temp);
    }
};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.380.1">struct</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.381.1">logger</span></span><span class="koboSpan" id="kobo.382.1"> {
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.383.1">static</span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="koboSpan" id="kobo.384.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.385.1">update</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.386.1">(</span></span><span class="hljs-type"><span class="koboSpan" id="kobo.387.1">float</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.388.1"> temp)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.389.1">{
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.390.1">printf</span></span><span class="koboSpan" id="kobo.391.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.392.1">“Logging temperature %.2f \r\n”</span></span><span class="koboSpan" id="kobo.393.1">, temp);
    }
};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.394.1">template</span></span><span class="koboSpan" id="kobo.395.1"> &lt;</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.396.1">typename</span></span><span class="koboSpan" id="kobo.397.1">... </span><span class="koboSpan" id="kobo.397.2">Subs&gt;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.398.1">struct</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.399.1">publisher</span></span><span class="koboSpan" id="kobo.400.1"> {
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.401.1">static</span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="koboSpan" id="kobo.402.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.403.1">notify</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.404.1">(</span></span><span class="hljs-type"><span class="koboSpan" id="kobo.405.1">float</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.406.1"> temp)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.407.1">{
        (Subs::</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.408.1">update</span></span><span class="koboSpan" id="kobo.409.1">(temp), ...);
    }
};
</span><span class="hljs-type"><span class="koboSpan" id="kobo.410.1">int</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.411.1">main</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.412.1">()</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.413.1">{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.414.1">using</span></span><span class="koboSpan" id="kobo.415.1"> temp_publisher = publisher&lt;display,
    data_sender,
    logger&gt;;
    temp_publisher::</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.416.1">notify</span></span><span class="koboSpan" id="kobo.417.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.418.1">23.47</span></span><span class="koboSpan" id="kobo.419.1">);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.420.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.421.1">0</span></span><span class="koboSpan" id="kobo.422.1">;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.423.1">In the code above, we have subscribers structs </span><code class="inlineCode"><span class="koboSpan" id="kobo.424.1">display</span></code><span class="koboSpan" id="kobo.425.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.426.1">data_sender</span></code><span class="koboSpan" id="kobo.427.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.428.1">logger</span></code><span class="koboSpan" id="kobo.429.1">. </span><span class="koboSpan" id="kobo.429.2">All structs implement the static method </span><code class="inlineCode"><span class="koboSpan" id="kobo.430.1">update</span></code><span class="koboSpan" id="kobo.431.1">, which takes </span><code class="inlineCode"><span class="koboSpan" id="kobo.432.1">temperature</span></code><span class="koboSpan" id="kobo.433.1"> as a parameter and prints it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.434.1">The struct </span><code class="inlineCode"><span class="koboSpan" id="kobo.435.1">publisher</span></code><span class="koboSpan" id="kobo.436.1"> is a variadic </span><a id="_idIndexMarker655"/><span class="koboSpan" id="kobo.437.1">class template. </span><span class="koboSpan" id="kobo.437.2">A </span><strong class="keyWord"><span class="koboSpan" id="kobo.438.1">variadic template</span></strong><span class="koboSpan" id="kobo.439.1"> is a template </span><a id="_idIndexMarker656"/><span class="koboSpan" id="kobo.440.1">with at least one </span><strong class="keyWord"><span class="koboSpan" id="kobo.441.1">parameter pack</span></strong><span class="koboSpan" id="kobo.442.1">. </span><span class="koboSpan" id="kobo.442.2">A template parameter </span><a id="_idIndexMarker657"/><span class="koboSpan" id="kobo.443.1">pack is a template parameter that accepts zero or more template arguments. </span><code class="inlineCode"><span class="koboSpan" id="kobo.444.1">typename... </span><span class="koboSpan" id="kobo.444.2">Subs</span></code><span class="koboSpan" id="kobo.445.1"> is a type template parameter pack named </span><code class="inlineCode"><span class="koboSpan" id="kobo.446.1">Subs</span></code><span class="koboSpan" id="kobo.447.1">, meaning we can instantiate the struct </span><code class="inlineCode"><span class="koboSpan" id="kobo.448.1">publisher</span></code><span class="koboSpan" id="kobo.449.1"> with zero or more different types. </span><span class="koboSpan" id="kobo.449.2">To sum it up:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.450.1">publisher</span></code><span class="koboSpan" id="kobo.451.1"> is a variadic class template as it has a template parameter pack </span><code class="inlineCode"><span class="koboSpan" id="kobo.452.1">typename... </span><span class="koboSpan" id="kobo.452.2">Subs</span></code><span class="koboSpan" id="kobo.453.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.454.1">We can instantiate it with a variable number of types provided as template arguments. </span><span class="koboSpan" id="kobo.454.2">This is the way to register subscribers to the publisher.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.455.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.456.1">main</span></code><span class="koboSpan" id="kobo.457.1"> function, we create the alias </span><code class="inlineCode"><span class="koboSpan" id="kobo.458.1">temp_publisher</span></code><span class="koboSpan" id="kobo.459.1"> as </span><code class="inlineCode"><span class="koboSpan" id="kobo.460.1">publisher&lt;display, data_sender, logger&gt;</span></code><span class="koboSpan" id="kobo.461.1">. </span><span class="koboSpan" id="kobo.461.2">We call the </span><code class="inlineCode"><span class="koboSpan" id="kobo.462.1">notify</span></code><span class="koboSpan" id="kobo.463.1"> method on this alias, which will result in calls to update functions in types provided through the template parameter pack, thanks to the fold expression in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.464.1">notify</span></code><span class="koboSpan" id="kobo.465.1"> method.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.466.1">The final piece of the puzzle is the fold expression </span><code class="inlineCode"><span class="koboSpan" id="kobo.467.1">(Subs::update(temp), ...)</span></code><span class="koboSpan" id="kobo.468.1">. </span><span class="koboSpan" id="kobo.468.2">This is a fold expression that uses the comma operator as the folding operator. </span><span class="koboSpan" id="kobo.468.3">It expands to: </span><code class="inlineCode"><span class="koboSpan" id="kobo.469.1">(display::update(temp), data_sender::update(temp), logger::update(temp))</span></code><span class="koboSpan" id="kobo.470.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.471.1">The fold expression ensures that </span><code class="inlineCode"><span class="koboSpan" id="kobo.472.1">display::update(temp)</span></code><span class="koboSpan" id="kobo.473.1"> is called first, then </span><code class="inlineCode"><span class="koboSpan" id="kobo.474.1">data_sender::update(temp)</span></code><span class="koboSpan" id="kobo.475.1">, then </span><code class="inlineCode"><span class="koboSpan" id="kobo.476.1">logger::update(temp)</span></code><span class="koboSpan" id="kobo.477.1">. </span><span class="koboSpan" id="kobo.477.2">The order of evaluation is strictly left to right for the operands of the comma operator. </span><span class="koboSpan" id="kobo.477.3">Each </span><code class="inlineCode"><span class="koboSpan" id="kobo.478.1">update(temp)</span></code><span class="koboSpan" id="kobo.479.1"> call returns a value (likely </span><code class="inlineCode"><span class="koboSpan" id="kobo.480.1">void</span></code><span class="koboSpan" id="kobo.481.1">).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.482.1">The comma operator discards all return values except the last one, so only the final </span><code class="inlineCode"><span class="koboSpan" id="kobo.483.1">logger::update(temp)</span></code><span class="koboSpan" id="kobo.484.1"> determines the fold’s result. </span><span class="koboSpan" id="kobo.484.2">If they all return void, the whole expression also returns void.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.485.1">Fold expressions were introduced in C++17 and using the comma operator is a concise way to call a function on each type in the parameter pack. </span><span class="koboSpan" id="kobo.485.2">Before that, a recursion was needed to iterate through types and call a function on them.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.486.1">When examining the disassembly output in Compiler Explorer, you’ll notice that the generated assembly code is relatively brief, approximately 30 lines in total, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-symbol"><span class="koboSpan" id="kobo.487.1">.LC0:</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.488.1">.ascii</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.489.1">“Displaying temperature %.2f \015\012\000”</span></span>
<span class="hljs-symbol"><span class="koboSpan" id="kobo.490.1">.LC1:</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.491.1">.ascii</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.492.1">“Sending temperature %.2f \015\012\000”</span></span>
<span class="hljs-symbol"><span class="koboSpan" id="kobo.493.1">.LC2:</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.494.1">.ascii</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.495.1">“Logging temperature %.2f \015\012\000”</span></span>
<span class="hljs-symbol"><span class="koboSpan" id="kobo.496.1">main:</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.497.1">push</span></span><span class="koboSpan" id="kobo.498.1">    {</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.499.1">r4</span></span><span class="koboSpan" id="kobo.500.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.501.1">r5</span></span><span class="koboSpan" id="kobo.502.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.503.1">r6</span></span><span class="koboSpan" id="kobo.504.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.505.1">lr</span></span><span class="koboSpan" id="kobo.506.1">}
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.507.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.508.1">r4</span></span><span class="koboSpan" id="kobo.509.1">, #-</span><span class="hljs-number"><span class="koboSpan" id="kobo.510.1">536870912</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.511.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.512.1">r5</span></span><span class="koboSpan" id="kobo.513.1">, .L3
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.514.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.515.1">r2</span></span><span class="koboSpan" id="kobo.516.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.517.1">r4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.518.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.519.1">r3</span></span><span class="koboSpan" id="kobo.520.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.521.1">r5</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.522.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.523.1">r0</span></span><span class="koboSpan" id="kobo.524.1">, .L3+</span><span class="hljs-number"><span class="koboSpan" id="kobo.525.1">4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.526.1">bl</span></span><span class="koboSpan" id="kobo.527.1">      printf
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.528.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.529.1">r2</span></span><span class="koboSpan" id="kobo.530.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.531.1">r4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.532.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.533.1">r3</span></span><span class="koboSpan" id="kobo.534.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.535.1">r5</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.536.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.537.1">r0</span></span><span class="koboSpan" id="kobo.538.1">, .L3+</span><span class="hljs-number"><span class="koboSpan" id="kobo.539.1">8</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.540.1">bl</span></span><span class="koboSpan" id="kobo.541.1">      printf
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.542.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.543.1">r2</span></span><span class="koboSpan" id="kobo.544.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.545.1">r4</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.546.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.547.1">r3</span></span><span class="koboSpan" id="kobo.548.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.549.1">r5</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.550.1">ldr</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.551.1">r0</span></span><span class="koboSpan" id="kobo.552.1">, .L3+</span><span class="hljs-number"><span class="koboSpan" id="kobo.553.1">12</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.554.1">bl</span></span><span class="koboSpan" id="kobo.555.1">      printf
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.556.1">mov</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.557.1">r0</span></span><span class="koboSpan" id="kobo.558.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.559.1">#0</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.560.1">pop</span></span><span class="koboSpan" id="kobo.561.1">     {</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.562.1">r4</span></span><span class="koboSpan" id="kobo.563.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.564.1">r5</span></span><span class="koboSpan" id="kobo.565.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.566.1">r6</span></span><span class="koboSpan" id="kobo.567.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.568.1">lr</span></span><span class="koboSpan" id="kobo.569.1">}
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.570.1">bx</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.571.1">lr</span></span>
<span class="hljs-symbol"><span class="koboSpan" id="kobo.572.1">.L3:</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.573.1">.word</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.574.1">1077377105</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.575.1">.word</span></span><span class="koboSpan" id="kobo.576.1">   .LC0
        </span><span class="hljs-meta"><span class="koboSpan" id="kobo.577.1">.word</span></span><span class="koboSpan" id="kobo.578.1">   .LC1
        </span><span class="hljs-meta"><span class="koboSpan" id="kobo.579.1">.word</span></span><span class="koboSpan" id="kobo.580.1">   .LC2
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.581.1">In this assembly code, we can see that there are no calls to the static update methods from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.582.1">display</span></code><span class="koboSpan" id="kobo.583.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.584.1">data_sender</span></code><span class="koboSpan" id="kobo.585.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.586.1">logger</span></code><span class="koboSpan" id="kobo.587.1"> structs. </span><span class="koboSpan" id="kobo.587.2">This means the compiler was able to optimize these </span><a id="_idIndexMarker658"/><span class="koboSpan" id="kobo.588.1">calls out, along with the registration of subscribers and the call to the publisher’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.589.1">notify</span></code><span class="koboSpan" id="kobo.590.1"> method, resulting in direct calls to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.591.1">printf</span></code><span class="koboSpan" id="kobo.592.1"> function. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.593.1">The result is a small memory footprint and fast performance. </span><span class="koboSpan" id="kobo.593.2">This example demonstrates the zero-cost abstraction design principle: we have abstractions for the publisher and subscribers, yet there is zero overhead, as the compiler is able to optimize the code to be as efficient as if it were written by hand.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.594.1">Compare the assembly output of the compile-time implementation with that of the runtime implementation using the same optimization level (</span><code class="inlineCode"><span class="koboSpan" id="kobo.595.1">-O3</span></code><span class="koboSpan" id="kobo.596.1">). </span><span class="koboSpan" id="kobo.596.2">It is clear that the compile-time implementation uses less memory and is faster as the compiler optimized away most of the function calls, and there is no indirection caused by virtual functions.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.597.1">As we analyze the assembly code, let’s take the opportunity to better understand fold expressions. </span><span class="koboSpan" id="kobo.597.2">To prevent GCC from optimizing away calls to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.598.1">update</span></code><span class="koboSpan" id="kobo.599.1"> methods, we can use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.600.1">__attribute__((noinline))</span></code><span class="koboSpan" id="kobo.601.1"> function attribute, e.g. </span><code class="inlineCode"><span class="koboSpan" id="kobo.602.1">static void __attribute__((noinline)) update(float temp)</span></code><span class="koboSpan" id="kobo.603.1">. </span><span class="koboSpan" id="kobo.603.2">Add this attribute to the static </span><code class="inlineCode"><span class="koboSpan" id="kobo.604.1">update</span></code><span class="koboSpan" id="kobo.605.1"> method of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.606.1">display</span></code><span class="koboSpan" id="kobo.607.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.608.1">data_sender</span></code><span class="koboSpan" id="kobo.609.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.610.1">logger</span></code><span class="koboSpan" id="kobo.611.1"> structs, and observe the generated assembly code. </span><span class="koboSpan" id="kobo.611.2">You’ll see how the call to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.612.1">notify</span></code><span class="koboSpan" id="kobo.613.1"> method in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.614.1">main</span></code><span class="koboSpan" id="kobo.615.1"> function results in parameter pack expansion and generates calls to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.616.1">update</span></code><span class="koboSpan" id="kobo.617.1"> methods of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.618.1">display</span></code><span class="koboSpan" id="kobo.619.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.620.1">data_sender</span></code><span class="koboSpan" id="kobo.621.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.622.1">logger</span></code><span class="koboSpan" id="kobo.623.1"> structs.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.624.1">You can run </span><a id="_idIndexMarker659"/><span class="koboSpan" id="kobo.625.1">the full example in Renode. </span><span class="koboSpan" id="kobo.625.2">Start Visual Studio Code, attach it to the running container, open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.626.1">Chapter15/observer</span></code><span class="koboSpan" id="kobo.627.1"> project as described in </span><a href="Chapter_04.xhtml"><em class="italic"><span class="koboSpan" id="kobo.628.1">Chapter 4</span></em></a><span class="koboSpan" id="kobo.629.1">, and run the following commands in the Visual Studio Code terminal, or run them directly in the container terminal:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.630.1">$ cmake -B build
-DMAIN_CPP_FILE_NAME=main_observer_ct_basic.cpp
$ cmake --build build --target run_in_renode
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.631.1">Simplified compile-time implementation of the Observer pattern has a couple of limits:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.632.1">Subscribers can only be registered.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.633.1">All subscribers are registered when the publisher is instantiated. </span><span class="koboSpan" id="kobo.633.2">They cannot be registered after the publisher is instantiated.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.634.1">Next, we will tackle the last point, as registering all subscribers in a single line of code may be cumbersome and not always practical. </span><span class="koboSpan" id="kobo.634.2">This will provide us with a more flexible compile-time design.</span></p>
<h2 class="heading-2" id="_idParaDest-205"><span class="koboSpan" id="kobo.635.1">Improving the compile-time implementation</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.636.1">We will not </span><a id="_idIndexMarker660"/><span class="koboSpan" id="kobo.637.1">change the interface of the publisher template struct. </span><span class="koboSpan" id="kobo.637.2">Instead, we will allow it to receive other publishers as arguments. </span><span class="koboSpan" id="kobo.637.3">The code is below:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.638.1">template</span></span><span class="koboSpan" id="kobo.639.1">&lt;</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.640.1">typename</span></span><span class="koboSpan" id="kobo.641.1"> T&gt;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.642.1">concept</span></span><span class="koboSpan" id="kobo.643.1"> Updatable = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.644.1">requires</span></span><span class="koboSpan" id="kobo.645.1"> (T, </span><span class="hljs-type"><span class="koboSpan" id="kobo.646.1">float</span></span><span class="koboSpan" id="kobo.647.1"> f) {
    { T::</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.648.1">update</span></span><span class="koboSpan" id="kobo.649.1">(f) } -&gt; std::same_as&lt;</span><span class="hljs-type"><span class="koboSpan" id="kobo.650.1">void</span></span><span class="koboSpan" id="kobo.651.1">&gt;;
};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.652.1">template</span></span><span class="koboSpan" id="kobo.653.1">&lt;</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.654.1">typename</span></span><span class="koboSpan" id="kobo.655.1"> T&gt;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.656.1">concept</span></span><span class="koboSpan" id="kobo.657.1"> Notifiable = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.658.1">requires</span></span><span class="koboSpan" id="kobo.659.1"> (T, </span><span class="hljs-type"><span class="koboSpan" id="kobo.660.1">float</span></span><span class="koboSpan" id="kobo.661.1"> f) {
    { T::</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.662.1">notify</span></span><span class="koboSpan" id="kobo.663.1">(f) } -&gt; std::same_as&lt;</span><span class="hljs-type"><span class="koboSpan" id="kobo.664.1">void</span></span><span class="koboSpan" id="kobo.665.1">&gt;;
};
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.666.1">template</span></span><span class="koboSpan" id="kobo.667.1"> &lt;</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.668.1">typename</span></span><span class="koboSpan" id="kobo.669.1">... </span><span class="koboSpan" id="kobo.669.2">Subs&gt;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.670.1">struct</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.671.1">publisher</span></span><span class="koboSpan" id="kobo.672.1"> {
    </span><span class="hljs-type"><span class="koboSpan" id="kobo.673.1">static</span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="koboSpan" id="kobo.674.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.675.1">notify</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.676.1">(</span></span><span class="hljs-type"><span class="koboSpan" id="kobo.677.1">float</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.678.1"> temp)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.679.1">{
        (</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.680.1">call_update_or_notify</span></span><span class="koboSpan" id="kobo.681.1">&lt;Subs&gt;(temp), ...);
    }
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.682.1">private</span></span><span class="koboSpan" id="kobo.683.1">:
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.684.1">template</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.685.1">&lt;</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.686.1">typename</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.687.1"> T&gt;</span></span>
<span class="hljs-function"> </span><span class="hljs-type"><span class="koboSpan" id="kobo.688.1">static</span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="koboSpan" id="kobo.689.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.690.1">call_update_or_notify</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.691.1">(</span></span><span class="hljs-type"><span class="koboSpan" id="kobo.692.1">float</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.693.1"> temp)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.694.1">{
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.695.1">if</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.696.1">constexpr</span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="koboSpan" id="kobo.697.1">(Updatable&lt;T&gt;)</span></span><span class="hljs-function"> </span><span class="koboSpan" id="kobo.698.1">{
            T::</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.699.1">update</span></span><span class="koboSpan" id="kobo.700.1">(temp);
        } </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.701.1">else</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.702.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.703.1">constexpr</span></span><span class="koboSpan" id="kobo.704.1"> (Notifiable&lt;T&gt;) {
            T::</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.705.1">notify</span></span><span class="koboSpan" id="kobo.706.1">(temp);
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.707.1">else</span></span><span class="koboSpan" id="kobo.708.1"> {
            </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.709.1">static_assert</span></span><span class="koboSpan" id="kobo.710.1">(</span><span class="hljs-literal"><span class="koboSpan" id="kobo.711.1">false</span></span><span class="koboSpan" id="kobo.712.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.713.1">“Type is not Updatable or Notifiable”</span></span><span class="koboSpan" id="kobo.714.1">);
        }
    }
};
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.715.1">In the </span><a id="_idIndexMarker661"/><span class="koboSpan" id="kobo.716.1">code above, we defined the following concepts:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.717.1">Updatable</span></code><span class="koboSpan" id="kobo.718.1">: This describes a type that has a static method </span><code class="inlineCode"><span class="koboSpan" id="kobo.719.1">update</span></code><span class="koboSpan" id="kobo.720.1"> that accepts a float</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.721.1">Notifiable</span></code><span class="koboSpan" id="kobo.722.1">: This describes a type that has a static method </span><code class="inlineCode"><span class="koboSpan" id="kobo.723.1">notify</span></code><span class="koboSpan" id="kobo.724.1"> that accepts a float</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.725.1">We covered concepts in more detail in </span><a href="Chapter_08.xhtml"><em class="italic"><span class="koboSpan" id="kobo.726.1">Chapter 8</span></em></a><span class="koboSpan" id="kobo.727.1">. </span><span class="koboSpan" id="kobo.727.2">The variadic template class </span><code class="inlineCode"><span class="koboSpan" id="kobo.728.1">publisher</span></code><span class="koboSpan" id="kobo.729.1"> has a new method – </span><code class="inlineCode"><span class="koboSpan" id="kobo.730.1">call_update_or_notify</span></code><span class="koboSpan" id="kobo.731.1">. </span><span class="koboSpan" id="kobo.731.2">It is called on every type in the parameter pack </span><code class="inlineCode"><span class="koboSpan" id="kobo.732.1">typename... </span><span class="koboSpan" id="kobo.732.2">Subs</span></code><span class="koboSpan" id="kobo.733.1"> in the method </span><code class="inlineCode"><span class="koboSpan" id="kobo.734.1">notify</span></code><span class="koboSpan" id="kobo.735.1"> using the fold expression and the comma operator.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.736.1">In the method </span><code class="inlineCode"><span class="koboSpan" id="kobo.737.1">call_update_or_notify</span></code><span class="koboSpan" id="kobo.738.1">, we use </span><code class="inlineCode"><span class="koboSpan" id="kobo.739.1">if constexpr</span></code><span class="koboSpan" id="kobo.740.1"> to check, at compile-time, if the type is </span><code class="inlineCode"><span class="koboSpan" id="kobo.741.1">Updatable</span></code><span class="koboSpan" id="kobo.742.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.743.1">Notifiable</span></code><span class="koboSpan" id="kobo.744.1"> and call the </span><code class="inlineCode"><span class="koboSpan" id="kobo.745.1">update</span></code><span class="koboSpan" id="kobo.746.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.747.1">notify</span></code><span class="koboSpan" id="kobo.748.1"> static method on it respectively.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.749.1">Below is an example of using the new version of the Observer pattern:</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.750.1">using</span></span><span class="koboSpan" id="kobo.751.1"> temp_publisher = publisher&lt;display, data_sender&gt;;
    temp_publisher::</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.752.1">notify</span></span><span class="koboSpan" id="kobo.753.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.754.1">23.47</span></span><span class="koboSpan" id="kobo.755.1">);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.756.1">using</span></span><span class="koboSpan" id="kobo.757.1"> temp_publisher_new = publisher&lt;temp_publisher, logger&gt;;
    temp_publisher_new::</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.758.1">notify</span></span><span class="koboSpan" id="kobo.759.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.760.1">42.42</span></span><span class="koboSpan" id="kobo.761.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.762.1">In the code above, we instantiate </span><code class="inlineCode"><span class="koboSpan" id="kobo.763.1">temp_publisher</span></code><span class="koboSpan" id="kobo.764.1"> by providing the variadic class template </span><code class="inlineCode"><span class="koboSpan" id="kobo.765.1">publisher</span></code><span class="koboSpan" id="kobo.766.1"> with types </span><code class="inlineCode"><span class="koboSpan" id="kobo.767.1">display</span></code><span class="koboSpan" id="kobo.768.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.769.1">data_sender</span></code><span class="koboSpan" id="kobo.770.1">, which are both subscribers are </span><code class="inlineCode"><span class="koboSpan" id="kobo.771.1">Updatable</span></code><span class="koboSpan" id="kobo.772.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.773.1">Next, we instantiate </span><code class="inlineCode"><span class="koboSpan" id="kobo.774.1">temp_publisher_new</span></code><span class="koboSpan" id="kobo.775.1"> by providing </span><code class="inlineCode"><span class="koboSpan" id="kobo.776.1">publisher</span></code><span class="koboSpan" id="kobo.777.1"> with the previously instantiated </span><code class="inlineCode"><span class="koboSpan" id="kobo.778.1">temp_publisher</span></code><span class="koboSpan" id="kobo.779.1"> and the subscriber </span><code class="inlineCode"><span class="koboSpan" id="kobo.780.1">logger</span></code><span class="koboSpan" id="kobo.781.1">. </span><span class="koboSpan" id="kobo.781.2">Below is the output of the above example:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.782.1">Displaying temperature 23.47
Sending temperature 23.47
Displaying temperature 42.42
Sending temperature 42.42
Logging temperature 42.42
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.783.1">You can </span><a id="_idIndexMarker662"/><span class="koboSpan" id="kobo.784.1">run the full example in Renode. </span><span class="koboSpan" id="kobo.784.2">Start Visual Studio Code, attach it to the running container, open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.785.1">Chapter15/observer</span></code><span class="koboSpan" id="kobo.786.1"> project as described in </span><a href="Chapter_04.xhtml"><em class="italic"><span class="koboSpan" id="kobo.787.1">Chapter 4</span></em></a><span class="koboSpan" id="kobo.788.1">, and run the following commands in the Visual Studio Code terminal, or run them directly in the container terminal:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.789.1">$ </span></span><span class="language-bash"><span class="koboSpan" id="kobo.790.1">cmake -B build -DMAIN_CPP_FILE_NAME=main_observer_ct.cpp</span></span>
<span class="hljs-con-meta"><span class="koboSpan" id="kobo.791.1">$ </span></span><span class="language-bash"><span class="koboSpan" id="kobo.792.1">cmake --build build --target run_in_renode</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.793.1">This implementation of the Observer pattern allows us to register subscribers in a more flexible manner. </span><span class="koboSpan" id="kobo.793.2">To make it more generic, as an exercise, you can modify it so that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.794.1">notify</span></code><span class="koboSpan" id="kobo.795.1"> method is able to take a variable number of arguments.</span></p>
<h1 class="heading-1" id="_idParaDest-206"><span class="koboSpan" id="kobo.796.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.797.1">In this chapter, we went through the Observer pattern, both runtime and compile-time implementations.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.798.1">Compile-time implementation is utilizing what we know about the application during compile-time. </span><span class="koboSpan" id="kobo.798.2">It is based on variadic template classes and fold expressions. </span><span class="koboSpan" id="kobo.798.3">The result is super compact and fast code, as we are not storing information about subscribers in a container, nor do we need to iterate through the container to make a call to </span><code class="inlineCode"><span class="koboSpan" id="kobo.799.1">update</span></code><span class="koboSpan" id="kobo.800.1"> methods.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.801.1">In the next chapter, we will cover </span><strong class="keyWord"><span class="koboSpan" id="kobo.802.1">Finite State Machines (FSM)</span></strong><span class="koboSpan" id="kobo.803.1"> and the implementation of the State patterns in C++.</span></p>
<h1 class="heading-1" id="_idParaDest-207"><span class="koboSpan" id="kobo.804.1">Join our community on Discord</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.805.1">Join our community’s Discord space for discussions with the author and other readers:</span></p>
<p class="normal"><a href="https://packt.link/embeddedsystems"><span class="url"><span class="koboSpan" id="kobo.806.1">https://packt.link/embeddedsystems</span></span></a></p>
<p class="normal"><span class="koboSpan" id="kobo.807.1"><img alt="" role="presentation" src="../Images/QR_code_Discord.png"/></span></p>
</div>
</body></html>